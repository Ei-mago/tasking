angular.module("ui.ewei.tabs",[]).controller("eweiTabsetController",["$scope","newTicketCustomFieldCacheService",function e(t,n){var a=this,o=a.tabs=t.tabs=[];this.hide=true;a.select=function(t){angular.forEach(o,function(e){if(e.active&&e!==t){e.active=false;e.onDeselect()}});t.active=true;t.onSelect()};a.addTab=function e(t){o.push(t);if(o.length===1){}else if(t.active){a.select(t)}};a.removeTab=function e(t){var i=o.indexOf(t);if(t.active&&o.length>1){var r=i==o.length-1?i-1:i+1;a.select(o[r])}if(t.id.indexOf("tickets_new")>-1){n.delete(t.id.split("tickets_new")[1])}o.splice(i,1)}}]).directive("eweitabset",function(){return{restrict:"EA",transclude:true,replace:true,scope:{type:"@"},controller:"eweiTabsetController",templateUrl:"source/scripts/directives/tabs/tabset.html",link:function(e,t,i){e.vertical=angular.isDefined(i.vertical)?e.$parent.$eval(i.vertical):false;e.justified=angular.isDefined(i.justified)?e.$parent.$eval(i.justified):false}}}).directive("eweitab",["coreModelService","$parse","tabs","$state","utils","$rootScope","batchTicketService","apiServiceDesksService",function(c,o,u,d,f,p,m,h){return{require:"^eweitabset",restrict:"EA",replace:true,templateUrl:"source/scripts/directives/tabs/tab.html",transclude:true,scope:{id:"@",active:"=?",heading:"@",ico:"@",width:"@",shake:"=?",onSelect:"&select",onDeselect:"&deselect"},controller:["$scope","$rootScope",function(e,t){}],compile:function(e,t,a){return function e(i,t,r,n){i.$watch("active",function(e){if(e){n.select(i)}});i.disabled=false;if(r.disabled){i.$parent.$watch(o(r.disabled),function(e){i.disabled=!!e})}i.removeTab=function(e,t,i){var r=f.findTabById(e);var n=u[r];if(n.stateName==="webchats_new.detail"&&!n.isClose){p.$emit("exit_current_tab",n);return false}if(t){var a=null;if(r>0){a=u[r-1]}else{if(u.length>1){a=u[1]}}if(a==null){switch(n.stateName){case"webchats_new.detail":d.go("webchats_new.list");break;case"webchat-history.detail":d.go("webchat-history",{},{reload:true});break;case"tickets_new":case"tickets_detail":var o=c.config.route.get("ticket.from");if(o&&-1!=o.indexOf("quickentry")){d.go("quickentry")}else if(o&&-1!=o.indexOf("chat_list")){d.go("webchats_new.list")}else{d.go("ticket_views")}break;case"user_groups_detail":var o=c.config.route.get("userGroup.from");if(o&&-1!=o.indexOf("quickentry")){d.go("quickentry")}else{d.go("customer_views")}break;case"customers_detail":var o=c.config.route.get("user.from");if(o&&-1!=o.indexOf("quickentry")){d.go("quickentry")}else{d.go("customer_views")}break;case"project_detail":var o=c.config.route.get("projectDetail.from");if(o&&-1!=o.indexOf("quickentry")){d.go("quickentry")}else{d.go("universal_list.favorites_list")}break;default:d.go("quickentry");break}}else{a.active=true;d.go(a.stateName,a.params)}}var s=u[r].params.type;var l=u[r].params.id;if(s==="batch-ticket"){m.noSaveCacheData=true;m.setCacheData(l,[])}else if(s==="batch-engineer"){h.noSaveCacheData=true;h.setCacheData(l,[])}else if(s==="plan-ticket"){c.config.route.put("tickets_new_"+l,{name:"tickets_new.plan_list",params:{}})}p.$emit("ticket-cached-no-save",true);u.splice(r,1);i.stopPropagation()};i.selectTab=function(e){i.shake=false;var t=f.findTabById(e);u[t].active=true;d.go(u[t].stateName,u[t].params,{reload:u[t].stateName.indexOf("webchats_new")==-1})};i.select=function(){if(!i.disabled){i.active=true}};n.addTab(i);i.$on("$destroy",function(){n.removeTab(i)});i.$transcludeFn=a}}}}]);angular.module("ui.ewei.alert",[]).directive("eweialert",function(){return{restrict:"EA",transclude:true,replace:true,scope:{position:"=",type:"=",closeable:"=",msg:"@",show:"=",close:"&"},templateUrl:"source/scripts/directives/ewei-alert/ewei_alert.html"}});angular.module("eweiApp.common").controller("serviceCountdownController",serviceCountdownController).directive("serviceCountdown",serviceCountdown);serviceCountdownController.$inject=["$scope","$state","$timeout","license","ConsoleConfig","$modal_","permissions","coreModelService","coreNotifyService","timeService"];function serviceCountdownController(i,t,r,n,a,o,s,e,l,c){var u=this.__proto__.constructor.name+"_"+(new Date).valueOf();function d(){l.register(u,l.constant.EVENT_LICENSE,function(e,t){p()})}function f(){l.unRegister(u)}i.$on("$destroy",function(){f()});function p(){i.liceseType=n.type();var e=n.lastTime();var t=n.isCoverData();i.remainingCapacity=n.remainingCapacity()/n.diskCapacity()*100;if(e&&e>=0&&i.remainingCapacity<5&&(a.engineer.role.nameKey=="ROLE_NAME_CREATOR"||a.engineer.role.nameKey=="ROLE_NAME_ADMIN")){if(t&&t==0){i.capacityCond=true}else{i.capacityCond=false}}else{i.capacityCond=false}if(i.capacityCond){r(function(){i.capacityCond=false},5e3)}if((n.type()=="enterprise_plus"||n.type()=="enterprise"||n.type()=="professional")&&n.threeDaysBeforeDeduction()&&(a.engineer.role.nameKey=="ROLE_NAME_CREATOR"||a.engineer.role.nameKey=="ROLE_NAME_ADMIN")){if((!n.lastTime()||n.lastTime()<0)&&n.expenseAmount()&&n.expenseAmount()>n.accountBalance()){i.deductionCond=true}else{i.deductionCond=false}}else{i.deductionCond=false}if(i.deductionCond){r(function(){i.deductionCond=false},5e3)}void 0;if((n.type()=="enterprise_plus"||n.type()=="enterprise"||n.type()=="professional"||n.type()=="online_service_basic"||n.type()=="remote_assistance_basic"||n.type()=="enterprise_basic"||n.type()=="enterprise_basic_19")&&n.threeDaysBeforeMaturity()&&(a.engineer.role.nameKey=="ROLE_NAME_CREATOR"||a.engineer.role.nameKey=="ROLE_NAME_ADMIN")){i.showThreeDaysTipCond=true;r(function(){i.showThreeDaysTipCond=false},5e3)}else{i.showThreeDaysTipCond=false}if(n.overdueDays()<0){return false}if(n.daysBeforeMaturity(10)&&(a.engineer.role.nameKey=="ROLE_NAME_CREATOR"||a.engineer.role.nameKey=="ROLE_NAME_ADMIN")){i.showCond=true}else{i.showCond=false}i.remindDay=n.overdueDays();if(i.showCond){r(function(){i.showCond=false},5e3)}}i.toPay=function(){i.deductionCond=false;i.showThreeDaysTipCond=false;i.showCond=false;i.hasPermission=false;if(s.hasPermission("system_setting_company_account")){t.go("system_setting.detail.provider",{uri:"company_account",settingType:"system"})}else{i.tipNotSupportService="很抱歉，你没有访问授权计划的权限";var e=o({scope:i,title:"提示",contentTemplate:"source/views/fun_restriction_reminder.html",html:true,show:true,placement:"center"});i.hideModal_=function(){e.$promise.then(e.hide)}}};i.linkEngineer=function(){$("#ewei-websdk-portal").trigger("click");i.showThreeDaysTipCond=false};function m(){d()}m()}function serviceCountdown(){return{restrict:"EA",replace:true,controller:serviceCountdownController,scope:false,templateUrl:"source/scripts/directives/serviceCountdown/serviceCountdown.html"}}angular.module("ewei.cometd",[]).directive("eweiCometd",["$rootScope","$state","utils","alertService","$http","ConsoleConfig","$modal_","cometdService","permissions",function(v,e,t,k,y,w,C,_,b){return{restrict:"EA",scope:true,controller:[function(){}],compile:function(e,t,i){return{pre:function e(g,t,i,r){(function(e){var n=e.cometd;function i(){void 0}function r(){void 0}function a(){void 0}var o=false;function t(e){if(n.isDisconnected()){o=false;a();return}var t=o;o=e.successful===true;if(!t&&o){i()}else if(t&&!o){r()}}var s=[];var l=[];var c="/provider/"+w.provider.id;function u(e){if(e.successful===true){v.cometdClientId=e.clientId;n.batch(function(){n.subscribe(c,h);if(s&&s.length>0){for(var e=0;e<s.length;e++){f(s[e])}}angular.forEach(w.serviceDeskIds,function(e){n.subscribe("/provider/"+w.provider.id+"/serviceDesk/"+e,h)})})}}function d(e){if(e.successful&&e.subscription===c){y({url:"create_long_connection.json?sessionId="+v.cometdClientId+"&channel=web_console&userId="+w.user.id}).success(function(e,t,i,r){if(e.success){_.setCometdService(e.success);void 0}else{_.setCometdService(false);void 0;k.add("发生错误，小伙伴们将无法获知你在线，请刷新页面重试","danger")}})}}var f=function(e){var t=p(s,e);if(t!=null){var i=m(t);if(i){n.unsubscribe(i);s.splice(t,1);l.splice(t,1)}}i=n.subscribe(e,h);s.push(e);l.push(i);void 0};g.$on("subscribe",function(e,t){f(t)});g.$on("unsubscribe",function(e,t){var i=p(s,t);if(i!=null){var r=m(i);if(r){n.unsubscribe(r);void 0;s.splice(i,1);l.splice(i,1)}}});function p(e,t){for(var i=0;i<e.length;i++){if(e[i]===t){return i}}return null}function m(e){return l[e]}function h(e){var t=e.data.type;if(t=="offline"){n.disconnect(true);g.useremail=w.user.email;var i=C({scope:g,contentTemplate:"source/views/alert_offline.html",html:true,show:true,placement:"center",backdrop:"static",alwaysShow:true,keyboard:false})}else if(t=="ticket_comment"){v.$broadcast("ticket_comment",e.data)}else if(t=="ticket_log"){if(b.hasPermission("ticket_operate_log")){v.$broadcast("ticket_log",e.data)}}else if(t=="ticket_operation"){v.$broadcast("change_handler",e.data)}else if(t=="chat_lack_plugin"){v.$broadcast("chat_lack_plugin",e.data)}else if(t=="request_remote_desk"){v.$broadcast("request_remote_desk",e.data)}else if(t=="accept_remote_desk"){v.$broadcast("accept_remote_desk",e.data)}else if(t=="reject_remote_desk"){v.$broadcast("reject_remote_desk",e.data)}else if(t=="cancel_remote_desk"){v.$broadcast("cancel_remote_desk",e.data)}else if(t=="request_assist"){v.$broadcast("request_assist",e.data)}else if(t=="cancel_request_assist"){v.$broadcast("cancel_request_assist",e.data)}else if(t=="accept_assist"){v.$broadcast("accept_assist",e.data)}else if(t=="reject_assist"){v.$broadcast("reject_assist",e.data)}else if(t=="ticket_assist"){v.$broadcast("ticket_assist",e.data)}else if(t=="join_chat"){v.$broadcast("join_chat",e.data)}else if(t=="pre_chat_assign"){v.$broadcast("pre_chat_assign",e.data)}else if(t=="request_chat"){v.$broadcast("request_chat",e.data)}else if(t=="cancel_request_chat"){v.$broadcast("cancel_request_chat",e.data)}else if(t=="accept_chat"){v.$broadcast("accept_chat",e.data)}else if(t=="chat_invite"){v.$broadcast("chat_invite",e.data)}else if(t=="cancel_chat_invite"){v.$broadcast("cancel_chat_invite",e.data)}else if(t=="response_chat_invite"){v.$broadcast("response_chat_invite",e.data)}else if(t=="chat_transfer_responsed"){v.$broadcast("chat_transfer_responsed",e.data)}else if(t=="webchat_message"){v.$broadcast("webchat_message",e.data)}else if(t=="notice"){v.$broadcast("notice",e.data)}else if(t=="accept_video_call"){v.$broadcast("accept_video_call",e.data)}else if(t=="reject_video_call"){v.$broadcast("reject_assist",e.data)}else if(t=="close_chat"){v.$broadcast("close_chat",e.data)}else if(t=="chat_to_ticket"){v.$broadcast("chat_to_ticket",e.data)}else if(t=="assign_chat"){v.$broadcast("assign_chat",e.data)}else if(t=="chat_transfer"){v.$broadcast("chat_transfer",e.data)}else if(t=="chat_time_out_warning"){v.$broadcast("chat_time_out_warning",e.data)}else if(t=="response_chat_time_out_warning"){v.$broadcast("response_chat_time_out_warning",e.data)}else if(t=="chat_new_notice"){v.$broadcast("chat_new_notice",e.data)}else if(t=="chat_user_status_change"){v.$broadcast("chat_user_status_change",e.data)}else if(t=="setUserValidToFalse"){window.location.href="/logout"}else if(t=="update_role_permissions"){v.$broadcast("update_role_permissions",e.data)}else if(t=="weixin_auth_callback"){v.$broadcast("weixin_auth_callback",e.data)}else if(t=="ticket_change"){v.$broadcast("ticket_change",e.data)}else if(t=="chat_log_delete"){v.$broadcast("chat_log_delete",e)}else{void 0}}n.configure({url:w.eweiWebCometd_url,logLevel:"warn"});void 0;n.addListener("/meta/handshake",u);n.addListener("/meta/connect",t);n.addListener("/meta/subscribe",d);n.handshake({user:{id:w.user.id,providerId:w.provider.id,platform:"web_console"}})})(jQuery)}}}}}]);angular.module("ewei.cometd").factory("cometdService",[function(){var t=null;return{setCometdService:function(e){t=e},getCometdService:function(){return t}}}]);angular.module("ngScrollTo",[]).directive("scrollTo",["$window",function(n){return{restrict:"AC",compile:function(){var i=n.document;function r(e){if(!e)n.scrollTo(0,0);var t=i.getElementById(e);if(!t){t=i.getElementsByName(e);if(t&&t.length)t=t[0];else t=null}if(t)t.scrollIntoView()}return function(e,t,i){t.bind("click",function(e){r(i.scrollTo)})}}}}]);angular.module("eweiApp.ticket").directive("keepScroll",[function(){return{restrict:"A",controller:["$scope",function(t){var e=0;this.setElement=function(e){element=e};this.addItem=function(e){t.$evalAsync(function(){element.scrollTop=element.scrollHeight+e.clientHeight})}}],link:function(e,t,i,r){r.setElement(t[0])}}}]).directive("scrollItem",[function(){return{restrict:"A",require:"^keepScroll",scope:{scrollItem:"@"},link:function(e,t,i,r){if(e.scrollItem==="true"){r.addItem(t[0])}}}}]).directive("scrollImageItem",[function(){return{restrict:"A",require:"^keepScroll",scope:{scrollImageItem:"@"},link:function(e,t,i,r){if(e.scrollImageItem==="true"){t.bind("load",function(){r.addItem(t[0])})}}}}]).directive("focusMe",function(){return{scope:{trigger:"@focusMe"},link:function(t,i){var e=t.$watch("trigger",function(e){if(e==="true"){t.$evalAsync(function(){i[0].focus()})}});t.$on("$destroy",function(){e()})}}}).directive("contentEditAble",function(){return{restrict:"AE",template:'<span class="padding5px margin_right20px" ng-hide="startEdit">{{editData}}</span><input type="text" ng-model="editData" ng-show="startEdit"><i class="fa" ng-show="canEdit===\'true\'" ng-class="{true:\'fa-check\',false:\'fa-pencil\'}[startEdit]"></i>',replace:false,transclude:true,scope:{editData:"=editData",canEdit:"@canEdit"},controller:["$scope",function(e){var t=null;e.startEdit=false;this.setContentElement=function(e){t=e};this.setContentIsEditAble=function(){if(t){t.attr("contentEditAble",true).focus()}};this.test=function(e){void 0;void 0}}],link:function(t,e,i,r){e.bind("click",function(e){if(e.target.tagName==="I"){t.startEdit=!t.startEdit}})}}}).directive("textareaAutoHeight",[function(){return{restrict:"A",scope:{maxHeight:"@textareaAutoHeight",content:"=ngModel"},link:function(r,n,e){r.maxHeight=parseInt(r.maxHeight,10);var i=n.outerHeight()-n.innerHeight();var a=n.outerHeight();var o=_.debounce(function(e,t){n.outerHeight(e);var i=e;if(n[0].scrollHeight!==e){i=""+(n[0].scrollHeight+t)+"px"}if(n[0].scrollHeight>r.maxHeight){i=r.maxHeight+"px"}n.outerHeight(i)},50,true);var t=r.$watch("content",function(e,t){o(a,i)},false);o(a,i);r.$on("$destroy",function(){t()})}}}]).directive("ticketLoading",["$http",function(a){return{restrict:"A",scope:{url:"@ticketLoading"},link:function(r,t,e){var i=function(e){var t=r.url.split(",");for(var i=0;i<t.length;i++){if(t[i]===e){return true}}return false};r.isLoading=function(){for(var e=0;e<a.pendingRequests.length;e++){if(i(a.pendingRequests[e].url)){return true}}return false};$parent=$(t).parent(".pane");var n=r.$watch(r.isLoading,function(e){if(e){t.show();$parent.css("overflow","hidden")}else{$parent.css("overflow","auto");t.hide()}});r.$on("$destroy",function(){n()})}}}]);(function(e){"use strict";e.module("com.ewei.angular.ui",["angular-locker","ngAnimate","angular-click-outside"]).controller("userSelectController",t).directive("userSelect",i);t.$inject=["$rootScope","$scope","$http","$modal_","userService","alertService","$filter","license","$stateParams","permissions","providerJudgement","ConsoleConfig"];function t(e,u,c,r,d,f,p,t,i,n,m,a){u.$watch("selecteduser",function(){if(u.selecteduser!=null&&typeof u.selecteduser=="object"){u.username=u.selecteduser.name;if(u.sessiontype=="USB_PHONE"){u.$emit("selectedUser",u.selecteduser,u.componentId)}}else if(u.selecteduser!=null&&(typeof u.selecteduser=="string"||typeof u.selecteduser=="number")){if(u.selecteduser==""){c({url:"user/"+u.selecteduser+".json",method:"GET",params:{}}).success(function(e,t,i,r){if(e.success){u.username=e.json.name}})}else if(u.selecteduser==="${current_user_id}"){u.username="（当前客服）"}else{c({url:"user/"+u.selecteduser+"/no_access_scope.json",method:"GET",params:{}}).success(function(e,t,i,r){if(e.success){u.username=e.json.name}})}}else{u.username=u.defaultUserName||""}});if(u.defaultUserName&&!u.selecteduser){u.username=u.defaultUserName}u.placeholder=u.userPlaceholder||"输入关键字搜索客户";if(u.usertype=="all"){if(u.ticketid){u.placeholder=u.userPlaceholder||"搜索替换客户"}}var o=1,s=20,l=true,h;function g(e){o=1;l=true;u.users=[];if(n.hasPermission("customer_create")){if(u.unableAddUser){if(!e){u.users.unshift({id:"${current_user_id}",name:"（当前客服）",email:"",mobilePhone:""})}}else{u.withCreate=true;u.users.unshift({id:0,name:"+ 添加客户",email:"",mobilePhone:""})}}}u.loadUsers=function(e){var t="";if(e!=h){g(e);h=e}if(l){t="/api/v1/engineer_customer_simple_list.json.json?pageSize="+s+"&key="+e+"&pageNo="+o++;if(u.usertype=="engineer"){t+="&queryUserType=engineer"}else if(u.usertype=="all"){if(u.byAccessScope==false){t+="&byAccessScope=false"}}else{t+="&queryUserType=customer"}return c.get(t,{}).then(function(e){var t=e.data;if(t.status==0&&t.result){u.users=u.users.concat(t.result.users);l=t.result.users.length==s}return u.users})}else{return u.users}};u.loadMore=function(){u.$broadcast("typeahead-reload",u.username)};u.$on("reset-data-source",function(){g()});u.clear=function(e,t){if(!t||t&&t===u.componentId){u.selecteduser=null;u.username=u.defaultUserName||null;u.$emit("selectedUser",null,u.componentId)}};u.$on("clear-selected-user",u.clear);u.onFocus=function(){u.username=u.defaultUserName||""};u.onBlur=function(){u.inputNewUser=u.username;if(u.selecteduser!=null){u.username=u.selecteduser.name}else{u.username=u.defaultUserName||""}};u.onSelect=function(e,t,i,r){void 0;v(e)};var v=function(e){if(e.id===0&&n.hasPermission("customer_create")){u.hideModal=function(){t.$promise.then(t.hide)};c.get("user_group_list.json?_count=999&_do_count=false&_fields=id,name,shared",{}).then(function(e){u.userGroups=e.data.userGroups});u.newUser={};u.$save=function(){var e=/[\\\[\]]/im;if(u.newUser.email&&!verifyEmailAddress(u.newUser.email)){f.add("邮件地址需由字母、数字或下划线组成","danger");return false}if(u.newUser.mobilePhone&&!validMobilePhone(u.newUser.mobilePhone)){f.add("手机号码格式不正确","danger");return false}if(u.newUser.password&&u.newUser.password.length<6){f.add("密码格式不正确，不能包含非法字符和汉字，长度在6-16位之间，请修改","danger");return false}else if(u.newUser.password&&u.newUser.password.length>5&&e.test(u.newUser.password)){f.add("密码格式不正确，不能包含非法字符和汉字，长度在6-16位之间，请修改","danger");return false}if(!m.isTrue()){return false}var t;var i=u.userCustomFields;var r=i.length;var n=[];var a;for(var o=0;o<r;o++){a={};t=i[o].customField;if(t.type=="date_to_date"){if(t.startTime||t.endTime){if(t.startTime&&t.endTime){var s=p("date")(t.startTime,"yyyy/MM/dd").toString();var l=p("date")(t.endTime,"yyyy/MM/dd").toString();a.value=s+"-"+l;a.customField=t;n.push(a)}else{f.add("请填写完整"+t.title,"danger");return false}}else{if(t.required){f.add("请填写完整"+t.title,"danger");return false}else{continue}}}else if(t.type=="cascade_options"){if(t.required){if(i[o].value=="-"){f.add("请填写完整"+t.title,"danger");return false}}if(i[o].value){a.value=i[o].value;a.customField=t;n.push(a)}}else{if(t.required){if(!i[o].value){f.add("请填写完整"+t.title,"danger");return false}}if(i[o].value){if(t.type=="date"){i[o].value=p("date")(i[o].value,"yyyy/MM/dd").toString()}a.value=i[o].value;a.customField=t;n.push(a)}}}u.newUser.customerCustomFields=n;d.add(u.newUser,function(e){if(e.success){u.hideModal();c({url:"reset_user_password.json",method:"POST",data:{userId:e.id,password:u.newUser.password}}).success(function(e,t,i,r){});u.selecteduser={id:e.id,name:u.newUser.name,userGroup:u.newUser.userGroup};u.username=u.selecteduser.name;u.$emit("selectedUser",u.selecteduser,u.componentId)}else{if(e.message!=null){var t="";if(e.message=="FIELD_NOT_EXIST"){t="自定义字段未找到"}else if(e.message.indexOf("REQUIRED_FIELD_IS_NULL_")>=0){var i=e.message.split("REQUIRED_FIELD_IS_NULL_")[1];var r;var n=u.newUser.customerCustomFields;for(var a in n){r=n[a].customField.id;if(i==r){t="请填写"+n[a].customField.title;break}}}else if(e.message.indexOf("FIELD_ERROR_")>=0){var i=e.message.split("FIELD_ERROR_")[1];var r;var n=u.newUser.customerCustomFields;for(var a in n){r=n[a].customField.id;if(i==r){t="请正确填写"+n[a].customField.title;break}}}else{t=e.message}f.add(p("translate")(t),"danger")}else{f.add("保存失败","danger")}}})};u.moreField=false;u.showMoreField=function(){u.moreField=true;var e=u.userCustomFields;var t=e.length;var i=[];var r=[];var n;for(var a=0;a<t;a++){n=e[a].customField;n.moreField=true;if(n.required==true){i.push(e[a])}else{r.push(e[a])}}u.userCustomFields=i.concat(r)};var i=function(e){var t=e;var i=[];for(var r=0;r<t.length;r++){var n=t[r];var a={id:null,value:n.value,customField:null};if(n.type=="options"){var o=jQuery.parseJSON(n.customFieldOptions);n.customFieldOptions=o;if(n.value==undefined){a.value=o[0].value}if((n.value==undefined||n.value=="")&&n.defaultValue){for(var s=0;s<o.length;s++){if(o[s].value==n.defaultValue){a.value=n.defaultValue}}}}if(n.type=="checkbox"){if(n.value=="true"){a.value=true}else{a.value=false}}if(n.type=="ip"||n.type=="url"||n.type=="mobile_phone"||n.type=="currency"){n.type="text"}if(n.notes!=undefined&&n.notes.length>40){n.notes=n.notes.substring(0,12)+". . . "}if(n.value){n.value=""}if(n.url){if(n.url.toLowerCase().indexOf("http://")!=0){n.url="http://"+n.url;void 0}if(n.url.indexOf("?")<0){a.fromParams="?"}else{a.fromParams="&"}var l=new String(n.url);if(l.indexOf("{value}")>0){l=l.replaceAll("{value}",a.value)}else{l=l+a.value}a.valueUrl=l}if(n.type=="date"){n.startForm=false}else if(n.type=="date_to_date"){n.startTimeForm=false;n.endTimeForm=false;if(n.value){var c=n.value.split("-");n.startTime=c[0];n.endTime=c[1]}}a.customField=n;a.id=n.userCustomFieldId;if(n.required){n.moreField=true}else{n.moreField=false}i.push(a)}u.userCustomFields=i};if(u.userId==undefined){c.get("custom_field.json?scope=user&active=true").success(function(e,t){i(e.json)})}else{c.get("user_custom_field.json?userId="+u.userId).success(function(e,t){i(e.json)})}u.datepickers={startTo:false,updateFrom:false,updateTo:false};u.open=function(e,t){e.preventDefault();e.stopPropagation();if(t.startForm){t.startForm=false}else{t.startForm=true}};u.timeFrameOpen=function(e,t,i){e.preventDefault();e.stopPropagation();if(i=="startTimeForm"){t.startTimeForm=!t.startTimeForm}else{t.endTimeForm=!t.endTimeForm}};u.newUser.name=u.inputNewUser;var t=r({scope:u,title:"添加客户",contentTemplate:"source/views/customer/user_add.html",html:true,show:true,placement:"top"})}else{u.selecteduser=e;u.username=e.name;u.$emit("selectedUser",u.selecteduser,u.componentId)}}}i.$inject=[];function i(){return{restrict:"EA",templateUrl:"/source/scripts/directives/user-select/user-select.html",controller:"userSelectController",scope:{selecteduser:"=",usertype:"=",byAccessScope:"=",ticketid:"=",webchatid:"=",chatisclose:"=",chatbtngroupstatus:"=",sessiontype:"=",getusertickets:"&",canClear:"=",unableAddUser:"=",userPlaceholder:"=",defaultUserName:"@"},link:function(e,t,i){if(i.componentId){e.componentId=i.componentId}}}}})(angular);(function(){"use strict";angular.module("com.ewei.angular.ui").directive("customerAndCutstomerGroupSelect",e).controller("customerAndCutstomerGroupSelectController",t);e.$inject=[];function e(){return{restrict:"EA",templateUrl:"/source/scripts/directives/customer-and-customer-group-select/customer-and-customer-group-select.html",controller:"customerAndCutstomerGroupSelectController",scope:{placeholder:"@",timeOut:"="},link:function(e,t,i){if(i.componentId){e.componentId=i.componentId}}}}t.$inject=["$scope","$http"];function t(i,r){i.key="";i.type="customer";i.loading=false;i.customerList=[];i.customerGroupList=[];i.isopen=false;var n=1,a=20,o=false,s=false,t,l=null;function c(){n=1;o=false;s=false;i.customerList=[];i.customerGroupList=[]}function u(e){var t="/api/v1/engineer_customer_simple_list.json.json?queryUserType=customer&pageSize="+a+"&key="+e+"&pageNo="+n++;r.get(t,{}).then(function(e){e=e.data;i.loading=false;if(e.status===0&&e.result){e.result.users.forEach(function(e){if(e.name&&e.groupName){e.nameA=e.name+"/"+e.groupName}else if(e.name&&!e.groupName){e.nameA=e.name}else if(!e.name&&e.groupName){e.nameA=e.groupName}if(e.mobilePhone&&e.email){e.contactA=e.mobilePhone+"["+e.email+"]"}else if(e.mobilePhone&&!e.email){e.contactA=e.mobilePhone}else if(!e.mobilePhone&&e.email){e.contactA=e.email}});if(s){i.customerList=i.customerList.concat(e.result.users)}else{i.customerList=e.result.users}o=e.result.users.length===a}})}function d(e){org.ewei.sdk.OpenUserGroupApi().listUserGroupByFields({key:e,fields:"id,name",page:{pageNumber:n++,pageSize:a}}).then(function(e){i.loading=false;if(s){i.customerGroupList=i.customerGroupList.concat(e.list)}else{i.customerGroupList=e.list}o=e.list.length===a})}function f(e){if(i.loading)return;if(l){clearTimeout(l)}l=setTimeout(function(e){i.loadWithType(e)},i.timeOut||1e3,e)}i.onFocus=function(e){i.isopen=true;if(i.key===""&&i.customerList.length===0&&i.customerGroupList.length===0){c();f(i.key)}e.stopPropagation()};i.onChanged=function(){f(i.key)};i.selectCustomer=function(e){i.isopen=false;i.$emit("on-selected-customer",e,i.componentId)};i.selectCustomerGroup=function(e){i.isopen=false;i.$emit("on-selected-customer-group",e,i.componentId)};i.switchTab=function(e){i.type=e;c();i.loadWithType(i.key)};i.loadWithType=function(e){if(e!==t){t=e;c()}i.loading=true;if(i.type==="customer"){u(e)}if(i.type==="customerGroup"){d(e)}};i.loadMore=function(e){if(o){s=true;f(e)}}}})();angular.module("com.ewei.angular.ui").directive("helper",[function(){return{restrict:"E",replace:true,template:'<div class="fixed bottom0 cursorhand box75 c99 padding10px size14" style="right: 20px;"  data-template="source/views/aside/helper.html" bs-aside="helper" ng-if="helper"><i class="fa fa-question-circle"></i> 使用帮助</div>'}}]);angular.module("com.ewei.angular.ui").controller("serviceCatalogSelectController",["$scope","serviceCatalogService","permissions","$http",function(h,r,e,t){h.loadServiceCatalogs=function(e,t){if(h.nullShowName==null||h.nullShowName==undefined){h.nullShowName="-"}var i=function(e){if(h.selectedservicecatalog!=null){h.catSelected=true}h.serviceCatalogs=[];angular.forEach(e.serviceCatalogs,function(e){var t=e;if(angular.isString(e)){e=e.replace(/[\r]/g,"").replace(/[\n]/g,"");t=angular.fromJson(e)}h.serviceCatalogs.push(t)});if(h.selectedservicecatalog==null){h.parentServiceCatalog=null;h.showServiceCatalogs=h.serviceCatalogs;h.selectedServiceCatalogNameChain=h.nullShowName;h.oldServiceCatalogNameChain=null}else{h.selectedServiceCatalogNameChain=d();h.oldServiceCatalogNameChain=h.selectedServiceCatalogNameChain;for(var t=0;t<h.serviceCatalogs.length;t++){var i=h.serviceCatalogs[t];if(i.id&&h.selectedservicecatalog.id&&i.id==h.selectedservicecatalog.id){h.parentServiceCatalog=null;h.showServiceCatalogs=h.serviceCatalogs;return false}for(var r=0;r<i.children_count;r++){var n=i.children[r];if(n.id&&h.selectedservicecatalog.id&&n.id==h.selectedservicecatalog.id){h.parentServiceCatalog=i;h.showServiceCatalogs=i.children;return false}for(var a=0;a<n.children_count;a++){var o=n.children[a];if(o.id&&h.selectedservicecatalog.id&&o.id==h.selectedservicecatalog.id){h.parentServiceCatalog=n;h.showServiceCatalogs=n.children;return false}for(var s=0;s<o.children_count;s++){var l=o.children[s];if(l.id&&h.selectedservicecatalog.id&&l.id==h.selectedservicecatalog.id){h.parentServiceCatalog=o;h.showServiceCatalogs=o.children;return false}for(var c=0;c<n.children_count;c++){var u=l.children[c];if(u){if(u.id&&h.selectedservicecatalog.id&&u.id==h.selectedservicecatalog.id){h.parentServiceCatalog=l;h.showServiceCatalogs=l.children;return false}}}}}}}}};r.run("",{},false,function(e){i(e.result)})};var i=function(e){for(var t=0;t<h.serviceCatalogs.length;t++){var i=h.serviceCatalogs[t];if(i.id==e){return null}for(var r=0;r<i.children_count;r++){var n=i.children[r];if(n.id==e){return i}for(var a=0;a<n.children_count;a++){var o=n.children[a];if(o.id==e){return n}}}}return null};var n=function(e){var t=e.name||"";if(e.parent){t=e.parent.name+"/"+t;if(e.parent.parent){t=e.parent.parent.name+"/"+t;if(e.parent.parent.parent){t=e.parent.parent.parent.name+"/"+t;if(e.parent.parent.parent.parent){t=e.parent.parent.parent.parent.name+"/"+t}}}}return t};var d=function(){void 0;if(typeof h.selectedservicecatalog=="string"||typeof h.selectedservicecatalog=="number"){if(!isNaN(h.selectedservicecatalog)){return a(h.selectedservicecatalog)}}else if(typeof h.selectedservicecatalog=="object"){if(h.selectedservicecatalog.id){var e=a(h.selectedservicecatalog.id);if(e){return e}else{var t=n(angular.copy(h.selectedservicecatalog));return t}}else{return"-"}}if(h.nullShowName!=null){return h.nullShowName}else{return"-"}};var a=function(e){if(h.serviceCatalogs){for(var t=0;t<h.serviceCatalogs.length;t++){var i=h.serviceCatalogs[t];if(i.id&&e&&i.id==e){return i.name}for(var r=0;r<i.children_count;r++){var n=i.children[r];if(n.id&&e&&n.id==e){return i.name+"/"+n.name}for(var a=0;a<n.children_count;a++){var o=n.children[a];if(o.id&&e&&o.id==e){return i.name+"/"+n.name+"/"+o.name}for(var s=0;s<o.children_count;s++){var l=o.children[s];if(l.id&&e&&l.id==e){return i.name+"/"+n.name+"/"+o.name+"/"+l.name}for(var c=0;c<l.children_count;c++){var u=l.children[c];if(u.id&&e&&u.id==e){return i.name+"/"+n.name+"/"+o.name+"/"+l.name+"/"+u.name}}}}}}}};h.back=function(e){if(h.parentServiceCatalog==null||i(h.parentServiceCatalog.id)==null){h.showServiceCatalogs=h.serviceCatalogs;h.parentServiceCatalog=null}else{h.parentServiceCatalog=i(h.parentServiceCatalog.id);h.showServiceCatalogs=h.parentServiceCatalog.children}h.isopen=true;e.stopPropagation()};h.clear=function(){h.selectedservicecatalog=null;h.selectedServiceCatalogNameChain=h.nullShowName;h.catSelected=false;h.parentServiceCatalog=null;h.showServiceCatalogs=h.serviceCatalogs;h.$emit("selectedServiceCatalog",null,null,h.oldServiceCatalogNameChain);h.oldServiceCatalogNameChain=null};h.selectServiceCatalog=function(e,t){var i=h.showServiceCatalogs[e];if(i.children_count>0){h.parentServiceCatalog=i;h.showServiceCatalogs=i.children;h.isopen=true;t.stopPropagation()}else{h.selectedservicecatalog=i;h.selectedServiceCatalogNameChain=d();h.catSelected=true;h.$emit("selectedServiceCatalog",h.selectedservicecatalog,h.selectedServiceCatalogNameChain,h.oldServiceCatalogNameChain);h.oldServiceCatalogNameChain=h.selectedServiceCatalogNameChain}};h.selectParentServiceCatalog=function(){h.selectedservicecatalog=h.parentServiceCatalog;h.selectedServiceCatalogNameChain=d();h.catSelected=true;h.$emit("selectedServiceCatalog",h.selectedservicecatalog,h.selectedServiceCatalogNameChain,h.oldServiceCatalogNameChain);h.oldServiceCatalogNameChain=h.selectedServiceCatalogNameChain};h.stopPropagation=function(e){e.stopPropagation()};var g=function(e,t){var i=0;for(var r=0;r<e.length;r++){if(e[r].id===t){i=r;break}}return i+1};h.searchCatalog=function(e){h.searchCatalogList=[];if(!e){return false}var t=new RegExp(e,"i");var i=new RegExp(e,"g");for(var r=0;r<h.serviceCatalogs.length;r++){var n=h.serviceCatalogs[r];var a=[];var o=null;a.push({id:n.id,name:n.name});if(t.test(n.name)){o=_.map(a,function(e){return e.name});h.searchCatalogList.push({id:n.id,name:n.name,listName:o[0].replace(i,"<b>"+e+"</b>")})}for(var s=0;s<n.children_count;s++){var l=n.children[s];a=a.slice(0,g(a,n.id));a.push({id:l.id,name:l.name});if(t.test(l.name)){o=_.map(a,function(e){return e.name});h.searchCatalogList.push({id:l.id,name:l.name,listName:o[0]+"/"+l.name.replace(i,"<b>"+e+"</b>")})}for(var c=0;c<l.children_count;c++){var u=l.children[c];a=a.slice(0,g(a,l.id));a.push({id:u.id,name:u.name});if(t.test(u.name)){o=_.map(a,function(e){return e.name});h.searchCatalogList.push({id:u.id,name:u.name,listName:o.slice(0,o.length-1).join("/")+"/"+u.name.replace(i,"<b>"+e+"</b>")})}for(var d=0;d<u.children_count;d++){var f=u.children[d];a=a.slice(0,g(a,u.id));a.push({id:f.id,name:f.name});if(t.test(f.name)){o=_.map(a,function(e){return e.name});h.searchCatalogList.push({id:f.id,name:f.name,listName:o.slice(0,o.length-1).join("/")+"/"+f.name.replace(i,"<b>"+e+"</b>")})}for(var p=0;p<f.children_count;p++){var m=f.children[p];a=a.slice(0,g(a,f.id));a.push({id:m.id,name:m.name});if(t.test(m.name)){o=_.map(a,function(e){return e.name});h.searchCatalogList.push({id:m.id,name:m.name,listName:o.slice(0,o.length-1).join("/")+"/"+m.name.replace(i,"<b>"+e+"</b>")})}}}}}}};h.selectSearchCatalog=function(e){h.selectedservicecatalog=e;h.$emit("selectedServiceCatalog",e)};h.loadServiceCatalogs();h.click=function(){h.parentServiceCatalog=null;h.showServiceCatalogs=h.serviceCatalogs};h.$watch("selectedservicecatalog",function(){if(h.selectedservicecatalog==null||h.selectedservicecatalog==""){h.selectedservicecatalog=null;h.catSelected=false;h.selectedServiceCatalogNameChain=h.nullShowName}else{h.selectedServiceCatalogNameChain=d();h.catSelected=!!h.selectedServiceCatalogNameChain}h.$emit("serviceCatalogList",h.selectedServiceCatalogNameChain)})}]).directive("serviceCatalogSelect",function(){return{restrict:"E",replace:true,scope:{selectedservicecatalog:"=",nullShowName:"@",disabled:"=",singleLine:"="},controller:"serviceCatalogSelectController",templateUrl:"/source/scripts/directives/service-catalog-select/service-catalog-select.html"}});angular.module("com.ewei.angular.ui").directive("serviceCatalogShow",[function(){return{restrict:"A",replace:false,scope:{servicecatalog:"="},template:"",link:function(e,t,i){var r=function(e){if(e!=null&&e.parent!=null){t.prepend(e.parent.name+"/");r(e.parent)}};e.$watch("servicecatalog",function(){t.empty();if(e.servicecatalog!=null){t.prepend(e.servicecatalog.name);r(e.servicecatalog)}else{t.prepend("-")}},true)}}}]);angular.module("com.ewei.angular.ui").controller("engineerOrWorkflowSelectController",["$rootScope","$scope","$http","$modal_","serviceDeskService","engineerService","workflowTemplateService","permissions","ConsoleConfig","serviceCatalogExtendService","apiListWorkflowsService","coreModelService","providerJudgement",function(e,n,t,r,i,a,o,s,l,c,u,d,f){n.showMoreInfoBar=n.showMoreInfoBar||"false";n.myEngineerId=l.engineer.id;n.showSearchList=function(e){e.stopPropagation()};n.searchedData={workflows:[],serviceDesks:[]};var p=function(){n.searchedData.workflows=[];n.searchedData.serviceDesks=[];n.searchName=""};n.searchEngineerOrWorkflow=function(e){n.searchedData.workflows=[];n.searchedData.serviceDesks=[];var i=e.target.value.trim();if(i.length<1){n.showServiceDeskList=true;n.showEngineerList=false;n.showWorkflowList=false;return false}n.showServiceDeskList=false;n.showEngineerList=false;n.showWorkflowList=false;if(angular.isArray(n.workflowTemplates)&&!n.hideworkflow){n.workflowTemplates.forEach(function(e){if(e.name.search(new RegExp(i,"i"))>-1){n.searchedData.workflows.push(e)}})}n.serviceDesks.forEach(function(e){var t={id:e.id,name:e.name,engineers:[]};e.engineers.forEach(function(e){if(e.username&&e.username.search(new RegExp(i,"i"))>-1||e.email&&e.email.search(new RegExp(i,"i"))>-1){t.engineers.push(e)}});if(e.name.search(new RegExp(i,"i"))>-1||t.engineers.length>0){n.searchedData.serviceDesks.push(t)}});n.getMoreInfo(i)};n.selectWorkflowTemplate=function(e){if(!f.isTrue()){return false}var t={engineer:angular.copy(n.selectedengineer),serviceDesk:angular.copy(n.selectedservicedesk),workflowTemplate:angular.copy(n.selectedworkflow)};n.selectedworkflow=e;if(n.ticketid==null){h()}n.selectedengineer=null;n.selectedservicedesk=null;n.showServiceDeskList=false;n.showWorkflowList=true;n.showEngineerList=false;n.catSelected=true;n.selectedworkflow.oldTicket=t;n.$emit("selectedWorkflow",n.selectedworkflow)};n.$watch("selectedworkflow",function(){if(n.selectedworkflow&&n.selectedworkflow.id&&n.selectedworkflow.name==null&&n.ticketid==null){h();n.showWorkflowList==true}else if(n.selectedworkflow==null&&n.showWorkflowList==true&&n.ticketid==null){n.showWorkflowList=false}});n.selectSearchedServiceDesk=function(e,t){if(!f.isTrue()){return false}var i={engineer:angular.copy(n.selectedengineer),serviceDesk:angular.copy(n.selectedservicedesk),workflowTemplate:angular.copy(n.selectedworkflow)};n.selectedservicedesk=e;n.selectedengineer=null;n.selectedworkflow=null;n.catSelected=false;n.selectedservicedesk.oldTicket=i;n.$emit("selectedServiceDesk",n.selectedservicedesk)};var m=function(e){n.serviceDesks=[];var t={};e.serviceDesks.forEach(function(e){t[e.name]=e});var i=Object.keys(t).sort(function(e,t){return e.localeCompare(t,"zh-CN-u-co-pinyin")});var r=[];i.forEach(function(e){r.push(t[e])});e.serviceDesks=r;angular.forEach(e.serviceDesks,function(e){if(e&&n.selectedworkflow==null&&n.selectedengineer!=null&&n.selectedservicedesk!=null&&n.selectedservicedesk.id==e.id){n.tempServiceDesk=e;n.engineers=e.engineers;n.catSelected=true;n.showEngineerList=false;n.showServiceDeskList=true;n.showWorkflowList=false;n.getMoreInfo()}e&&n.serviceDesks.push(e)})};n.loadServiceDesksAndWorkflows=function(){c.run("",{},false,function(e){m(e.result)});n.workflowTemplates=d.detail.workflows.gets(d.list.workflows.gets(1));if(!n.workflowTemplates&&n.workflowTemplates.length==0){u.getWorkflowTemplate("list.workflows",{page:{pageNumber:1,pageSize:9999}},function(e){n.workflowTemplates=e;void 0})}if(n.selectedworkflow!=null){h();n.catSelected=true;n.showWorkflowList=true;n.showServiceDeskList=false;n.showEngineerList=false}else if(n.selectedservicedesk!=null&&n.selectedengineer==null){n.catSelected=false;n.showServiceDeskList=true;n.showEngineerList=false;n.showWorkflowList=false}else if(n.selectedservicedesk==null){n.showServiceDeskList=true;n.showEngineerList=false;n.showWorkflowList=false}};var h=function(){n.workflowTemplates.forEach(function(e){if(e.id===parseInt(n.selectedworkflow.id)){n.selectedworkflow.name=e.name}})};n.$on("load_workflows",function(e,t){h()});n.openWorkflow=false;n.switchWorkflow=function(){n.openWorkflow=n.openWorkflow?false:true};n.back=function(e){n.showServiceDeskList=true;n.showEngineerList=false;n.showWorkflowList=false;n.isopen=true;if(n.serviceDesks==null){n.loadServiceDesksAndWorkflows()}e.stopPropagation();n.getMoreInfo()};n.selectWorkflow=function(e){n.showServiceDeskList=false;n.showEngineerList=false;n.showWorkflowList=true;n.isopen=true;e.stopPropagation()};n.selectServiceDesk=function(e,t){if(!f.isTrue()){return false}var i={engineer:angular.copy(n.selectedengineer),serviceDesk:angular.copy(n.selectedservicedesk),workflowTemplate:angular.copy(n.selectedworkflow)};var r=e;if(angular.isDefined(r.engineers)&&r.engineers.length>0){n.tempServiceDesk=r;n.engineers=r.engineers;n.showServiceDeskList=false;n.showWorkflowList=false;n.showEngineerList=true;n.isopen=true;t.stopPropagation();n.getMoreInfo()}else{n.selectedservicedesk=r;n.selectedengineer=null;n.selectedworkflow=null;n.catSelected=false;n.selectedservicedesk.oldTicket=i;n.$emit("selectedServiceDesk",n.selectedservicedesk)}};n.getMoreInfo=function(e){if(n.showMoreInfoBar==="false")return;var t=[];var i=[];var r=n.engineers||[];if(e&&n.searchedData&&n.searchedData.serviceDesks){r=[];n.searchedData.serviceDesks.forEach(function(e){if(e.engineers&&e.engineers.length>0){e.engineers.forEach(function(e){if(i.indexOf(e.id)===-1){t.push(e.user.id);i.push(e.id)}r.push(e)})}})}else{(n.engineers||[]).forEach(function(e){t.push(e.user.id);i.push(e.id)})}if(i.length>0){n.getTicketCount(i,r);n.getChatCount(i,r)}if(t.length>0){n.getOnlineList(t,r)}};n.getOnlineList=function(e,i){org.ewei.sdk.OpenUserOnlineApi().listByUserIds({userIds:e}).then(function(e){if(e.length>0){e.forEach(function(t){var e=_.filter(i,function(e){return e.user.id===t.userId});e.forEach(function(e){e.status=t})})}})};n.getChatCount=function(e,i){org.ewei.sdk.OpenChatApi().countByEngineerIds({engineerIds:e}).then(function(e){if(e.length>0){e.forEach(function(t){var e=_.filter(i,function(e){return e.id===t.engineerId});e.forEach(function(e){e.chatCount=t.count})})}})};n.getTicketCount=function(e,i){org.ewei.sdk.OpenTicketApi().countByEngineerIds({engineerIds:e}).then(function(e){if(e.length>0){e.forEach(function(t){var e=_.filter(i,function(e){return e.id===t.engineerId});e.forEach(function(e){e.ticketCount=t.count})})}})};n.selectServiceDeskInEngineerList=function(){if(!f.isTrue()){return false}var e={engineer:angular.copy(n.selectedengineer),serviceDesk:angular.copy(n.selectedservicedesk),workflowTemplate:angular.copy(n.selectedworkflow)};n.selectedservicedesk=n.tempServiceDesk;n.selectedengineer=null;n.selectedworkflow=null;n.catSelected=false;n.selectedservicedesk.oldTicket=e;n.$emit("selectedServiceDesk",n.selectedservicedesk)};n.selectEngineer=function(e,t){if(!f.isTrue()){return false}var i={engineer:angular.copy(n.selectedengineer),serviceDesk:angular.copy(n.selectedservicedesk),workflowTemplate:angular.copy(n.selectedworkflow)};if(angular.isObject(t)){n.selectedservicedesk=t}else{n.selectedservicedesk=n.tempServiceDesk}n.selectedengineer=e;n.selectedworkflow=null;n.showServiceDeskList=false;n.showWorkflowList=false;n.showEngineerList=true;n.catSelected=true;n.$emit("selectedEngineer",{engineer:n.selectedengineer,serviceDesk:n.selectedservicedesk,oldTicket:i})};var g=function(e){for(var t=0;t<n.serviceDesks.length;t++){var i=n.serviceDesks[t];if(i.id==e){return i.engineers}}return[]};n.assignMe=function(){if(!f.isTrue()){return false}var t={engineer:angular.copy(n.selectedengineer),serviceDesk:angular.copy(n.selectedservicedesk),workflowTemplate:angular.copy(n.selectedworkflow)};a.get({id:l.engineer.id},function(e){n.selectedengineer=e.json;n.selectedservicedesk=e.json.defaultServiceDesk;n.selectedworkflow=null;n.tempServiceDesk=n.selectedservicedesk;n.engineers=g(n.selectedservicedesk.id);n.showServiceDeskList=false;n.showWorkflowList=false;n.showEngineerList=true;n.catSelected=true;n.$emit("selectedEngineer",{engineer:n.selectedengineer,serviceDesk:n.selectedservicedesk,oldTicket:t,asignMe:true})})};n.viewWorkflow=function(){org.ewei.sdk.OpenActivitiWorkflowTemplateApi().getById({id:parseInt(n.selectedworkflow.id)}).then(function(e){n.workflowRootNode=e.rootNode;var t=n.selectedworkflow.name||"查看工作流";var i=r({scope:n,title:t,contentTemplate:"source/scripts/directives/alert-workflows/alert-workflows.html",html:true,show:true,placement:"center"});n.$hide=function(){i.$promise.then(i.hide)}})};n.$on("assign_me",function(e,t){n.assignMe()});if(s.hasPermission("ticket_update")){n.loadServiceDesksAndWorkflows()}n.click=function(){if(n.isopen){n.getMoreInfo()}n.showServiceDeskList=true;n.showEngineerList=false;n.showWorkflowList=false;p()}}]).directive("engineerOrWorkflowSelect",function(){return{restrict:"E",replace:true,scope:{selectedengineer:"=",selectedservicedesk:"=",selectedworkflow:"=",ticketid:"=",assignable:"@",showinticketdetail:"=",activitiWorkflowNodeUid:"=",hideworkflow:"=",showMoreInfoBar:"@"},controller:"engineerOrWorkflowSelectController",templateUrl:"/source/scripts/directives/engineer-or-workflow-select/engineer-or-workflow-select.html"}});(function(e){"use strict";e.module("com.ewei.angular.ui").directive("customerGroupSelect",t).controller("customerGroupSelectController",i);t.$inject=[];function t(){return{restrict:"EA",replace:true,scope:{selectedcustomergroup:"="},controller:"customerGroupSelectController",templateUrl:"/source/scripts/directives/customer-group-select/customer-group-select.html"}}i.$inject=["$scope","$http"];function i(i,e){i.searchedData={userGroups:[]};e.get("user_group_list.json?_count=999&_do_count=false&_fields=id,name,shared",{}).then(function(e){i.searchedData.userGroups=i.userGroups=e.data.userGroups});i.searchUserGroup=function(e){i.searchedData.userGroups=[];var t=e.target.value.trim();if(t.length<1){i.searchedData.userGroups=i.userGroups;return false}i.userGroups.forEach(function(e){if(e.name&&e.name.search(new RegExp(t,"i"))>-1){i.searchedData.userGroups.push(e)}})};i.showSearchList=function(e){e.stopPropagation()};i.selectSearchedCustomerGroup=function(e,t){i.selectedcustomergroup=e}}})(angular);(function(U){"use strict";angular.module("com.ewei.angular.ui").directive("workflowTree",e).controller("workflowTreeCtrl",t);e.$inject=[];function e(){return{restrict:"EA",replace:true,scope:{tree:"=",showOnly:"@",doingUid:"="},controller:"workflowTreeCtrl",templateUrl:"source/scripts/directives/workflow-tree/workflow-tree.html",link:function(e,t,i){}}}t.$inject=["alertService","$timeout","$filter","$http","$scope","$modal_","allConditionOptionsWorkflow","anyConditionOptionsWorkflow","compareOptionsWorkflow","ticketStatusCompareService","commonTools"];function t(a,t,n,i,c,r,e,o,s,l,u){var d={start:"开始",handler:"请选择处理人",getway:{good:"自定义条件",bad:"请选择条件"},filterHandler:function(e,t){if(t==="DEFAULT_SERVICE_DESK_NAME"){t="默认服务台"}if(t&&e){return e+"/"+t}else if(t){return t}else{return this.handler}},filterGetway:function(e,t){var i=0;e.forEach(function(e){if(e.attribute!=="-1"){i++}});t.forEach(function(e){if(e.attribute!=="-1"){i++}});return i>0?this.getway.good:this.getway.bad}};function f(e,r){var n=[];try{(function e(t){if(t.uId===r){throw"oh! got it"}n.push(t.uId);if(t.children&&t.children.length>0){for(var i=0;i<t.children.length;i++){e(t.children[i])}n.pop()}else{n.pop()}})(e,r)}catch(e){}return n}function p(e,t){if(e){if(e.uId===t){return e}else{return p(e.children[0],t)||p(e.children[1],t)}}else{return null}}function m(e){if(e.serviceDesk||e.engineer){c.modal.dialog.$promise.then(c.modal.dialog.hide);return true}else{a.add("请选择处理人","danger");return false}}function h(){var e=[],t=null,i=0;U.utils.traverse(c.tree,function(e){if(e.type==="getway"){i++}});if(i<8){e=e.concat(c.andConditions,c.orConditions);for(var r=0;r<e.length;r++){if(e[r].attribute!=="-1"){var n=C(e[r]);if(n.option&&n.compare&&n.value){}else{t=n.option;break}}}if(t===null){c.modal.dialog.$promise.then(c.modal.dialog.hide);return true}else{a.add("条件【"+t+"】填写不完整,请检查","danger");return false}}else{a.add("条件节点最多只能8个","danger");return false}}function g(e){var t=f(e,c.doingUid);U.utils.traverse(e,function(e){if(t){if(t.indexOf(e.uId)!==-1){e.completed=true}else{e.completed=false}}if(e.uId===c.doingUid){e.doing=true}if(e.type==="handler"){if(e.display===undefined){e.display=d.filterHandler(e.engineer&&e.engineer.userName||null,e.serviceDesk.name)}}if(e.type==="getway"){if(e.display===undefined){e.display=d.filterGetway(e.andConditions,e.orConditions)}}})}c.$watch("tree",function(e,t){if(e!==t){g(e)}});c.modal={opType:"create",node:{type:"handler"},dialog:null};function v(e,l){c.modal.dialog=r({scope:c,title:e,contentTemplate:"source/scripts/directives/workflow-tree/workflow-tree-add-node.html",html:true,show:true,placement:"center"});c.saveNode=function(){if(c.modal.opType==="create"){var e=angular.copy(c.modal.node);var t=l.children||[];var i=U.utils.uuid(32,16).toLowerCase();t.forEach(function(e){e.parentUId=i});if(c.modal.node.type==="handler"){if(m(e)){l.children=[{display:d.filterHandler(e.engineer&&e.engineer.username||null,e.serviceDesk.name),type:e.type,engineerId:e.engineer&&e.engineer.id,serviceDeskId:e.serviceDesk.id,uId:i,parentUId:l.uId,children:t,valid:true}]}}if(c.modal.node.type==="getway"){var r=t[0]&&t[0].uId||U.utils.uuid(32,16).toLowerCase();var n=t[1]&&t[1].uId||U.utils.uuid(32,16).toLowerCase();var a=angular.copy(c.andConditions);var o=angular.copy(c.orConditions);if(h()){a.forEach(function(e){e.value=_(e)});o.forEach(function(e){e.value=_(e)});if(l.type==="handler"||l.type==="start"){l.children=[{display:d.filterGetway(a,o),type:e.type,andConditions:a,orConditions:o,uId:i,parentUId:l.uId,trueUId:r,falseUId:n,valid:true,children:[t[0]||{type:"handler",display:d.handler,parentUId:i,children:[],uId:r},t[1]||{type:"handler",display:d.handler,parentUId:i,children:[],uId:n}]}]}else if(l.type==="getway"){l.trueUId=i;l.falseUId=U.utils.uuid(32,16).toLowerCase();l.children=[{display:d.filterGetway(a,o),type:e.type,andConditions:a,orConditions:o,uId:i,parentUId:l.uId,trueUId:r,falseUId:n,valid:true,children:[t[0],t[1]]},{type:"handler",display:d.handler,parentUId:l.uId,children:[],uId:l.falseUId}]}}}}else if(c.modal.opType==="modify"){if(c.modal.node.type==="handler"){var s=angular.copy(c.modal.node);if(m(s)){l.display=d.filterHandler(s.engineer&&s.engineer.username||null,s.serviceDesk.name);l.engineerId=s.engineer&&s.engineer.id;l.serviceDeskId=s.serviceDesk.id;l.valid=true}}if(c.modal.node.type==="getway"){var a=angular.copy(c.andConditions);var o=angular.copy(c.orConditions);if(h()){a.forEach(function(e){e.value=_(e)});o.forEach(function(e){e.value=_(e)});l.display=d.filterGetway(a,o);l.andConditions=a;l.orConditions=o;l.valid=true}}}}}c.createNode=function(e){c.modal.opType="create";c.modal.opSubType=e.type;if(e.type==="start"){c.modal.node={type:"handler"}}else{c.modal.node={type:e.type}}y(c.modal.node);v("添加节点",e)};c.modifyNode=function(e){c.modal.opType="modify";c.modal.opSubType=e.type;c.modal.node={type:e.type};k(e);y(e);t(function(){v("编辑节点",e)},200)};c.removeNode=function(e){var t=p(c.tree,e.parentUId);if(t){if(e.type==="getway"){t.children=[]}else if(e.type==="handler"){if(t.type==="getway"){var i=U.utils.uuid(32,16).toLowerCase();if(t.trueUId===e.uId){t.children[0]={type:"handler",display:d.handler,parentUId:t.uId,children:[],uId:i}}if(t.falseUId===e.uId){t.children[1]={type:"handler",display:d.handler,parentUId:t.uId,children:[],uId:i}}}else{e.children.forEach(function(e){e.parentUId=t.uId});t.children=e.children}}}else{c.tree={type:"handler",display:d.handler,children:[],uId:U.utils.uuid(32,16).toLowerCase()}}};function k(e){c.modal.node.engineer={};c.modal.node.serviceDesk={};if(e.engineerId==="${current_engineer_id}"){e.engineer={name:"（当前客服）",id:"${current_engineer_id}"}}else{if(e.serviceDeskId){i({url:"service_desk/"+e.serviceDeskId+".json",method:"GET",params:{}}).success(function(e){c.modal.node.serviceDesk=e.json})}if(e.engineerId){i({url:"engineer/"+e.engineerId+".json",method:"GET",params:{}}).success(function(e){c.modal.node.engineer=e.json})}}}function y(e){c.andConditions=e.andConditions||[];c.orConditions=e.orConditions||[];var t=[];t=t.concat(c.andConditions,c.orConditions);t.forEach(function(e){x(e);I(e);w(e)});if(c.andConditions.length===0){c.andConditions=[{attribute:"-1",tally:"and"}]}if(c.orConditions.length===0){c.orConditions=[{attribute:"-1",tally:"or"}]}}function w(e){if(e.attribute==="createdAt"||e.attribute==="ticketMetric.responseAt"||e.attribute==="ticketMetric.pausedAt"||e.attribute==="ticketMetric.solvedAt"||e.attribute==="lastReply"||e.attribute==="customerLastReply"||e.attribute==="engineerLastReply"){e.value=parseInt(e.value)}else if(e.attribute==="deleteTicket"){if(e.value!=="无效信息"&&e.value!=="重复信息"&&e.value!=="恶意骚扰"){e.reason=e.value;e.value="其他原因"}}else if(e.valueType==="copyTo"){var t=e.value;t=t.replace("[${","").replace("!}]","").replace("copy_to_user_or_email_ticket_ids_","");var i=t.split(",");var r=[];var n=e.display.value.split(",");i.forEach(function(e,t){r.push({id:parseInt(e),name:n[t]})});e.value=r}else if(e.attribute==="user"){e.value=e.value}else if(e.attribute==="transfer"||e.attribute==="tripartite"||e.attribute==="autoClose"){return true}else if(e.attribute==="engineer"){A(e)}else if(e.attribute==="serviceDesk"){O(e)}else if(e.attribute==="requester.id"){L(e)}else if(e.attribute==="userGroup"){M(e)}else if(e.attribute==="addCC"){if(U.utils.isString(e.value)){e.value=JSON.parse(e.value)}}else if(e.attribute==="via"){if(U.utils.isString(e.value)){e.value=JSON.parse(e.value)}}else if(e.attribute==="status"){if(e.value){e.value=l.getCurrentStatus(e.value)}}else if(e.attribute==="serviceCatalog.id"){e.value={id:parseInt(JSON.stringify(e.value).replace(/[^0-9]/gi,""))}}if(e.valueType==="cascade_options"||e.valueType==="multi_options"||e.valueType==="options"){e.valueOptions.value=e.value}else if(e.valueType==="date"){e.value=u.parseDate(e.value,"yyyy/MM/dd")}else if(e.valueType==="date_time"){}else if(e.valueType==="date_to_date"){var a=e.value;a=a.split("-");e.startTime=u.parseDate(a[0],"yyyy/MM/dd");e.endTime=u.parseDate(a[1],"yyyy/MM/dd")}else if(e.valueType==="checkbox"){e.compare=e.value==="true"?"$eq_ticket_custom_field":"$ne_or_null_ticket_custom_field"}}function C(t){var i={option:null,compare:null,value:null};c.andConditionOptions.forEach(function(e){if(e.value===t.attribute){i.option=e.option}});t.compareOptions.forEach(function(e){if(e.value===t.compare){i.compare=e.option}});if(t.valueOptions&&(t.attribute.indexOf("ticketcustomfield_multi_options")>-1||t.attribute.indexOf("ticketcustomfield_cascade_options")>-1||t.attribute.indexOf("ticketcustomfield_options")>-1)){i.value=t.valueOptions.value}else if(t.attribute==="engineer"){if(t.engineer&&t.serviceDesk){var e="";if(t.engineer.nickname){e=t.engineer.nickname}if(t.engineer.username){e=t.engineer.username}i.value=t.serviceDesk.name+"/"+e}else if(t.engineer){i.value=t.engineer.name}}else if(t.valueType==="copyTo"){var r=[];t.value.forEach(function(e){r.push(e.name)});i.value=r.join(",")}else if(t.attribute==="transfer"||t.attribute==="tripartite"||t.attribute==="autoClose"){i.value=true}else if(t.value){if(t.attribute==="serviceDesk"){i.value=t.value}else if(t.attribute==="requester.id"){i.value=t.value}else if(t.attribute==="user"){i.value=t.value}else if(t.attribute==="serviceCatalog.id"){i.value=t.value}else if(t.attribute.indexOf("ticketcustomfield_date")>-1){i.value=n("date")(t.value,"yyyy/MM/dd").toString()}else if(t.attribute==="userGroup"){if(U.utils.isArray(t.value)){i.value=t.value.join(",")}else{i.value=t.value}}else if(t.valueOptions){t.valueOptions.forEach(function(e){if(e.value===t.value){i.value=e.option}})}else{i.value=t.value}}return i}function _(e){if(e.valueType==="cascade_options"||e.valueType==="multi_options"||e.valueType==="options"){return e.valueOptions.value}if(e.valueType==="date"){return n("date")(e.value,"yyyy/MM/dd").toString()}if(e.valueType==="engineer"){if(e.engineer&&e.serviceDesk){return e.serviceDesk.id+"_"+e.engineer.id}else if(e.engineer){return e.engineer.id}}if(e.valueType==="serviceDesk"){return e.value.id}if(e.valueType==="via"){return e.value}if(e.valueType==="userGroup"){return e.value}if(e.attribute==="transfer"||e.attribute==="tripartite"||e.attribute==="autoClose"){return true}if(typeof e.value==="object"){if(e.attribute.indexOf("ticketcustomfield")>=0){if(e.attribute.indexOf("ticketcustomfield_date")>=0){return n("date")(e.value,"yyyy/MM/dd").toString()}else{return e.value}}else{if(e.compare==="$in"||e.compare==="$not_in"){if(e.attribute==="serviceCatalog.id"){return"service_catalog_and_children_id_"+e.value.id}}else{return e.value.id}}}else{if(e.attribute.indexOf("ticketcustomfield_checkbox")>=0){return"true"}else{if(e.compare==="$in"||e.compare==="$not_in"){if(e.attribute==="status"){return l.run(e.value,e.compare)}}else{return e.value}}}}function b(){i.get("custom_field.json?scope=ticket&active=true").success(function(e,t){c.customField=e.json;angular.forEach(e.json,function(e,t,i){var r={};var n="";if(e.systemFieldKey==="priority"){r={option:"工单："+e.title,value:"priority",valueType:"select"}}else if(e.systemFieldKey==="ticket_type"){r={option:"工单："+e.title,value:"ticketType.id",valueType:"select"}}else if(e.systemFieldKey==="service_catalog"){r={option:"工单："+e.title,value:"serviceCatalog.id",valueType:"servicecatalog"}}else if(e.systemFieldKey==="subject"){r={option:"工单："+e.title,value:"subject",valueType:"text"}}else if(e.systemFieldKey==="tags"){r={option:"工单："+e.title,value:"tags",valueType:"text"}}else if(e.systemFieldKey==="ticket_description"){r={option:"工单："+e.title,value:"ticket_description",valueType:"text"}}else if(e.type==="date_to_date"){n={option:"工单：自定义字段-"+e.title,value:"ticketcustomfield_"+e.type+"_"+e.id,valueType:"date_to_date"}}else if(e.type==="date_time"){r={option:"工单：自定义字段-"+e.title,value:"ticketcustomfield_"+e.type+"_"+e.id,valueType:"date_time"}}else{r={option:"工单：自定义字段-"+e.title,value:"ticketcustomfield_"+e.type+"_"+e.id,valueType:"text"}}if(e.type==="text"||e.type==="email"||e.type==="regexp"||e.type==="textarea"||e.type==="number"||e.type==="decimal"){r.valueType="text"}else if(e.type==="date"){r.valueType=e.type;r.start=false}else if(e.type==="date_time"){r.valueType=e.type}else if(e.type==="options"){if(e.customFieldOptions){if(e.systemFieldKey){r.valueType="select";var a=angular.fromJson(e.customFieldOptions);for(var o=0,s=a.length;o<s;o++){a[o].option=a[o].name}r.valueOptions=a}else{r.valueType="options";if(e.customFieldOptions){r.valueOptions=e}}}}else if(e.type==="cascade_options"){if(e.systemFieldKey==="service_catalog"){r.valueType="serviceCatalog"}else{r.valueType="cascade_options";if(e.customFieldOptions){r.valueOptions=e}}}else if(e.type==="multi_options"){r.valueType="multi_options";if(e.customFieldOptions){r.valueOptions=e}}else if(e.type==="checkbox"){r.valueType="checkbox"}else{r.valueType="text"}r.edit_able=e.edit_able;if(n!==""){r.startTimeForm=false;r.endTimeForm=false}else{if(r.value!=="ticket_description"){c.andConditionOptions.push(angular.copy(r));c.orConditionOptions.push(angular.copy(r))}}})})}function S(e){e.valueOptions=[{option:"Email收件箱",value:"email"},{option:"网页表单(feedback)",value:"form"},{option:"在线交谈/远程协助",value:"chat"},{option:"微信客服",value:"weixin"},{option:"CTI客服",value:"new_phone"},{option:"帮助中心",value:"helpcenter"},{option:"客服界面",value:"console"},{option:"API工单渠道",value:"api"},{option:"钉钉渠道",value:"dingding"}]}function T(e){e.valueOptions=[{option:"未分派",value:"new"},{option:"已分派",value:"assigned"},{option:n("translate")("TICKET_STATUS_OPEN"),value:"open"},{option:n("translate")("TICKET_STATUS_SOLVED"),value:"solved"},{option:n("translate")("TICKET_STATUS_PENDING"),value:"pending"}]}function $(e){e.valueOptions=[{option:"无效信息",value:"无效信息"},{option:"重复信息",value:"重复信息"},{option:"恶意骚扰",value:"恶意骚扰"},{option:"其他原因",value:"其他原因"}]}function E(t){var e=JSON.parse(JSON.parse(localStorage.getItem("systemFieldPriority")).customFieldOptions);t.valueOptions=[];e.forEach(function(e){t.valueOptions.push({option:e.name,value:e.value})})}function F(s){i({url:"ticket_type.json",method:"GET",params:{_count:12332,_do_count:false,_fields:"id,name,description,isDefault"}}).success(function(e,t,i,r){if(e.ticketTypes){var n=[];for(var a=0,o=e.ticketTypes.length;a<o;a++){n.push({option:e.ticketTypes[a].name,value:""+e.ticketTypes[a].id})}s.valueOptions=n}})}function j(e){var t=[];for(var i=1;i<=5;i++){t.push({option:i+"分",value:i+""})}e.valueOptions=t}function D(e){var t=[];for(var i=0,r=e[1];i<r;i++){t.push(c.compareOptions[e[0]+i])}return t}function x(e){if(e.attribute==="priority"||e.attribute==="status"||e.attribute==="ticketType.id"||e.attribute==="requester.id"||e.attribute==="user"||e.attribute==="evaluate.score"){e.compareOptions=D([0,2]);if(e.attribute==="status"){e.compareOptions=e.compareOptions.concat(D([31,2]))}}else if(e.attribute==="serviceDesk"){e.compareOptions=D([41,2])}else if(e.attribute==="serviceCatalog.id"){e.compareOptions=D([37,4])}else if(e.attribute==="userGroup"||e.attribute==="userGroup"){e.compareOptions=D([33,2])}else if(e.attribute==="engineer"){e.compareOptions=D([14,2])}else if(e.attribute==="tags"){e.compareOptions=D([10,2])}else if(e.attribute==="subject"){e.compareOptions=D([12,2])}else if(e.attribute==="createdAt"||e.attribute==="ticketMetric.responseAt"||e.attribute==="ticketMetric.pausedAt"||e.attribute==="ticketMetric.solvedAt"||e.attribute==="ticketMetric.closedAt"){e.compareOptions=D([4,3])}else if(e.attribute==="ticket_comment"){e.compareOptions=D([12,2])}else if(e.attribute==="via"){e.compareOptions=D([18,2])}else if(e.attribute.indexOf("checkbox")>=0){e.compareOptions=D([22,2]);e.value="true"}else if(e.attribute.indexOf("textarea")>=0){e.compareOptions=D([24,2])}else if(e.attribute.indexOf("date")>=0||e.attribute.indexOf("number")>=0||e.attribute.indexOf("decimal")>=0){e.compareOptions=D([26,3])}else if(e.attribute.indexOf("ticketcustomfield")>=0){if(e.attribute.indexOf("multi_options")>=0){e.compareOptions=D([29,2])}else if(e.attribute.indexOf("text")>=0){e.compareOptions=D([20,2]);e.compareOptions=e.compareOptions.concat(D([24,2]))}else{e.compareOptions=D([20,2])}}else{e.compareOptions=D([7,3])}}function I(e){if(e.tally==="and"){for(var t=0,i=c.andConditionOptions.length;t<i;t++){if(c.andConditionOptions[t].value===e.attribute){e.valueType=c.andConditionOptions[t].valueType;e.valueOptions=angular.copy(c.andConditionOptions[t].valueOptions);e.edit_able=c.andConditionOptions[t].edit_able}}}else{for(var t=0,i=c.orConditionOptions.length;t<i;t++){if(c.orConditionOptions[t].value===e.attribute){e.valueType=c.orConditionOptions[t].valueType;e.valueOptions=angular.copy(c.orConditionOptions[t].valueOptions);e.edit_able=c.orConditionOptions[t].edit_able}}}if(e.valueType==="select"){if(e.attribute==="status"){T(e)}else if(e.attribute==="ticketType.id"){F(e)}else if(e.attribute==="priority"){E(e)}else if(e.attribute==="evaluate.score"){j(e)}else if(e.attribute==="deleteTicket"){$(e)}else if(e.attribute==="via"){S(e)}}}c.delCondition=function(e,t){if(e==="and"){c.andConditions.splice(t,1);if(c.andConditions.length===0){c.andConditions=[{attribute:"-1",tally:"and"}]}}else if(e==="or"){c.orConditions.splice(t,1);if(c.orConditions.length===0){c.orConditions=[{attribute:"-1",tally:"or"}]}}};c.addCondition=function(e){if(e==="and"){c.andConditions.push({attribute:"-1",tally:"and"})}else if(e==="or"){c.orConditions.push({attribute:"-1",tally:"or"})}};function A(t){if(t.value==="${current_engineer_id}"){t.engineer={name:"（当前客服）",id:"${current_engineer_id}"}}else{i({url:"service_desk/"+t.value.split("_")[0]+".json",method:"GET",params:{}}).success(function(e){t.serviceDesk=e.json});i({url:"engineer/"+t.value.split("_")[1]+".json",method:"GET",params:{}}).success(function(e){t.engineer=e.json})}}function O(e){e.value=e.value}function L(t){if(t.value==="${current_user_id}"){t.value={id:"${current_user_id}",name:"（当前客户）"}}else{i({url:"user/"+t.value+"/no_access_scope.json",method:"GET",params:{}}).success(function(e){t.value=e.json})}}function M(e){e.value=e.value}c.datepickers={startForm:false,startTo:false,updateFrom:false,updateTo:false};c.open=function(e,t,i){e.preventDefault();e.stopPropagation();t[i].start=!t[i].start};c.timeFrameOpen=function(e,t,i,r){e.preventDefault();e.stopPropagation();t[i][r]=!t[i][r]};c.conditionChange=function(e){for(var t in e){if(e.hasOwnProperty(t)){if(t==="attribute"||t==="tally"){}else{delete e[t]}}}x(e);I(e)};function N(){c.compareOptions=angular.copy(s);c.andConditionOptions=angular.copy(e);c.orConditionOptions=angular.copy(o);b();g(c.tree)}N()}})(org.ewei);(function(e){"use strict";angular.module("com.ewei.angular.ui").factory("allConditionOptionsWorkflow",[function(){var e=[{option:"请选择",value:"-1"},{option:"工单 : 状态",value:"status",valueType:"select"},{option:"工单 : 处理人",value:"engineer",valueType:"engineer"},{option:"工单 : 创建人",value:"user",valueType:"user"},{option:"工单 : 客服组",value:"serviceDesk",valueType:"serviceDesk"},{option:"工单 : 客户",value:"requester.id",valueType:"requester"},{option:"工单 : 客户组",value:"userGroup",valueType:"userGroup"},{option:"工单 : 渠道",value:"via",valueType:"via"},{option:"工单 : 服务评价",value:"evaluate.score",valueType:"select"},{option:"工单 : 回复",value:"ticket_comment",valueType:"text"}];return e}]).factory("anyConditionOptionsWorkflow",[function(){var e=[{option:"请选择",value:"-1"},{option:"工单 : 状态",value:"status",valueType:"select"},{option:"工单 : 处理人",value:"engineer",valueType:"engineer"},{option:"工单 : 创建人",value:"user",valueType:"user"},{option:"工单 : 客服组",value:"serviceDesk",valueType:"serviceDesk"},{option:"工单 : 客户",value:"requester.id",valueType:"requester"},{option:"工单 : 客户组",value:"userGroup",valueType:"userGroup"},{option:"工单 : 渠道",value:"via",valueType:"via"},{option:"工单 : 服务评价",value:"evaluate.score",valueType:"select"},{option:"工单 : 回复",value:"ticket_comment",valueType:"text"}];return e}]).factory("compareOptionsWorkflow",[function(){var e=[{option:"是",value:"$eq"},{option:"否",value:"$ne"},{option:"大于",value:"$gt"},{option:"小于",value:"$lt"},{option:"是",value:"$eq_hours"},{option:"小于",value:"$lt_hours"},{option:"大于",value:"$gt_hours"},{option:"是",value:"$eq_last_comment_hours"},{option:"小于",value:"$lt_last_comment_hours"},{option:"大于",value:"$gt_last_comment_hours"},{option:"至少包含其中一个",value:"$include"},{option:"不含以下",value:"$not_include"},{option:"包含以下字符串",value:"$include"},{option:"不含以下字符串",value:"$not_include"},{option:"是",value:"$eq"},{option:"否",value:"$ne"},{option:"包含",value:"$comment_contain"},{option:"不包含",value:"$comment_not_contain"},{option:"是",value:"$eq"},{option:"不是",value:"$ne"},{option:"是",value:"$eq_ticket_custom_field"},{option:"不是",value:"$ne_or_null_ticket_custom_field"},{option:"勾选",value:"$eq_ticket_custom_field"},{option:"不勾选",value:"$ne_or_null_ticket_custom_field"},{option:"包含以下字符串",value:"$like_ticket_custom_field"},{option:"不含以下字符串",value:"$not_like_ticket_custom_field"},{option:"是",value:"$eq_ticket_custom_field"},{option:"小于",value:"$lt_ticket_custom_field"},{option:"大于",value:"$gt_ticket_custom_field"},{option:"至少包含其中一个",value:"$ticket_custom_field_options_include"},{option:"不含以下",value:"$ticket_custom_field_options_not_include"},{option:"大于等于",value:"$in"},{option:"小于",value:"$not_in"},{option:"至少是下列一个",value:"$in"},{option:"不是以下",value:"$not_in"},{option:"至少包含其中一个",value:"$in"},{option:"不含以下",value:"$not_in"},{option:"是且包含其子目录",value:"$in"},{option:"是但不包含其子目录",value:"$eq"},{option:"不是且不是其子目录",value:"$not_in"},{option:"不是但可能是其子目录",value:"$ne_or_null"},{option:"是",value:"$in"},{option:"不是",value:"$not_in"}];return e}])})(org.ewei);angular.module("com.ewei.angular.ui").controller("ticketSubmitButtonController",["$scope","$http","$modal_","$rootScope","ConsoleConfig","alertService",function(a,e,t,i,o,s){try{a.systemFieldSubject=JSON.parse(localStorage["systemFieldSubject"]);a.systemFieldTicketdescription=JSON.parse(localStorage["systemFieldTicketdescription"]);a.typeFiled=angular.fromJson(localStorage.getItem("systemFieldTicketType"));a.priorityFiled=angular.fromJson(localStorage.getItem("systemFieldPriority"));a.catalogFiled=angular.fromJson(localStorage.getItem("systemFieldServiceCatalog"))}catch(e){}a.submit=function(e){if(a.disabled)return;var t="";if(a.ticket&&a.ticket.ticketComment&&a.ticket.ticketComment.content){t=angular.copy(a.ticket.ticketComment.content)}if(navigator.userAgent.indexOf("Firefox")!==-1){t=t.replace(/&nbsp;/g," ").replace(/<br>/g," ")}t=t.replace(/&amp;nbsp/g," ");t=t.replace(/^\s*|\s*$/g,"");if(a.systemFieldTicketdescription&&a.systemFieldTicketdescription.required&&!/\S/.test(t)&&(a.ticket.ticketComment&&(!a.ticket.ticketComment.attachments||a.ticket.ticketComment.attachments.length==0))){s.add("请填写"+a.systemFieldTicketdescription.title,"danger");return false}if(a.ticket.createType==="batch-customer"&&(!a.ticket.selectedCustomers||a.ticket.selectedCustomers.length===0||a.ticket.workflowTemplate==null&&a.ticket.engineer==null&&a.ticket.serviceDesk==null)){s.add("客户、处理人不能为空","danger");return false}if(a.ticket.createType==="normal"&&(a.ticket.requester==null||a.ticket.workflowTemplate==null&&a.ticket.engineer==null&&a.ticket.serviceDesk==null)){s.add("客户、处理人不能为空","danger");return false}if(a.typeFiled&&a.typeFiled.required&&!a.ticket.ticketType||a.ticket.ticketType&&!a.ticket.ticketType.id&&a.typeFiled.required){s.add(a.typeFiled.title+"不能为空","danger");return false}if(a.catalogFiled&&a.catalogFiled.required&&!a.ticket.serviceCatalog){s.add(a.catalogFiled.title+"不能为空","danger");return false}if(a.priorityFiled&&a.priorityFiled.required&&!a.ticket.priority){s.add(a.priorityFiled.title+"不能为空","danger");return false}if(a.systemFieldSubject&&a.systemFieldSubject.required&&!a.ticket.subject){s.add(a.systemFieldSubject.title+"不能为空","danger");return false}var i=a.ticket.ticketCustomFields;for(var r=0;r<i.length;r++){var n=i[r];if(a.customFormFields&&a.customFormFields.indexOf(n)>-1){if(n.customFormInfo&&!n.customFormInfo.deleted){if(n.customField.required&&(!n.value||n.value=="-")){s.add(n.customField.title+"不能为空","danger");return false}}}else{if(n.customField.sysCustomForm&&n.customField.required&&(!n.value||n.value=="-")){s.add(n.customField.title+"不能为空","danger");return false}}}if(!e){if(a.ticket.engineer==null&&a.ticket.workflowTemplate==null){e="new"}else if(a.ticket.engineer&&a.ticket.engineer.id==o.engineer.id||a.ticket.workflowTemplate&&a.ticket.workflowTemplate.templateNodes&&a.ticket.workflowTemplate.templateNodes[0]&&a.ticket.workflowTemplate.templateNodes[0].engineer&&a.ticket.workflowTemplate.templateNodes[0].engineer.id==o.engineer.id){e="open"}else{e="assigned"}}a.save({_status:e});a.status.isopen=false};a.status={isopen:false};a.currentEngineer=o.engineer}]).directive("ticketSubmitButton",function(){return{restrict:"EA",replace:true,scope:{ticket:"=",disabled:"=",uploading:"=",save:"&",customFormFields:"="},templateUrl:"/source/scripts/directives/ticket-submit-button/ticket-submit-button.html",controller:"ticketSubmitButtonController"}});angular.module("com.ewei.angular.ui").directive("eweiTicketSubjectAutoComplete",["$document","coreModelService",function(o,s){return{restrict:"ECA",replace:true,scope:{subject:"=",placeholder:"="},templateUrl:"/source/scripts/directives/ticket-subject-autocomplete/ticket-subject-autocomplete.html",link:function(i,r,e){i.isShowAutoComplete=false;i.selectedIndex=0;var t=function(e){var t=r.find(e.target).length>0;if(!t){i.isShowAutoComplete=false;i.$apply()}};var n=function(e){var t=r.find(e.target).length>0;if(t){if(e.keyCode==38){if(i.selectedIndex>0){--i.selectedIndex}}else if(e.keyCode==40){if(i.selectedIndex<i.list.length-1){++i.selectedIndex}}else if(e.keyCode==13){a(i.list[i.selectedIndex])}i.$apply()}};var a=function(e){i.isShowAutoComplete=false;i.subject=e.subject};o.on("click",t);o.on("keydown",n);r.on("$destroy",function(){o.off("click",t);o.off("keydown",n)});i.search=function(){i.selectedIndex=0;i.isShowAutoComplete=true;i.list=s.detail.cachedTickets.search({property:"subject",search:i.subject,hasRepeat:false,hasLike:true})};i.itemMouseUp=function(e){for(var t in i.list){if(i.list.hasOwnProperty(t)){if(e.id==i.list[t].id){i.selectedIndex=t}}}};i.itemClick=function(e){a(e)}}}}]);angular.module("com.ewei.angular.ui").controller("fileUploadButtonController",["$scope","attachmentService","$upload","$timeout","alertService","commonTools","$http","$rootScope","$modal_","$state",function(a,n,e,o,r,s,l,t,c,i){if(a.attachments==null){a.attachments=[]}a.showNoResource=true;a.catalogCollapse=function(e){e.collapse=!e.collapse};a.addResource=function(){f();t.helpcenterCommunityAccessSelectTab="resource";i.go("community")};var u=false;a.selectResource=function(i){if(u)return;u=true;f();o(function(){a.$parent.cacheFiles.forEach(function(e,t){if(e.name===i.name){a.$parent.cacheFiles.splice(t,1)}});a.attachments.forEach(function(e,t){if(e.fileName===i.name){a.attachments.splice(t,1)}});i.attachment.isLocalFile=false;a.$parent.cacheFiles.push({name:i.name,size:i.attachment.size,result:i.attachment,isAbort:false,progress:100});p(i.attachment);u=false},500)};var d=null;a.pickResource=function(){var e="source/views/ticket/ticket_pickup_resource.html";l.get("helpResourcesCatalog_all.json",{params:{_count:999,_do_count:true}}).success(function(e){a.catalogs=e.helpResourcesCatologs;if(a.catalogs.length>0){a.showNoResource=false}l.get("helpResources_all.json",{params:{_count:999,_do_count:true}}).success(function(t){a.total=t._total;a.helpResources=t.helpResources;angular.forEach(a.catalogs,function(i,e){i.resources=[];angular.forEach(t.helpResources,function(e,t){if(e.catalog.id==i.id){i.resources.push(e)}});if(i.resources.length>0){i.collapse=false}else{i.collapse=true}});i()})});var i=function(){d=c({scope:a,title:"选取社区帮助中心的下载资源",contentTemplate:e,html:true,show:true,placement:"center"})}};var f=function(){d.$promise.then(d.hide)};a.cacheFiles=[];if(angular.isArray(a.attachments)){angular.forEach(a.attachments,function(e){a.cacheFiles.push({name:e.fileName,size:e.size,result:angular.toJson({id:e.id,fileName:e.fileName,contentUrl:e.contentUrl}),isAbort:false,progress:100})})}a.requestScreenshot=function(){var e={type:"ticket",id:""};a.$emit("requestScreenshot",e)};a.requestVideo=function(){var e={type:"ticket",id:""};a.$emit("requestVideo",e)};t.$on("uploadedTicketAttachment",function(e,t){p(t.file);s.safeApply(a);a.cacheFiles.push({name:t.file.fileName,size:t.file.size,result:angular.toJson({id:t.file.id,fileName:t.file.fileName,contentUrl:t.file.contentUrl,isLocalFile:true}),isAbort:false,progress:100})});a.uploading=false;eweiUpload(function(e,t){plupload.each(t,function(e){e.uploading=true;e.progress=0;a.cacheFiles.push(e)});s.safeApply(a)},function(e,t){if(t.size>52428800){void 0;e.stop()}},function(e,t){var i=e.total.percent;a.$emit("uploading",true);t.progress=i;s.safeApply(a);void 0},function(e,n,t){n.progress=100;l({url:"save_attachment.json",method:"POST",params:{fileName:n.name,contentType:n.type,contentUrl:JSON.parse(t).key,size:n.size}}).success(function(e,t,i,r){if(e.json){o(function(){n.uploading=false;a.$emit("uploading",false);n.result=e.json;n.result.isLocalFile=true;p(e.json);s.safeApply(a);void 0})}else{void 0}})},function(e,t,i){if(t.code==-600){r.add("上传文件不能大于50M。","danger");e.stop()}},function(){});var p=function(e){var t=angular.fromJson(e);a.attachments.push({id:t.id,fileName:t.fileName,contentUrl:t.contentUrl,size:t.fileSize,contentType:t.contentType})};a.deleteAttachment=function(e,i){var r=angular.fromJson(e);if(confirm("删除文件 "+r.fileName+" ？")){if(r.isLocalFile){n.remove({id:r.contentUrl},function(e){for(var t=0;t<a.attachments.length;t++){if(a.attachments[t].id==r.id){a.attachments.splice(t,1);break}}a.cacheFiles.splice(i,1)})}else{for(var t=0;t<a.attachments.length;t++){if(a.attachments[t].id==r.id){a.attachments.splice(t,1);break}}a.cacheFiles.splice(i,1)}}}}]).directive("fileUploadButton",function(){return{restrict:"EA",scope:{attachments:"="},templateUrl:"/source/scripts/directives/file-upload-button/file-upload-button.html",controller:"fileUploadButtonController"}});angular.module("com.ewei.angular.ui").controller("resourcesUploadButtonController",["$scope","attachmentService","$upload","$timeout","alertService","$http","commonTools",function(a,t,e,o,r,i,s){if(a.attachments==null){a.attachments=[]}a.cacheFiles=[];a.uploading=false;a.fileSelectVisible=true;eweiUpload(function(e,t){if(t&&t.length>1){void 0;e.stop();return}plupload.each(t,function(e){e.uploading=true;e.progress=0;a.cacheFiles.push(e)});a.fileSelectVisible=false;s.safeApply(a)},function(e,t){void 0},function(e,t){var i=e.total.percent;a.$emit("uploading",{uploader:e,file:t,state:true});t.progress=i;s.safeApply(a);void 0},function(e,n,t){n.progress=100;i({url:"save_attachment.json",method:"POST",params:{fileName:n.name,contentType:n.type,contentUrl:JSON.parse(t).key,size:n.size}}).success(function(e,t,i,r){if(e.json){o(function(){a.$emit("uploadedAttachment",e.json);setTimeout(function(){a.$emit("uploading",false)},1e3);n.uploading=false;n.result=e.json;s.safeApply(a);void 0})}else{void 0}})},function(e,t,i){if(t.code==-600){r.add("上传文件不能大于50M。","danger");e.stop()}},function(){},true);a.deleteAttachment=function(e,i){var r=angular.fromJson(e);t.remove({id:r.contentUrl},function(e){for(var t=0;t<a.attachments.length;t++){if(a.attachments[t].id==r.id){a.attachments.splice(t,1);break}}a.cacheFiles.splice(i,1);a.fileSelectVisible=true;a.$emit("uploading",true)})}}]).directive("resourcesUploadButton",function(){return{restrict:"EA",transclude:true,replace:false,scope:{attachments:"="},templateUrl:"/source/scripts/directives/resources-upload-button/resources-upload-button.html",controller:"resourcesUploadButtonController"}});angular.module("com.ewei.angular.ui").controller("eweiTable2Controller",["$scope",function(e){e.templateState=false;e.switchTemplateState=function(){if(!e.templateState){e.templateState=true}}}]).directive("eweitable",function(){return{restrict:"E",transclude:true,replace:true,templateUrl:"source/scripts/directives/table/table.html"}}).directive("eweitable11",function(){return{restrict:"E",transclude:true,replace:true,templateUrl:"source/scripts/directives/table/table11.html"}}).directive("eweitable2",function(){return{restrict:"E",transclude:true,replace:true,link:function(e,t,i){e.hideTitle=i.hideTitle},templateUrl:"source/scripts/directives/table/table2.html",controller:"eweiTable2Controller"}}).directive("eweiengineerstable",function(){return{restrict:"E",transclude:true,replace:true,link:function(e,t,i){e.hideTitle=i.hideTitle},templateUrl:"source/scripts/directives/table/ewei_engineers_table.html",controller:"eweiTable2Controller"}}).directive("eweitickettable",function(){return{restrict:"E",transclude:true,replace:true,link:function(e,t,i){e.hideTitle=i.hideTitle},templateUrl:"source/scripts/directives/table/ewei_ticket_table.html",controller:"eweiTable2Controller"}}).directive("eweitable3",function(){return{restrict:"E",transclude:true,replace:true,templateUrl:"source/scripts/directives/table/table3.html"}}).directive("eweiTicketPlanTable",function(){return{restrict:"E",transclude:true,replace:true,templateUrl:"source/scripts/directives/table/ewei-ticket-plan-table.html"}}).directive("ngEnter",function(){return function(t,e,i){e.bind("keydown keypress",function(e){if(e.which===13){t.$apply(function(){t.$eval(i.ngEnter)});e.preventDefault()}})}});(function(h){"use strict";h.module("com.ewei.angular.ui").service("groupUserTicketChainService",e).controller("groupUserTicketChainController",t).directive("groupUserTicketChain",i);e.$inject=["$state","userService","ticketDetailService","chatDetailService","userGroupService"];function e(r,n,a,o,s){var l={};var c={};var u={};var d={};this.run=function(e,t,i){switch(e){case"ticket":a.run(t,{},true,function(e){if(0!=e.status){r.go("unauthorized")}else{if(e&&e.result&&e.ticketCustomFields){delete e.result.ticketCustomFields}l=e.result;if(typeof i==="function"){i({result:l})}}});break;case"webchat":o.run(t,{},true,function(e){if(e.status!=0){r.go("unauthorized")}else{c=e.result;if(typeof i==="function"){i(e)}}});break;case"user":n.get({id:t}).$promise.then(function(e){if(false==e.success){r.go("unauthorized")}else{u=e.json;if(typeof i==="function"){i(e)}}});break;case"userGroup":s.get({id:t}).$promise.then(function(e){if(false==e.success){r.go("unauthorized")}else{d=e.json;if(typeof i==="function"){i(e)}}});break}};this.setData=function(e,t,i,r){l=e;c=t;u=i;d=r};this.setUserGroup=function(e){u.userGroup=d=e};this.setUser=function(e){u=e;d=u.userGroup};this.getData=function(e){if(e=="ticket"){return l}else if(e=="webchat"){return c}else if(e=="user"){return u}else if(e=="userGroup"){return d}}}t.$inject=["$scope","$state","$http","$modal_","$filter","alertService","userGroupService","permissions","ConsoleConfig","accessableTicketService","groupUserTicketChainService"];function t(n,a,i,t,o,s,r,l,e,c,u){var d=n.$watch("user",function(e,t,i){if(e){n.user.showName=n.user.name||n.user.nickname||n.user.id;n.user.shortName=n.user.showName.length>5?n.user.showName.substring(0,5)+"...":n.user.showName;u.setUser(e)}});var f=n.$watch("ticket.requester",function(){if(n.ticket!=null&&n.ticket.requester!=null&&n.ticket.id==null){if(n.group==null){n.disableStyle4Group=false}else{n.disableStyle4Group=true}n.disableStyle4User=true}else{n.disableStyle4User=false;n.disableStyle4Group=false}});var p=function(e,t){i({url:"update_user_group.json",method:"POST",data:{id:n.user.id,userGroupId:e,shared:t}}).success(function(e,t,i,r){if(e.success){u.setUserGroup(n.newUserGroup);if(n.webchat!=null){if(n.webchat.id!=null){a.go("webchat_user_group_detail",{id:n.webchat.id})}}else if(n.ticket!=null){if(n.ticket.id!=null){a.go("user_group_requester_tickets_detail",{id:n.ticket.id})}}else{a.go("user_group_customers_detail",{id:n.user.id})}}else{s.add("保存失败","danger")}})};var m=true;n.disableStyle4Group=false;n.disableStyle4User=false;u.setData(n.ticket,n.webchat,n.user,n.group);n.group_click=function(){if(n.group==null){if(l.hasPermission("customer_group_create")){n.hideModal=function(){e.$promise.then(e.hide)};i.get("get_external_url_authorize.json").success(function(e){if(e.success&&e.json){n.externalUrlAuthorize=e.json}});n.flag_showMoreOptions=false;n.showMoreOptions=function(){n.flag_showMoreOptions=true};n.newUserGroup={shared:false,userGroupCustomFields:[]};n.groupField={};n.$save=function(){var e=n.groupField.userGroupCustomFields;if(h.isDefined(e)){for(var t=0;t<e.length;t++){if(e[t].customField.regexpForValidation&&e[t].value){var i=new RegExp(e[t].customField.regexpForValidation);if(!i.test(e[t].value)){s.add("请输入正确的"+e[t].customField.title,"danger");e[t].value="";return}}else if(e[t].customField&&e[t].customField.required){if(!e[t].value||e[t].value=="-"){s.add(e[t].customField.title+"不能为空","danger");return}}}}h.forEach(n.groupField.userGroupCustomFields,function(e){var t={value:e.value,customField:{id:e.customField.id}};n.newUserGroup.userGroupCustomFields.push(t)});r.add(n.newUserGroup,function(e){if(e.success){n.hideModal();n.newUserGroup.id=e.id;p(e.id,n.newUserGroup.shared)}else{if(e.message!=null){s.add(o("translate")(e.message),"danger")}else{s.add("保存失败","danger")}}})};var e=t({scope:n,title:"新建客户分组",contentTemplate:"source/views/customer/user_group_add.html",html:true,show:true,placement:"top"})}else{s.add("您没有创建客户组的权限","danger")}}else{i.get("accessable_user_group.json?userGroupId="+n.group.id).success(function(e,t,i,r){if(e.success){if(n.user!=null){if(n.webchat!=null){if(n.webchat.id!=null){a.go("webchat_user_group_detail.customers",{id:n.webchat.id})}}else if(n.ticket!=null){if(n.ticket.id!=null){if(n.group&&n.ticket.requester){n.ticket.requester.userGroup=n.group}a.go("user_group_requester_tickets_detail.customers",{id:n.ticket.id,ticket:n.ticket})}}else{a.go("user_group_customers_detail.customers",{id:n.user.id})}}}else{if(e.message!=null){s.add(o("translate")(e.message),"danger")}else{s.add("访问失败","danger")}}})}};n.user_click=function(){if(n.user!=null){i.get("accessable_user.json?userId="+n.user.id).success(function(e,t,i,r){if(e.success){if(n.webchat!=null){if(n.webchat.id!=null){a.go("webchat_requester_detail.tickets",{id:n.webchat.id,status:"all_ticket"})}}else if(n.ticket!=null){if(n.ticket.id!=null){a.go("requester_tickets_detail.tickets",{id:n.ticket.id,status:"all_ticket",ticket:n.ticket})}}else{a.go("customers_detail.tickets",{id:n.user.id,status:"all_ticket"})}}else{if(e.message!=null){s.add(o("translate")(e.message),"danger")}else{s.add("访问失败","danger")}}})}};n.ticket_click=function(){if(n.webchat!=null){if(n.ticket!=null&&n.ticket.id!=null){n.go_ticket(n.ticket.id)}else{if(n.webchat.engineer.id!=e.engineer.id){s.add("您无此权限，不能访问","danger");return}}}else if(n.ticket!=null&&n.ticket.id!=null){n.go_ticket(n.ticket.id)}};n.webchat_click=function(){if(n.webchat!=null&&n.webchat.id!=null){a.go("webchats_new.detail",{id:n.webchat.id},{reload:"webchats_new.detail"})}};n.go_ticket=function(t){if(t==undefined){t=n.ticket.id}c.run(t,{},false,function(e){if(e.status==0){if(n.webchat!=null){a.go("webchat_ticket_detail",{id:n.webchat.id,ticketId:t})}else{a.go("tickets_detail",{id:t})}}else{if(e.result&&e.result.error){s.add(o("translate")(e.result.error_description),"danger")}else{s.add("访问失败","danger")}}})};n.goOrChainTicket=function(){if(n.ticket==null||n.ticket.id==null){n.chainToChooseTicket()}else{n.ticket_click(n.ticket.no)}};n.chainToChooseTicket=function(){var e={id:0,no:0,option:"创建新的工单"};if(e.id==undefined){s.add("请选择","danger")}else{if(e.id>0){n.chainChatToTicket(e.no)}else{n.chainChatToTicket()}}};n.chainChatToTicket=function(e){if(m){m=false;var t={};if(e){t={ticketNo:e}}else{if(!l.hasPermission("ticket_create")){s.add("您没有创建工单的权限","danger");return}}i({url:"chat_to_ticket/"+n.webchat.id+".json",method:"GET",params:t}).success(function(e,t,i,r){if(e.success){n.go_ticket(e.id)}else{m=true;if(e.message!=null){s.add(o("translate")(e.message),"danger")}else{s.add("失败","danger")}}})}};n.$watch("webchat",function(e){if(e){u.setData(n.ticket,n.webchat,n.user,n.group)}});n.$on("$destroy",function(){f();d()})}i.$inject=[];function i(){return{restrict:"EA",replace:true,templateUrl:"/source/scripts/directives/group-user-ticket-chain/group-user-ticket-chain.html",controller:"groupUserTicketChainController",scope:{active:"@",user:"=",ticket:"=",webchat:"=",group:"="}}}})(angular);angular.module("com.ewei.angular.ui").controller("engineerSelectController",["$scope","serviceDeskService","engineerService","$http",function(s,e,t,i){s.showSearchList=function(e){e.stopPropagation()};s.searchedData={serviceDesks:[]};s.showCurrentEngineer=angular.copy(s.hascurrentengineer);var r=function(){s.searchedData.serviceDesks=[];s.searchName=""};s.searchEngineerOrWorkflow=function(e){s.searchedData.serviceDesks=[];if(s.searchName){s.currentEngineer={};s.showCurrentEngineer=false}else{if(s.hascurrentengineer){s.currentEngineer={name:"（当前客服）",id:"${current_engineer_id}"};s.showCurrentEngineer=true}}var i=e.target.value.trim();if(i.length<1){s.showServiceDeskList=true;s.showEngineerList=false;return false}s.showServiceDeskList=false;s.showEngineerList=false;s.serviceDesks.forEach(function(e){var t={id:e.id,name:e.name,engineers:[]};e.engineers.forEach(function(e){if(e.username&&e.username.search(new RegExp(i,"i"))>-1||e.email&&e.email.search(new RegExp(i,"i"))>-1){t.engineers.push(e)}});if(e.name.search(new RegExp(i,"i"))>-1||t.engineers.length>0){s.searchedData.serviceDesks.push(t)}})};s.selectSearchedServiceDesk=function(e,t,i){if(!i&&!s.selectableservicedesk){t.stopPropagation();return false}if(i){t.stopPropagation();return false}var r={engineer:angular.copy(s.selectedengineer),serviceDesk:angular.copy(s.selectedservicedesk)};s.selectedservicedesk=e;s.selectedengineer=null;s.catSelected=false;s.selectedservicedesk.oldTicket=r;s.$emit("selectedServiceDesk",s.selectedservicedesk)};s.loadServiceDesks=function(){if(s.hascurrentengineer){s.currentEngineer={name:"（当前客服）",id:"${current_engineer_id}"}}i({url:"/api/v1/service_desks/include_engineers.json"}).success(function(e,t,i,r){s.serviceDesks=[];if(e.status==0&&e.result){var n={};e.result.serviceDesks.forEach(function(e){n[e.name]=e});var a=Object.keys(n).sort(function(e,t){return e.localeCompare(t,"zh-CN-u-co-pinyin")});var o=[];a.forEach(function(e){o.push(n[e])});e.result.serviceDesks=o;angular.forEach(e.result.serviceDesks,function(e){if(e&&s.selectedservicedesk!=null&&s.selectedservicedesk.id==e.id){s.engineers=e.engineers;s.catSelected=true;s.showEngineerList=false;s.showServiceDeskList=true}e&&s.serviceDesks.push(e)});if(s.selectedservicedesk==null){s.showServiceDeskList=true;s.showEngineerList=false}}})};s.back=function(e){s.showServiceDeskList=true;s.showEngineerList=false;s.isopen=true;if(s.serviceDesks==null){s.loadServiceDesks()}e.stopPropagation()};s.clear=function(){s.selectedservicedesk="";s.selectedengineer="";s.catSelected=false;s.showServiceDeskList=true;s.showEngineerList=false;if(s.serviceDesks==null){s.loadServiceDesks()}};s.selectServiceDesk=function(e,t){var i=s.serviceDesks[e];if(angular.isDefined(i.engineers)&&i.engineers.length>0){s.selectedservicedeskIndex=e;s.tempServiceDesk=i;s.engineers=i.engineers;s.showServiceDeskList=false;s.showEngineerList=true;s.isopen=true;t.stopPropagation()}else{s.selectedservicedesk=i;s.selectedengineer=null;s.catSelected=true}};s.selectServiceDeskInEngineerList=function(){s.selectedservicedesk=s.tempServiceDesk;s.selectedengineer=null;s.catSelected=true};s.selectEngineer=function(e,t){var i={engineer:angular.copy(s.selectedengineer),serviceDesk:angular.copy(s.selectedservicedesk)};if(angular.isObject(t)){s.selectedservicedesk=t}else{s.selectedservicedesk=s.tempServiceDesk}s.selectedengineer=e;s.showServiceDeskList=false;s.showEngineerList=true;s.catSelected=true;s.$emit("selectedEngineer",{engineer:s.selectedengineer,serviceDesk:s.selectedservicedesk,oldTicket:i})};s.loadServiceDesks();s.click=function(){s.showServiceDeskList=true;s.showEngineerList=false;r()};s.$watch("selectedengineer",function(){if(s.selectedengineer==null&&s.selectedservicedesk==null){s.catSelected=false}})}]).directive("engineerSelect",function(){return{restrict:"E",replace:true,scope:{selectedengineer:"=",selectedservicedesk:"=",selectableservicedesk:"@",workflow:"=",singleLine:"=",hascurrentengineer:"@"},controller:"engineerSelectController",templateUrl:"/source/scripts/directives/engineer-select/engineer-select.html"}}).controller("noGroupEngineerSelectSearchController",["$rootScope","$scope","$http","alertService","$filter",function(e,n,r,t,i){n.$watch("selectedsearch",function(){if(n.selectedsearch!=null&&typeof n.selectedsearch=="object"){if(n.selectedsearch.user==null){r({url:"engineer/"+n.selectedsearch.id+".json",method:"GET",params:{}}).success(function(e,t,i,r){if(e.success){n.username=e.json.user.name}})}else{n.username=n.selectedsearch.user.name}}else{n.username=""}});n.loadEngineers=function(e){var t={$or:[{$like:{"user.name":"$"+e+"$"}},{$like:{"user.email":"$"+e+"$"}}]};var i="engineer.json?_count=20&_do_count=false&_fields=id,user.id,user.name,user.email&_asc=user.name&_filter="+JSON.stringify(t);return r.get(i,{}).then(function(e){n.engineers=e.data.engineers;return n.engineers})};n.onFocus=function(){n.username=""};n.onBlur=function(){n.inputNewUser=n.username;if(n.selectedsearch!=null){n.username=n.selectedsearch.user.name}else{n.username=""}};n.onSelect=function(e,t,i,r){n.selectedsearch=e;n.username=n.selectedsearch.user.name;n.$emit("selectedsearch",n.selectedsearch)}}]).directive("noGroupEngineerSelectSearch",[function(){return{restrict:"EA",replace:true,templateUrl:"/source/scripts/directives/engineer-select/no-group-engneer-select-search.html",controller:"noGroupEngineerSelectSearchController",scope:{selectedsearch:"="}}}]);angular.module("com.ewei.angular.ui").controller("ticketPrioritySelectController",["$scope","$http",function(e,t){e.priorities=[];if(localStorage&&localStorage["systemFieldPriority"]){e.priorities=angular.fromJson(angular.fromJson(localStorage["systemFieldPriority"]).customFieldOptions)}e.change=function(){e.$emit("selectedPriority",e.selectedpriority)}}]).directive("ticketPrioritySelect",[function(){return{restrict:"EA",replace:true,templateUrl:"/source/scripts/directives/ticket-priority-select/ticket-priority-select.html",controller:"ticketPrioritySelectController",scope:{selectedpriority:"=",disabled:"="}}}]).directive("ticketPriorityShow",[function(){return{restrict:"E",scope:{priority:"@"},template:"",link:function(n,a,e){function i(){if(n.priority==null||n.priority==""){a.html("");return}if(localStorage){var e=angular.fromJson(localStorage["systemFieldPriority"]);var t=angular.fromJson(e.customFieldOptions);for(var i=0,r=t.length;i<r;i++){if(t[i].value==n.priority){a.html(t[i].name);break}}}}i();n.$watch("priority",function(e,t){if(e!=t){i()}})}}}]);angular.module("com.ewei.angular.ui").controller("ticketTypeSelectController",["$scope","ticketTypeService",function(r,e){e.run("",{_count:999,_do_count:false,_fields:"id,name",_asc:"id"},false,function(e){if(e.status==0&&e.result){r.ticketTypes=e.result.ticketTypes;if(r.selectedtickettype!=null){angular.forEach(r.ticketTypes,function(e){if(e.id==r.selectedtickettype.id){r.selectedtickettype=e;return}})}else if(r.ticketprojecttype){angular.forEach(r.ticketTypes,function(e){if(e.name==r.ticketprojecttype){r.selectedtickettype=e;return}})}}});r.$watch("selectedtickettype",function(e,t,i){if(e){angular.forEach(r.ticketTypes,function(e){if(e.id==r.selectedtickettype.id){r.tickettype=e;return}})}},false);r.change=function(e){r.selectedtickettype=e;r.$emit("selectedTicketType",r.selectedtickettype)}}]).directive("ticketTypeSelect",[function(){return{restrict:"EA",replace:true,templateUrl:"/source/scripts/directives/ticket-type-select/ticket-type-select.html",controller:"ticketTypeSelectController",scope:{selectedtickettype:"=",disabled:"=",ticketprojecttype:"="}}}]);angular.module("com.ewei.angular.ui").controller("eweiTagsInputController",["$scope","$http","alertService","apiRestfulService","ConsoleConfig",function(s,l,c,e,r){var n;s.loadTags=function(e){var t="?provider_id="+r.provider.id+"&_token="+getCookie("user_token");if(!e){var i;if(s.who=="ticket"){i="api/v1/tags/hot/ticket_r_tag.json"}else if(s.who=="user"){i="api/v1/tags/hot/user_r_tag.json"}else if(s.who=="user_group"){i="api/v1/tags/hot/user_group_r_tag.json"}if(!n){return l.get(i+t).then(function(e){n=e;return angular.isDefined(e)?e:[]})}else{return n}}else{return l.get("api/v1/tags/by_key.json?_count=10&key="+e).then(function(e){var t=[];if(e.data&&e.data.status==0&&e.data.result&&e.data.result.tags){t=e.data.result.tags}return t})}};var a=function(a,o){if(s.whoid!=null&&s.whoid!=""){var e;var t;if(s.who=="user"){e="save_user_tag_relation.json";t={tagId:a,userId:s.whoid}}else if(s.who=="ticket"){e="/api/v1/ticket/tag_relation/save.json";t={tagId:a,tagName:o,ticketId:s.whoid}}else if(s.who=="user_group"){e="save_user_group_tag_relation.json";t={tagId:a,userGroupId:s.whoid}}else if(s.who=="chat"){e="add_chat_tag_relation.json";t={tagId:a,chatId:s.whoid}}l({url:e,method:"POST",data:t}).success(function(e,t,i,r){var n=false;if(s.who=="ticket"){n=e.status==0}else{n=e.success}if(!n){c.add("保存tag："+o+"失败","danger");s.tags.forEach(function(e,t){if(e.id===a){s.tags.splice(t,1);return false}})}}).error(function(){c.add("保存tag："+o+"失败","danger");s.tags.forEach(function(e,t){if(e.id===a){s.tags.splice(t,1);return false}})})}};var t=function(e,t){var i;var r;if(s.who=="user"){i="delete_user_tag_relation.json";r={tagId:e,userId:s.whoid}}else if(s.who=="ticket"){if(s.whoid==null||s.whoid==""){return}i="/api/v1/ticket/tag_relation/delete";r={tagId:e,tagName:t,ticketId:s.whoid}}else if(s.who=="user_group"){i="delete_user_group_tag_relation.json";r={tagId:e,userGroupId:s.whoid}}else if(s.who=="chat"){i="delete_chat_tag_relation.json";r={tagId:e,chatId:s.whoid}}l({url:i,method:"POST",data:r}).success(function(e,t,i,r){if(e.success){}else{}})};s.tagAdded=function(n){if(n.id==null){if(!s.notAllowAdd){l({url:"/api/v1/tags.json",method:"POST",data:n}).success(function(e,t,i,r){if(e.status==0&&e.result){n.id=e.result.id;a(n.id,n.name)}else{}}).error(function(e,t,i,r){})}else{this.tags.splice(this.tags.indexOf(n),1)}}else{a(n.id,n.name)}};s.tagRemoved=function(e){if(e.id!=null){t(e.id,e.name)}}}]).directive("eweiTagsInput",[function(){return{restrict:"EA",templateUrl:"/source/scripts/directives/ewei-tags-input/ewei-tags-input.html",controller:"eweiTagsInputController",scope:{tags:"=",who:"@",whoid:"@",hideHelp:"@",editAble:"=",notes:"@",notAllowAdd:"="}}}]);angular.module("com.ewei.angular.ui").controller("eweiMultipleController",["$scope","$http","alertService","apiRestfulService","ConsoleConfig","multipleGroupService",function(r,i,e,t,n,a){if(typeof r.placeholderval=="undefined"){r.placeholderval="输入关键字搜索标签，按空格创建新标签"}r.focus=function(){r.query="";r.itemlist=[];r.loadTags()};r.loadTags=function(){r.clicked=true;var e;var t=40;if(angular.isUndefined(r.query)){return}if(r.who=="user_groups"){var e="user_group_list.json?_count="+t+'&_do_count=1&_page=1&_desc=createdAt&_fields=id,name,shared&_asc=name&_filter={"$like":{"name":"$'+r.query+'$"}}'}else if(r.who=="service_desks"){var e="/api/v1/service_desks.json?provider_id="+n.provider.id+"&_token="+getCookie("user_token")+"&_count="+t+"&_do_count=false&_fields=id,name&_page=1&desc=createdAt&key="+r.query}return i.get(e).then(function(e){var t;if(r.who=="user_groups"){t=e.data.userGroups}else if(r.who=="service_desks"){t=e.data.result.serviceDesks}if(r.who=="service_desks"){for(var i=0;i<t.length;i++){if(t[i].name=="DEFAULT_SERVICE_DESK_NAME"){t[i].name="默认服务台"}}}r.itemlist=t?t:[]})};r.$watch("query",function(e){if(e){r.loadTags()}});r.tagAdded=function(e){r.cancelFn();r.tagObj=[];if(r.who=="user_groups"){a.setUserGroup(e);r.tagObj=a.getUserGroup()}else if(r.who=="service_desks"){a.setServiceGroup(e);r.tagObj=a.getServiceGroup()}r.query=""};r.tagRemoved=function(e){void 0;r.tagObj=[];if(r.who=="user_groups"){a.deleteUserGroup(e);r.tagObj=a.getUserGroup()}else if(r.who=="service_desks"){a.deleteServiceGroup(e);r.tagObj=a.getServiceGroup()}};r.cancelFn=function(){r.clicked=false};function o(){r.tagObj=[];if(r.who=="user_groups"){r.tagObj=a.getUserGroup()}else if(r.who=="service_desks"){r.tagObj=a.getServiceGroup()}}o()}]).filter("t",[function(){return function(e){if(e=="DEFAULT_SERVICE_DESK_NAME"){return"默认服务台"}else{return e}}}]).directive("eweiMultiple",["$timeout","$window",function(n,a){return{restrict:"EA",replace:true,templateUrl:"/source/scripts/directives/ewei-multiple-component/ewei-multiple-component.html",controller:"eweiMultipleController",scope:{tags:"=",placeholderval:"@",who:"@",whoid:"@"},link:function(e,t,i){function r(){if(e.clicked){e.clicked=false}}t.on("click",function(e){e.stopPropagation()});n(function(){angular.element(a).on("click",r)},0);e.$on("$destory",function(){angular.element(a).off("click",r)})}}}]);angular.module("com.ewei.angular.ui").controller("ticketCcInputController",["$rootScope","$scope","$http","userService","ConsoleConfig","$document","alertService","apiEngineersByServiceDeskService","coreNotifyService","coreModelService",function(e,s,l,t,c,r,a,i,n,o){function u(){s.dropdown={isShowDropdown:false,isShowBack:false,isShowGroupIcon:false,isShowNextIcon:true,currentDropdown:1,type:"",foreignEmail:"",initDropdownList:[{name:"客户",type:"customer",show:true},{name:"客服",type:"engineer",show:true},{name:"关联客户",type:"relationCustomer",show:true},{name:"外援",type:"foreign",show:true}]};s.dropdownList=s.dropdown.initDropdownList}s.inputText="";var d=this.__proto__.constructor.name+"_"+Date.now();if(s.isticketdetail){u()}s.loadUsers=function(e){var r=[];var t;if(s.inputText===""){return[]}var i=0;if(s.isticketdetail){s.dropdown.isShowDropdown=false}if(s.usergroup!=null){i=s.usergroup.id}if(s.isticketdetail){t=s.user&&s.user.id?"/api/v1/engineer_customer_simple_list.json?queryUserType=&key="+e+"&userId="+s.user.id:"/api/v1/engineer_customer_simple_list.json?queryUserType=engineer&byAccessScope=true&key="+e}else{t="/api/v1/engineer_customer_simple_list.json?queryUserType=&key="+e}if(!s.excludeusergroup){t+="&userGroupId="+i}return l.get(t,{}).then(function(e){var t=e.data;var i=angular.isDefined(t.result.users)?t.result.users:[];angular.forEach(i,function(e){var t=e.email?e.email:"";r.push({id:e.id,name:e.name+(e.email?"("+t+")":""),groupId:e.groupId,type:e.type})});return r})};var f=function(e){if(s.ccs){for(var t=0;t<s.ccs.length;t++){if(s.ccs[t].id==e){return true}}}return false};var p=s.$watch("ccs",function(e,t,i){if(e&&!e.hasFormat){var r=[];r.hasFormat=true;var n={};angular.forEach(s.ccs,function(e){if(angular.isObject(e.user)){var t=angular.isDefined(e.user.email)&&e.user.email!=null?"("+e.user.email+")":"";if(!n[e.user.id]){n[e.user.id]=1;r.push({id:e.user.id,name:e.user.name+t})}}else if(e.email){if(!e.id){e.id=eweiCommon.uuid(32)}if(e.name){r.push({id:e.id,name:e.name.indexOf(e.email)===-1?e.name+(e.email?"("+e.email+")":""):e.name,email:e.email})}else{r.push({id:e.id,name:e.email,email:e.email})}}else if(e.name){if(!e.id){e.id=eweiCommon.uuid(32)}r.push(e)}else if(e.ids){l({url:"/api/v1/customers/by_ids.json?ids="+e.ids,method:"GET"}).success(function(e){if(e.status==0&&e.result){for(var t=0;t<e.result.users.length;t++){r.push(e.result.users[t])}}})}else if(e.userGroup){r.push({id:e.userGroup.id,name:e.userGroup.name,type:"userGroup"})}else if(e.serviceDesk){if(e.serviceDesk.name==="DEFAULT_SERVICE_DESK_NAME"){e.serviceDesk.name="默认服务台"}r.push({id:e.serviceDesk.id,name:e.serviceDesk.name,type:"serviceDesk"})}});s.ccs=r;s.isContainMe=f(c.user.id)}});s.$on("$destroy",function(){p()});var m=s.$watch("iscopytome",function(e,t,i){if(s.iscopytome!=undefined){if(s.iscopytome){s.ccMe(false,true)}}});s.$on("$destroy",function(){m()});s.ccMe=function(e,n){if(e){s.removeMe();s.iscopytome=false}else{t.get({id:c.user.id},function(e){var t=e.json;if(!f(t.id)){var i=angular.isDefined(t.email)?"("+t.email+")":"";var r={id:t.id,name:t.name+i};if(s.validateTag(r)){if(!n){h(r,r.name,"ccMe")}}s.isContainMe=true}})}};s.removeMe=function(){v(c.user,c.user.name);for(var e=0;e<s.ccs.length;e++){if(s.ccs[e].id===c.user.id){s.ccs.splice(e,1);break}}s.isContainMe=false};var h=function(e,t,i){var r;var n;if(s.isticketdetail){if(s.validateTag(e)){var a="";var o={};if(e.email){a="("+e.email+")"}if(e.id){o={id:e.id,name:t+a,type:e.type}}else{o={name:t+a}}if(o.id===c.user.id){s.isContainMe=true}if(o.name==="DEFAULT_SERVICE_DESK_NAME"){o.name="默认服务台"}s.ccs.push(o)}if(i==="ccMe"){s.blur()}else{if(s.isticketdetail){u();s.hideMenu();s.dropdown.isShowDropdown=true}}if(s.whoid==null||s.whoid==""){return}r="/api/v1/ticket_cc_relation/save.json?provider_id="+c.provider.id+"&_token="+getCookie("user_token");if(Object.prototype.toString.call(e.id)==="[object Number]"){if(e.type==="userGroup"){n={userGroupId:e.id,userGroupName:t,ticketId:s.whoid}}else if(e.type==="serviceDesk"){if(t==="DEFAULT_SERVICE_DESK_NAME"){t="默认服务台"}n={serviceDeskId:e.id,serviceDeskName:t,ticketId:s.whoid}}else{n={userId:e.id,userName:t,ticketId:s.whoid}}}else{n={email:t,userName:t,ticketId:s.whoid}}l({url:r,method:"POST",data:n}).success(function(e){if(e.result.success){}})}};var g=true;var v=function(e,t,i){var r;var n;if(s.who=="ticket"){if(s.whoid==null||s.whoid==""){return}r="/api/v1/ticket_cc_relation/delete.json?provider_id="+c.provider.id+"&_token="+getCookie("user_token");if(i){n={email:i,userName:t,ticketId:s.whoid}}else{if(e.type==="userGroup"){n={userGroupId:e.id,userGroupName:t,ticketId:s.whoid}}else if(e.type==="serviceDesk"){if(t==="DEFAULT_SERVICE_DESK_NAME"){t="默认服务台"}n={serviceDeskId:e.id,serviceDeskName:t,ticketId:s.whoid}}else{n={userId:e.id,userName:t,ticketId:s.whoid}}}}if(g){g=false;l({url:r,method:"POST",data:n}).success(function(e,t,i,r){if(e.success){if(userId==c.user.id){s.iscopytome=false}}else{}g=true})}};s.validateTag=function(t){var e=s.ccs&&_.filter(s.ccs,function(e){if(t.id){return t.id===e.id}else{return e.name===t.name||t.name.indexOf(e.name)!==-1||e.name.indexOf(t.name)!==-1}}).length>0;if(!t.id){t.id=eweiCommon.uuid(32)}if(e){return false}return Object.prototype.toString.call(t.id)==="[object Number]"||verifyEmailAddress(t.name)};s.tagAdded=function(e){var t=e.name?e.name:e.nickname;if(t){h(e,t,"normalAdd")}s.isContainMe=f(c.user.id);var i=$(".tag-list+input",$("#tagsInput"));if(i.length>0){i[0].focus()}};s.tagRemoved=function(e){if(e.id){v(e,e.name,e.email)}s.isContainMe=f(c.user.id)};s.focus=function(){if(s.ispolymerizesearch){s.isHidden=false}if(s.isticketdetail){s.dropdown.isShowDropdown=true;s.hideMenu()}};s.blur=function(){if(s.ispolymerizesearch){s.isHidden=true}var e=r.prop("activeElement");var t=r.find("#tagsInput");var i=t[0].contains(e);if(!i){u()}};s.keyup=function(e){var t=r.prop("activeElement");var i=r.find("#tagsInput2");if(t===i[0]){return}if(s.inputText===""&&s.isticketdetail){u();s.hideMenu();s.dropdown.isShowDropdown=true}};s.hideMenu=function(){if(!s.user||!s.usergroup){angular.forEach(s.dropdownList,function(e){if(e.type==="relationCustomer"||e.type==="customer"){e.show=false}})}};function k(e,t){var i=e;if(t==="customer"&&s.usergroup){s.usergroup.type="userGroup";i.unshift(s.usergroup)}s.dropdownList=i;s.dropdown.currentDropdown=2;s.dropdown.type="customer";s.changeCurrentDropdown("",t)}s.loadEngineer=function(){l({method:"GET",url:"/api/v1/service_desks.json?provider_id="+c.provider.id+"&_token="+getCookie("user_token")+"&_count=20&_do_count=false&_fields=id,name&_page="+s.engineerPageNum}).success(function(e){if(e.result.serviceDesks.length===0){return}if(s.engineerPageNum===1){s.dropdownList=e.result.serviceDesks}else{s.dropdownList=s.dropdownList.concat(e.result.serviceDesks)}s.groupList=s.dropdownList;s.dropdown.currentDropdown=2;s.dropdown.type="engineer";s.changeCurrentDropdown()})};s.selectItem=function(t,e){e.stopPropagation();if(s.dropdown.currentDropdown===1){if(t.type==="customer"){if(s.usergroup){var i="";l({method:"GET",url:"api/v1/customers/group_id/"+s.usergroup.id+".json?_count=50&_page=1&provider_id="+c.provider.id+"&_token="+getCookie("user_token")}).success(function(e){k(e.result,t.type)})}else{}}else if(t.type==="engineer"){s.engineerPageNum=1;s.loadEngineer()}else if(t.type==="relationCustomer"){l({method:"GET",url:"api/v1/customers/coordination_group/"+s.usergroup.id+".json?provider_id="+c.provider.id+"&_token="+getCookie("user_token")}).success(function(e){k(e.result,t.type)})}else{s.dropdown.type="foreign";s.dropdown.currentDropdown=2;s.dropdown.isShowBack=true}}else if(s.dropdown.currentDropdown===2){if(s.dropdown.type==="customer"){s.tagAdded(t)}else{s.serviceDeskTop=t;b()}}else{if(s.dropdown.type==="engineer"){if(t.type==="serviceDesk"){s.tagAdded(t)}else{s.tagAdded(t.user)}}else{s.tagAdded(t)}}};s.changeCurrentDropdown=function(e,t){if(e==="back"){s.dropdown.currentDropdown--}if(s.dropdown.currentDropdown===1){s.dropdown.isShowBack=false;s.dropdown.isShowGroupIcon=false;s.dropdown.isShowNextIcon=true;s.dropdownList=s.dropdown.initDropdownList;if(s.dropdown.type=="foreign"){s.dropdown.type=""}}else if(s.dropdown.currentDropdown===2){if(t==="customer"||t==="relationCustomer"){s.dropdown.isShowBack=true;s.dropdown.isShowGroupIcon=false;s.dropdown.isShowNextIcon=false}else{s.dropdown.isShowBack=true;s.dropdown.isShowGroupIcon=true;s.dropdown.isShowNextIcon=true;s.dropdownList=s.groupList}}else{s.dropdown.isShowBack=true;s.dropdown.isShowGroupIcon=false;s.dropdown.isShowNextIcon=false}};s.inputForeign=function(){var e={name:s.dropdown.foreignEmail}};s.addForeign=function(){var n={name:s.dropdown.foreignEmail};if(!verifyEmailAddress(s.dropdown.foreignEmail)){a.add("格式有误","danger");return}var e=s.ccs&&_.filter(s.ccs,function(e){return e.name===n.name||n.name.indexOf(e.name)!==-1||e.name.indexOf(n.name)!==-1}).length>0;if(e){u();s.hideMenu();s.dropdown.isShowDropdown=true;return}var t="/api/v1/engineer_customer_simple_list.json?queryUserType=&key="+s.dropdown.foreignEmail;if(s.user&&s.user.id){t+="&userId="+s.user.id}l.get(t,{}).then(function(e){var t=e.data;var i=[];var r=angular.isDefined(t.result.users)?t.result.users:[];angular.forEach(r,function(e){var t=angular.isDefined(e.email)?e.email:"";i.push({id:e.id,name:e.name+"("+t+")"})});if(i.length<=0){s.tagAdded(n)}else{a.add("该邮箱请直接添加为抄送人，不能添加为外援","danger")}})};function y(){i.run(n.constant.EVENT_DETAIL_SERVICEDESKS,{id:s.serviceDeskTop.id},{},function(e){})}function w(){var e=o.detail.servicedesks.get(s.serviceDeskTop.id);if(e){var t=e.engineers||[];if(t.indexOf(s.serviceDeskTop)<=-1){s.serviceDeskTop.type="serviceDesk";t.unshift(s.serviceDeskTop)}s.dropdownList=t;s.dropdown.currentDropdown=3;s.dropdown.type="engineer";s.changeCurrentDropdown()}}function C(){n.register(d,n.constant.EVENT_DETAIL_SERVICEDESKS,function(e){w()})}function b(){w();y()}function S(){C()}S();function T(){n.unRegister(d)}s.$on("$destroy",function(){T()})}]).directive("ticketCcInput",[function(){return{restrict:"EA",templateUrl:"/source/scripts/directives/ticket-cc-input/ticket-cc-input.html",controller:"ticketCcInputController",scope:{ccs:"=",usergroup:"=",user:"=",iscopytome:"=",excludeusergroup:"@",who:"@",whoid:"@",assignable:"@",hidetomy:"@",width:"@",ispolymerizesearch:"@",isticketdetail:"="},compile:function e(a,t,i){return{post:function e(r,t,i,n){if(r.assignable=="false"){r.$on("removeDisabled",function(e,t){a.children().eq(0).removeAttr("disabled")});a.children().eq(0).attr("disabled","disabled")}setTimeout(function(){var i=t.find("ul");i.on("scroll",function(e,t){if(r.dropdown.currentDropdown==2&&r.dropdown.type=="engineer"){if(i[1].scrollTop===i[1].scrollHeight-i[1].clientHeight){r.engineerPageNum++;r.loadEngineer()}}})},0)}}},link:function(){void 0}}}]);angular.module("com.ewei.angular.ui").controller("ticketCustomeFieldController",["$scope","$http","$stateParams","alertService","$filter","ticketCustomFieldService","customFieldService","newTicketCustomFieldCacheService","$state","commonTools","cachedTicketService",function(d,i,e,s,a,n,o,f,p,m,l){d.datetimepickerConfig={datepickerOptions:{showWeeks:false},timepickerOptions:{showSeconds:true},buttonBar:{show:true,now:{show:true,text:"现在",cls:"btn-sm btn-default"},today:{show:true,text:"今天",cls:"btn-sm btn-default"},clear:{show:true,text:"清除",cls:"btn-sm btn-default"},date:{show:true,text:"日期",cls:"btn-sm btn-default"},time:{show:true,text:"时间",cls:"btn-sm btn-default"},close:{show:true,text:"关闭",cls:"btn-sm btn-default"},cancel:{show:false,text:"取消",cls:"btn-sm btn-default"}}};d.filedValueChange=function(e,t,i){if(t&&t!=""){var r=new String(t);if(r.indexOf("{value}")>0){r=r.replaceAll("{value}",i)}else{r=r+i}d.ticket.ticketCustomFields[e].valueUrl=r}};var c=function(e){var t=e;var i=[];for(var r=0;r<t.length;r++){var n=t[r];if(n.active!=true||n.systemFieldKey!=null&&n.systemFieldKey!=""){continue}var a={id:null,value:n.value,customField:null};try{if(n.type=="options"&&n.customFieldOptions){var o=angular.fromJson(n.customFieldOptions);if(typeof n.systemFieldKey=="undefined"&&o[0].name!="-"){o.unshift({name:"-",value:""})}n.customFieldOptions=o;d.copyCustomFieldOptions=angular.copy(o);if(n.value==undefined||n.value==""){a.value=""}if((n.value==undefined||n.value=="")&&n.defaultValue){for(var s=0;s<o.length;s++){if(o[s].value==n.defaultValue&&(!d.ticket||d.ticket&&!d.ticket.id&&d.ticket.status!=="closed"&&d.ticket.status!=="solved"&&!d.ticket.deleted&&d.ticket.status!=="deleted")){a.value=n.defaultValue}}}}else if(n.type=="multi_options"&&n.customFieldOptions){if(angular.isString(n.customFieldOptions)){n.customFieldOptions=angular.fromJson(n.customFieldOptions)}if(!n.value){angular.forEach(n.customFieldOptions,function(e){e.selectValue=false})}}}catch(e){void 0}if(n.type=="checkbox"){if(n.value=="true"){a.value=true}else{a.value=false}}if(n.notes!=undefined&&n.notes.length>40){n.notes=n.notes.substring(0,12)+". . . "}if(n.url){if(n.url.toLowerCase().indexOf("http://")!=0){n.url="http://"+n.url}if(n.url.indexOf("?")<0){a.fromParams="?"}else{a.fromParams="&"}var l=new String(n.url);if(l.indexOf("{value}")>0){l=l.replaceAll("{value}",a.value)}else{l=l+a.value}a.valueUrl=l}if(n.type=="date"&&a.value){n.startForm=false;a.value=m.parseDate(a.value,"yyyy/MM/dd")}else if(n.type=="date_time"&&a.value){n.startForm=false;a.value=m.parseDateTime(a.value,"yyyy/MM/dd HH:mm:ss")}else if(n.type=="date_to_date"){n.startTimeForm=false;n.endTimeForm=false;if(a.value){var c=a.value.split("-");n.startTime=m.parseDate(c[0],"yyyy/MM/dd");n.endTime=m.parseDate(c[1],"yyyy/MM/dd")}else{n.startTime="";n.endTime=""}}a.customField=n;a.id=n.id;i.push(a)}f.add(p.params.id,i);d.ticket.ticketCustomFields=f.get(p.params.id);d.ticket.ticketCustomFieldsCopy=angular.copy(d.ticket.ticketCustomFields);for(var r=0;r<d.ticket.ticketCustomFields.length;r++){var u=d.ticket.ticketCustomFields[r];if(u.customField.type=="date_to_date"&&u.value){var c=u.value.split("-");u.customField.startTime=m.parseDate(c[0],"yyyy/MM/dd");u.customField.endTime=m.parseDate(c[1],"yyyy/MM/dd");break}}};var t=function(){if(d.ticket.id){n.run("",{ticketId:d.ticket.id},true,function(e){c(e.result)})}else{if(d.ticket&&!d.ticket.ticketCustomFields){o.run("",{scope:"ticket",active:true},true,function(e){c(e.result.customFields)})}else{for(var e=0;e<d.ticket.ticketCustomFields.length;e++){var t=d.ticket.ticketCustomFields[e];var i=t.customField;if(i.active!=true||i.systemFieldKey!=null&&i.systemFieldKey!=""){continue}try{if(i.type=="date"&&t.value){i.startForm=false;t.value=m.parseDate(a("date")(t.value,"yyyy/MM/dd"))}else if(i.type=="date_time"&&t.value){i.startForm=false;t.value=m.parseDateTime(a("date")(t.value,"yyyy/MM/dd HH:mm:ss"))}else if(i.type=="date_to_date"){i.startTimeForm=false;i.endTimeForm=false;if(t.value){var r=t.value.split("-");i.startTime=m.parseDate(r[0],"yyyy/MM/dd");i.endTime=m.parseDate(r[1],"yyyy/MM/dd")}else{i.startTime="";i.endTime=""}}}catch(e){void 0}}}}};d.updateValue=function(e){var t=d.ticket.ticketCustomFieldsCopy[e];var i=d.ticket.ticketCustomFields[e];var r=d.ticket.ticketCustomFieldsCopy[e];if(i.value==r.value){return}var n=i.value;if(i.customField&&i.customField.type=="date_to_date"){if(i.customField.endTimeForm||i.customField.startTimeForm){return}else{if(!n){if(!i.customField.endTime&&!i.customField.startTime){}else{return}}}}if(i.customField.required&&!n){s.add("请输入"+i.customField.title,"danger","left");i.value=t.value;return}if(i.customField.regexpForValidation){var a=new RegExp(i.customField.regexpForValidation);if(n&&!a.test(n)){s.add("请输入正确的"+i.customField.title,"danger","left");i.value=t.value||"";return}}if(i.customField.url){if(i.customField.url.toLowerCase().indexOf("http://")!=0){i.customField.url="http://"+i.customField.url}if(i.customField.url.indexOf("?")<0){i.fromParams="?"}else{i.fromParams="&"}var o=new String(i.customField.url);if(o.indexOf("{value}")>0){o=o.replaceAll("{value}",i.value)}else{o=o+i.value}i.valueUrl=o}f.set(p.params.id,i);u(i,e)};d.change=function(e){var t=d.ticket.ticketCustomFields[e];var i=d.ticket.ticketCustomFieldsCopy[e];if(t.customField.type=="date_to_date"){if(t.customField.startTime!=undefined&&t.customField.startTime!=""){var r=a("date")(t.customField.startTime,"yyyy/MM/dd").toString()}else{s.add("请选取开始时间","danger","left");t.value="";return}if(t.customField.endTime!=undefined&&t.customField.endTime!=""){var n=a("date")(t.customField.endTime,"yyyy/MM/dd").toString()}else{s.add("请选取结束时间","danger","left");t.value="";return}if(t.customField.startTime&&t.customField.endTime&&t.customField.startTime>t.customField.endTime){s.add("结束时间必须大于等于开始时间","danger","left");t.value="";return}t.value=r+"-"+n}if(t.value==i.value){return}f.set(p.params.id,t);u(t,e)};var u=function(n,e){var t=n.value;if(t&&n.customField.type=="date"){t=a("date")(n.value,"yyyy/MM/dd").toString()}else if(t&&n.customField.type=="date_time"){t=a("date")(n.value,"yyyy/MM/dd HH:mm:ss").toString()}if(d.ticket.id!=null){i({url:"/api/v1/ticket_update/"+d.ticket.id+"/custom_field.json",method:"POST",data:{value:t,custom_field_id:n.customField.id}}).success(function(e,t,i,r){if(e.status==0){d.ticket.ticketCustomFieldsCopy=angular.copy(d.ticket.ticketCustomFields);l.updateCached(d.ticket);d.$emit("ticket-custom-field-value-updated",d.ticket.id,n.customField.id,n.value)}else{if(e.result&&e.result.error){s.add(e.result.error_description,"danger","left")}else{s.add("修改失败","danger","left")}}})}};d.open=function(e,t){e.preventDefault();e.stopPropagation();t.startForm=true};d.timeFrameOpen=function(e,t,i){e.preventDefault();e.stopPropagation();if(i=="startTimeForm"){t.startTimeForm=true}else{t.endTimeForm=true}};d.isInCustomForm=function(t){var e=_.find(d.customFormFields,function(e){return e.id==t.id});return e!=undefined};if(d.newTicketForm==true){t()}d.$on("ticket-loaded",t)}]).directive("ticketCustomeField",[function(){return{restrict:"AE",templateUrl:"/source/scripts/directives/ticket-custom-field/ticket-custom-field.html",controller:"ticketCustomeFieldController",scope:{ticket:"=",newTicketForm:"=",externalUrlAuthorize:"=",customFormFields:"="}}}]).directive("cascadeOptions",[function(){return{restrict:"AE",templateUrl:"/source/scripts/directives/cascade-options/cascade-options.html",controller:"cascadeController",scope:{ticketField:"=",ticketId:"=",category:"@",singleLine:"="}}}]).controller("cascadeController",["$scope","$http","alertService",function(a,r,o){function i(){if(a.category!=undefined&&a.category=="auto"){a.field=a.ticketField}else{a.field=a.ticketField.customField||a.ticketField}if(a.field.customFieldOptions&&angular.isString(a.field.customFieldOptions)){a.field.customFieldOptions=angular.fromJson(a.field.customFieldOptions)}if(a.ticketField.value==undefined||a.ticketField.value==""||a.ticketField.value=="-"){a.ticketField.value="-";a.catSelected=false}else if(a.field.edit_able==0){a.catSelected=false}else{a.catSelected=true}var e=0;a.showOption=a.field.customFieldOptions;a.fieldOldValue=a.field.value;a.backShow=false}i();a.$watch("ticketField",function(e,t){if(e!==t){i()}});a.selectOption=function(e,t){if(e.item.children){t.stopPropagation();index1=e.$index;a.backShow=true;a.showOption=e.item.children}else{var i=e.$index;a.backShow=false;a.catSelected=true;a.ticketField.value=a.field.customFieldOptions[index1].value+"/"+a.field.customFieldOptions[index1].children[i].value;a.showOption=a.field.customFieldOptions;if(a.category!="auto"){if(a.ticketField.value!=a.fieldOldValue){n(a.ticketField)}}}};a.back=function(e){e.stopPropagation();a.showOption=a.field.customFieldOptions;a.backShow=false};a.clear=function(){if(a.field.required){o.add(a.field.title+"是必填项，不能被清空","danger","left")}else if(!a.field.required&&a.field.edit_able==0){a.catSelected=false}else{a.catSelected=false;a.ticketField.value="-";a.showOption=a.field.customFieldOptions;n(a.ticketField)}};var n=function(n){n=angular.copy(n);if(a.ticketId!=null){if(n.value=="-"){n.value=""}var e="";var t={};var i="POST";if(a.category=="userCustomField"){e="/updateUserCustomField.json";t={id:n.customField.ticketCustomFieldId,value:n.value,userId:a.ticketId,customFieldId:n.customField.id}}else if(a.category=="userGroupCustomField"){e="/updateUserGroupCustomField.json";t={id:n.customField.ticketCustomFieldId,value:n.value,userGroupId:a.ticketId,customFieldId:n.customField.id}}else{e="/api/v1/ticket_update/"+a.ticketId+"/custom_field.json";i="PUT";t={custom_field_id:n.customField.id,value:n.value}}r({url:e,method:i,data:t}).success(function(e,t,i,r){if(e.status!==undefined){if(e.status==0){a.fieldOldValue=n.value;a.$emit("ticket-custom-field-value-updated",a.ticketId,n.customField.id,n.value)}else if(e.status!=0&&e.result&&e.result.error){if(e.result.error){o.add(e.result.error_description,"danger","left")}else{o.add("修改失败","danger","left")}}}else{if(e.success){a.fieldOldValue=n.value}else{if(e.message){o.add(e.message,"danger","left")}else{o.add("修改失败","danger","left")}}}})}}}]).directive("multiOptions",[function(){return{restrict:"AE",templateUrl:"/source/scripts/directives/multi-options/multi-options.html",controller:"multiOptions",scope:{ticketField:"=",ticketId:"=",category:"@",noneDefaultValue:"@"}}}]).controller("multiOptions",["$scope","$http","alertService",function(a,r,o){var n;function i(){if(a.category!=undefined&&a.category=="auto"){a.field=a.ticketField}else{a.field=a.ticketField.customField||a.ticketField}a.fieldOldValue=a.field.value;if(a.field.customFieldOptions&&angular.isString(a.field.customFieldOptions)){a.field.customFieldOptions=angular.fromJson(a.field.customFieldOptions)}if(a.ticketField.value==undefined||a.ticketField.value==""){n=[];if(a.ticketId==undefined){if(!a.noneDefaultValue){for(var e=0;e<a.field.customFieldOptions.length;e++){if(a.field.customFieldOptions[e].defaultValue){n.push(a.field.customFieldOptions[e].value);a.field.customFieldOptions[e].selectValue=true}}}}if(n.length>0&&a.field.edit_able!=0){a.catSelected=true}else{a.catSelected=false}a.ticketField.value=n.join(",")}else{n=a.ticketField.value.split(",");for(var e=0;e<a.field.customFieldOptions.length;e++){for(var t=0;t<n.length;t++){if(a.field.customFieldOptions[e].value==n[t]){a.field.customFieldOptions[e].selectValue=true}}}if(!a.field.required&&a.field.edit_able==0){a.catSelected=false}else{a.catSelected=true}}a.copyCustomFieldOptions=angular.copy(a.field.customFieldOptions)}i();a.$watch("ticketField",function(e,t){if(e!==t){i()}});a.dropdownMultiselectSearch=function(e,t){t.splice(0);var i=e.target.value.trim();angular.forEach(a.copyCustomFieldOptions,function(e){if(e.name&&e.name.search(new RegExp(i,"i"))>-1){t.push(e)}})};a.selected=function(e,t){if(a.category=="auto"||a.category=="polymerize_search"){if(t.selectValue==true){n.push(t.value);s(a.copyCustomFieldOptions,t,true)}else{for(var i=0;i<n.length;i++){if(n[i]==t.value){n.splice(i,1)}}s(a.copyCustomFieldOptions,t,false)}a.ticketField.value=n.join(",");a.catSelected=a.ticketField.value!=""?true:false}else{if(t.selectValue==true){s(a.copyCustomFieldOptions,t,true)}else{s(a.copyCustomFieldOptions,t,false)}}};var s=function(e,t,i){angular.forEach(e,function(e){if(e.value==t.value){e.selectValue=i}})};a.clear=function(){if(a.field.required&&a.category!="auto"&&a.category!="polymerize_search"){o.add(a.field.title+"是必填项，不能被清空","danger","left");if(a.ticketField.value){angular.forEach(a.ticketField.value.split(","),function(t){angular.forEach(a.field.customFieldOptions,function(e){if(t==e.value){e.selectValue=true}})})}return}else{a.ticketField.value="";n=[];a.catSelected=false;for(var e=0;e<a.field.customFieldOptions.length;e++){a.field.customFieldOptions[e].selectValue=false}l(a.ticketField)}};a.update=function(e){var i=[];var t=e.length<a.copyCustomFieldOptions.length?a.copyCustomFieldOptions:e;angular.forEach(t,function(t){if(t.selectValue==true){i.push(t.value)}else{angular.forEach(i,function(e){if(e==t.value){i.splice(i.indexOf(e),1)}})}});if(i.length==0&&a.field.required&&a.category!="auto"&&a.category!="polymerize_search"){o.add(a.field.title+"是必填项，不能被清空","danger","left");angular.forEach(a.ticketField.value.split(","),function(t){angular.forEach(a.field.customFieldOptions,function(e){if(t==e.value){e.selectValue=true}})})}else{a.ticketField.value=i.join(",")}if(a.ticketField.value!=a.fieldOldValue){l(a.ticketField);a.catSelected=a.ticketField.value!=""?true:false}};var l=function(n){if(a.ticketId!=null){var e="";var t={};var i="POST";if(a.category=="userCustomField"){e="/updateUserCustomField.json";t={id:n.customField.ticketCustomFieldId,value:n.value,userId:a.ticketId,customFieldId:n.customField.id}}else if(a.category=="userGroupCustomField"){e="/updateUserGroupCustomField.json";t={id:n.customField.ticketCustomFieldId,value:n.value,userGroupId:a.ticketId,customFieldId:n.customField.id}}else{e="/api/v1/ticket_update/"+a.ticketId+"/custom_field.json";i="PUT";t={custom_field_id:n.customField.id,value:n.value}}r({url:e,method:i,data:t}).success(function(e,t,i,r){if(e.status!==undefined){if(e.status==0){a.fieldOldValue=n.value;a.$emit("ticket-custom-field-value-updated",a.ticketId,n.customField.id,n.value)}else if(e.status!=0&&e.result&&e.result.error){if(e.result.error){o.add(e.result.error_description,"danger","left")}else{o.add("修改失败","danger","left")}}}else{if(e.success){a.fieldOldValue=n.value}else{if(e.message){o.add(e.message,"danger","left")}else{o.add("修改失败","danger","left")}}}})}}}]);+function(){"use strict";angular.module("com.ewei.angular.ui").controller("ticketCustomFormController",e).directive("ticketCustomForm",t);e.$inject=["$scope","$http","$stateParams","alertService","$filter","ticketCustomFieldService","customFieldService","newTicketCustomFieldCacheService","$state","commonTools","cachedTicketService","permissions"];function e(s,r,e,l,a,t,i,c,u,n,o,d){if(d.hasPermission("ticket_update")){s.editableTicket=true}else{s.editableTicket=false}s.datetimepickerConfig={datepickerOptions:{showWeeks:false},timepickerOptions:{showSeconds:true},buttonBar:{show:true,now:{show:true,text:"现在",cls:"btn-sm btn-default"},today:{show:true,text:"今天",cls:"btn-sm btn-default"},clear:{show:true,text:"清除",cls:"btn-sm btn-default"},date:{show:true,text:"日期",cls:"btn-sm btn-default"},time:{show:true,text:"时间",cls:"btn-sm btn-default"},close:{show:true,text:"关闭",cls:"btn-sm btn-default"},cancel:{show:false,text:"取消",cls:"btn-sm btn-default"}}};s.customFormFieldsCopy=angular.copy(s.customFormFields);s.updateValue=function(e){var t=s.customFormFieldsCopy[e];var i=s.customFormFields[e];var r=s.customFormFieldsCopy[e];if(i.value==r.value){return}var n=i.value;if(i.customField&&i.customField.type=="date_to_date"){if(i.customField.endTimeForm||i.customField.startTimeForm){return}else{if(!n){if(!i.customField.endTime&&!i.customField.startTime){}else{return}}}}if(i.customField.required&&!n){l.add("请输入"+i.customField.title,"danger","left");i.value=t.value;return}if(i.customField.regexpForValidation){var a=new RegExp(i.customField.regexpForValidation);if(n&&!a.test(n)){l.add("请输入正确的"+i.customField.title,"danger","left");i.value=t.value||"";return}}if(i.customField.url){if(i.customField.url.toLowerCase().indexOf("http://")!=0){i.customField.url="http://"+i.customField.url}if(i.customField.url.indexOf("?")<0){i.fromParams="?"}else{i.fromParams="&"}var o=new String(i.customField.url);if(o.indexOf("{value}")>0){o=o.replaceAll("{value}",i.value)}else{o=o+i.value}i.valueUrl=o}c.set(u.params.id,i);f(i,e)};s.change=function(e){var t=s.customFormFields[e];var i=s.customFormFieldsCopy[e];if(t.customField.type=="date_to_date"){if(t.customField.startTime!=undefined&&t.customField.startTime!=""){var r=a("date")(t.customField.startTime,"yyyy/MM/dd").toString()}else{l.add("请选取开始时间","danger","left");t.value="";return}if(t.customField.endTime!=undefined&&t.customField.endTime!=""){var n=a("date")(t.customField.endTime,"yyyy/MM/dd").toString()}else{l.add("请选取结束时间","danger","left");t.value="";return}if(t.customField.startTime&&t.customField.endTime&&t.customField.startTime>t.customField.endTime){l.add("结束时间必须大于等于开始时间","danger","left");t.value="";return}t.value=r+"-"+n}if(t.value==i.value){return}c.set(u.params.id,t);f(t,e)};var f=function(e,t){var i=e.value;if(i&&e.customField.type=="date"){i=a("date")(e.value,"yyyy/MM/dd").toString()}else if(i&&e.customField.type=="date_time"){i=a("date")(e.value,"yyyy/MM/dd HH:mm:ss").toString()}if(s.ticket.id!=null){r({url:"/api/v1/ticket_update/"+s.ticket.id+"/custom_field.json",method:"POST",data:{value:i,custom_field_id:e.customField.id}}).success(function(e,t,i,r){if(e.status==0){s.customFormFieldsCopy=angular.copy(s.customFormFields);o.updateCached(s.ticket)}else{if(e.result&&e.result.error){l.add(e.result.error_description,"danger","left")}else{l.add("修改失败","danger","left")}}})}};s.open=function(e,t){e.preventDefault();e.stopPropagation();t.startForm=true};s.timeFrameOpen=function(e,t,i){e.preventDefault();e.stopPropagation();if(i=="startTimeForm"){t.startTimeForm=true}else{t.endTimeForm=true}};s.$watchCollection("customFormFields",function(e,t){if(e!==t){s.customFormFieldsCopy=angular.copy(s.customFormFields)}})}t.$inject=[];function t(){return{restrict:"AE",templateUrl:"/source/scripts/directives/ticket-custom-form/ticket-custom-form.html",controller:"ticketCustomFormController",scope:{ticket:"=",customFormFields:"=",externalUrlAuthorize:"=",onHide:"&",newTicketForm:"=",customFormLoading:"="}}}}();(function(C){"use strict";C.module("com.ewei.angular.ui").controller("ticketFormController",e).directive("ticketForm",t);e.$inject=["$rootScope","$scope","$http","alertService","$stateParams","permissions","utils","$state","$filter","$modal_","ConsoleConfig","userService","ticketExternalUrlAuthorizeService","accessableTicketService","coreNotifyService","cachedTicketService","$timeout"];function e(o,s,l,c,e,t,i,r,u,n,a,d,f,p,m,h,g){if(t.hasPermission("ticket_update")){s.editableTicket=true}else{s.editableTicket=false}if(t.hasPermission("ticket_force_handle")){s.ticket_force_handle=true}else{s.ticket_force_handle=false}s.$watch("ticket.activitiWorkflowTemplate",function(e){s.ticket.workflowTemplate=e});s.tagsField=C.fromJson(localStorage.getItem("systemFieldTags"));s.$on("selectedPriority",function(e,t){if(s.ticket.id!=null){l({url:"/api/v1/ticket_update/"+s.ticket.id+"/priority.json",method:"PUT",data:{priority:t}}).success(function(e,t,i,r){if(e.status==0){o.$broadcast("ticket_sla_update",{ticketId:s.ticket.id});g(function(){s.$parent.refreshTicketDetail()},800);h.updateCached(s.ticket)}else{if(e.result&&e.result.error){c.add(e.result.error_description,"danger","left")}else{c.add("修改优先级失败","danger","left")}}})}});s.$on("selectedTicketType",function(e,t){if(s.ticket.id!=null){var i=s.ticket.ticketType==null?null:s.ticket.ticketType.name;l({url:"/api/v1/ticket_update/"+s.ticket.id+"/ticket_type.json",method:"PUT",data:{ticket_type_id:t?t.id:null}}).success(function(e,t,i,r){if(e.status!=0&&e.result){if(e.result.error){c.add(e.result.error_description,"danger","left")}else{c.add("修改工单类型失败","danger","left")}}else{g(function(){s.$parent.refreshTicketDetail()},800);h.updateCached(s.ticket)}})}});s.currentUser=a.user;s.requesterToMeShow=true;s.updateRequesterToMe=function(){d.get({id:a.user.id},function(e){if(e){if(s.ticket.id!=null){s.$emit("selectedUser",e.json)}else{s.ticket.requester=e.json}}})};if(e.categoryid&&e.projectid){s.updateRequesterToMe();s.ticketprojecttype="任务"}s.$watch("ticket.createType",function(e){if(e==="batch-engineer"){s.updateRequesterToMe()}});s.$on("selectedServiceCatalog",function(e,t,i,r){if(s.ticket.id!=null){var n=t==null?null:t.id;var a=s.ticket.serviceCatalog==null?null:s.ticket.serviceCatalog.id;if(n!=a){l({url:"/api/v1/ticket_update/"+s.ticket.id+"/service_catalog.json",method:"POST",data:{service_catalog_id:n}}).success(function(e,t,i,r){if(e.status==0){o.$broadcast("ticket_sla_update",{ticketId:s.ticket.id});g(function(){s.$parent.refreshTicketDetail()},800);h.updateCached(s.ticket)}else{if(e.result&&e.result.error){c.add(e.result.error_description,"danger","left")}else{c.add("修改工单服务目录失败","danger","left")}}})}}});s.selectedEngineerMessage={open:false,copyToMe:false};var v={type:"engineer",data:{},engineer:function(a){v.isSaving=true;l({url:"/api/v1/ticket/"+s.ticket.id+"/assign_to_engineer.json",method:"POST",data:v.postData}).success(function(e,t,i,r){v.isSaving=false;s.isLoding=false;s.selectedEngineerMessage={open:false,copyToMe:false};if(e.status==0&&e.result){for(var n=0;n<s.ticketLogs.length;n++){if(s.ticketLogs[n].hasOwnProperty("ticketComment")&&!s.ticketLogs[n].ticketComment.hasOwnProperty("id")){s.ticketLogs[n].ticketComment.id=e.result.ticketCommentId;break}}s.ticket.engineer=a.engineer;s.ticket.serviceDesk=a.serviceDesk;y();g(function(){s.$parent.refreshTicketDetail()},800);s.$parent.setReplyBoxDefaultMessage(s.ticket.status);c.add("分派处理人成功","success")}else{s.ticketLogs.shift();if(C.isObject(v.data)&&C.isObject(v.data.oldTicket)){s.ticket.engineer=v.data.oldTicket.engineer;s.ticket.workflowTemplate=v.data.oldTicket.workflowTemplate;s.ticket.serviceDesk=v.data.oldTicket.serviceDesk}if(e.result&&e.result.error){if(e.result.error=="license_limit"){c.add("授权限制","danger","left")}else{c.add(e.result.error_description,"danger","left")}}else{c.add("修改处理人失败","danger","left")}}k.hide()})},workFlow:function(e){v.isSaving=true;var t={ticketId:v.postData.id,activitiWorkflowTemplateId:v.postData.workflowTemplateId,ticketComment:v.postData.ticketComment,copyToMe:v.postData.ticketComment.copyToMe};org.ewei.sdk.OpenTicketApi().assignTicketToActivitiWorkflow(t).then({success:function(e){v.isSaving=false;s.isLoding=false;s.selectedEngineerMessage={open:false,copyToMe:false};if(e){for(var t=0;t<s.ticketLogs.length;t++){if(s.ticketLogs[t].hasOwnProperty("ticketComment")&&!s.ticketLogs[t].ticketComment.hasOwnProperty("id")){break}}y();m.doNotify(m.constant.EVENT_TICKET_WORKFLOWS);s.$broadcast("load_workflows");g(function(){s.$parent.refreshTicketDetail()},800);s.$parent.setReplyBoxDefaultMessage(s.ticket.status);c.add("分派处理人成功","success")}else{s.ticketLogs.shift();if(C.isObject(v.data)&&C.isObject(v.data.oldTicket)){s.ticket.engineer=v.data.oldTicket.engineer;s.ticket.workflowTemplate=v.data.oldTicket.workflowTemplate;s.ticket.serviceDesk=v.data.oldTicket.serviceDesk}if(response.result&&response.result.error){if(response.result.error=="license_limit"){c.add("授权限制","danger","left")}else{c.add(response.result.error_description,"danger","left")}}else{c.add("修改处理人失败","danger","left")}}k.hide()}})},serviceDesk:function(e){v.isSaving=true;l({url:"/api/v1/ticket/"+s.ticket.id+"/assign_to_service_desk.json",method:"POST",data:v.postData}).success(function(e,t,i,r){v.isSaving=false;s.isLoding=false;s.selectedEngineerMessage={open:false,copyToMe:false};if(e.status==0&&e.result){for(var n=0;n<s.ticketLogs.length;n++){if(s.ticketLogs[n].hasOwnProperty("ticketComment")&&!s.ticketLogs[n].ticketComment.hasOwnProperty("id")){s.ticketLogs[n].ticketComment.id=e.result.ticketCommentId;break}}s.ticket.engineer=null;y();g(function(){s.$parent.refreshTicketDetail()},800);s.$parent.setReplyBoxDefaultMessage(s.ticket.status);c.add("分派处理人成功","success")}else{s.ticketLogs.shift();if(C.isObject(v.data)&&C.isObject(v.data.oldTicket)){s.ticket.engineer=v.data.oldTicket.engineer;s.ticket.workflowTemplate=v.data.oldTicket.workflowTemplate;s.ticket.serviceDesk=v.data.oldTicket.serviceDesk}if(e.result&&e.result.error){if(e.result.error=="license_limit"){c.add("授权限制","danger","left")}else{c.add(e.result.error_description,"danger","left")}}else{c.add("修改处理人失败","danger","left")}}k.hide()})}};var k=n({scope:s,template:"source/scripts/directives/selected-engineer-message/selected-engineer-model-template.html",contentTemplate:"source/scripts/directives/selected-engineer-message/selected-engineer-message-template.html",html:true,show:false,backdrop:"static",title:"添加回复",placement:"center"});s.isLoding=false;s.saveSelectedEngineerMessage=function(){s.isLoding=true;void 0;if(s.selectedEngineerMessage.copyToMe){v.postData.copyToMe=true;s.isCopyToMe=true}if(s.selectedEngineerMessage&&s.selectedEngineerMessage.content&&s.selectedEngineerMessage.content.length>1e3){c.add("请不要超过1000个字符","danger");return}if(s.selectedEngineerMessage&&!s.selectedEngineerMessage.content){s.selectedEngineerMessage.content=s.engineerOrWorkflowName}if(v.isSaving){return false}var e={createdAt:(new Date).format("yyyy-MM-dd hh:mm:ss"),ticketComment:s.selectedEngineerMessage,user:a.user};e.user.type="engineer";s.ticketLogs.unshift(e);var t=eweiCommon.uuid(32).toLowerCase();s.allReceivedMsg[t]=true;if(v&&v.postData&&v.postData.ticketComment){v.postData.ticketComment.uid=t}v[v.type](v.data)};s.cancelSaveSelectedEngineerMessage=function(){k.hide();s.selectedEngineerMessage={open:false,copyToMe:false};if(C.isObject(v.data)&&C.isObject(v.data.oldTicket)){s.ticket.engineer=v.data.oldTicket.engineer;s.ticket.workflowTemplate=v.data.oldTicket.workflowTemplate;s.ticket.serviceDesk=v.data.oldTicket.serviceDesk}};s.$on("selectedWorkflow",function(e,t){var i=t==null?null:t.id;var r=t==null?null:"工作流："+t.name;s.engineerOrWorkflowName="工单交由"+t.name+"处理";var n=t.oldTicket.workflowTemplate==null?null:t.oldTicket.workflowTemplate.id;if(s.ticket.id!=null&&i!=n){v.type="workFlow";v.data=t;v.postData={id:s.ticket.id,workflowTemplateId:i,to:r,from:w(t.oldTicket),ticketComment:s.selectedEngineerMessage};k.show()}});s.$on("selectedServiceDesk",function(e,t){var i=t==null?null:t.id;var r=t==null?null:"客服组："+u("translate")(t.name);s.engineerOrWorkflowName="工单交由"+u("translate")(t.name)+"处理";var n=t.oldTicket.serviceDesk==null?null:t.oldTicket.serviceDesk.id;var a=t.oldTicket.engineer==null?null:t.oldTicket.engineer.id;if(s.ticket.id!=null&&(i!=n||a!=null)){v.type="serviceDesk";v.data=t;v.postData={id:s.ticket.id,serviceDeskId:i,to:r,from:w(t.oldTicket),ticketComment:s.selectedEngineerMessage};k.show()}});s.$on("selectedEngineer",function(e,t){var i=t.engineer==null?null:t.engineer.id;var r=t.serviceDesk==null?null:t.serviceDesk.id;var n=i==null?null:"客服："+u("translate")(t.serviceDesk.name)+"/"+t.engineer.user.name;var a=t.oldTicket.engineer==null?null:t.oldTicket.engineer.id;var o=t.oldTicket.serviceDesk==null?null:t.oldTicket.serviceDesk.id;if(t.asignMe){s.engineerOrWorkflowName="我来处理"}else{s.engineerOrWorkflowName="工单交由"+t.engineer.user.name+"处理"}if(s.ticket.id!=null){k.show();v.type="engineer";v.data=t;v.postData={id:s.ticket.id,engineerId:i,serviceDeskId:r,to:n,from:w(t.oldTicket),ticketComment:s.selectedEngineerMessage}}});var y=function(){p.run(s.ticket.id,{},false,function(e){if(e.status!=0&&e.result&&e.result.error){c.add(u("translate")(e.result.error_description),"danger");i.removeActiveTab(r)}})};var w=function(e){if(e.workflowTemplate!=null){return"工作流："+e.workflowTemplate.name}else if(C.isDefined(e.serviceDesk)&&e.engineer!=null){return"客服："+u("translate")(e.serviceDesk.name)+"/"+e.engineer.user.name}else if(C.isDefined(e.serviceDesk)&&e.serviceDesk!=null){return"服务台："+u("translate")(e.serviceDesk.name)}else{return null}};s.$watch("ticket.id",function(){if(s.ticket!=null&&s.ticket.id!=null){if(s.ticket.status=="closed"||s.ticket.status=="deleted"||!s.editableTicket){s.requesterToMeShow=false}s.ticket_bottom="ticket_bottom_0"}else{s.ticket_bottom="ticket_bottom_80"}var e=false;s.typeFiled=C.fromJson(localStorage.getItem("systemFieldTicketType"));if(!s.ticket.ticketType&&s.ticket.id==null){if(s.typeFiled&&s.typeFiled.customFieldOptions){for(var t=0;t<s.typeFiled.customFieldOptions.length;t++){if(s.typeFiled.defaultValue==s.typeFiled.customFieldOptions[t].value){e=true;break}}}if(e){s.ticket.ticketType={id:s.typeFiled.defaultValue}}}s.priorityFiled=C.fromJson(localStorage.getItem("systemFieldPriority"));if(s.priorityFiled&&s.priorityFiled.required&&s.ticket.id==null){s.ticket.priority=s.priorityFiled.defaultValue}s.catalogFiled=C.fromJson(localStorage.getItem("systemFieldServiceCatalog"));f.run("",{},false,function(e){if(e.success&&e.json){s.externalUrlAuthorize=e.json}});s.tagsField=C.fromJson(localStorage.getItem("systemFieldTags"));s.planSolvedAtField=C.fromJson(localStorage.getItem("systemFieldPlanSolvedAt"));void 0})}t.$inject=[];function t(){return{restrict:"EA",replace:true,templateUrl:"/source/scripts/directives/ticket-form/ticket-form.html",controller:"ticketFormController",scope:{ticket:"=",ticketLogs:"=",newTicketForm:"=",allReceivedMsg:"=",customFormFields:"=",hideRequester:"=",hideHandle:"="}}}})(angular);(function(){"use strict";angular.module("eweiApp.ticket").controller("ticketCommentDetailCtrl",t).directive("ticketCommentDetail",e);e.$inject=["$state"];function e(a){var e={restrict:"EA",link:t,templateUrl:"/source/scripts/directives/ticket-comment-detail/ticket-comment-detail.html",controller:"ticketCommentDetailCtrl",controllerAs:"vm",bindToController:true,scope:{ticketComment:"=comment",ticketId:"@",ticketUser:"=user"}};return e;function t(n,e,t,i){e.on("click","a",function(e){if(!e||!e.target||!e.target.href)return;var t=URI.parse(e.target.href);var i=/^\/(tickets|webchats|project_detail)\//g;if(t&&t.host===location.hostname&&t.fragment&&!e.shiftKey&&!e.ctrlKey&&!e.altKey){i.lastIndex=0;var r=i.exec(t.fragment)[1];switch(r){case"tickets":var n=/^\/tickets\/(\d+)/g.exec(t.fragment);if(n&&n.length==2){a.go("tickets_detail",{id:n[1]});e.preventDefault()}break;case"project_detail":var n=/^\/project_detail\/(\d+)\/(\d+)/g.exec(t.fragment);if(n&&n.length==3){a.go("project_detail",{categoryid:n[1],id:n[2]});e.preventDefault()}break}}});function r(){if(n.vm.ticketComment&&n.vm.ticketComment.type==7){var e=/\[([\s\S]+)\]/gi;var t=/\(([\s\S]+)\)/gi;var i=e.exec(n.vm.ticketComment.content);if(i&&i.length==2){n.vm.ticketComment.linkTitle=i[1]}var r=t.exec(n.vm.ticketComment.content);if(r&&r.length==2){n.vm.ticketComment.linkAddress=r[1]}}}r();n.$watch("vm.ticketComment",function(e,t){if(e!==t){r()}},true)}}t.$inject=["$state","$http","ticketSaveCommentService","coreNotifyService"];function t(t,e,i,r){var n=this;n.toShowWebchat=s;if(n.ticketComment.richTextContent){n.new_ticket_content=n.ticketComment.richTextContent.richText}else{n.new_ticket_content=n.ticketComment.content}n.toggleTicketLogOpen=a;n.openMap=o;n.reSendTicket=l;n.openAsset=function(e){var t=org.ewei.utils.getURLStringA(e,"uuid");r.doNotify(r.constant.EVENT_APP_OPEN_ASSET,{uuid:t})};function a(t){t.open=!t.open;e.get("ticket_comment_visible/"+t.id+".json?open="+t.open+"").success(function(e){if(!e.success){t.open=!t.open}})}function o(e,t,i){var r=30.622084+","+104.071962;var n="http://api.map.baidu.com/marker?location="+r+"&title=我的位置&content="+i+"&output=html";window.open(n,"_blank")}function s(e){t.go("webchats_new.detail",{id:e.id},{reload:"webchats_new.detail"})}function l(e){if(!e.sending){i.setTicketComment(e,e.ticket.status)}}}})();(function(){"use strict";angular.module("eweiApp.ticket").controller("oemLearnMoreCtrl",e).directive("oemLearnMore",t);e.$inject=["$modal_","$scope","oemSettingService","alertService","$rootScope","ConsoleConfig"];function e(e,t,i,r,n,a){var o=this;o.editConfig=c;o.saveOemConfig=u;o.editModel={};o.oemConfig=i.getLocalOemConfig();o.show=false;o.showLearnMore={description:o.description,learnMoreUrl:o.learnMoreUrl};o.nameKey=a&&a.engineer&&a.engineer.role?a.engineer.role.nameKey:"";n.$watch("oemConfig",function(){if(n.oemConfig!=null){o.oemConfig=i.getLocalOemConfig()}});function s(e){if(e.indexOf("http://")>=0||e.indexOf("https://")>=0){return e}else{return"http://"+e}}var l=e({scope:t,prefixEvent:"oem-config",template:"modal/modal.tpl.w620.html",controller:"oemLearnMoreEditCtrl",controllerAs:"oemLearnMoreEdit",contentTemplate:"source/scripts/directives/oem-learn-more/oem-learn-more-edit.html",html:true,show:false,placement:"center"});if(o.oemConfig&&o.oemConfig.open){if(o.oemConfig.learnMore=="each"){i.getOemHelpDoc(o.type).success(function(e){if(e.success&&e.json){if(e.json.description){o.showLearnMore.description=e.json.description}else{o.showLearnMore.description=o.description.replaceAll("易维帮助台",a.provider.name)}if(e.json.learnMoreUrl){o.showLearnMore.learnMoreUrl=s(e.json.learnMoreUrl)}}o.editModel={oemConfig:{id:o.oemConfig.id},description:o.showLearnMore.description,learnMoreUrl:o.showLearnMore.learnMoreUrl,type:o.type};o.show=true}).error(function(){o.show=true})}else if(o.oemConfig.learnMore=="one"&&o.oemConfig.learnMoreUrl){o.showLearnMore.description=o.description.replaceAll("易维帮助台",a.provider.name);o.showLearnMore.learnMoreUrl=s(o.oemConfig.learnMoreUrl);o.show=true}}else{o.show=true}if(a.provider&&a.provider.name){o.showLearnMore.description=o.description.replaceAll("易维帮助台",a.provider.name)}t.$on("changePrividerName",function(e,t){o.showLearnMore.description=o.description.replaceAll("易维帮助台",t)});function c(){l.show()}function u(e){if(!e){return false}if(o.editModel.description.length>1e3){r.add("描述不能大于1000个字符","danger");return false}if(o.editModel.learnMoreUrl.length>255){r.add("链接地址不能大于255个字符","danger");return false}i.saveOemHelpDoc(o.editModel).success(function(e){if(e.success){o.showLearnMore.description=o.editModel.description;o.showLearnMore.learnMoreUrl=s(o.editModel.learnMoreUrl);o.id=e.id;l.hide()}else{if(e.messgae){r.add($filter("translate")(e.message),"danger")}else{r.add("更新失败","danger")}}}).error(function(){})}}function t(){var e={restrict:"E",controller:"oemLearnMoreCtrl",controllerAs:"oemLearnMore",bindToController:true,templateUrl:"source/scripts/directives/oem-learn-more/oem-learn-more.html",scope:{type:"@",description:"@",learnMoreUrl:"@"}};return e}})();(function(){"use strict";var p=document.documentElement.clientWidth||document.body.clientWidth;var a=document.documentElement.clientHeight||document.body.clientHeight;angular.module("eweiApp.ticket").controller("ticketImageViewCtrl",t).directive("ticketImageView",e).directive("detailImgsShowBox",i).directive("setDetailLiWidth",r).directive("setDetailImgBl",n);e.$inject=["$timeout"];function e(e){var t={restrict:"A",link:i,scope:{},controller:"ticketImageViewCtrl",controllerAs:"vm"};return t;function i(e,i,t,r){i.click(function(e){var t=e.target;if(t.tagName==="IMG"&&$(t).hasClass("js-view")){r.viewImages(i.find("img.js-view"),t)}});var n=null;window.onresize=function(){clearTimeout(n);n=setTimeout(function(){p=document.documentElement.clientWidth||document.body.clientWidth;a=document.documentElement.clientHeight||document.body.clientHeight},1e3)}}}t.$inject=["$modal_","$scope","$rootScope","EweiConfig"];function t(i,n,e,t){var a=this;a.viewImages=r;a.viewImage=o;a.slideImages=[];n.saveAsImage=function(e){window.open("/no_auth_ewei_attachment?contentUrl="+e.$parent.item.contentUrl+"&attname="+e.$parent.item.fileName)};function r(e,r){a.viewImagesModal=i({scope:n,template:"source/scripts/directives/ticket-image-view/view-image-template.html",contentTemplate:"source/scripts/directives/ticket-image-view/view-image.html",html:true,show:true,backdrop:"static",placement:"center"});a.slideImages=[];var t=$(r).scope().attachment;a.slideImages.push({src:$(r).attr("src").replace("-log.200",""),contentUrl:t.contentUrl,fileName:t.fileName});e.each(function(e,t){if(t!=r){var i=$(t).scope().attachment;a.slideImages.push({src:$(t).attr("src").replace("-log.200",""),contentUrl:i.contentUrl,fileName:i.fileName})}});n.$applyAsync()}function o(e){var t="width="+window.screen.availWidth+",height="+(window.screen.availHeight-60);window.open("source/views/image-view.html?url=/no_auth_ewei_attachment?contentUrl="+$(e.target).scope().img.contentUrl+"&attname="+$(e.target).scope().img.fileName,"_blank","toolbar=0,location=no,menubar=0,modal=yes,alwaysRaised=yes,"+t)}}i.$inject=[];function i(){return{restrict:"EA",link:function(i,e,t){var r=e[0].getElementsByTagName("ul")[0];var n=e[0].getElementsByTagName("a");var a=r.getElementsByTagName("li");var o=r.getElementsByTagName("img");var s=0;if(i.$parent.vm.slideImages&&i.$parent.vm.slideImages.length){var l=i.$parent.vm.slideImages;r.style.width=p*l.length+"px";n[0].onclick=function(){if(/msie/i.test(navigator.userAgent)||"ActiveXObject"in window||navigator.userAgent.indexOf("Edge")!==-1){a=r.getElementsByTagName("li")}if(s===0){s=a.length-1;r.style.left=-r.offsetWidth+"px";eweiCommon.startMove(r,{left:-a[0].offsetWidth*s})}else{s--;eweiCommon.startMove(r,{left:-a[0].offsetWidth*s})}};n[1].onclick=function(){if(/msie/i.test(navigator.userAgent)||"ActiveXObject"in window||navigator.userAgent.indexOf("Edge")!==-1){a=r.getElementsByTagName("li")}if(a.length-1===s){s=0;r.style.left=a[0].offsetWidth+"px";eweiCommon.startMove(r,{left:-a[0].offsetWidth*s})}else{s++;eweiCommon.startMove(r,{left:-a[0].offsetWidth*s})}};var c=0;n[2].onclick=function(){if(/msie/i.test(navigator.userAgent)||"ActiveXObject"in window||navigator.userAgent.indexOf("Edge")!==-1){o=r.getElementsByTagName("img")}c=(c+90)%360;o[s].style.transform="rotate("+c+"deg)"};document.onkeydown=function(e){var t=e||window.event;if(t.keyCode===37){n[0].onclick()}else if(t.keyCode===39){n[1].onclick()}else if(t.keyCode===27){document.onkeydown=null}};var u=0;var d=0;r.onmousedown=function(e){var t=e||window.event;var n=t.srcElement||t.target;if(n.nodeName.toLowerCase()=="img"){u=t.clientX-n.offsetLeft;d=t.clientY-n.offsetTop;document.onmousemove=function(e){var t=e||window.event;var i=t.clientX-u;var r=t.clientY-d;n.style.left=i+"px";n.style.top=r+"px"};document.onmouseup=function(e){document.onmousemove=null;document.onmouseup=null};t.preventDefault();return false}else if(n.nodeName.toLowerCase()=="li"){if(i.$parent.vm.viewImagesModal){i.$parent.vm.viewImagesModal.hide();document.onkeydown=null}}};var f=function(e){var t=e||window.event;var i=t.srcElement||t.target;var r=1.05;if(i.nodeName.toLowerCase()=="img"){var n=t.detail?-t.detail/3:t.wheelDelta/120;var a=i.offsetWidth,o=i.offsetHeight;var s=i.offsetLeft,l=i.offsetTop;if(n>0){i.style.width=i.offsetWidth*r+"px";i.style.height=i.offsetHeight*r+"px"}else{i.style.width=i.offsetWidth/r+"px";i.style.height=i.offsetHeight/r+"px"}i.style.left=s+(a-i.offsetWidth)/2+"px";i.style.top=l+(o-i.offsetHeight)/2+"px"}t.preventDefault()};r.addEventListener("mousewheel",f,false);r.addEventListener("DOMMouseScroll",f,false)}}}}r.$inject=[];function r(){return{restrict:"EA",link:function(e,t,i){t[0].style.width=p+"px"}}}n.$inject=["alertService"];function n(r){return{restrict:"EA",link:function(e,t,i){t[0].onload=function(){t[0].style.position="absolute";if(t[0].offsetWidth>p||t[0].offsetHeight>a){if(t[0].offsetWidth/t[0].offsetHeight>p/a){t[0].style.width=p+"px";t[0].style.left=0;t[0].style.top=(a-t[0].offsetHeight)/2+"px"}else{t[0].style.height=a+"px";t[0].style.top=0;t[0].style.left=(p-t[0].offsetWidth)/2+"px"}}else{t[0].style.left=(p-t[0].offsetWidth)/2+"px";t[0].style.top=(a-t[0].offsetHeight)/2+"px"}};t[0].onerror=function(){r.add("图片加载失败","danger")}}}}})();(function e(p,m){"use strict";var t=p.module("ngContextMenu",[]);t.factory("contextMenu",["$rootScope",function e(t){function i(){t.$broadcast("context-menu/close")}return{cancelAll:i,eventBound:false}}]);t.directive("contextMenu",["$http","$timeout","$interpolate","$compile","contextMenu",function e(c,t,u,d,f){return{restrict:"EA",scope:true,require:"?ngModel",link:function e(a,o,t,i){if(!f.eventBound){m.addEventListener("click",function e(){f.cancelAll();a.$apply()});f.eventBound=true}function s(){if(a.menu){a.menu.remove();a.menu=null;a.position=null}}a.$on("context-menu/close",s);function l(){return i?p.extend(a,i.$modelValue):a}function r(e,n){n=n||"append";if("preventDefault"in e){f.cancelAll();e.stopPropagation();e.preventDefault();if(t.data!=undefined){a.position={x:e.offsetX,y:e.offsetY}}else{a.position={x:e.clientX,y:e.clientY}}}else{if(!a.menu){return}}c.get(t.contextMenu,{cache:true}).then(function e(t){var i=d(t.data)(p.extend(l())),r=p.element(i);switch(n){case"append":o.append(r);break;default:a.menu.replaceWith(r);break}r.css({position:"fixed",top:0,left:0,transform:u("translate({{x}}px, {{y}}px)")({x:a.position.x,y:a.position.y})});a.menu=r;a.menu.bind("click",s)})}if(i){var n=function e(){return i.$modelValue};a.$watch(n,function e(){r({},"replaceWith")},true)}o.bind(t.contextEvent||"contextmenu",r)}}}])})(window.angular,window.document);(function(){"use strict";angular.module("com.ewei.angular.ui").directive("ticketLog",e).controller("ticketLogController",t);function e(){return{restrict:"EA",replace:false,scope:{ticketid:"@",ticketLogs:"=",allReceivedMsg:"="},templateUrl:"/source/scripts/directives/ticket-log/ticket-log.html",controller:"ticketLogController",controllerAs:"ticketLog",bindToController:true}}t.$inject=["$scope","ticketLogService","locker","$http","$rootScope","ConsoleConfig"];function t(t,i,e,r,n,a){var o=this;o.filterType="comments";o.currentPage=1;o.pageCount=10;o.loadTicketContext=l;o.loadMoreTicketContext=u;o.loadTicketTimeline=c;o.isLoadingTicketContext=false;var s=function(e){return{all:{_fields:"id,createdAt,operations,ticketComment,ticketComment.richTextContent,chat,user.type,user.name,user.photo.contentUrl",_filter:"{'$eq':{'ticket.id':"+o.ticketid+"}}",_count:o.pageCount,_page:e,_do_count:true,_desc:"id"},comments:{_fields:"id,createdAt,operations,ticketComment,ticketComment.richTextContent,chat,user.type,user.name,user.photo.contentUrl",_filter:"{'$and':[{'$eq':{'ticket.id':"+o.ticketid+"}},{'$is_not_null':['ticketComment']}]}",_count:o.pageCount,_page:e,_do_count:true,_desc:"id"},logs:{_fields:"id,createdAt,operations,chat,user.name",_filter:"{'$and':[{'$eq':{'ticket.id':"+o.ticketid+"}},{'$is_null':['ticketComment']}]}",_count:o.pageCount,_page:e,_do_count:true,_desc:"id"}}};function l(e){if(s(1).hasOwnProperty(e)){o.currentPage=1;o.filterType=e;p(false)}}function c(e){o.filterType=e}function u(){p(true)}function d(e){if(e.ticketComment&&e.ticketComment.extra){e.ticketComment.extra=JSON.parse(e.ticketComment.extra)}}function f(e){var t={};if(!e.ticketComment){return}if(e.ticketComment.equipment){e.ticketComment.isMobile=true}else{if(e.terminalEquipment){t=e.terminalEquipment;if(t.browser.indexOf("Mobile")>-1){e.ticketComment.isMobile=true;e.ticketComment.equipment=t.browser.split(" ")[0]}else if(t.os.indexOf("Android")>-1){e.ticketComment.isMobile=true;e.ticketComment.equipment=t.os}else{if(t.browser.indexOf("CFNetwork")===-1&&t.browser.indexOf("Unknow")===-1){e.ticketComment.isMobile=false;e.ticketComment.equipment=t.browser.split(" ")[0]}else{e.ticketComment.equipment=null}}if(!e.ticketComment.address){e.ticketComment.address=t.location}}}}o.showNextPageButton=false;function p(n){var a=1;if(n){a=o.currentPage+1}if(n&&angular.isNumber(o._total)&&Math.ceil(o._total/o.pageCount)<a){o.showNextPageButton=false;return false}o.isLoadingTicketContext=true;var e=o.filterType=="all"?"":"&ticketComment=is_not_null";r({url:"api/v1/tickets/"+o.ticketid+"/ticket_log_infos.json?_count="+o.pageCount+"&_page="+a+e,method:"get"}).success(function(e){var e=e.result;o.isLoadingTicketContext=false;if(angular.isArray(e.ticketLogs)&&e.ticketLogs.length&&e.ticketLogs[0].createdAt){e.ticketLogs=_.filter(e.ticketLogs,function(e){if(!e.ticketComment){return true}if(e.ticketComment.type==3&&!(e.ticketComment.attachments||e.ticketComment.content)){return false}return true});angular.forEach(e.ticketLogs,function(e){f(e);d(e)});if(a===1){o.ticketLogs=e.ticketLogs}k();if(n){o.currentPage=a;o.ticketLogs=_.uniq(_.union(o.ticketLogs,e.ticketLogs),false,function(e){return e.id})}o._total=e._total}else if(angular.isArray(e.ticketLogs)&&e.ticketLogs.length===0){o.ticketLogs=[];o.showNextPageButton=false}else if(e.ticketLogs&&e.ticketLogs.length&&!angular.isArray(o.cachedData)){setTimeout(function(){p()},1e3)}if(o.pageCount>e._total||n&&angular.isNumber(o._total)&&Math.ceil(o._total/o.pageCount)<=a){o.showNextPageButton=false}else{o.showNextPageButton=true}o.allReceivedMsg={};var t={};for(var i=0;i<e.ticketLogs.length;i++){var r=e.ticketLogs[i];if(r.ticketComment&&r.ticketComment.uId){o.allReceivedMsg[r.ticketComment.uId]=true}if(r.ticketComment&&r.ticketComment.richTextContent){t[i]=r.ticketComment.richTextContent.id}}if(!angular.equals({},t)){m(t,e.ticketLogs)}}).error(function(){o.isLoadingTicketContext=false})}function m(a,o){var t=[];angular.forEach(a,function(e){t.push(e)});r({url:"/api/v1/ticket_comment/rich_text_content/list.json",method:"get",params:{ids:t}}).success(function(e){if(e.status===0){var t;for(var i in a){for(var r=0;r<e.result.richTextContents.length;r++){var n=e.result.richTextContents[r];if(a[i]===n.id){t=n;break}}o[i].ticketComment.richTextContent=null;void 0;o[i].ticketComment.richTextContent=t}}})}function h(e){r({url:"api/ticket/log/"+e+".json?provider_id="+a.provider.id+"&_token="+getCookie("user_token"),method:"get"}).success(function(t){if(t.status==0){var e=$.grep(o.ticketLogs,function(e){return e.id==t.result.id});if(e.length==0){o.ticketLogs.unshift(t.result)}}else{p()}})}function g(e){i.query({_fields:"id,createdAt,operations,ticketComment,ticketComment.richTextContent,user.type,user.name,user.photo.contentUrl",_filter:"{'$eq':{'id':"+e+"}}",_do_count:false},function(e){if(e.ticketLogs.length&&e.ticketLogs[0].createdAt){o.ticketLogs.unshift(e.ticketLogs[0])}else{}})}function v(e,t){r({url:"api/v1/ticket_comments/"+t+".json",method:"GET"}).success(function(e){var t={};if(e.status==0){var i=e.result;t.ticketComment=i;t.createdAt=i.createdAt;t.user=i.user;d(t);if(o.allReceivedMsg[t.ticketComment.uId]){return}if(o.filterType==="logs"){o.filterType="all";p()}f(t);o.ticketLogs.unshift(t);k()}})}function k(){if(t.$parent.solutionId){o.ticketLogs.forEach(function(e){if(e.ticketComment){if(t.$parent.solutionId===e.ticketComment.id){e.ticketComment.isSolution=true}else{e.ticketComment.isSolution=false}}})}}t.showTerminalDetails=function(t){t.ticketComment.terminalDetails=true;if(!t.ticketComment.hasQuest){var e="/find_by_ticket_log_id/"+t.id+".json";if(!t.id){e="/find_by_ticket_comment_id/"+t.ticketComment.id+".json"}r({url:e,type:"GET"}).success(function(e){if(e.json){t.ticketComment.hasInfo=false;t.ticketComment.browser=e.json.browser;t.ticketComment.ip=e.json.ip;t.ticketComment.os=e.json.os}else{t.ticketComment.hasInfo=true}});t.ticketComment.hasQuest=true}};t.hideTerminalDetails=function(e){e.terminalDetails=false};var y=t.$watch("ticketLog.ticketid",function(){if(o.ticketid!=null&&o.ticketid>0){p()}});t.$watch("$parent.solutionId",function(e,t){if(e!==t){k()}});t.$on("ticket_comment",function(e,t){v(t,t.ticketCommentId)});t.$on("ticket_log",function(e,t){if(o.filterType!=="comments"){h(t.ticketLogId)}});t.$on("scrollLoadTicket",function(){u()});t.$on("$destroy",function(){y()})}})();angular.module("com.ewei.angular.ui").controller("ticketReplyButtonController",["$scope","alertService","ticketReplyButtonStatusService","providerJudgement",function(n,a,e,o){n.isLoding=true;function r(){if(n.ticket){e.run(n.ticket,function(e){n.buttonStatus=e;void 0});n.isLoding=false}}n.submit=function(e,t){if(!o.isTrue()){return false}if(n.uploading||n.isSaving){return false}var i=/\S/;void 0;if(n.comment&&!n.comment.content){if(e.indexOf("get")>-1){n.comment.content="确认接单"}else if(e.indexOf("rob")>-1){n.comment.content="我来处理"}}var r=angular.copy(n.comment.content);if(navigator.userAgent.indexOf("Firefox")!==-1){r=r.replace(/&nbsp;/g," ").replace(/<br>/g," ");void 0}r=r.replace(/&amp;nbsp/g," ");r=r.replace(/^\s*|\s*$/g,"");if(e!=""&&e!=="asSolution"){if(i.test(r)){n.reply({_status:e,onlyComment:t})}else{a.add("不能发送空白消息","danger");return false}}else{if(i.test(r)||n.attachments.length>0){n.reply({_status:e,onlyComment:t})}else if(i.test(r)==false){a.add("不能发送空白消息","danger");return false}}n.status.isopen=false};n.status={isopen:false};n.buttonTitle="";n.setTitle=function(e){if(e){n.buttonTitle="请先输入"}else{n.buttonTitle=""}};n.checkShouldDisabled=function(){if(n.uploading)return true;if(n.attachments.length>0){return false}return false};n.$watch("ticket.status",function(e,t,i){if(e!=t){r()}},true);n.$watch("ticket.engineer",function(e,t,i){if(e!=t){r()}},true);n.$watch("ticket.workflowTemplate",function(e,t,i){if(e!=t){r()}},true);n.$watch("ticket.serviceDesk",function(e,t,i){if(e!=t){r()}},true);n.$watch("activitiWorkflowNodeUid",function(e,t,i){if(e!=t){r()}},true);r()}]).directive("ticketReplyButton",function(){return{restrict:"EA",replace:true,scope:{ticket:"=",open:"=",disabled:"=",uploading:"=",attachments:"=",reply:"&",isSaving:"=",comment:"="},templateUrl:"source/scripts/directives/ticket-reply-button/ticket-reply-button.html",controller:"ticketReplyButtonController"}});(function(y,e){y.module("com.ewei.angular.ui").controller("ticketReviewButtonController",t).directive("ticketReviewButton",i);t.$inject=["$scope","permissions","$modal_","$http","ConsoleConfig","alertService","coreNotifyService","coreModelService","apiTicketEvaluateConfigService"];function t(a,e,t,r,n,o,s,i,l){a.queryBox={};var c="";var u={};var d="";var f="";var p=[{defaultValue:true,name:"通过，关闭工单",value:true},{name:"不通过，发回重新处理",value:false}];var m="审核结果";l.run();function h(){try{}catch(e){void 0}}h();function g(){return r({url:"/api/v1/ticket_evaluate/get/by_ticket_id/"+a.ticket.id+".json",method:"GET"}).success(function(e,t,i,r){if(e.status==0&&e.result){a.evaluate=e.result.evaluate;if(a.evaluate){a.evaluate.solved=a.evaluate.solved?"true":"false"}}v()}).error(function(){v()})}function v(){u=y.copy(i.config.evaluate);if(u){if(!a.evaluate){a.evaluate={solved:null};for(var e=0;e<u.firstQuestionOptions.length;e++){if(typeof u.firstQuestionOptions[e].defaultValue!="undefined"){a.evaluate.solved=u.firstQuestionOptions[e].value;break}}a.evaluate.score=u.secondQuestionDefaultScore;a.evaluate.recommend=u.recommendQuestionDefaultScore;a.evaluate.loyalty=u.loyaltyQuestionDefaultScore}if(a.evaluate&&!a.evaluate.recommend){a.evaluate.recommend=u.recommendQuestionDefaultScore}if(a.evaluate&&!a.evaluate.loyalty){a.evaluate.loyalty=u.loyaltyQuestionDefaultScore}u.thirdQuestionOptions=p;u.thirdQuestionTitle=m}a.queryBox.satisfaction=u}a.reviewTicket=function(e){a.queryBox.inquiryTicketWindow=false;a.queryBox.passTicketWindow=true;a.queryBox.notPassTicketWindow=false;g().then(function(){c=t({scope:a,title:"审核工单",template:"modal/modal.tpl.w600.html",contentTemplate:"source/scripts/directives/ticket-extend-button/ticket-review-button/ask-page.html",html:true,show:true,placement:"center"})});e.stopPropagation()};a.submitFeedback=function(e){if(a.disabled)return;a.disabled=true;var t=feedbackForm;var n=feedbackForm.thirdQuestion.value=="true"?true:false;var i={isReviewPass:n};if(a.queryBox.satisfaction&&a.queryBox.satisfaction.open){i.ticketEvaluate={suggestion:a.evaluate.suggestion||""};i.ticketEvaluate.solved=a.evaluate.solved=feedbackForm.firstQuestion.value;i.ticketEvaluate.score=a.evaluate.score;if(a.queryBox.satisfaction.loyaltyQuestionOpen){i.ticketEvaluate.loyalty=a.evaluate.loyalty}if(a.queryBox.satisfaction.recommendQuestionOpen){i.ticketEvaluate.recommend=a.evaluate.recommend}}r({url:"/api/v1/ticket/"+a.ticket.id+"/review.json",method:"POST",data:i}).success(function(e,t,i,r){if(e.status==0){k(feedbackForm,n,e.id);if(n){o.add("工单#"+a.ticket.no+"审核通过","success")}}else{o.add(e.result.error_description,"danger")}a.disabled=false;c.$promise.then(c.hide)}).error(function(e,t,i,r){a.disabled=false;c.$promise.then(c.hide)});e.stopPropagation()};function k(e,t,i){var r=t?"closed":"open";if(r=="closed"){a.ticket.ticketMetric.closedAt=(new Date).format("yyyy-MM-dd hh:mm:ss")}else{if(a.ticket.engineer&&a.ticket.engineer.id==n.engineer.id){r="open"}else{r="assigned"}}if(r!=null){a.ticket.status=r;if(a.ticket.workflowTemplate!=undefined&&r!="closed"){s.doNotify(s.constant.EVENT_TICKET_WORKFLOWS)}}a.isSavingComment=false;a.cacheFiles=[]}}function i(){return{restrict:"EA",replace:true,scope:false,templateUrl:"source/scripts/directives/ticket-extend-button/ticket-review-button/ticket-review-button.html",controller:"ticketReviewButtonController"}}})(angular,org.ewei);(function(){angular.module("com.ewei.angular.ui").controller("ticketResetButtonController",e).directive("ticketResetButton",t);e.$inject=["$timeout","$scope","permissions","$modal_","$http","ConsoleConfig","alertService","coreNotifyService","commonTools","attachmentService"];function e(e,a,t,r,o,s,l,i,n,c){var u;a.resetTicket=function(e){a.data.open=true;a.data.attachments=[];a.data.content="";a.cacheFiles=[];a.stopUpload=false;u=r({scope:a,title:"重置工单",template:"modal/modal.tpl.w600.html",contentTemplate:"source/scripts/directives/ticket-extend-button/ticket-reset-button/ticket-reset-dialog.html",show:true,placement:"center",hideCallback:function(){a.stopUpload=true}});e.stopPropagation()};a.filesAdded=function(e,t){plupload.each(t,function(e){e.uploading=true;e.progress=0;a.uploading=true;a.cacheFiles.push(e)})};a.uploadProgress=function(e,t){t.progress=e.total.percent;n.safeApply(a);void 0;if(a.stopUpload){e.stop()}};a.fileUploaded=function(e,n,t){n.progress=100;o({url:"save_attachment.json",method:"POST",params:{fileName:n.name,contentType:n.type,contentUrl:JSON.parse(t).key,size:n.size}}).success(function(e,t,i,r){if(e.json){n.uploading=false;n.result=e.json;n.result.isLocalFile=true;d(e.json);a.uploading=false}else{void 0;a.uploading=false}})};a.uploadError=function(e,t,i){a.uploading=false;if(t.code===-600){l.add("上传文件不能大于50M。","danger");e.stop()}};a.uploadComplete=function(){};var d=function(e){var t=angular.fromJson(e);a.data.attachments.push({id:t.id,fileName:t.fileName,contentUrl:t.contentUrl,size:t.size,contentType:t.contentType})};a.removeCacheFile=function(i){a.uploading=false;if(!i.result){if(i.ext){a.$broadcast("deleteUploadingFile",i);a.cacheFiles.splice(a.cacheFiles.indexOf(i),1);return false}else{a.$broadcast("stopUploadingFile",i);a.cacheFiles.splice(a.cacheFiles.indexOf(i),1);return false}}var r=angular.fromJson(i.result);if(r.isLocalFile){c.remove({id:r.contentUrl},function(e){for(var t=0;t<a.data.attachments.length;t++){if(a.data.attachments[t].id===r.id){a.data.attachments.splice(t,1);break}}a.cacheFiles.splice(a.cacheFiles.indexOf(i),1)})}else{for(var e=0;e<a.data.attachments.length;e++){if(a.data.attachments[e].id===r.id){a.data.attachments.splice(e,1);break}}a.cacheFiles.splice(a.cacheFiles.indexOf(i),1)}};a.setReplyOpenType=function(){a.data.open=!a.data.open};a.data={content:"",uId:eweiCommon.uuid(32),ticket:{id:a.ticket.id},user:{id:s.user.id},attachments:[],open:true};a.submitReset=function(e){if(a.disabled||!a.data.content)return;a.disabled=true;o({url:"/api/v1/ticket_comment/reply_to_reset.json",method:"POST",data:a.data}).success(function(e,t,i,r){if(e.status===0){if(a.ticket.engineer&&a.ticket.engineer.id===s.engineer.id){a.ticket.status="open"}else{a.ticket.status="assigned"}l.add("工单#"+a.ticket.no+"已重置","success");var n={createdAt:(new Date).format("yyyy-MM-dd hh:mm:ss"),user:s.user};n.ticketComment=angular.copy(a.data);n.user.type="engineer";a.data.uId=eweiCommon.uuid(32)}else if(e.result&&e.result.error){l.add(e.result.error_description,"danger")}a.disabled=false;u.hide();a.data.uId=eweiCommon.uuid(32)}).error(function(e,t,i,r){a.disabled=false;u.hide()})};a.showNoResource=true;a.catalogCollapse=function(e){e.collapse=!e.collapse};a.addResource=function(){m();$rootScope.helpcenterCommunityAccessSelectTab="resource";$state.go("community")};var f=false;a.selectResource=function(i){if(f)return;f=true;m();e(function(){a.cacheFiles.forEach(function(e,t){if(e.name===i.name){a.cacheFiles.splice(t,1)}});a.data.attachments.forEach(function(e,t){if(e.fileName===i.name){a.data.attachments.splice(t,1)}});i.attachment.isLocalFile=false;a.cacheFiles.push({name:i.name,size:i.attachment.size,result:i.attachment,isAbort:false,progress:100});d(i.attachment);f=false},500)};var p=null;a.pickResource=function(){var e="source/views/ticket/ticket_pickup_resource.html";o.get("helpResourcesCatalog_all.json",{params:{_count:999,_do_count:true}}).success(function(e){a.catalogs=e.helpResourcesCatologs;if(a.catalogs.length>0){a.showNoResource=false}o.get("helpResources_all.json",{params:{_count:999,_do_count:true}}).success(function(t){a.total=t._total;a.helpResources=t.helpResources;angular.forEach(a.catalogs,function(i,e){i.resources=[];angular.forEach(t.helpResources,function(e,t){if(e.catalog.id===i.id){i.resources.push(e)}});if(i.resources.length>0){i.collapse=false}else{i.collapse=true}});i()})});var i=function(){p=r({scope:a,title:"选取社区帮助中心的下载资源",contentTemplate:e,html:true,show:true,placement:"center"})}};var m=function(){p.$promise.then(p.hide)}}function t(){return{restrict:"EA",replace:true,scope:false,templateUrl:"source/scripts/directives/ticket-extend-button/ticket-reset-button/ticket-reset-button.html",controller:"ticketResetButtonController"}}})(angular);(function(){angular.module("com.ewei.angular.ui").controller("ticketCreateProjectController",e).directive("ticketCreateProjectButton",t);e.$inject=["$state","$scope","permissions","$modal_","sortOrder","alertService","coreNotifyService","providerJudgement","apiProjectClassifyListService","apiRestfulService","$rootScope"];function e(r,n,e,t,i,a,o,s,l,c,u){var d;var f=vm.__proto__.constructor.name+"_"+(new Date).valueOf();n.items=i.fn(true);n.sortItems=i.fn();n.project={name:n.ticket.subject,describe:""};n.createSubject=function(e){if(!s.isTrue()){return false}d=t({scope:n,title:"生成项目",contentTemplate:"source/scripts/directives/ticket-extend-button/ticket-create-project-button/ticket-create-project-dialog.html",template:"modal/modal.tpl.w500.html",html:true,show:true,placement:"center"})};n.makeSureCreate=function(){if(!n.project.name){a.add("请输入项目名称","danger");return false}else if(!n.project.describe){a.add("请输入项目描述","danger");return false}else if(!n.project.choseSort){a.add("请选择分类","danger");return false}var e="";for(var t=0;t<n.project.choseSort.projectPhases.length;t++){if(n.project.choseSort.projectPhases[t].position===1){e=n.project.choseSort.projectPhases[t].id}}var i={url:"api/v1/projects",urlParam:"",dataParam:{content:n.project.describe,currentPhase:{id:e},name:n.project.name,projectCategory:{id:n.project.choseSort.id}}};c.run(i).post(i.dataParam,function(t){if(t.status!==0){a.add("创建项目失败","danger")}else{c.run({url:"/api/v1/projects/"+t.result.id+"/tickets/"+n.ticket.id,urlParam:{bindType:"id"}}).post(null,function(e){if(e.status===0){a.add("项目已关联工单#"+e.result.ticket.no+"！");u.$broadcast("sendTimeLineLogs",{log:e.result.log});r.go("project_detail",{categoryid:n.project.choseSort.id,id:t.result.id})}else{a.add("与项目关联失败！","danger")}});d.hide()}})};function p(){m();var e={_fields:"",_page:1,_count:0,createdAtBegin:"",createdAtEnd:""};l.run("list.projectClassifyList",o.constant.EVENT_PROJECT_CLASSIFY_LIST,e._page,"",e,function(e){})}function m(){o.register(f,o.constant.EVENT_PROJECT_CLASSIFY_LIST,function(e,t){n.items=i.fn(true);n.sortItems=i.fn()})}p();function h(){o.unRegister(f)}n.$on("$destroy",function(){h()})}function t(){return{restrict:"EA",replace:true,scope:true,templateUrl:"source/scripts/directives/ticket-extend-button/ticket-create-project-button/ticket-create-project-button.html",controller:"ticketCreateProjectController"}}})(angular);(function(u,e){u.module("com.ewei.angular.ui").controller("ticketAppendLogButtonController",t).directive("ticketAppendLogButton",i);t.$inject=["$scope","permissions","$modal_","$http","ConsoleConfig","alertService","coreNotifyService","commonTools","attachmentService"];function t(t,e,i,r,n,a,o,s,l){var c;t.appendLog=function(e){t.data.open=false;t.data.attachments=[];t.data.content="";t.cacheFiles=[];t.stopUpload=false;c=i({scope:t,title:"追加回复",template:"modal/modal.tpl.w600.html",contentTemplate:"source/scripts/directives/ticket-extend-button/ticket-append-log-button/ticket-append-log-dialog.html",show:true,placement:"center",hideCallback:function(){t.stopUpload=true}});e.stopPropagation()};t.submitLog=function(e){if(t.disabled||!t.data.content)return;t.disabled=true;t.$parent.newComment=u.copy(t.data);t.reply("",null,null,true);t.disabled=false;c.hide();t.data.uId=eweiCommon.uuid(32)}}function i(){return{restrict:"EA",replace:true,scope:false,templateUrl:"source/scripts/directives/ticket-extend-button/ticket-append-log-button/ticket-append-log-button.html",controller:"ticketAppendLogButtonController"}}})(angular,org.ewei);(function(u,d){u.module("com.ewei.angular.ui").controller("ticketCreateSolutionButtonController",e).directive("ticketCreateSolutionButton",t);e.$inject=["$scope","permissions","$modal_","$http","ConsoleConfig","alertService","coreNotifyService","commonTools","attachmentService"];function e(i,e,t,r,n,a,o,s,l){var c;i.createSolution=function(e){i.data.open=false;i.data.attachments=[];i.data.content="";i.cacheFiles=[];i.stopUpload=false;c=t({scope:i,title:"解决方案",template:"modal/modal.tpl.w600.html",contentTemplate:"source/scripts/directives/ticket-extend-button/ticket-create-solution-button/ticket-create-solution-dialog.html",show:true,placement:"center",hideCallback:function(){i.stopUpload=true}});e.stopPropagation()};i.submitSolution=function(e){if(i.disabled||!i.data.content)return;i.disabled=true;var t={createdAt:(new Date).format("yyyy-MM-dd hh:mm:ss"),user:n.user};t.ticketComment=u.copy(i.data);t.user.type="engineer";i.allReceivedMsg[t.ticketComment.uId]=true;d.sdk.OpenTicketCommentApi().saveTicketCommentAsSolution({ticketComment:i.data}).then({success:function(e){i.ticketLogs.forEach(function(e){e.ticketComment&&(e.ticketComment.isSolution=false)});t.ticketComment.id=i.solutionId=e;t.ticketComment.isSolution=true;i.disabled=false;c.hide();i.ticketLogs.unshift(t);i.data.uId=eweiCommon.uuid(32)},fail:function(e){i.disabled=false;c.hide()}})}}function t(){return{restrict:"EA",replace:true,scope:false,templateUrl:"source/scripts/directives/ticket-extend-button/ticket-create-solution-button/ticket-create-solution-button.html",controller:"ticketCreateSolutionButtonController"}}})(angular,org.ewei);angular.module("com.ewei.angular.ui").controller("ticketToolBarController",["$scope","$rootScope","attachmentService","$upload","$timeout","alertService","$http","commonTools","$modal_","$state",function(a,e,n,t,o,r,s,l,c,i){if(a.attachments==null){a.attachments=[]}a.showNoResource=true;a.catalogCollapse=function(e){e.collapse=!e.collapse};a.addResource=function(){f();e.helpcenterCommunityAccessSelectTab="resource";i.go("community")};var u=false;a.selectResource=function(i){if(u)return;u=true;f();o(function(){a.$parent.cacheFiles.forEach(function(e,t){if(e.name===i.name){a.$parent.cacheFiles.splice(t,1)}});a.attachments.forEach(function(e,t){if(e.fileName===i.name){a.attachments.splice(t,1)}});i.attachment.isLocalFile=false;a.$parent.cacheFiles.push({name:i.name,size:i.attachment.size,result:i.attachment,isAbort:false,progress:100});p(i.attachment);u=false},500)};var d=null;a.uploadAttachmentBuried=function(){_hmt.push(["_trackEvent","工单工具","上传附件"])};a.uploadLocationBuried=function(){_hmt.push(["_trackEvent","工单工具","上传本地文件"])};a.pickResource=function(){_hmt.push(["_trackEvent","工单工具","调用社区资源"]);var e="source/views/ticket/ticket_pickup_resource.html";s.get("helpResourcesCatalog_all.json",{params:{_count:999,_do_count:true}}).success(function(e){a.catalogs=e.helpResourcesCatologs;if(a.catalogs.length>0){a.showNoResource=false}s.get("helpResources_all.json",{params:{_count:999,_do_count:true}}).success(function(t){a.total=t._total;a.helpResources=t.helpResources;angular.forEach(a.catalogs,function(i,e){i.resources=[];angular.forEach(t.helpResources,function(e,t){if(e.catalog.id==i.id){i.resources.push(e)}});if(i.resources.length>0){i.collapse=false}else{i.collapse=true}});i()})});var i=function(){d=c({scope:a,title:"选取社区帮助中心的下载资源",contentTemplate:e,html:true,show:true,placement:"center"})}};var f=function(){d.$promise.then(d.hide)};a.cacheFiles=[];a.uploading=false;eweiUpload(function(e,t){plupload.each(t,function(e){e.uploading=true;e.progress=0;a.cacheFiles.push(e)});l.safeApply(a)},function(e,t){void 0;if(t.size>52428800){void 0;e.stop()}},function(e,t){var i=e.total.percent;a.$emit("uploading",true);t.progress=i;l.safeApply(a);void 0},function(e,n,t){n.progress=100;s({url:"save_attachment.json",method:"POST",params:{fileName:n.name,contentType:n.type,contentUrl:JSON.parse(t).key,size:n.size}}).success(function(e,t,i,r){if(e.json){o(function(){n.uploading=false;a.$emit("uploading",false);n.result=e.json;n.result.isLocalFile=true;p(e.json);l.safeApply(a);void 0})}else{void 0}})},function(e,t,i){a.$emit("uploading",false);if(t.code==-600){r.add("上传文件不能大于50M。","danger");e.stop()}},function(){a.$emit("uploading",false)});a.requestScreenshot=function(){_hmt.push(["_trackEvent","工单工具","屏幕截图"]);var e={type:"ticket",id:a.ticket.id,status:a.ticket.status,open:a.open};a.$emit("requestScreenshot",e)};a.requestVideo=function(){_hmt.push(["_trackEvent","工单工具","屏幕录像"]);var e={type:"ticket",id:a.ticket.id,status:a.ticket.status,open:a.open};a.$emit("requestVideo",e)};e.$on("uploadedTicketAttachment",function(e,t){p(t.file);l.safeApply(a);a.cacheFiles.push({name:t.file.fileName,size:t.file.size,result:angular.toJson({id:t.file.id,fileName:t.file.fileName,contentUrl:t.file.contentUrl,isLocalFile:true}),isAbort:false,progress:100})});var p=function(e){var t=angular.fromJson(e);a.attachments.push({id:t.id,fileName:t.fileName,contentUrl:t.contentUrl,size:t.fileSize,contentType:t.contentType})};a.deleteAttachment=function(e,i){var r=angular.fromJson(e);if(confirm("删除文件 "+r.fileName+" ？")){if(r.isLocalFile){n.remove({id:r.contentUrl},function(e){for(var t=0;t<a.attachments.length;t++){if(a.attachments[t].id==r.id){a.attachments.splice(t,1);break}}a.cacheFiles.splice(i,1)})}else{for(var t=0;t<a.attachments.length;t++){if(a.attachments[t].id==r.id){a.attachments.splice(t,1);break}}a.cacheFiles.splice(i,1)}}}}]).directive("ticketToolBar",function(){return{restrict:"EA",scope:{attachments:"=",cacheFiles:"=",ticket:"=",open:"="},templateUrl:"/source/scripts/directives/ticket-tool-bar/ticket-tool-bar.html",controller:"ticketToolBarController"}}).directive("eweiTicketStatusImg",["$compile","ticketStatusColorService",function(f,a){return{restrict:"E",replace:false,scope:{ticketstatuscolors:"=",ticketid:"@",status:"=",format:"@",ticketdetail:"@",deleted:"="},template:"",link:function(l,c,u){l.showSlaStatus=function(){l.showSla=true};l.hideSlaStatus=function(){l.showSla=false};var d=function(e){var t=e%60;var i=Math.floor(e/1440);var r=Math.floor(e%1440/60);var n="";t=t>0?t:0;r=r>0?r:0;i=i>0?i:0;if(i>0){n+=i+"天"}if(r>0){n+=r+"小时"}if(t>0){n+=t+"分钟"}if(n==""){n="0分钟"}return n};var e=function(){if(angular.isDefined(l.ticketstatuscolors)&&l.ticketstatuscolors!=null){var e={};if(angular.isDefined(l.ticketstatuscolors[l.ticketid])){e=l.ticketstatuscolors[l.ticketid]}var t="",i="";i=l.format=="short"?l.status.toUpperCase().substr(0,1):l.status.toUpperCase();t=l.status;if(l.deleted){i=l.format=="short"?"D":"Deleted";t="deleted"}var r='<span ng-mouseenter="showSlaStatus();" ng-mouseleave="hideSlaStatus();" class="'+t+' ticket-sla" style="cursor:pointer;">'+i+"</span>";if(e.solveLevel||e.responseLevel){var n="40px";if(e.solveLevel&&e.responseLevel){n="60px"}var a="position: relative;top: -"+n+";left: -20px;background-color:#fff;";if(angular.isString(u.slaStyle)){a=u.slaStyle}r+='<div style="'+a+'" ng-show="showSla">';if(e.responseLevel){var o="";switch(e.responseLevel){case 1:o="#66CC00";break;case 2:o="#FF9900";break;case 3:o="#FF0000";break}r+='<p class="text-nowrap" style="color:'+o+';">响应耗时：'+d(e.responseMinutes)+"，SLA指标："+d(e.planResponseMinutes)+"</p>"}if(e.solveLevel){var s="";switch(e.solveLevel){case 1:s="#66CC00";break;case 2:s="#FF9900";break;case 3:s="#FF0000";break}r+='<p class="text-nowrap" style="color:'+s+';">处理耗时：'+d(e.solveMinutes)+"，SLA指标："+d(e.planSolveMinutes)+"</p>"}r+="</div>"}else{r+='<div style="position: absolute;top: 33px;left: 10px;background-color: #fff;white-space: nowrap;z-index: 1;"  ng-show="showSla">未匹配到SLA</div>'}c.html("").append(f(r)(l))}else{c.html("")}};var t=l.$watch("ticketstatuscolors",function(){e()});l.$watch("status",function(){e()});l.$watch("deleted",function(){e()});var i=function(e){a.run("",{ticketIds:e},true,function(e){if(e.success){l.ticketstatuscolors=e.json}else{}})};var r=l.$watch("status",function(e,t){if(e!=t&&l.ticketdetail!=undefined&&t!=undefined){i(l.ticketid)}});if(l.ticketdetail!=undefined){i(l.ticketid)}var n=l.$on("ticket_sla_update",function(e,t){i(t.ticketId)});l.$on("$destroy",function(){t();r();n()})}}}]);angular.module("com.ewei.angular.ui").controller("attachmentDetailIemController",["$rootScope","$scope","attachmentService","$http","$location","$sce","EweiConfig",function(e,t,i,r,n,a,o){t.timeNow=(new Date).toString();t.domain=n.host();var s=function(e){t.isImage=e=="image"?true:false;t.isAudio=e=="audio"?true:false;t.isVideo=e=="video"?true:false;t.isKnowledge=e=="knowledge"?true:false;t.isOther=e=="other"?true:false;t.isMap=e=="map"?true:false};this.setType=s;t.viewImage=function(){window.open("/no_auth_ewei_attachment?contentUrl="+t.attachment.contentUrl,"_blank","toolbar=0,location=no,menubar=0,modal=yes,alwaysRaised=yes")};t.saveAsImage=function(e){window.open("/no_auth_ewei_attachment?contentUrl="+t.attachment.contentUrl+"&attname="+encodeURIComponent(t.attachment.fileName))};t.errorAudio=function(e){};if(t.questionId&&t.questionId>0){s("knowledge");r({url:"question/"+t.questionId+".json",method:"GET"}).success(function(e){t.question=e.json;if(!t.question.summary){if(t.question.remark){t.question.summary=t.question.remark.replace(/<\/?[^>]*>/g,"")}else if(t.question.articleBody){t.question.summary=t.question.articleBody.replace(/<\/?[^>]*>/g,"")}}}).error(function(){})}else{t.file=t.attachment;var l=t.attachment.contentType;if(l=="image/jpeg"||l=="image/gif"||l=="image/png"){if(t.allFile==="yes"){s("other")}else if(t.maptype==5||t.log&&t.log.type==="location"){s("map")}else if(t.attachment.size>=8388608){s("other")}else{s("image")}}else if(l=="audio/amr"||l=="audio/mp3"||l=="audio/mpeg"||l=="audio"){s("audio")}else if(l=="video/mp4"||l=="video/mpeg4"||l=="video/ogg"||l=="video/webm"||l=="video/x-sgi-movie"||l=="video/x-ms-wm"){s("video")}else{s("other")}if(t.transit=="true"){if(t.isImage){t.url="/ewei_attachment?contentUrl="+t.attachment.contentUrl+"-log.200"}else if(t.isAudio){t.url="/ewei_attachment?contentUrl="+t.attachment.contentUrl;+".mp3"}else if(t.isOther){t.url="/ewei_attachment?contentUrl="+t.attachment.contentUrl+"&fileName="+encodeURIComponent(t.attachment.fileName)}else{t.url="/ewei_attachment?contentUrl="+t.attachment.contentUrl}}else{if(t.isImage){t.url="/ewei_attachment?contentUrl="+t.attachment.contentUrl+"-log.200"}else if(t.isMap){if(t.log&&t.log.type==="location"){t.url="/ewei_attachment?contentUrl="+t.attachment.contentUrl+"-log.200";t.location=t.log.msgLatitude+","+t.log.msgLongitude;t.addr=t.log.msgAddress}else{t.url="/ewei_attachment?contentUrl="+t.attachment.contentUrl+"-log.200";var c=t.mapcontent.split(",");t.location=c[0]+","+c[1];t.addr=c[2]}}else if(t.isOther){t.url="/ewei_attachment?contentUrl="+t.attachment.contentUrl+"&fileName="+encodeURIComponent(t.attachment.fileName);var u=l.split("/")[1];if(l.indexOf("image")!==-1){if(u==="x-icon"){if(t.attachment.fileName.indexOf(".ico")===-1){t.url+=".ico"}}else if(u==="photoshop"){if(t.attachment.fileName.indexOf(".psd")===-1){t.url+=".psd"}}else{t.url+="."+u}}}else if(t.isAudio&&l=="audio/amr"){t.url="/ewei_attachment?contentUrl="+t.attachment.contentUrl+".mp3"}else{t.url="/ewei_attachment?contentUrl="+t.attachment.contentUrl}}}}]).controller("attachmentController",["$scope",function(e){}]).directive("attachmentDetail",function(){return{restrict:"EA",scope:{attachments:"@",content:"@",transit:"@",richText:"@"},templateUrl:"/source/scripts/directives/attachment-detail/attachment-detail.html",controller:"attachmentController"}}).directive("attachmentDetailItem",function(){return{restrict:"EA",scope:{attachmentid:"@",attachment:"=",maptype:"@",mapcontent:"@",transit:"@",questionId:"@",useScroll:"@",log:"=",sendStatus:"@"},link:function(e,t,i,r){e.allFile=i.allFile;if(e.log&&e.log.createdAt&&e.log.phoneHangUpAt){var n=new Date(e.log.createdAt.replace(" ","T"));var a=new Date(e.log.phoneHangUpAt.replace(" ","T"));var o=a-n;e.log.time=parseInt(o/1e3)}},templateUrl:"/source/scripts/directives/attachment-detail/attachment-detail-item.html",controller:"attachmentDetailIemController"}});(function(y){"use strict";y.module("com.ewei.angular.ui").controller("userGroupSelectController",e).directive("userGroupSelect",t);e.$inject=["$scope","$http","$q","$modal_","userGroupService","alertService","$filter","chatDetailService","$state","groupUserTicketChainService","permissions"];function e(n,i,a,r,o,s,l,e,t,c,u){var d=n.$watch("selectedusergroup",function(){if(n.selectedusergroup!=null&&typeof n.selectedusergroup=="object"){n.userGroupName=n.selectedusergroup.name}else if(n.selectedusergroup!=null&&(typeof n.selectedusergroup=="string"||typeof n.selectedusergroup=="number")){i({url:"user_group/"+n.selectedusergroup+".json",method:"GET",params:{}}).success(function(e,t,i,r){if(e.success){n.userGroupName=e.json.name}})}else if(!n.selectedusergroup){n.userGroupName=null}});var f=1,p=20,m=true,h;function g(){n.userGroups=[];f=1;m=true}n.loadUserGroups=function(e){if(e!=h){g();h=e}if(m){var t={page:{pageSize:p,pageNumber:f++},key:e};var i=a.defer();var r=n.withoutAccessScope?"listAllUserGroup":"listUserGroup";org.ewei.sdk.OpenUserGroupApi()[r](t).then(function(e){m=e.list.length==p;if(!n.userGroups||n.userGroups.length==0){n.userGroups=e.list;if(n.allUserGroup){n.userGroups.unshift({id:0,name:"所有客户组"})}else{n.userGroups.unshift({id:-1,name:"-"})}if(u.hasPermission("customer_group_create")){if(!n.unableAddUsergroup){n.userGroups.unshift({id:-2,name:"+ 添加客户分组"})}}}else{n.userGroups=n.userGroups.concat(e.list)}i.resolve(n.userGroups)},i.reject);return i.promise}else{return n.userGroups}};n.loadMore=function(){n.$broadcast("typeahead-reload",n.userGroupName)};n.clear=function(e,t){if(!t||t&&t===n.componentId){n.selectedusergroup=null;n.userGroupName=null}};n.$on("reset-data-source",g);n.onFocus=function(){n.userGroupName=""};n.onBlur=function(){if(n.selectedusergroup!=null){n.userGroupName=n.selectedusergroup.name}else{n.userGroupName=""}};var v=function(e,t){if(!n.customer)return;i({url:"update_user_group.json",method:"POST",data:{id:n.customer.id,userGroupId:e<=0?null:e,shared:t}}).success(function(e,t,i,r){if(e.success){}else{if(e.message!=null){s.add(l("translate")(e.message),"danger")}else{s.add("更新失败","danger")}}})};n.onSelect=function(e,t,i,r){k(e)};var k=function(t){if(t.id===-2&&u.hasPermission("customer_group_create")){n.hideModal=function(){e.$promise.then(e.hide)};i.get("get_external_url_authorize.json").success(function(e){if(e.success&&e.json){n.externalUrlAuthorize=e.json}});n.flag_showMoreOptions=false;n.showMoreOptions=function(){n.flag_showMoreOptions=true};n.newUserGroup={name:n.key,shared:false,userGroupCustomFields:[]};n.groupField={};n.$save=function(){var e=n.groupField.userGroupCustomFields;if(e){for(var t=0;t<e.length;t++){if(e[t].customField.regexpForValidation&&e[t].value){var i=new RegExp(e[t].customField.regexpForValidation);if(!i.test(e[t].value)){s.add("请输入正确的"+e[t].customField.title,"danger");e[t].value="";return}}else if(e[t].customField&&e[t].customField.required&&(!e[t].value||e[t].value=="-")){s.add(e[t].customField.title+"不能为空","danger");return}}}y.forEach(n.groupField.userGroupCustomFields,function(e){var t={value:e.value,customField:{id:e.customField.id}};n.newUserGroup.userGroupCustomFields.push(t)});o.add(n.newUserGroup,function(e){if(e.success){n.hideModal();n.selectedusergroup={id:e.id,name:n.newUserGroup.name,shared:n.newUserGroup.shared};n.userGroupName=n.selectedusergroup.name;if(n.customer){n.customer.shared=n.selectedusergroup.shared}n.newUserGroup.id=e.id;c.setUserGroup(n.newUserGroup);v(e.id,n.newUserGroup.shared)}else{if(e.message!=null){s.add(l("translate")(e.message),"danger")}else{s.add("保存失败","danger")}}})};var e=r({scope:n,title:"新建客户分组",contentTemplate:"source/views/customer/user_group_add.html",html:true,show:true,placement:"top"})}else{n.oldSelectedusergroup=y.copy(n.selectedusergroup);if(t.id===-1&&u.hasPermission("customer_group_create")){n.targetusergroup=null}else{if(t.id===-1&&!u.hasPermission("customer_group_create")){n.targetusergroup=null}else{n.targetusergroup=t}}if(n.useredit=="true"||n.useredit==true){if(u.hasPermission("customer_group_create")&&(t.id!==-1||n.selectedusergroup!=null)||!u.hasPermission("customer_group_create")&&(t.id!==-1||n.selectedusergroup!=null)){var e=r({scope:n,title:"更换客户分组",contentTemplate:"source/scripts/directives/user-group-select/user-group-confirm.html",html:true,show:true,placement:"center"});n.hideModal=function(){e.$promise.then(e.hide)};n.cancel=function(){n.selectedusergroup=y.copy(n.oldSelectedusergroup)};n.$ok=function(){n.hideModal();n.selectedusergroup=n.targetusergroup;if(n.selectedusergroup){n.userGroupName=n.selectedusergroup.name}else{n.userGroupName=""}function e(e){if(u.hasPermission("customer_group_create")&&e.id===-1||!u.hasPermission("customer_group_create")&&e.id===-1){n.selectedusergroup=null;n.userGroupName=null;c.setUserGroup(undefined);v(null,null)}else{n.selectedusergroup=n.targetusergroup;if(n.customer){n.userGroupName=n.selectedusergroup.name;n.customer.shared=n.selectedusergroup.shared;c.setUserGroup(n.selectedusergroup);v(n.selectedusergroup.id,n.selectedusergroup.shared)}}}setTimeout(e(t),1e3)}}}else{n.selectedusergroup=n.targetusergroup;if(n.selectedusergroup){n.userGroupName=n.selectedusergroup.name}else{n.userGroupName=""}}}};n.$on("$destroy",function(){d()})}t.$inject=[];function t(){return{restrict:"EA",replace:true,templateUrl:"/source/scripts/directives/user-group-select/user-group-select.html",controller:"userGroupSelectController",scope:{selectedusergroup:"=",customer:"=",useredit:"=",unableAddUsergroup:"=",allUserGroup:"=",canClear:"=",withoutAccessScope:"="}}}})(angular);angular.module("com.ewei.angular.ui").controller("userGroupMutilSelect",["$scope","$http","alertService","apiRestfulService","ConsoleConfig",function(n,i,e,t,r){var a;var o=40;n.loadTags=function(e){var t="user_group_list.json?_count="+o+'&_do_count=1&_page=1&_desc=createdAt&_fields=id,name,shared&_asc=name&_filter={"$like":{"name":"$'+e+'$"}}';return i.get(t).then(function(e){if(e.data&&e.data.userGroups){a=e.data.userGroups;return a?a:[]}})};n.tagAdded=function(e){n.usergroups=n.usergroups||[];var t;if(!angular.isArray(n.usergroups)){var i;i=(n.usergroups+"").split(",");n.usergroups=[];angular.forEach(i,function(e){n.usergroups.push(parseInt(e))})}if(n.hasName){t=e}else{t=e.id}n.usergroups.push(t)};n.tagRemoved=function(e){if(!angular.isArray(n.usergroups)){n.usergroups=[]}else{if(n.hasName){n.usergroups.splice(n.usergroups.indexOf(e),1)}else{n.usergroups.splice(n.usergroups.indexOf(e.id),1)}}};n.validateTag=function(e){if(!e.id){return false}};function s(){if(n.usergroups){try{if(!angular.isArray(n.usergroups)){n.usergroups=JSON.parse(n.usergroups)}}catch(e){void 0}var e="";var t=angular.copy(n.usergroups);if(angular.isArray(t)){if(n.hasName){n.tags=t}else{e=t.join(",");l(e)}}else{if(angular.isNumber(t)){e=t+""}l(e)}}}s();function l(e){var t="/api/v1/user_groups/show_many.json?_token="+getCookie("user_token")+"&provider_id="+r.provider.id+"&_fields=id,name"+"&ids="+e;i.get(t).success(function(e,t,i,r){if(e&&e.result&&e.result.userGroups){n.tags=e.result.userGroups}})}}]).directive("userGroupMutilSelect",[function(){return{restrict:"EA",templateUrl:"/source/scripts/directives/user-group-mutil-select/user-group-mutil-select.html",controller:"userGroupMutilSelect",scope:{usergroups:"=",hasName:"="}}}]);angular.module("com.ewei.angular.ui").controller("ticketLogShowController",["$scope",function(e){if(e.log&&e.log.operations&&e.log.operations.length>0){angular.forEach(e.log.operations,function(e){if(e.type&&e.type.indexOf("TYPE_TICKET_UPDATE_CUSTOMFIELD")>-1){e.type=e.type.split(":")[1]}})}}]).directive("ticketLogShow",[function(){return{restrict:"EA",replace:true,templateUrl:"/source/scripts/directives/ticket-log-show/ticket-log-show.html",controller:"ticketLogShowController",scope:{log:"="}}}]);angular.module("com.ewei.angular.ui").directive("ticketSlaTipBar",["automationService",function(t){return{restrict:"A",replace:false,scope:{sla:"=",type:"@"},template:"",link:function(s,l,e){s.$watch("sla",function(){if(s.sla){var o="系统";if(s.sla.operator!=null){o=s.sla.operator.name}if(s.type=="solved"){t.get({type:"ticket"},function(e){if(e.success&&e.json){var t=e.json;var i;if(t.tempValue){i=t.tempValue*60*60*1e3}else{i=4*24*60*60*1e3}var r="";var n="";if(s.sla){r=s.sla.operatedAt?new Date(Date.parse(s.sla.operatedAt.replace(/-/g,"/"))+i):"";n=s.sla.operatedAt?new Date(Date.parse(s.sla.operatedAt.replace(/-/g,"/"))):""}var a=o+" 处理完毕于 "+n.toLocaleString()+"，评价问卷已发送给客户。";if(t.active){a+="如无变更，系统将于 "+r.toLocaleString()+" 左右自动关闭此工单。"}l.html(a)}})}else if(s.type=="pending"){var e=new Date(Date.parse(s.sla.operatedAt.replace(/-/g,"/")));l.html(o+" 暂停此工单，于 "+e.toLocaleString()+"。")}else{var e=new Date(Date.parse(s.sla.operatedAt.replace(/-/g,"/")));l.html("\x3c!-- scope.type="+s.type+", sla.operator.name="+o+", sla.operatedAt="+e.toLocaleString()+"--\x3e")}}})}}}]).directive("maxTicketSlaOperatedAt",["$filter",function(o){return{restrict:"A",replace:false,scope:{slas:"=",type:"@"},template:"",link:function(e,t,i){var r;if(e.slas){for(var n=0;n<e.slas.length;n++){var a=e.slas[n];if(a.type==e.type){if(e.type=="solved"){if(r==null||a.operatedAt>r){r=a.operatedAt}}else if(e.type=="pending"){if(r==null||a.operatedAt>r){r=a.operatedAt}}t.html(o("dateFilter_style1")(r))}}}else{t.html("-")}}}}]);angular.module("com.ewei.angular.ui").controller("imageShowController",["$rootScope","$scope","EweiConfig",function(i,r,n){var e=function(){var e=/^http[s]?:\/\/([\w-]+\.)+[\w-]+([\w-./?%&=]*)?$/;if((r.imageurl==null||r.imageurl=="")&&r.defaultimageurl!=null&&r.defaultimageurl!=""){if(!r.islogo&&i.oemConfig&&i.oemConfig.open&&i.oemConfig.photo&&i.oemConfig.photo.contentUrl){r.url="/no_auth_ewei_attachment?contentUrl="+i.oemConfig.photo.contentUrl}else{r.url=r.defaultimageurl}}else if(e.test(r.imageurl)){r.url=r.imageurl}else{if(r.transit=="true"){if(r.imageurl.indexOf("/no_auth_ewei_attachment?contentUrl=")!=-1){r.url=r.imageurl+(r.imagestyle!=null&&r.imagestyle!=""?"?style="+r.imagestyle:"")}else{r.url="/no_auth_ewei_attachment?contentUrl="+r.imageurl+(r.imagestyle!=null&&r.imagestyle!=""?"?style="+r.imagestyle:"")}}else{if(r.imageurl.indexOf("//"+n.bucket_domain+"/")!=-1){var t=("//"+n.bucket_domain+"/").length;if(r.imageurl.indexOf("/no_auth_ewei_attachment?contentUrl=")!=-1){r.url=r.imageurl.substr(t)+(r.imagestyle!=null&&r.imagestyle!=""?"-"+r.imagestyle:"")}else{r.url="/no_auth_ewei_attachment?contentUrl="+r.imageurl.substr(t)+(r.imagestyle!=null&&r.imagestyle!=""?"-"+r.imagestyle:"")}}else{if(r.imageurl.indexOf("/no_auth_ewei_attachment?contentUrl=")!=-1){r.url=r.imageurl+(r.imagestyle!=null&&r.imagestyle!=""?"-"+r.imagestyle:"")}else{r.url="/no_auth_ewei_attachment?contentUrl="+r.imageurl+(r.imagestyle!=null&&r.imagestyle!=""?"-"+r.imagestyle:"")}}}void 0}};r.$watch("imageurl",function(){e()});r.toEdit=function(){void 0}}]).directive("imageShow",function(){return{restrict:"EA",replace:true,scope:{imagestyle:"@",imageurl:"@",defaultimageurl:"@",imageclass:"@",editable:"@",islogo:"@",transit:"@"},templateUrl:"/source/scripts/directives/image-show/image-show.html",controller:"imageShowController"}});(function(){"use strict";angular.module("com.ewei.angular.ui").directive("hasModule",e);e.$inject=["$rootScope","$interpolate"];function e(e,c){var u=["online_service_basic","remote_assistance_basic","enterprise_basic","enterprise_basic_19"];function a(e,t,i,r){if(!e||u.indexOf(e.type)===-1||!e.moduleList)return;var n=c(r.hasModule)(t);if(n!=""){var a=n.split(",");var o=e.moduleList;var s=false;var l=Date.parse(e.authorizeDeadline?e.authorizeDeadline.replace(/-/g,"/"):"1970/1/1");a.forEach(function(e){if(o.indexOf(e)>-1&&Date.now()<l){s=true}});if(!s){switch(r.whenNoModule){case"warning":{i.bind("click",function(e){if(!s()){e.stopImmediatePropagation();void 0}});break}case"hide":{i.hide();break}default:{i.remove();break}}}}}return{priority:900,restrice:"AE",compile:function(){return{pre:function(i,r,n){a(e.providerLicense,i,r,n);e.$on("provider-license-changed",function(e,t){a(t,i,r,n)})}}}}}})();angular.module("com.ewei.angular.ui").directive("hasPermission",["permissions",function(o){return{restrict:"A",link:function(e,t,i){if(!_.isString(i.hasPermission))throw"hasPermission value must be a string";var r=i.hasPermission.trim();if(r!=""){var n=r[0]==="!";if(n){r=r.slice(1).trim()}function a(){var e=o.hasPermission(r);if(e&&!n||!e&&n)t.show();else t.hide()}a()}}}}]).directive("hasPermissions",["permissions",function(n){return{restrict:"A",link:function(e,t,i){if(i.hasPermissions!=""){var r=i.hasPermissions.split(",");if(n.anyPermissions(r)){t.show()}else{t.hide()}}}}}]).directive("anyPermissions",["permissions",function(n){return{restrict:"A",link:function(e,t,i){var r=angular.fromJson(i.anyPermissions);if(n.anyPermissions(r)){t.show()}else{t.hide()}}}}]);angular.module("com.ewei.angular.ui").directive("eweiSrc",[function(){return{restrict:"A",link:function(e,t,i){if(!_.isString(i.eweiSrc))throw"eweiSrc value must be a string";var r=i.eweiSrc.trim();if(r!=""){t.attr("src",r)}}}}]);angular.module("com.ewei.angular.ui").controller("chatLogInticketLogController",["$scope","$http","chatDetailService",function(u,e,t){var i=/(?:(https?):\/\/(?:www\.)?|www\.)((?:(?:[-\w]+\.)+)[-\w]+)(?::\d+)?(?:\/((?:[-a-zA-Z;./\d#:_?=&,]*)))?/gi;function d(e){var t=e;var i=/(?:\[([^\]]+?)\]\s?\()?((http|ftp|https):\/\/[\w\-_]+(\.[\w\-_]+)+([\w\-\.,@?^=%&:\/~\+#]*[\w\-\@?^=%&\/~\+#])?)\){0,1}/g;t=t.replace(/</g,"&lt;").replace(/\n/g,"<br/>");if(t.match(i)){t=t.replace(i,function(e,t,i){if(t){return'<a class="c75" href="'+i+'" target="_blank">'+t+"</a>"}return'<a class="c75" href="'+i+'" target="_blank">'+i+"</a>"})}return t}u.chatLogs=[];t.run(u.ticketComment.chat.id,"",false,function(c){if(c.status==0){e({url:"api/v1/chats/"+u.ticketComment.chat.id+"/chat_logs.json",method:"GET",params:{_page:1,_count:1e7,sort:"ASC"}}).success(function(e,t,i,r){if(e.status==0){var e=e.result;var n=[];if(e.chat_logs){for(var a=0,o=e.chat_logs.length;a<o;a++){var s=e.chat_logs[a];var l=s.content;s.rawContent=s.content;if(l!=undefined&&l!=""&&s.type!=="location"){l=d(l)}s.content=l;s.chat=c.result;u.chatLogs.push(s)}}}})}})}]).controller("chatLog",["$scope","$http",function(i,e){i.cancelProgess=function(e){var t=e.log.contentUrl;i.$emit("stopUpload",{id:t});e.$parent.logLists.splice(e.$index,1)};if(i.$parent.reSendMessage){i.reSendMessage=i.$parent.reSendMessage}}]).directive("chatLogInTicketLog",function(){return{restrict:"EA",replace:true,scope:{chat:"=",ticketComment:"="},templateUrl:"/source/scripts/directives/chat-log-in-ticket-log/chat-log-in-ticket-log.html",controller:"chatLogInticketLogController"}}).directive("chatLogs",[function(){return{restrict:"E",scope:{logLists:"=logLists",progess:"=",isWebchat:"@",reSendMessage:"&",ticketComment:"="},templateUrl:"/source/scripts/directives/chat-log-in-ticket-log/chat-logs.html",controller:"chatLog"}}]);angular.module("eweiApp.ticket").directive("videojs",function(){var e=function(e,t,i){i.type=i.type||"video/mp4";var r={techOrder:["html5","flash"],controls:true,preload:"auto",autoplay:false,height:i.height,width:i.width,children:{controlBar:{children:{volumeControl:false}}}};var n=(new Date).getTime();i.id="videojs"+n;t.attr("id",i.id);var a=i.poster?i.poster:"/source/images/ewei-video.png";var o=_V_(i.id,r,function(){this.src({type:i.type,aspectRatio:"16:9",autoHeight:true,width:500})});e.$on("$destroy",function(){o.dispose()})};return{restrict:"A",link:e}});angular.module("ewei.notify",[]).directive("eweiNotify",[function(){return{restrict:"E",scope:true,controller:["$scope","utils","tabs","$stateParams","commonTools","$rootScope","$http","$sce","$state","$filter","EweiConfig","ConsoleConfig","$window","alertService","coreNotifyService","WebChatListManager","providerJudgement",function(s,d,f,l,c,p,m,e,u,n,t,h,g,v,a,o,k){var y=function(e){if(e){$("#playAudioContainer").empty();$("#playAudioContainer").html('<audio src="source/audio/'+e+'" autoplay="true"></audio>')}else{$("#playAudioContainer").empty();$("#playAudioContainer").html("<audio src='source/audio/DingDong.wav' autoplay='true'></audio>")}};s.$on("chat_new_notice",function(e,t){if(t.chatId){if(!t.user||t.user.id!==h.user.id){o.setChatUnread(t.chatId)}}a.doNotify(a.constant.EVENT_OTHER_CHAT_RED_POINT,true);if(t.user&&t.user.id==h.user.id){return}y("message.mp3");var i=window.contextpath+"/source/images/logo_helpdesk.png";if(p.provider.contentUrl){i=p.provider.contentUrl}if(p.oemConfig&&p.oemConfig.open&&p.oemConfig.photo&&p.oemConfig.photo.contentUrl){i="/no_auth_ewei_attachment?contentUrl="+p.oemConfig.photo.contentUrl}if(t.user&&t.user.photo&&t.user.photo.contentUrl){i="/no_auth_ewei_attachment?contentUrl="+t.user.photo.contentUrl}var r="会话#"+t.chatId+"有新消息!";if(t.chatLog){if(t.chatLog.type=="text"&&t.chatLog.content!=null&&t.chatLog.content!=""){r=t.chatLog.content}else if(t.chatLog.type!=null){r=n("translate")("CHATLOG_TYPE_"+t.chatLog.type.toUpperCase())}}c.browserNotify({body:r,title:t.user.name,icon:i,timeOut:3e4,callBack:function(){if(k.isFree()){u.go("no-license",{},{reload:true})}else{u.go("webchats_new.detail",{id:t.chatId},{reload:"webchats_new.detail"})}}})});s.$on("accept_chat",function(e,t){if(t.chatId&&t.engineerId===h.engineer.id){o.setChatUnread(t.chatId)}});function w(t){if(angular.isObject(t)){if(t.operater&&t.operater.id==h.user.id&&t.type!=="file"){return}var e=window.contextpath+"/source/images/logo_helpdesk.png";if(p.provider.contentUrl){e=p.provider.contentUrl}if(p.oemConfig&&p.oemConfig.open&&p.oemConfig.photo&&p.oemConfig.photo.contentUrl){e="/no_auth_ewei_attachment?contentUrl="+p.oemConfig.photo.contentUrl}if(t.operater&&t.operater.photo&&t.operater.photo.contentUrl){e="/no_auth_ewei_attachment?contentUrl="+t.operater.photo.contentUrl}var i=t.message;var r={};var n="";if(/^{.+}$/.test(i)){try{i=angular.fromJson(i)}catch(e){i=t.message.replace(/\n/g,"\\n").replace(/\r/g,"\\r").replace(/\t/g,"\\t");i=angular.fromJson(i)}}i.userName=i.userName||"";if(t.operater){i.userName=t.operater.name||t.operater.nickname||""}if(angular.isObject(i)){switch(i["type"]){case"ticket_receive":r.title="";if(!i.requesterName){i.requesterName=""}if(typeof i.serviceDeskName=="undefined"){r.body=i.requesterName+" 请求服务，新工单到达。\n工单#"+i.ticketNo+i.subject}else{r.body=i.requesterName+" 请求服务，新工单到达："+i.serviceDeskName+"\n工单#"+i.ticketNo+i.subject}break;case"add_ticket_comment":r.title="";r.body=i.userName+(i.open?"":"[私密]")+" 回复："+i.content+"\n工单#"+i.ticketNo+i.subject;break;case"ticket_automation":r.title="";r.body="自动化通知："+i.content;break;case"assign_ticket":r.title="";if(!i.userName){i.userName="系统"}if(typeof i.serviceDeskName=="undefined"){r.body=i.userName+" 分派工单给你。工单#"+i.ticketNo}else{r.body=i.userName+" 分派工单给你@"+i.serviceDeskName+" 工单#"+i.ticketNo}break;case"other_place_user_online":r.title="";r.body="用户("+i.userName+")在另一设备登陆("+i.deviceName+")";break;case"comment_article":r.title="";r.body=i.userName+" 评论："+i.content+" 文章:"+i.title;break;case"answer_question":r.title="";r.body=i.userName+" 回答："+i.content+" 问题:"+i.title;break;case"comment_answer":r.title="";r.body=i.userName+" 评论："+i.content+" 回答："+i.title;break;case"change_password":r.title="";r.body=i.userName+" 修改了你的登录密码";break;case"change_email":r.title="";r.body=i.userName+" 替换您的Email为："+i.email;break;case"account_enable":r.title="";r.body=i.userName+"  停用了你的账号";break;case"project_share":r.title="";r.body=i.userName+"  分享项目给你 项目#"+i.projectNo;break;case"project_add_remark":r.title="";r.body=i.userName+"  备注："+i.content+"  项目#"+i.projectNo;break;case"project_update_phase":r.title="";r.body=i.userName+"  变更项目进度到"+i.phaseName;if(i.content){r.body+=",并备注："+i.content}r.body+="  项目#"+i.projectNo;break;case"project_relate_ticket":r.title="";r.body=i.userName+"  添加关联工单#"+i.ticketNo+"  项目#"+i.projectNo;break;case"project_delete_relate_ticket":r.title="";r.body=i.userName+"  解除了关联工单#"+i.ticketNo+"  项目#"+i.projectNo;break;case"file_export_success":r.title="工单#"+i.ticketNo+"  数据导出完成";r.body="下载导出文件:"+i.attachmentName;break;case"file_export_failure":v.add("数据导出失败，请重新导出","danger");return false}}else{r.title="";r.body=$(i).text()}c.browserNotify({body:r.body,title:r.title,icon:e,timeOut:3e4,callBack:function(){p.$broadcast("remove-notify",{notifyLogId:t.id});if(t.targetId&&t.type==="ticket"){u.go("tickets_detail",{id:t.targetId})}else if(t.targetId&&t.type==="project"){u.go("project_detail",{categoryid:i.projectCategoryId,id:t.targetId})}else if(t.targetId&&t.type==="file"){var e="/ewei_attachment?contentUrl="+i.attachmentUrl+"&fileName="+encodeURIComponent(i.attachmentName);g.open(e)}else{u.go("dashboard.home")}}});if(t.targetId){var a,o;if(t.type==="ticket"){a=d.findTabById("tickets_detail"+t.targetId)}else if(t.type==="project"){a=d.findTabById("project_detail"+i.projectCategoryId+t.targetId)}o=f[a];if(angular.isObject(o)){if(o.params.id!=l.id){s.$applyAsync(function(){o.shake=true})}}}}}s.$on("notice",function(e,t){y("answercall.wav");if(!angular.isArray(p.notifyLogs)){p.notifyLogs=[]}m({url:"notify_log_by_id.json",method:"GET",params:{notifyLogId:t.notifyLogId}}).success(function(e,t,i,r){var n=[];var a=[];var o={};if(e.success){if(e.json){var s=e.json;var l=s.message;if(p.providerEweiProductName){s.message=s.message.replaceAll("易维帮助台",p.providerEweiProductName)}s.message=s.message.replaceAll("DEFAULT_SERVICE_DESK_NAME","默认服务台");if(!_.find(p.notifyLogs,function(e){return e.id==s.id})){p.notifyLogs.unshift(s)}if(s.type=="ticket"){var c="tickets_detail"+s.targetId;var u=d.findTabById(c);if(u!==null&&u!==undefined){if(f[u]&&f[u].active){p.$broadcast("remove-notify",{notifyLogId:s.id});return}}w(s)}else if(s.type==="project"){w(s)}else if(s.type==="file"){w(s)}}else{m({url:"notify_log.json",method:"GET",params:{_count:8,_page:1,_desc:"createdAt"}}).success(function(e,t,i,r){p.notifyLogs=[];if(angular.isArray(e.notifyLogs)){var n={};for(var a=0,o=e.notifyLogs.length;a<o;a++){var s=e.notifyLogs[a];var l=s.message;if(p.providerEweiProductName!=""){l=l.replaceAll("易维帮助台",p.providerEweiProductName)}l=l.replaceAll("DEFAULT_SERVICE_DESK_NAME","默认服务台");s.message=l;if(a==0){n=s}p.notifyLogs.unshift(s)}}})}}})})}],link:function(e,t,i,r){}}}]);angular.module("com.ewei.angular.ui").directive("radioOptions",[function(){return{restrict:"AE",templateUrl:"/source/scripts/directives/radio-options/radio-options.html",controller:"radioOptions",scope:{ticketField:"=",ticketId:"=",category:"@",noneDefaultValue:"@",singleLine:"="}}}]).controller("radioOptions",["$scope","$http","alertService",function(a,r,o){function i(){if(a.category!=undefined&&a.category=="auto"){a.field=a.ticketField}else{a.field=a.ticketField.customField||a.ticketField}if(a.field.customFieldOptions&&angular.isString(a.field.customFieldOptions)){a.field.customFieldOptions=angular.fromJson(a.field.customFieldOptions)}if(!a.field.value&&a.field.defaultValue&&!a.noneDefaultValue){a.field.value=a.field.defaultValue}a.copyCustomFieldOptions=angular.copy(a.field.customFieldOptions)}i();a.$watch("ticketField",function(e,t){if(e!==t){i()}});a.$watch("ticketField.value",function(e,t){if(e!==t){a.field.value=a.ticketField.value}});a.dropdownRadioSearch=function(e,t){t.splice(0);var i=e.target.value.trim();angular.forEach(a.copyCustomFieldOptions,function(e){if(e.name&&e.name.search(new RegExp(i,"i"))>-1){t.push(e)}})};a.chooseDropdownRadio=function(e,t){if(e.value!=t.value){e.value=t.value;a.ticketField.value=t.value;n(a.ticketField)}};var n=function(n){var e="POST";if(a.ticketId!=null){var t="";var i={};if(a.category=="userCustomField"){t="/updateUserCustomField.json";i={id:n.customField.ticketCustomFieldId,value:n.value,userId:a.ticketId,customFieldId:n.customField.id}}else if(a.category=="userGroupCustomField"){t="/updateUserGroupCustomField.json";i={id:n.customField.ticketCustomFieldId,value:n.value,userGroupId:a.ticketId,customFieldId:n.customField.id}}else{t="/api/v1/ticket_update/"+a.ticketId+"/custom_field.json";e="PUT";i={custom_field_id:n.customField.id,value:n.value}}r({url:t,method:e,data:i}).success(function(e,t,i,r){if(e.status!==undefined){if(e.status!=0&&e.result&&e.result.error){if(e.result.error){o.add(e.result.error_description,"danger","left")}else{o.add("修改失败","danger","left")}}else{a.$emit("ticket-custom-field-value-updated",a.ticketId,n.customField.id,n.value)}}else{if(e.success){}else{if(e.message){o.add(e.message,"danger","left")}else{o.add("修改失败","danger","left")}}}})}}}]);angular.module("com.ewei.angular.ui").directive("eweiQuestion",[function(){return{restrict:"AE",templateUrl:"/source/scripts/directives/ewei-question/ewei-question.html",controller:"eweiQuestion",scope:{description:"="}}}]).controller("eweiQuestion",["$scope","$http","alertService",function(e,t,i){}]);(function(){"use strict";angular.module("com.ewei.angular.ui").directive("dashboardChart",t).controller("dashboardChartController",e);e.$inject=["$scope","$http","ConsoleConfig","loadJs","typeTransfer","$filter","chartTypeService","coreNotifyService","coreModelService","apiSummaryChartService","$timeout"];function e(g,o,a,e,s,i,t,l,c,u,r){var v=this;var n=v.__proto__.constructor.name+"_"+(new Date).valueOf();v.selectedChartName="";v.chartPosition=v.chartposition;v.chartList=t;v.chartIsShow=false;function d(){p();h();r(function(){v.loadChart(v.charttype)},0)}function f(e){var t=false;for(var i=0;i<v.chartList.length;i++){if(v.chartList[i].name==e.type){t=true}}if(!t){g.loadingChart=true;document.getElementById("chart_"+e.position).innerHTML='<p class="chart_data_none">无权限查看该信息</p>';return}var r={"工单状态":["ticketStatePieChart","setWorkorder"],"工单数量":["countTicketNumber","setTicketNumberChart"],"工单处理时长":["ticketHandleTimeChart","setTicketHandleChart"],"工单响应时长":["ticketResponseTimeChart","setTicketResponseChart"],"解决率":["ticketSolvedRateChart","setTicketSolvedRateChart"],"满意度":["ticketEvaluteChart","setTicketEvaluateChart"],"是否评价":["ticketIsEvaluateChart","setTicketIsEvaluateChart"],"SLA达标率":["ticketSlaRateChar","setTicketSLARateChart"],"时间段分布":["listDistributeBytimeday","setBytimeChart"],"IP地址来源地":["listDistributeByip","setByipChart"],"渠道分布":["listDistributeBychannel","setByChannelChart"],"溢出率":["listDistributeByoverflow","setByOverflowChart"],"删除率":["listDistributeBydeleterate","setByDeleteRateChart"],"删除原因":["listDistributeBydeletereason","setByDeleteReasonChart"],"优先级分布":["listDistributeBypriority","setByPriorityChart"],"工单类型分布":["listDistributeBytype","setByTypeChart"],"服务目录分布":["listDistributeByservicecatalog","setByServicecatalogChart"],"标签分布":["listDistributeBytag","setByTagChart"],"客服接单排行榜":["listDistributeByfirstreply","setByFirstReplyChart"],"客服关单排行榜":["listDistributeByclose","setByCloseChart"],"客服团队协作排行榜":["listDistributeByparticipate","setByParticipateChart"],"客服技术支持排行榜":["listDistributeBytechsupport","setByTechSupportChart"],"客服社区贡献度排行榜":["listDistributeByhelpcenter","setByHelpcenterChart"],"客服组接单排行榜":["listDistributeBygroupfirstreply","setByGroupFirstReplyChart"],"客服组关单排行榜":["listDistributeBygroupclose","setByGroupCloseChart"],"客服组团队协作排行榜":["listDistributeBygroupparticipate","setByGroupParticipateChart"],"客服组技术支持排行榜":["listDistributeBygrouptechsupport","setByGroupTechSupportChart"],"客服组社区贡献度排行榜":["listDistributeBygrouphelpcenter","setByGroupHelpcenterChart"],"客户数量":["customerAnalyseIncremental_bymonth","setByIncrementalChart"],"客户活跃度":["customerAnalyseHelpcenter_bymonth","setByCustomerHelpcenterChart"],"客户类型占比":["customerAnalyseByusergroup","setByUsergroupChart"],"企业客户规模分布":["customerAnalyseByusergroupscale","setByUsergroupScaleChart"],"客户服务请求排行榜":["customerAnalyseRequestCountBycustomer","setByRequestCountChart"],"客户社区活动排行榜":["customerAnalyseHelpcenterBycustomer","setByHelpcenterCountChart"],"客户好评排行榜":["customerAnalyseGoodCountBycustomer","setByGoodCountChart"],"客户差评排行榜":["customerAnalysePoorCountBycustomer","setByPoorCountChart"],"客户组服务请求排行榜":["customerAnalyseRequestCountByusergroup","setByRequestCountGroupChart"],"客户组社区活动排行榜":["customerAnalyseHelpcenterByusergroup","setByHelpcenterCountGroupChart"],"客户组好评排行榜":["customerAnalyseGoodCountByusergroup","setByGoodCountGroupChart"],"客户组差评排行榜":["customerAnalysePoorCountByusergroup","setByPoorCountGroupChart"],"积分排行榜":["customerAnalyseCustomerIntegral","setByIntegralChart"]};if(!r[e.type]){return}var n=c.detail.summary.get(r[e.type][0])||{};if(n!=null&&!angular.equals({},n)&&n.status==0){v.chartIsShow=true;v[r[e.type][1]](n,e.position)}}function p(){l.register(n,l.constant.EVENT_DETAIL_SUMMARY,function(e,t){if(v.selectedChartName!=t.type||v.chartIsShow||v.chartPosition!=t.position){return}f(t)})}function m(){l.unRegister(n)}g.$on("$destroy",function(){m()});function h(){var e=new Date;var t=i("date")(e,"yyyy/MM/dd 23:59:59");v.chartBeginTime=i("date")(e.setMonth(e.getMonth()-1),"yyyy/MM/dd 00:00:00");v.chartEndTime=t}v.loadChart=function(e){v.selectedChartName=e;v.chartIsShow=false;f({type:e,position:v.chartPosition});k(e)};function k(e){var t={"工单状态":"ticketStatePieChart","工单数量":"countTicketNumber","工单处理时长":"ticketHandleTimeChart","工单响应时长":"ticketResponseTimeChart","解决率":"ticketSolvedRateChart","满意度":"ticketEvaluteChart","是否评价":"ticketIsEvaluateChart","SLA达标率":"ticketSlaRateChar","时间段分布":"listDistributeBytimeday","IP地址来源地":"listDistributeByip","渠道分布":"listDistributeBychannel","溢出率":"listDistributeByoverflow","删除率":"listDistributeBydeleterate","删除原因":"listDistributeBydeletereason","优先级分布":"listDistributeBypriority","工单类型分布":"listDistributeBytype","服务目录分布":"listDistributeByservicecatalog","标签分布":"listDistributeBytag","客服接单排行榜":"listDistributeByfirstreply","客服关单排行榜":"listDistributeByclose","客服团队协作排行榜":"listDistributeByparticipate","客服技术支持排行榜":"listDistributeBytechsupport","客服社区贡献度排行榜":"listDistributeByhelpcenter","客服组接单排行榜":"listDistributeBygroupfirstreply","客服组关单排行榜":"listDistributeBygroupclose","客服组团队协作排行榜":"listDistributeBygroupparticipate","客服组技术支持排行榜":"listDistributeBygrouptechsupport","客服组社区贡献度排行榜":"listDistributeBygrouphelpcenter","客户数量":"customerAnalyseIncremental_bymonth","客户活跃度":"customerAnalyseHelpcenter_bymonth","客户类型占比":"customerAnalyseByusergroup","企业客户规模分布":"customerAnalyseByusergroupscale","客户服务请求排行榜":"customerAnalyseRequestCountBycustomer","客户社区活动排行榜":"customerAnalyseHelpcenterBycustomer","客户好评排行榜":"customerAnalyseGoodCountBycustomer","客户差评排行榜":"customerAnalysePoorCountBycustomer","客户组服务请求排行榜":"customerAnalyseRequestCountByusergroup","客户组社区活动排行榜":"customerAnalyseHelpcenterByusergroup","客户组好评排行榜":"customerAnalyseGoodCountByusergroup","客户组差评排行榜":"customerAnalysePoorCountByusergroup","积分排行榜":"customerAnalyseCustomerIntegral"};var i={$and:[{$ge:{"ticketMetric.solvedAt":v.chartBeginTime.replace(/\//g,"-")}},{$lt:{"ticketMetric.solvedAt":v.chartEndTime.replace(/\//g,"-")}}]};var r={};var n={};if(e=="工单处理时长"||e=="工单响应时长"||e=="SLA达标率"||e=="解决率"||e=="满意度"||e=="是否评价"){r={_filter:i,advancedQueryCondition:{startDate:v.chartBeginTime,endDate:v.chartEndTime,chartSelectTimeType:2},engineerId:a.engineer.id,userId:a.user.id}}else if(e=="工单数量"){n={startDate:v.chartBeginTime,endDate:v.chartEndTime}}else{n={begin:v.chartBeginTime,end:v.chartEndTime}}u.run(t[e],l.constant.EVENT_DETAIL_SUMMARY,"",r,n,{position:v.chartPosition,type:e},function(e){if(angular.isDefined(e.result)){}})}v.deleteTemplte=function(){v.deletetemplte()};v.changeChart=function(i){if(v.selectedChartName==i.name){return}g.loadingChart=false;var r=y(v.chartPosition);v.loadChart(i.name);if(v.dashboardinfo.length<=0){var e=[{type:"chart",chartType:"工单状态",orderNo:1},{type:"newState",orderNo:2},{type:"chart",chartType:"工单数量",orderNo:3},{type:"data",orderNo:4},{type:"chart",chartType:"满意度",orderNo:5},{type:"client",orderNo:6}];e[r-1].chartType=i.name;o({url:"/api/v1/dashboard/save_more.json?_token="+getCookie("user_token")+"&provider_id="+a.provider.id,method:"POST",data:e}).success(function(e){v.loaddashboardinfo()})}else{var e={type:"chart",chartType:i.name,id:v.positionid,orderNo:r};o({url:"/api/v1/dashboard/update.json?_token="+getCookie("user_token")+"&provider_id="+a.provider.id,method:"POST",data:e}).success(function(e){var t=c.list.dashboard.get(1,r-1);t.chartType=i.name})}};function y(e){if(e=="A"){return 1}else if(e=="B"){return 2}else if(e=="C"){return 3}else if(e=="D"){return 4}else if(e=="E"){return 5}else{return 6}}v.setWorkorder=function(e,t){g.workorderChart=ECharts.Charts.InitChart("chart_"+t);g.loadingChart=true;if(e.result.closed==0&&e.result.deleted==0&&e.result.news==0&&e.result.open==0&&e.result.pending==0&&e.result.solved==0&&e.result.suspended==0){document.getElementById("chart_"+v.chartPosition).innerHTML='<p class="chart_data_none">暂无数据</p>';return}var r=[];var n=[];var a=20;r=[{name:"关闭",value:e.result.closed},{name:"回收站",value:e.result.deleted},{name:"新建",value:e.result.news},{name:"处理中",value:e.result.open},{name:"暂停",value:e.result.pending},{name:"处理完毕",value:e.result.solved},{name:"隔离区",value:e.result.suspended}];n=[40,80];o({url:"ticketlegend/list.json",type:"GET"}).success(function(e){if(e.success){var t={};for(var i=0;i<e.json.length;i++){e.json[i].legendStatus=s.keyToValue(e.json[i].legendStatus);if(e.json[i].legendStatus!="error"){t[e.json[i].legendStatus]=false}}g.workorderChart=ECharts.Charts.RenderChart("pie","workorder",r,"",a,g.workorderChart,"",n,true,t);g.workorderChart.on(echarts.config.EVENT.LEGEND_SELECTED,function(e){if(e.selected[e.target]){o({url:"ticketlegend/delete.json",method:"POST",params:{legend_status:s.valueToKey(e.target)}})}else{o({url:"ticketlegend/add.json",method:"POST",params:{legend_status:s.valueToKey(e.target)}})}})}})};v.setTicketNumberChart=function(e,t){g.ticketNumberChart=ECharts.Charts.InitChart("chart_"+t);var i=[];var r=0;var n=0;var a=0;var o=0;var s=20;g.loadingChart=true;if(e.result==undefined||e.result==null||e.result.length<=0){document.getElementById("chart_"+t).innerHTML='<p class="chart_data_none">暂无数据</p>';return}var l=function(){var e=new Date(v.chartBeginTime);var t=new Date(v.chartEndTime);var i=[];while(e<=t){var r=e.getMonth()+1;if(r<10){r="0"+r}var n=e.getDate();if(n<10){n="0"+n}i.push(e.getFullYear()+"-"+r+"-"+n);e.setDate(e.getDate()+1)}return i};if(e.result.length>0){if(e.result.length<s){var c=l();for(var u=0;u<c.length;u++){var d=false;var f={};f.name=c[u];f.value=0;f.group="新建工单";var p={};p.name=c[u];p.value=0;p.group="处理完成工单";for(var m=0;m<e.result.length;m++){if(c[u]==e.result[m].name){d=true;i.push(e.result[m])}if(u==0){if("新建工单"==e.result[m].group){r=parseInt(r)+parseInt(e.result[m].value)}else if("暂停工单"==e.result[m].group){o=parseInt(o)+parseInt(e.result[m].value)}else if("处理中的工单"==e.result[m].group){a=parseInt(a)+parseInt(e.result[m].value)}else{n=parseInt(n)+parseInt(e.result[m].value)}}}if(!d){i.push(f);i.push(p)}}}else{for(var m=0;m<e.result.length;m++){if("新建工单"==e.result[m].group){r=parseInt(r)+parseInt(e.result[m].value);i.push(e.result[m])}else if("暂停工单"==e.result[m].group){o=parseInt(o)+parseInt(e.result[m].value)}else if("处理中的工单"==e.result[m].group){a=parseInt(a)+parseInt(e.result[m].value)}else{n=parseInt(n)+parseInt(e.result[m].value);i.push(e.result[m])}}i.sort(function(e,t){return Date.parse(e.name)-Date.parse(t.name)})}}g.ticketNumberChart=ECharts.Charts.RenderChart("line","chart_performance",i,"",s,g.ticketNumberChart);g.$emit("transfer.numberData",{newNum:r,endNum:n,paddingNum:o,openNum:a});var h={};g.ticketNumberChart.on(echarts.config.EVENT.CLICK,function(e){var t=e.name;var i=new Date(e.name).getTime();var r=i+24*60*60*1e3;var n=new Date(r);var a=n.getMonth()+1;var o=n.getDate();a=a<10?"0"+a:a;o=o<10?"0"+o:o;if(e.seriesName=="新建工单"){h={$and:[{$ge:{createdAt:t+" 00:00:00"}},{$lt:{createdAt:n.getFullYear()+"-"+a+"-"+o+" 00:00:00"}}]}}else if(e.seriesName=="处理完成工单"){h={$and:[{$ge:{"ticketMetric.solvedAt":t+" 00:00:00"}},{$lt:{"ticketMetric.solvedAt":n.getFullYear()+"-"+a+"-"+o+" 00:00:00"}}]}}})};v.setTicketHandleChart=function(e,t){g.picture_handle=ECharts.Charts.InitChart("chart_"+t);g.loadingChart=true;if(!e.result||!e.result.handleTimeList||e.result.handleTimeList.length<=0){document.getElementById("chart_"+t).innerHTML='<p class="chart_data_none">暂无数据</p>';return}var i=[];var r=0;var n=["1D","2D","3D","4D","5D","6D","7D+"];if(e.result.handleTimeList!=null&&e.result.handleTimeList.length>0){var a=e.result.handleTimeList.length;var o=0;var s=0;for(var l=0;l<n.length;l++){var c={};c.name=n[l];c.value=0;for(var u=0;u<a;u++){if(n[l]==e.result.handleTimeList[u].name){c.value=e.result.handleTimeList[u].value}if(l==0){if(e.result.handleTimeList[u].sumTime!=null&&e.result.handleTimeList[u].sumTime!="undefined"){o=parseInt(o)+parseInt(e.result.handleTimeList[u].sumTime)}if(e.result.handleTimeList[u].value!=null&&e.result.handleTimeList[u].value!="undefined"){s=parseInt(s)+parseInt(e.result.handleTimeList[u].value)}}}c.group="工单数量(个)";i.push(c)}if(s!=0){r=(o/(s*60*24)).toFixed(2)}}g.picture_handle=ECharts.Charts.RenderChart("bar","chart_handle",i,"",null,g.picture_handle)};v.setTicketResponseChart=function(e,t){g.picture_response=ECharts.Charts.InitChart("chart_"+t);g.loadingChart=true;if(!e.result||!e.result.responseTimeList||e.result.responseTimeList.length<=0){document.getElementById("chart_"+t).innerHTML='<p class="chart_data_none">暂无数据</p>';return}var i=[];var r=0;var n=["1H","4H","8H","24H","48H","72H+"];if(e.result.responseTimeList!=null&&e.result.responseTimeList.length>0){var a=e.result.responseTimeList.length;var o=0;var s=0;for(var l=0;l<n.length;l++){var c={};c.name=n[l];c.value=0;for(var u=0;u<a;u++){if(n[l]==e.result.responseTimeList[u].name){c.value=e.result.responseTimeList[u].value}if(l==0){if(e.result.responseTimeList[u].value!=null&&e.result.responseTimeList[u].value!="undefined"){o=parseInt(o)+parseInt(e.result.responseTimeList[u].value)}if(e.result.responseTimeList[u].sumTime!=null&&e.result.responseTimeList[u].sumTime!="undefined"){s=parseInt(s)+parseInt(e.result.responseTimeList[u].sumTime)}}}c.group="工单数量(个)";i.push(c)}if(o!=0){r=(s/(o*60)).toFixed(2)}}g.picture_response=ECharts.Charts.RenderChart("bar","chart_response",i,"",null,g.picture_response)};v.setTicketSolvedRateChart=function(e,t){g.picture_solvedRate=ECharts.Charts.InitChart("chart_"+t);g.loadingChart=true;if(!e.result||!e.result.solvedRateList||e.result.solvedRateList.length<=0){document.getElementById("chart_"+t).innerHTML='<p class="chart_data_none">暂无数据</p>';return}var i=[];var r=0;if(e.result.solvedRateList!=null&&e.result.solvedRateList.length>0){i=e.result.solvedRateList;var n=0;var a=0;for(var o=0;o<e.result.solvedRateList.length;o++){if(e.result.solvedRateList[o].flag){n=parseInt(n)+parseInt(e.result.solvedRateList[o].value)}a=parseInt(a)+parseInt(e.result.solvedRateList[o].value)}if(a!=0){r=(n*100/a).toFixed(0)}}g.picture_solvedRate=ECharts.Charts.RenderChart("pie","chart_solved_rate",i,"",null,g.picture_solvedRate)};v.setTicketEvaluateChart=function(e,t){g.picture_evaluate=ECharts.Charts.InitChart("chart_"+t);g.loadingChart=true;if(!e.result||!e.result.evaluateList||e.result.evaluateList.length<=0){document.getElementById("chart_"+t).innerHTML='<p class="chart_data_none">暂无数据</p>';return}var i=[];var r=0;if(e.result.evaluateList!=null&&e.result.evaluateList.length>0){i=e.result.evaluateList;var n=0;var a=0;for(var o=0;o<e.result.evaluateList.length;o++){if(0!=e.result.evaluateList[o].flag){n=parseInt(n)+parseInt(e.result.evaluateList[o].value)}a=parseInt(a)+parseInt(e.result.evaluateList[o].value)}r=(n*100/a).toFixed(0)}if(isNaN(r)){r=0}g.picture_evaluate=ECharts.Charts.RenderChart("pie","chart_evaluate",i,"",null,g.picture_evaluate)};v.setTicketIsEvaluateChart=function(e,t){g.picture_isEvaluate=ECharts.Charts.InitChart("chart_"+t);g.loadingChart=true;if(!e.result||!e.result.isEvaluateList||e.result.isEvaluateList.length<=0){document.getElementById("chart_"+t).innerHTML='<p class="chart_data_none">暂无数据</p>';return}var i=[];if(e.result.isEvaluateList!=null){i=e.result.isEvaluateList}g.picture_isEvaluate=ECharts.Charts.RenderChart("pie","chart_isEvaluate",i,"",null,g.picture_isEvaluate)};v.setTicketSLARateChart=function(e,t){g.picture_SLARate=ECharts.Charts.InitChart("chart_"+t);g.loadingChart=true;if(!e.result||!e.result.SLARateList||e.result.SLARateList.length<=0){document.getElementById("chart_"+t).innerHTML='<p class="chart_data_none">暂无数据</p>';return}var i=[];var r=[];var n=0;if(e.result.SLARateList!=null&&e.result.SLARateList.length>0){i=e.result.SLARateList;var a=0;for(var o=0;o<e.result.SLARateList.length;o++){a=parseInt(a)+parseInt(e.result.SLARateList[o].value)}n=(a/e.result.SLARateList.length).toFixed(2)}g.picture_SLARate=ECharts.Charts.RenderChart("line","chart_SLARate",i,"",null,g.picture_SLARate)};v.setBytimeChart=function(e,t){g.chartBytime=ECharts.Charts.InitChart("chart_"+t);g.loadingChart=true;if(e.result.length<=0){document.getElementById("chart_"+v.chartPosition).innerHTML='<p class="chart_data_none">暂无数据</p>';return}g.chartBytime=ECharts.Charts.RenderChart("line","distribute_bytime",e.result,"",50,g.chartBytime)};v.setByipChart=function(e,t){g.chartByip=ECharts.Charts.InitChart("chart_"+t);g.loadingChart=true;if(e.result.length<=0){document.getElementById("chart_"+v.chartPosition).innerHTML='<p class="chart_data_none">暂无数据</p>';return}g.chartByip=ECharts.Charts.RenderChart("bar","distribute_byip",e.result,"",50,g.chartByip)};v.setByChannelChart=function(e,t){g.chartBychannel=ECharts.Charts.InitChart("chart_"+t);g.loadingChart=true;if(e.result.length<=0){document.getElementById("chart_"+t).innerHTML='<p class="chart_data_none">暂无数据</p>';return}g.chartBychannel=ECharts.Charts.RenderChart("pie","distribute_bychannel",e.result,"",null,g.chartBychannel)};v.setByOverflowChart=function(e,t){g.chartByoverflow=ECharts.Charts.InitChart("chart_"+t);g.loadingChart=true;if(e.result.length<=0){document.getElementById("chart_"+t).innerHTML='<p class="chart_data_none">暂无数据</p>';return}g.chartByoverflow=ECharts.Charts.RenderChart("pie","distribute_byoverflow",e.result,"",null,g.chartByoverflow)};v.setByDeleteRateChart=function(e,t){g.chartBydeleterate=ECharts.Charts.InitChart("chart_"+t);g.loadingChart=true;if(e.result.length<=0){document.getElementById("chart_"+t).innerHTML='<p class="chart_data_none">暂无数据</p>';return}g.chartBydeleterate=ECharts.Charts.RenderChart("pie","distribute_bydeleterate",e.result,"",null,g.chartBydeleterate)};v.setByDeleteReasonChart=function(e,t){g.chartBydeletereason=ECharts.Charts.InitChart("chart_"+t);g.loadingChart=true;if(e.result.length<=0){document.getElementById("chart_"+t).innerHTML='<p class="chart_data_none">暂无数据</p>';return}g.chartBydeletereason=ECharts.Charts.RenderChart("pie","distribute_bydeletereason",e.result,"",null,g.chartBydeletereason)};v.setByPriorityChart=function(e,t){g.chartBypriority=ECharts.Charts.InitChart("chart_"+t);g.loadingChart=true;if(e.result.length<=0){document.getElementById("chart_"+t).innerHTML='<p class="chart_data_none">暂无数据</p>';return}var i=e.result;if(localStorage&&localStorage["systemFieldPriority"]){var r=angular.fromJson(angular.fromJson(localStorage["systemFieldPriority"]).customFieldOptions);for(var n=0,a=i.length;n<a;n++){for(var o=0,s=r.length;o<s;o++){if(i[n].name==r[o].value){i[n].name=r[o].name;break}}}}g.chartBypriority=ECharts.Charts.RenderChart("radar","distribute_bypriority",i,"",null,g.chartBypriority)};v.setByTypeChart=function(e,t){g.chartBytype=ECharts.Charts.InitChart("chart_"+t);g.loadingChart=true;if(e.result.length<=0){document.getElementById("chart_"+t).innerHTML='<p class="chart_data_none">暂无数据</p>';return}g.chartBytype=ECharts.Charts.RenderChart("radar","distribute_bytype",e.result,"",null,g.chartBytype)};v.setByServicecatalogChart=function(e,t){g.chartByservicecatalog=ECharts.Charts.InitChart("chart_"+t);g.loadingChart=true;if(e.result.length<=0){document.getElementById("chart_"+t).innerHTML='<p class="chart_data_none">暂无数据</p>';return}g.chartData=e.result;g.breadcrumbs=[{name:"根目录",id:null}];g.chartByservicecatalog=ECharts.Charts.RenderChart("pie","distribute_byservicecatalog",g.chartData,"",null,g.chartByservicecatalog);if(g.chartByservicecatalog!=null){g.chartByservicecatalog.on(echarts.config.EVENT.CLICK,function(e){var t=getChartDataOther(e.name);clickServicecatalog(e.name,t)})}};v.setByTagChart=function(e,t){g.chartBytag=ECharts.Charts.InitChart("chart_"+t);g.loadingChart=true;if(e.result.length<=0){document.getElementById("chart_"+v.chartPosition).innerHTML='<p class="chart_data_none">暂无数据</p>';return}g.chartBytag=ECharts.Charts.RenderChart("bar","distribute_bytag",e.result,"",50,g.chartBytag)};v.setByFirstReplyChart=function(e,t){g.chartByfirstreply=ECharts.Charts.InitChart("chart_"+t);g.loadingChart=true;if(e.result.length<=0){document.getElementById("chart_"+v.chartPosition).innerHTML='<p class="chart_data_none">暂无数据</p>';return}g.chartByfirstreply=ECharts.Charts.RenderChart("bar","distribute_byfirstreply",e.result,"",10,g.chartByfirstreply)};v.setByCloseChart=function(e,t){g.chartByclose=ECharts.Charts.InitChart("chart_"+t);g.loadingChart=true;if(e.result.length<=0){document.getElementById("chart_"+t).innerHTML='<p class="chart_data_none">暂无数据</p>';return}g.chartByclose=ECharts.Charts.RenderChart("bar","distribute_byclose",e.result,"",10,g.chartByclose)};v.setByParticipateChart=function(e,t){g.chartByparticipate=ECharts.Charts.InitChart("chart_"+t);g.loadingChart=true;if(e.result.length<=0){document.getElementById("chart_"+t).innerHTML='<p class="chart_data_none">暂无数据</p>';return}g.chartByparticipate=ECharts.Charts.RenderChart("bar","distribute_byparticipate",e.result,"",10,g.chartByparticipate)};v.setByTechSupportChart=function(e,t){g.chartBytechsupport=ECharts.Charts.InitChart("chart_"+t);g.loadingChart=true;if(e.result.length<=0){document.getElementById("chart_"+t).innerHTML='<p class="chart_data_none">暂无数据</p>';return}g.chartBytechsupport=ECharts.Charts.RenderChart("bar","distribute_bytechsupport",e.result,"",10,g.chartBytechsupport)};v.setByHelpcenterChart=function(e,t){g.chartByhelpcenter=ECharts.Charts.InitChart("chart_"+t);g.loadingChart=true;if(e.result.length<=0){document.getElementById("chart_"+t).innerHTML='<p class="chart_data_none">暂无数据</p>';return}g.chartByhelpcenter=ECharts.Charts.RenderChart("bar","distribute_byhelpcenter",e.result,"",10,g.chartByhelpcenter,true)};v.setByGroupFirstReplyChart=function(e,t){g.chartBygroupfirstreply=ECharts.Charts.InitChart("chart_"+t);g.loadingChart=true;if(e.result.length<=0){document.getElementById("chart_"+t).innerHTML='<p class="chart_data_none">暂无数据</p>';return}g.chartBygroupfirstreply=ECharts.Charts.RenderChart("radar","distribute_bygroupfirstreply",e.result,"",10,g.chartBygroupfirstreply)};v.setByGroupCloseChart=function(e,t){g.chartBygroupclose=ECharts.Charts.InitChart("chart_"+t);g.loadingChart=true;if(e.result.length<=0){document.getElementById("chart_"+t).innerHTML='<p class="chart_data_none">暂无数据</p>';return}g.chartBygroupclose=ECharts.Charts.RenderChart("radar","distribute_bygroupclose",e.result,"",10,g.chartBygroupclose)};v.setByGroupParticipateChart=function(e,t){g.chartBygroupparticipate=ECharts.Charts.InitChart("chart_"+t);g.loadingChart=true;if(e.result.length<=0){document.getElementById("chart_"+t).innerHTML='<p class="chart_data_none">暂无数据</p>';return}g.chartBygroupparticipate=ECharts.Charts.RenderChart("radar","distribute_bygroupparticipate",e.result,"",10,g.chartBygroupparticipate)};v.setByGroupTechSupportChart=function(e,t){g.chartBygrouptechsupport=ECharts.Charts.InitChart("chart_"+t);g.loadingChart=true;if(e.result.length<=0){document.getElementById("chart_"+t).innerHTML='<p class="chart_data_none">暂无数据</p>';return}g.chartBygrouptechsupport=ECharts.Charts.RenderChart("radar","distribute_bygrouptechsupport",e.result,"",10,g.chartBygrouptechsupport)};v.setByGroupHelpcenterChart=function(e,t){g.chartBygrouphelpcenter=ECharts.Charts.InitChart("chart_"+t);g.loadingChart=true;if(e.result.length<=0){document.getElementById("chart_"+t).innerHTML='<p class="chart_data_none">暂无数据</p>';return}g.chartBygrouphelpcenter=ECharts.Charts.RenderChart("bar","distribute_bygrouphelpcenter",e.result,"",10,g.chartBygrouphelpcenter,true)};v.setByIncrementalChart=function(e,t){g.chartByincremental=ECharts.Charts.InitChart("chart_"+t);g.loadingChart=true;if(e.result.length<=0){document.getElementById("chart_"+t).innerHTML='<p class="chart_data_none">暂无数据</p>';return}g.chartByincremental=ECharts.Charts.RenderChart("bar","customer_analyse_incremental",e.result,"",12,g.chartByincremental,true)};v.setByCustomerHelpcenterChart=function(e,t){g.chartByhelpcenter=ECharts.Charts.InitChart("chart_"+t);g.loadingChart=true;if(e.result.length<=0){document.getElementById("chart_"+t).innerHTML='<p class="chart_data_none">暂无数据</p>';return}g.chartByhelpcenter=ECharts.Charts.RenderChart("bar","helpcenter",e.result,"",12,g.chartByhelpcenter,true)};v.setByUsergroupChart=function(e,t){g.chartByusergroup=ECharts.Charts.InitChart("chart_"+t);g.loadingChart=true;if(e.result.length<=0){document.getElementById("chart_"+t).innerHTML='<p class="chart_data_none">暂无数据</p>';return}g.chartByusergroup=ECharts.Charts.RenderChart("pie","customer_analyse_byusergroup",e.result,"",null,g.chartByusergroup)};v.setByUsergroupScaleChart=function(e,t){g.chartByusergroupscale=ECharts.Charts.InitChart("chart_"+t);g.loadingChart=true;if(e.result.length<=0){document.getElementById("chart_"+v.chartPosition).innerHTML='<p class="chart_data_none">暂无数据</p>';return}g.chartByusergroupscale=ECharts.Charts.RenderChart("pie","customer_analyse_byusergroupscale",e.result,"",null,g.chartByusergroupscale)};v.setByRequestCountChart=function(e,t){g.chartByrequestcount=ECharts.Charts.InitChart("chart_"+t);g.loadingChart=true;if(e.result.length<=0){document.getElementById("chart_"+t).innerHTML='<p class="chart_data_none">暂无数据</p>';return}g.chartByrequestcount=ECharts.Charts.RenderChart("bar","request_count_bycustomer",e.result,"",10,g.chartByrequestcount)};v.setByHelpcenterCountChart=function(e,t){g.chartByhelpcentercount=ECharts.Charts.InitChart("chart_"+t);g.loadingChart=true;if(e.result.length<=0){document.getElementById("chart_"+t).innerHTML='<p class="chart_data_none">暂无数据</p>';return}g.chartByhelpcentercount=ECharts.Charts.RenderChart("bar","helpcenter_count_bycustomer",e.result,"",10,g.chartByhelpcentercount,true)};v.setByGoodCountChart=function(e,t){g.chartBygoodcount=ECharts.Charts.InitChart("chart_"+t);g.loadingChart=true;if(e.result.length<=0){document.getElementById("chart_"+t).innerHTML='<p class="chart_data_none">暂无数据</p>';return}g.chartBygoodcount=ECharts.Charts.RenderChart("bar","good_count_bycustomer",e.result,"",10,g.chartBygoodcount)};v.setByPoorCountChart=function(e,t){g.chartBypoorcount=ECharts.Charts.InitChart("chart_"+t);g.loadingChart=true;if(e.result.length<=0){document.getElementById("chart_"+t).innerHTML='<p class="chart_data_none">暂无数据</p>';return}g.chartBypoorcount=ECharts.Charts.RenderChart("bar","poor_count_bycustomer",e.result,"",10,g.chartBypoorcount)};v.setByRequestCountGroupChart=function(e,t){g.chartByrequestcount=ECharts.Charts.InitChart("chart_"+t);g.loadingChart=true;if(e.result.length<=0){document.getElementById("chart_"+t).innerHTML='<p class="chart_data_none">暂无数据</p>';return}g.chartByrequestcount=ECharts.Charts.RenderChart("bar","request_count_byusergroup",e.result,"",10,g.chartByrequestcount)};v.setByHelpcenterCountGroupChart=function(e,t){g.chartByhelpcentercount=ECharts.Charts.InitChart("chart_"+t);g.loadingChart=true;if(e.result.length<=0){document.getElementById("chart_"+t).innerHTML='<p class="chart_data_none">暂无数据</p>';return}g.chartByhelpcentercount=ECharts.Charts.RenderChart("bar","helpcenter_count_byusergroup",e.result,"",10,g.chartByhelpcentercount,true)};v.setByGoodCountGroupChart=function(e,t){g.chartBygoodcount=ECharts.Charts.InitChart("chart_"+t);g.loadingChart=true;if(e.result.length<=0){document.getElementById("chart_"+t).innerHTML='<p class="chart_data_none">暂无数据</p>';return}g.chartBygoodcount=ECharts.Charts.RenderChart("bar","good_count_byusergroup",e.result,"",10,g.chartBygoodcount)};v.setByPoorCountGroupChart=function(e,t){g.chartBypoorcount=ECharts.Charts.InitChart("chart_"+t);g.loadingChart=true;if(e.result.length<=0){document.getElementById("chart_"+t).innerHTML='<p class="chart_data_none">暂无数据</p>';return}g.chartBypoorcount=ECharts.Charts.RenderChart("bar","poor_count_byusergroup",e.result,"",10,g.chartBypoorcount)};v.setByIntegralChart=function(e,t){g.chartByintegral=ECharts.Charts.InitChart("chart_"+t);g.loadingChart=true;if(e.result.length<=0){document.getElementById("chart_"+t).innerHTML='<p class="chart_data_none">暂无数据</p>';return}e.result.sort(function(e,t){return t.value-e.value});var i=[];if(e.result.length>=8){i=e.result.slice(0,8)}else{i=e.result}i.sort(function(e,t){return e.value-t.value});g.chartByintegral=ECharts.Charts.RenderChart("h-bar","customer_integral",i,"",null,g.chartByintegral)};d()}function t(){return{restrict:"EA",replace:true,scope:{chartposition:"=",charttype:"=",deletetemplte:"&",loaddashboardinfo:"&",dashboardinfo:"=",positionid:"="},controllerAs:"vm",bindToController:true,controller:"dashboardChartController",templateUrl:"/source/scripts/directives/dashboard-chart/dashboard-chart.html"}}})();!function(e){e.module("com.ewei.angular.ui").controller("commonHeaderController",t).service("commonHeaderService",i).directive("commonHeader",r);t.$inject=["$scope","ConsoleConfig","$state","$location","coreModelService","$modal_","$http","alertService"];function t(t,e,i,r,n,a,o,s){var l=this;l.providerDomain=e.providerHelpCenterUrl;l.clickCommonHeader=function(e){l.activeObj={quickentry:false,dashboard:false};l.activeObj[e]=true;if(e=="quickentry"){i.go("quickentry",null,{reload:true});n.config.route.put("mainPanel","quickentry")}else{i.go("dashboard.home",null,{reload:true});n.config.route.put("mainPanel","dashboard")}};l.providerDomain=e.providerHelpCenterUrl;t.shareDiv=l.shareDiv={show:true,span:"分享到",url:l.providerDomain+"/",text:"我们全新的客服系统已经上线了。新的帮助中心网址："+l.providerDomain+"/"};var c;l.showShareDiv=function(){_hmt.push(["_trackEvent","新手向导","通知客户"]);c=a({scope:t,contentTemplate:"/source/views/notify_and_share.html",html:true,show:true,placement:"center"});t.hideModal=function(){c.$promise.then(c.hide)};t.email={};t.email.subject=e.provider.name+"客服系统开通啦";t.email.content="非常高兴地通知你，我们全新的客服系统已经上线了。新的帮助中心网址如下：\r\n\r\n"+l.shareDiv.url+"\r\n\r\n期待您的光临。";t.sendNotifyEmail=function(){_hmt.push(["_trackEvent","通知客户","发送"]);t.email.customerEmails=t.email.customerEmails.replace(/\r/gi,"").replace(/\n/gi,";").replace(/ /gi,";").replace(/；/gi,";").replace(/、/gi,";").replace(/,/gi,";").replace(/，/gi,";").replace(/\//gi,";");o.post("notify_to_customer.json",t.email).success(function(e){if(e.success){s.add("通知邮件发送成功","success");t.hideModal()}else{s.add("通知邮件发送失败！","danger")}})};t.hideBlack=function(){_hmt.push(["_trackEvent","通知客户","取消"])}};function u(){l.activeObj={quickentry:false,dashboard:false};if(n.config.route.get("mainPanel")){if(r.path()=="/manage"){l.activeObj["quickentry"]=true}else if(n.config.route.get("mainPanel")=="quickentry"){i.go("quickentry");l.activeObj["quickentry"]=true}else{i.go("dashboard.home");l.activeObj["dashboard"]=true}}else{if(r.path()=="/dashboard"){l.activeObj["dashboard"]=true}else{l.activeObj["quick_entry"]=true}}}u()}i.$inject=[];function i(){}r.$inject=[];function r(){return{restrict:"EA",replace:true,scope:{},templateUrl:"/source/scripts/directives/ewei-common-header/header.html",controller:t,controllerAs:"vm"}}}(angular);!function(e){"use strict";e.module("com.ewei.angular.ui").controller("searchComponentController",t).directive("searchComponent",i);t.$inject=[];function t(){}i.$inject=[];function i(){return{restrict:"EA",templateUrl:"/source/scripts/directives/search-component/search-component.html",controller:"searchComponentController",scope:{searchkey:"=",placeholderval:"=",searchmethods:"&",clearSearch:"&"}}}}(angular);!function(e){e.module("com.ewei.angular.ui").controller("eweiTableNewController",t).directive("eweiTableNew",i);t.$inject=[];function t(){}i.$inject=[];function i(){return{restrict:"E",transclude:true,replace:true,link:function(e,t,i){e.hideTitle=i.hideTitle},templateUrl:"source/scripts/directives/eweitable/eweitable.html",controller:"eweiTableNewController"}}}(angular);(function(){"use strict";angular.module("com.ewei.angular.ui").directive("customFieldJurisdiction",t).controller("customFieldJurisdictionController",e);e.$inject=["$http","$stateParams","ConsoleConfig","$scope"];function e(e,t,i,n){var a=this;a.hasMore=true;r();function r(){o()}function o(){e({url:"/api/v1/fieldpermission/"+t.id+".json",method:"GET",params:{_token:getCookie("user_token"),provider_id:i.provider.id}}).success(function(e,t,i,r){if(e.result){if(e.result.length<=5){a.hasMore=false}a.roleJurisdictionList=e.result.slice(0,5);a.allRoleJurisdictionList=e.result;n.fieldPermissions=a.allRoleJurisdictionList}})}a.editAble=function(e){if(e.edit_able){e.scan_able=1}};a.scanAble=function(e){if(!e.scan_able){e.edit_able=0}};a.showMore=function(){a.roleJurisdictionList=a.allRoleJurisdictionList;a.hasMore=false}}function t(){return{restrict:"EA",replace:true,controllerAs:"vm",controller:"customFieldJurisdictionController",templateUrl:"/source/scripts/directives/custom-field-jurisdiction/custom-field-jurisdiction.html"}}})();angular.module("com.ewei.angular.ui").controller("eweiCarouselController",["$scope","$element","$interval","$animate",function(r,t,i,n){var a=this,o=a.slides=r.slides=[],s=angular.version.minor>=4,l="uib-noTransition",c="uib-slideDirection",u=-1,d,f;a.currentSlide=null;var p=false;a.select=r.select=function(e,t){var i=r.indexOfSlide(e);if(t===undefined){t=i>a.getCurrentIndex()?"next":"prev"}if(e&&e!==a.currentSlide&&!r.$currentTransition){m(e,i,t)}};function m(e,t,i){if(p){return}angular.extend(e,{direction:i,active:true});angular.extend(a.currentSlide||{},{direction:i,active:false});if(n.enabled()&&!r.noTransition&&!r.$currentTransition&&e.$element&&a.slides.length>1){e.$element.data(c,e.direction);if(a.currentSlide&&a.currentSlide.$element){a.currentSlide.$element.data(c,e.direction)}r.$currentTransition=true;if(s){n.on("addClass",e.$element,function(e,t){if(t==="close"){r.$currentTransition=null;n.off("addClass",e)}})}else{e.$element.one("$animate:close",function e(){r.$currentTransition=null})}}a.currentSlide=e;u=t;g()}r.$on("$destroy",function(){p=true});function h(e){if(angular.isUndefined(o[e].index)){return o[e]}var t,i=o.length;for(t=0;t<o.length;++t){if(o[t].index==e){return o[t]}}}a.getCurrentIndex=function(){if(a.currentSlide&&angular.isDefined(a.currentSlide.index)){return+a.currentSlide.index}return u};r.indexOfSlide=function(e){return angular.isDefined(e.index)?+e.index:o.indexOf(e)};r.next=function(){var e=(a.getCurrentIndex()+1)%o.length;if(e===0&&r.noWrap()){r.pause();return}return a.select(h(e),"next")};r.prev=function(){var e=a.getCurrentIndex()-1<0?o.length-1:a.getCurrentIndex()-1;if(r.noWrap()&&e===o.length-1){r.pause();return}return a.select(h(e),"prev")};r.isActive=function(e){return a.currentSlide===e};r.$watch("interval",g);r.$watchCollection("slides",e);r.$on("$destroy",v);function g(){v();var e=+r.interval;if(!isNaN(e)&&e>0){d=i(k,e)}}function v(){if(d){i.cancel(d);d=null}}function k(){var e=+r.interval;if(f&&!isNaN(e)&&e>0&&o.length){r.next()}else{r.pause()}}function e(e){if(!e.length){r.$currentTransition=null}}r.play=function(){if(!f){f=true;g()}};r.pause=function(){if(!r.noPause){f=false;v()}};a.addSlide=function(e,t){e.$element=t;o.push(e);if(o.length===1||e.active){a.select(o[o.length-1]);if(o.length===1){r.play()}}else{e.active=false}};a.removeSlide=function(e){if(angular.isDefined(e.index)){o.sort(function(e,t){return+e.index>+t.index})}var t=o.indexOf(e);o.splice(t,1);if(o.length>0&&e.active){if(t>=o.length){a.select(o[t-1])}else{a.select(o[t])}}else if(u>t){u--}if(o.length===0){a.currentSlide=null}};r.$watch("noTransition",function(e){t.data(l,e)})}]).directive("eweiCarousel",[function(){return{transclude:true,replace:true,controller:"eweiCarouselController",controllerAs:"carousel",require:"carousel",templateUrl:function(e,t){return t.templateUrl||"/source/scripts/directives/ewei-carousel/ewei-carousel.html"},scope:{interval:"=",noTransition:"=",noPause:"=",noWrap:"&"}}}]).directive("eweiSlide",function(){return{require:"^eweiCarousel",restrict:"EA",transclude:true,replace:true,templateUrl:function(e,t){return t.templateUrl||"/source/scripts/directives/ewei-carousel/ewei-slide.html"},scope:{active:"=?",actual:"=?",index:"=?"},link:function(t,e,i,r){r.addSlide(t,e);t.$on("$destroy",function(){r.removeSlide(t)});t.$watch("active",function(e){if(e){r.select(t)}})}}}).animation(".item",["$injector","$animate",function(e,s){var l="uib-noTransition",c="uib-slideDirection",u=null;if(e.has("$animateCss")){u=e.get("$animateCss")}function d(e,t,i){e.removeClass(t);if(i){i()}}return{beforeAddClass:function(e,t,i){if(t=="active"&&e.parent()&&e.parent().parent()&&!e.parent().parent().data(l)){var r=false;var n=e.data(c);var a=n=="next"?"left":"right";var o=d.bind(this,e,a+" "+n,i);e.addClass(n);if(u){u(e,{addClass:a}).start().done(o)}else{s.addClass(e,a).then(function(){if(!r){o()}i()})}return function(){r=true}}i()},beforeRemoveClass:function(e,t,i){if(t==="active"&&e.parent()&&e.parent().parent()&&!e.parent().parent().data(l)){var r=false;var n=e.data(c);var a=n=="next"?"left":"right";var o=d.bind(this,e,a,i);if(u){u(e,{addClass:a}).start().done(o)}else{s.addClass(e,a).then(function(){if(!r){o()}i()})}return function(){r=true}}i()}}}]);(function(l){"use strict";l.module("com.ewei.angular.ui").directive("layDate",["$timeout",function(e){return{require:"?ngModel",restrict:"A",scope:{ngModel:"=",istime:"="},link:function(n,a,o,s){e(function(){var e=null;var t={};var i=a[0].id?a[0].id:Date.parse(new Date);if(!a[0].id){a[0].id=i}t={elem:"#"+i,format:o.format!=undefined&&o.format!=""?o.format:"YYYY/MM/DD hh:mm:ss",istime:l.isDefined(n.istime)?n.istime:true,isclear:false,istoday:false,choose:function(e){n.$apply(r)}};e=laydate(t);s.$render=function(){a.val(s.$viewValue||"")};a.on("change",function(){n.$apply(r)});function r(){var e=a.val();s.$setViewValue(e)}})}}}])})(angular);(function(e){"use strict";e.module("com.ewei.angular.ui").directive("ticketEvaluateSolvedShow",t).directive("ticketEvaluateScoreShow",i);t.$inject=[];function t(){return{restrict:"E",scope:{value:"@",solveds:"="},template:"",link:function(e,t,i){if(e.value==null||e.value==""){t.html("");return}if(undefined!=e.solveds){var r=e.solveds.length;for(var n=0;n<r;n++){if(e.solveds[n].value==e.value){t.html(e.solveds[n].name);break}}}}}}i.$inject=[];function i(){return{restrict:"E",scope:{value:"@",scores:"="},template:"",link:function(e,t,i){if(e.value==null||e.value==""){t.html("");return}if(undefined!=e.scores){var r=e.scores.length;for(var n=0;n<r;n++){if(e.scores[n].value==e.value){t.html(e.scores[n].name);break}}}}}}})(angular);angular.module("com.ewei.angular.ui").controller("ticketAdvancedController",["$scope","ticketEvaluateService",function(t,e){t.$watch("advancedQueryCondition.status",function(){if(t.advancedQueryCondition.status==""){t.advancedQueryCondition.status=null}});t.$watch("advancedQueryCondition.solved",function(){if(t.advancedQueryCondition.solved==""){t.advancedQueryCondition.solved=null}});t.$watch("advancedQueryCondition.score",function(){if(t.advancedQueryCondition.score==""){t.advancedQueryCondition.score=null}});t.$watch("advancedQueryCondition.deleteReason",function(){if(t.advancedQueryCondition.deleteReason==""){t.advancedQueryCondition.deleteReason=null}});t.$watch("advancedQueryCondition.serviceDesk",function(){if(t.advancedQueryCondition.serviceDesk==""){t.advancedQueryCondition.serviceDesk=null}});t.$watch("advancedQueryCondition.engineer",function(){if(t.advancedQueryCondition.engineer==""){t.advancedQueryCondition.engineer=null}});t.$watch("advancedQueryCondition.via",function(){if(t.advancedQueryCondition.via==""){t.advancedQueryCondition.via=null}});t.$watch("advancedQueryCondition.user",function(){if(t.advancedQueryCondition.user==""){t.advancedQueryCondition.user=null}});t.$watch("advancedQueryCondition.userGroup",function(){if(t.advancedQueryCondition.userGroup==""){t.advancedQueryCondition.userGroup=null}});t.systemFieldPriority={};t.systemFieldServiceCatalog={};t.systemFieldTicketType={};if(localStorage){t.systemFieldPriority=angular.fromJson(localStorage["systemFieldPriority"]);t.systemFieldServiceCatalog=angular.fromJson(localStorage["systemFieldServiceCatalog"]);t.systemFieldTicketType=angular.fromJson(localStorage["systemFieldTicketType"])}var i=function(){e.run(false,function(e){t.evaluate={solveds:[],scores:[]};t.evaluate.solveds=e.firstQuestionOptions;t.evaluate.scores=[{name:"1分",value:"1"},{name:"2分",value:"2"},{name:"3分",value:"3"},{name:"4分",value:"4"},{name:"5分",value:"5"}]})};i()}]).directive("ticketAdvancedQuery",function(){return{restrict:"E",transclude:true,replace:true,templateUrl:"/source/scripts/directives/ticket-advanced-query/ticket-advanced-query.html",controller:"ticketAdvancedController"}});angular.module("com.ewei.angular.ui").controller("userAdvancedController",["$scope",function(e){e.$watch("advancedQueryCondition.userGroup",function(){if(e.advancedQueryCondition.userGroup==""){e.advancedQueryCondition.userGroup=null}});e.$watch("advancedQueryCondition.phone",function(){if(e.advancedQueryCondition.phone==""){e.advancedQueryCondition.phone=null}});e.$watch("advancedQueryCondition.mobilePhone",function(){if(e.advancedQueryCondition.mobilePhone==""){e.advancedQueryCondition.mobilePhone=null}});e.$watch("advancedQueryCondition.email",function(){if(e.advancedQueryCondition.email==""){e.advancedQueryCondition.email=null}});e.$watch("advancedQueryCondition.nickname",function(){if(e.advancedQueryCondition.nickname==""){e.advancedQueryCondition.nickname=null}});e.$watch("advancedQueryCondition.name",function(){if(e.advancedQueryCondition.name==""){e.advancedQueryCondition.name=null}})}]).directive("userAdvancedQuery",function(){return{restrict:"E",transclude:true,replace:true,templateUrl:"source/scripts/directives/user-advanced-query/user-advanced-query.html",controller:"userAdvancedController"}});angular.module("com.ewei.angular.ui").controller("engineerAdvancedController",["$scope",function(t){t.advancedQueryCondition={};org.ewei.sdk.OpenServiceDeskApi().listServiceDesk({page:{pageNumber:1,pageSize:9999},key:""}).then(function(e){t.serviceDesks=e.list});org.ewei.sdk.OpenEngineerApi().listRole({}).then(function(e){t.roles=e.list})}]).directive("engineerAdvancedQuery",function(){return{restrict:"E",transclude:true,replace:true,templateUrl:"/source/scripts/directives/engineer-advanced-query/engineer-advanced-query.html",controller:"engineerAdvancedController"}});angular.module("com.ewei.angular.ui").controller("chatAdvancedController",["$scope","ChatEvaluateConfig",function(r,e){r.evaluate=e;function t(e,t){return[{label:"-",value:undefined},{label:e,value:true},{label:t,value:false}]}r.autoCloseOptions=t("是","否");r.evaluationOptions=t("已评价","未评价");r.solvedOptions=t(e.firstQuestionOptions[0].name,e.firstQuestionOptions[1].name);r.qualityScoreOptions=t("已质检","未质检");r.$watch("advancedQueryCondition.serviceDesk",function(){if(r.advancedQueryCondition.serviceDesk==""){r.advancedQueryCondition.serviceDesk=null}});r.$watch("advancedQueryCondition.engineer",function(){if(r.advancedQueryCondition.engineer==""){r.advancedQueryCondition.engineer=null}});r.$watch("advancedQueryCondition.via",function(){if(r.advancedQueryCondition.via==""){r.advancedQueryCondition.via=null}});r.$watch("advancedQueryCondition.user",function(){if(r.advancedQueryCondition.user==""){r.advancedQueryCondition.user=null}});r.$on("selectedServiceCatalog",function(e,t,i){r.advancedQueryCondition.serviceCatalogNameChain=i});r.systemFieldPriority={};r.systemFieldServiceCatalog={};r.systemFieldTicketType={};if(localStorage){r.systemFieldPriority=angular.fromJson(localStorage["systemFieldPriority"]);r.systemFieldServiceCatalog=angular.fromJson(localStorage["systemFieldServiceCatalog"]);r.systemFieldTicketType=angular.fromJson(localStorage["systemFieldTicketType"])}}]).directive("chatAdvancedQuery",function(){return{restrict:"E",transclude:true,replace:true,templateUrl:"/source/scripts/directives/chat-advanced-query/chat-advanced-query.html",controller:"chatAdvancedController"}});angular.module("com.ewei.angular.ui").controller("serviceDeskSelectController",["$scope","$filter","serviceDeskService","ConsoleConfig","$http",function(n,i,t,a,o){n.serviceDesks=[];n.pageNum=1;n.currentServiceDesk={name:"（当前客服所在客服组）",id:"${current_servicedesk_ids}"};n.loadData=function(i,r){var e={_page:n.pageNum,_count:19,_do_count:false,_fields:"id,name",_asc:"name"};if(i){e._key=i}o({method:"GET",url:"/api/v1/service_desks.json?provider_id="+a.provider.id+"&_token="+getCookie("user_token")+"&_count=20&_do_count=false&_fields=id,name&_page="+n.pageNum+"&key="+i}).success(function(e){if(r==="search"){n.serviceDesks=e.result.serviceDesks;if(n.serviceDesks.indexOf(n.currentServiceDesk)===-1&&!i&&n.type!="automation"){n.serviceDesks.unshift(n.currentServiceDesk)}}else{n.serviceDesks=n.serviceDesks.concat(e.result.serviceDesks);if(n.serviceDesks.indexOf(n.currentServiceDesk)!=-1&&i){n.serviceDesks.splice(n.serviceDesks.indexOf(n.currentServiceDesk),1)}}for(var t=0;t<n.serviceDesks.length;t++){if(n.serviceDesks[t].name==="DEFAULT_SERVICE_DESK_NAME"){n.serviceDesks[t].name="默认服务台"}}})};n.loadServiceDeskById=function(){if(n.selectedservicedesk==="${current_servicedesk_ids}"||n.selectedservicedesk&&n.selectedservicedesk.id==="${current_servicedesk_ids}"){n.lastSelectedServiceDeskName="（当前客服所在客服组）";n.selectedServiceDeskName="（当前客服所在客服组）"}else{var e=null;if(typeof n.selectedservicedesk==="object"){e=n.selectedservicedesk.id}else{e=n.selectedservicedesk}t.query({id:e},function(e){var t=e.json;if(t.name=="DEFAULT_SERVICE_DESK_NAME"){t.name=i("translate")(t.name)}n.lastSelectedServiceDeskName=t.name;n.selectedServiceDeskName=t.name})}};n.selectServiceDesk=function(e){if(e){n.selectedservicedesk=angular.copy(e);n.selectedServiceDeskName=e.name;n.lastSelectedServiceDeskName=n.selectedServiceDeskName}else{n.selectedservicedesk=null;n.selectedServiceDeskName=null;n.lastSelectedServiceDeskName=null}};n.lastSelectedServiceDeskName="";n.focus=function(){if(!n.isOpen){n.lastSelectedServiceDeskName=n.selectedServiceDeskName;n.selectedServiceDeskName=""}n.serviceDesks=[]};n.blur=function(){if(n.isOpen){n.selectedServiceDeskName=n.lastSelectedServiceDeskName}n.pageNum=1};n.$watch("selectedServiceDeskName",function(){if(n.lastSelectedServiceDeskName!=n.selectedServiceDeskName){n.pageNum=1;if(!angular.isUndefined(n.selectedServiceDeskName)){n.loadData(n.selectedServiceDeskName,"search")}}});if(n.selectedservicedesk){n.loadServiceDeskById()}n.loadData("","search")}]).directive("serviceDeskSelect",[function(){return{restrict:"EA",replace:true,templateUrl:"/source/scripts/directives/service-desk-select/service-desk-select.html",controller:"serviceDeskSelectController",scope:{selectedservicedesk:"=",type:"@"},link:function(i,e,t,r){var n=e.find("ul");var a=e.find("input");var o=1;n.on("scroll",function(e,t){if(n[0].scrollTop===n[0].scrollHeight-n[0].clientHeight){++i.pageNum;if(i.selectedServiceDeskName){i.loadData(i.selectedServiceDeskName,"add")}else{i.loadData("","add")}}});a.on("focus",function(e,t){if(i.isOpen){a.blur()}})}}}]);angular.module("com.ewei.angular.ui").controller("serviceDeskMutilSelect",["$scope","$http","alertService","apiRestfulService","ConsoleConfig",function(i,r,e,t,n){var a;var o=40;i.loadTags=function(e){var t="/api/v1/service_desks.json?provider_id="+n.provider.id+"&_token="+getCookie("user_token")+"&_count="+o+"&_do_count=false&_fields=id,name&_page=1&key="+e;return r.get(t).then(function(e){if(e.data&&e.data.result&&e.data.result.serviceDesks){a=e.data.result.serviceDesks;a=s(a);return a?a:[]}})};i.tagAdded=function(e){i.selectedservicedesk=i.selectedservicedesk||[];i.selectedservicedesk.push(e)};i.tagRemoved=function(e){for(var t=0;t<i.selectedservicedesk.length;t++){if(i.selectedservicedesk[t].id===e.id){i.selectedservicedesk.splice(t,1);break}}};i.validateTag=function(t){if(!t.id){return false}var e=_.find(i.tags,function(e){return e.id===t.id});if(e&&e.name!==t.name){e.name=t.name;return false}};i.$watch("selectedservicedesk",function(e){if(e&&e.length>0){i.selectedservicedesk=s(i.selectedservicedesk);i.tags=angular.copy(i.selectedservicedesk)}});function s(e){for(var t=0;t<e.length;t++){if(e[t].name==="DEFAULT_SERVICE_DESK_NAME"){e[t].name="默认服务台";break}}return e}}]).directive("serviceDeskMutilSelect",[function(){return{restrict:"EA",templateUrl:"/source/scripts/directives/service-desk-mutil-select/service-desk-mutil-select.html",controller:"serviceDeskMutilSelect",scope:{selectedservicedesk:"="}}}]);(function(r){angular.module("com.ewei.angular.ui").controller("viaSelectController",["$scope","$http","license",function(a,e,t){a.license=t;a.loadVias=function(){if(a.viatype&&a.viatype==="chat"){r.sdk.OpenChannelApi().listChatChannel({}).then(function(e){i(e)})}else{r.sdk.OpenChannelApi().listTicketChannel({}).then(function(e){i(e)})}};var i=function(e){var t={console:{channel:"console",via_type:"console",via_count:0,vias:[]},web:{channel:"web",via_type:"web",via_count:0,vias:[]},helpcenter:{channel:"helpcenter",via_type:"helpcenter",via_count:0,vias:[]},phone:{channel:"phone",via_type:"phone",via_count:0,vias:[]},weixin:{channel:"weixin",via_type:"weixin",via_count:0,vias:[]},email:{channel:"email",via_type:"email",via_count:0,vias:[]},sdk:{channel:"sdk",via_type:"sdk",via_count:0,vias:[]},dingding:{channel:"dingding",via_type:"dingding",via_count:0,vias:[]},yunzhijia:{channel:"yunzhijia",via_type:"yunzhijia",via_count:0,vias:[]},api:{channel:"api",via_type:"api",via_count:0,vias:[]}};a.viass=[];angular.forEach(e,function(e){t[e.via_type].vias.push(e);t[e.via_type].via_count++;delete e.via_type});for(var i in t){var r=t[i];if(r!=null){if(r.via_type=="API"){var n=r.vias;if(n==null){n=[]}n.unshift({name:"易维-WEB-移动"});n.unshift({name:"易维-Android"});n.unshift({name:"易维-IOS"});r.vias=n;r.via_count=n.length}if(a.selectedtype!=null&&a.selectedtype==r.via_type){a.vias=r.vias;a.catSelected=true;a.showViaTypeList=true}a.viass.push(r)}}if(a.selectedtype==null){a.showViaTypeList=true}};a.back=function(e){a.showViaTypeList=true;a.isopen=true;if(a.viass==null){a.loadVias()}e.stopPropagation()};a.clear=function(){a.selectedtype="";a.selectedvia="";a.selectedchannel="";a.catSelected=false;a.showViaTypeList=true;if(a.viass==null){a.loadVias()}};a.selectParentVia=function(e,t){a.parentVia=e;a.vias=e.vias;a.showViaTypeList=false;a.isopen=true;t.stopPropagation()};a.selectViaType=function(e){a.selectedtype=a.parentVia.via_type;a.selectedchannel=a.parentVia.channel;a.selectedvia={};a.showViaTypeList=false;a.catSelected=true;a.isopen=false};a.selectVia=function(e){a.selectedtype=a.parentVia.via_type;a.selectedchannel=a.parentVia.channel;a.selectedvia=e;a.showViaTypeList=false;a.catSelected=true};a.$watch("selectedvia",function(){if(a.selectedvia==null){a.catSelected=false;a.showViaTypeList=true}});a.loadVias();a.click=function(){a.showViaTypeList=true}}]).directive("viaSelect",function(){return{restrict:"E",replace:true,scope:{selectedtype:"=",selectedchannel:"=",selectedvia:"=",viatype:"="},controller:"viaSelectController",templateUrl:"/source/scripts/directives/via-select/via-select.html"}})})(org.ewei);angular.module("com.ewei.angular.ui").controller("chartToolBarController",["$rootScope","$scope","$http","$filter","$location","ConsoleConfig","serviceDesks","alertService",function(c,u,e,n,d,t,i,f){if(angular.isUndefined(c.chartSelectTime)){u.chartSelectTime={id:2}}else{u.chartSelectTime=c.chartSelectTime}u.chartSelectTimeValue=[{id:1,name:"最近30天"},{id:2,name:"最近7天"},{id:3,name:"最近24小时"},{id:4,name:"自定义"}];u.selectedHandle="0";e({url:"/service_desk.json?_asc=name&_count=999&_do_count=false&_fields=id,name&filter={'$and':{'deleted':false}}",method:"GET"}).success(function(e,t,i,r){if(e.serviceDesks&&e.serviceDesks.length>0){u.chartServiceDeskIsShow=true;if(location.href.indexOf("performance")<0){u.chartServiceDeskIsShow=false}u.chartServiceDeskValue=e.serviceDesks;u.chartServiceDesk={id:0,name:"全部客服组"};for(var n=0;n<u.chartServiceDeskValue.length;n++){if(u.chartServiceDeskValue[n].name=="DEFAULT_SERVICE_DESK_NAME"){u.chartServiceDeskValue[n].name="默认服务台";break}}u.chartServiceDeskValue.unshift({id:0,name:"全部客服组"})}});u.changeQueryServiceDesks=function(){if(u.chartServiceDesk.id!=0){u.chartEngineerValue=[];e({url:"/serviceDesks/"+u.chartServiceDesk.id+"/enginners.json",method:"GET"}).success(function(e,t,i,r){if(e.success&&e.json&&e.json.length>0){var n=e.json;for(var a=0;a<n.length;a++){var o={};if(n[a].name==""||n[a].name==null||n[a].name==undefined){if(n[a].nickname||n[a].nickname==null||n[a].nickname==undefined){o.name=n[a].eamil}else{o.name=n[a].nickname}}else{o.name=n[a].name}o.id=n[a].id;u.chartEngineerValue.push(o)}u.chartEngineerIsShow=true;u.chartEngineer={id:0,name:"全部客服"};u.chartEngineerValue.unshift({id:0,name:"全部客服"})}else{u.chartEngineerIsShow=false;u.chartEngineer={id:""};u.selectedHandle="0"}})}else{u.chartEngineerIsShow=false;u.chartEngineer={id:""};u.selectedHandle="0"}};u.changeQueryDate=function(){c.chartSelectTime=u.chartSelectTime;u.chartEngineerIsShow=false;u.chartServiceDesk={id:0};var e=u.chartSelectTime.id;var t=new Date;var i=n("date")(t,"yyyy/MM/dd 23:59:59");if(e==1){t.setMonth(t.getMonth()-1)}else if(e==2){t.setDate(t.getDate()-7)}else if(e==3){t.setDate(t.getDate()-1)}else{if(angular.isUndefined(c.chartSelectedDate)){var r=n("date")(t,"yyyy/MM/dd");u.chartSelectedDate={begin:r,end:r}}else{u.chartSelectedDate=c.chartSelectedDate}u.chartSelectTimeIsShow=true}if(e==1||e==2||e==3){u.endDate=i;u.startDate=n("date")(t,"yyyy/MM/dd 00:00:00");u.chartSelectTimeIsShow=false}};u.visible=false;u.changeQueryDate();u.$watch("chartSelectedDate",function(){if(u.chartSelectTime.id==4){u.startDate=n("date")(u.chartSelectedDate.begin,"yyyy/MM/dd");u.endDate=n("date")(u.chartSelectedDate.end,"yyyy/MM/dd");c.chartSelectedDate={begin:u.startDate,end:u.endDate}}},true);u.datepickers={startForm:false,startTo:false,updateFrom:false,updateTo:false};u.open=function(e,t){e.preventDefault();e.stopPropagation();u.datepickers[t]=true};u.queryData=function(){var e=u.startDate;var t=u.endDate;var i="";var r="";var n="";var a="";if(e==""||e==null||e==undefined){f.add("开始时间不能为空","danger");return}if(t==""||t==null||t==undefined){f.add("结束时间不能为空","danger");return}if(e.length==10){e+=" 00:00:00"}if(t.length==10){t+=" 23:59:59"}if(u.chartServiceDeskIsShow){if(u.chartServiceDesk.id!="0"){i=u.chartServiceDesk.id;for(var o=0;o<u.chartServiceDeskValue.length;o++){if(i==u.chartServiceDeskValue[o].id){r=u.chartServiceDeskValue[o].name;break}}}}if(u.chartEngineerIsShow){if(u.chartEngineer.id!=0){n=u.chartEngineer.id;for(var o=0;o<u.chartEngineerValue.length;o++){if(n==u.chartEngineerValue[o].id){a=u.chartEngineerValue[o].name;break}}}}if(u.selectedHandle=="0"){u.createChecked=false;u.responseChecked=false;u.handleChecked=false;u.finishChecked=false;u.reviewChecked=false}else if(u.selectedHandle=="1"){u.createChecked=true;u.responseChecked=false;u.handleChecked=false;u.finishChecked=false;u.reviewChecked=false}else if(u.selectedHandle=="2"){u.responseChecked=true;u.createChecked=false;u.handleChecked=false;u.finishChecked=false;u.reviewChecked=false}else if(u.selectedHandle=="3"){u.handleChecked=true;u.createChecked=false;u.responseChecked=false;u.finishChecked=false;u.reviewChecked=false}else if(u.selectedHandle=="4"){u.finishChecked=true;u.createChecked=false;u.responseChecked=false;u.handleChecked=false;u.reviewChecked=false}else if(u.selectedHandle=="5"){u.finishChecked=false;u.createChecked=false;u.responseChecked=false;u.handleChecked=false;u.reviewChecked=true}var s={begin:e,end:t,serviceDeskId:i,engineerId:n,serviceDeskName:r,engineerName:a,createChecked:u.createChecked,handleChecked:u.handleChecked,finishChecked:u.finishChecked,responseChecked:u.responseChecked,reviewChecked:u.reviewChecked,chartSelectTimeType:u.chartSelectTime.id};var l=d.path();if("/chart/performance/other"==l||"/chart/performance/sla"==l||"/chart/performance/response_time"==l){c.$broadcast("reloadPerformanceRponseTime",s)}else if("/chart/distribute/request_distribute"==l){c.$broadcast("reloadDistributeRequest",s)}else if("/chart/distribute/ticket_prop_distribute"==l){c.$broadcast("reloadDistributeTicketProp",s)}else if("/chart/distribute/top_engineer"==l){c.$broadcast("reloadDistributeTopEngineer",s)}else if("/chart/distribute/top_servicedesk"==l){c.$broadcast("reloadDistributeTopServicedesk",s)}else if("/chart/customer/customer_analyse"==l){c.$broadcast("reloadCustomerAnalyse",s)}else if("/chart/customer/top_customer"==l){c.$broadcast("reloadCustomerTopCustomer",s)}else if("/chart/customer/top_usergroup"==l){c.$broadcast("reloadCustomerTopUsergroup",s)}else if("/chart/customer/customer_integral"==l){c.$broadcast("reloadCustomerIntegral",s)}else{c.$broadcast("reloadPerformanceNumber",s)}};u.visible=false;u.submitCheck=false;u.selectedservicedesk={id:null};u.chartClassSelect={id:null};u.advancedQuery=function(e){u.visible=true;u.changeQueryDate();var t=d.path();var i=u.chartClassSelect.id;if(1==i){u.serviceDeskId=u.selectedservicedesk.id;u.engineerId=null}else if(2==i){u.serviceDeskId=null;u.engineerId=u.selectedengineer.id}else{u.serviceDeskId=null;u.engineerId=null}if(!u.engineerId&&!u.serviceDeskId){u.submitCheck=true;return}angular.element("#myModal").modal("hide");u.submitCheck=false;var r={begin:u.startDate,end:u.endDate,serviceDeskId:u.serviceDeskId,engineerId:u.engineerId,responseChecked:u.chartResponseCheckbox.isChecked,reviewChecked:u.reviewChecked,handleChecked:u.chartDisposeCheckbox.isChecked,finishChecked:u.chartFinishCheckbox.isChecked,chartSelectTimeType:u.chartSelectTime.id};void 0;if("/chart/performance/other"==t){c.$broadcast("reloadPerformanceRponseTime",r)}else{c.$broadcast("reloadPerformanceNumber",r)}};u.chartClassSelect={id:0};u.chartResponseCheckbox={isChecked:false};u.chartDisposeCheckbox={isChecked:false};u.chartFinishCheckbox={isChecked:false};u.chartClearEliminate=function(){u.visible=false;u.chartClassSelect={id:0};u.chartResponseCheckbox.isChecked=false;u.chartDisposeCheckbox.isChecked=false;u.chartFinishCheckbox.isChecked=false;u.serviceDeskId=null;u.engineerId=null;u.queryData()};u.chartClassSelectValue=[{id:0,name:"请选择--"},{id:1,name:"客服组"},{id:2,name:"客服"}];u.downLoadCharts=function(e){var t=d.path();var i={downLoadType:e};if("/chart/performance/number"==t){c.$broadcast("downLoadPerformanceNumber",i)}else if("/chart/performance/other"==t){c.$broadcast("downLoadPerformanceResponse",i)}else if("/chart/distribute/request_distribute"==t){c.$broadcast("exportPdfByRequestDistribute",i)}else if("/chart/distribute/ticket_prop_distribute"==t){c.$broadcast("exportPdfByTicketPropDistribute",i)}else if("/chart/distribute/top_engineer"==t){c.$broadcast("exportPdfByTopEngineer",i)}else if("/chart/distribute/top_servicedesk"==t){c.$broadcast("exportPdfByTopServicedesk",i)}else if("/chart/customer/customer_analyse"==t){c.$broadcast("exportPdfByCustomerAnalyse",i)}else if("/chart/customer/top_customer"==t){c.$broadcast("exportPdfByTopCustomer",i)}else if("/chart/customer/top_usergroup"==t){c.$broadcast("exportPdfByTopUserGroup",i)}else if("/chart/customer/customer_integral"==t){c.$broadcast("exportPdfByCustomerIntegral",i)}else{void 0}};u.filterBuried=function(){_hmt.push(["_trackEvent","新增筛选条件","报表统计"])};u.exportBuried=function(){_hmt.push(["_trackEvent","新增筛选条件","报表统计"])}}]).directive("chartToolBar",function(){return{restrict:"E",replace:true,scope:{showfilter:"@",showexport:"@"},controller:"chartToolBarController",templateUrl:"/source/scripts/directives/chart-tool-bar/chart-tool-bar.html"}});angular.module("com.ewei.angular.ui").controller("chartTicketFieldController",["$scope","$http","ticketListCustomOptions","alertService","$location","$rootScope","serviceCatalogNameService",function(s,r,i,e,n,a,l){t();function t(){r({method:"GET",url:"/search_view/tickets_chart.json"}).success(function(e){if(e.success){if(e.json){s.showDefaultField=false;s.visibleFieldId=e.json.id}else{s.showDefaultField=true}o(e.json)}})}s.setShowColums=function(){s.fieldIsShow=!s.fieldIsShow;var t=0;angular.forEach(s.ticketFields,function(e){if(e.selected){t++}})};s.$watch("fieldIsShow",function(e,t,i){if(t!=undefined&&!s.fieldIsShow){s.saveVisibleCustomField()}});var o=function(o){r({method:"GET",url:"/custom_field.json?scope=ticket&active=true"}).success(function(e){if(e.success&&e.json){s.columns=[];var a={};s.ticketFields=e.json;var t=angular.copy(i);angular.forEach(t,function(e){var t={};if(e.value=="no"){s.ticketFields.push({value:e.value,title:e.option,ischecked:true,selected:true});if(e.value=="no"){t={title:e.option,field:e.value,visible:true,widthClass:"w150"}}else{t={title:e.option,field:e.value,fieldCount:2,field0:"requester",field1:"name",visible:true,widthClass:"w150"}}s.columns.push(t)}else{if(s.showDefaultField){if(e.value=="serviceDesk.name"||e.value=="via.channelName"||e.value=="createdAt"||e.value=="requester.name"){s.ticketFields.push({value:e.value,title:e.option,selected:true});if(e.value=="serviceDesk.name"){t={title:e.option,field:e.value,fieldCount:2,field0:"serviceDesk",field1:"name",visible:true,widthClass:"w150"}}else if(e.value=="via.channelName"){t={title:e.option,field:e.value,fieldCount:2,field0:"via",visible:true,field1:"channelName",widthClass:"w150"}}else if(e.value=="requester.name"){t={title:e.option,field:e.value,fieldCount:2,field0:"requester",visible:true,field1:"name",widthClass:"w150"}}else{t={title:e.option,visible:true,field:e.value}}s.columns.push(t)}else{s.ticketFields.push({value:e.value,title:e.option})}}else{var r=o.fields.split(",");for(var n=0;n<r.length;n++){if(e.value==r[n]){e.selected=true;var i=r[n].split(".");if(i.length==3){t={title:e.option,field:r[n],fieldCount:i.length,field0:i[0],field1:i[1],field2:i[2],visible:true,widthClass:"w150"}}else if(i.length==2){t={title:e.option,field:r[n],fieldCount:i.length,field0:i[0],field1:i[1],visible:true,widthClass:"w150"}}else if(i.length==1){t={title:e.option,field:r[n],visible:true,widthClass:"w150"};if(r[n]=="copyTo"||r[n]=="tags"){s.$on("loadCustomerData",function(e,t){var i=f(t);if(r[n]=="copyTo"){p(i)}else if(r[n]=="tags"){m(i)}})}}s.columns.push(t);break}else{e.selected=false}}s.ticketFields.push({value:e.value,title:e.option,selected:e.selected})}}});angular.forEach(s.ticketFields,function(t){if(t.systemFieldKey!="ticket_description"){var i={};if(t.systemFieldKey&&t.systemFieldKey=="subject"){t.ischecked=true;t.selected=true}if(s.showDefaultField){if(t.systemFieldKey=="priority"||t.systemFieldKey=="subject"){t.selected=true;i={title:t.title,field:t.systemFieldKey,visible:true,widthClass:"w150"};s.columns.push(i)}}else{var e=o.customFields.split(",");angular.forEach(e,function(e){if(t.id==e){t.selected=true;i={title:t.title,field:t.id,fieldCount:"customFields",visible:true,widthClass:"w150"};s.columns.push(i)}});if(t.systemFieldKey=="status"||t.systemFieldKey=="subject"||t.systemFieldKey=="priority"||t.systemFieldKey=="tags"){var r=o.fields.split(",");for(var n=0;n<r.length;n++){if(t.systemFieldKey==r[n]){t.selected=true;i={title:t.title,field:t.systemFieldKey,visible:true,widthClass:"w150"};s.columns.push(i);break}}if(t.systemFieldKey=="tags"){s.$on("loadCustomerData",function(e,t){var i=f(t);m(i)})}}else if(t.systemFieldKey=="service_catalog"){var r=o.fields.split(",");for(var n=0;n<r.length;n++){if("serviceCatalog.id"==r[n]){t.selected=true;i={title:t.title,field:"serviceCatalog.id",fieldCount:2,field0:"serviceCatalog",field1:"id",visible:true,widthClass:"w150"};s.columns.push(i);l.run("",{deleted:true},false,function(e){if(e.status==0){s.servicecatalogs=e.result}});break}}}else if(t.systemFieldKey=="ticket_type"){var r=o.fields.split(",");for(var n=0;n<r.length;n++){if("ticketType.name"==r[n]){t.selected=true;i={title:t.title,field:"ticketType.name",fieldCount:2,field0:"ticketType",field1:"name",visible:true,widthClass:"w150"};s.columns.push(i);break}}}}}else{a=t}});angular.forEach(s.columns,function(e){if(e.field=="subject"){s.columns.splice(s.columns.indexOf(e),1);e.widthClass="w500";s.columns.splice(1,0,e)}});s.ticketFields.splice(s.ticketFields.indexOf(a),1)}})};s.$on("loadCustomerData",function(e,t){s.tickets=t;var i=u();var r=f(s.tickets);d(r,i);g(r);h(r)});s.selectVisibleColumn=function(e){if(!e.ischecked){var t=0;if(e.selected){e.selected=false}else{e.selected=true}angular.forEach(s.ticketFields,function(e){if(e.selected){t++}});if(true){if(!e.selected&&t==9){angular.forEach(s.ticketFields,function(e){if(!e.selected){e.ischecked=false}})}}else{angular.forEach(s.ticketFields,function(e){if(!e.selected){e.ischecked=true}})}}};s.saveVisibleCustomField=function(){var i={customFields:"",fields:"",otherFields:"",type:"tickets_chart",id:s.visibleFieldId};var t=[];angular.forEach(s.ticketFields,function(e){if(e.selected){t.push(e)}});angular.forEach(t,function(e){if(e.id&&!e.systemFieldKey){if(i.customFields==""){i.customFields+=e.id}else{i.customFields+=","+e.id}}else{var t="";if(e.systemFieldKey){if(e.systemFieldKey=="ticket_type"){t="ticketType.name"}else if(e.systemFieldKey=="service_catalog"){t="serviceCatalog.id"}else{t=e.systemFieldKey}}else{t=e.value}if(i.fields==""){i.fields=t}else{i.fields+=","+t}if(s.searchType=="ticket"){if(e.value=="copyTo"||e.value=="tags"){if(i.otherFields==""){i.otherFields=e.value}else{i.otherFields+=","+e.value}}}}});r({method:"POST",url:"/search_view.json",data:i}).success(function(e){if(e.success){o(i)}})};s.downLoadCharts=function(e){var t=n.path();c();var i={downLoadType:e,columns:s.exportColumns};if("/chart/performance/number"==t){a.$broadcast("downLoadPerformanceNumber",i)}else if("/chart/performance/other"==t){a.$broadcast("downLoadPerformanceResponse",i)}else if("/chart/performance/sla"==t){a.$broadcast("downLoadPerformanceResponse",i)}else if("/chart/performance/response_time"==t){a.$broadcast("downLoadPerformanceResponse",i)}else{void 0}};var c=function(){s.exportColumns=[];angular.forEach(s.columns,function(e){var t={};if(e.fieldCount=="customFields"){t.fieldCount="customFields"}t.title=e.title;t.field=e.field;s.exportColumns.push(t)})};var u=function(){var t="";angular.forEach(s.columns,function(e){if(e.fieldCount=="customFields"||e.fieldCount=="customFieldsUser"||e.fieldCount=="customFieldsUserGroup"){if(t==""){t=e.field}else{t+=","+e.field}}});return t};var d=function(e,t){r({url:"get_ticket_custom_fields.json",method:"POST",data:{ticketIds:e,customFieldIds:t}}).success(function(e,t,i,r){if(e.success){s.customFieldList=e.json}else{}})};var f=function(e){var t="";for(var i=0;i<e.length;i++){if(t==""){t=""+e[i].id}else{t+=","+e[i].id}}return t};var p=function(e){r({url:"copy_to_by_ticket_ids.json",method:"POST",data:{ticketIds:e}}).success(function(e,t,i,r){if(e.success){s.relatedCopyTos=e.json}else{}})};var m=function(e){r({url:"tags_by_ticket_ids.json",method:"POST",data:{ticketIds:e}}).success(function(e,t,i,r){if(e.success){s.relatedtags=e.json}else{}})};var h=function(e){r({url:"map_ticket_status_color_by_ticket_id.json",method:"POST",data:{ticketIds:e}}).success(function(e,t,i,r){if(e.success){s.ticketStatusColors=e.json}else{}})};var g=function(e){if(e&&e.length>0){org.ewei.sdk.OpenTicketApi().listSubscriptionTicketIds({ticketIds:e?_.map(e.split(","),function(e){return parseInt(e)}):[]}).then(function(e){s.ticketsubscriptions=e})}}}]).directive("chartTicketField",function(){return{restrict:"A",replace:true,controller:"chartTicketFieldController",templateUrl:"/source/scripts/directives/chart-ticket-field/chart-ticket-field.html",link:function(t,e,i){$(document).click(function(e){if(e.target.className.indexOf("ticket-field-class")<=-1){t.fieldIsShow=false;t.$apply()}})}}});angular.module("com.ewei.angular.ui").controller("userCustomeFieldController",["$scope","$http","alertService","$filter","commonTools",function(u,t,o,a,d){u.datetimepickerConfig={datepickerOptions:{showWeeks:false},timepickerOptions:{showSeconds:true},buttonBar:{show:true,now:{show:true,text:"现在",cls:"btn-sm btn-default"},today:{show:true,text:"今天",cls:"btn-sm btn-default"},clear:{show:true,text:"清除",cls:"btn-sm btn-default"},date:{show:true,text:"日期",cls:"btn-sm btn-default"},time:{show:true,text:"时间",cls:"btn-sm btn-default"},close:{show:true,text:"关闭",cls:"btn-sm btn-default"},cancel:{show:false,text:"取消",cls:"btn-sm btn-default"}}};u.filedValueChange=function(e,t,i){if(t&&t!=""){var r=new String(t);if(r.indexOf("{value}")>0){r=r.replaceAll("{value}",i)}else{r=r+i}u.userCustomFields[e].valueUrl=r}};u.datetimepickerConfig={datepickerOptions:{showWeeks:false},timepickerOptions:{showSeconds:true},buttonBar:{show:true,now:{show:true,text:"现在",cls:"btn-sm btn-default"},today:{show:true,text:"今天",cls:"btn-sm btn-default"},clear:{show:true,text:"清除",cls:"btn-sm btn-default"},date:{show:true,text:"日期",cls:"btn-sm btn-default"},time:{show:true,text:"时间",cls:"btn-sm btn-default"},close:{show:true,text:"关闭",cls:"btn-sm btn-default"},cancel:{show:false,text:"取消",cls:"btn-sm btn-default"}}};var i=function(e){var t=e;var i=[];for(var r=0;r<t.length;r++){var n=t[r];var a={id:null,value:n.value,customField:null};if(n.type=="options"){var o=jQuery.parseJSON(n.customFieldOptions);n.customFieldOptions=o;u.copyCustomFieldOptions=angular.copy(o);if(n.value==undefined){a.value=o[0].value}if((n.value==undefined||n.value=="")&&n.defaultValue){for(var s=0;s<o.length;s++){if(o[s].value==n.defaultValue){a.value=n.defaultValue}}}}if(n.type=="checkbox"){if(n.value=="true"){a.value=true}else{a.value=false}}if(n.type=="mobile_phone"||n.type=="currency"){n.type="text"}if(n.notes!=undefined&&n.notes.length>40){n.notes=n.notes.substring(0,12)+". . . "}if(n.url){if(n.url.toLowerCase().indexOf("http://")!=0){n.url="http://"+n.url}if(n.url.indexOf("?")<0){a.fromParams="?"}else{a.fromParams="&"}var l=new String(n.url);if(l.indexOf("{value}")>0){l=l.replaceAll("{value}",a.value)}else{l=l+a.value}a.valueUrl=l}if(n.type=="date"){n.startForm=false;n.value=d.parseDate(a.value,"yyyy/MM/dd");a.value=n.value}else if(n.type=="date_time"){n.startForm=false;n.value=d.parseDateTime(a.value,"yyyy/MM/dd HH:mm:ss");a.value=n.value}else if(n.type=="date_to_date"){n.startTimeForm=false;n.endTimeForm=false;if(n.value){var c=n.value.split("-");n.startTime=d.parseDate(c[0],"yyyy/MM/dd");n.endTime=d.parseDate(c[1],"yyyy/MM/dd")}}a.customField=n;a.id=n.userCustomFieldId;i.push(a)}u.userCustomFields=i;u.userCustomFieldsCopy=angular.copy(u.userCustomFields)};u.updateValue=function(e){var t=u.userCustomFields[e];var i=u.userCustomFieldsCopy[e];if(t.value==i.value){return}var r=t.value;if(t.customField&&t.customField.type=="date_to_date"){if(t.customField.endTimeForm||t.customField.startTimeForm){return}else{if(!r){if(!t.customField.endTime&&!t.customField.startTime){}else{return}}}}if(t.customField.required&&!r){o.add("请输入"+t.customField.title,"danger","left");return}if(t.customField.regexpForValidation){var n=new RegExp(t.customField.regexpForValidation);if(!n.test(r)&&r){o.add("请输入正确的"+t.customField.title,"danger","left");return}}if(t.customField.url){if(t.customField.url.toLowerCase().indexOf("http://")!=0){t.customField.url="http://"+t.customField.url}if(t.customField.url.indexOf("?")<0){t.fromParams="?"}else{t.fromParams="&"}var a=new String(t.customField.url);if(a.indexOf("{value}")>0){a=a.replaceAll("{value}",t.value)}else{a=a+t.value}t.valueUrl=a}s(t)};u.change=function(e){var t=u.userCustomFields[e];var i=u.userCustomFieldsCopy[e];if(t.customField.type=="date_to_date"){if(t.customField.startTime!=undefined){var r=a("date")(t.customField.startTime,"yyyy/MM/dd").toString()}else{o.add("请选取开始时间","danger","left");t.value="";return}if(t.customField.endTime!=undefined){var n=a("date")(t.customField.endTime,"yyyy/MM/dd").toString()}else{o.add("请选取结束时间","danger","left");t.value="";return}t.value=r+"-"+n}if(t.value==i.value){return}s(t)};var s=function(n){var e=n.value;if(n.customField.type=="date"){e=a("date")(n.value,"yyyy/MM/dd").toString()}else if(n.customField.type=="date_time"){e=a("date")(n.value,"yyyy/MM/dd HH:mm:ss").toString()}if(u.userId!=null){t({url:"updateUserCustomField.json",method:"POST",data:{id:n.customField.userCustomFieldId,value:e,userId:u.userId,customFieldId:n.customField.id}}).success(function(e,t,i,r){if(e.success){}else{o.add("请输入正确的"+n.customField.title,"danger","left")}})}};u.datepickers={startTo:false,updateFrom:false,updateTo:false};u.open=function(e,t){e.preventDefault();e.stopPropagation();if(t.startForm){t.startForm=false}else{t.startForm=true}};u.timeFrameOpen=function(e,t,i){e.preventDefault();e.stopPropagation();if(i=="startTimeForm"){t.startTimeForm=!t.startTimeForm}else{t.endTimeForm=!t.endTimeForm}};u.$watch("userId",function(e){if(e==undefined){t.get("custom_field.json?scope=user&active=true").success(function(e,t){i(e.json)})}else{t.get("user_custom_field.json?userId="+e).success(function(e,t){i(e.json)})}})}]).directive("userCustomeField",[function(){return{restrict:"AE",templateUrl:"/source/scripts/directives/user-custom-field/user-custom-field.html",controller:"userCustomeFieldController",scope:{userId:"=",edit:"=",externalUrlAuthorize:"="}}}]);angular.module("com.ewei.angular.ui").controller("userGroupCustomeFieldController",["$scope","$http","alertService","$filter","groupUserTicketChainService","commonTools",function(p,i,s,m,e,h){p.datetimepickerConfig={datepickerOptions:{showWeeks:false},timepickerOptions:{showSeconds:true},buttonBar:{show:true,now:{show:true,text:"现在",cls:"btn-sm btn-default"},today:{show:true,text:"今天",cls:"btn-sm btn-default"},clear:{show:true,text:"清除",cls:"btn-sm btn-default"},date:{show:true,text:"日期",cls:"btn-sm btn-default"},time:{show:true,text:"时间",cls:"btn-sm btn-default"},close:{show:true,text:"关闭",cls:"btn-sm btn-default"},cancel:{show:false,text:"取消",cls:"btn-sm btn-default"}}};p.filedValueChange=function(e,t,i){if(t&&t!=""){var r=new String(t);if(r.indexOf("{value}")>0){r=r.replaceAll("{value}",i)}else{r=r+i}p.userGroupCustomFields[e].valueUrl=r}};p.datetimepickerConfig={datepickerOptions:{showWeeks:false},timepickerOptions:{showSeconds:true},buttonBar:{show:true,now:{show:true,text:"现在",cls:"btn-sm btn-default"},today:{show:true,text:"今天",cls:"btn-sm btn-default"},clear:{show:true,text:"清除",cls:"btn-sm btn-default"},date:{show:true,text:"日期",cls:"btn-sm btn-default"},time:{show:true,text:"时间",cls:"btn-sm btn-default"},close:{show:true,text:"关闭",cls:"btn-sm btn-default"},cancel:{show:false,text:"取消",cls:"btn-sm btn-default"}}};var r=function(t){var e=t;p.userOldGroupCustomFields=t;var i=[];for(var r=0;r<e.length;r++){var n=e[r];var a={id:null,value:n.value,customField:null};if(n.type=="options"&&n.customFieldOptions){var o=angular.fromJson(n.customFieldOptions);o.unshift({name:"-",value:""});n.customFieldOptions=o;if(n.value==undefined){a.value=o[0].value}if((n.value==undefined||n.value=="")&&n.defaultValue&&p.userGroupId==null){for(var s=0;s<o.length;s++){if(o[s].value==n.defaultValue){a.value=n.defaultValue}}}}if(n.type=="checkbox"){if(n.value=="true"){a.value=true}else{a.value=false}}if(n.type=="mobile_phone"||n.type=="currency"){n.type="text"}if(n.notes!=undefined&&n.notes.length>40){n.notes=n.notes.substring(0,12)+". . . "}if(n.url){if(n.url.toLowerCase().indexOf("http://")!=0){n.url="http://"+n.url}if(n.url.indexOf("?")<0){a.fromParams="?"}else{a.fromParams="&"}var l=new String(n.url);if(l.indexOf("{value}")>0){l=l.replaceAll("{value}",a.value)}else{l=l+a.value}a.valueUrl=l}if(n.type=="date"){n.startForm=false;a.value=n.value=h.parseDate(n.value,"yyyy/MM/dd")}else if(n.type=="date_time"){n.startForm=false;a.value=n.value=h.parseDateTime(n.value,"yyyy/MM/dd HH:mm:ss")}else if(n.type=="date_to_date"){n.startTimeForm=false;n.endTimeForm=false;if(n.value){var c=n.value.split("-");n.startTime=h.parseDate(c[0],"yyyy/MM/dd");n.endTime=h.parseDate(c[1],"yyyy/MM/dd")}}if(n.type=="multi_options"){var u="";if(a.value===undefined){angular.forEach(JSON.parse(n.customFieldOptions),function(e){if(e.defaultValue){u+=e.value+","}});a.value=u.substring(0,u.length-1)}}a.customField=n;i.push(a)}p.userGroupCustomFields=i;p.showMoreField=function(){p.isShowMoreField=true;p.$applyAsync(function(){Array.prototype.push.apply(p.userGroupCustomFields,p.unRequiredField);p.groupField.userGroupCustomFields=p.userGroupCustomFields})};p.unRequiredField=[];if(p.groupField!=undefined){var d=[];var f;var t=[];angular.forEach(i,function(e){f={};if(e.value&&!e.customField.required){if(e.customField.type=="date"){e.value=m("date")(userCustomFields[r].value,"yyyy/MM/dd").toString()}f.value=e.value;f.customField=e.customField;t.push(f)}if(e.customField.required==true&&e.customField.active==true){d.push(e)}else{p.unRequiredField.push(e)}});p.userGroupCustomFields=d;p.groupField.userGroupCustomFields=p.userGroupCustomFields.concat(t)}};if(p.userGroupId==undefined){i.get("custom_field.json?scope=user_group&active=true").success(function(e,t){r(e.json)})}else{i.get("user_group_custom_field.json?userGroupId="+p.userGroupId).success(function(e,t){r(e.json)})}p.updateValue=function(e){var t=p.userGroupCustomFields[e];var i=t.value;var r=p.userOldGroupCustomFields[e].value;var n=p.userOldGroupCustomFields[e].required;if(r!=i){if(t.customField.regexpForValidation&&i&&p.groupField==undefined){var a=new RegExp(t.customField.regexpForValidation);if(!a.test(i)){s.add("请输入正确的"+t.customField.title,"danger","left");t.value=r;return}}if(!i&&n){s.add(t.customField.title+"是必填项，不能为空，请重新输入","danger","left");t.value=r;return}if(t.customField.url){if(t.customField.url.toLowerCase().indexOf("http://")!=0){t.customField.url="http://"+t.customField.url}if(t.customField.url.indexOf("?")<0){t.fromParams="?"}else{t.fromParams="&"}var o=new String(t.customField.url);if(o.indexOf("{value}")>0){o=o.replaceAll("{value}",t.value)}else{o=o+t.value}t.valueUrl=o}l(t,e)}};p.change=function(e){var t=p.userGroupCustomFields[e];var i=t.value;var r=p.userOldGroupCustomFields[e].value;var n=p.userOldGroupCustomFields[e].required;if(t.customField.type=="date_to_date"){if(!t.customField.endTime&&!t.customField.startTime){if(!n){t.value=""}else{if(p.userOldGroupCustomFields[e].value.length>0){t.customField.startTime=p.userOldGroupCustomFields[e].value.split("-")[0];t.customField.endTime=p.userOldGroupCustomFields[e].value.split("-")[1]}s.add("请正确选取时间","danger","left");return}}else if(t.customField.startTime&&!t.customField.endTime){s.add("请选取结束时间","danger","left");return}else if(t.customField.endTime&&!t.customField.startTime){s.add("请选取开始时间","danger","left");return}else{var a=m("date")(t.customField.startTime,"yyyy/MM/dd").toString();var o=m("date")(t.customField.endTime,"yyyy/MM/dd").toString();t.value=a+"-"+o}}else{if(i!=r){if(!i&&n){s.add(p.userOldGroupCustomFields[e].title+"是必填项，不能为空","danger","left");t.value=r;return}}else{return}}l(t,e)};var l=function(n,a){var e=n.value;if(n.customField.type=="date"){e=m("date")(n.value,"yyyy/MM/dd").toString()}else if(n.customField.type=="date_time"){e=m("date")(n.value,"yyyy/MM/dd HH:mm:ss").toString()}if(p.userGroupId!=null){i({url:"updateUserGroupCustomField.json",method:"POST",data:{id:n.customField.userGroupCustomFieldId,value:e,userGroupId:p.userGroupId,customFieldId:n.customField.id}}).success(function(e,t,i,r){if(e.success){p.userOldGroupCustomFields[a].value=n.value}else{s.add("请输入正确的"+n.customField.title,"danger","left")}})}};p.datepickers={startTo:false,updateFrom:false,updateTo:false};p.open=function(e,t){e.preventDefault();e.stopPropagation();if(t.startForm){t.startForm=false}else{t.startForm=true}};p.timeFrameOpen=function(e,t,i){e.preventDefault();e.stopPropagation();if(i=="startTimeForm"){t.startTimeForm=!t.startTimeForm}else{t.endTimeForm=!t.endTimeForm}};p.$watch("userGroupId",function(e,t){if(e!=t){i.get("user_group_custom_field.json?userGroupId="+p.userGroupId).success(function(e,t){r(e.json)})}})}]).directive("userGroupCustomeField",[function(){return{restrict:"AE",templateUrl:"/source/scripts/directives/user-group-custom-field/user-group-custom-field.html",controller:"userGroupCustomeFieldController",scope:{userGroupId:"=",externalUrlAuthorize:"=",groupField:"="}}}]);angular.module("com.ewei.angular.ui").controller("ticketTemplateSelectController",["$scope","$http","$filter","$rootScope","alertService","$state","$stateParams","permissions","utils","ConsoleConfig","ticketTemplateListService","providerJudgement","locker","emojiService","apiRestfulService","coreModelService","coreNotifyService","apiTicketTemplateService","commonTools","$modal_",function(j,D,a,s,l,c,u,d,f,p,e,m,h,g,v,k,t,i,x,y){j.isClick=false;j.uploading=false;var w=u.id;var C=c.current.name;try{j.systemFieldSubject=JSON.parse(localStorage["systemFieldSubject"]);j.systemFieldTicketdescription=JSON.parse(localStorage["systemFieldTicketdescription"]);j.typeFiled=angular.fromJson(localStorage.getItem("systemFieldTicketType"));j.priorityFiled=angular.fromJson(localStorage.getItem("systemFieldPriority"));j.catalogFiled=angular.fromJson(localStorage.getItem("systemFieldServiceCatalog"))}catch(e){}function I(e){if(j.ticket.tags==null){j.ticket.tags=[];j.ticket.tags.push({name:e})}else{var t=false;for(var i=0,r=j.ticket.tags.length;i<r;i++){if(j.ticket.tags[i].name==e){t=true;break}}if(!t){j.ticket.tags.push({name:e})}}}j.changeTicketTemplate=function(e){j.cancelSelect();if(e.id==-1){j.selectedTicketTemplate=null;return}j.selectedTicketTemplate=e;j.oldTicket=angular.copy(j.ticket);var e=e;if(e!=null&&e.id!=null){D({url:"ticket_template/"+e.id+".json",method:"GET",params:{}}).success(function(e,t,i,r){var n;var a,o;if(e.success){var s=e.json;if(s!=null&&s.operations!=null&&s.operations.length>0){j.ticket.ccs=[];for(var l=0,c=s.operations.length;l<c;l++){var u=s.operations[l].type;var d=s.operations[l].value;var f=s.operations[l].ticketCustomFieldId;if("requester"==u){D({url:"user/"+d+".json",method:"GET",params:{}}).success(function(e,t,i,r){if(e.success){j.ticket.requester=e.json}})}else if("subject"==u){j.ticket.subject=d;n=d}else if("priority"==u){j.ticket.priority=d}else if("ticket_type"==u&&d){D({url:"ticket_type/"+d+".json",method:"GET",params:{}}).success(function(e,t,i,r){if(e.success){j.ticket.ticketType=e.json}})}else if("servicecatalog"==u&&d){j.ticket.serviceCatalog={id:d}}else if("engineer"==u&&d){var p=d.split(",");delete j.ticket.serviceDesk;delete j.ticket.engineer;if(p&&p[0]&&p[0]>0){if(p[0]!="workflow_template"){D({url:"service_desk/"+p[0]+".json",method:"GET",params:{}}).success(function(e,t,i,r){if(e.success){j.ticket.serviceDesk=e.json}})}}if(p&&p[1]&&p[1]>0){if(p[0]=="workflow_template"){j.ticket.workflowTemplate={id:p[1]}}else{D({url:"engineer/"+p[1]+".json",method:"GET",params:{}}).success(function(e,t,i,r){if(e.success){j.ticket.engineer=e.json}})}}}else if("comment_attribute"==u&&d){if("private"==d){o=false}else{o=true}}else if("comment"==u&&d){a=d}else if("addtag"==u&&d){if(j.ticket.tags==null){j.ticket.tags=[]}var m=d.split(" ");for(var h=0,g=m.length;h<g;h++){if(m[h]!=""){I(m[h])}}}else if("modifytag"==u&&d){j.ticket.tags=[];var m=d.split(" ");for(var v=0,k=m.length;v<k;v++){if(m[v]!=""){I(m[v])}}}else if("deletetag"==u&&d){var y={name:d};if(j.ticket.tags!=null){}}else if("add_ticket_cc"==u&&d){var w=d.split(",")||[];var C="0,";for(var b=0;b<w.length;b++){if(validEmail(w[b])){j.ticket.ccs.push({name:w[b]})}else{C+=w[b]+","}}D({url:"/api/v1/customers/by_ids.json",method:"GET",params:{ids:C}}).success(function(e,t,i,r){if(e.status==0&&e.result&&e.result.users){j.ticket.ccs=j.ticket.ccs.concat(e.result.users)}})}else if("add_ticket_cc_servicedesk"==u&&d){var S=JSON.parse(d);S=_.uniq(S,false,function(e){return e.id});angular.forEach(S,function(e){e.type="serviceDesk"});j.ticket.ccs=j.ticket.ccs.concat(S)}else if("status"==u){}else if("ticket_custom_field"==u){if(j.ticket.ticketCustomFields&&j.ticket.ticketCustomFields.length>0){for(var T=0;T<j.ticket.ticketCustomFields.length;T++){var $=j.ticket.ticketCustomFields[T].customField;if($&&$.id==f){if("checkbox"==$.type){if("true"==d){j.ticket.ticketCustomFields[T].value=true}else{j.ticket.ticketCustomFields[T].value=false}}else if("date"==$.type){d=d?d.replace(/-/g,"/"):"";d=j.ticket.ticketCustomFields[T].value=x.parseDate(d,"yyyy/MM/dd")}else if("date_time"==$.type){d=d?d.replace(/-/g,"/"):"";d=j.ticket.ticketCustomFields[T].value=x.parseDateTime(d,"yyyy/MM/dd HH:mm:ss")}else if("date_to_date"==$.type){var E=angular.copy(d);var F=E.split("-");$.startTime=x.parseDate(F[0],"yyyy/MM/dd");$.endTime=x.parseDate(F[1],"yyyy/MM/dd");j.ticket.ticketCustomFields[T].value=d}else{j.ticket.ticketCustomFields[T].value=d}break}}}}}}j.ticket.select_ticket_template_show=false;j.ticket.submit_ticket_template_show=true;j.$emit("selectedTicketTemplate",{is_use_template:true,subject:n,comment:a,open:o})}})}};j.save=function(e){if(!m.isTrue()){return false}j.isClick=true;if(e==null||e=="undefined"){if(j.ticket.status==null||j.ticket.status=="undefined"){if(j.ticket.engineer==null){j.ticket.status="new"}else{j.ticket.status="open"}}else{if(j.ticket.status=="new"){if(j.ticket.engineer||j.ticket.workflowTemplate){l.add("模板中处理人必须指定为客服组","danger");j.isClick=false;return false}}else{if(!j.ticket.engineer&&!j.ticket.workflowTemplate){l.add("模板中处理人必须指定为客服或工作流","danger");j.isClick=false;return false}}}}else{j.ticket.status=e}var t={channel:"console",channelName:"客服界面 ",source:p.user.name};j.ticket.via=t;var i=function(t){return _.find(j.customFormFields,function(e){return e.id==t.id})};j.ticket.ticketCustomFields=_.filter(j.ticket.ticketCustomFields,function(e){return e.customField&&(e.customField.sysCustomForm||i(e.customField))});angular.forEach(j.ticket.ticketCustomFields,function(e){if(e.value=="-"){e.value=""}if(e.customField&&e.customField.type=="date"&&e.value){e.value=a("date")(e.value,"yyyy/MM/dd")}if(e.customField&&e.customField.type=="date_time"&&e.value){e.value=a("date")(e.value,"yyyy/MM/dd HH:mm:ss")}});j.$parent.replying=true;if(j.$parent.$parent.attachments!=undefined){j.ticket.ticketComment.attachments=j.$parent.$parent.attachments}if(!j.ticket.ticketComment){j.ticket.ticketComment={content:""}}var r=g.parseHtmlToSend(angular.copy(j.ticket.ticketComment.content));var n=angular.copy(r);if(navigator.userAgent.indexOf("Firefox")!==-1){n=n.replace(/&nbsp;/g,"").replace(/<br>/g,"")}n=n.replace(/^\s*|\s*$/g,"");var o=j.$parent.cleanupSaveData(angular.copy(j.ticket));if(o.ticketMetric&&o.ticketMetric.planSolvedAt){o.ticketMetric.planSolvedAt=a("date")(o.ticketMetric.planSolvedAt,"yyyy-MM-dd HH:mm:ss").toString()}o.ticketComment.content=n;o.ccs=[];angular.forEach(j.ticket.ccs,function(e){if(e.id&&Object.prototype.toString.call(e.id)==="[object Number]"){var t={};if(e.type==="userGroup"){o.ccs.push({userGroup:e})}else if(e.type==="serviceDesk"){o.ccs.push({serviceDesk:e})}else{o.ccs.push({user:e})}}else{o.ccs.push({email:e.name})}});if(j.ticket.createType!=="normal"){j.$parent.batchSave(o);return}D({url:"/api/v1/ticket/save.json",method:"POST",data:o}).success(function(t,e,i,r){if(t.status==0){j.$emit("applyTicketTemplateCompleted");l.add("添加工单成功");k.config.route.remove("tickets_new_"+u.id);var n=f.findTabById(C.split(".")[0]+w);if(n!=null){f.splice(n)}j.ticket=null;j.ticket=angular.copy(o);j.ticket.ticketComment.content="";h.driver("session").namespace("eweiApp.chat").forget(u.id);if(u.projectid&&t.result.ticketId){v.run({url:"/api/v1/projects/"+u.projectid+"/tickets/"+t.result.ticketId,urlParam:{bindType:"id"}}).post(null,function(e){if(e.status===0){l.add("项目已关联工单#"+e.result.ticket.no+"！");s.$broadcast("addTickets",e.result.ticket);s.$broadcast("sendTimeLineLogs",{log:e.result.log})}else{l.add("与项目关联失败！","danger")}c.go("tickets_detail",{id:t.result.ticketId})},function(){l.add("与项目关联失败！","danger");c.go("tickets_detail",{id:t.result.ticketId})})}else{c.go("tickets_detail",{id:t.result.ticketId})}}else{if(t.result&&t.result.error){if(t.result.error=="provider_license_error"){var a=y({scope:j,title:"提示",contentTemplate:"source/views/quantity_limitation.html",html:true,show:true,placement:"center"});j.limit={};j.limit.hasPermission=true;j.goUpgrade=function(){if(d.hasPermission("system_setting_company_account")){c.go("system_setting.detail.provider",{uri:"company_account",settingType:"system"});a.$promise.then(a.hide)}else{j.limit.hasPermission=false}};j.hideLimitModal=function(){a.$promise.then(a.hide)}}else{l.add(t.result.error_description,"danger")}}else{l.add("添加工单失败","danger")}j.$parent.replying=false;j.isClick=false}}).error(function(e,t,i,r){j.$parent.replying=false;j.isClick=false;l.add("error"+e,"danger")})};j.cancelSelect=function(){if(!j.oldTicket)return;j.ticket=angular.extend({select_ticket_template_show:true,submit_ticket_template_show:false,ticketCustomFields:angular.copy(j.oldTicket.ticketCustomFieldsCopy),ticketCustomFieldsCopy:angular.copy(j.oldTicket.ticketCustomFieldsCopy),ticketComment:{ccs:[]}},j.oldTicket);j.$emit("selectedTicketTemplate",{is_use_template:false,subject:j.ticket.subject,comment:j.ticket.comment})};j.submit=function(e){j.save(e);j.status.isopen=false};j.status={isopen:false};j.$on("file-uploading",function(e,t){j.uploading=t});j.$on("save-with-template",function(e,t){j.save(t)});var r=function(e){var t=[];var i=[];if(e.status==0&&e.result){for(var r=0;r<e.result.ticketTemplates.length;r++){if(e.result.ticketTemplates[r].engineer!=undefined){t.push(e.result.ticketTemplates[r])}else{i.push(e.result.ticketTemplates[r])}}}j.ticketTemplates=t.concat(i);j.ticketTemplates.unshift({id:-1,name:"不使用模板"})};i.getList("templates",t.constant.EVENT_LIST_TICKET_TEMPLATES,1,null,null,function(e){r(e)});j.$watch("ticket.ticketComment",function(e,t){if(e!==t){j.ticket.ticketComment=e}},true)}]).directive("ticketTemplateSelect",[function(){return{restrict:"EA",replace:true,templateUrl:"/source/scripts/directives/ticket-template-select/ticket-template-select.html",controller:"ticketTemplateSelectController",scope:{tickettemplateselect:"=",ticket:"=",customFormFields:"="}}}]);angular.module("com.ewei.angular.ui").directive("eweiTagsShow",function(){return{restrict:"E",replace:false,scope:{relatedtags:"=",relatedid:"@"},template:"",link:function(r,i,e){var n=function(e){for(var t=0;t<r.relatedtags.length;t++){var i=r.relatedtags[t];if(i.relatedId==e){return i.tagNames}}return null};var t=r.$watch("relatedtags",function(){if(angular.isDefined(r.relatedtags)&&r.relatedtags!=null){var e=n(r.relatedid);if(e!=null){var t="";angular.forEach(e,function(e){t+="<mark>"+e+"</mark> "});i.html(t)}}});r.$on("$destroy",function(){t()})}}}).directive("tags",function(){return{restrict:"E",scope:{data:"="},template:'<mark title="{{tag}}" ng-repeat="tag in tags track by $index">{{tag}}</mark>',link:function(t,e,i){function r(){if(t.data){if(angular.isArray(t.data)){t.tags=t.data}else{var e=t.data.split(" ");t.tags=_.filter(e,function(e){return!!e})}}}r();t.$watch("data",function(e,t){if(e!==t){r()}})}}});angular.module("com.ewei.angular.ui").directive("eweiCcShow",function(){return{restrict:"E",replace:false,scope:{relatedcopytos:"=",relatedid:"@"},template:"",link:function(r,i,e){var n=function(e){for(var t=0;t<r.relatedcopytos.length;t++){var i=r.relatedcopytos[t];if(i.relatedId==e){return i.copyToNames}}return null};var t=r.$watch("relatedcopytos",function(){if(angular.isDefined(r.relatedcopytos)&&r.relatedcopytos!=null){var e=n(r.relatedid);if(e!=null){var t="";angular.forEach(e,function(e){t+="<mark>"+e+"</mark> "});i.html(t)}}});r.$on("$destroy",function(){t()})}}});(function(e,d){"use strict";e.module("com.ewei.angular.ui").directive("eweiTicketFieldShow",["$filter",function(u){return{restrict:"E",scope:{field:"=",ticket:"="},template:"",link:function(a,o,e){var s;function t(){var e=c();var t=e.split(".");var i=a.ticket;for(var r in t){if(t.hasOwnProperty(r)){i=i[t[r]];if(!i){break}}}var n=l(e,i);if(n){if(s===true){o.html("<span style='color:#FC3333' title='超时"+n+"'>超时"+n+"</span>")}else if(s===false){o.html("<span title='剩余"+n+"'>剩余"+n+"</span>")}else{o.html("<span title='"+n+"'>"+n+"</span>")}}else{o.html("")}s=null}function l(e,t){var i=t;do{if(e==="ticketMetric.pausedAt"){i=u("dateFilter_style1")(i);break}if(e==="ticketMetric.solvedAt"){i=u("dateFilter_style1")(i,"solvedAt",a.ticket.status);break}if(e==="ticketMetric.responseAt"){i=u("dateFilter_style1")(i);break}if(e==="ticketMetric.planSolvedAt"){i=u("dateFilter_style1")(i,"planSolvedAt",a.ticket.status);break}if(e==="ticketMetric.responseMinutes"){i=u("minute_format_filter")(i,"responseMinutes",a.ticket.status);break}if(e==="ticketMetric.solveMinutes"){i=u("minute_format_filter")(i,"solveMinutes",a.ticket.status);break}if(["createdAt","deletedAt","lastLoginAt"].indexOf(e)>=0){i=u("dateFilter_style1")(i);break}if(["updatedAt"].indexOf(e)>=0){i=u("dateFilter_human")(i);break}if(["role.name","serviceDesk.name","defaultServiceDesk.name","user.role.name"].indexOf(e)>=0){i=u("translate")(i);break}if(e==="tags"&&d.utils.isArray(i)){i=i.join(",");break}if(e==="deleteReason"){i=u("nullStringFilter")(i);break}if(e==="priority"){if(localStorage){var r=JSON.parse(JSON.parse(localStorage["systemFieldPriority"]).customFieldOptions);for(var n in r){if(r.hasOwnProperty(n)){if(r[n].value===i){i=r[n].name;break}}}}break}if(e==="solution"){if(i&&i.solution){i=i.solution}else{i=""}}if(e==="ticketMetric.slaResponseTarget"||e==="ticketMetric.slaSolveTarget"){if(i){s=i>0?true:false;i=u("minutesToTimeCh")(parseInt(Math.abs(i)/1e3/60))}else{i=u("nullStringFilter")(i)}}}while(0);return i}function c(){var e=a.field+"";do{if(e==="serviceCatalog.id"){e="serviceCatalogNames";break}if(e==="evaluate.score"){e="evaluate.score";break}if(e==="evaluate.solved"){e="evaluate.solvedName";break}if(e==="copyTo"){e="copyto";break}if(e==="solutionId"){e="solution";break}}while(0);return e}function i(){t()}var r=a.$watch("ticket",function(e,t){if(e!==t){i()}},true);a.$on("$destroy",function(){r()});i()}}}]).directive("eweiTableScrollToMaxRight",function(){return{restrict:"A",link:function(i,r,e){r.bind("scroll",function(){var e=r[0];var t=Math.abs(e.scrollWidth-e.offsetWidth);if(e.scrollLeft===t){i.loadMoreFields()}})}}})})(angular,org.ewei);angular.module("com.ewei.angular.ui").directive("serviceCatalogNameShow",function(){return{restrict:"E",replace:false,scope:{servicecatalogid:"@",servicecatalogs:"="},template:"",link:function(r,e,t){var i="";r.getServiceCatalog=function(e){if(r.servicecatalogs==undefined){return null}for(var t=0;t<r.servicecatalogs.length;t++){var i=r.servicecatalogs[t];if(i.id==e){return i}}return null};var n=r.servicecatalogid;while(true){var a=r.getServiceCatalog(n);if(a==null){break}n=a.parentId;i=a.name+"/"+i}e.html(i)}}});angular.module("com.ewei.angular.ui").directive("eweiCustomFieldsShow",function(){return{restrict:"E",replace:false,scope:{customfields:"=",ticketid:"@",customfieldid:"@"},template:"",link:function(n,t,e){var i=function(e,t){for(var i=0;i<n.customfields.length;i++){var r=n.customfields[i];if(r.ticketId==e&&r.customFieldId==t){if(r.type=="checkbox"){if(r.value=="true"){return"<input type='checkbox' checked='checked' disabled />"}else if(r.value=="false"){return""}}else{return r.value}}}return null};var r=n.$watch("customfields",function(){if(angular.isDefined(n.customfields)&&n.customfields!=null){var e=i(n.ticketid,n.customfieldid);if(e!=null&&e!=""&&e!=undefined){t.html(e);t.attr("title",e)}else{t.html("-")}}});n.$on("$destroy",function(){r()})}}});angular.module("com.ewei.angular.ui").directive("eweiCustomFieldsUser",function(){return{restrict:"E",replace:false,scope:{customfields:"=",userid:"@",customfieldid:"@"},template:"",link:function(n,t,e){var i=function(e,t){for(var i=0;i<n.customfields.length;i++){var r=n.customfields[i];if(r.userId==e&&r.customFieldId==t){if(r.type=="checkbox"){if(r.value=="true"){return"<input type='checkbox' checked='checked' disabled />"}else if(r.value=="false"){return""}}else{return r.value}}}return null};var r=n.$watch("customfields",function(){if(angular.isDefined(n.customfields)&&n.customfields!=null){var e=i(n.userid,n.customfieldid);if(e!=null&&e!=""&&e!=undefined){t.html(e)}else{t.html("-")}}});n.$on("$destroy",function(){r()})}}});angular.module("com.ewei.angular.ui").directive("eweiStartShow",function(){return{restrict:"E",replace:false,scope:{ticketsubscriptions:"=",item:"="},template:"",link:function(i,e,t){var r=function(e){for(var t=0;t<i.ticketsubscriptions.length;t++){if(i.ticketsubscriptions[t].ticketId==e.id){if(false==e.isTarget||undefined===e.isTarget){e.isTarget=true}break}}return null};var n=i.$watch("ticketsubscriptions",function(){if(angular.isDefined(i.ticketsubscriptions)&&i.ticketsubscriptions!=null){var e=r(i.item)}});i.$on("$destroy",function(){n()})}}});(function(){"use strict";angular.module("eweiApp.common").directive("wechatEmoji",e).filter("wechatEmoji",t).factory("emojiService",i);function e(){i.$inject=["$scope"];var e={restrict:"AE",link:t,controller:i,controllerAs:"vm",bindToController:true,scope:{editElementId:"@",wechatEmojiPanelOpen:"="},templateUrl:"source/scripts/directives/wechat-emoji/wechat-emoji.html"};return e;function t(e,t,i,n){t.click(function(e){var t=e.target;if("INPUT"===t.tagName){var i=t.getAttribute("title"),r=t.getAttribute("data-type");switch(r){case"qq":i=n.getAppendText(i,r);n.appendToTextArea(i);break;case"emoji":i=n.getAppendText(i,r);n.appendToTextArea(i);break}e.preventDefault()}})}function i(e){var n=this;n.index=1;n.closeEmojiBox=function(){n.wechatEmojiPanelOpen=false};e.$watch("vm.wechatEmojiPanelOpen",function(e,t){if(e===true){n.index=1}});n.getAppendText=function(e,t){switch(t){case"qq":e='<img class="qqemoji qqemoji'+n.emojiData.QQFaceMap[e]+'" text="['+e+']" src="/source/scripts/directives/wechat-emoji/images/spacer.gif">';break;case"emoji":e='<img class="emoji emoji'+n.emojiData.QQFaceMap["<"+e+">"]+'" text="'+e+'" src="/source/scripts/directives/wechat-emoji/images/spacer.gif">';break}return e};n.appendToTextArea=function(e){var t=document.getElementById(n.editElementId),i,r;if(t){t.focus();a(e)}};var t;function a(e){var t,i;if(window.getSelection){t=window.getSelection();if(t.getRangeAt&&t.rangeCount){i=t.getRangeAt(0);i.deleteContents();var r=document.createElement("div");r.innerHTML=e;var n=document.createDocumentFragment(),a,o;a=r.firstChild;o=n.appendChild(a);var s=n.firstChild;i.insertNode(n);if(o){i=i.cloneRange();i.setStartAfter(o);i.collapse(true);t.removeAllRanges();t.addRange(i)}}}else if((t=document.selection)&&t.type!="Control"){var l=t.createRange();l.collapse(true);t.createRange().pasteHTML(e)}}n.emojiData={QQFaceList:["微笑","撇嘴","色","发呆","得意","流泪","害羞","闭嘴","睡","大哭","尴尬","发怒","调皮","呲牙","惊讶","难过","酷","冷汗","抓狂","吐","偷笑","愉快","白眼","傲慢","饥饿","困","惊恐","流汗","憨笑","悠闲","奋斗","咒骂","疑问","嘘","晕","疯了","衰","骷髅","敲打","再见","擦汗","抠鼻","鼓掌","糗大了","坏笑","左哼哼","右哼哼","哈欠","鄙视","委屈","快哭了","阴险","亲亲","吓","可怜","菜刀","西瓜","啤酒","篮球","乒乓","咖啡","饭","猪头","玫瑰","凋谢","嘴唇","爱心","心碎","蛋糕","闪电","炸弹","刀","足球","瓢虫","便便","月亮","太阳","礼物","拥抱","强","弱","握手","胜利","抱拳","勾引","拳头","差劲","爱你","NO","OK","爱情","飞吻","跳跳","发抖","怄火","转圈","磕头","回头","跳绳","投降","激动","乱舞","献吻","左太极","右太极"],EmojiList:["笑脸","开心","大笑","热情","眨眼","色","接吻","亲吻","脸红","露齿笑","满意","戏弄","吐舌","无语","得意","汗","失望","低落","呸","焦虑","担心","震惊","悔恨","眼泪","哭","破涕为笑","晕","恐惧","心烦","生气","睡觉","生病","恶魔","外星人","心","心碎","丘比特","闪烁","星星","叹号","问号","睡着","水滴","音乐","火","便便","强","弱","拳头","胜利","上","下","右","左","第一","强壮","吻","热恋","男孩","女孩","女士","男士","天使","骷髅","红唇","太阳","下雨","多云","雪人","月亮","闪电","海浪","猫","小狗","老鼠","仓鼠","兔子","狗","青蛙","老虎","考拉","熊","猪","牛","野猪","猴子","马","蛇","鸽子","鸡","企鹅","毛虫","章鱼","鱼","鲸鱼","海豚","玫瑰","花","棕榈树","仙人掌","礼盒","南瓜灯","鬼魂","圣诞老人","圣诞树","礼物","铃","庆祝","气球","CD","相机","录像机","电脑","电视","电话","解锁","锁","钥匙","成交","灯泡","邮箱","浴缸","钱","炸弹","手枪","药丸","橄榄球","篮球","足球","棒球","高尔夫","奖杯","入侵者","唱歌","吉他","比基尼","皇冠","雨伞","手提包","口红","戒指","钻石","咖啡","啤酒","干杯","鸡尾酒","汉堡","薯条","意面","寿司","面条","煎蛋","冰激凌","蛋糕","苹果","飞机","火箭","自行车","高铁","警告","旗","男人","女人","O","X","版权","注册商标","商标"],QQFaceMap:{"微笑":"0","撇嘴":"1","色":"2","发呆":"3","得意":"4","流泪":"5","害羞":"6","闭嘴":"7","睡":"8","大哭":"9","尴尬":"10","发怒":"11","调皮":"12","呲牙":"13","惊讶":"14","难过":"15","酷":"16","冷汗":"17","抓狂":"18","吐":"19","偷笑":"20","可爱":"21","愉快":"21","白眼":"22","傲慢":"23","饥饿":"24","困":"25","惊恐":"26","流汗":"27","憨笑":"28","悠闲":"29","大兵":"29","奋斗":"30","咒骂":"31","疑问":"32","嘘":"33","晕":"34","疯了":"35","折磨":"35","衰":"36","骷髅":"37","敲打":"38","再见":"39","擦汗":"40","抠鼻":"41","鼓掌":"42","糗大了":"43","坏笑":"44","左哼哼":"45","右哼哼":"46","哈欠":"47","鄙视":"48","委屈":"49","快哭了":"50","阴险":"51","亲亲":"52","吓":"53","可怜":"54","菜刀":"55","西瓜":"56","啤酒":"57","篮球":"58","乒乓":"59","咖啡":"60","饭":"61","猪头":"62","玫瑰":"63","凋谢":"64","嘴唇":"65","示爱":"65","爱心":"66","心碎":"67","蛋糕":"68","闪电":"69","炸弹":"70","刀":"71","足球":"72","瓢虫":"73","便便":"74","月亮":"75","太阳":"76","礼物":"77","拥抱":"78","强":"79","弱":"80","握手":"81","胜利":"82","抱拳":"83","勾引":"84","拳头":"85","差劲":"86","爱你":"87",NO:"88",OK:"89","爱情":"90","飞吻":"91","跳跳":"92","发抖":"93","怄火":"94","转圈":"95","磕头":"96","回头":"97","跳绳":"98","投降":"99","激动":"100","乱舞":"101","献吻":"102","左太极":"103","右太极":"104",Smile:"0",Grimace:"1",Drool:"2",Scowl:"3",Chill:"4",Sob:"5",Shy:"6",Shutup:"7",Silent:"7",Sleep:"8",Cry:"9",Awkward:"10",Pout:"11",Angry:"11",Wink:"12",Tongue:"12",Grin:"13",Surprised:"14",Surprise:"14",Frown:"15",Cool:"16",Ruthless:"16",Tension:"17",Blush:"17",Scream:"18",Crazy:"18",Puke:"19",Chuckle:"20",Joyful:"21",Slight:"22",Smug:"23",Hungry:"24",Drowsy:"25",Panic:"26",Sweat:"27",Laugh:"28",Loafer:"29",Commando:"29",Strive:"30",Determined:"30",Scold:"31",Doubt:"32",Shocked:"32",Shhh:"33",Dizzy:"34",Tormented:"35",BadLuck:"36",Toasted:"36",Skull:"37",Hammer:"38",Wave:"39",Relief:"40",Speechless:"40",DigNose:"41",NosePick:"41",Clap:"42",Shame:"43",Trick:"44","Bah！L":"45","Bah！R":"46",Yawn:"47",Lookdown:"48","Pooh-pooh":"48",Wronged:"49",Shrunken:"49",Puling:"50",TearingUp:"50",Sly:"51",Kiss:"52","Uh-oh":"53",Wrath:"53",Whimper:"54",Cleaver:"55",Melon:"56",Watermelon:"56",Beer:"57",Basketball:"58",PingPong:"59",Coffee:"60",Rice:"61",Pig:"62",Rose:"63",Wilt:"64",Lip:"65",Heart:"66",BrokenHeart:"67",Cake:"68",Lightning:"69",Bomb:"70",Dagger:"71",Soccer:"72",Ladybug:"73",Poop:"74",Moon:"75",Sun:"76",Gift:"77",Hug:"78",Strong:"79",ThumbsUp:"79",Weak:"80",ThumbsDown:"80",Shake:"81",Victory:"82",Peace:"82",Admire:"83",Fight:"83",Beckon:"84",Fist:"85",Pinky:"86",Love:"2",RockOn:"87",No:"88","Nuh-uh":"88",InLove:"90",Blowkiss:"91",Waddle:"92",Tremble:"93","Aaagh!":"94",Twirl:"95",Kotow:"96",Lookback:"97",Dramatic:"97",Jump:"98",JumpRope:"98","Give-in":"99",Surrender:"99",Hooray:"100",HeyHey:"101",Meditate:"101",Smooch:"102","TaiJi L":"103","TaiChi L":"103","TaiJi R":"104","TaiChi R":"104","發呆":"3","流淚":"5","閉嘴":"7","尷尬":"10","發怒":"11","調皮":"12","驚訝":"14","難過":"15","饑餓":"24","累":"25","驚恐":"26","悠閑":"29","奮鬥":"30","咒罵":"31","疑問":"32","噓":"33","暈":"34","瘋了":"35","骷髏頭":"37","再見":"39","摳鼻":"41","羞辱":"43","壞笑":"44","鄙視":"48","陰險":"51","親親":"52","嚇":"53","可憐":"54","籃球":"58","飯":"61","豬頭":"62","枯萎":"64","愛心":"66","閃電":"69","炸彈":"70","甲蟲":"73","太陽":"76","禮物":"77","擁抱":"78","強":"79","勝利":"82","拳頭":"85","差勁":"86","愛你":"88","愛情":"90","飛吻":"91","發抖":"93","噴火":"94","轉圈":"95","磕頭":"96","回頭":"97","跳繩":"98","激動":"100","亂舞":"101","獻吻":"102","左太極":"103","右太極":"104","<笑脸>":"1f604","<笑臉>":"1f604","<Laugh>":"1f604","<开心>":"1f60a","<開心>":"1f60a","<Happy>":"1f60a","<大笑>":"1f603","<Big Smile>":"1f603","<热情>":"263a","<熱情>":"263a","<Glowing>":"263a","<眨眼>":"1f609","<Wink>":"1f609","<色>":"1f60d","<Love>":"1f60d","<接吻>":"1f618","<Smooch>":"1f618","<亲吻>":"1f61a","<親吻>":"1f61a","<Kiss>":"1f61a","<脸红>":"1f633","<臉紅>":"1f633","<Blush>":"1f633","<露齿笑>":"1f63c","<露齒笑>":"1f63c","<Grin>":"1f63c","<满意>":"1f60c","<滿意>":"1f60c","<Satisfied>":"1f60c","<戏弄>":"1f61c","<戲弄>":"1f61c","<Tease>":"1f61c","<吐舌>":"1f445","<Tongue>":"1f445","<无语>":"1f612","<無語>":"1f612","<Speechless>":"1f612","<得意>":"1f60f","<Smirk>":"1f60f","<汗>":"1f613","<Sweat>":"1f613","<失望>":"1f640","<Let Down>":"1f640","<低落>":"1f61e","<Low>":"1f61e","<呸>":"1f616","<Ugh>":"1f616","<焦虑>":"1f625","<焦慮>":"1f625","<Anxious>":"1f625","<担心>":"1f630","<擔心>":"1f630","<Worried>":"1f630","<震惊>":"1f628","<震驚>":"1f628","<Shocked>":"1f628","<悔恨>":"1f62b","<D’oh!>":"1f62b","<眼泪>":"1f622","<眼淚>":"1f622","<Tear>":"1f622","<哭>":"1f62d","<Cry>":"1f62d","<破涕为笑>":"1f602","<破涕為笑>":"1f602","<Lol>":"1f602","<晕>":"1f632","<Dead>":"1f632","<恐惧>":"1f631","<恐懼>":"1f631","<Terror>":"1f631","<心烦>":"1f620","<心煩>":"1f620","<Upset>":"1f620","<生气>":"1f63e","<生氣>":"1f63e","<Angry>":"1f63e","<睡觉>":"1f62a","<睡覺>":"1f62a","<Zzz>":"1f62a","<生病>":"1f637","<Sick>":"1f637","<恶魔>":"1f47f","<惡魔>":"1f47f","<Demon>":"1f47f","<外星人>":"1f47d","<Alien>":"1f47d","<心>":"2764","<Heart>":"2764","<心碎>":"1f494","<Heartbroken>":"1f494","<BrokenHeart>":"1f494","<丘比特>":"1f498","<Cupid>":"1f498","<闪烁>":"2728","<閃爍>":"2728","<Twinkle>":"2728","<星星>":"1f31f","<Star>":"1f31f","<叹号>":"2755","<嘆號>":"2755","<!>":"2755","<问号>":"2754","<問號>":"2754","<?>":"2754","<睡着>":"1f4a4","<睡著>":"1f4a4","<Asleep>":"1f4a4","<水滴>":"1f4a6","<Drops>":"1f4a6","<音乐>":"1f3b5","<音樂>":"1f3b5","<Music>":"1f3b5","<火>":"1f525","<Fire>":"1f525","<便便>":"1f4a9","<Poop>":"1f4a9","<强>":"1f44d","<強>":"1f44d","<ThumbsUp>":"1f44d","<弱>":"1f44e","<ThumbsDown>":"1f44e","<拳头>":"1f44a","<拳頭>":"1f44a","<Punch>":"1f44a","<胜利>":"270c","<勝利>":"270c","<Peace>":"270c","<上>":"1f446","<Up>":"1f446","<下>":"1f447","<Down>":"1f447","<右>":"1f449","<Right>":"1f449","<左>":"1f448","<Left>":"1f448","<第一>":"261d","<#1>":"261d","<强壮>":"1f4aa","<強壯>":"1f4aa","<Strong>":"1f4aa","<吻>":"1f48f","<Kissing>":"1f48f","<热恋>":"1f491","<熱戀>":"1f491","<Couple>":"1f491","<男孩>":"1f466","<Boy>":"1f466","<女孩>":"1f467","<Girl>":"1f467","<女士>":"1f469","<Lady>":"1f469","<男士>":"1f468","<Man>":"1f468","<天使>":"1f47c","<Angel>":"1f47c","<骷髅>":"1f480","<骷髏>":"1f480","<Skull>":"1f480","<红唇>":"1f48b","<紅唇>":"1f48b","<Lips>":"1f48b","<太阳>":"2600","<太陽>":"2600","<Sun>":"2600","<下雨>":"2614","<Rain>":"2614","<多云>":"2601","<多雲>":"2601","<Cloud>":"2601","<雪人>":"26c4","<Snowman>":"26c4","<月亮>":"1f319","<Moon>":"1f319","<闪电>":"26a1","<閃電>":"26a1","<Lightning>":"26a1","<海浪>":"1f30a","<Waves>":"1f30a","<猫>":"1f431","<貓>":"1f431","<Cat>":"1f431","<小狗>":"1f429","<Doggy>":"1f429","<老鼠>":"1f42d","<Mouse>":"1f42d","<仓鼠>":"1f439","<倉鼠>":"1f439","<Hamster>":"1f439","<兔子>":"1f430","<Rabbit>":"1f430","<狗>":"1f43a","<Dog>":"1f43a","<青蛙>":"1f438","<Frog>":"1f438","<老虎>":"1f42f","<Tiger>":"1f42f","<考拉>":"1f428","<Koala>":"1f428","<熊>":"1f43b","<Bear>":"1f43b","<猪>":"1f437","<豬>":"1f437","<Pig>":"1f437","<牛>":"1f42e","<Cow>":"1f42e","<野猪>":"1f417","<野豬>":"1f417","<Boar>":"1f417","<猴子>":"1f435","<Monkey>":"1f435","<马>":"1f434","<馬>":"1f434","<Horse>":"1f434","<蛇>":"1f40d","<Snake>":"1f40d","<鸽子>":"1f426","<鴿子>":"1f426","<Pigeon>":"1f426","<鸡>":"1f414","<雞>":"1f414","<Chicken>":"1f414","<企鹅>":"1f427","<企鵝>":"1f427","<Penguin>":"1f427","<毛虫>":"1f41b","<毛蟲>":"1f41b","<Caterpillar>":"1f41b","<章鱼>":"1f419","<八爪魚>":"1f419","<Octopus>":"1f419","<鱼>":"1f420","<魚>":"1f420","<Fish>":"1f420","<鲸鱼>":"1f433","<鯨魚>":"1f433","<Whale>":"1f433","<海豚>":"1f42c","<Dolphin>":"1f42c","<玫瑰>":"1f339","<Rose>":"1f339","<花>":"1f33a","<Flower>":"1f33a","<棕榈树>":"1f334","<棕櫚樹>":"1f334","<Palm>":"1f334","<仙人掌>":"1f335","<Cactus>":"1f335","<礼盒>":"1f49d","<禮盒>":"1f49d","<Candy Box>":"1f49d","<南瓜灯>":"1f383","<南瓜燈>":"1f383","<Jack-o-lantern>":"1f383","<鬼魂>":"1f47b","<Ghost>":"1f47b","<圣诞老人>":"1f385","<聖誕老人>":"1f385","<Santa>":"1f385","<圣诞树>":"1f384","<聖誕樹>":"1f384","<Xmas Tree>":"1f384","<礼物>":"1f381","<禮物>":"1f381","<Gift>":"1f381","<铃>":"1f514","<鈴鐺>":"1f514","<Bell>":"1f514","<庆祝>":"1f389","<慶祝>":"1f389","<Party>":"1f389","<气球>":"1f388","<氣球>":"1f388","<Balloon>":"1f388","<CD>":"1f4bf","<相机>":"1f4f7","<相機>":"1f4f7","<Camera>":"1f4f7","<录像机>":"1f3a5","<錄影機>":"1f3a5","<Film Camera>":"1f3a5","<电脑>":"1f4bb","<電腦>":"1f4bb","<Computer>":"1f4bb","<电视>":"1f4fa","<電視>":"1f4fa","<TV>":"1f4fa","<电话>":"1f4de","<電話>":"1f4de","<Phone>":"1f4de","<解锁>":"1f513","<解鎖>":"1f513","<Unlocked>":"1f513","<锁>":"1f512","<鎖>":"1f512","<Locked>":"1f512","<钥匙>":"1f511","<鑰匙>":"1f511","<Key>":"1f511","<成交>":"1f528","<Judgement>":"1f528","<灯泡>":"1f4a1","<燈泡>":"1f4a1","<Light bulb>":"1f4a1","<邮箱>":"1f4eb","<郵箱>":"1f4eb","<Mail>":"1f4eb","<浴缸>":"1f6c0","<Wash>":"1f6c0","<钱>":"1f4b2","<錢>":"1f4b2","<Money>":"1f4b2","<炸弹>":"1f4a3","<炸彈>":"1f4a3","<Bomb>":"1f4a3","<手枪>":"1f52b","<手槍>":"1f52b","<Pistol>":"1f52b","<药丸>":"1f48a","<藥丸>":"1f48a","<Pill>":"1f48a","<橄榄球>":"1f3c8","<橄欖球>":"1f3c8","<Football>":"1f3c8","<篮球>":"1f3c0","<籃球>":"1f3c0","<Basketball>":"1f3c0","<足球>":"26bd","<Soccer Ball>":"26bd","<棒球>":"26be","<Baseball>":"26be","<高尔夫>":"26f3","<高爾夫>":"26f3","<Golf>":"26f3","<奖杯>":"1f3c6","<獎盃>":"1f3c6","<Trophy>":"1f3c6","<入侵者>":"1f47e","<Invader>":"1f47e","<唱歌>":"1f3a4","<Singing>":"1f3a4","<吉他>":"1f3b8","<Guitar>":"1f3b8","<比基尼>":"1f459","<Bikini>":"1f459","<皇冠>":"1f451","<Crown>":"1f451","<雨伞>":"1f302","<雨傘>":"1f302","<Umbrella>":"1f302","<手提包>":"1f45c","<Purse>":"1f45c","<口红>":"1f484","<Lipstick>":"1f484","<戒指>":"1f48d","<Ring>":"1f48d","<钻石>":"1f48e","<鑽石>":"1f48e","<Gem>":"1f48e","<咖啡>":"2615","<Coffee>":"2615","<啤酒>":"1f37a","<Beer>":"1f37a","<干杯>":"1f37b","<乾杯>":"1f37b","<Toast>":"1f37b","<鸡尾酒>":"1f377","<雞尾酒>":"1f377","<Martini>":"1f377","<汉堡>":"1f354","<漢堡>":"1f354","<Burger>":"1f354","<薯条>":"1f35f","<薯條>":"1f35f","<Fries>":"1f35f","<意面>":"1f35d","<意粉>":"1f35d","<Sphaghetti>":"1f35d","<寿司>":"1f363","<壽司>":"1f363","<Sushi>":"1f363","<面条>":"1f35c","<麵條>":"1f35c","<Noodles>":"1f35c","<煎蛋>":"1f373","<Eggs>":"1f373","<冰激凌>":"1f366","<雪糕>":"1f366","<Ice Cream>":"1f366","<蛋糕>":"1f382","<Cake>":"1f382","<苹果>":"1f34f","<蘋果>":"1f34f","<Apple>":"1f34f","<飞机>":"2708","<飛機>":"2708","<Plane>":"2708","<火箭>":"1f680","<Rocket ship>":"1f680","<自行车>":"1f6b2","<單車>":"1f6b2","<Bike>":"1f6b2","<高铁>":"1f684","<高鐵>":"1f684","<Bullet Train>":"1f684","<警告>":"26a0","<Warning>":"26a0","<旗>":"1f3c1","<Flag>":"1f3c1","<男人>":"1f6b9","<男>":"1f6b9","<Men>":"1f6b9","<女人>":"1f6ba","<女>":"1f6ba","<Women>":"1f6ba","<O>":"2b55","<X>":"274e","<版权>":"a9","<版權>":"a9","<Copyright>":"a9","<注册商标>":"ae","<注冊商標>":"ae","<Registered TM>":"ae","<商标>":"2122","<商標>":"2122","<Trademark>":"2122"}}}}function t(){return function(e){if(angular.isString(e)){var t={"/:,@P":"[偷笑]","/:,@-D":"[愉快]","/::d":"[白眼]","/::g":"[饥饿]","/::!":"[惊恐]","/::L":"[流汗]","/::>":"[憨笑]","/::-S":"[嘘]","/:,@@":"[晕]","/::8":"[疯了]","/:,@!":"[衰]","/:!!!":"[骷髅]","/:bye":"[再见]","/:wipe":"[擦汗]","/:dig":"[抠鼻]","/:handclap":"[鼓掌]","/:&-(":"[糗大了]","/:B-)":"[坏笑]","/::-O":"[哈欠]","/:>-|":"[鄙视]","/:P-(":"[委屈]","/::'|":"[快哭了]","/:X-)":"[阴险]","/::*":"[亲亲]","/:@x":"[吓]","/:8*":"[可怜]","/:pd":"[菜刀]","/:<W>":"[西瓜]","/:&lt;W>":"[西瓜]","/:beer":"[啤酒]","/:basketb":"[篮球]","/:oo":"[乒乓]","/:eat":"[饭]","/:pig":"[猪头]","/:rose":"[玫瑰]","/:fade":"[凋谢]","/:showlove":"[嘴唇]","/:heart":"[爱心]","/:li":"[闪电]","/:bome":"[炸弹]","/:kn":"[刀]","/:footb":"[足球]","/:ladybug":"[瓢虫]","/:shit":"[便便]","/:moon":"[月亮]","/:sun":"[太阳]","/:gift":"[礼物]","/:hug":"[拥抱]","/:strong":"[强]","/:weak":"[弱]","/:share":"[握手]","/:v":"[胜利]","/:@)":"[抱拳]","/:jj":"[勾引]","/:bad":"[差劲]","/:lvu":"[爱你]","/:no":"[NO]","/:ok":"[OK]","/:jump":"[跳跳]","/:shake":"[发抖]","/:<O>":"[怄火]","/:&lt;O>":"[怄火]","/:circle":"[转圈]","/:kotow":"[磕头]","/:turn":"[回头]","/:skip":"[跳绳]","/:oY":"[投降]","/:,@x":"[嘘]"};var n={"[微笑]":"qqemoji0","[撇嘴]":"qqemoji1","[色]":"qqemoji2","[发呆]":"qqemoji3","[得意]":"qqemoji4","[流泪]":"qqemoji5","[害羞]":"qqemoji6","[闭嘴]":"qqemoji7","[睡]":"qqemoji8","[大哭]":"qqemoji9","[尴尬]":"qqemoji10","[发怒]":"qqemoji11","[调皮]":"qqemoji12","[呲牙]":"qqemoji13","[惊讶]":"qqemoji14","[难过]":"qqemoji15","[酷]":"qqemoji16","[冷汗]":"qqemoji17","[抓狂]":"qqemoji18","[吐]":"qqemoji19","[偷笑]":"qqemoji20","[愉快]":"qqemoji21","[白眼]":"qqemoji22","[傲慢]":"qqemoji23","[饥饿]":"qqemoji24","[困]":"qqemoji25","[惊恐]":"qqemoji26","[流汗]":"qqemoji27","[憨笑]":"qqemoji28","[悠闲]":"qqemoji29","[奋斗]":"qqemoji30","[咒骂]":"qqemoji31","[疑问]":"qqemoji32","[嘘]":"qqemoji33","[晕]":"qqemoji34","[疯了]":"qqemoji35","[衰]":"qqemoji36","[骷髅]":"qqemoji37","[敲打]":"qqemoji38","[再见]":"qqemoji39","[擦汗]":"qqemoji40","[抠鼻]":"qqemoji41","[鼓掌]":"qqemoji42","[糗大了]":"qqemoji43","[坏笑]":"qqemoji44","[左哼哼]":"qqemoji45","[右哼哼]":"qqemoji46","[哈欠]":"qqemoji47","[鄙视]":"qqemoji48","[委屈]":"qqemoji49","[快哭了]":"qqemoji50","[阴险]":"qqemoji51","[亲亲]":"qqemoji52","[吓]":"qqemoji53","[可怜]":"qqemoji54","[菜刀]":"qqemoji55","[西瓜]":"qqemoji56","[啤酒]":"qqemoji57","[篮球]":"qqemoji58","[乒乓]":"qqemoji59","[咖啡]":"qqemoji60","[饭]":"qqemoji61","[猪头]":"qqemoji62","[玫瑰]":"qqemoji63","[凋谢]":"qqemoji64","[嘴唇]":"qqemoji65","[爱心]":"qqemoji66","[心碎]":"qqemoji67","[蛋糕]":"qqemoji68","[闪电]":"qqemoji69","[炸弹]":"qqemoji70","[刀]":"qqemoji71","[足球]":"qqemoji72","[瓢虫]":"qqemoji73","[便便]":"qqemoji74","[月亮]":"qqemoji75","[太阳]":"qqemoji76","[礼物]":"qqemoji77","[拥抱]":"qqemoji78","[强]":"qqemoji79","[弱]":"qqemoji80","[握手]":"qqemoji81","[胜利]":"qqemoji82","[抱拳]":"qqemoji83","[勾引]":"qqemoji84","[拳头]":"qqemoji85","[差劲]":"qqemoji86","[爱你]":"qqemoji87","[NO]":"qqemoji88","[OK]":"qqemoji89","[爱情]":"qqemoji90","[飞吻]":"qqemoji91","[跳跳]":"qqemoji92","[发抖]":"qqemoji93","[怄火]":"qqemoji94","[转圈]":"qqemoji95","[磕头]":"qqemoji96","[回头]":"qqemoji97","[跳绳]":"qqemoji98","[投降]":"qqemoji99","[激动]":"qqemoji100","[乱舞]":"qqemoji101","[献吻]":"qqemoji102","[左太极]":"qqemoji103","[右太极]":"qqemoji104"};var a={"#[1|58389]":"emoji1f604","#[1|57430]":"emoji1f60a","#[1|57431]":"emoji1f603","#[1|58388]":"emoji263a","#[1|58373]":"emoji1f609","#[1|57606]":"emoji1f60d","#[1|58392]":"emoji1f618","#[1|58391]":"emoji1f61a","#[1|58381]":"emoji1f633","#[1|58372]":"emoji1f63c","#[1|58378]":"emoji1f60c","#[1|57605]":"emoji1f61c","#[1|58377]":"emoji1f445","#[1|58382]":"emoji1f612","#[1|58370]":"emoji1f60f","#[1|57608]":"emoji1f613","#[1|58371]":"emoji1f640","#[1|57432]":"emoji1f61e","#[1|58375]":"emoji1f616","#[1|58369]":"emoji1f625","#[1|58383]":"emoji1f630","#[1|58379]":"emoji1f628","#[1|58374]":"emoji1f62b","#[1|58387]":"emoji1f622","#[1|58385]":"emoji1f62d","#[1|58386]":"emoji1f602","#[1|58384]":"emoji1f632","#[1|57607]":"emoji1f631","#[1|57433]":"emoji1f620","#[1|58390]":"emoji1f63e","#[1|58376]":"emoji1f62a","#[1|58380]":"emoji1f637","#[1|57626]":"emoji1f47f","#[1|57612]":"emoji1f47d","#[1|57378]":"emoji2764","#[1|57379]":"emoji1f494","#[1|58153]":"emoji1f498","#[1|58158]":"emoji2728","#[1|58165]":"emoji1f31f","#[1|58167]":"emoji2755","#[1|58166]":"emoji2754","#[1|57660]":"emoji1f4a4","#[1|58161]":"emoji1f4a6","#[1|57406]":"emoji1f3b5","#[1|57629]":"emoji1f525","#[1|57434]":"emoji1f4a9","#[1|57358]":"emoji1f44d","#[1|58401]":"emoji1f44e","#[1|57357]":"emoji1f44a","#[1|57361]":"emoji270c","#[1|57902]":"emoji1f446","#[1|57903]":"emoji1f447","#[1|57905]":"emoji1f449","#[1|57904]":"emoji1f448","#[1|57359]":"emoji261d","#[1|57676]":"emoji1f4aa","#[1|57617]":"emoji1f48f","#[1|58405]":"emoji1f491","#[1|57345]":"emoji1f466","#[1|57346]":"emoji1f467","#[1|57349]":"emoji1f469","#[1|57348]":"emoji1f468","#[1|57422]":"emoji1f47c","#[1|57628]":"emoji1f480","#[1|57347]":"emoji1f48b","#[1|57418]":"emoji2600","#[1|57419]":"emoji2614","#[1|57417]":"emoji2601","#[1|57416]":"emoji26c4","#[1|57420]":"emoji1f319","#[1|57661]":"emoji26a1","#[1|58430]":"emoji1f30a","#[1|57423]":"emoji1f431","#[1|57426]":"emoji1f429","#[1|57427]":"emoji1f42d","#[1|58660]":"emoji1f439","#[1|58668]":"emoji1f430","#[1|58666]":"emoji1f43a","#[1|58673]":"emoji1f438","#[1|57424]":"emoji1f42f","#[1|58663]":"emoji1f428","#[1|57425]":"emoji1f43b","#[1|57611]":"emoji1f437","#[1|58667]":"emoji1f42e","#[1|58671]":"emoji1f417","#[1|57609]":"emoji1f435","#[1|57370]":"emoji1f434","#[1|58669]":"emoji1f40d","#[1|58657]":"emoji1f426","#[1|58670]":"emoji1f414","#[1|57429]":"emoji1f427","#[1|58661]":"emoji1f41b","#[1|57610]":"emoji1f419","#[1|58658]":"emoji1f420","#[1|57428]":"emoji1f433","#[1|58656]":"emoji1f42c","#[1|57394]":"emoji1f339","#[1|58115]":"emoji1f33a","#[1|58119]":"emoji1f334","#[1|58120]":"emoji1f335","#[1|58423]":"emoji1f49d","#[1|58437]":"emoji1f383","#[1|57627]":"emoji1f47b","#[1|58440]":"emoji1f385","#[1|57395]":"emoji1f384","#[1|57618]":"emoji1f381","#[1|58149]":"emoji1f514","#[1|58130]":"emoji1f389","#[1|58128]":"emoji1f388","#[1|57638]":"emoji1f4bf","#[1|57352]":"emoji1f4f7","#[1|57405]":"emoji1f3a5","#[1|57356]":"emoji1f4bb","#[1|57642]":"emoji1f4fa","#[1|57353]":"emoji1f4de","#[1|57669]":"emoji1f513","#[1|57668]":"emoji1f512","#[1|57407]":"emoji1f511","#[1|57622]":"emoji1f528","#[1|57615]":"emoji1f4a1","#[1|57601]":"emoji1f4eb","#[1|57663]":"emoji1f6c0","#[1|57647]":"emoji1f4b2","#[1|58129]":"emoji1f4a3","#[1|57619]":"emoji1f52b","#[1|58127]":"emoji1f48a","#[1|58411]":"emoji1f3c8","#[1|58410]":"emoji1f3c0","#[1|57368]":"emoji26bd","#[1|57366]":"emoji26be","#[1|57364]":"emoji26f3","#[1|57649]":"emoji1f3c6","#[1|57643]":"emoji1f47e","#[1|57404]":"emoji1f3a4","#[1|57409]":"emoji1f3b8","#[1|58146]":"emoji1f459","#[1|57614]":"emoji1f451","#[1|58428]":"emoji1f302","#[1|58147]":"emoji1f45c","#[1|58140]":"emoji1f484","#[1|57396]":"emoji1f48d","#[1|57397]":"emoji1f48e","#[1|57413]":"emoji2615","#[1|57415]":"emoji1f37a","#[1|58124]":"emoji1f37b","#[1|57412]":"emoji1f377","#[1|57632]":"emoji1f354","#[1|58171]":"emoji1f35f","#[1|58175]":"emoji1f35d","#[1|58180]":"emoji1f363","#[1|58176]":"emoji1f35c","#[1|57671]":"emoji1f373","#[1|58170]":"emoji1f366","#[1|58187]":"emoji1f382","#[1|58181]":"emoji1f34f","#[1|57373]":"emoji2708","#[1|57613]":"emoji1f680","#[1|57654]":"emoji1f6b2","#[1|58421]":"emoji1f684","#[1|57938]":"emoji26a0","#[1|57650]":"emoji1f3c1","#[1|57656]":"emoji1f6b9","#[1|57657]":"emoji1f6ba","#[1|58162]":"emoji2b55","#[1|58163]":"emoji274e","#[1|57934]":"emojia9","#[1|57935]":"emojiae","#[1|58679]":"emoji2122"};var o={"#[1|55357]#[1|56447]":"emoji1f47f","#[1|55357]#[1|56443]":"emoji1f47b","#[1|55357]#[1|56477]":"emoji1f49d","#[1|55357]#[1|56911]":"emoji1f64f","#[1|55357]#[1|56490]":"emoji1f4aa","#[1|55357]#[1|56496]":"emoji1f4b2","#[1|55356]#[1|57218]":"emoji1f382","#[1|55356]#[1|57224]":"emoji1f388","#[1|55356]#[1|57217]":"emoji1f381"};var i=["\ud83c[\udf00-\udfff]","\ud83d[\udc00-\ude4f]","\ud83d[\ude80-\udeff]"];for(var r in t){e=e.replace(new RegExp(r.replace(/[-\/\\^$*+?.()|[\]{}]/g,"\\$&"),"g"),t[r])}return e.replace(new RegExp("(\\[)[\\u4e00-\\u9fa5OKNO]+(\\])","g"),function(e,t,i,r){if(n.hasOwnProperty(e)){return'<img class="qqemoji '+n[e]+'" alt="'+e+'" title="'+e+'" type="filter" src="/source/images/spacer.gif">'}return e}).replace(new RegExp("(\\#\\[1\\|)\\d+(\\])","g"),function(e,t,i,r){if(a.hasOwnProperty(e)){return'<img class="emoji '+a[e]+'" alt="'+e+'" type="filter" src="/source/images/spacer.gif">'}return e}).replace(new RegExp("(\\#\\[1\\|)\\d+(\\]\\#\\[1\\|)\\d+(\\])","g"),function(e,t,i,r){if(o.hasOwnProperty(e)){return'<img class="emoji '+o[e]+'" alt="'+e+'" type="filter" src="/source/images/spacer.gif">'}return e})}return e}}function i(){var e={EmojiCodeMap:r,parseHtmlToSend:t};var r={"<笑脸>":"#[1|58389]","<开心>":"#[1|57430]","<大笑>":"#[1|57431]","<热情>":"#[1|58388]","<眨眼>":"#[1|58373]","<色>":"#[1|57606]","<接吻>":"#[1|58392]","<亲吻>":"#[1|58391]","<脸红>":"#[1|58381]","<露齿笑>":"#[1|58372]","<满意>":"#[1|58378]","<戏弄>":"#[1|57605]","<吐舌>":"#[1|58377]","<无语>":"#[1|58382]","<得意>":"#[1|58370]","<汗>":"#[1|57608]","<失望>":"#[1|58371]","<低落>":"#[1|57432]","<呸>":"#[1|58375]","<焦虑>":"#[1|58369]","<担心>":"#[1|58383]","<震惊>":"#[1|58379]","<悔恨>":"#[1|58374]","<眼泪>":"#[1|58387]","<哭>":"#[1|58385]","<破涕为笑>":"#[1|58386]","<晕>":"#[1|58384]","<恐惧>":"#[1|57607]","<心烦>":"#[1|57433]","<生气>":"#[1|58390]","<睡觉>":"#[1|58376]","<生病>":"#[1|58380]","<恶魔>":"#[1|57626]","<外星人>":"#[1|57612]","<心>":"#[1|57378]","<心碎>":"#[1|57379]","<丘比特>":"#[1|58153]","<闪烁>":"#[1|58158]","<星星>":"#[1|58165]","<叹号>":"#[1|58167]","<问号>":"#[1|58166]","<睡着>":"#[1|57660]","<水滴>":"#[1|58161]","<音乐>":"#[1|57406]","<火>":"#[1|57629]","<便便>":"#[1|57434]","<强>":"#[1|57358]","<弱>":"#[1|58401]","<拳头>":"#[1|57357]","<胜利>":"#[1|57361]","<上>":"#[1|57902]","<下>":"#[1|57903]","<右>":"#[1|57905]","<左>":"#[1|57904]","<第一>":"#[1|57359]","<强壮>":"#[1|57676]","<吻>":"#[1|57617]","<热恋>":"#[1|58405]","<男孩>":"#[1|57345]","<女孩>":"#[1|57346]","<女士>":"#[1|57349]","<男士>":"#[1|57348]","<天使>":"#[1|57422]","<骷髅>":"#[1|57628]","<红唇>":"#[1|57347]","<太阳>":"#[1|57418]","<下雨>":"#[1|57419]","<多云>":"#[1|57417]","<雪人>":"#[1|57416]","<月亮>":"#[1|57420]","<闪电>":"#[1|57661]","<海浪>":"#[1|58430]","<猫>":"#[1|57423]","<小狗>":"#[1|57426]","<老鼠>":"#[1|57427]","<仓鼠>":"#[1|58660]","<兔子>":"#[1|58668]","<狗>":"#[1|58666]","<青蛙>":"#[1|58673]","<老虎>":"#[1|57424]","<考拉>":"#[1|58663]","<熊>":"#[1|57425]","<猪>":"#[1|57611]","<牛>":"#[1|58667]","<野猪>":"#[1|58671]","<猴子>":"#[1|57609]","<马>":"#[1|57370]","<蛇>":"#[1|58669]","<鸽子>":"#[1|58657]","<鸡>":"#[1|58670]","<企鹅>":"#[1|57429]","<毛虫>":"#[1|58661]","<章鱼>":"#[1|57610]","<鱼>":"#[1|58658]","<鲸鱼>":"#[1|57428]","<海豚>":"#[1|58656]","<玫瑰>":"#[1|57394]","<花>":"#[1|58115]","<棕榈树>":"#[1|58119]","<仙人掌>":"#[1|58120]","<礼盒>":"#[1|58423]","<南瓜灯>":"#[1|58437]","<鬼魂>":"#[1|57627]","<圣诞老人>":"#[1|58440]","<圣诞树>":"#[1|57395]","<礼物>":"#[1|57618]","<铃>":"#[1|58149]","<庆祝>":"#[1|58130]","<气球>":"#[1|58128]","<CD>":"#[1|57638]","<相机>":"#[1|57352]","<录像机>":"#[1|57405]","<电脑>":"#[1|57356]","<电视>":"#[1|57642]","<电话>":"#[1|57353]","<解锁>":"#[1|57669]","<锁>":"#[1|57668]","<钥匙>":"#[1|57407]","<成交>":"#[1|57622]","<灯泡>":"#[1|57615]","<邮箱>":"#[1|57601]","<浴缸>":"#[1|57663]","<钱>":"#[1|57647]","<炸弹>":"#[1|58129]","<手枪>":"#[1|57619]","<药丸>":"#[1|58127]","<橄榄球>":"#[1|58411]","<篮球>":"#[1|58410]","<足球>":"#[1|57368]","<棒球>":"#[1|57366]","<高尔夫>":"#[1|57364]","<奖杯>":"#[1|57649]","<入侵者>":"#[1|57643]","<唱歌>":"#[1|57404]","<吉他>":"#[1|57409]","<比基尼>":"#[1|58146]","<皇冠>":"#[1|57614]","<雨伞>":"#[1|58428]","<手提包>":"#[1|58147]","<口红>":"#[1|58140]","<戒指>":"#[1|57396]","<钻石>":"#[1|57397]","<咖啡>":"#[1|57413]","<啤酒>":"#[1|57415]","<干杯>":"#[1|58124]","<鸡尾酒>":"#[1|57412]","<汉堡>":"#[1|57632]","<薯条>":"#[1|58171]","<意面>":"#[1|58175]","<寿司>":"#[1|58180]","<面条>":"#[1|58176]","<煎蛋>":"#[1|57671]","<冰激凌>":"#[1|58170]","<蛋糕>":"#[1|58187]","<苹果>":"#[1|58181]","<飞机>":"#[1|57373]","<火箭>":"#[1|57613]","<自行车>":"#[1|57654]","<高铁>":"#[1|58421]","<警告>":"#[1|57938]","<旗>":"#[1|57650]","<男人>":"#[1|57656]","<女人>":"#[1|57657]","<O>":"#[1|58162]","<X>":"#[1|58163]","<版权>":"#[1|57934]","<注册商标>":"#[1|57935]","<商标>":"#[1|58679]"};function t(e){if(angular.isString(e)){e=e.replace(/<img [^>]*src=['"]([^'"]+)[^>]*>/gi,function(e){var t=angular.element(e);if(t.hasClass("qqemoji")){if(t.attr("type")==="filter"){return t.attr("alt")}return t.attr("text")}else if(t.hasClass("emoji")){if(t.attr("type")==="filter"){return t.attr("alt")}var i="<"+t.attr("text")+">";if(r.hasOwnProperty(i)){return r[i]}}return e}).replace(/<br\s*[\/]?>/gi,"\n")}return angular.element("<div></div>").html(e).text()}return e}})();(function(){o.$inject=["$window"];p.$inject=["alertService"];m.$inject=["alertService","$http","ConsoleConfig"];h.$inject=["alertService"];angular.module("eweiApp.common").directive("contenteditable",e).directive("ngShadow",t).directive("setIframeContent",i).provider("showErrorsConfig",r).directive("showErrors",n).directive("dynamicFrame",a).directive("resizeChatHeight",o).directive("infiniteScroll",s).directive("responseTicketDetail",l).directive("eweiTimer",c).directive("disableNgAnimate",u).directive("eweiTextEditor",d).directive("audioError",f).directive("copySomeThing",p).directive("webFormStyle",m).directive("submitCustomFieldSet",h).directive("eweiWangEditor",g).directive("copyImgUpload",v).directive("typeaheadScrollLoad",k).directive("iconFileType",y).directive("imageFileType",w);e.$inject=["locker","$stateParams"];function e(r,n){var e={restrict:"A",link:t,require:"?ngModel"};return e;function t(t,a,s,o){if(!o){return}a.html(r.driver("session").namespace("eweiApp.chat").get(n.id));o.$render=function(){var e=o.$viewValue||"";a.html(e);var t=a[0];if(t){if(document.createRange&&window.getSelection&&t.childNodes.length){var i=document.createRange();var r=window.getSelection();var n=t.childNodes[t.childNodes.length-1];i.setStart(n,n.length);i.collapse(true);r.removeAllRanges();r.addRange(i)}}};a.on("blur change keyup keydown focus",function(e){t.$applyAsync(i)});i();function i(){var e=a.html();var t=/(<br>\s*$)/;if(s.scripBr){e&&(e=e.replace(t,""))}if(s.hasCache!=="false"){r.driver("session").namespace("eweiApp.chat").put(n.id,e)}o.$setViewValue(e);void 0}a[0].addEventListener("paste",function(e){if(s.pasteForText==="true"){var t=e.clipboardData||e.originalEvent.clipboardData;var i;if(t==null){i=window.clipboardData&&window.clipboardData.getData("text")}else{i=t.getData("text/plain")}if(i){e.preventDefault();e.stopPropagation();if(navigator.userAgent.indexOf("Firefox")>-1){e=e.originalEvent||e;var r=e.clipboardData;var i=r.getData("text");if(i&&i.length>0){var n=window.getSelection(),a=n.getRangeAt(0),o=a.createContextualFragment(i.replace(/</g,"&lt;").replace(/>/g,"&gt;"));a.insertNode(o);n.collapseToEnd();document.execCommand("Delete","false",null)}}else{document.execCommand("insertHTML","false",i)}}}})}}function t(){return{restrict:"A",transclude:true,scope:{},template:"<div ng-transclude></div>",link:function(e,t,i){void 0;angular.element.prototype.shadow=function(){var e=angular.element(this);var t=e[0].createShadowRoot();return t};var r=angular.element(angular.element(t)[0]).shadow();var n=angular.element(t).children()[0];void 0;r.appendChild(n)}}}function i(){var e={restrict:"A",scope:{setIframeContent:"@"},link:function(r,e,t){var n=angular.element(e).find("iframe");function i(e){var t=e[0].scrollWidth||e.outerWidth();var i=t;if(t>860){i=860}if(t<500){i=500}n.css({width:i,border:"none"})}var a=0;function o(e){var t=e[0].scrollHeight||e.outerHeight()+10;void 0;if(t==10){if(a<20){r.$evalAsync(function(){o(e)});a++}else{n.css({height:"700px",border:"none"})}return}var i=t;if(t>700){i=700}if(t<30){i=30}n.css({height:i,border:"none"})}n.load(function(){var e=n.contents().find("body");e.css({border:"none"});e.html(r.setIframeContent);i(e);r.$evalAsync(function(){o(e);n.show()})})}};return e}function r(){var t;t=false;this.showSuccess=function(e){return t=e};this.$get=function(){return{showSuccess:t}}}n.$inject=["$timeout","showErrorsConfig"];function n(d,i){var f,r;f=function(e){var t;t=i.showSuccess;if(e&&e.showSuccess!=null){t=e.showSuccess}return t};r=function(e,t,i,r){var n,a,o,s,l,c,u;n=false;l=e.$eval(i.showErrors);c=f(l);a=t[0].querySelector("[name]");s=angular.element(a);o=s.attr("name");if(!o){throw"show-errors element has no child input elements with a 'name' attribute"}s.bind("blur",function(){n=true;return u(r[o].$invalid)});e.$watch(function(){return r[o]&&r[o].$invalid},function(e){if(!n){return}return u(e)});e.$on("show-errors-check-validity",function(e,t){void 0;if(t&&t!==r.$name){return}return u(r[o].$invalid)});e.$on("show-errors-reset",function(){return d(function(){t.removeClass("has-error");t.removeClass("has-success");return n=false},0,false)});return u=function(e){void 0;t.toggleClass("has-error",e);if(c){return t.toggleClass("has-success",!e)}}};return{restrict:"A",require:"^form",compile:function(e,t){if(!e.hasClass("form-group")){throw"show-errors element does not have the 'form-group' class"}return r}}}a.$inject=["$rootScope","ConsoleConfig"];function a(e,n){return{restrict:"E",scope:{},link:function(e,t,i){var r=n.domainRoot;r="//api."+r;t.append('<iframe style="height:100%;width:100%" src="'+r+"/sso_from_ewei_web.json?provider_id="+n.provider.id+"&_token="+getCookie("user_token")+'"></iframe>')}}}function o(e){var t={restrict:"A",scope:{maxHeight:"@resizeChatHeight",content:"=ngModel",resizeFunc:"&resizeFunc"},link:function(r,n,e){r.maxHeight=parseInt(r.maxHeight,10);var i=n.outerHeight();var a=_.debounce(function(e,t){var i=43;if(n[0].scrollHeight!==e){i=""+n[0].scrollHeight+"px"}if(n[0].scrollHeight>r.maxHeight){i=r.maxHeight+"px"}if(!t){n.outerHeight(i)}if(t){$(".js-chat-content").height($(".js-chat-layout").height()-$(".js-chat-header").height()-46)}else{$(".js-chat-content").height($(".js-chat-layout").height()-$(".js-chat-header").height()-n.parent().height())}},50,true);r.$watch("content",function(e,t){a(i)},false);a(i,true);$(window).on("resize",function(){_.debounce(function(){$(".js-chat-content").height($(".js-chat-layout").height()-$(".js-chat-header").height()-$(".js-chat-footer").height())},100)()})}};return t}function s(){var e={restrict:"A",scope:{infiniteScroll:"&"},link:function(e,t,i){var r=t.find(".js-ticket-back-top");r.click(function(){t[0].scrollTop=0});t.bind("scroll",function(){if(t[0].scrollHeight-t.height()-10<t[0].scrollTop){e.infiniteScroll()}if(t[0].scrollTop>100){r.show()}else{r.hide()}});e.$on("backPageToTop",function(){t[0].scrollTop=0});e.$on("$destroy",function(){t.unbind("scroll")})}};return e}l.$inject=["$window"];function l(e){return{restrict:"A",link:function(e,t,i){t.on("click",function(){t.find("#sidebar").hide()})}}}function c(){var e={restrict:"E",template:'<span ng-bind="::start" ></span>&nbsp;<span class="js-timer"></span>',scope:{start:"=",stopTimer:"=stopTimer"},link:function(e,t,i){var r=t.find(".js-timer");var n=0;var a;var o=new Date(e.start?e.start.replace(/\-/g,"/"):"");var s=new Date;if(angular.isDate(o)){n=Math.floor((s.getTime()-o.getTime())/1e3)}if(!angular.isNumber(n)){n=0}function l(e){var t,i,r,n="";t=Math.floor(e/3600);e=e%3600;i=Math.floor(e/60);r=e%60;if(t<10){n+="0"+t+":"}else{n+=t+":"}if(i<10){n+="0"+i+":"}else{n+=i+":"}if(r<10){n+="0"+r}else{n+=r}return n}function c(){if(n){n++}else{n=1}r.html(l(n));clearTimeout(a);a=setTimeout(function(){c()},1e3)}if(!e.stopTimer){c()}var u=e.$watch("stopTimer",function(e,t,i){if(e){clearTimeout(a)}else{o=new Date(i.start?i.start.replace(/\-/g,"/"):"");s=new Date;if(angular.isDate(o)){n=Math.floor((s.getTime()-o.getTime())/1e3)}else{n=0}}},false);e.$on("stopTimer",function(){clearTimeout(a);u()});e.$on("$destroy",function(){clearTimeout(a);u()})}};return e}u.$inject=["$animate"];function u(n){return{restrict:"A",link:function(e,r,t){e.$watch(function(){return e.$eval(t.setNgAnimate,e)},function(e,t,i){n.enabled(!!e,r)})}}}function d(){return{restrict:"EA",require:"^ngModel",link:function(e,t,i,r){var n;function a(){n=angular.element(t[0]).wangEditor({menuConfig:[["createLink","unLink"]],onchange:function(e){r.$setViewValue(e)}})}r.$render=function(){var e=r.$isEmpty(r.$viewValue)?"":r.$viewValue;n.html(e)};a()}}}f.$inject=["$parse"];function f(e){return{restrict:"A",compile:function(){return function(e,t,i){t.on("error",function(e){void 0})}}}}function p(n){return{restrict:"EA",link:function(e,t,i,r){t[0].onclick=function(){var e=i.copySomeThing;var t=document.getElementById(e);t.select();document.execCommand("Copy");n.add("复制成功")}}}}function m(e,t,s){return{restrict:"EA",link:function(o,e,t,i){e[0].onclick=function(){var e=document.createElement("div");e.innerHTML=o.webFormStype.code;if(e.innerHTML=="undefined"){var t;var i=window.location.protocol+"//"+window.location.host+s.requestContextPath;if(s.provider){t=s.provider.id||""}e.innerHTML='<script ewei-pid="'+t+'" ewei-boxid="'+o.webFormStype.keyCode+'" ewei-domain="'+i+'" src="'+i+'/source/scripts/eweiBox.new.js"><\/script><p id="__ewei__box__webchat__message" style="display:none;">欢迎光临，请问有什么可以帮到你？</p><div id="__ewei__box__webchat__button__" style="position: fixed;right:10px;bottom:10px; z-index: 99999;font-family: \'Microsoft YaHei\', Tahoma, Arial, SimSun; cursor: pointer; color: #fff; height: 30px; background: #555555;text-align:center;">'+"<span style=\"display: inline-block;height: 100%;width: 30px;font-size:22px;background-color: #000;background-image: url('//help.ewei.com/source/images/chat.png');background-repeat: no-repeat;background-position: center;vertical-align: middle\"></span>"+'<span style="display: inline-block;padding-left:8px;padding-right:8px;font-size:14px;letter-spacing:2px;vertical-align: middle;">在线交谈</span>'+"</div>"}var r=e.getElementsByTagName("div")[0];var n=r.getElementsByTagName("span")[0];var a=r.getElementsByTagName("span")[1];r.style.right="initial";r.style.bottom="initial";r.style.top="initial";r.style.left="initial";r.style.backgroundColor="";n.style.position="";n.style.top="";n.style.left="";switch(o.webFormOutward.style){case"fillet":n.style.float="left";n.style.width="40px";n.style.fontSize="20px";n.style.borderTopLeftRadius="15px";n.style.borderBottomLeftRadius="15px";n.style.borderTopRightRadius="";n.style.borderBottomRightRadius="";n.style.paddingLeft="4px";n.style.height="36px";n.style.display="inline-block";n.style.position="";n.style.top="";n.style.left="";if(!a){a=document.createElement("span");r.appendChild(a)}a.style.paddingBottom="";a.style.fontSize="14px";a.style.paddingLeft="0";a.style.paddingRight="0";a.style.height="36px";a.style.width="120px";a.style.color="#FFFFFF";a.style.borderTopRightRadius="15px";a.style.borderBottomRightRadius="15px";a.style.borderTopLeftRadius="";a.style.borderBottomLeftRadius="";a.style.display="inline-block";a.style.paddingRight="10px";a.style.paddingLeft="";a.style.letterSpacing="";a.style.minWidth="";r.style.width="30px";break;case"square":n.style.float="";n.style.width="60px";n.style.borderBottomLeftRadius="6px";n.style.borderBottomRightRadius="6px";n.style.borderTopLeftRadius="6px";n.style.borderTopRightRadius="6px";n.style.fontSize="24px";n.style.height="60px";n.style.lineHeight="56px";n.style.paddingLeft="";n.style.display="block";if(a){r.removeChild(a)}r.style.width="60px";break;case"roundness":n.style.width="60px";n.style.borderTopLeftRadius="50%";n.style.borderBottomLeftRadius="50%";n.style.borderTopRightRadius="50%";n.style.borderBottomRightRadius="50%";n.style.fontSize="24px";n.style.height="60px";n.style.lineHeight="56px";n.style.paddingLeft="";n.style.display="block";if(a){r.removeChild(a)}r.style.width="60px";break}switch(o.webFormOutward.position){case"bottom_right":r.style.right="10px";if(o.webFormOutward.style=="fillet"){n.style.height="30px";a.style.height="30px";a.style.width="auto";a.style.lineHeight="30px";r.style.width="auto";r.style.height="30px"}else{r.style.height="60px"}r.style.marginTop="0px";r.style.bottom="10px";break;case"bottom_left":r.style.left="10px";r.style.marginTop="0px";if(o.webFormOutward.style=="fillet"){n.style.height="30px";a.style.height="30px";a.style.width="auto";a.style.lineHeight="30px";r.style.width="auto";r.style.height="30px"}else{r.style.height="60px"}r.style.bottom="10px";break;case"right":r.style.height="auto";r.style.right="10px";r.style.top="40%";if(o.webFormOutward.style=="fillet"){n.style.paddingLeft="";n.style.width="30px";n.style.borderTopLeftRadius="15px";n.style.borderBottomLeftRadius="";n.style.borderTopRightRadius="15px";n.style.borderBottomRightRadius="";if(a){a.style.width="";a.style.height="";a.style.paddingRight="";a.style.letterSpacing="";a.style.borderTopLeftRadius="";a.style.borderBottomLeftRadius="15px";a.style.borderTopRightRadius="";a.style.borderBottomRightRadius="15px";a.style.paddingBottom="10px";a.style.paddingLeft="5px";a.style.paddingRight="5px";a.style.lineHeight="24px";a.style.wordBreak="break-all"}}r.style.marginTop=-(r.offsetHeight/2)+"px";break;case"left":r.style.height="auto";r.style.left="10px";r.style.top="40%";if(o.webFormOutward.style=="fillet"){n.style.paddingLeft="";n.style.width="30px";n.style.borderTopLeftRadius="15px";n.style.borderBottomLeftRadius="";n.style.borderTopRightRadius="15px";n.style.borderBottomRightRadius="";if(a){a.style.width="";a.style.height="";a.style.paddingRight="";a.style.letterSpacing="";a.style.borderTopLeftRadius="";a.style.borderBottomLeftRadius="15px";a.style.borderTopRightRadius="";a.style.borderBottomRightRadius="15px";a.style.paddingBottom="10px";a.style.paddingLeft="5px";a.style.paddingRight="5px";a.style.lineHeight="24px";a.style.wordBreak="break-all"}}r.style.marginTop=-(r.offsetHeight/2)+"px"}if(o.webFormOutward.buttonBackgroundColor){if(a){a.style.backgroundColor=o.webFormOutward.buttonBackgroundColor}if(n){n.style.backgroundColor=o.webFormOutward.buttonBackgroundColor}}if(o.webFormOutward.buttonLeftColor){n.style.backgroundColor=o.webFormOutward.buttonBackgroundColor}if(o.webFormOutward.buttonTitle){if(a){a.innerHTML=o.webFormOutward.buttonTitle}}o.webFormStype.code=e.innerHTML}}}}function h(e){return{restrict:"EA",link:function(e,t,i,r){var n=t[0].getElementsByTagName("ul")[0];n.onclick=function(e){var e=e||window.event;var i=e.srcElement||e.target;if(i.nodeName.toLowerCase()=="i"){i.previousElementSibling.focus();i.previousElementSibling.onkeypress=function(e){var t=e||window.event;if(t.keyCode==13){i.previousElementSibling.blur()}}}else if(i.nodeName.toLowerCase()=="input"){}else{var t=n.getElementsByTagName("input");for(var r=0;r<t.length;r++){t[r].blur()}}}}}}g.$inject=["$compile","alertService","ConsoleConfig"];function g(h,n,a){return{restrict:"EA",require:"^ngModel",link:function(d,e,t,i){var f=new wangEditor(e[0].id);var p=window.wangEditor;var m=window.jQuery;f.config.menus=["bold","underline","italic","strikethrough","eraser","forecolor","bgcolor","|","fontsize","link","unlink","|","emotion","screenshot","picturerecording","attachment","remote_desktop","video_call"];p.createMenu(function(e){var t="screenshot";if(!e(t)){return}var i=new p.Menu({editor:f,id:t,title:"屏幕截图",$domNormal:h(m('<a href="#" tabindex="-1" ng-click="requestScreenshot();"><i class="iconfont">&#xe602;</i></a>'))(d),$domSelected:h(m('<a href="#" tabindex="-1" class="selected" ng-click="requestScreenshot();"><i class="iconfont">&#xe602;</i></a>'))(d)});f.menus[t]=i;var r="picturerecording";if(!e(r)){return}var n=new p.Menu({editor:f,id:r,title:"屏幕录像",$domNormal:h(m('<a href="#" tabindex="-1" ng-click="requestVideo(\'video\');"><i class="iconfont">&#xe60a;</i></a>'))(d),$domSelected:h(m('<a href="#" tabindex="-1" class="selected" ng-click="requestVideo(\'video\');"><i class="iconfont">&#xe60a;</i></a>'))(d)});f.menus[r]=n;var a="attachment";if(!e(a)){return}var o=new p.Menu({editor:f,id:a,title:"上传附件",$domNormal:h('<a style="opacity:0;" href="#" tabindex="-1">'+'<i class="iconfont">&#xe607;</i></div>')(d),$domSelected:h('<a href="#" class="selected" tabindex="-1">'+'<i class="iconfont">&#xe607;</i>'+"</a>")(d)});f.menus[a]=o;var s="remote_desktop";if(!e(s)||d.chatIsClose&&d.webchat.clientType!=="WEB_PC"){return}var l=new p.Menu({editor:f,id:s,title:"远程桌面",$domNormal:h('<a tabindex="-1">'+'<div class="dropdown">'+'<button class="dropdown-toggle" style="padding: 0;" type="button" ng-click="checkRemoteDeskPlug(\'remote_desk\')">'+'<i class="iconfont">&#xe606;</i>'+"</button>"+'<button class="dropdown-toggle" style="padding: 0;margin-left: 2px;" type="button" id="remoteDesk" data-toggle="dropdown" aria-haspopup="true" aria-expanded="true">'+'<i class="iconfont">&#xe60c;</i>'+"</button>"+'<ul class="dropdown-menu remote-dest-list" aria-labelledby="dropdownMenu1">'+'<li class="item clearfix" ng-mouseenter="speedFirstStyle = true" ng-click="startHD($event,true)">'+'<span style="height:28px;" class="sub" ng-class="{\'active\':speedFirst}">'+'<i class="iconfont">&#xe60d;</i>'+"</span>"+'<span class="txt" ng-class="{\'active\':speedFirst}">画质优先</span>'+"</li>"+'<li class="item clearfix" ng-mouseenter="speedFirstStyle = false"  ng-click="startHD($event,false)">'+'<span style="height:28px;" class="sub" ng-class="{\'active\':!speedFirst}">'+'<i class="iconfont">&#xe60d;</i>'+"</span>"+'<span class="txt" ng-class="{\'active\':!speedFirst}">速度优先</span>'+"</li>"+"</ul>"+"</div>"+"</a>")(d),$domSelected:h('<a tabindex="-1" class="selected" ng-if="!chatIsClose&&webchat.clientType===\'WEB_PC\'">'+"</a>")(d)});f.menus[s]=l;var c="video_call";if(!e(c)||d.chatIsClose&&d.webchat.clientType!=="WEB_PC"){return}var u=new p.Menu({editor:f,id:c,title:"视频通话",$domNormal:h('<a tabindex="-1" ng-click="checkRemoteDeskPlug(\'video_call\')" >'+'<i class="iconfont">&#xe60f;</i>'+"</a>")(d),$domSelected:h('<a tabindex="-1" class="selected" ng-click="checkRemoteDeskPlug(\'video_call\')" >'+'<i class="iconfont">&#xe60f;</i>'+"</a>")(d)});f.menus[c]=u});d.$parent.emotion_data=[{icon:"/source/js/wangEditor_v2/emotion/images/0.gif",value:"[微笑]"},{icon:"/source/js/wangEditor_v2/emotion/images/1.gif",value:"[撇嘴]"},{icon:"/source/js/wangEditor_v2/emotion/images/2.gif",value:"[色]"},{icon:"/source/js/wangEditor_v2/emotion/images/3.gif",value:"[发呆]"},{icon:"/source/js/wangEditor_v2/emotion/images/4.gif",value:"[得意]"},{icon:"/source/js/wangEditor_v2/emotion/images/5.gif",value:"[流泪]"},{icon:"/source/js/wangEditor_v2/emotion/images/6.gif",value:"[害羞]"},{icon:"/source/js/wangEditor_v2/emotion/images/7.gif",value:"[闭嘴]"},{icon:"/source/js/wangEditor_v2/emotion/images/8.gif",value:"[睡]"},{icon:"/source/js/wangEditor_v2/emotion/images/9.gif",value:"[大哭]"},{icon:"/source/js/wangEditor_v2/emotion/images/10.gif",value:"[尴尬]"},{icon:"/source/js/wangEditor_v2/emotion/images/11.gif",value:"[发怒]"},{icon:"/source/js/wangEditor_v2/emotion/images/12.gif",value:"[调皮]"},{icon:"/source/js/wangEditor_v2/emotion/images/13.gif",value:"[呲牙]"},{icon:"/source/js/wangEditor_v2/emotion/images/14.gif",value:"[惊讶]"},{icon:"/source/js/wangEditor_v2/emotion/images/15.gif",value:"[难过]"},{icon:"/source/js/wangEditor_v2/emotion/images/16.gif",value:"[酷]"},{icon:"/source/js/wangEditor_v2/emotion/images/17.gif",value:"[冷汗]"},{icon:"/source/js/wangEditor_v2/emotion/images/18.gif",value:"[抓狂]"},{icon:"/source/js/wangEditor_v2/emotion/images/19.gif",value:"[吐]"},{icon:"/source/js/wangEditor_v2/emotion/images/20.gif",value:"[偷笑]"},{icon:"/source/js/wangEditor_v2/emotion/images/21.gif",value:"[可爱]"},{icon:"/source/js/wangEditor_v2/emotion/images/22.gif",value:"[白眼]"},{icon:"/source/js/wangEditor_v2/emotion/images/23.gif",value:"[傲慢]"},{icon:"/source/js/wangEditor_v2/emotion/images/24.gif",value:"[饥饿]"},{icon:"/source/js/wangEditor_v2/emotion/images/25.gif",value:"[困]"},{icon:"/source/js/wangEditor_v2/emotion/images/26.gif",value:"[惊恐]"},{icon:"/source/js/wangEditor_v2/emotion/images/27.gif",value:"[流汗]"},{icon:"/source/js/wangEditor_v2/emotion/images/28.gif",value:"[憨笑]"},{icon:"/source/js/wangEditor_v2/emotion/images/29.gif",value:"[大兵]"},{icon:"/source/js/wangEditor_v2/emotion/images/30.gif",value:"[奋斗]"},{icon:"/source/js/wangEditor_v2/emotion/images/31.gif",value:"[咒骂]"},{icon:"/source/js/wangEditor_v2/emotion/images/32.gif",value:"[疑问]"},{icon:"/source/js/wangEditor_v2/emotion/images/33.gif",value:"[嘘]"},{icon:"/source/js/wangEditor_v2/emotion/images/34.gif",value:"[晕]"},{icon:"/source/js/wangEditor_v2/emotion/images/35.gif",value:"[折磨]"},{icon:"/source/js/wangEditor_v2/emotion/images/36.gif",value:"[衰]"},{icon:"/source/js/wangEditor_v2/emotion/images/37.gif",value:"[骷髅]"},{icon:"/source/js/wangEditor_v2/emotion/images/38.gif",value:"[敲打]"},{icon:"/source/js/wangEditor_v2/emotion/images/39.gif",value:"[再见]"},{icon:"/source/js/wangEditor_v2/emotion/images/40.gif",value:"[擦汗]"},{icon:"/source/js/wangEditor_v2/emotion/images/41.gif",value:"[抠鼻]"},{icon:"/source/js/wangEditor_v2/emotion/images/42.gif",value:"[鼓掌]"},{icon:"/source/js/wangEditor_v2/emotion/images/43.gif",value:"[臭大了]"},{icon:"/source/js/wangEditor_v2/emotion/images/44.gif",value:"[坏笑]"},{icon:"/source/js/wangEditor_v2/emotion/images/45.gif",value:"[左哼哼]"},{icon:"/source/js/wangEditor_v2/emotion/images/46.gif",value:"[右哼哼]"},{icon:"/source/js/wangEditor_v2/emotion/images/47.gif",value:"[哈欠]"},{icon:"/source/js/wangEditor_v2/emotion/images/48.gif",value:"[鄙视]"},{icon:"/source/js/wangEditor_v2/emotion/images/49.gif",value:"[委屈]"},{icon:"/source/js/wangEditor_v2/emotion/images/50.gif",value:"[快哭了]"},{icon:"/source/js/wangEditor_v2/emotion/images/51.gif",value:"[阴险]"},{icon:"/source/js/wangEditor_v2/emotion/images/52.gif",value:"[亲亲]"},{icon:"/source/js/wangEditor_v2/emotion/images/53.gif",value:"[吓]"},{icon:"/source/js/wangEditor_v2/emotion/images/54.gif",value:"[可怜]"},{icon:"/source/js/wangEditor_v2/emotion/images/60.gif",value:"[咖啡]"},{icon:"/source/js/wangEditor_v2/emotion/images/78.gif",value:"[拥抱]"},{icon:"/source/js/wangEditor_v2/emotion/images/79.gif",value:"[握手]"},{icon:"/source/js/wangEditor_v2/emotion/images/80.gif",value:"[强]"},{icon:"/source/js/wangEditor_v2/emotion/images/81.gif",value:"[弱]"},{icon:"/source/js/wangEditor_v2/emotion/images/82.gif",value:"[胜利]"},{icon:"/source/js/wangEditor_v2/emotion/images/83.gif",value:"[抱拳]"},{icon:"/source/js/wangEditor_v2/emotion/images/84.gif",value:"[勾引]"},{icon:"/source/js/wangEditor_v2/emotion/images/85.gif",value:"[拳头]"},{icon:"/source/js/wangEditor_v2/emotion/images/86.gif",value:"[差劲]"},{icon:"/source/js/wangEditor_v2/emotion/images/87.gif",value:"[爱你]"},{icon:"/source/js/wangEditor_v2/emotion/images/88.gif",value:"[NO]"},{icon:"/source/js/wangEditor_v2/emotion/images/89.gif",value:"[OK]"}];f.config.emotions={default:{title:"默认",data:d.$parent.emotion_data}};f.config.uploadImgUrl="/ueditor_controller?action=uploadimage";f.config.uploadImgFns.onload=function(e,t){if(t.readyState===4&&t.status==200){var i=JSON.parse(t.responseText);var r={contentType:"image/png",contentUrl:i.contentUrl,createdAt:(new Date).format("yyyy-MM-dd hh:mm:ss"),fileName:i.original,id:i.attachmentId,provider:{id:a.provider.id},size:i.size};d.sendMessage("file","",r)}else{n.add("图片上传失败，请重新上传！","warning")}};f.config.uploadImgFns.ontimeout=function(e){n.add("上传超时","warning")};f.config.uploadImgFns.onerror=function(e){n.add("上传失败","warning")};f.onchange=function(){i.$setViewValue(this.$txt.html());d.$parent.contentTxt=this.$txt.text()};i.$render=function(){var e=i.$isEmpty(i.$viewValue)?"":i.$viewValue;f.$txt.html(e)};f.create()}}}v.$inject=["$http","$modal_","$location"];function v(f,p,n){return{restrict:"EA",link:function(s,e,t){var i=e[0];var l="";var c="";var u=null;i.addEventListener("paste",function(e){var t=e.clipboardData||e.originalEvent.clipboardData;var i;if(t==null){i=window.clipboardData&&window.clipboardData.getData("text")}else{i=t.getData("text/plain")||t.getData("text/html")}if(i){return false}if(t.items){for(var r=0;r<t.items.length;r++){if(t.items[r].kind=="file"&&/image\//.test(t.items[r].type)){var n=e.clipboardData.items[r].getAsFile();c=n.size;var a=new FileReader;a.onloadend=function(e){o(e.target.result)};a.readAsDataURL(n);e.preventDefault();break}}}else{setTimeout(function(){var e=document.querySelectorAll("#webchatTextMessage img");var t="";for(var i=0;i<e.length;i++){if(e[i].className.indexOf("emoji")===-1){e[i].style.display="none";if(e[i].className.indexOf("my_img")===-1){t=e[i].src;e[i].className+=" my_img"}}}if(t.indexOf("data:image/png;base64")!=-1){o(t)}},1)}var o=function(t){u=p({scope:s,contentTemplate:"copy_img_sure.html",title:"确定要发送该图片吗？",html:true,show:true,placement:"center",backdrop:"static"});s.uploadImgUrl=t;f.get("/qiniu_token.json").success(function(e){l=e;s.sendImgUrlByBase64=function(e){s.isImgUrlBase64Upload=true;d(t.replace("data:image/png;base64,",""),l);e.preventDefault();e.stopPropagation()}})}});function d(e,t){var i=n.protocol()==="https"?"https://up.qbox.me/putb64/-1/":"http://up.qiniu.com/putb64/-1/";var r=new XMLHttpRequest;r.onreadystatechange=function(){if(r.readyState==4){var e=JSON.parse(r.responseText);f({url:"save_attachment.json",method:"POST",params:{fileName:e.key,contentType:"image/png",contentUrl:e.key,size:c}}).success(function(e){if(e.json){s.isImgUrlBase64Upload=false;u.$promise.then(u.hide);s.sendMessage("file","",e.json)}})}};r.open("POST",i,true);r.setRequestHeader("Content-Type","application/octet-stream");r.setRequestHeader("Authorization","UpToken "+t);r.send(e)}}}}k.$inject=["$rootScope","$timeout","$window"];function k(u,d,e){return{link:{post:function(e,t,i){var r,n,a,o,s,l,c;a=0;if(i.scrollLoadDistance!=null){e.$watch(i.scrollLoadDistance,function(e){return a=parseInt(e,10)})}o=true;r=false;if(i.scrollLoadDisabled!=null){e.$watch(i.scrollLoadDisabled,function(e){o=!e;if(o&&r){r=false;return n()}})}l=_.debounce(function(){if(u.$$phase){return e.$eval(i.typeaheadScrollLoad)}else{return e.$apply(i.typeaheadScrollLoad)}},500,true);n=function(){var e=s.prop("scrollHeight")-s.scrollTop()-s.height();var t=e<=a;if(t&&o&&e<c){c=e;return l()}else if(t){c=e;return r=true}};e.$on("$destroy",function(){if(s&&s.off){s.off("scroll",n)}});return d(function(){s=t.next("*[uib-typeahead-popup]");s.on("scroll",n);if(i.scrollLoadImmediateCheck){if(e.$eval(i.scrollLoadImmediateCheck)){return n()}}else{return n()}},1e3)}}}}y.$inject=["$compile"];function y(e){return{restrict:"EA",template:'<i class="iconfont" style="color: {{icontObj.color}};" ng-bind-html="icontObj.value | trusted"></i>',replace:true,transclude:true,link:function(e,t,i,r){var n="";e.icontObj={};n=e.file.type||e.file.contentType;var a=e.file.name||e.file.fileName;if(n&&(n.indexOf("image")!==-1||n.indexOf("video")!==-1||n.indexOf("audio")!==-1)){if(n.indexOf("image")!==-1){e.icontObj.color="#00D1A4";e.icontObj.value="&#xe729;"}else if(n.indexOf("video")!==-1||n.indexOf("audio")!==-1){e.icontObj.color="#0DBAF7";e.icontObj.value="&#xe72d;"}}else if(a){a=a.slice(-4);if(a.indexOf("pdf")>-1){e.icontObj.color="#F36666";e.icontObj.value="&#xe736;"}else if(a.indexOf("ai")>-1||a.indexOf("psd")>-1||a.indexOf("jpg")>-1){e.icontObj.color="#00D1A4";e.icontObj.value="&#xe729;"}else if(a.indexOf("rm")>-1||a.indexOf("rmvb")>-1||a.indexOf("swf")>-1||a.indexOf("flv")>-1||a.indexOf("mp4")>-1){e.icontObj.color="#0DBAF7";e.icontObj.value="&#xe72d;"}else if(a.indexOf("ppt")>-1||a.indexOf("pptx")>-1){e.icontObj.color="#F36666";e.icontObj.value="&#xe737;"}else if(a.indexOf("zip")>-1||a.indexOf("rar")>-1||a.indexOf("jar")>-1||a.indexOf("7z")>-1){e.icontObj.color="#F9B566";e.icontObj.value="&#xe72e;"}else if(a.indexOf("txt")>-1){e.icontObj.color="#7889AD";e.icontObj.value="&#xe726;"}else if(a.indexOf("et")>-1||a.indexOf("xls")>-1||a.indexOf("xlsx")>-1){e.icontObj.color="#01D1A5";e.icontObj.value="&#xe72c;"}else if(a.indexOf("vsd")>-1||a.indexOf("docx")>-1||a.indexOf("wps")>-1||a.indexOf("doc")>-1){e.icontObj.color="#F36666";e.icontObj.value="&#xe751;"}else if(a.indexOf("rp")>-1){e.icontObj.color="#C20CED";e.icontObj.value="&#xe72b;"}else{e.icontObj.color="#D2D4DE";e.icontObj.value="&#xe6c4;"}}else{e.icontObj.color="#D2D4DE";e.icontObj.value="&#xe6c4;"}}}}w.$inject=["$parse"];function w(e){return{restrict:"EA",template:'<img style="width:50px;height:50px;" ng-src="/source/images/{{icontObj.value}}.png"/>',replace:true,transclude:true,link:function(e,t,i,r){e.icontObj={};var n=angular.fromJson(i.file);var a=null,o=null;if(n){a=n.type||n.contentType;o=n.name||n.fileName}else if(e.file){a=e.file.type||e.file.contentType;o=e.file.name||e.file.fileName}if(a&&(a.indexOf("image")!==-1||a.indexOf("video")!==-1||a.indexOf("audio")!==-1)){if(a.indexOf("image/vnd.rn-realpix")!==-1){e.icontObj.value="file-rp"}else if(a.indexOf("image")!==-1){e.icontObj.value="file-img"}else if(a.indexOf("video")!==-1||a.indexOf("audio")!==-1){e.icontObj.value="file-mv"}}else if(o){o=o.slice(-4);if(o.indexOf("pdf")>-1){e.icontObj.value="file-pdf"}else if(o.indexOf("ai")>-1||o.indexOf("psd")>-1){e.icontObj.value="file-img"}else if(o.indexOf("rm")>-1||o.indexOf("rmvb")>-1||o.indexOf("swf")>-1||o.indexOf("flv")>-1){e.icontObj.value="file-mv"}else if(o.indexOf("ppt")>-1||o.indexOf("pptx")>-1){e.icontObj.value="file-ppt"}else if(o.indexOf("zip")>-1||o.indexOf("rar")>-1||o.indexOf("jar")>-1||o.indexOf("7z")>-1){e.icontObj.value="file-zip"}else if(o.indexOf("txt")>-1){e.icontObj.value="file-txt"}else if(o.indexOf("et")>-1||o.indexOf("xls")>-1||o.indexOf("xlsx")>-1){e.icontObj.value="file-excel"}else if(o.indexOf("vsd")>-1||o.indexOf("docx")>-1||o.indexOf("wps")>-1||o.indexOf("doc")>-1){e.icontObj.value="file-word"}else if(o.indexOf("rp")>-1){e.icontObj.value="file-rp"}else{e.icontObj.value="attachment-file"}}else{e.icontObj.value="attachment-file"}}}}})();(function(){angular.module("eweiApp.ticket").directive("quickKnowledgeTip",e).controller("quickKnowledgeTipCtrl",i);e.$inject=[];function e(){var e={restrict:"AE",link:t,controller:i,controllerAs:"vm",scope:{textMessage:"=",textQuestionId:"=?",focusAreaId:"@",reply:"&?",hideSendKnowledge:"@?",onlyQuickReplys:"="},bindToController:true,templateUrl:"source/scripts/directives/quick_knowledge_tip/quick_knowledge_tip.html"};return e;function t(e,t,i,r){t.bind("blur",function(){r.clearMatchItems()})}}i.$inject=["$scope","$http","$rootScope","$location","ConsoleConfig","$document","quickreplyService","utils"];function i(o,i,e,t,r,n,a,s){var l=this;var c=0;l.matchQuickReplys=d;l.selectmatchQuickReplys=f;l.clearMatchItems=p;l.editKnowledge=h;l.sendKnowledge=g;l.quickReplys=[];l.matchItems=[];l.questions=[];l.questionKnowledgeType={announcement:"公告",questions:"论坛",articles:"知识库",weixin_joke:"微信笑话",manage:"管理"};var u=function(){a.run("",{_do_count:false,_count:1e4},false,function(e){l.quickReplys=e.quickReplys})};u();var d=_.debounce(function(e){var t="";p();if(!l.onlyQuickReplys&&e.indexOf("//")>=0){l.quickmatchItems="knowledge";t=e.substr(e.lastIndexOf("/")+1);v(t);return}if(!(angular.isArray(l.quickReplys)&&l.quickReplys.length>0)){return}if(e.indexOf("/")>=0){if(e.lastIndexOf("/")===e.length-1){t=""}else{t=e.substr(e.lastIndexOf("/")+1)}}else{t=e}for(var i=0,r=l.quickReplys.length;i<r;i++){if(l.matchItems.length>4){l.itemMouseenter(l.matchItems[0]);return}if(t==""){var n={id:l.quickReplys[i].id,content:l.quickReplys[i].content,selected:false};var a=l.quickReplys[i].title;n.html=a;l.matchItems.push(n)}else{if(l.quickReplys[i].title.toUpperCase().indexOf(t.toUpperCase())>=0){var n={id:l.quickReplys[i].id,content:l.quickReplys[i].content,selected:false};var a=l.quickReplys[i].title.replaceAll(t,"<label class='highlightedText'>"+t+"</label>");n.html=a;l.matchItems.push(n)}}}l.itemMouseenter(l.matchItems[0]);o.$applyAsync()},50);function f(e){if(l.textMessage&&l.textMessage.indexOf("/")>=0){var t=l.textMessage.length;var i;for(var r=t-1;r>=0;r--){if(l.textMessage[r]==="/"&&l.textMessage[r-1]!=="<"&&l.textMessage[r+1]!==">"){i=r;break}}l.textMessage=l.textMessage.substring(0,i)+e}else{l.textMessage=e}p();m()}function p(){l.matchItems=[];l.quickmatchItems="";o.$applyAsync()}function m(){var e=document.getElementById(l.focusAreaId);if(e){e.focus()}}l.itemMouseenter=_.debounce(function(e){var t=0;for(var i=0,r=l.matchItems.length;i<r;i++){if((l.matchItems[i]===e||l.matchItems[i].id===e.id)&&t===0){l.matchItems[i].selected=true;t+=1;c=i}else{l.matchItems[i].selected=false}}o.$applyAsync()},50);function h(r){if(r.topic&&r.topic.type=="articles"||!r.remark){i({url:"question_body_"+r.id+".json",method:"GET"}).success(function(e){var t=l.textMessage.split("//");var i=s.htmlToPlainText(e.json.articleBody);l.textMessage=t[0]+i;l.textQuestionId=r.id})}else{var e=l.textMessage.split("//");var t=s.htmlToPlainText(r.remark);l.textMessage=e[0]+t;l.textQuestionId=r.id}l.questions=[];m()}function g(e){l.reply({_status:null,text:l.textMessage,questionId:e.id});m()}o.$on("sendKnowledgeStatus",function(e,t){if(t){angular.forEach(l.questions,function(e){if(e.id==t.questionId){e.sendKnowledgeStatus=t.sendKnowledgeStatus;if(t.sendKnowledgeStatus=="success"){l.textMessage="";l.questions=[]}return}})}else{l.textMessage="";l.questions=[]}});function v(e){i({url:"searchQuestionByKey.json",method:"GET",params:{key:e,paseSize:20,pageNo:1,providerId:r.provider.id,topicType:"questionAndArticle"}}).success(function(e,t,i,r){if(e.success){l.questions=e.json}else{l.questions=[]}})}o.$watch("vm.textMessage",function(e,t){if(e!==t&&angular.isString(e)&&e.length>0){var i=e.replace(/<br>$/gi,"");if(i.length>0){d(i)}else{p()}}else{if(!e){p()}}},false);function k(e){if(l.matchItems.length){if(e.keyCode===38){e.preventDefault();c=c===0?l.matchItems.length-1:c-1}else if(e.keyCode===40){e.preventDefault();c=c===l.matchItems.length-1?0:c+1}l.itemMouseenter(l.matchItems[c])}if(l.matchItems.length&&e.keyCode===13){e.preventDefault();f(l.matchItems[c].content)}}n.on("keydown",k);o.$on("$destroy",function(){n.off("keydown",k)})}})();(function(){angular.module("eweiApp.help_center").directive("uiSettingHtml",e).directive("updateAceContent",i);function e(){return{restrict:"A",templateUrl:"/source/views/help_center/ui_setting_html/ui_setting_html.html",scope:{aceFooterHtmlModel:"=",aceHeaderHtmlModel:"=",aceCssModel:"=",attachments:"=",aceIsUsingCustomizeHeader:"="},controller:t}}t.$inject=["$scope","$modal_","$upload","$rootScope","EweiConfig"];function t(t,e,i,r,n){t.qiniu=n.bucket_domain;t.aceFooterHtmlConfig={useWrapMode:true,showGutter:false,theme:"monokai",mode:"html",showPrintMargin:false,firstLineNumber:5};t.aceHeaderHtmlConfig={useWrapMode:true,showGutter:false,theme:"monokai",mode:"html",showPrintMargin:false,firstLineNumber:5};t.aceCssConfig={useWrapMode:true,showGutter:false,theme:"monokai",mode:"css",showPrintMargin:false,firstLineNumber:5};t.currentEditItem="headerHtml";t.currentItem="headerHtml";t.usingCustomizeHeader=function(){};t.changeEditItem=function(e){t.currentEditItem=e};t.preview=function(){t.previewContent="";if(t.aceCssModel){t.previewContent="";if(t.aceCssModel.indexOf("<style>")==-1){t.previewContent+="<style>"}t.previewContent+=t.aceCssModel;if(t.aceCssModel.indexOf("<style>")==-1){t.previewContent+="</style>"}}if(t.currentItem=="headerHtml"){if(t.aceHeaderHtmlModel){t.previewContent+=t.aceHeaderHtmlModel.replace(/<script/g,"&lt;script").replace(/<\/script/g," &lt;/script").replace(/<iframe/g,"&lt;iframe").replace(/<\/iframe/g," &lt;/iframe")}}else{if(t.aceFooterHtmlModel){t.previewContent+=t.aceFooterHtmlModel.replace(/<script/g,"&lt;script").replace(/<\/script/g," &lt;/script").replace(/<iframe/g,"&lt;iframe").replace(/<\/iframe/g," &lt;/iframe")}}t.previewModal=e({scope:t,prefixEvent:"confirm_moda",template:"modal/modal.tpl.w900.html",contentTemplate:"ace-preview-modal.html",html:true,show:true,title:"预览",placement:"center"})};t.removeAttachment=function(e){t.attachments.splice(e,1)};t.fileSelectDisabled=false;t.fileUploading=false;t.uploadImage=function(e){if(e==null||e==undefined||e.length<=0){return}if(e[0].size>52428800){alertService.add("上传单个附件大小不能超过50M","danger")}else{t.fileSelectDisabled=true;t.fileUploading=true;e.upload=i.upload({url:"upload",method:"POST",file:e});e.upload.then(function(e){if(e.status==200){if(e.data.fileSize>52428800){alertService.add("上传单个附件大小不能超过50M","danger")}else{if(t.attachments==undefined||t.attachments==null){t.attachments=[]}t.fileSelectDisabled=false;t.fileUploading=false;t.attachments.push(e.data)}}else{alertService.add("请检查文件类型，格式！","danger")}},function(e){t.errorMsg=e.status+": "+e.data});e.upload.progress(function(e){void 0});e.upload.xhr(function(e){e.upload.addEventListener("abort",function(){void 0},false)})}}}function i(){return{restrict:"A",link:function(e,t,i){$(t).load(function(){$body=$(t).contents().find("body");$body.html(i.updateAceContent)})}}}})();angular.module("com.ewei.angular.ui").controller("slaBarController",["$http","$scope","$timeout",function(e,t,n){var a=this;a.slaData={};a.showSla=false;var o=function(e){var t=e%60;var i=Math.floor(e/1440);var r=Math.floor(e%1440/60);var n="";t=t>0?t:0;r=r>0?r:0;i=i>0?i:0;return i+"D&nbsp;"+r+"H&nbsp;"+t+"M&nbsp;"};var s=0;function l(e){var t=new Date(e.hasOwnProperty("beginTime")?e.beginTime.replace(/\-/g,"/"):"");var i=new Date(e.hasOwnProperty("endTime")?e.endTime.replace(/\-/g,"/"):"");var r=new Date;if(e.processingTimeChange){e.actualProcessingTime+=1;a.slaData.actualProcessingTime=o(e.actualProcessingTime)}if(e.responseTimeChange){e.actualResponseTime+=1;a.slaData.actualResponseTime=o(e.actualResponseTime)}s=n(function(){l(e)},6e4);if(!e.processingTimeChange&&!e.responseTimeChange){n.cancel(s)}if(t>r||r>i){n.cancel(s)}}e.get("find_ticket_sla_state.json?ticketId="+t.ticketId).success(function(e){if(e.success){a.showSla=true;l(angular.copy(e.json));a.slaData.actualProcessingTime=o(e.json.actualProcessingTime);a.slaData.actualResponseTime=o(e.json.actualResponseTime);a.slaData.planProcessingTime=o(e.json.planProcessingTime);a.slaData.planResponseTime=o(e.json.planResponseTime)}});t.$on("$destroy",function(){n.cancel(s)})}]).directive("slaBar",function(){return{restrict:"EA",scope:{ticketId:"@"},templateUrl:"/source/scripts/directives/sla-bar/sla-bar.html",controller:"slaBarController",controllerAs:"vm"}});angular.module("com.ewei.angular.ui").controller("noticeUserSelectController",["$scope","$filter","$http",function(n,e,t){n.userItems=[{id:-2,name:e("translate")("TYPE_TICKET_UPDATE_REQUESTER_MARK")},{id:0,name:e("translate")("TYPE_TICKET_UPDATE_HANDLER_MARK")}];t({url:"engineer.json",method:"GET",params:{_count:999,_do_count:false,_fields:"id,user.id,user.name",_asc:"user.name",_filter:"{'$and':[{'$eq':{'user.deleted':false}},{'$eq':{'user.valid':true}}]}"}}).success(function(e,t,i,r){if(e.engineers){angular.forEach(e.engineers,function(e){n.userItems.push({id:e.user.id,name:e.user.name,engineerId:e.id})})}angular.forEach(n.userItems,function(e){if(n.selectedItem!=null&&typeof n.selectedItem=="object"&&e.id===n.selectedItem.id){n.selectedItem=e}else if(n.selectedItem!=null&&typeof n.selectedItem=="string"){if(n.selectedItem.indexOf("_")>=0){var t=n.selectedItem.split("_");if(t[1]==e.engineerId){n.selectedItem=e}}else{if(e.id==Number(n.selectedItem)){n.selectedItem=e}}}else if(n.selectedItem!=null&&typeof n.selectedItem=="number"&&e.id==n.selectedItem){n.selectedItem=e}})})}]).directive("noticeUserSelect",[function(){return{restrict:"EA",replace:true,templateUrl:"/source/scripts/directives/notice-user-select/notice-user-select.html",controller:"noticeUserSelectController",scope:{selectedItem:"="}}}]);angular.module("com.ewei.angular.ui").service("ipService",["cacheService",function(a){this.run=function(e,t,i,r){var n={url:"ip_to_address.json?ip=:ip",urlParam:{ip:e},dataParam:t};if(undefined===i||true==i){a.run(n,function(e){if(typeof r==="function"){r(e)}})}else{a.get(n,function(e){if(typeof r==="function"){r(e)}})}}}]).controller("ipToAddressController",["$http","$scope","ipService",function(e,i,r){i.$on("ipIsChange",function(e,t){i.address="-";r.run(t.ip,{},false,function(e){if(e.success&&e.json&&e.json.address){i.address=e.json.address}else{i.address="-"}})})}]).directive("ipToAddress",function(){return{restrict:"EA",replace:true,scope:{ip:"="},templateUrl:"/source/scripts/directives/ip-to-address/ip-to-address.html",controller:"ipToAddressController"}});angular.module("com.ewei.angular.ui").controller("servicedeskViaShowController",["$http","$scope",function(e,n){void 0;n.viaList=[];n.$watch("servicedeskId",function(){if(n.servicedeskId&&n.servicedeskId!=""){e({url:"service_desk/"+n.servicedeskId+"/vias.json",method:"GET"}).success(function(e,t,i,r){if(e.success&&e.json){n.viaList=e.json}})}})}]).directive("servicedeskViaShow",function(){return{restrict:"EA",replace:true,scope:{servicedeskId:"="},templateUrl:"/source/scripts/directives/servicedesk-via-show/servicedesk-via-show.html",controller:"servicedeskViaShowController"}});angular.module("com.ewei.angular.ui").controller("userMergeCustomFieldController",["$scope","$http","alertService","$filter","commonTools",function(u,e,a,o,d){u.edit=true;var i=function(e){var t=e;var i=[];for(var r=0;r<t.length;r++){var n=t[r];if(n.active!=true||n.systemFieldKey!=null&&n.systemFieldKey!=""){continue}var a={id:null,value:n.value,customField:null};try{if(n.type=="options"&&n.customFieldOptions){var o=angular.fromJson(n.customFieldOptions);if(typeof n.systemFieldKey=="undefined"&&o[0].name!="-"){o.unshift({name:"-",value:""})}n.customFieldOptions=o;if(n.value==undefined||n.value==""){a.value=""}else if((n.value==undefined||n.value=="")&&n.defaultValue){for(var s=0;s<o.length;s++){if(o[s].value==n.defaultValue){a.value=n.defaultValue}}}}}catch(e){void 0}if(n.type=="checkbox"){if(n.value=="true"){a.value=true}else{a.value=false}}if(n.type=="mobile_phone"||n.type=="currency"){n.type="text"}if(n.notes!=undefined&&n.notes.length>40){n.notes=n.notes.substring(0,12)+". . . "}if(n.url){if(n.url.toLowerCase().indexOf("http://")!=0){n.url="http://"+n.url}if(n.url.indexOf("?")<0){a.fromParams="?"}else{a.fromParams="&"}var l=new String(n.url);if(l.indexOf("{value}")>0){l=l.replaceAll("{value}",a.value)}else{l=l+a.value}a.valueUrl=l}if(n.type=="date"){n.startForm=false;n.value=d.parseDate(a.value,"yyyy/MM/dd");a.value=n.value}else if(n.type=="date_time"){n.startForm=false;n.value=d.parseDateTime(a.value,"yyyy/MM/dd HH:mm:ss");a.value=n.value}else if(n.type=="date_to_date"){n.startTimeForm=false;n.endTimeForm=false;if(n.value){var c=n.value.split("-");n.startTime=d.parseDate(c[0],"yyyy/MM/dd");n.endTime=d.parseDate(c[1],"yyyy/MM/dd")}}a.customField=n;a.id=n.id;i.push(a)}u.ticket.ticketCustomFields=i;u.userCustomFields=i;u.userCustomFieldsCopy=angular.copy(u.userCustomFields)};u.$watch("ticket",function(e,t){if(u.ticket){i(u.ticket)}});u.filedValueChange=function(e,t,i){if(t&&t!=""){var r=new String(t);if(r.indexOf("{value}")>0){r=r.replaceAll("{value}",i)}else{r=r+i}u.userCustomFields[e].valueUrl=r}};u.change=function(e){var t=u.userCustomFields[e];var i=u.userCustomFieldsCopy[e];if(t.customField.type=="date_to_date"){if(t.customField.startTime!=undefined){var r=o("date")(t.customField.startTime,"yyyy/MM/dd").toString()}else{a.add("请选取开始时间","danger","left");t.value="";return}if(t.customField.endTime!=undefined){var n=o("date")(t.customField.endTime,"yyyy/MM/dd").toString()}else{a.add("请选取结束时间","danger","left");t.value="";return}t.value=r+"-"+n}if(t.value==i.value){return}};u.datepickers={startTo:false,updateFrom:false,updateTo:false};u.open=function(e,t){e.preventDefault();e.stopPropagation();if(t.startForm){t.startForm=false}else{t.startForm=true}};u.timeFrameOpen=function(e,t,i){e.preventDefault();e.stopPropagation();if(i=="startTimeForm"){t.startTimeForm=!t.startTimeForm}else{t.endTimeForm=!t.endTimeForm}}}]).directive("userMergeCustomField",[function(){return{restrict:"AE",templateUrl:"/source/scripts/directives/user-custom-field/user-custom-field.html",controller:"userMergeCustomFieldController",scope:{ticket:"="}}}]);(function(){"use strict";angular.module("eweiApp.ticket").controller("ticketTimeLineCtrl",e).directive("ticketTimeLine",t);e.$inject=["$http","$scope","apiTicketTimeAxisService","coreNotifyService","coreModelService"];function e(e,t,i,r,n){var a=this;var o=vm.__proto__.constructor.name+"_"+(new Date).valueOf();a.lineDatas={};var s=function(e){e=e.replace("-","/");e=new Date(e);var t=new Date;var i=Math.floor((t-e)/1e3);var r=Math.floor(i/60);var n=Math.floor(r/60);var a=Math.floor(n/24);n=n-a*24;r=r-a*24*60-n*60;i=i-a*24*60*60-n*60*60-r*60;var o="";if(a>0){o+=a+"天"}if(n>0){o+=n+"小时"}if(r>0){o+=r+"分钟"}o+=i+"秒";return o};var l=function(e){if(e===undefined){return""}var t=Math.floor(e/60);var i=Math.floor(t/24);t=t-i*24;e=e-i*24*60-t*60;var r="";if(i>0){r+=i+"天"}if(t>0){r+=t+"小时"}r+=e+"分钟";return r};var c=function(e){if(e<=60){return e}else{return Math.floor(e/60)+"小时"+e%60}};var u=function(e){var r={};var n;a.lineDatas={};e.forEach(function(e){var t={};var i=true;n=e.createdAt+e.operateType;if(!r[n]){r[n]=e}else{e=r[n]}t.letter=e.ticketStatus[0];t.fromNow=l(e.expendMinutes)||e.createdAt;t.workMinutes=l(e.workMinutes);if(e.operator){t.operator=e.operator}else{t.operator={name:"系统"}}t.handerClass="";if(e.targetUser&&e.targetUser.id===e.changeHandlerId){t.targetClass="hander"}if(e.operator&&e.operator.id===e.changeHandlerId){t.handerClass="hander"}if(e.performanceUser){t.performanceUser=e.performanceUser}if(e.performanceUser&&e.responseDuration){t.responseDuration=c(e.responseDuration)}if(e.performanceUser&&e.processDuration){t.processDuration=c(e.processDuration)}if(angular.isNumber(e.slaResponseDuration)){if(e.slaResponseDuration===0){t.slaResponseDuration=c(1)}else{t.slaResponseDuration=c(e.slaResponseDuration)}}if(angular.isNumber(e.slaProcessDuration)){if(e.slaProcessDuration===0){t.slaProcessDuration=c(1)}else{t.slaProcessDuration=c(e.slaProcessDuration)}}switch(e.ticketStatus){case"new":t.slaColor="ticket-statu-new";break;case"assigned":t.slaColor="ticket-statu-assigned";break;case"open":t.slaColor="ticket-statu-open";break;case"pending":t.slaColor="ticket-statu-pending";break;case"solved":t.slaColor="ticket-statu-solved";break;case"closed":t.slaColor="ticket-statu-closed";break;case"suspended":t.slaColor="ticket-statu-suspended";break;case"deleted":t.slaColor="ticket-statu-deleted";break}t.type==e.type;t.operateType=e.operateType;switch(e.operateType){case"create":t.ection="创建工单";break;case"create_assign":t.ection="创建工单并分派给";break;case"request":t.ection="请求服务";break;case"assign":t.ection="分派工单给";break;case"response_ticket":t.ection="响应工单";break;case"receive":t.ection="接单";i=false;t.targetUser=null;t.targetSericeDesk=null;break;case"solved":t.ection="处理完毕工单";break;case"solved_assign":t.ection="处理完毕工单,并分派给";break;case"reset":t.ection="重置工单";break;case"reply_to_reset":t.ection="重置工单";break;case"reset_assign":t.ection="重置任务并分派给";break;case"pending":t.ection="等待客户响应";break;case"reply":t.ection="回复工单";break;case"delete":t.ection="删除工单";break;case"recovery":t.ection="恢复工单";break;case"close":t.ection="关闭工单";break;case"change_status":t.ection="状态变更";break;case"grab":t.ection="抢单";i=false;break;case"grab_to_pending":t.ection="抢单并暂停工单";i=false;break;case"grab_to_solved":t.ection="抢单并处理完毕工单";i=false;break;case"receive_to_pending":t.ection="接单并暂停工单";i=false;break;case"receive_to_solved":t.ection="接单并处理完毕工单";i=false;break;case"review":t.ection="审核工单";break;case"reply_to_solved":t.ection="处理完毕工单";break;case"reply_cancel_pending":t.ection="取消暂停工单";i=false;break;case"reply_to_pending":t.ection="暂停工单";break;case"assign_to_work_flow":t.ection="分派工单给";break;case"assign_to_service_desk":t.ection="分派工单给";break;case"assign_to_engineer":t.ection="分派工单给";break;case"review_to_pass":t.ection="关闭工单";break;case"review_to_no_pass":t.ection="重置工单";break;case"remove_suspended":t.ection="移除隔离区";break;case"response_assign":t.ection="响应任务";break;case"solved_assign":t.ection="处理完毕,并分派给";break}if(e.operateType.indexOf("solved")>-1){t.hasSolved=true}if(i){t.targetUser=e.targetUser;t.targetSericeDesk=e.targetSericeDesk}if(e.remark){t.ection+=" ("+e.remark+")"}a.lineDatas[n]=t})};function d(){var e=n.detail.ticketTimeLine.get(a.ticketid)||[];if(e&&e.length>0){u(e)}}function f(){i.run(r.constant.EVENT_DETAIL_TICKET_TIMELINE,1,{id:a.ticketid},{},function(e){})}function p(){r.register(o,r.constant.EVENT_DETAIL_TICKET_TIMELINE,function(e){d()})}function m(){r.unRegister(o)}function h(){p();d();f()}h();t.$on("$destroy",function(){m()});t.$on("ticket_log",function(e,t){f()})}function t(){var e={restrict:"E",controller:"ticketTimeLineCtrl",scope:{ticketid:"@"},controllerAs:"timeline",bindToController:true,templateUrl:"/source/scripts/directives/ticket-time-line/ticket-time-line.html",link:function(e,t,i){}};return e}})();(function(){"use strict";angular.module("eweiApp.ticket").controller("ticketAttachmentsCtrl",e).directive("ticketAttachments",t).directive("ticketAttachmentsImage",i);e.$inject=["apiTicketAttachmentsService","$scope","coreModelService","coreNotifyService","$http","$modal_","alertService"];function e(e,r,t,i,n,a,o){var s=i.constant.EVENT_DETAIL_TICKET_ATTACHMENTS;var l=this.__proto__.constructor.name+"_"+(new Date).valueOf();var c=this;var u=function(){i.register(l,s,function(e){f()})};var d=function(){f();p()};var f=function(){var e=t.detail.ticketAttachments.gets(t.list.ticketAttachments.gets(1))||[];c.slideImages=[];angular.forEach(e,function(e,t){e.url="/ewei_attachment?contentUrl="+e.contentUrl+"&fileName="+encodeURIComponent(e.fileName);var i=e.contentType,r=i.split("/")[1];if(i.indexOf("image")!==-1&&e.fileName.indexOf("."+r)===-1){if(r==="jpeg"){if(e.fileName.indexOf(".jpg")===-1){e.url+=".jpg"}}else if(r==="x-icon"){if(e.fileName.indexOf(".ico")===-1){e.url+=".ico"}}else if(r==="photoshop"){if(e.fileName.indexOf(".psd")===-1){e.url+=".psd"}}else{e.url+="."+r}}if(i=="image/jpeg"||i=="image/gif"||i=="image/png"){c.slideImages.push({id:e.id,src:e.url,contentUrl:e.contentUrl,fileName:e.fileName,type:e.contentType});e.isShowImg=true}});c.ticketAttachments=e;c.slideImagesCopy=angular.copy(c.slideImages)};var p=function(){e.getTicketAttachments(s,1,{ticketId:r.ticketid},"",function(e){})};var m=function(){u();d()};m();r.deleteAttachment=function(e,t){r._messages="删除该附件后，该附件在工单、会话、项目看板、社区文章中将不能查看，确定删除吗？";var i=a({scope:r,title:"删除附件",contentTemplate:"source/views/alter_common.html",html:true,show:true,placement:"center"});r.$ok=function(){r.isLoading=true;n({url:"/api/v1/ticket_comment/attachments.json",method:"delete",params:{contentUrl:t.contentUrl,attachmentId:t.id,ticketCommentId:t.ticketCommentId}}).success(function(e){void 0;if(e.status===0){r.isLoading=false;i.$promise.then(i.hide);m();o.add("删除成功","success")}})};e.stopPropagation()};var h=function(){i.unRegister(l)};r.$on("$destroy",function(){h()})}function t(){var e={restrict:"E",controller:"ticketAttachmentsCtrl",scope:{ticketid:"@"},controllerAs:"vm",templateUrl:"/source/scripts/directives/ticket-attachments/ticket-attachments.html",link:function(e,t,i){var r=angular.element(".download-frame",t);e.download=function(e,t){e.preventDefault();if(r&&r.length>0){r[0].src=t}}}};return e}i.$inject=["$modal_"];function i(l){return{restrict:"EA",link:function(s,e,t){e[0].onclick=function(e){var t=e.target;var i=$(t).attr("index"),r=0,n;if((t.tagName==="SPAN"||t.tagName==="IMG")&&$(t).hasClass("title-attachment")){var a=angular.copy(s.vm.slideImagesCopy);for(var o=0;o<a.length;o++){if(a[o].id===Number(i)){r=o;n=a[o];break}}if(n&&(n.type.indexOf("image")>-1||n.fileName.indexOf("ai")>-1||n.fileName.indexOf("psd")>-1)){s.vm.slideImages=a.splice(r).concat(a);s.vm.viewImagesModal=l({scope:s,template:"source/scripts/directives/ticket-image-view/view-image-template.html",contentTemplate:"source/scripts/directives/ticket-image-view/view-image.html",html:true,show:true,backdrop:"static",placement:"center"})}}}}}}})();angular.module("com.ewei.angular.ui").controller("ticketCommentSelectController",["$http","$scope",function(e,t){t.commentTypes=[{type:"text",option:"文本"}];t.openOptions=[{value:"true",option:"公开"},{value:"false",option:"私密"}];if(typeof t.ticketcomment=="string"){t.ticketcomment=JSON.parse(t.ticketcomment)}else if(typeof t.ticketcomment=="undefined"){t.ticketcomment={type:"text",value:"",open:"true"}}t.logs=function(e){}}]).directive("ticketCommentSelect",function(){return{restrict:"EA",scope:{ticketcomment:"="},templateUrl:"/source/scripts/directives/ticket-comment-select/ticket-comment-select.html",controller:"ticketCommentSelectController"}});(function(){"use strict";angular.module("eweiApp.common").directive("ticketReplyTemplate",e).controller("ticketReplyTemplateController",t);function e(){return{restrict:"EA",replace:false,scope:false,controller:t,templateUrl:"/source/scripts/directives/ticket-reply-template/ticket-reply-template.html"}}t.$inject=["$timeout","$scope","commonTools","$http","attachmentService","ConsoleConfig","$ocLazyLoad","alertService","$modal_","$rootScope","$state","$stateParams","utils"];function t(e,a,o,s,t,l,i,c,r,u,n,d,f){var p=a.$parent;var m=function(e){if(a.$parent.newComment.attachments==null){a.$parent.newComment.attachments=[]}var t=angular.fromJson(e);a.$parent.newComment.attachments.push({id:t.id,fileName:t.fileName,contentUrl:t.contentUrl,size:t.fileSize,contentType:t.contentType})};var h;a.requestScreenshot=function(){_hmt.push(["_trackEvent","工单工具","屏幕截图"]);var e={type:"ticket",id:a.ticket.id,status:a.ticket.status,open:a.open};a.$emit("requestScreenshot",e)};a.requestVideo=function(){_hmt.push(["_trackEvent","工单工具","屏幕录像"]);var e={type:"ticket",id:a.ticket.id,status:a.ticket.status,open:a.open};a.$emit("requestVideo",e)};u.$on("uploadedTicketAttachment",function(e,t){m(t.file);o.safeApply(a);a.cacheFiles.push({name:t.file.fileName,size:t.file.size,result:angular.toJson({id:t.file.id,fileName:t.file.fileName,contentUrl:t.file.contentUrl,isLocalFile:true}),isAbort:false,progress:100})});function g(e){var n=e[0];if(n.cmd=="respondCS"||n.cmd=="respondSC"){var i=n.jsparam.type;void 0;var r={contentUrl:n.key,contentType:n.contentType,fileName:n.key,size:n.size,width:n.width,height:n.height};t.add(r,function(e){if(e.success){if(i=="ticket"){var t={ticket:n.jsparam,file:{id:e.json.id,fileName:e.json.fileName,contentUrl:r.contentUrl,size:r.size,contentType:r.contentType}};void 0;m(t.file);o.safeApply(a);p.cacheFiles.push({name:t.file.fileName,size:t.file.size,result:angular.toJson({id:t.file.id,fileName:t.file.fileName,contentUrl:t.file.contentUrl,isLocalFile:true}),isAbort:false,progress:100})}}else{c.add("保存失败","danger")}})}else if(n.cmd=="respondD"){u.$broadcast("checkRemoteDeskPlugResult",n)}else if(n.cmd=="respondV"){if(n.remoteFunction=="video_call"){u.$broadcast("checkVideoPlugResult",n)}else{u.$broadcast("checkRemoteDeskPlugResult",n)}}else if(n.cmd=="respondVD"){if(n.run){c.add("视频通话已经运行,将自动拒绝请求","danger");u.$broadcast("mypc_not_support_remote","running");return}if(n.camera||n.microphone){n.user=l.user.name;n.username=l.user.name;s({url:"/accept_remote_desk.json",method:"GET",params:{json:JSON.stringify(n),targetUserId:n.requestClientId,chatId:n.jsparam.chatId,acceptUserId:n.jsparam.acceptUserId,remoteFunction:"video_call"}}).success(function(e,t,i,r){savePluginLog(n.cmd)})}else{c.add("你的电脑没有麦克风或者摄像头,将自动拒绝请求","danger");u.$broadcast("mypc_not_support_remote","hardware")}}}p.cacheFiles=[];if(p.newComment&&angular.isArray(p.newComment.attachments)){angular.forEach(p.newComment.attachments,function(e){a.cacheFiles.push({name:e.fileName,size:e.size,result:angular.toJson({id:e.id,fileName:e.fileName,contentUrl:e.contentUrl}),isAbort:false,progress:100})})}a.uploading=false;a.filesAdded=function(e,t){void 0;plupload.each(t,function(e){e.uploading=true;e.progress=0;a.uploading=true;p.cacheFiles.push(e)})};a.beforeUpload=function(e,t){if(t.size>52428800){void 0;e.stop()}a.uploading=true};a.uploadProgress=function(e,t){var i=e.total.percent;t.progress=i;o.safeApply(a)};a.fileUploaded=function(e,n,t){n.progress=100;s({url:"save_attachment.json",method:"POST",params:{fileName:n.name,contentType:n.type,contentUrl:JSON.parse(t).key,size:n.size}}).success(function(e,t,i,r){if(e.json){n.uploading=false;n.result=e.json;n.result.isLocalFile=true;m(e.json);a.uploading=false}else{void 0;a.uploading=false}})};a.uploadError=function(e,t,i){a.uploading=false;if(t.code==-600){c.add("上传文件不能大于50M。","danger");e.stop()}};a.uploadComplete=function(){};a.removeCacheFile=function(e){p.cacheFiles.splice(p.cacheFiles.indexOf(e),1);a.$broadcast("stopUploadingFile")};a.removeCacheFile=function(i){a.uploading=false;if(!i.result){p.cacheFiles.splice(p.cacheFiles.indexOf(i),1);a.$broadcast("stopUploadingFile");return false}var r=angular.fromJson(i.result);if(confirm("删除文件 "+r.fileName+" ？")){if(r.isLocalFile){t.remove({id:r.contentUrl},function(e){for(var t=0;t<p.newComment.attachments.length;t++){if(p.newComment.attachments[t].id==r.id){p.newComment.attachments.splice(t,1);break}}p.cacheFiles.splice(p.cacheFiles.indexOf(i),1)})}else{for(var e=0;e<p.newComment.attachments.length;e++){if(p.newComment.attachments[e].id==r.id){p.newComment.attachments.splice(e,1);break}}p.cacheFiles.splice(p.cacheFiles.indexOf(i),1)}}};a.showNoResource=true;a.catalogCollapse=function(e){e.collapse=!e.collapse};a.addResource=function(){y();u.helpcenterCommunityAccessSelectTab="resource";n.go("community")};var v=false;a.selectResource=function(i){if(v)return;v=true;y();e(function(){a.$parent.cacheFiles.forEach(function(e,t){if(e.name===i.name){a.$parent.cacheFiles.splice(t,1)}});a.$parent.newComment.attachments.forEach(function(e,t){if(e.fileName===i.name){a.$parent.newComment.attachments.splice(t,1)}});i.attachment.isLocalFile=false;a.$parent.cacheFiles.push({name:i.name,size:i.attachment.size,result:i.attachment,isAbort:false,progress:100});m(i.attachment);v=false},500)};var k=null;a.uploadAttachmentBuried=function(){_hmt.push(["_trackEvent","工单工具","上传附件"])};a.uploadLocationBuried=function(){_hmt.push(["_trackEvent","工单工具","上传本地文件"])};a.pickResource=function(){_hmt.push(["_trackEvent","工单工具","调用社区资源"]);var e="source/views/ticket/ticket_pickup_resource.html";s.get("helpResourcesCatalog_all.json",{params:{_count:999,_do_count:true}}).success(function(e){a.catalogs=e.helpResourcesCatologs;if(a.catalogs.length>0){a.showNoResource=false}s.get("helpResources_all.json",{params:{_count:999,_do_count:true}}).success(function(t){a.total=t._total;a.helpResources=t.helpResources;angular.forEach(a.catalogs,function(i,e){i.resources=[];angular.forEach(t.helpResources,function(e,t){if(e.catalog.id==i.id){i.resources.push(e)}});if(i.resources.length>0){i.collapse=false}else{i.collapse=true}});i()})});var i=function(){k=r({scope:a,title:"选取社区帮助中心的下载资源",contentTemplate:e,html:true,show:true,placement:"center"})}};var y=function(){k.$promise.then(k.hide)};var w=d;a.$on("$destroy",function(){void 0;var e=f.findTabByIdAndStateName("tickets_detail"+w.id,"tickets_detail");if(!e&&h){void 0;h.destroy();h=null}})}})();(function(){"use strict";angular.module("eweiApp.common").directive("ticketReplyBoxTemplate",e).controller("ticketReplyBoxTemplateController",t);e.$inject=["$http","alertService","commonProtocol"];function e(s,l,a){return{restrict:"EA",replace:false,scope:false,link:function(o,e,t){$(document).on("click",function(e){var t=$(e.target);if(t.closest(".ticket_emoji_area").length==0){o.wechatEmojiPanelOpen=false}});function u(){if(navigator.userAgent.indexOf("Firefox")>-1){return true}return false}function d(){if(navigator.userAgent.indexOf("MSIE")>-1||!!navigator.userAgent.match(/Trident.*rv\:11\./)){return true}return false}var r;function i(){if(window.fetch&&typeof fetch=="function"){var e=$("#textarea_area").find('img[src^="data:"]');if(e.length>0){e.each(function(e,t){var i=t.src;$(t).remove();fetch(i).then(function(e){return e.blob()}).then(function(e){f=true;r.addFile(e)})})}}}var f=false;function p(e){return e.replace(/</g,"&lt;").replace(/>/g,"&gt;")}$("#textarea_area").on("paste",function(e){f=true;if(u()){e=e.originalEvent||e;var t=e.clipboardData;var i=t.getData("text");if(i&&i.length>0){e.preventDefault();e.stopPropagation();var r=window.getSelection(),n=r.getRangeAt(0),a=n.createContextualFragment(p(i));n.insertNode(a);r.collapseToEnd();document.execCommand("Delete","false",null);return}}if(d()){var o=window.clipboardData.getData("Text");if(!o||o.length==0){e.stopPropagation?e.stopPropagation():e.cancelBubble=true;e.preventDefault?e.preventDefault():e.returnValue=false;return}}if(window.navigator.userAgent.indexOf("Chrome")&&window.chrome){var s,l;e=e.originalEvent||e;s=e.clipboardData?e.clipboardData.items:[];if(e.clipboardData==undefined){e.clipboardData={items:[]}}var c=false;for(l=0;l<s.length;l++){if(s[l].type=="text/html"||s[l].type=="text/plain"){c=true}}if(c){e.preventDefault();e.stopPropagation();for(l=0;l<s.length;l++){if(s[l].type=="text/plain"){s[l].getAsString(function(e){var e=p(e);document.execCommand("insertHTML","false",e)})}}}}});var n;r=WebUploader.create({dnd:"#textarea_area",swf:"/source/lib/ueditor/third-party/webuploader/Uploader.swf",server:a.fn(),paste:"#textarea_area",duplicate:true,fileSingleSizeLimit:"52428800",threads:1});$("#textarea_area").on("input",i);r.on("uploadStart",function(){if(n){r.option("formData",{key:eweiCommon.uuid(32,16).toLowerCase(),token:n})}else{$.ajax({url:"/qiniu_token.json",type:"GET",async:false,success:function(e){n=e;r.option("formData",{key:eweiCommon.uuid(32,16).toLowerCase(),token:n})}})}});r.on("fileQueued",function(e){if(t.fileType){if(t.fileType=="image"){if(e.type.indexOf("image")!=-1){r.upload()}else{l.add("文件格式不正确","danger")}}}else{r.upload()}e.uploading=true;e.progress=0;e.size=e.size;if(f&&e.ext=="png"){e.name="截图_"+Date.now()+"."+e.ext;f=false}else{e.name=e.name}o.uploading=true;o.$evalAsync(function(){o.cacheFiles.push(e)})});r.on("uploadProgress",function(e,t){var i=parseInt(t*100);e.progress=i});r.on("uploadSuccess",function(a,e){s({url:"save_attachment.json",method:"POST",params:{fileName:a.name,contentType:a.type,contentUrl:e.key,size:a.size}}).success(function(e,t,i,r){if(e.json){if(o.newComment.attachments==null){o.newComment.attachments=[]}a.progress=100;a.uploading=false;a.result=e.json;a.result.isLocalFile=true;o.checkUploading();var n=angular.fromJson(e.json);o.newComment.attachments.push({id:n.id,fileName:n.fileName,contentUrl:n.contentUrl,size:n.size,contentType:n.contentType})}else{l.add("保存附件数据为空失败！","danger");o.checkUploading()}})});r.on("error",function(e){if(e=="F_EXCEED_SIZE"){l.add("上传文件不能大于50M。","danger")}else{l.add("上传失败！","danger")}});o.$on("deleteUploadingFile",function(e,t){r.removeFile(t)});angular.element(".dropdown-menu>li:nth-child(4),.dropdown-menu>li:nth-child(5),.dropdown-menu>li:nth-child(6)",e).on("click",function(e){e.stopPropagation()});o.cancelResLink=function(){angular.element(".dropdown-menu").parent().removeClass("open")}},controller:t,templateUrl:"/source/scripts/directives/ticket-reply-box-template/ticket-reply-box-template.html"}}t.$inject=["$timeout","$scope","commonTools","$http","attachmentService","ConsoleConfig","$ocLazyLoad","alertService","$modal_","$rootScope","$state","$stateParams","utils"];function t(e,a,o,s,t,l,i,c,n,u,r,d,f){a.wechatEmojiPanelOpen=false;a.showWechatEmoji=function(e){if(a.chatIsClose){return}a.wechatEmojiPanelOpen=!a.wechatEmojiPanelOpen;if(e.stopPropagation){e.stopPropagation()}if(e.preventDefault){e.preventDefault()}};var p=function(e){if(a.newComment.attachments==null){a.newComment.attachments=[]}var t=angular.fromJson(e);a.newComment.attachments.push({id:t.id,fileName:t.fileName,contentUrl:t.contentUrl,size:t.size,contentType:t.contentType})};var m;a.requestScreenshot=function(){_hmt.push(["_trackEvent","工单工具","屏幕截图"]);var e={type:"ticket",id:a.ticket.id,status:a.ticket.status,open:a.open};a.downloadApplicationType="requestScreenshot";a.$emit("requestScreenshot",e)};a.requestVideo=function(){_hmt.push(["_trackEvent","工单工具","屏幕录像"]);var e={type:"ticket",id:a.ticket.id,status:a.ticket.status,open:a.open};a.downloadApplicationType="requestVideo";a.$emit("requestVideo",e)};a.$parent.closedownloadApplication=function(){a.$emit(a.downloadApplicationType,"","close")};u.$on("uploadedTicketAttachment",function(e,t){p(t.file);o.safeApply(a);a.cacheFiles.push({name:t.file.fileName,size:t.file.size,result:angular.toJson({id:t.file.id,fileName:t.file.fileName,contentUrl:t.file.contentUrl,isLocalFile:true}),isAbort:false,progress:100})});function h(e){var n=e[0];if(n.cmd=="respondCS"||n.cmd=="respondSC"){var i=n.jsparam.type;void 0;var r={contentUrl:n.key,contentType:n.contentType,fileName:n.key,size:n.size,width:n.width,height:n.height};t.add(r,function(e){if(e.success){if(i=="ticket"){var t={ticket:n.jsparam,file:{id:e.json.id,fileName:e.json.fileName,contentUrl:r.contentUrl,size:r.size,contentType:r.contentType}};void 0;p(t.file);o.safeApply(a);a.cacheFiles.push({name:t.file.fileName,size:t.file.size,result:angular.toJson({id:t.file.id,fileName:t.file.fileName,contentUrl:t.file.contentUrl,isLocalFile:true}),isAbort:false,progress:100})}}else{c.add("保存失败","danger")}})}else if(n.cmd=="respondD"){u.$broadcast("checkRemoteDeskPlugResult",n)}else if(n.cmd=="respondV"){if(n.remoteFunction=="video_call"){u.$broadcast("checkVideoPlugResult",n)}else{u.$broadcast("checkRemoteDeskPlugResult",n)}}else if(n.cmd=="respondVD"){if(n.run){c.add("视频通话已经运行,将自动拒绝请求","danger");u.$broadcast("mypc_not_support_remote","running");return}if(n.camera||n.microphone){n.user=l.user.name;n.username=l.user.name;s({url:"/accept_remote_desk.json",method:"GET",params:{json:JSON.stringify(n),targetUserId:n.requestClientId,chatId:n.jsparam.chatId,acceptUserId:n.jsparam.acceptUserId,remoteFunction:"video_call"}}).success(function(e,t,i,r){savePluginLog(n.cmd)})}else{c.add("你的电脑没有麦克风或者摄像头,将自动拒绝请求","danger");u.$broadcast("mypc_not_support_remote","hardware")}}}if(a.newComment&&angular.isArray(a.newComment.attachments)){angular.forEach(a.newComment.attachments,function(e){a.cacheFiles.push({name:e.fileName,size:e.size,result:angular.toJson({id:e.id,fileName:e.fileName,contentUrl:e.contentUrl}),isAbort:false,progress:100,type:e.contentType})})}var g=a.$watchCollection("newComment.attachments",function(e,t){if(a.cacheFiles.length==0&&e!==t){a.cacheFiles.slice(0,a.cacheFiles.length);angular.forEach(a.newComment.attachments,function(e){a.cacheFiles.push({name:e.fileName,size:e.size,result:angular.toJson({id:e.id,fileName:e.fileName,contentUrl:e.contentUrl}),isAbort:false,progress:100,type:e.contentType})});g()}});a.uploading=false;a.filesAdded=function(e,t){plupload.each(t,function(e){e.uploading=true;e.progress=0;a.uploading=true;a.cacheFiles.push(e)})};a.uploadProgress=function(e,t){var i=e.total.percent;t.progress=i;o.safeApply(a)};a.fileUploaded=function(e,n,t){n.progress=100;s({url:"save_attachment.json",method:"POST",params:{fileName:n.name,contentType:n.type,contentUrl:JSON.parse(t).key,size:n.size}}).success(function(e,t,i,r){if(e.json){n.uploading=false;n.result=e.json;n.result.isLocalFile=true;p(e.json);a.checkUploading()}else{void 0;a.checkUploading()}})};a.uploadError=function(e,t,i){a.checkUploading();if(t.code==-600){c.add("上传文件不能大于50M。","danger");e.stop()}};a.uploadComplete=function(){};a.checkUploading=function(){a.uploading=_.filter(a.cacheFiles,function(e){return!e.result}).length>0};a.removeCacheFile=function(i){if(!i.result){if(i.ext){a.$broadcast("deleteUploadingFile",i);a.cacheFiles.splice(a.cacheFiles.indexOf(i),1);a.checkUploading();return false}else{a.$broadcast("stopUploadingFile",i);a.cacheFiles.splice(a.cacheFiles.indexOf(i),1);a.checkUploading();return false}}var r=angular.fromJson(i.result);a._messages="删除文件 "+r.fileName+" ？";var e=n({scope:a,title:"删除确认",contentTemplate:"source/views/alter_common.html",html:true,show:true,placement:"center"});a.$hide=function(){e.$promise.then(e.hide)};a.$ok=function(){if(r.isLocalFile){t.remove({id:r.contentUrl},function(e){for(var t=0;t<a.newComment.attachments.length;t++){if(a.newComment.attachments[t].id==r.id){a.newComment.attachments.splice(t,1);break}}a.cacheFiles.splice(a.cacheFiles.indexOf(i),1);a.checkUploading()})}else{for(var e=0;e<a.newComment.attachments.length;e++){if(a.newComment.attachments[e].id==r.id){a.newComment.attachments.splice(e,1);break}}a.cacheFiles.splice(a.cacheFiles.indexOf(i),1);a.checkUploading()}a.$hide()}};a.showNoResource=true;a.catalogCollapse=function(e){e.collapse=!e.collapse};a.addResource=function(){y();u.helpcenterCommunityAccessSelectTab="resource";r.go("community")};var v=false;a.selectResource=function(i){if(v)return;v=true;y();e(function(){a.cacheFiles.forEach(function(e,t){if(e.name===i.name){a.cacheFiles.splice(t,1)}});a.newComment.attachments.forEach(function(e,t){if(e.fileName===i.name){a.newComment.attachments.splice(t,1)}});i.attachment.isLocalFile=false;a.cacheFiles.push({name:i.name,size:i.attachment.size,result:i.attachment,isAbort:false,progress:100});p(i.attachment);v=false},500)};var k=null;a.uploadAttachmentBuried=function(){_hmt.push(["_trackEvent","工单工具","上传附件"])};a.uploadLocationBuried=function(){_hmt.push(["_trackEvent","工单工具","上传本地文件"])};a.pickResource=function(){_hmt.push(["_trackEvent","工单工具","调用社区资源"]);var e="source/views/ticket/ticket_pickup_resource.html";s.get("helpResourcesCatalog_all.json",{params:{_count:999,_do_count:true}}).success(function(e){a.catalogs=e.helpResourcesCatologs;if(a.catalogs.length>0){a.showNoResource=false}s.get("helpResources_all.json",{params:{_count:999,_do_count:true}}).success(function(t){a.total=t._total;a.helpResources=t.helpResources;angular.forEach(a.catalogs,function(i,e){i.resources=[];angular.forEach(t.helpResources,function(e,t){if(e.catalog.id==i.id){i.resources.push(e)}});if(i.resources.length>0){i.collapse=false}else{i.collapse=true}});i()})});var i=function(){k=n({scope:a,title:"选取社区帮助中心的下载资源",contentTemplate:e,html:true,show:true,placement:"center"})}};var y=function(){k.$promise.then(k.hide)};var w=d;a.$on("$destroy",function(){void 0;var e=f.findTabByIdAndStateName("tickets_detail"+w.id,"tickets_detail");if(!e&&m){void 0;m.destroy();m=null}});a.resLinkAdding=false;a.addLink=function(){a.resLinkAdding=true;a.addResLink(a.resName,a.resLink,function(){a.resLinkAdding=false;a.resName="";a.resLink="";a.cancelResLink()})};a.validLink=function(){var e=/^(:?http:\/\/|https:\/\/)?[a-z0-9-@:]+\.\S+$/gi;return e.test(a.resLink)}}})();(function(){"use strict";angular.module("eweiApp.common").directive("ticketNewcreateBoxTemplate",e).controller("ticketNewcreateBoxTemplateController",t);e.$inject=["$http","alertService","commonProtocol"];function e(s,l,c){return{restrict:"EA",replace:false,scope:false,link:function(o,e,t){$(document).on("click",function(e){var t=$(e.target);if(t.closest(".ticket_emoji_area").length==0){o.wechatEmojiPanelOpen=false}});function u(){if(navigator.userAgent.indexOf("Firefox")>-1){return true}return false}function d(){if(navigator.userAgent.indexOf("MSIE")>-1||!!navigator.userAgent.match(/Trident.*rv\:11\./)){return true}return false}var r;function i(){if(window.fetch&&typeof fetch=="function"){var e=$("#textarea_area").find('img[src^="data:"]');if(e.length>0){e.each(function(e,t){var i=t.src;$(t).remove();fetch(i).then(function(e){return e.blob()}).then(function(e){p=true;r.addFile(e)})})}}}function f(e){return e.replace(/</g,"&lt;").replace(/>/g,"&gt;")}function n(e){if(document.getElementById(e).contentDocument){return document.getElementById(e).contentDocument}else{return document.frames[e].document}}var p=false;$("#textarea_area").on("paste",function(e){p=true;if(u()){e=e.originalEvent||e;var t=e.clipboardData;var i=t.getData("text");if(i&&i.length>0){e.preventDefault();e.stopPropagation();var r=window.getSelection(),n=r.getRangeAt(0),a=n.createContextualFragment(f(i));n.insertNode(a);r.collapseToEnd();document.execCommand("Delete","false",null);return}}if(d()){var o=window.clipboardData.getData("Text");if(!o||o.length==0){e.stopPropagation?e.stopPropagation():e.cancelBubble=true;e.preventDefault?e.preventDefault():e.returnValue=false;return}}if(window.navigator.userAgent.indexOf("Chrome")&&window.chrome){var s,l;e=e.originalEvent||e;s=e.clipboardData?e.clipboardData.items:[];if(e.clipboardData==undefined){e.clipboardData={items:[]}}var c=false;for(l=0;l<s.length;l++){if(s[l].type=="text/html"||s[l].type=="text/plain"){c=true}}if(c){e.preventDefault();e.stopPropagation();for(l=0;l<s.length;l++){if(s[l].type=="text/plain"){s[l].getAsString(function(e){document.execCommand("insertHTML","false",e)})}}}}});var a;r=WebUploader.create({dnd:"#ticketContent",swf:"/source/lib/ueditor/third-party/webuploader/Uploader.swf",server:c.fn(),paste:"#ticketContent",duplicate:true,fileSingleSizeLimit:"52428800",threads:1});$("#textarea_area").on("input",i);r.on("uploadStart",function(){if(a){r.option("formData",{key:eweiCommon.uuid(32,16).toLowerCase(),token:a})}else{$.ajax({url:"/qiniu_token.json",type:"GET",async:false,success:function(e){a=e;r.option("formData",{key:eweiCommon.uuid(32,16).toLowerCase(),token:a})}})}});r.on("fileQueued",function(e){if(t.fileType){if(t.fileType=="image"){if(e.type.indexOf("image")!=-1){r.upload()}else{l.add("文件格式不正确","danger")}}}else{r.upload()}e.uploading=true;e.progress=0;e.size=e.size;if(p&&e.ext=="png"){e.name="截图_"+Date.now()+"."+e.ext;p=false}else{e.name=e.name}o.uploading=true;o.cacheFiles.push(e)});r.on("uploadProgress",function(e,t){var i=parseInt(t*100);e.progress=i});r.on("uploadSuccess",function(a,e){s({url:"save_attachment.json",method:"POST",params:{fileName:a.name,contentType:a.type,contentUrl:e.key,size:a.size}}).success(function(e,t,i,r){if(e.json){if(o.attachments==null){o.attachments=[]}a.progress=100;a.uploading=false;a.result=e.json;a.result.isLocalFile=true;o.uploading=false;var n=angular.fromJson(e.json);o.attachments.push({id:n.id,fileName:n.fileName,contentUrl:n.contentUrl,size:n.size,contentType:n.contentType,isLocalFile:n.isLocalFile})}else{l.add("保存附件数据为空失败！","danger");o.uploading=false}})});r.on("error",function(e){if(e=="F_EXCEED_SIZE"){l.add("上传文件不能大于50M。","danger")}else{l.add("上传失败！","danger")}});o.$on("deleteUploadingFile",function(e,t){r.removeFile(t)})},controller:t,templateUrl:"/source/scripts/directives/ticket-reply-box-template/ticket-newcreate-box-template.html"}}t.$inject=["$scope","attachmentService","$upload","$timeout","alertService","commonTools","$http","$rootScope","$modal_","$state"];function t(a,n,e,o,r,s,l,t,c,i){a.wechatEmojiPanelOpen=false;a.showWechatEmoji=function(e){if(a.chatIsClose){return}a.wechatEmojiPanelOpen=!a.wechatEmojiPanelOpen;if(e.stopPropagation){e.stopPropagation()}if(e.preventDefault){e.preventDefault()}};if(a.attachments==null){a.attachments=[]}a.showNoResource=true;a.catalogCollapse=function(e){e.collapse=!e.collapse};a.addResource=function(){f();t.helpcenterCommunityAccessSelectTab="resource";i.go("community")};var u=false;a.selectResource=function(i){if(u)return;u=true;f();o(function(){a.cacheFiles.forEach(function(e,t){if(e.name===i.name){a.cacheFiles.splice(t,1)}});a.attachments.forEach(function(e,t){if(e.fileName===i.name){a.attachments.splice(t,1)}});i.attachment.isLocalFile=false;a.cacheFiles.push({name:i.name,size:i.attachment.size,result:i.attachment,isAbort:false,progress:100});m(i.attachment);u=false},500)};var d=null;a.pickResource=function(){var e="source/views/ticket/ticket_pickup_resource.html";l.get("helpResourcesCatalog_all.json",{params:{_count:999,_do_count:true}}).success(function(e){a.catalogs=e.helpResourcesCatologs;if(a.catalogs.length>0){a.showNoResource=false}l.get("helpResources_all.json",{params:{_count:999,_do_count:true}}).success(function(t){a.total=t._total;a.helpResources=t.helpResources;angular.forEach(a.catalogs,function(i,e){i.resources=[];angular.forEach(t.helpResources,function(e,t){if(e.catalog.id==i.id){i.resources.push(e)}});if(i.resources.length>0){i.collapse=false}else{i.collapse=true}});i()})});var i=function(){d=c({scope:a,title:"选取社区帮助中心的下载资源",contentTemplate:e,html:true,show:true,placement:"center"})}};var f=function(){d.$promise.then(d.hide)};function p(){a.cacheFiles=[];if(angular.isArray(a.attachments)){angular.forEach(a.attachments,function(e){a.cacheFiles.push({name:e.fileName,size:e.size,result:angular.toJson({id:e.id,fileName:e.fileName,contentUrl:e.contentUrl,isLocalFile:e.isLocalFile}),isAbort:false,progress:100,type:e.contentType})})}}p();a.requestScreenshot=function(){var e={type:"ticket",id:""};a.downloadApplicationType="requestScreenshot";a.$emit("requestScreenshot",e)};a.requestVideo=function(){var e={type:"ticket",id:""};a.downloadApplicationType="requestVideo";a.$emit("requestVideo",e)};a.closedownloadApplication=function(){a.$emit(a.downloadApplicationType||"requestVideo","","close")};t.$on("uploadedTicketAttachment",function(e,t){m(t.file);s.safeApply(a);a.cacheFiles.push({name:t.file.fileName,size:t.file.size,result:angular.toJson({id:t.file.id,fileName:t.file.fileName,contentUrl:t.file.contentUrl,isLocalFile:true}),isAbort:false,progress:100})});a.uploading=false;a.filesAdded=function(e,t){plupload.each(t,function(e){e.uploading=true;e.progress=0;a.cacheFiles.push(e)});s.safeApply(a)};a.beforeUpload=function(e,t){if(t.size>52428800){r.add("上传文件不能大于50M。");e.stop()}a.uploading=true};a.uploadProgress=function(e,t){var i=e.total.percent;a.$emit("uploading",true);t.progress=i;s.safeApply(a);void 0};a.fileUploaded=function(e,n,t){n.progress=100;l({url:"save_attachment.json",method:"POST",params:{fileName:n.name,contentType:n.type,contentUrl:JSON.parse(t).key,size:n.size}}).success(function(e,t,i,r){if(e.json){o(function(){n.uploading=false;n.result=e.json;n.result.isLocalFile=true;m(e.json);s.safeApply(a);a.checkUploading()})}else{void 0}})};a.uploadError=function(e,t,i){a.checkUploading();if(t.code==-600){r.add("上传文件不能大于50M。","danger");e.stop()}};a.uploadComplete=function(){};var m=function(e){var t=angular.fromJson(e);a.attachments.push({id:t.id,fileName:t.fileName,contentUrl:t.contentUrl,size:t.size,contentType:t.contentType,isLocalFile:t.isLocalFile})};a.$watchCollection("attachments",function(e,t){if(e!==t){p()}});a.checkUploading=function(){var e=_.filter(a.cacheFiles,function(e){return!e.result}).length>0;a.uploading=e;a.$emit("uploading",e)};a.deleteAttachment=function(e,i){if(!e.result){if(e.ext){a.$broadcast("deleteUploadingFile",e);a.cacheFiles.splice(a.cacheFiles.indexOf(e),1);a.checkUploading();return false}else{a.$broadcast("stopUploadingFile",e);a.cacheFiles.splice(a.cacheFiles.indexOf(e),1);a.checkUploading();return false}}var r=angular.fromJson(e.result);a._messages="删除文件 "+r.fileName+" ？";var t=c({scope:a,title:"删除确认",contentTemplate:"source/views/alter_common.html",html:true,show:true,placement:"center"});a.$hide=function(){t.$promise.then(t.hide)};a.$ok=function(){if(r.isLocalFile){n.remove({id:r.contentUrl},function(e){for(var t=0;t<a.attachments.length;t++){if(a.attachments[t].id==r.id){a.attachments.splice(t,1);break}}a.cacheFiles.splice(i,1);a.checkUploading()})}else{for(var e=0;e<a.attachments.length;e++){if(a.attachments[e].id==r.id){a.attachments.splice(e,1);break}}a.cacheFiles.splice(i,1);a.checkUploading()}a.$hide()}}}})();(function(){"use strict";angular.module("eweiApp.common").directive("eweiUploader",e).controller("eweiUploaderController",t);e.$inject=["ConsoleConfig","EweiConfig","$http","$q","commonProtocol","$timeout"];function e(o,s,e,t,l,c){return{restrict:"EA",replace:true,scope:{filesAdded:"&",beforeUpload:"&",uploadProgress:"&",fileUploaded:"&",uploadError:"&",uploadComplete:"&"},template:'<a ng-click="uploadLocationBuried()">上传本地文件</a>',controller:"eweiUploaderController",controllerAs:"eweiUploader",link:function(e,t,i,r){var n=i.dropElement;var a=null;c(function(){var e={url:l.fn(),runtimes:"html5,flash,html4",browse_button:t[0].id,uptoken_url:"/api/v1/qiniu_token.json?provider_id="+o.provider.id+"&_token="+getCookie("user_token"),get_new_uptoken:true,domain:s.bucket_domain,unique_names:false,save_key:false,container:"container",max_file_size:"50mb",flash_swf_url:"source/lib/qiniu/plupload/Moxie.swf",max_retries:3,dragdrop:true,chunk_size:"4mb",auto_start:true,drop_element:n,init:{FilesAdded:function(e,t){r.filesAdded({up:e,files:t})},BeforeUpload:function(e,t){r.beforeUpload({up:e,file:t})},UploadProgress:function(e,t){r.uploadProgress({up:e,file:t})},FileUploaded:function(e,t,i){r.fileUploaded({up:e,file:t,info:i})},Error:function(e,t,i){r.uploadError({up:e,err:t,errTip:i})},UploadComplete:function(e){r.uploadComplete({up:e})},Key:function(e,t){return eweiCommon.uuid(32,16).toLowerCase()}}};a=Qiniu.uploader(e)},300);e.$on("stopUploadingFile",function(e,t){a.removeFile(t)})},bindToController:true}}t.$inject=["$scope"];function t(e){}})();(function(){"use strict";angular.module("eweiApp.common").directive("eweiWebuploader",e);e.$inject=["alertService","commonProtocol"];function e(s,l){return{restrict:"EA",scope:{uploadStart:"&",fileQueued:"&",uploadProgress:"&",uploadSuccess:"&",error:"&"},link:function(i,e,r){var n=null;var t=e[0].id?e[0].id:Date.now();e[0].id=t;var a={swf:"/source/lib/ueditor/third-party/webuploader/Uploader.swf",server:r.serverUrl||l.fn(),pick:{id:"#"+t,multiple:false},resize:false,fileSingleSizeLimit:r.fileSingleSizeLimit*1024*1024,duplicate:true,formData:{}};if(r.dnd==="true"){a.dnd="#"+t}var o=WebUploader.create(a);o.on("uploadStart",function(){var t={};if(r.formData){t=JSON.parse(r.formData)}if(n){t.key=eweiCommon.uuid(32,16).toLowerCase();t.token=n;o.option("formData",t)}else{$.ajax({url:"/qiniu_token.json",type:"GET",async:false,success:function(e){n=e;t.key=eweiCommon.uuid(32,16).toLowerCase();t.token=n;o.option("formData",t)}})}});o.on("fileQueued",function(e){var t=false;i.fileQueued({file:e,cb:function(e){t=e}});if(t){return false}if(r.fileType){if(r.fileType=="image"){if(e.type.indexOf("image")!=-1){o.upload()}else{s.add("文件格式不正确","danger")}}}else{o.upload()}});o.on("uploadProgress",function(e,t){i.uploadProgress({file:e,percentage:t})});o.on("uploadSuccess",function(e,t){i.uploadSuccess({file:e,response:t})});o.on("error",function(e){i.error({handler:e})});i.$on("removeUploadingFile",function(e,t){o.removeFile(t)})}}}})();(function(){"use strict";angular.module("eweiApp.common").directive("messageBoxIcon",e).controller("messageBoxIconController",r).directive("messageBox",t).controller("messageBoxController",i);e.$inject=["$timeout","$rootScope","$window"];function e(e,t,i){return{restrict:"EA",replace:true,scope:{},template:'<a class="notify message-icon" title="通知消息" ng-click="vm.togglePanel()"><span class="bell"><i class="iconfont">&#xe646;</i><span class="badge" ng-if="vm.messageCount>0">{{vm.messageCountView}}</span></span></a>',controller:r,controllerAs:"vm",link:function(e,t,i){t.on("click",function(e){e.stopPropagation()})}}}r.$inject=["$scope","$rootScope","$q","$http","$timeout","EweiConfig","ConsoleConfig","coreNotifyService","apiMessageService"];function r(e,t,i,r,n,a,o,s,l){var c=this;var u=c.__proto__.constructor.name+"_"+(new Date).valueOf();c.listName="count";c.messageCount=0;c.togglePanel=function(){t.$broadcast("toggle-global-panel",{name:"message-panel"})};c.showPanel=function(){t.$broadcast("active-global-panel",{name:"message-panel"})};c.hidePanel=function(){t.$broadcast("deactive-global-panel",{name:"message-panel"})};c.checkMessageCount=function(){l.run(c.listName,s.constant.EVENT_OTHER_MESSAGE_COUNT,1,"")};var d=function(){if(c.messageCount>99){c.messageCountView=99}else{c.messageCountView=c.messageCount}};var f=function(e,t){try{r({url:"delete_notify_log_by_id.json",method:"GET",params:{notifyLogId:t.notifyLogId}}).success(function(e,t,i,r){v()})}catch(e){void 0}};var p=function(){c.checkMessageCount()};var m=function(e,t){c.messageCount=t.count;d()};var h=null;var g=function(){n.cancel(h);h=n(function(){c.checkMessageCount()},6e4)};var v=function(){n.cancel(h);h=n(function(){c.checkMessageCount()},6e4)};var k=function(){s.register(u,s.constant.EVENT_OTHER_MESSAGE_COUNT,m)};var y=function(){s.unRegister(u)};k();c.checkMessageCount();e.$on("notice",g);e.$on("remove-notify",f);e.$on("open-ticket",p);e.$on("active-global-panel",function(e,t){if(t.name==="message-panel"){c.messageCount=0;r({url:"api/v1/notify/update_new_msg_false.json?provider_id="+o.provider.id+"&_token="+getCookie("user_token"),method:"POST"}).success(function(e,t,i,r){if(e.success){}})}});e.$on("$destory",y)}t.$inject=["$timeout","$window"];function t(l,c){return{restrict:"EA",replace:true,scope:{},templateUrl:"/source/scripts/directives/message-box/message-box.html",controller:i,controllerAs:"vm",compile:function e(t,i,r){return{post:function(e,t,i){function r(){if(e.vm.panelActived){l(e.vm.hidePanel)}}t.on("click",function(e){e.stopPropagation()});l(function(){$(c).on("click",r)},500);var n=angular.element(".panel-body",t);var a=angular.element(".messages-list",n);var o=false;var s=_.throttle(e.vm.getMore,1e3,{trailing:false});n.on("scroll",function(){if(a.height()-n.height()<=n.scrollTop()){if(!o){o=true;l(function(){o=false;s()},50)}}});e.$on("panel-changed",function(e,t){if(t=="message"){n.scrollTop(0)}});e.$on("$destroy",function(){$(c).off("click",r)})}}}}}i.$inject=["$scope","$rootScope","$q","$http","$timeout","utils","$state","commonTools","EweiConfig","ConsoleConfig","permissions","$window","$modal_","alertService","coreNotifyService","coreModelService","apiMessageService","apiSetMessageService","apiNotifySettingService","routerConstant","license"];function i(n,a,e,t,i,r,o,s,l,c,u,d,f,p,m,h,g,v,k,y,w){var C=this;var _=C.__proto__.constructor.name+"_"+Date.now();C.listName="";C.argument={_count:10,_page:1};C.argumentLast=undefined;C.panelActived=false;C.notifyLogs=[];C.nextPageNo=1;C.currentPanel="message";C.userNoticeConfig={};C.loading=false;C.licenseService=w;var b="message-panel";C.checkIfNeedLoadData=function(){if(C.panelActived){C.currentPanel="message";n.$emit("panel-changed",C.currentPanel);C.nextPageNo=1;C.argument._page=1;$(true)}};C.hidePanel=function(){a.$broadcast("deactive-global-panel",{name:b})};C.autoHideOtherPanel=function(){};C.getMore=function(){if(C.argument._page==C.nextPageNo){void 0;return}C.argument._page=C.nextPageNo;$()};n.$on("active-global-panel",function(e,t){C.panelActived=t.name===b;C.checkIfNeedLoadData();C.autoHideOtherPanel()});n.$on("deactive-global-panel",function(e,t){if(t.name===b){C.panelActived=false}});n.$on("toggle-global-panel",function(e,t){if(t.name===b){var i={name:b};if(!C.panelActived){a.$broadcast("active-global-panel",i)}else{a.$broadcast("deactive-global-panel",i)}}});n.$on("remove-notify",function(e,t){if(t&&t.notifyLogId){for(var i=0;i<C.notifyLogs.length;i++){if(C.notifyLogs[i].id===t.notifyLogId){C.notifyLogs.splice(i,1);break}}}});var S=function(){C.loading=true;g.run(C.listName,m.constant.EVENT_LIST_MESSAGE,C.argument._page,{userId:c.user.id},C.argument,function(e){C.loading=false})};var T=function(){var e=[];for(var t=1;t<=C.argument._page;t++){e=e.concat(h.list.messages.gets(t))}C.notifyLogs=h.detail.messages.gets(e);if(C.notifyLogs&&C.notifyLogs.length>0){angular.forEach(C.notifyLogs,function(e){if(a.providerEweiProductName!=""){e.message=e.message.replaceAll("易维帮助台",a.providerEweiProductName)}if(e.type==="project"&&e.operater){var t=e.operater.name||e.operater.nickname;var i=angular.fromJson(e.message);i.userName=t;e.message=angular.toJson(i)}})}};var $=function(e){T();if(e||JSON.stringify(C.argument)!=JSON.stringify(C.argumentLast)){S();C.argumentLast=angular.copy(C.argument)}};var E=function(){m.register(_,m.constant.EVENT_LIST_MESSAGE,function(e,t){$();C.nextPageNo=t._total>C.argument._page*C.argument._count?C.argument._page+1:C.nextPageNo});m.register(_,m.constant.EVENT_DETAIL_MESSAGES,function(e,t){if(t&&t.action){if(t.action==="delete"&&t.id!==undefined){a.$broadcast("message-removed");for(var i=0,r=C.notifyLogs.length;i<r;i++){if(t.id==C.notifyLogs[i].id){C.notifyLogs.splice(i,1);break}}}else if(t.action==="clear"){C.notifyLog=[];a.$broadcast("message-removed");n.hideModal()}}});m.register(_,m.constant.EVENT_DETAIL_NOTIFYCONFIG,function(e,t){if(t!==undefined&&t.config){C.userNoticeConfig=t.config}})};var F=function(){m.unRegister(_)};E();C.deleteNotifyLogs=function(){_hmt.push(["_trackEvent","消息侧栏","清空消息"]);if(C.notifyLogs.length>0){n._messages="确定要清空消息列表吗？";var e=f({scope:n,title:"清空确认",contentTemplate:"source/views/alter_common.html",html:true,show:true,placement:"center"});n.hideModal=function(){e.$promise.then(e.hide)};n.$ok=function(){v.run("clear",m.constant.EVENT_DETAIL_MESSAGES);C.argument={_count:10,_page:1}}}};C.clickNotifyLog=function(e){var t=null;v.run("delete",m.constant.EVENT_DETAIL_MESSAGES,{notifyLogId:e.id});if(e.type=="ticket"){C.hidePanel();o.go("tickets_detail",{id:e.targetId})}else if(e.type=="comment_article"){d.open("/new/#/article/detail/"+e.targetId)}else if(e.type=="answer_question"){d.open("/new/#/forum/detail/"+e.targetId)}else if(e.type=="comment_answer"){d.open("/new/#/forum/detail/"+e.targetId)}else if(e.type=="project"){t=angular.fromJson(e.message);C.hidePanel();o.go("project_detail",{categoryid:t.projectCategoryId,id:t.projectId})}else if(e.type=="file"){C.hidePanel();t=angular.fromJson(e.message);var i=Date.now();var r=new Date(e.createdAt.replace(/-/g,"/")).getTime();var n=7*24*60*60*1e3;if(i-r>n){p.add("数据已失效，最多保留7天","danger");return false}var a="/ewei_attachment?contentUrl="+t.attachmentUrl+"&fileName="+encodeURIComponent(t.attachmentName);d.open(a)}};C.component_popup=function(e){a.$broadcast("show_component_popup",e)};C.showSettingPanel=function(){_hmt.push(["_trackEvent","右侧消息","最新消息设置"]);C.hidePanel();y.setNotify(true)};C.hideSettingPanel=function(){C.currentPanel="message";n.$emit("panel-changed",C.currentPanel)}}})();(function(){"use strict";k.$inject=["input"];angular.module("eweiApp.common").directive("avatarBoxIcon",e).controller("avatarBoxIconController",t).directive("avatarBox",i).controller("avatarBoxController",a).filter("stripDomain",k);e.$inject=[];function e(){return{restrict:"EA",replace:true,scope:{},template:'<a class="avatar avatar-icon" ng-class="{\'active\':panelActived}" ng-click="togglePanel();clearSpot()"><image-show imageurl="{{$root.currentUserPhoto}}" defaultimageurl="source/images/face/header_40.png" imagestyle="head.40.40" imageclass="img-circle" editable="false"></image-show><span ng-if="showSpot" class="spot"></span><i class="iconfont">&#xe60e;</i><span class="busy" ng-if="$root.concurrentChatNumber===0"><i class="iconfont"></i></span></a>',controller:t,link:function(e,t){t.on("click",function(e){e.stopPropagation()})}}}t.$inject=["$scope","$rootScope","$log","ConsoleConfig","coreNotifyService","apiConsoleGuideService"];function t(e,t,i,r,n,a){var o=e;var s=o.__proto__.constructor.name+"_"+Date.now();o.showSpot=false;o.guideDataExist=false;o.togglePanel=function(){t.$broadcast("toggle-global-panel",{name:"avatar-panel"})};o.showPanel=function(){t.$broadcast("active-global-panel",{name:"avatar-panel"})};o.hidePanel=function(){t.$broadcast("deactive-global-panel",{name:"avatar-panel"})};var l=function(){a.run("get",n.constant.EVENT_DETAIL_CONSOLE_GUIDE,{},{consoleOperateQuides:"account"})};o.emailExamined=false;if(r.user.emailExamined){o.emailExamined=true}var c=function(e){if(angular.isDefined(e)&&angular.isDefined(e.result)&&angular.isDefined(e.result.consoleOperateQuides)){var t=e.result.consoleOperateQuides;o.guideDataExist=false;for(var i=0;i<t.length;i++){if(t[i].operate==="account"){o.guideDataExist=true;break}}o.showSpot=!o.guideDataExist}};o.clearSpot=function(){!o.guideDataExist&&a.run("set",n.constant.EVENT_DETAIL_CONSOLE_GUIDE,{},{operate:"account"},function(e){if(e.status==0){o.guideDataExist=true;o.showSpot=false}})};function u(){n.register(s,n.constant.EVENT_DETAIL_CONSOLE_GUIDE,function(e,t){c(t)})}function d(){n.unRegister(s)}e.$on("$destory",d);function f(){u();l()}f()}i.$inject=["$timeout","$window"];function i(r,n){return{restrict:"EA",replace:true,scope:{},templateUrl:"/source/scripts/directives/avatar-box/avatar-box.html",controller:a,link:function(e,t){function i(){if(e.panelActived){r(e.hidePanel)}}t.on("click",function(e){e.stopPropagation()});r(function(){angular.element(n).on("click",i)},500);e.$on("$destory",function(){angular.element(n).off("click",i)})}}}a.$inject=["$scope","$rootScope","$log","$http","ConsoleConfig","permissions","$window","$modal_","engineerService","routerConstant","license","alertService","$q"];function a(t,r,e,i,n,a,o,s,l,c,u,d,f){var p=t;p.panelActived=false;p.currentUserName=n.user.name;p.providerHelpCenterUrl=n.providerHelpCenterUrl;p.providerDomain=k(n.providerHelpCenterUrl);p.chatNumberOptions=[];p.engineer={};p.licenseService=u;p.hasCallCenter=false;function m(){var t=f.defer();org.ewei.sdk.OpenChannelApi().listPhoneCallCenter({page:{pageNumber:1,pageSize:999}}).then(function(e){p.hasCallCenter=e&&e.list&&e.list.length>0;t.resolve(p.hasCallCenter)},t.reject);return t.promise}p.goCti=function(e){if(!p.hasCallCenter){e.preventDefault();d.add("未开通呼叫中心渠道，请联系管理员开通","danger")}p.hidePanel()};var h="avatar-panel";var g=1;if(a.hasPermission("chat_shows_busy")){g=0}for(var v=g;v<=10;v++){p.chatNumberOptions.push({text:v==0?"0(示忙)":v.toString(),active:r.concurrentChatNumber==v,click:"setCurrentChatNumber("+v+")"})}p.hidePanel=function(){r.$broadcast("deactive-global-panel",{name:h})};p.goNotify=function(){c.setNotify(true)};p.autoHideOtherPanel=function(){};t.$on("active-global-panel",function(e,t){p.panelActived=t.name===h;m().then(function(e){p.hasCallCenter=e});p.autoHideOtherPanel()});t.$on("deactive-global-panel",function(e,t){if(t.name===h){p.panelActived=false}});t.$on("toggle-global-panel",function(e,t){if(t.name===h){var i={name:h};if(!p.panelActived){r.$broadcast("active-global-panel",i)}else{r.$broadcast("deactive-global-panel",i)}}});p.favoriteLink=function(){s({scope:t,title:"提示信息",contentTemplate:"source/views/favorite.html",html:true,show:true,placement:"center"})};p.setChatNumber=function(e){_hmt.push(["_trackEvent","全局功能","并发会话上限"]);p.showChatNumberSelector=!p.showChatNumberSelector;e.stopPropagation()};p.logoutBuried=function(){var n="/redirect_to_helpcenter#/login?from_console_logout";i.get("logout").success(function(e,t,i,r){window.location.href=n})};p.setCurrentChatNumber=function(t){i({url:"update_concurrent_number",method:"GET",params:{t:Date.now(),number:t}}).success(function(e){if(e.success){r.concurrentChatNumber=t;r.$broadcast("concurrent-chat-number-changed",t)}})};p.getCurrentEngineer=function(){l.get({id:n.engineer.id},function(e){userAginLogin(e);t.engineer=e.json})};p.getCurrentEngineer();p.clearSpot=function(){if(p.showSpot){}};p.component_popup=function(e){r.$broadcast("show_component_popup",e)};t.$on("active-global-panel",function(e,t){p.panelActived=t.name==="avatar-panel"})}function k(e){var t=/https?:\/\/(?:www\.)?([-a-zA-Z0-9@:%._\+~#=]{2,256}\.[a-z]{2,6}\b)*(\/[\/\d\w\.-]*)*(?:[\?])*(.+)*/gi;if(t.test(e)){t.lastIndex=0;var i=t.exec(e);if(i.length>1){return i[1]}}return e}})();(function(s){"use strict";s.module("eweiApp.common").directive("customStyle",e).controller("customStyleController",t);e.$inject=[];function e(){return{restrict:"A",replace:true,scope:{},templateUrl:"source/scripts/directives/ewei-custom-style/ewei-custom-style.html",controller:"customStyleController"}}t.$inject=["$scope","$rootScope","$http","$log","ConsoleConfig"];function t(e,i,t,r,n){var a=e;function o(){t({url:"get_console_style_custom_by_provider_id.json",method:"GET",params:{providerId:n.provider.id}}).success(function(e){a.style=e.json||{};if(s.isUndefined(a.style.headBackgroundColor)){a.style.headBackgroundColor="#3bb6ee"}a.mainColor=tinycolor(a.style.headBackgroundColor);i.mainColor=a.style.headBackgroundColor;r.debug("loaded style:",a.style)})}o();e.$on("provider-changed",function(){o()});e.$on("provider-color-setting",function(e,t){a.style.headBackgroundColor=t;a.mainColor=tinycolor(a.style.headBackgroundColor);i.mainColor=a.style.headBackgroundColor});a.mixColor=tinycolor.mix}})(angular);(function(){"use strict";angular.module("eweiApp.common").provider("ladda",function(){var t={style:"zoom-in"};return{setOption:function(e){angular.extend(t,e)},$get:function(){return t}}}).directive("ladda",["ladda","$timeout",function(a,e){return{restrict:"A",priority:-1,link:function(i,r,n){e(function(){r.addClass("ladda-button");if(angular.isUndefined(r.attr("data-style"))){r.attr("data-style",a.style||"zoom-in")}if(angular.isUndefined(r.attr("data-spinner-size"))&&a.spinnerSize){r.attr("data-spinner-size",a.spinnerSize)}if(angular.isUndefined(r.attr("data-spinner-color"))&&a.spinnerColor){r.attr("data-spinner-color",a.spinnerColor)}if(!r[0].querySelector(".ladda-label")){var e=document.createElement("span");e.className="ladda-label";angular.element(e).append(r.contents());r.append(e)}var t=Ladda.create(r[0]);i.$watch(n.ladda,function(e){if(!e&&!angular.isNumber(e)){t.stop();if(n.ngDisabled){r.attr("disabled",i.$eval(n.ngDisabled))}return}if(!t.isLoading()){t.start()}if(angular.isNumber(e)){t.setProgress(e)}});i.$on("$destroy",function(){t.remove()})})}}}])})();(function(u){"use strict";u.module("eweiApp.common").directive("inviteEngineerDialog",e).controller("inviteEngineerDialogController",t);e.$inject=[];function e(){return{restrict:"EA",scope:{},templateUrl:"",controller:t,controllerAs:"vm"}}t.$inject=["$rootScope","$scope","$modal_","coreNotifyService","coreModelService","apiInviteEngineerService","roleService","alertService"];function t(e,i,r,n,t,a,o,s){var l=this;i.$on("show-invite-engineer-dialog",function(){l.showInviteEngineerDialog()});l.engineersRoleList=[];o.query({_count:999,_do_count:false,_fields:"id,name",_filter:"{'$and':[{'$eq':{'provider.id':${current_provider_id}}},{'$eq':{'type':'engineer'}}]}"},function(e){l.engineersRoleList=e.roles||[];l.addEngineer()});function c(e){var t=l.inviteEngineerForm;var i={name:t["name-"+e],email:t["email-"+e],role:t["role-"+e]};if(i.name.$invalid){i.name.$dirty=true;t.$setDirty();l.errorMessage="必须填写名字";return false}if(i.email.$invalid){i.email.$dirty=true;t.$setDirty();if(i.email.$error&&i.email.$error.required){l.errorMessage="必须填写Email"}else{l.errorMessage="Email格式错误，请重新填写"}return false}if(i.role.$invalid){i.role.$dirty=true;t.$setDirty();l.errorMessage="必须选择角色";return false}return true}l.inviteEngineers=[];l.addEngineer=function(){l.inviteEngineers.push({engineerRole:{id:l.engineersRoleList[0].id}});l.errorMessage=undefined};l.removeEngineer=function(e){if(e!==0){l.inviteEngineers.splice(e,1)}};l.showInviteEngineerDialog=function(){l.inviteEngineers=[];l.addEngineer();var t=r({scope:i,title:"邀请客服",template:"source/scripts/directives/ewei-invite-engineer/ewei-invite-engineer-dialog.html",html:true,show:true,placement:"top"});i.hideModal=function(){t.$promise.then(t.hide)};i.newUserGroup={shared:false,userGroupCustomFields:[]};i.groupField={};i.$save=function(){l.errorMessage=undefined;for(var e=0;e<l.inviteEngineers.length;e++){if(!c(e)){return}}if(!i.vm.inviteEngineerForm.$valid){i.vm.inviteEngineerForm.$dirty=true;return}l.saving=true;a.run("invite",n.constant.EVENT_OTHER_INVITE_ENGINEER,{},l.inviteEngineers,function(e){l.saving=false;if(u.isDefined(e)&&e.status==0){t.hide();s.add("邀请邮件已发出，请通知小伙伴激活账号！")}})}}}})(angular);angular.module("com.ewei.angular.ui").directive("engineerStatus",function(){return{restrict:"E",scope:{chatCount:"=",chatMax:"=",brackets:"@",engineer:"="},templateUrl:"/source/scripts/directives/engineer-status/engineer-status.html"}});(function(s){"use strict";angular.module("com.ewei.angular.ui").directive("eweiPermissions",t).controller("eweiPermissionsController",e);e.$inject=["$http","$stateParams","ConsoleConfig","$scope"];function e(e,t,i,n){n.hasMore=false;n.allChecked=false;r();function r(){a()}function a(){s.sdk.OpenRoleApi().listEngineerRole({includeCreator:false}).then(function(t){if(t){var e=_.filter(t,function(e){return!!e.nameKey});t=_.sortBy(t,function(e,t){return e.id-t.id});angular.forEach(e,function(e){t.splice(t.indexOf(e),1)});t=e.concat(t);if(n.type!=="add"){for(var i=0;i<t.length;i++){for(var r=0;r<n.rolePermissions.length;r++){if(t[i].id===n.rolePermissions[r].roleId){t[i].scanAble=n.rolePermissions[r].scanAble;t[i].editAble=n.rolePermissions[r].editAble;break}}}}else{for(var i=0;i<t.length;i++){t[i].scanAble=true;t[i].editAble=true}}if(t.length<=5){n.hasMore=false}else{n.hasMore=true}n.roleJurisdictionList=t.slice(0,5);n.allRoleJurisdictionList=t;n.$parent.fieldPermissions=n.allRoleJurisdictionList;o("scanAble")}})}n.scanAble=function(e,t){e.editAble=e.scanAble;o(t)};n.showMore=function(){n.roleJurisdictionList=n.allRoleJurisdictionList;n.hasMore=false};n.checkAll=function(t){var i=n.allChecked;angular.forEach(n.allRoleJurisdictionList,function(e){e[t]=i})};function o(t){var i=true;angular.forEach(n.allRoleJurisdictionList,function(e){if(!e[t])i=false});n.allChecked=i}}function t(){return{restrict:"EA",replace:true,controller:"eweiPermissionsController",templateUrl:"/source/scripts/directives/ewei-permissions/ewei-permissions.html"}}})(org.ewei);(function(){"use strict";angular.module("com.ewei.angular.ui").directive("eweiTicketSla",e);e.$inject=["$compile","ticketStatusColorService","$popover","$sce"];function e(e,u,d,f){return{restrict:"E",replace:true,scope:{ticketstatuscolors:"=",ticketid:"@",status:"=",format:"@",ticketdetail:"@",disablePopover:"@",deleted:"="},template:'<span class="{{slaClass}} ticket-sla" style="cursor:pointer;">{{slaText}}</span>',link:function(n,a,e){n.slaClass="";n.slaText="";var o;var s=function(e){var t=e%60;var i=Math.floor(e/1440);var r=Math.floor(e%1440/60);var n="";t=t>0?t:0;r=r>0?r:0;i=i>0?i:0;if(i>0){n+=i+"天"}if(r>0){n+=r+"小时"}if(t>0){n+=t+"分钟"}if(n==""){n="0分钟"}return n};var t=function(){if(angular.isDefined(n.ticketstatuscolors)&&n.ticketstatuscolors!=null){var e={};if(angular.isDefined(n.ticketstatuscolors[n.ticketid])){e=n.ticketstatuscolors[n.ticketid]}n.slaText=n.format=="short"?n.status.toUpperCase().substr(0,1):n.status.toUpperCase();n.slaClass=n.status;if(n.deleted){n.slaText=n.format=="short"?"D":"DELETED";n.slaClass="deleted"}var t="";if(e.solveLevel||e.responseLevel){t+="<div>";if(e.responseLevel){var i="";switch(e.responseLevel){case 1:i="#66CC00";break;case 2:i="#FF9900";break;case 3:i="#FF0000";break}t+='<p class="text-nowrap" style="color:'+i+';">响应耗时：'+s(e.responseMinutes)+"，SLA指标："+s(e.planResponseMinutes)+"</p>"}if(e.solveLevel){var r="";switch(e.solveLevel){case 1:r="#66CC00";break;case 2:r="#FF9900";break;case 3:r="#FF0000";break}t+='<p class="text-nowrap" style="color:'+r+';">处理耗时：'+s(e.solveMinutes)+"，SLA指标："+s(e.planSolveMinutes)+"</p>"}t+="</div>"}else{t+="<div>未匹配到SLA</div>"}n.popoverHtml=t}else{}if(n.popoverHtml&&!(n.disablePopover&&n.disablePopover=="true")){if(o){o.destroy()}o=d(a,{content:f.trustAsHtml(n.popoverHtml),trigger:"hover",html:true,placement:"top",container:"body",autoClose:true,template:"/source/scripts/directives/ewei-ticket-sla/sla_tip.html"})}};var i=n.$watch("ticketstatuscolors",function(){t()});var r=function(e){u.run("",{ticketIds:e},true,function(e){if(e.success){n.ticketstatuscolors=e.json}else{}})};var l=n.$watch("status",function(e,t){if(e!=t&&n.ticketdetail!=undefined&&t!=undefined){r(n.ticketid)}});if(n.ticketdetail!=undefined){r(n.ticketid)}var c=n.$on("ticket_sla_update",function(e,t){r(t.ticketId)});n.$on("$destroy",function(){i();l();c();if(o){o.destroy()}})}}}})();(function(){"use strict";angular.module("com.ewei.angular.ui").directive("eweiCustomColumnWidth",e);e.$inject=["DefaultColumnWidth","$parse"];function e(s,e){return{restrict:"A",scope:{columnType:"=",column:"=eweiCustomColumnWidth",customFieldColumnWidthInfo:"=",fieldColumnWidthInfo:"="},link:function(e,t,i){var r=e.columnType;var n,a=180;function o(){if(angular.isDefined(e.column)&&angular.isDefined(r)){if(s.hasOwnProperty(r+"Fields")){n=s[r+"Fields"];if(angular.isString(e.column.field)&&n.hasOwnProperty(e.column.field)){a=n[e.column.field];if(angular.isDefined(e.fieldColumnWidthInfo)){if(e.fieldColumnWidthInfo.hasOwnProperty(e.column.field)&&!isNaN(e.fieldColumnWidthInfo[e.column.field])){a=e.fieldColumnWidthInfo[e.column.field]}}}if(angular.isNumber(e.column.field)){if(angular.isDefined(e.customFieldColumnWidthInfo)){if(e.customFieldColumnWidthInfo.hasOwnProperty(e.column.field)&&!isNaN(e.customFieldColumnWidthInfo[e.column.field])){a=e.customFieldColumnWidthInfo[e.column.field]}}}}t.css("width",a+"px");t.css("minWidth",a+"px");t.css("maxWidth",a+"px")}}o();e.$watch("fieldColumnWidthInfo",function(e,t){if(e!==t){o()}})}}}})();(function(){"use strict";angular.module("com.ewei.angular.ui").directive("eweiTableAutoRows",e);e.$inject=["$window","$parse","$timeout"];function e(a,g,o){return{restrict:"A",require:"?ngTable",link:function(f,p,m,e){var i=0;function h(){i++;var e=p.find("tbody>tr.ng-table-group");var t=p.find("thead>tr");if(t.length>0&&t.get(0).scrollWidth>0){e.css("width",t.get(0).scrollWidth+"px");e.parent().css("width",t.get(0).scrollWidth+"px")}else{if(i<50){o(h,200)}}}function t(){if(angular.isDefined(m.eweiTableAutoRows)&&angular.isDefined(m.rowHeight)){var t=parseInt(m.rowHeight);var i=0;var e=g(m.hasGroup)(f);if(m.groupInfo){var r=g(m.groupInfo)(f);if(angular.isArray(r)){r.forEach(function(e){if(e.value){i+=t}})}}f.$evalAsync(h);var n=f.params.total();var a=51;var o=p.find("thead").outerHeight(true);if(o<=0){o=50}var s=p.innerHeight();var l;if(s<=0){s=p.parents(".ewei-table").innerHeight()}l=s-o-i;if(n==0){l-=a}var c=Math.floor(l/t);if(c<2){c=2}if(e){c=20}var u=Math.ceil(a/t);if(n>0&&n>c&&n<=c+u){c+=u}var d=g(m.eweiTableAutoRows)(f);if(d){d(c)}}}var r;function n(){if(r){o.cancel(r)}r=o(t,200)}angular.element(a).on("resize",n);f.$on("ngTableAfterReloadData",n);f.$on("$destroy",function(){angular.element(a).off("resize",n)})}}}})();!function(a){a.module("eweiApp.common").directive("mouseIndex",e);e.$inject=["eweiPhoneService"];function e(n){return{restrict:"EA",link:function(e,t,i){var r=a.element(t);r[0].onclick=function(){var e=-1;void 0;if(t[0].selectionStart||t[0].selectionStart==0){e=t[0].selectionStart}else{void 0}void 0;n.setMouseIndex(e)};r[0].onchange=function(){var e=-1;void 0;if(t[0].selectionStart||t[0].selectionStart==0){e=t[0].selectionStart}else{void 0}void 0;n.setMouseIndex(e)}}}}}(angular);angular.module("com.ewei.angular.ui").directive("progressColor",[function(){return{restrict:"AE",templateUrl:"/source/scripts/directives/progress-color/progress-color.html",controller:"progressColorCtr",scope:{defaultColr:"="}}}]).controller("progressColorCtr",["$scope","$http","alertService",function(t,e,i){t.changeColor=function(e){t.defaultColr=e;t.listShow=false}}]);(function(e){"use strict";e.module("eweiApp.common").directive("socialShare",t);t.$inject=[];function t(){return{restrict:"EA",scope:{shareUrl:"=",shareSource:"=",shareTitle:"=",shareDescription:"=",shareSites:"=",shareDisabled:"=",shareImage:"=",socialShareConfig:"=",wechatQrcodeTitle:"=",wechatQrcodeHelper:"="},link:function(e,t,i){var r=e.socialShareConfig||{url:e.shareUrl,source:e.shareSource||"",title:e.shareTitle,description:e.shareDescription||"",image:e.shareImage||"",sites:e.shareSites||["weibo","qzone","wechat"],disabled:e.shareDisabled||["google","facebook","twitter"],wechatQrcodeTitle:e.wechatQrcodeTitle||"微信扫一扫：分享",wechatQrcodeHelper:e.wechatQrcodeHelper||"<p>微信里点“发现”，扫一下</p><p>二维码便可将本文分享至朋友圈。</p>"};t.share(r)}}}})(angular);(function(){"use strict";angular.module("com.ewei.angular.ui").controller("userRelatedGroupInputController",e).directive("userRelatedGroupInput",t);e.$inject=["$rootScope","$scope","$http","ConsoleConfig","alertService"];function e(e,i,r,t,n){var a=1,o=99,s=true,l;function c(){i.userGroups=[];a=1;s=true}i.loadUserGroups=function(e){if(e!=l){c();l=e}if(s){var t="user_group_list.json?_count="+o+"&_do_count=1&_page="+a+++'&_fields=id,name,shared&_asc=name&_filter={"$like":{"name":"$'+e+'$"}}';return r.get(t,{}).then(function(e){s=e.data.userGroups.length==o;if(!i.userGroups||i.userGroups.length==0){i.userGroups=e.data.userGroups}else{i.userGroups=i.userGroups.concat(e.data.userGroups)}return i.userGroups})}else{return i.userGroups}};i.loadMore=function(){i.$broadcast("typeahead-reload",i.userGroupName)};i.$on("reset-data-source",c);i.validateUserGroup=function(t){return t&&t.id&&!_.find(i.relatedUserGroups,function(e){return e.id===t.id})};i.addRelatedUserGroup=function(e){if(i.customer&&i.customer.id&&e&&e.id){r({url:"add_related_user_groups",method:"POST",data:{userId:i.customer.id,userGroupId:e.id}}).then(function(e){if(e&&e.data&&e.data.success){}else{n.add("添加关联客户组失败","danger","left");i.relatedUserGroups.pop()}},function(){n.add("添加关联客户组失败","danger","left");i.relatedUserGroups.pop()})}};i.removeRelatedUserGroup=function(t){if(i.customer&&i.customer.id&&t&&t.id){r({url:"delete_related_user_groups",method:"POST",data:{userId:i.customer.id,userGroupId:t.id}}).then(function(e){if(e&&e.data&&e.data.success){}else{n.add("删除关联客户组失败","danger","left");i.relatedUserGroups.push(t)}},function(){n.add("删除关联客户组失败","danger","left");i.relatedUserGroups.push(t)})}}}function t(){return{restrict:"EA",templateUrl:"/source/scripts/directives/user-related-group-input/user-related-group-input.html",controller:"userRelatedGroupInputController",scope:{relatedUserGroups:"=",assignable:"@",width:"@",customer:"=",onTagAdding:"&",onTagAdded:"&",onInvalidTag:"&",onTagRemoving:"&",onTagRemoved:"&",onTagClicked:"&"},compile:function e(a,t,i){return{post:function e(t,i,r,n){if(t.assignable=="false"){t.$on("removeDisabled",function(e,t){a.children().eq(0).removeAttr("disabled")});a.children().eq(0).attr("disabled","disabled")}}}},link:function(){void 0}}}})();(function(){"use strict";angular.module("eweiApp.common").directive("ticketSubject",e);e.$inject=["$sce","$parse","$popover","$timeout","apiRestfulService","$sanitize"];function e(e,l,t,c,u,d){return{restrict:"AE",templateUrl:"/source/scripts/directives/ticket-subject/ticket-subject.html",scope:{subject:"=",ticketid:"@",ticketStatusColors:"=",slaFormat:"@",slaStatus:"=",viewport:"@",deleted:"="},link:function(o,i,e){function t(){var e=o.ticketid;if(!e)return;if(o.popoverObj){o.popoverObj.popover("destroy")}o.popoverObj=i.popover({container:"body",html:true,content:function(){return r()},placement:"auto bottom",delay:{show:500,hide:50},trigger:"manual",viewport:o.viewport||".data-area",template:'<div class="popover ticket-preview-popover" role="tooltip"><h3 class="popover-title"></h3><div class="popover-content"></div></div>'})}function r(){var e=o.ticketStatusColors?o.ticketStatusColors[o.ticketid]:null;var t=o.slaFormat;var i=o.slaStatus;var r=f(e,o.ticketid,t,i);var n=o.subject;if(n&&n.length>128){n=n.substring(0,128)+"..."}var a="<h5><strong>主题：</strong>"+d(n)+"</h5>";a+=r.html||"";o.slaClass=r.slaClass;if(o.deleted){r.slaClass="deleted"}o.slaText=r.slaText;if(o.lastComment&&o.lastComment.content&&o.lastComment.content.length>0){a+="<hr>";a+="<p><strong>最新回复</strong></p>";a+="<p>"+d(o.lastComment.content||"")+"</p>";a+="<p>时间："+l("create_at | dateFilter_style1")(o.lastComment)+"</p>"}return a}r();function n(){if(o.popoverObj){var e=r();var t=i.data("bs.popover");if(t){t.options.content=e;t.tip().find(".popover-content").html(e)}}}i.on("show.bs.popover",function(){void 0;if(!o.lastComment||o.lastComment.ticketId!=o.ticketid){var e={url:"/api/v1/ticket_comment/"+o.ticketid+"/last.json",urlParam:"",dataParam:""};u.run(e).query(null,function(e){if(e.status==0){o.lastComment=e.result;o.lastComment.ticketId=o.ticketid;n();if(o.lastComment&&o.lastComment.content&&o.lastComment.content.length>30&&o.showing){o.popoverObj.popover("show")}}else if(e.error){o.lastComment=null;n()}})}});i.on("click",function(){if(o.popoverObj){o.popoverObj.popover("hide")}});var a,s;i.on("mouseenter",function(){o.showing=true;if(a){c.cancel(a)}a=c(function(){if(o.showing){o.popoverObj.popover("show")}},800);$(".popover").on("mouseleave",function(){o.showing=false;if(a){c.cancel(a)}o.popoverObj.popover("hide")})}).on("mouseleave",function(){o.showing=false;if(a){c.cancel(s)}s=c(function(){o.popoverObj.popover("hide")},50)});t();o.$watch("ticketStatusColors",function(e,t){if(e!==t&&o.popoverObj){n()}});o.$watch("slaStatus",function(e,t){if(e!==t&&o.popoverObj){n()}});o.$watch("ticketid",function(e,t){if(e!==t&&o.popoverObj){delete o.lastComment;n()}});o.$on("$destroy",function(){if(o.popoverObj){o.popoverObj.popover("destroy")}})}}}function f(e,t,i,r){var n={slaClass:"",slaText:""};if(!e)return n;var a=function(e){var t=e%60;var i=Math.floor(e/1440);var r=Math.floor(e%1440/60);var n="";t=t>0?t:0;r=r>0?r:0;i=i>0?i:0;if(i>0){n+=i+"天"}if(r>0){n+=r+"小时"}if(t>0){n+=t+"分钟"}if(n==""){n="0分钟"}return n};n.slaText=i=="short"?r.toUpperCase().substr(0,1):r.toUpperCase();n.slaClass=r;var o="";if(e.solveLevel||e.responseLevel){o+="<div>";if(e.responseLevel){var s="";switch(e.responseLevel){case 1:s="#66CC00";break;case 2:s="#FF9900";break;case 3:s="#FF0000";break}o+='<p class="text-nowrap" style="color:'+s+';">'+(e.responseMinutes>-1?"响应耗时：":"")+(e.responseMinutes>-1?a(e.responseMinutes):"")+(e.responseMinutes>-1?"，":"")+"SLA指标："+a(e.planResponseMinutes)+"</p>"}if(e.solveLevel){var l="";switch(e.solveLevel){case 1:l="#66CC00";break;case 2:l="#FF9900";break;case 3:l="#FF0000";break}o+='<p class="text-nowrap" style="color:'+l+';">'+(e.solveMinutes>-1?"处理耗时：":"")+(e.solveMinutes>-1?a(e.solveMinutes):"")+(e.solveMinutes>-1?"，":"")+"SLA指标："+a(e.planSolveMinutes)+"</p>"}o+="</div>"}else if(e.planResponseMinutes&&e.planSolveMinutes){o+='<div class="text-muted">暂无SLA信息</div>'}else{o+='<div class="text-muted">未匹配到SLA</div>'}n.html=o;return n}})();+function(){"use strict";angular.module("eweiApp.common").directive("userEmailInput",e);e.$inject=["$window","$parse","$q","$typeahead","$parseOptions"];function e(e,m,t,h,g){var v=h.defaults;return{restrict:"AE",require:"ngModel",link:function e(r,n,t,a){var o={scope:r};angular.forEach(["placement","container","delay","trigger","keyboard","html","animation","template","filter","limit","minLength","watchOptions","selectMode","autoSelect","comparator","id"],function(e){if(angular.isDefined(t[e]))o[e]=t[e]});n.attr("autocomplete","off");var s=m(t.onemails);var i=o.filter||v.filter;var l=o.limit||v.limit;var c=o.comparator||v.comparator;var u=t.userEmailInput;if(i)u+=" | "+i+":$viewValue";if(c)u+=":"+c;if(l)u+=" | limitTo:"+l;var d=g(u);var f=h(n,a,o);if(o.watchOptions){var p=d.$match[7].replace(/\|.+/,"").replace(/\(.*\)/g,"").trim();r.$watch(p,function(e,t){d.valuesFn(r,a).then(function(e){f.update(e);a.$render()})},true)}r.$watch(t.ngModel,function(i,e){r.$modelValue=i;a.$render();d.valuesFn(r,a).then(function(e){if(o.selectMode&&!e.length&&i.length>0){a.$setViewValue(a.$viewValue.substring(0,a.$viewValue.length-1));return}if(e.length>l)e=e.slice(0,l);var t=f.$isVisible();t&&f.update(e);if(e.length===1&&e[0].value===i)return;!t&&f.update(e);a.$render()})});a.$formatters.push(function(e){var t=d.displayValue(e);return t===undefined?"":t});a.$render=function(){if(angular.isObject(r.$modelValue)){var e=n.val().split(/[,;\s]+/g);e=e.slice(0,e.length-1);e.push(r.$modelValue.email);e=_.union(e);var t=e.join(",");n.val(t);s(r,{$emails:t});if(n[0].setSelectionRange){n[0].focus();n[0].setSelectionRange(t.length,t.length)}else if(n[0].createTextRange){var i=n[0].createTextRange();i.collapse(true);i.moveEnd("character",t.length);i.moveStart("character",t.length);i.select()}}else{n.val(r.$modelValue)}};n.on("change input",function(){s(r,{$emails:n.val()})});r.$on("$typeahead.select",function(){});r.$on("$destroy",function(){if(f)f.destroy();o=null;f=null})}}}}();angular.module("com.ewei.angular.ui").controller("eweiTemplatePaginationController",["$scope",function(i){var r=function(e,t,i){var r,n,a,o,s,l;r=11;l=[];s=Math.ceil(t/i);if(s==1){l.push({type:"prev",number:Math.max(1,e-1),active:e>1});l.push({type:"page",number:1,active:e!==1,current:e===1});l.push({type:"next",number:Math.min(s,e+1),active:e<s})}if(s>1){l.push({type:"prev",number:Math.max(1,e-1),active:e>1});l.push({type:"first",number:1,active:e>1,current:e===1});a=Math.round((r-5)/2);o=Math.max(2,e-a);n=Math.min(s-1,e+a*2-(e-o));o=Math.max(2,o-(a*2-(n-o)));var c=o;while(c<=n){if(c===o&&c!==2||c===n&&c!==s-1){l.push({type:"more",active:false})}else{l.push({type:"page",number:c,active:e!==c,current:e===c})}c++}l.push({type:"last",number:s,active:e!==s,current:e===s});l.push({type:"next",number:Math.min(s,e+1),active:e<s})}void 0;return l};if(i.params&&i.params.total>0){i.pages=r(i.params.page,i.params.total,i.params.count)}i.$watch("params",function(e,t){if(e!=t){if(i.params&&i.params.total>0){i.pages=r(i.params.page,i.params.total,i.params.count)}}})}]).directive("eweiTemplatePagination",[function(){return{restrict:"E",templateUrl:"/source/scripts/directives/ewei-template-pagination/ewei-template-pagination.html",controller:"eweiTemplatePaginationController",scope:{params:"=",changePage:"&"}}}]);+function(){"use strict";angular.module("eweiApp.common").directive("ticketCountdownInfo",e).controller("ticketCountdownController",t).filter("ticketCountdown",i).filter("slatime",r);e.$inject=[];function e(){return{restrict:"E",replace:true,templateUrl:"/source/scripts/directives/ticket-countdown/ticket-countdown.html",scope:{ticket:"="},link:function(e,t,i){},controller:"ticketCountdownController"}}t.$inject=["$scope","$http","$q","$interval","$filter","uibDateParser"];function t(s,t,i,r,l,c){s.hasSla=false;s.currentTimeLeft=0;s.slaColor="sla-green";s.timeOffset=0;var u=0;var n;var a=Date.now();var o;var d;function f(){if(!s.ticket||!s.ticket.id){return i.reject(null)}if(!s.hasSla){return i.resolve(null)}return t({url:"/api/v1/ticket/"+s.ticket.id+"/sla_detail.json",method:"GET"}).then(function(e){if(e.data.status==0){return e.data.result}return i.reject(e.data.result)})}function p(){if(!s.ticket){return i.resolve(null)}var e=null;if(s.ticket.requester&&s.ticket.requester.userGroup&&s.ticket.requester.userGroup.id){e=s.ticket.requester.userGroup.id}return t({url:"/api/v1/holiday.json",method:"GET",params:{userGroupId:e,yearMonth:l("date")(new Date,"yyyyMM")}}).then(function(e){if(e.data.status==0){return e.data.result}return i.reject(e.data.result)})}function m(){if(!s.ticket){return i.resolve(null)}var e=null;if(s.ticket.requester&&s.ticket.requester.userGroup&&s.ticket.requester.userGroup.id){e=s.ticket.requester.userGroup.id}return t({url:"/api/v1/working_time.json",method:"GET",params:{userGroupId:e}}).then(function(e){if(e.data.status==0){return e.data.result}return i.reject(e.data.result)})}function e(){return t({url:"/api/current.json?_r="+Date.now(),method:"GET"}).then(function(e){if(e.data){return parseInt(e.data)}return Date.now()})}function h(e){if(!e)return"";var t={};if(e.createdAt){t.createdAt=e.createdAt}if(e.ticketMetric&&e.ticketMetric.sla){t.slaId=e.ticketMetric.sla.id}if(e.requester){t.requesterId=e.requester.id}if(e.priority){t.priority=e.priority}t.status=e.status;return angular.toJson(t)}function g(){if(n){r.cancel(n)}if(!s.ticket.createdAt||!s.ticket.ticketMetric){return}var e=h(s.ticket);if(e==o){if(s.ticket.ticketMetric&&s.ticket.ticketMetric.sla&&d){s.ticket.ticketMetric.planSolvedAt=d;return}else if(d==s.ticket.ticketMetric.planSolvedAt){return}}o=e;u=0;s.hasSla=!!(s.ticket.ticketMetric&&s.ticket.ticketMetric.sla&&s.ticket.ticketMetric.sla.id);if(s.hasSla&&s.ticket.status=="solved"||s.ticket.status=="closed"){s.responseTime=(s.ticket.ticketMetric.responseMinutes||0)*1e3*60;s.solveTime=(s.ticket.ticketMetric.solveMinutes||0)*1e3*60;f().then(function(e){s.slaInfo=e;void 0;if(s.hasSla&&e.planSolvedAt){s.ticket.ticketMetric.planSolvedAt=e.planSolvedAt;d=e.planSolvedAt}if(!s.hasSla||!e){return}var t=1-s.ticket.ticketMetric.responseMinutes/e.planResponseMinutes;var i=1-s.ticket.ticketMetric.solveMinutes*1e3*60/(e.planSolvedMinutes*1e3*60);s.responseColor=C(t);s.solveColor=C(i)})}else if(s.hasSla&&s.ticket.status=="pending"){f().then(function(e){s.slaInfo=e;if(e.planSolvedAt){s.ticket.ticketMetric.planSolvedAt=e.planSolvedAt;d=e.planSolvedAt}})}else if(!s.hasSla&&s.ticket.status=="solved"||s.ticket.status=="closed"){s.responseTime=(s.ticket.ticketMetric.responseMinutes||0)*1e3*60;s.solveTime=(s.ticket.ticketMetric.solveMinutes||0)*1e3*60;s.responseColor=s.ticket.ticketMetric.respondQualified?"sla-green":"sla-red";s.solveColor=s.ticket.ticketMetric.solveQualified?"sla-green":"sla-red"}else{var t={slaInfo:f()};if(s.hasSla){t.holidayInfo=p();t.workingTimeInfo=m()}i.all(t).then(function(e){s.slaInfo=e.slaInfo;s.holidayInfo=e.holidayInfo;s.workingTimeInfo=e.workingTimeInfo;if(s.hasSla&&s.slaInfo.planSolvedAt){s.ticket.ticketMetric.planSolvedAt=s.slaInfo.planSolvedAt;d=s.slaInfo.planSolvedAt}y()},function(e){void 0})}}function v(){var e=Date.now();if(s.hasSla){e+=s.timeOffset}var t=e-a;s.currentTimeLeft-=t;s.slaColor=w();_(e,t);a=e;if(s.$$destroyed){r.cancel(n)}}function k(){if(n){r.cancel(n)}if(s.hasSla){a=a+s.timeOffset}v();n=r(v,5e3)}function y(){if(!s.ticket)return;if(s.ticket.ticketMetric&&s.ticket.ticketMetric.planSolvedAt){var e=c.parse(s.ticket.ticketMetric.planSolvedAt,"yyyy-MM-dd HH:mm:ss");if(e&&s.ticket.status!="pending"&&s.ticket.status!="closed"&&s.ticket.status!="solved"){s.currentTimeLeft=e-new Date-s.timeOffset;k()}}}function w(){var e,t,i,r,n=0;e=c.parse(s.ticket.createdAt,"yyyy-MM-dd HH:mm:ss");t=c.parse(s.ticket.ticketMetric.planSolvedAt,"yyyy-MM-dd HH:mm:ss");i=t-e;r=new Date-e;if(r<0){r=0}void 0;n=1-r/i;void 0;return C(n)}function C(e){if(s.currentTimeLeft<0){return"sla-red"}if(e<=0||e>1){return"sla-red"}if(e<=.3){return"sla-yellow"}return"sla-green"}function _(e,t){var i=new Date;var r=l("date")(i,"yyyy-MM-dd");var n=i.getDay();if(s.holidayInfo&&s.holidayInfo.holidays&&s.holidayInfo.holidays.indexOf("today")>-1){return}if(s.workingTimeInfo&&s.workingTimeInfo.detailsJson&&s.workingTimeInfo.detailsJson&&s.workingTimeInfo.detailsJson[n]){var a=s.workingTimeInfo.detailsJson[n];var o=[c.parse(r+" "+a[0],"yyyy-MM-dd HH:mm"),c.parse(r+" "+a[1],"yyyy-MM-dd HH:mm")];if(e<o[0]||e>o[1]){return}}u+=t}g();e().then(function(e){s.timeOffset=e-Date.now()});s.$on("$destroy",function(){if(n){r.cancel(n)}});s.$on("ticket-loaded",function(){g();F();j()});var b,S,T,$,E;function F(){if(b){b()}if(S){S()}if(T){T()}if($){$()}if(E){E()}}function j(){b=s.$watch("ticket.createdAt",function(e,t){if(e!==t&&e){b();g()}});S=s.$watch("ticket.ticketMetric.sla",function(e,t){if(e!==t){void 0;g()}},true);T=s.$watch("ticket.ticketMetric.planSolvedAt",function(e,t){if(e!==t&&!s.hasSla){y();void 0}});$=s.$watch("ticket.requester",function(e,t){if(e!==t&&e.id&&e.userGroup&&e.userGroup.id){g()}},true);E=s.$watch("ticket.status",function(e,t){if(e!==t){g();void 0}},true)}}function i(){return function(e,t){if(!e)return"";if(typeof e!=="number"){e=parseInt(number)}var i=Math.abs(e);t=t||{};angular.extend(t,{units:["hour","minute","second"],unitMeasures:{hour:36e5,minute:6e4,second:1e3,ms:1},unitLabels:{hour:"小时",minute:"分钟",second:"秒",ms:"毫秒"},unit:"minute"});var r,n;var a={};var o,s,l;for(r=0,n=t.units.length;r<n;r++){o=t.units[r];s=t.unitMeasures[o];if(r+1===n){l=i/s}else{l=Math.floor(i/s)}a[o]=l;i-=l*s}var c="";var u=false,d=t.units.indexOf(t.unit);for(r=0,n=t.units.length;r<n;r++){o=t.units[r];if(a.hasOwnProperty(o)&&a[o]>0){u=true}if(u&&r<=d){c+='<i class="num">'+a[o]+"</i>"+t.unitLabels[o]+" "}}if(!c&&i<6e4){if(e>0){return'少于<i class="num">1</i>分钟'}else{return'不到<i class="num">1</i>分钟'}}return c}}function r(){return function(e){if(e&&angular.isNumber(e)){if(e<60){return e+"分钟"}else{var t=Math.floor(e/60);var i=e%60;var r="";if(t>0){r+=t+"小时 "}if(i>0){r+=i+"分"}return r}}return e}}}();angular.module("com.ewei.angular.ui").controller("ticketPlanSolvedAtController",ticketPlanSolvedAtController).directive("ticketPlanSolvedAt",ticketPlanSolvedAtDirective);ticketPlanSolvedAtController.$inject=["$scope","$http","$filter","commonTools"];function ticketPlanSolvedAtController(i,e,t,r){i.datetimepickerConfig={datepickerOptions:{showWeeks:false,minDate:new Date},timepickerOptions:{showSeconds:true},buttonBar:{show:true,now:{show:true,text:"现在",cls:"btn-sm btn-default"},today:{show:true,text:"今天",cls:"btn-sm btn-default"},clear:{show:true,text:"清除",cls:"btn-sm btn-default"},date:{show:true,text:"日期",cls:"btn-sm btn-default"},time:{show:true,text:"时间",cls:"btn-sm btn-default"},close:{show:true,text:"关闭",cls:"btn-sm btn-default"},cancel:{show:false,text:"取消",cls:"btn-sm btn-default"}}};i.isOpen=false;i.open=function(e){e.preventDefault();e.stopPropagation();i.isOpen=!i.isOpen};i.selectedDate=r.parseDateTime(i.selectedPlanSolvedAt,"yyyy-MM-dd HH:mm:ss");i.updateValue=function(){var e=t("date")(i.selectedDate,"yyyy-MM-dd HH:mm:ss");if(e){i.selectedPlanSolvedAt=t("date")(i.selectedDate,"yyyy-MM-dd HH:mm:ss");i.$emit("selectedPlanSolvedAt",i.selectedPlanSolvedAt)}};i.$watch("selectedPlanSolvedAt",function(e,t){if(e!==0){i.selectedDate=r.parseDateTime(i.selectedPlanSolvedAt,"yyyy-MM-dd HH:mm:ss")}})}ticketPlanSolvedAtDirective.$inject=[];function ticketPlanSolvedAtDirective(){return{restrict:"EA",replace:true,templateUrl:"/source/scripts/directives/ticket-plan-solved-at/ticket-plan-solved-at.html",controller:"ticketPlanSolvedAtController",scope:{selectedPlanSolvedAt:"=",disabled:"="}}}+function(){"use strict";angular.module("com.ewei.angular.ui").controller("ticketDetailOperationButtonController",t).directive("ticketDetailOperationButton",e);e.$inject=[];function e(){return{restrict:"AE",replace:true,scope:{ticket:"=",webchat:"=",onMerge:"&",onDelete:"&",onDestroy:"&",onConvertToArticle:"&",onConvertToTicketTemplate:"&",onPrint:"&",onExportToWord:"&",onExportToPdf:"&",onRecoverIsolation:"&",onCancelDelete:"&"},templateUrl:"/source/scripts/directives/ticket-detail-operation-button/ticket-detail-operation-button.html",link:function(e,t,i){},controller:"ticketDetailOperationButtonController"}}t.$inject=["$scope","permissions"];function t(t,i){function r(){t.buttons=[{title:"移出隔离区",action:"onRecoverIsolation",enabled:t.ticket.status=="suspended"&&!t.ticket.deleted&&t.ticket.status!="deleted"},{title:"撤销删除",action:"onCancelDelete",enabled:t.ticket.deleted||t.ticket.status=="deleted"},{title:"删除工单",action:"onDelete",enabled:i.hasPermission("ticket_delete")&&!t.ticket.deleted&&t.ticket.status!="deleted"&&t.ticket.status!="suspended"},{title:"彻底删除工单",action:"onDestroy",enabled:i.hasPermission("ticket_delete")&&(t.ticket.deleted||t.ticket.status=="deleted")},{title:"合并到另一张工单",action:"onMerge",enabled:i.hasPermission("ticket_merge")&&t.ticket.status!="deleted"},{title:"生成文章到社区",action:"onConvertToArticle",enabled:t.ticket.status!="deleted"},{title:"打印",action:"onPrint",permission:"ticket_print",enabled:i.hasPermission("ticket_print")},{title:"导出Word",action:"onExportToWord",permission:"ticket_detail_export",enabled:i.hasPermission("ticket_detail_export")},{title:"导出PDF",action:"onExportToPdf",permission:"ticket_detail_export",enabled:i.hasPermission("ticket_detail_export")}];t.mainButton=t.buttons[2];for(var e=0;e<t.buttons.length;e++){if(t.buttons[e].enabled){t.mainButton=t.buttons[e];break}}t.validButtons=_.filter(t.buttons,function(e){return e.enabled&&e!=t.mainButton})}r();t.hasPermission=i.hasPermission;t.doAction=function(e){if(t.hasOwnProperty(e)&&typeof t[e]=="function"){t[e].call(t.ticket)}};t.$watch("ticket",function(e,t){if(e!==t){r()}},true)}}();(function(e){"use strict";e.module("com.ewei.angular.ui").directive("businessHours",i).controller("businessHoursController",t);t.$inject=["$scope"];function t(e){var a=this;t();function t(){var e=a.week.times;var t=e.length;var i;if(t<=2){a.currentStatus="merge";a.handleText="拆分时段"}else{a.currentStatus="split";a.handleText="合并时段"}for(var r=0;r<t;r++){if(e[r]==="24:00"){e[r]="23:59"}i=e[r].split(":");var n=new Date;n.setHours(i[0]);n.setMinutes(i[1]);a.week.times[r]=o(n)}}function o(e){var t=e.getFullYear();var i=(e.getMonth()+1).toString();var r=e.getDate().toString();var n=e.getHours().toString();var a=e.getMinutes().toString();var o=e.getSeconds().toString();if(i.length==1){i="0"+i}if(r.length==1){r="0"+r}if(n.length==1){n="0"+n}if(a.length==1){a="0"+a}if(o.length==1){o="0"+o}return t+"/"+i+"/"+r+" "+n+":"+a+":"+o}a.splitOrMergeTime=function(){var e=new Date;e.setHours("00");e.setMinutes("00");var t=new Date;t.setHours("23");t.setMinutes("59");if(a.currentStatus==="split"){a.week.times=[o(e),o(t)];a.currentStatus="merge";a.handleText="拆分时段"}else{a.week.times=[o(e),o(e),o(e),o(t)];a.currentStatus="split";a.handleText="合并时段"}};a.timeChange=function(e,t){a.week.times[e]=o(t)}}i.$inject=[];function i(){return{restrict:"EA",replace:true,scope:{week:"="},controller:t,controllerAs:"vm",bindToController:true,templateUrl:"/source/scripts/directives/business-hours/business-hours.html"}}})(angular);(function(l){"use strict";l.module("com.ewei.angular.ui").directive("businessHoursWeek",t).controller("businessHoursWeekController",t);e.$inject=["$scope","alertService","ConsoleConfig"];function e(i,n,e){var s=this;s.handleData=function(e){s.week=[];var t={};var i;for(var r in e){i={day:"",times:[]};if(r==="0"){i.day="星期日"}else if(r==="1"){i.day="星期一"}else if(r==="2"){i.day="星期二"}else if(r==="3"){i.day="星期三"}else if(r==="4"){i.day="星期四"}else if(r==="5"){i.day="星期五"}else{i.day="星期六"}i.times=e[r];if(r==="0"){t=i}else{s.week.push(i)}}s.week.push(t)};s.getHours=function(){var e=l.copy(s.week);var t;var i;var r={};var n=[];if(s.validateTime(e)){for(var a=0;a<e.length;a++){t=e[a].times;if(a<6){r[a+1]=[]}for(var o=0;o<t.length;o++){i=t[o].split(" ")[1].substring(0,5);if(a===6){n.push(i)}else{r[a+1].push(i)}}}r[0]=n;return r}else{return false}};s.validateTime=function(e){var t;var i;for(var r=0;r<e.length;r++){t=e[r].times;i=e[r].day;if(t.length>2){if(t[0]>t[1]){n.add(i+"的时间段设置错误","danger");return false}else if(t[0]>t[2]){n.add(i+"的时间段设置错误","danger");return false}else if(t[0]>t[3]){n.add(i+"的时间段设置错误","danger");return false}else if(t[1]>t[2]){n.add(i+"的时间段设置错误","danger");return false}else if(t[1]>t[3]){n.add(i+"的时间段设置错误","danger");return false}else if(t[2]>t[3]){n.add(i+"的时间段设置错误","danger");return false}else{}}else{if(t[0]>t[1]){n.add(i+"的时间段设置错误","danger");return false}}}return true};i.$watch("weekTimes",function(e,t){if(i.weekTimes){s.handleData(i.weekTimes)}})}t.$inject=[];function t(){return{restrict:"EA",replace:true,controller:e,controllerAs:"vm",bindToController:true,templateUrl:"/source/scripts/directives/business-hours-week/business-hours-week.html"}}})(angular);+function(){"use strict";angular.module("com.ewei.angular.ui").controller("eweiCalendarController",e).directive("eweiCalendar",t);e.$inject=["$scope"];function e(m){var h=false;var g=[],v,k;function e(e,t){var i=moment();i=moment([i.year(),i.month(),i.date()]);var r=moment([e,t]);var n=r.daysInMonth();var a=r.day();var o=0;var s,l=1;var c={1:{days:[]}};var u=m.saturdayAsHoliday||false;var d=m.sundayAsHoliday||false;var f=m.holidays.length!=0;k=angular.copy(m.holidays);if(a==0){a=7}for(s=1;s<a;s++){c[l].days.push({id:o++})}for(s=1;s<=n;s++){if(o%7==0){l++;c[l]={days:[]}}var r=moment([e,t,s]);var p={id:o++,date:r,day:s,year:e,month:t,name:r.format("DD"),fullName:r.format("YYYY-MM-DD"),before:r.isBefore(i),after:r.isAfter(i),weekDay:r.day(),isHoliday:false};if(k&&k.length>0&&k.indexOf(p.fullName)>-1){void 0;p.isHoliday=true}m.onDateChange({$yearMonth:y(),$date:p.fullName,$isHoliday:p.isHoliday});c[l].days.push(p)}for(var s=c[l].days.length;s<7;s++){c[l].days.push({id:o++})}h=true;g=angular.copy(m.holidays);v=y();return c}function t(e){var t=e.year();m.maxYear=m.maxYear||t+5;m.years=[];var i=m.maxYear-t;for(var r=0;r<=i;r++){m.years.push(t+r)}m.months=[];for(var r=0;r<12;r++){m.months.push({label:r+1+"月",value:r})}}function y(){var e="";if(m.currentMonth<9){e="0"}return m.currentYear+e+(m.currentMonth+1)}var i=moment();function r(){m.thisYear=i.year();m.thisMonth=i.month();m.thisDay=i.date();m.today=i.format("YYYY-MM-DD");m.currentYear=m.currentYear==undefined?i.year():m.currentYear;m.currentMonth=m.currentMonth==undefined?i.month():m.currentMonth;t(i);m.calculate();s()}m.calculate=function(){m.weeks=e(m.currentYear,m.currentMonth)};m.yearMonthChanged=function(){m.onYearMonthChange({$yearMonth:y()})};m.nextMonth=function(){m.currentMonth++;if(m.currentMonth>11){m.currentMonth=0;m.nextYear()}m.onYearMonthChange({$yearMonth:y()})};m.prevMonth=function(){m.currentMonth--;if(m.currentMonth<0){m.currentMonth=11;m.prevYear()}m.onYearMonthChange({$yearMonth:y()})};m.nextYear=function(){m.currentYear++;if(m.currentYear>m.maxYear){m.currentYear=m.maxYear}m.onYearMonthChange({$yearMonth:y()})};m.prevYear=function(){m.currentYear--;if(m.currentYear<m.thisYear){m.currentYear=m.thisYear}m.onYearMonthChange({$yearMonth:y()})};m.goToday=function(){m.currentMonth=i.month();m.currentYear=i.year();m.onYearMonthChange({$yearMonth:y()})};m.toggleHoliday=function(e){if(!e.date||e.before)return;e.isHoliday=!e.isHoliday;if(m.onDateChange){m.onDateChange({$yearMonth:y(),$date:e.fullName,$isHoliday:e.isHoliday})}};m.setSaturdayAsHoliday=function(){var e=[];for(var t in m.weeks){var i=m.weeks[t].days[5];if(i&&i.date&&!i.before){e.push(i)}}angular.forEach(e,function(e){e.isHoliday=m.saturdayAsHoliday;m.onDateChange({$yearMonth:y(),$date:e.fullName,$isHoliday:e.isHoliday})})};m.setSundayAsHoliday=function(){var e=[];for(var t in m.weeks){var i=m.weeks[t].days[6];if(i&&i.date&&!i.before){e.push(i)}}angular.forEach(e,function(e){e.isHoliday=m.sundayAsHoliday;m.onDateChange({$yearMonth:y(),$date:e.fullName,$isHoliday:e.isHoliday})})};r();var n,a,o;function s(){if(n){n()}if(a){a()}if(o){o()}n=m.$watch("holidays",function(e,t){if(e!=t&&(m.holidays.join("")!=g.join("")||y()!=v)){h=false;r()}});a=m.$watch("saturdayAsHoliday",function(e,t){if(e!=t&&k&&k.length==0){m.setSaturdayAsHoliday()}});o=m.$watch("sundayAsHoliday",function(e,t){if(e!=t&&k&&k.length==0){m.setSundayAsHoliday()}})}}function t(){return{restrict:"EA",scope:{currentYear:"=",currentMonth:"=",holidays:"=",maxYear:"@",saturdayAsHoliday:"=",sundayAsHoliday:"=",loading:"=",onDateChange:"&",onYearMonthChange:"&"},templateUrl:"/source/scripts/directives/ewei-calendar/ewei-calendar.html",controller:"eweiCalendarController",link:function(e,t,i){}}}}();(function(){"use strict";angular.module("com.ewei.angular.ui").directive("lineBarChart",t).controller("lineBarChartController",e);e.$inject=["$scope","$rootScope"];function e(e,t){void 0}t.$inject=["$rootScope","$window"];function t(l,n){return{restrict:"EA",replace:true,controller:e,scope:{option:"="},link:function(e,t,i){var s=echarts.getInstanceByDom(t[0])||echarts.init(t[0]);var r=function(e,t,i,r,n){var a=i.length<20?30:10;var o={color:["#ff9900",l.mainColor],title:{text:e,textStyle:{fontWeight:300,fontSize:12}},tooltip:{trigger:"axis",axisPointer:{type:"cross",crossStyle:{color:"#999"}}},dataZoom:[{backgroundColor:"rgba(0,0,0,0)",dataBackgroundColor:"#eae",end:100,realtime:true,show:true,start:0}],toolbox:{feature:{}},legend:{data:t,align:"right",right:0,textStyle:{fontSize:12}},xAxis:[{type:"category",data:i,axisPointer:{type:"line"},axisTick:{alignWithLabel:true,lineStyle:{color:"#eef2f9"}},axisLine:{show:false},splitLine:{lineStyle:{color:"#eef2f9"}}}],yAxis:[{minInterval:1,type:"value",name:r[0].name,axisLine:{show:r[0].axisLine?r[0].axisLine.show:false},splitLine:{lineStyle:{color:"#eef2f9"}},axisTick:{lineStyle:{color:"#eef2f9"}},nameLocation:"middle",nameTextStyle:{fontSize:12,fontFamily:"微软雅黑"},offset:-10,nameGap:50,axisLabel:{formatter:"{value}"}},{minInterval:1,type:"value",name:r[1].name,axisLine:{show:r[1].axisLine?r[1].axisLine.show:false},splitLine:{lineStyle:{color:"#eef2f9"}},axisTick:{lineStyle:{color:"#eef2f9"}},nameLocation:"middle",nameTextStyle:{fontSize:12,fontFamily:"微软雅黑"},offset:-10,nameGap:55,axisLabel:{formatter:"{value} M"}}],series:[{name:n[0].name,type:n[0].type,yAxisIndex:1,data:n[0].data,symbol:"circle",symbolSize:10,barWidth:a},{name:n[1].name,type:n[1].type,data:n[1].data,barWidth:a}]};s.setOption(o)};e.$watch("option",function(e){if(e){r(e.titleText,e.legendData,e.xAxisData,e.yAxis,e.series)}});angular.element(n).on("resize",s.resize);e.$on("$destroy",function(){angular.element(n).off("resize",s.resize);if(s){s.dispose()}})}}}})();(function(){"use strict";angular.module("com.ewei.angular.ui").directive("pieChart",e).controller("pieChartController",t);t.$inject=["$scope","$rootScope"];function t(e,t){}e.$inject=["$rootScope","$window"];function e(e,a){return{restrict:"EA",replace:true,controller:t,scope:{option:"="},link:function(e,t,i){var n=echarts.getInstanceByDom(t[0])||echarts.init(t[0]);var r=function(e,t,i){var r={title:{text:e,x:"center",y:"bottom",textStyle:{fontWeight:300,fontSize:12}},tooltip:{trigger:"item",formatter:"{a} <br/>{b} : {c} ({d}%)"},legend:{top:"10",data:t,type:"scroll"},series:[{name:i.name,type:"pie",radius:"55%",center:["50%","60%"],data:i.data,itemStyle:{emphasis:{shadowBlur:10,shadowOffsetX:0,shadowColor:"rgba(0, 0, 0, 0.51)"}},label:{normal:{show:true,position:"outside",formatter:"{b}: {d}%"}}}]};n.setOption(r)};e.$watch("option",function(e){if(e){r(e.titleText,e.legendData,e.series)}},true);angular.element(a).on("resize",n.resize);e.$on("$destroy",function(){angular.element(a).off("resize",n.resize);if(n){n.dispose()}})}}}})();(function(){"use strict";angular.module("com.ewei.angular.ui").directive("linesChart",e).controller("linesChartController",t);t.$inject=["$scope","$rootScope"];function t(e,t){}e.$inject=["$rootScope","$window"];function e(e,n){return{restrict:"EA",replace:true,controller:t,scope:{option:"="},link:function(e,t,i){var c=echarts.getInstanceByDom(t[0])||echarts.init(t[0]);var r=function(e,t,i,r,n,a,o,s){var l={title:{text:t,textStyle:{fontWeight:300,fontSize:12}},tooltip:s||{trigger:"axis",axisPointer:{type:"cross",crossStyle:{color:"#999"}},formatter:o},dataZoom:[{backgroundColor:"rgba(0,0,0,0)",dataBackgroundColor:"#eae",end:100,realtime:true,show:true,start:0}],toolbox:{feature:{}},legend:{data:i,align:"right",right:0,textStyle:{fontSize:12}},grid:{left:"50",right:"50",bottom:"50",containLabel:true},xAxis:[{type:"category",data:r,axisPointer:{type:"line"},axisTick:{alignWithLabel:true,lineStyle:{color:"#eef2f9"}},axisLine:{show:false},splitLine:{lineStyle:{color:"#eef2f9"}}}],yAxis:n,series:a};if(e&&e.length){l.color=e}c.setOption(l)};e.$watch("option",function(e){if(e){e.yAxis.minInterval=1;r(e.lineColor,e.titleText,e.legendData,e.xAxisData,e.yAxis,e.series,e.formatter,e.tooltip)}},true);angular.element(n).on("resize",c.resize);e.$on("$destroy",function(){angular.element(n).off("resize",c.resize);if(c){c.dispose()}})}}}})();+function(){"use strict";angular.module("com.ewei.angular.ui").controller("chartTableController",["$scope","ngTableParams","apiTicketQuantityService",function(i,e,t){i.argument={_fields:"",_filter:{},_asc:"",_desc:"",_count:i.count,_page:1};var r=function(){i.tableParams=i.tableParams||new e({page:i.argument._page,count:i.argument._count,sorting:JSON.parse('{"name":"desc"}')},{counts:[],total:0,groupBy:function(e){return null},getData:function(e,t){i.argument._page=t.page();if(i.data){t.total(i.data.length);e.resolve(i.data.slice((i.argument._page-1)*i.argument._count,i.argument._page*i.argument._count))}}})};i.isSortBy=function(e,t){return e.order===t};i.sorting=function(n){if(n.sortType==="number"&&n.field&&n.field.indexOf(".")===-1){i.data=i.data.sort(function(e,t){var i,r;if(/^[+\-\d.]+$/g.test(e[n.field])||/^[+\-\d.]+$/g.test(t[n.field])){i=Number(e[n.field]===undefined||e[n.field]==="-"||e[n.field]===""?null:e[n.field]);r=Number(t[n.field]===undefined||t[n.field]==="-"||t[n.field]===""?null:t[n.field]);return r-i}else if(typeof e[n.field]==="string"||typeof t[n.field]==="string"){i=e[n.field]==null?"":e[n.field];r=t[n.field]==null?"":t[n.field];return r.localeCompare(i,undefined,{numeric:true})}else if(typeof e[n.field]==="number"||typeof t[n.field]==="number"){i=e[n.field]==null?0:e[n.field];r=t[n.field]==null?0:t[n.field];return r-i}return 0})}else{i.data=_.sortBy(i.data,n.field).reverse()}if(n.order&&n.order==="desc"){i.data=i.data.reverse();n.order="asc"}else{n.order="desc"}angular.forEach(i.columns,function(e){if(e.field!==n.field){e.order=""}});i.tableParams.reload()};i.$watch("data",function(e,t){if(e!==t){i.tableParams.page(1);i.tableParams.reload()}},true);i.$watch("columns",function(e,t){if(e!==t){i.tableParams.reload()}},true);r()}]).directive("chartTable",function(){return{restrict:"EA",transclude:true,replace:true,scope:{columns:"=",data:"=",totalData:"=",count:"@"},templateUrl:"source/statistics/directive/chart-table/chart-table.html",controller:"chartTableController"}})}();+function(){"use strict";angular.module("com.ewei.angular.ui").controller("chartMultiHeaderTableController",["$scope","ngTableParams","apiTicketQuantityService",function(i,e,t){i.argument={_fields:"",_filter:{},_asc:"",_desc:"",_count:i.count,_page:1};var r=function(){i.tableParams=i.tableParams||new e({page:i.argument._page,count:i.argument._count,sorting:JSON.parse('{"name":"desc"}')},{counts:[],total:0,groupBy:function(e){return null},getData:function(e,t){i.argument._page=t.page();if(i.data){t.total(i.data.length);e.resolve(i.data.slice((i.argument._page-1)*i.argument._count,i.argument._page*i.argument._count))}}})};i.isSortBy=function(e,t){return e.order===t};i.sorting=function(n){if(n.sortType==="number"&&n.field&&n.field.indexOf(".")===-1){i.data=i.data.sort(function(e,t){var i,r;if(/^[+\-\d.]+$/g.test(e[n.field])||/^[+\-\d.]+$/g.test(t[n.field])){i=Number(e[n.field]===undefined||e[n.field]==="-"||e[n.field]===""?null:e[n.field]);r=Number(t[n.field]===undefined||t[n.field]==="-"||t[n.field]===""?null:t[n.field]);return r-i}else if(typeof e[n.field]==="string"||typeof t[n.field]==="string"){i=e[n.field]==null?"":e[n.field];r=t[n.field]==null?"":t[n.field];return r.localeCompare(i,undefined,{numeric:true})}else if(typeof e[n.field]==="number"||typeof t[n.field]==="number"){i=e[n.field]==null?0:e[n.field];r=t[n.field]==null?0:t[n.field];return r-i}return 0})}else{i.data=_.sortBy(i.data,n.field).reverse()}if(n.order&&n.order==="desc"){i.data=i.data.reverse();n.order="asc"}else{n.order="desc"}angular.forEach(i.columns,function(e){if(e.field!==n.field){e.order=""}});i.tableParams.reload()};i.$watch("data",function(e,t){if(e!==t){i.tableParams.page(1);i.tableParams.reload()}},true);i.$watch("columns",function(e,t){if(e!==t){i.tableParams.reload()}},true);r()}]).directive("chartMultiHeaderTable",function(){return{restrict:"EA",transclude:true,replace:true,scope:{columns:"=",subColumns:"=",mergeColumns:"=",data:"=",totalData:"=",count:"@"},templateUrl:"source/statistics/directive/chart-multi-header-table/chart-multi-header-table.html",controller:"chartMultiHeaderTableController"}})}();+function(){"use strict";angular.module("com.ewei.angular.ui").controller("CustomerOperationButtonController",t).directive("customerOperationButton",e);e.$inject=[];function e(){return{restrict:"AE",replace:true,scope:{customer:"=",onAddTicket:"&",onDelete:"&",onMerge:"&",onResetPassword:"&",onSwitchBlacklist:"&"},templateUrl:"/source/scripts/directives/customer-operation-button/customer-operation-button.html",link:function(e,t,i){},controller:"CustomerOperationButtonController"}}t.$inject=["$scope","permissions"];function t(t,i){function r(){t.buttons=[{title:"新建工单",action:"onAddTicket",enabled:i.hasPermission("ticket_create")},{title:"合并到另一个客户",action:"onMerge",enabled:i.hasPermission("customer_merge")},{title:"设置密码",action:"onResetPassword",enabled:i.hasPermission("customer_update")},{title:!t.customer||t.customer&&t.customer.valid?"加入黑名单":"移出黑名单",action:"onSwitchBlacklist",enabled:i.hasPermission("customer_blacklist_manage")},{title:"删除",action:"onDelete",enabled:i.hasPermission("customer_delete")}];t.mainButton=t.buttons[2];for(var e=0;e<t.buttons.length;e++){if(t.buttons[e].enabled){t.mainButton=t.buttons[e];break}}t.validButtons=_.filter(t.buttons,function(e){return e.enabled&&e!=t.mainButton})}r();t.hasPermission=i.hasPermission;t.doAction=function(e){if(t.hasOwnProperty(e)&&typeof t[e]=="function"){t[e].call(t.ticket)}};t.$watch("customer",function(e,t){if(e!==t){r()}},true)}}();+function(){"use strict";angular.module("com.ewei.angular.ui").controller("CustomerGroupOperationButtonController",t).directive("customerGroupOperationButton",e);e.$inject=[];function e(){return{restrict:"AE",replace:true,scope:{customerGroup:"=",onCreate:"&",onDelete:"&"},templateUrl:"/source/scripts/directives/customer-group-operation-button/customer-group-operation-button.html",link:function(e,t,i){},controller:"CustomerGroupOperationButtonController"}}t.$inject=["$scope","permissions"];function t(t,i){function r(){t.buttons=[{title:"添加客户",action:"onCreate",enabled:i.hasPermission("customer_create")},{title:"删除",action:"onDelete",enabled:i.hasPermission("customer_group_delete")}];t.mainButton=t.buttons[2];for(var e=0;e<t.buttons.length;e++){if(t.buttons[e].enabled){t.mainButton=t.buttons[e];break}}t.validButtons=_.filter(t.buttons,function(e){return e.enabled&&e!=t.mainButton})}r();t.hasPermission=i.hasPermission;t.doAction=function(e){if(t.hasOwnProperty(e)&&typeof t[e]=="function"){t[e].call(t.ticket)}};t.$watch("customerGroup",function(e,t){if(e!==t){r()}},true)}}();(function(){var e;angular.module("com.ewei.angular.ui").directive("ngDateRange",[function(){var e=function(i,e,t){i.format=i.format||"YYYY-MM-DD";var r=moment().endOf("day");var n=moment().endOf("month");var a=moment().endOf("quarter");var o=moment().endOf("year");var s=i.max?moment(i.max):null;if(s&&n.isAfter(s)){n=s.clone()}if(s&&a.isAfter(s)){a=s.clone()}if(s&&o.isAfter(s)){o=s.clone()}var l={opens:"left",startDate:i.dateRange.startDate,endDate:i.dateRange.endDate,minDate:i.min,maxDate:i.max,dateLimit:{days:i.limit},showDropdowns:false,showWeekNumbers:false,timePicker:false,timePickerIncrement:1,timePicker12Hour:true,alwaysShowCalendars:false,ranges:{"今天":[moment().startOf("day"),moment().endOf("day")],"昨天":[moment().subtract(1,"days").startOf("day"),moment().subtract(1,"days").endOf("day")],"最近7天":[moment().subtract(6,"days"),moment()],"最近30天":[moment().subtract(29,"days"),moment()],"本月":[moment().startOf("month"),n],"本季度":[moment().startOf("quarter"),a],"本年":[moment().startOf("year"),o]},buttonClasses:["btn"],applyClass:"btn-confirm",cancelClass:"btn-cancel",separator:" - ",locale:{applyLabel:"确定",cancelLabel:"取消",fromLabel:"从",toLabel:"到",customRangeLabel:"自定义",daysOfWeek:["日","一","二","三","四","五","六"],monthNames:["一月","二月","三月","四月","五月","六月","七月","八月","九月","十月","十一月","十二月"],firstDay:1,format:i.format}};var c=function(e,t){i.dateRange.startDate=e;i.dateRange.endDate=t};$("div",e).on("click.daterangepicker",function(e){if(i.disabled){e.stopPropagation()}});$("div",e).daterangepicker(l,c);var u=$("div",e).data("daterangepicker");i.$watch("dateRange.startDate",function(e){u.setStartDate(e)});i.$watch("dateRange.endDate",function(e){u.setEndDate(e)})};return{restrict:"E",templateUrl:"source/scripts/directives/daterange-picker/daterange-picker.html",scope:{min:"=",max:"=",limit:"=",dateRange:"=",format:"@",disabled:"="},link:e}}])}).call(this);angular.module("com.ewei.angular.ui").directive("rate",[function(){return{restrict:"AE",templateUrl:"/source/scripts/directives/rate/rate.html",controller:"rateController",scope:{value:"="}}}]).controller("rateController",["$scope","$http","alertService",function(t,e,i){t.scores=[1,2,3,4,5];t.setValue=function(e){t.value=e}}]);(function(e){"use strict";e.module("eweiApp.common").directive("copyImgUploadNew",t).controller("copyImgUploadNewController",i);t.$inject=["commonProtocol","alertService","$http","$modal_"];function t(f,c,p,m){return{restrict:"EA",scope:false,link:function(a,e,t){var i=null;var r=e[0].id?e[0].id:Date.now();e[0].id=r;var n=WebUploader.create({swf:"source/lib/ueditor/third-party/webuploader/Uploader.swf",server:f.fn(),paste:"#"+r,resize:false,disableGlobalDnd:true,duplicate:true,threads:1});var u=function(e){return e.replace(/</g,"&lt;").replace(/>/g,"&gt;")};var d=false;e.on("paste",function(e){d=true;if(f.isFireFox()){e=e.originalEvent||e;var t=e.clipboardData;var i=t.getData("text");if(i&&i.length>0){e.preventDefault();e.stopPropagation();var r=window.getSelection(),n=r.getRangeAt(0),a=n.createContextualFragment(u(i));n.insertNode(a);r.collapseToEnd();document.execCommand("Delete","false",null);return}}if(f.isIE()){var o=window.clipboardData.getData("Text");if(!o||o.length==0){e.stopPropagation?e.stopPropagation():e.cancelBubble=true;e.preventDefault?e.preventDefault():e.returnValue=false;return}}if(window.navigator.userAgent.indexOf("Chrome")&&window.chrome){var s,l;e=e.originalEvent||e;s=e.clipboardData?e.clipboardData.items:[];if(e.clipboardData==undefined){e.clipboardData={items:[]}}var c=false;for(l=0;l<s.length;l++){if(s[l].type=="text/html"||s[l].type=="text/plain"){c=true}}if(c){e.preventDefault();e.stopPropagation();for(l=0;l<s.length;l++){if(s[l].type=="text/plain"){s[l].getAsString(function(e){document.execCommand("insertHTML","false",e)})}}}}});var o=function(){if(window.fetch&&typeof fetch=="function"){var e=$("#"+r).find('img[src^="data:"]');if(e.length>0){e.each(function(e,t){var i=t.src;$(t).remove();fetch(i).then(function(e){return e.blob()}).then(function(e){d=true;n.addFile(e)})})}}};var s=null;var l=function(){s.$promise.then(s.hide);s=null};e.on("input",o);n.on("uploadStart",function(){if(i){n.option("formData",{key:eweiCommon.uuid(32,16).toLowerCase(),token:i})}else{$.ajax({url:"/qiniu_token.json",type:"GET",async:false,success:function(e){i=e;n.option("formData",{key:eweiCommon.uuid(32,16).toLowerCase(),token:i})}})}});n.on("fileQueued",function(e){if(t.fileType){if(t.fileType=="image"){if(e.type.indexOf("image")!=-1){n.upload()}else{c.add("文件格式不正确","danger")}}}else{a.isImgUpload=false;if(s){n.removeFile(e);return false}s=m({scope:a,template:"source/scripts/directives/copy-img-upload/copy-img-upload-modal.html",contentTemplate:"source/scripts/directives/copy-img-upload/copy-img-upload.html",html:true,show:true,backdrop:"static",title:"确定要发送该图片吗？",placement:"center"});n.makeThumb(e,function(e,t){if(e){return}a.uploadImgUrl=t},550,300);a.sendImg=function(){n.upload();l();a.isImgUpload=true;e.uploading=true;e.progress=0;e.size=e.size;if(d&&e.ext=="png"){e.name="截图_"+Date.now()+"."+e.ext;d=false}else{e.name=e.name}a.cacheFiles.push(e)};a.cancleSendImg=function(){n.removeFile(e);a.isImgUpload=false;l()}}});n.on("uploadProgress",function(e,t){var i=parseInt(t*100);e.progress=i});n.on("uploadSuccess",function(n,e){p({url:"save_attachment.json",method:"POST",params:{fileName:n.name,contentType:n.type,contentUrl:e.key,size:n.size}}).success(function(e,t,i,r){if(e.json){a.isImgUpload=false;n.progress=100;a.cacheFiles.splice(a.cacheFiles.indexOf(n),1);a.sendMessage("file","",e.json)}else{c.add("保存附件数据为空失败！","danger")}})});n.on("error",function(e){a.isImgUpload=false;if(e=="F_EXCEED_SIZE"){c.add("上传文件不能大于50M。","danger")}else{c.add("上传失败！","danger")}});a.$on("stopUploadingFile",function(e,t){n.removeFile(t)})}}}i.$inject=["$scope","$rootScope","$http","$log","ConsoleConfig"];function i(e,t,i,r,n){}})(angular);!function(e,t){"use strict";e.module("com.ewei.angular.ui").controller("selectConditionCtrl",i).directive("selectCondition",r);i.$inject=["$scope","$http","ticketListFilterOptions"];function i(n,e,t){n.firstFilterOptionChange=function(e,t,i){var r;if(i==="and"){r=n.andConditions}else{r=n.orConditions}a(r[e]);r[e].thirdValue="";o(r[e])};var a=function(e){var t=e.firstValue.value;if(t==="user.tags"){e.secondOptions=[{option:"包含以下字符串",value:"$include"},{option:"不含以下字符串",value:"$not_include"}]}else{e.secondOptions=[{option:"是",value:"$eq"},{option:"不是",value:"$ne"}]}};var o=function(e){var t=e.firstValue.value;e.valueType=t};n.toAddFilterOption=function(e){var t;if(e==="and"){t=n.andConditions}else{t=n.orConditions}var i=n.conditionOptions;t.push({firstValue:{},secondValue:{},thirdValue:"",firstOptions:i,secondOptions:"",thirdOptions:"",valueType:""})};n.toDeleteFilterOption=function(e,t){var i;if(e==="and"){i=n.andConditions}else{i=n.orConditions}i.splice(t,1)};var r=function(e){e.forEach(function(t){t.firstValue=t.firstOptions.find(function(e){if(e.value===t.firstValue){return e}});o(t);a(t);t.secondValue=t.secondOptions.find(function(e){if(e.value===t.secondValue){return e}});t.thirdOptions="";try{t.thirdValue=JSON.parse(t.thirdValue)}catch(e){}})};var i=function(){var t=[];var i=[];n.andConditions.forEach(function(e){t.push({firstOptions:n.conditionOptions,firstValue:e.attribute,secondValue:e.compare,thirdValue:e.value})});n.orConditions.forEach(function(e){i.push({firstOptions:n.conditionOptions,firstValue:e.attribute,secondValue:e.compare,thirdValue:e.value})});n.andConditions=t;n.orConditions=i;r(n.andConditions);r(n.orConditions)};i()}r.$inject=[];function r(){return{restrict:"EA",templateUrl:"/source/scripts/directives/select-condition/select-condition.html",controller:"selectConditionCtrl",scope:{conditionOptions:"=",andConditions:"=",orConditions:"=",isDefault:"="}}}}(angular,org.ewei);!function(a){angular.module("com.ewei.angular.ui").controller("areaSelectController",["$scope","serviceDeskService","engineerService","$http",function(r,e,t,i){r.loadArea=function(){a.sdk.OpenAssignRuleApi().getAddressInfo().then(function(e){var t=[];for(var i in e){t.push({name:i,code:e[i]})}r.provice=t;r.showProvice=true})};r.back=function(e){r.showProvice=true;r.showCity=false;e.stopPropagation()};r.clear=function(){r.selectArea=null;r.catSelected=false;if(r.provice==null){r.loadArea()}};r.selectAreaFunc=function(e,t,i){if(t==="provice"){r.tempProvice=e;a.sdk.OpenAssignRuleApi().getAddressInfo({provinceCode:r.tempProvice.code}).then(function(e){var t=[];for(var i in e){t.push({name:i,code:e[i]})}r.city=t;r.showProvice=false;r.showCity=true});i.stopPropagation()}else if(t==="city"){r.selectArea={provice:r.tempProvice,city:e};r.catSelected=true}else{r.selectArea={provice:r.tempProvice};r.catSelected=true}};r.click=function(){r.showProvice=true;r.showCity=false};r.$watch("selectArea",function(){r.catSelected=false});var n=function(){r.loadArea()};n()}]).directive("areaSelect",function(){return{restrict:"E",replace:true,scope:{singleLine:"=",selectArea:"="},controller:"areaSelectController",templateUrl:"/source/scripts/directives/area-select/area-select.html"}})}(org.ewei);!function(e,t){"use strict";e.module("com.ewei.angular.ui").controller("questionArticleLinkCtrl",i).directive("questionArticleLink",r);i.$inject=["$scope","$http","ticketListFilterOptions"];function i(i){i.goDetail=function(){if(i.article.topic&&i.article.topic.type){var e=i.article.topic.type;var t=window.location.origin+"/new/#";if(e==="questions"||e==="deletes"||e==="default"){t+="/forum/detail/"+i.article.topic.id+"/"+i.article.id}else{t+="/article/detail/"+i.article.id+"?topicId="+i.article.topic.id}window.open(t)}}}r.$inject=[];function r(){return{restrict:"EA",templateUrl:"/source/scripts/directives/question-article-link/question-article-link.html",controller:"questionArticleLinkCtrl",scope:{article:"="}}}}(angular,org.ewei);(function(){"use strict";angular.module("com.ewei.angular.ui").directive("customerSelect",e).controller("customerSelectController",t);e.$inject=[];function e(){return{restrict:"EA",replace:true,templateUrl:"/source/scripts/directives/customer-select/customer-select.html",controller:"customerSelectController",scope:{customers:"=",maxCount:"="}}}t.$inject=["$scope","alertService"];function t(r,i){r.selectedUser=null;r.ticketCount=0;if(!r.maxCount){r.maxCount=1e3}r.removeCustomer=function(e){if(r.customers.length>e){var t=r.customers.splice(e,1);s();o()}};r.clear=function(){r.customers.splice(0,r.customers.length);a=[];r.ticketCount=0};function n(e){var t=r.ticketCount+(e===undefined?0:e);if(t>r.maxCount){i.add("每次批量建单最多允许创建"+r.maxCount+"张工单，无法添加更多客户了。","danger");return false}return true}var a=[];function o(){r.ticketCount=a.length}function s(){a=[];angular.forEach(r.customers,function(e){if(e.type){if(a.indexOf(e.id)===-1){a.push(e.id)}}else if(!e.type&&e.userGroup&&e.userGroup.users){angular.forEach(e.userGroup.users,function(e){if(a.indexOf(e.id)===-1){a.push(e.id)}})}})}r.$on("on-selected-customer",function(e,t,i){if(!n(1))return;if(!_.find(r.customers,function(e){return e.id===t.id})){r.customers.unshift(t);if(a.indexOf(t.id)===-1){a.push(t.id)}o()}});r.$on("on-selected-customer-group",function(e,t,i){if(!n(t.countUser))return;if(!_.find(r.customers,function(e){return!e.id&&e.userGroup.id===t.id})){r.customers.unshift({userGroup:t});t.users=[];org.ewei.sdk.OpenUserApi().listCustomerByUserGroup({userGroupId:t.id,page:{pageNumber:1,pageSize:1e3}}).then(function(e){t.users=e.list;t.users.forEach(function(e){if(a.indexOf(e.id)===-1){a.push(e.id)}});o()})}o()});r.$watchCollection("customers",function(e,t){if(e!==t){r.customers=e||[];o()}});if(r.customers&&r.customers.length>0){s();o()}}})();(function(){"use strict";angular.module("com.ewei.angular.ui").directive("handleSelect",e).controller("handleSelectController",t);e.$inject=[];function e(){return{restrict:"EA",replace:true,templateUrl:"/source/scripts/directives/handle-select/handle-select.html",controller:"handleSelectController",scope:{selectHandles:"="}}}t.$inject=["$scope","$stateParams","apiServiceDesksService"];function t(s,e,t){s.id=e.id;s.selectHandles=[];s.serviceDesks=[];s.checkedHandles=function(){s.selectHandles=[];angular.forEach(s.serviceDesks,function(t){if(t.checked){s.selectHandles.push({serviceDesk:{name:t.name,id:t.id},type:"serviceDesk"})}else{angular.forEach(t.engineers,function(e){if(e.checked){s.selectHandles.push({engineer:{id:e.id,name:e.user.name},serviceDesk:{id:t.id,name:t.name},type:"engineer"})}})}})};s.newServiceDesks=[];s.allService=[];var i=function(){s.serviceDesks=t.getCacheData(s.id);if(s.serviceDesks.length==0){t.run("",{},"",function(e){s.serviceDesks=angular.copy(e);s.allService=angular.copy(e);angular.forEach(s.serviceDesks,function(e){e.checkedEngineers=0})})}else{s.checkedHandles()}};i();s.resultType=false;s.searchFlag=false;s.serviceDeskSearch=function(e){s.newServiceDesks=[];if(s.serviceInput){s.searchFlag=true;angular.forEach(e,function(i){for(var e in i){if(e==="name"&&typeof i[e]==="string"){if(i[e].indexOf(s.serviceInput)>-1){s.newServiceDesks.push(i)}}else{angular.forEach(i.engineers,function(e){for(var t in e){if((t==="username"||t==="email")&&typeof e[t]==="string"){if(e[t].indexOf(s.serviceInput)>-1){s.newServiceDesks.push(i)}}}})}}});var t=[];for(var i=0,r=s.newServiceDesks.length;i<r;i++){var n=true;for(var a=0;a<t.length;a++){if(s.newServiceDesks[i].id==t[a].id){n=false}}if(n){t.push(s.newServiceDesks[i])}}l(t);var o=[];angular.forEach(t,function(i){angular.forEach(i.engineers,function(e){for(var t in e){if((t==="username"||t==="email")&&typeof e[t]==="string"){if(e[t].indexOf(s.serviceInput)>-1){o=[];o.push(e);if(i.checked){i.showEngineers=false}else{i.showEngineers=true}}}}i.engineers=o})});s.serviceDesks=t;if(s.serviceDesks.length>0){s.resultType=true}}else{s.serviceDesks=angular.copy(s.allService);s.removeSearchContent()}};s.watchInput=function(){if(s.serviceInput===""){s.serviceDeskSearch(angular.copy(s.allService))}};var l=function(e){for(var t=0;t<e.length;t++){for(var i=0;i<s.selectHandles.length;i++){if(s.selectHandles[i].type=="serviceDesk"&&s.selectHandles[i].serviceDesk.id===e[t].id){e[t].checked=true;e[t].showEngineers=false}for(var r=0;r<e[t].engineers.length;r++){if(s.selectHandles[i].type=="engineer"&&s.selectHandles[i].serviceDesk.id===e[t].id&&s.selectHandles[i].engineer.id===e[t].engineers[r].id&&e[t].engineers.length>0){e[t].engineers[r].checked=true;e[t].showEngineers=true}}}}};s.removeSearchContent=function(){l(s.allService);s.serviceInput="";s.serviceDesks=angular.copy(s.allService);s.searchFlag=false};s.enterSearch=function(e){var t=window.event||e;if(t.keyCode==13){s.serviceDeskSearch(angular.copy(s.allService))}};s.showEngineers=function(e){if(e.checked){e.showEngineers=false}else{e.showEngineers=!e.showEngineers}};s.checkedEngineer=function(i,r){if(i.checked){r.checkedEngineers++;s.selectHandles.push({engineer:{id:i.id,name:i.user.name},serviceDesk:{id:r.id,name:r.name},type:"engineer"})}else{r.checkedEngineers--;angular.forEach(s.selectHandles,function(e,t){if(e.serviceDesk.id===r.id&&e.engineer.id===i.id){s.selectHandles.splice(t,1)}})}};s.checkedServiceDesk=function(e,i){e.stopPropagation();i.showEngineers=false;angular.forEach(i.engineers,function(e){e.checked=false});i.checkedEngineers=0;if(i.checked){s.selectHandles.push({serviceDesk:{name:i.name,id:i.id},type:"serviceDesk"})}else{angular.forEach(s.selectHandles,function(e,t){if(i.id===e.serviceDesk.id){s.selectHandles.splice(t,1)}})}};s.clear=function(){s.selectHandles=[];angular.forEach(s.serviceDesks,function(e){e.checked=false;angular.forEach(e.engineers,function(e){e.checked=false});e.checkedEngineers=0});angular.forEach(s.allService,function(e){e.checked=false;angular.forEach(e.engineers,function(e){e.checked=false});e.checkedEngineers=0})};s.$on("$destroy",function(){if(!t.noSaveCacheData){t.setCacheData(s.id,s.serviceDesks)}})}})();(function(){"use strict";angular.module("com.ewei.angular.ui").directive("batchIndicator",e).controller("batchIndicatorController",t);e.$inject=[];function e(){return{restrict:"E",replace:true,templateUrl:"/source/scripts/directives/batch-indicator/batch-indicator.html",controller:"batchIndicatorController",scope:true}}t.$inject=["$rootScope","$scope","alertService","$state"];function t(e,i,r,t){i.status="ready";i.batchType="batch-ticket-customer";e.$on("batch-started",o);e.$on("batch-progress",s);e.$on("batch-finished",l);i.total=0;i.finished=0;i.needConfirmStop=false;i.stopEnabled=true;i.ok=function(e){i.status="ready";i.total=0;i.finished=0;if(i.fromId&&e){t.go("tickets_new.batch",{id:i.fromId})}};i.stop=function(){i.needConfirmStop=true};i.confirmStop=function(){if(!i.stopEnabled)return;i.stopEnabled=false;if(e.batchWorker){e.batchWorker.postMessage({type:"stop"})}};i.cancelStop=function(){i.needConfirmStop=false;i.stopEnabled=true};var n,a;function o(e,t){u();i.$applyAsync(function(){i.reason="";i.status="processing";i.batchType=t.batchType||"";i.total=t.total;i.finished=0;i.needConfirmStop=false;i.stopEnabled=true;n=Date.now()})}function s(e,t){i.$applyAsync(function(){i.total=t.total;i.finished=t.finished||0;a=(Date.now()-n)/i.finished;void 0})}function l(e,t){d();i.$applyAsync(function(){i.status="complete";i.total=t.total;i.finished=t.finished||0;i.stopEnabled=true;i.needConfirmStop=false;i.from=t.from;i.fromId=t.fromId;i.faildData=t.saveFailedData;i.reason=t.reason;if(t.reason&&t.reason==="license-error"){r.add("数据空间授权不足","danger")}else if(t.reason&&t.reason!=="stop"){var e="批量建单";if(i.batchType=="batch-ticket-export"||i.batchType=="customer-batch-export"||i.batchType=="user-group-batch-export"||i.batchType=="webchat-history-batch-export"){e="导出"}r.add("与服务器通讯中断，"+e+"未完成","danger")}})}var c;function u(){var e="批量建单";if(i.batchType=="batch-ticket-export"||i.batchType=="customer-batch-export"||i.batchType=="user-group-batch-export"||i.batchType=="webchat-history-batch-export"){e="导出"}var t="有"+e+"任务正在执行，你确认要取消未完成的任务吗？";c=window.onbeforeunload;window.onbeforeunload=function(e){e=e||window.event;e.returnValue=t;return t}}function d(){window.onbeforeunload=c}}})();angular.module("com.ewei.angular.ui").controller("transferSelectController",["$scope",function(e){var i=e;i.placeholder="搜索"+i.name+"名称";i.key="";i.activeSource={};i.activeDest={};i.hasKey=false;i.onKeyUp=function(e){var t=window.event?e.keyCode:e.which;if(e.ctrlKey&&e.keyCode===13){return}if(t===13){i.onSearch({key:i.key})}};var r=function(e){var r=[];e.forEach(function(t){var i=false;r.forEach(function(e){if(e.id===t.id){i=true}});if(!i){r.push(t)}});return r};i.onSelectAll=function(){if(i.value){i.value=r(_.union(i.list,i.value))}else{i.value=i.list}i.onChange({type:i.type,value:i.value})};i.onRemove=function(e){i.value.remove(e);i.onChange({type:i.type,value:i.value})};i.onSelect=function(e){var t=[];i.activeSource=e;t.unshift(e);if(i.value){i.value=r(_.union(t,i.value))}else{i.value=t}i.onChange({type:i.type,value:i.value})};i.onClear=function(){i.key="";i.onLoad()};i.onChangeType=function(){i.onChange({type:i.type,value:i.value})}}]).directive("transferSelect",function(){return{restrict:"E",transclude:true,replace:true,templateUrl:"source/scripts/directives/transfer-select/transfer-select.html",controller:"transferSelectController",scope:{list:"=",value:"=",total:"=",type:"=",name:"@",hasMore:"=",onSearch:"&",onLoad:"&",onLoadMore:"&",onChange:"&"}}});(function(){"use strict";angular.module("com.ewei.angular.ui").directive("miniEditor",e).controller("miniEditorController",t);e.$inject=[];function e(){return{restrict:"EA",replace:true,templateUrl:"source/scripts/directives/mini-editor/mini-editor.html",controller:"miniEditorController",scope:{value:"=",mark:"=?",placeholder:"@",height:"@",width:"@"}}}t.$inject=["$scope","$modal_","alertService"];function t(i,t,r){var n=null;i.id=(new Date).valueOf();i.placeholder=i.placeholder||"";i.height=i.height||"auto";i.width=i.width||"auto";i.data={url:""};i.addMark=function(){if(!n){r.add("请先选择要添加链接的文字","danger");return}var e=document.createElement(i.mark.tag);e.setAttribute("style","color:#6699CC;");e.innerText=n.toString();o(e);n=null};i.addLink=function(){if(!n){r.add("请先选择要添加链接的文字","danger");return}var e=t({scope:i,template:"modal/modal.tpl.w380.html",contentTemplate:"source/scripts/directives/mini-editor/modal-link.html",html:true,show:true,placement:"center",hideCallback:function(){n=null;i.data.url=""}});i.$hide=function(){e.$promise.then(e.hide)};i.$ok=function(){var e=i.data.url;if(e){if(e.toLowerCase().indexOf("http:")===-1&&e.toLowerCase().indexOf("https:")===-1){e="http://"+e}var t=document.createElement("a");t.setAttribute("style","color:#6699CC;");t.href=e;t.target="_blank";t.innerText=n.toString();o(t)}i.$hide()}};function a(e){var t=/<([\s\S]*?)(?:\s+?[^>]*?)?>\s*?<\/\1>/gi;return e.replace(t,"")}function o(e){n.deleteContents();n.insertNode(e);i.value=a(document.getElementById(i.id).innerHTML)}i.onSelect=function(){n=window.getSelection().getRangeAt(0);if(n.startOffset===n.endOffset){n=null}}}})();(function(){"use strict";angular.module("com.ewei.angular.ui").directive("batchOperationTable",e).controller("batchOperationTableController",t).filter("ccs",[function(){return function(e){var t=[];angular.forEach(e,function(e){if(e.serviceDesk&&e.serviceDesk.name){t.push(e.serviceDesk.name)}if(e.user&&e.user.name){t.push(e.user.name)}if(e.userGroup&&e.userGroup.name){t.push(e.userGroup.name)}if(e.email){t.push(e.email)}if(e.name&&!e.email){t.push(e.name)}});return t.join(",")}}]).filter("tags",[function(){return function(e){var t=[];angular.forEach(e,function(e){t.push(e.name)});return t.join(",")}}]).filter("priority",[function(){return function(t,e){var i="";angular.forEach(JSON.parse(e),function(e){if(e.value==t||e.name==t){i=e.name}});return i}}]).filter("serviceCatalog",["batchTicketService",function(i){return function(e){if(!e||e&&!e.id){return""}var d=i.serviceCatalogs;var t=function(e){if(d){for(var t=0;t<d.length;t++){var i=d[t];if(i.id&&e&&i.id==e){return i.name}for(var r=0;r<i.children_count;r++){var n=i.children[r];if(n.id&&e&&n.id==e){return i.name+"/"+n.name}for(var a=0;a<n.children_count;a++){var o=n.children[a];if(o.id&&e&&o.id==e){return i.name+"/"+n.name+"/"+o.name}for(var s=0;s<o.children_count;s++){var l=o.children[s];if(l.id&&e&&l.id==e){return i.name+"/"+n.name+"/"+o.name+"/"+l.name}for(var c=0;c<l.children_count;c++){var u=l.children[c];if(u.id&&e&&u.id==e){return i.name+"/"+n.name+"/"+o.name+"/"+l.name+"/"+u.name}}}}}}}};return t(e.id)}}]);e.$inject=[];function e(){return{restrict:"E",replace:true,templateUrl:"/source/batch-create-ticket/directive/batch-operation-table/batch-operation-table.html",controller:"batchOperationTableController",scope:{checkboxes:"=",selectedTicketIds:"=",columns:"=",batchList:"=",addRow:"&"},link:function(r,e,t){function i(e){var t=e.target;var i=document.querySelector(".batch-table .table tbody");if(i.contains(e.target)){}else{r.cancelCheckedTableCell()}}$(document).on("click",i);r.$on("$destroy",function(){$(document).off("click",i)})}}}t.$inject=["$rootScope","$scope","$stateParams","alertService","NgTableParams","$filter","batchTicketService","ticketExternalUrlAuthorizeService"];function t(e,n,t,a,i,o,r,s){n.id=t.id;var l=function(){angular.forEach(n.columns,function(e){e.align=e.align||"center";if(e.field==="handle"){e.fieldLength=250}else if(e.field==="customer"){e.fieldLength=280}else if(e.field==="subject"){e.fieldLength=e.length}else if(e.field==="ticket_description"){e.fieldLength=e.length}else if(e.field==="priority"){e.fieldLength=250}else if(e.field==="service_catalog"){e.fieldLength=280}else if(e.field==="ticket_type"){e.fieldLength=280}else if(e.field==="ccs"){e.fieldLength=280}else if(e.field==="tags"){e.fieldLength=280}else if(e.field==="sla_time"){e.fieldLength=230}else if(e.type=="checkbox"){e.fieldLength=100}else if(e.type=="date_to_date"){e.fieldLength=380}else if(e.type=="options"){e.fieldLength=180}else if(e.type=="multi_options"){e.fieldLength=180}else if(e.type=="cascade_options"){e.fieldLength=180}else if(e.type=="date_time"){e.fieldLength=180}else if(e.type=="date"){e.fieldLength=180}else if(e.type=="textarea"){e.fieldLength=180}else{e.fieldLength=e.length||180}})};var c=function(){n.batchList=r.getCacheData(n.id);var e=angular.copy(r.saveFaileExceldData);if(e&&e.length>0){n.batchList=e.concat(n.batchList);r.saveFaileExceldData=[]}if(n.batchList.length==0){var t=r.getNewRowData();n.batchList.push(t)}angular.forEach(n.batchList,function(i){angular.forEach(n.columns,function(t){if(t.url){i[t.field].valueUrl=t.url}if(t.customFieldOptions&&t.field!="priority"){if(t.field=="ticket_type"){if(!i.ticketType){i.ticketType={}}i.ticketType.customFieldOptions=t.customFieldOptions}else{if(i[t.field]){i[t.field].customFieldOptions=t.customFieldOptions}else{i[t.field]={customFieldOptions:t.customFieldOptions}}}}if(t.field=="priority"){var e=JSON.parse(t.customFieldOptions);angular.forEach(e,function(e){if(e.name==i[t.field]||e.value==i[t.field]){i[t.field]=e.value}})}if(t.field.indexOf("custom_field_")>-1){if(t.type=="options"){if(i[t.field]){i[t.field].openSearch=true}else{i[t.field]={openSearch:true,value:null}}if(t.defaultValue){i[t.field].defaultValue=t.defaultValue}}else if(t.type=="date_to_date"){if(i[t.field]){i[t.field].startTimeForm="";i[t.field].endTimeForm="";i[t.field].startTime=i[t.field].value?new Date(i[t.field].value.split("-")[0]):"";i[t.field].endTime=i[t.field].value?new Date(i[t.field].value.split("-")[1]):""}else{i[t.field]={startTime:"",endTime:"",startTimeForm:"",endTimeForm:""}}}else if(t.type=="date"||t.type=="date_time"){i[t.field].startForm="";if(i[t.field]){i[t.field].value=i[t.field].value?i[t.field].value:""}else{i[t.field]={value:null}}}else{if(i[t.field]&&!i[t.field].value){i[t.field].value=null}}}})})};var u=function(){l();c()};var d=function(e){if(r.checkedCustomFileds.length){n.columns=r.checkedCustomFileds;e()}else{r.getTicketCustomfileds(function(){n.columns=r.checkedCustomFileds;e()})}};d(u);s.run("",{},false,function(e){if(e.success&&e.json){n.externalUrlAuthorize=e.json}});n.datetimepickerConfig={datepickerOptions:{showWeeks:false},timepickerOptions:{showSeconds:true},buttonBar:{show:true,now:{show:true,text:"现在",cls:"btn-sm btn-default"},today:{show:true,text:"今天",cls:"btn-sm btn-default"},clear:{show:true,text:"清除",cls:"btn-sm btn-default"},date:{show:true,text:"日期",cls:"btn-sm btn-default"},time:{show:true,text:"时间",cls:"btn-sm btn-default"},close:{show:true,text:"关闭",cls:"btn-sm btn-default"},cancel:{show:false,text:"取消",cls:"btn-sm btn-default"}}};n.showCheckboxes=true;n.checkboxes={checked:false,items:{}};n.$watch("checkboxes.checked",function(t){angular.forEach(n.batchList,function(e){if(angular.isDefined(e.id)){n.checkboxes.items[e.id]=t}})});n.selectedTicketIds=[];n.$watch("checkboxes.items",function(e){n.selectedTicketIds=[];angular.forEach(e,function(e,t){if(e){n.selectedTicketIds.push(t)}});if(undefined===n.batchList||n.batchList.length==0){n.checkboxes.checked=false;return}else{var t=0,i=0,r=n.batchList.length;angular.forEach(n.batchList,function(e){t+=n.checkboxes.items[e.id]||0;i+=!n.checkboxes.items[e.id]||0});if(i==0||t==0){n.checkboxes.checked=t==r}angular.element(document.getElementById("select_all")).prop("indeterminate",t!=0&&i!=0)}},true);n.checkedTableCell=function(e,t,i){if(Object.prototype.hasOwnProperty.call(e,"$errorData")){if(e.$errorData[t.field]&&t.field!=="customer"){delete e.$errorData[t.field]}}angular.forEach(n.batchList,function(e){e.active=""});angular.forEach(n.columns,function(e){e.active=false});t.active=true;e.active=t.field};n.cancelCheckedTableCell=function(){angular.forEach(n.batchList,function(e){e.active=""});angular.forEach(n.columns,function(e){e.active=false})};n.open=function(e,t){e.preventDefault();e.stopPropagation();if(t.startForm){t.startForm=false}else{t.startForm=true}};n.timeFrameOpen=function(e,t,i){e.preventDefault();e.stopPropagation();if(i=="startTimeForm"){t.startTimeForm=!t.startTimeForm}else{t.endTimeForm=!t.endTimeForm}};n.filedValueChange=function(e,t,i){if(t&&t!=""){var r=new String(t);if(r.indexOf("{value}")>0){r=r.replaceAll("{value}",i)}else{r=r+i}e.valueUrl=r}};n.updateValue=function(e,t){var i=e.value;if(t.type=="date_to_date"){if(e.endTimeForm||e.startTimeForm){return}else{if(!i){if(!e.endTime&&!e.startTime){}else{return}}}}if(t.required&&!i){a.add("请输入"+t.title,"danger","left");return}if(t.regexpForValidation){var r=new RegExp(t.regexpForValidation);if(e.value&&!r.test(e.value)){a.add("请输入正确的"+t.title,"danger","left");e.value="";return}}};n.change=function(e,t){if(t.type=="date_to_date"){if(e.startTime!=undefined&&e.startTime!=""){var i=o("date")(e.startTime,"yyyy/MM/dd").toString()}else{a.add("请选取开始时间","danger","left");e.value="";return}if(e.endTime!=undefined&&e.endTime!=""){var r=o("date")(e.endTime,"yyyy/MM/dd").toString()}else{a.add("请选取结束时间","danger","left");e.value="";return}if(e.startTime&&e.endTime&&e.startTime>e.endTime){a.add("结束时间必须大于等于开始时间","danger","left");e.value="";return}e.value=i+"-"+r}};n.$on("selectedUser",function(e,t,i){var r=_.find(n.batchList,function(e){return e.id===i});if(r&&Object.prototype.hasOwnProperty.call(r,"$errorData")){if(r.$errorData["customer"]){delete r.$errorData["customer"]}}})}})();+function(){"use strict";angular.module("com.ewei.angular.ui").controller("eweiTreeController",["$scope","$modal_","alertService",function(l,a,o){l.toggle=function(e){if(!e.children||e.children&&e.children.length===0){return}e.isopen=!e.isopen};l.select=function(e){l.$emit("select-tree",e)};var s=function(t,i,r,n){var a;if(t.children&&t.children.length>0){var e=t.children.map(function(e){return e.order});a=Math.max.apply(null,e)}else{a=1}org.ewei.sdk.KnowledgeCatalogApi().save({knowledgeCatalog:{name:i,order:a+1,pid:t.id,level:t.level+1}}).then(function(e){if(e){t.children.push({id:e,name:i,order:a+1,pid:t.id,level:t.level+1,children:[]});t.isopen=true;l.isLoading=false;o.add(r+"成功","success");n.$promise.then(n.hide)}else{l.isLoading=false;o.add(r+"失败","danger")}})};var c=function(t,i,r,n){org.ewei.sdk.KnowledgeCatalogApi().update({knowledgeCatalog:{id:t.id,name:i,order:t.order,pid:t.pid,level:t.level}}).then(function(e){if(e){t.name=i;l.isLoading=false;o.add(r+"成功","success");n.$promise.then(n.hide)}else{l.isLoading=false;o.add(r+"失败","danger")}})};l.modify=function(e,t,i){e.stopPropagation();l.inputText=i==="add"?"":t.name;var r=i==="add"?"添加子分类":"修改名称";l.placeholder="请输入分类名称";var n=a({scope:l,title:r,contentTemplate:"source/system-setting/intelligent-robot/directive/alert/alert.html",html:true,show:true,placement:"center"});l.$ok=function(e){if(l.isLoading){return false}l.isLoading=true;if(i==="add"){s(t,e,r,n)}else{c(t,e,r,n)}};l.$hide=function(){n.$promise.then(n.hide)}};l.move=function(e,t,i){e.stopPropagation();var r=l.parent.children.indexOf(t);var n=i==="up"?r-1:r+1;var a=angular.copy(l.parent.children[n]);var o=angular.copy(l.parent.children[r]);var s=o.order;o.order=a.order;a.order=s;org.ewei.sdk.KnowledgeCatalogApi().updateBatch({knowledgeCatalogs:[a,o]}).then(function(e){if(e){l.parent.children[r]=a;l.parent.children[n]=o;l.parent.children[n].showEdit=false;l.parent.children[n].showToggle=false}})};l.delete=function(e,t){e.stopPropagation();if(t.children&&t.children.length>0){o.add("此分类下还有子分类或知识库问题，无法删除","danger");return}l._messages="删除分类后无法恢复，是否继续？";var i=a({scope:l,title:"删除确认",contentTemplate:"source/views/alter_common.html",html:true,show:true,placement:"center"});l.$ok=function(){if(l.isLoading){return false}l.isLoading=true;org.ewei.sdk.KnowledgeCatalogApi().deleteByIds({ids:[t.id]}).then(function(e){if(e){l.parent.children.splice(l.parent.children.indexOf(t),1);l.isLoading=false;o.add("删除成功","success");i.$promise.then(i.hide)}else{l.isLoading=false;o.add("此分类下还有子分类或知识库问题，无法删除","danger")}})};l.$hide=function(){i.$promise.then(i.hide)}}}]).directive("eweiTree",function(){return{restrict:"EA",transclude:true,replace:true,scope:{data:"=",index:"=",total:"=",parent:"=",selectid:"="},templateUrl:"source/system-setting/intelligent-robot/directive/ewei-tree/ewei-tree.html",controller:"eweiTreeController"}})}();angular.module("com.ewei.angular.ui").controller("catalogSelectController",["$scope","serviceCatalogService","permissions","$http",function(h,e,t,i){h.loadServiceCatalogs=function(e,t){if(h.nullShowName==null||h.nullShowName==undefined){h.nullShowName="-"}var i=function(){if(h.selectedservicecatalog!=null){h.catSelected=true}h.serviceCatalogs=h.list;if(h.selectedservicecatalog==null){h.parentServiceCatalog=null;h.showServiceCatalogs=h.serviceCatalogs;h.selectedServiceCatalogNameChain=h.nullShowName;h.oldServiceCatalogNameChain=null}else{h.selectedServiceCatalogNameChain=a();h.oldServiceCatalogNameChain=h.selectedServiceCatalogNameChain}};h.$watch("list",function(e){if(e){i()}})};var r=function(e){for(var t=0;t<h.serviceCatalogs.length;t++){var i=h.serviceCatalogs[t];if(i.id==e){return null}for(var r=0;r<i.children.length;r++){var n=i.children[r];if(n.id==e){return i}for(var a=0;a<n.children.length;a++){var o=n.children[a];if(o.id==e){return n}}}}return null};var n=function(e){var t=e.name||"";if(e.parent){t=e.parent.name+"/"+t;if(e.parent.parent){t=e.parent.parent.name+"/"+t;if(e.parent.parent.parent){t=e.parent.parent.parent.name+"/"+t;if(e.parent.parent.parent.parent){t=e.parent.parent.parent.parent.name+"/"+t}}}}return t};var a=function(){if(h.selectedservicecatalog.id){var e=o(h.serviceCatalogs,h.selectedservicecatalog.id);if(e){return e.join(" / ")}else{var t=n(angular.copy(h.selectedservicecatalog));return t}}else{if(h.nullShowName!=null){return h.nullShowName}else{return"-"}}};var o=function(e,r){var n=[];var a=false;if(e&&e.length>0){e.forEach(function(e){if(e.id==r){n.push(e.name);a=true}if(!a){var t=[e.name];var i=o(e.children,r);if(i&&i.length>0){n=n.concat(t,i);return n}}});return n}};h.back=function(e){if(h.parentServiceCatalog==null||r(h.parentServiceCatalog.id)==null){h.showServiceCatalogs=h.serviceCatalogs;h.parentServiceCatalog=null}else{h.parentServiceCatalog=r(h.parentServiceCatalog.id);h.showServiceCatalogs=h.parentServiceCatalog.children}h.isopen=true;e.stopPropagation()};h.clear=function(){h.selectedservicecatalog=null;h.selectedServiceCatalogNameChain=h.nullShowName;h.catSelected=false;h.parentServiceCatalog=null;h.showServiceCatalogs=h.serviceCatalogs;h.oldServiceCatalogNameChain=null};h.selectServiceCatalog=function(e,t){var i=h.showServiceCatalogs[e];if(i.children&&i.children.length>0){h.parentServiceCatalog=i;h.showServiceCatalogs=i.children;h.isopen=true;t.stopPropagation()}else{h.selectedservicecatalog=i;h.selectedServiceCatalogNameChain=a();h.catSelected=true;h.oldServiceCatalogNameChain=h.selectedServiceCatalogNameChain}};h.selectParentServiceCatalog=function(){h.selectedservicecatalog=h.parentServiceCatalog;h.selectedServiceCatalogNameChain=a();h.catSelected=true;h.oldServiceCatalogNameChain=h.selectedServiceCatalogNameChain};h.stopPropagation=function(e){e.stopPropagation()};var g=function(e,t){var i=0;for(var r=0;r<e.length;r++){if(e[r].id===t){i=r;break}}return i+1};h.searchCatalog=function(e){h.searchCatalogList=[];if(!e){return false}var t=new RegExp(e,"i");var i=new RegExp(e,"g");for(var r=0;r<h.serviceCatalogs.length;r++){var n=h.serviceCatalogs[r];var a=[];var o=null;a.push({id:n.id,name:n.name});if(t.test(n.name)){o=_.map(a,function(e){return e.name});h.searchCatalogList.push({id:n.id,name:n.name,listName:o[0].replace(i,"<b>"+e+"</b>")})}for(var s=0;s<n.children.length;s++){var l=n.children[s];a=a.slice(0,g(a,n.id));a.push({id:l.id,name:l.name});if(t.test(l.name)){o=_.map(a,function(e){return e.name});h.searchCatalogList.push({id:l.id,name:l.name,listName:o[0]+"/"+l.name.replace(i,"<b>"+e+"</b>")})}for(var c=0;c<l.children.length;c++){var u=l.children[c];a=a.slice(0,g(a,l.id));a.push({id:u.id,name:u.name});if(t.test(u.name)){o=_.map(a,function(e){return e.name});h.searchCatalogList.push({id:u.id,name:u.name,listName:o.slice(0,o.length-1).join("/")+"/"+u.name.replace(i,"<b>"+e+"</b>")})}for(var d=0;d<u.children.length;d++){var f=u.children[d];a=a.slice(0,g(a,u.id));a.push({id:f.id,name:f.name});if(t.test(f.name)){o=_.map(a,function(e){return e.name});h.searchCatalogList.push({id:f.id,name:f.name,listName:o.slice(0,o.length-1).join("/")+"/"+f.name.replace(i,"<b>"+e+"</b>")})}for(var p=0;p<f.children.length;p++){var m=f.children[p];a=a.slice(0,g(a,f.id));a.push({id:m.id,name:m.name});if(t.test(m.name)){o=_.map(a,function(e){return e.name});h.searchCatalogList.push({id:m.id,name:m.name,listName:o.slice(0,o.length-1).join("/")+"/"+m.name.replace(i,"<b>"+e+"</b>")})}}}}}}};h.selectSearchCatalog=function(e){h.selectedservicecatalog=e;h.$emit("selectedServiceCatalog",e)};h.loadServiceCatalogs();h.click=function(){h.parentServiceCatalog=null;h.showServiceCatalogs=h.serviceCatalogs};h.$watch("selectedservicecatalog",function(){if(h.selectedservicecatalog==null||h.selectedservicecatalog==""){h.selectedservicecatalog=null;h.catSelected=false;h.selectedServiceCatalogNameChain=h.nullShowName}else{h.selectedServiceCatalogNameChain=a();h.catSelected=!!h.selectedServiceCatalogNameChain}})}]).directive("catalogSelect",function(){return{restrict:"E",replace:true,scope:{list:"=",selectedservicecatalog:"=",nullShowName:"@",disabled:"=",singleLine:"="},controller:"catalogSelectController",templateUrl:"source/system-setting/intelligent-robot/directive/catalog-select/catalog-select.html"}});angular.module("com.ewei.angular.ui").directive("dropDown",[function(){return{restrict:"AE",templateUrl:"source/system-setting/intelligent-robot/directive/drop-down/drop-down.html",controller:"dropDownController",scope:{options:"=",selectedId:"=",onSelected:"&"}}}]).controller("dropDownController",["$scope","$http","alertService",function(r,e,t){r.$watch("options",function(e){if(e){r.customOptions=angular.copy(e);if(r.selectedId){r.customOptions.forEach(function(e){if(e.id===r.selectedId){r.selected=e}})}}});r.search=function(e){var t=[];var i=e.target.value.trim();angular.forEach(r.options,function(e){if(e.title&&e.title.search(new RegExp(i,"i"))>-1){t.push(e)}});r.customOptions=t};r.choose=function(e){r.selected=e;r.selectedId=e.id;r.onSelected({value:e})}}]);angular.module("com.ewei.angular.ui").directive("chatPortal",[function(){return{restrict:"AE",templateUrl:"source/system-setting/intelligent-robot/directive/chat-portal/chat-portal.html",controller:"chatPortalController",scope:{item:"=",show:"="}}}]).controller("chatPortalController",["$scope","$http","alertService",function(r,e,t){r.user={photo:null,replyMessage:"",name:"",type:"text",isRobot:false};function i(e){org.ewei.sdk.OpenAutomatonApi().findById({id:e.id}).then(function(e){var t={photo:e.photo,name:e.name,isRobot:true,type:"text",replyMessage:e.type==="knowledge"?e.welcomeKnowledgeReply:e.welcomeArticleReply};r.list=[t];if(e.recommend&&e.recommendKnowledges&&e.recommendKnowledges.length>0){r.list.push({photo:e.photo,name:e.name,isRobot:true,type:"knowledge",replyMessage:e.recommendReply,knowledgeList:e.recommendKnowledges})}})}r.$watch("item",function(e,t){if(e!==t){i(e)}});r.hide=function(){r.show=false};r.enterEvent=function(e){var t=window.event?e.keyCode:e.which;if(t==13){e.preventDefault();r.send()}};r.onReply=function(e){if(e.target.nodeName==="A"&&e.target.type){r.onAction(e.target.type,e.target.innerText)}};r.onAction=function(e,t){r.user.replyMessage=t;r.send()};r.transTag=function(i,r){var e=new RegExp("<"+r+"[\\s\\S]*?>([\\s\\S]*?)<\\/"+r+">","g");var n=/>([\s\S]*?)</;var t=/#(.*?);/g;var a=i.match(e);if(a){a.forEach(function(e){var t=e.split(n)[1];i=i.replace(e,"<a type="+r+">"+t+"</a>")});i=i.replace(t,"")}return i};r.send=function(e){if(!e&&!r.user.replyMessage){return}if(e){var t=angular.copy(r.user);t.replyMessage=e&&e.title?e.title:t.replyMessage;r.list.push(t);var i={photo:r.item.photo,name:r.item.name,isRobot:true,type:"text",replyMessage:e.answer};r.list.push(i);return}var t=angular.copy(r.user);t.replyMessage=e&&e.title?e.title:t.replyMessage;r.list.push(t);r.user.replyMessage="";org.ewei.sdk.TalkApi().testRobotMessage({automatonId:r.item.id,message:t.replyMessage}).then(function(e){if(e){var t=n(e);r.list.push(t)}})};var n=function(e){e.photo=r.item.photo;e.name=r.item.name;e.isRobot=true;if(e.knowledgeList&&e.knowledgeList.length>0){if(e.knowledgeList.length>1){e.type="knowledge"}else{e.type="text";e.replyMessage=e.knowledgeList[0].answer}}else if(e.replyMessage.indexOf("{{article_list}}")>-1){e.type="articles";var t=e.replyMessage.split("{{article_list}}");if(t.length>1){e.beforeContent=t[0];e.afterContent=t[1]}else{e.beforeContent=t[0]}}else{e.type="text"}return e}}]);(function(){"use strict";angular.module("com.ewei.angular.ui").directive("excel2json",e);e.$inject=[];function e(){return{scope:{loaded:"&",maxLength:"@",headerList:"="},link:function(f,e,t){f.maxLength=f.maxLength||100;f.headerList=f.headerList||[];e.bind("change",function(d){var e=new FileReader;e.onload=function(e){var t=e.target.result;var i=XLSX.read(t,{type:typeof FileReader!=="undefined"&&(FileReader.prototype||{}).readAsBinaryString?"binary":"array"});var r=Object.keys(i.Sheets);for(var n=0;n<1;n++){var a=r[n];if(i.Sheets.hasOwnProperty(a)){var o=i.Sheets[a];var s=f.headerList.length>0;f.headerList.forEach(function(i){var r=false;Object.keys(o).forEach(function(e){for(var t=0;t<26;t++){if(e===String.fromCharCode(65+t)+"1"){if(o[e].v===i.key){r=true}}}});if(!r){s=false}});if(!s){f.loaded({result:{data:"导入表格不符合规范，请严格按照模版样式填写，不要删减字段",status:false}});break}var l=XLSX.utils.sheet_to_json(o);if(l.length>f.maxLength){f.loaded({result:{data:"最大支持 "+f.maxLength+" 条数据",status:false}});break}for(var c=0,u=l.length;c<u;c++){Object.keys(l[c]).forEach(function(e){if(typeof l[c][e]==="number"){var t=new Date(1900,0,l[c][e]-1).toLocaleDateString();l[c][e]=t}})}f.loaded({result:{data:l,status:true}})}}d.target.value=""};var t=d.target.files[0];var i=t.name.split(".")[1];if(i!=="xls"&&i!=="xlsx"){d.target.value="";f.loaded({result:{data:t.name+"不是有效的excel文件",status:false}})}else{e.readAsBinaryString(t)}})}}}})();angular.module("com.ewei.angular.ui").directive("ticketLabelAutocomplete",["$document","$http","$timeout",function(o,s,l){return{restrict:"ECA",replace:true,scope:{subject:"=",disabled:"="},templateUrl:"/source/scripts/directives/ticket_label_autocomplete/ticket-label-autocomplete.html",link:function(i,r,e){i.isShowAutoComplete=false;i.selectedIndex=0;var t=function(e){var t=r.find(e.target).length>0;if(!t){i.isShowAutoComplete=false;i.$apply()}};var n=function(e){var t=r.find(e.target).length>0;if(t){if(e.keyCode==38){if(i.selectedIndex>0){--i.selectedIndex}}else if(e.keyCode==40){if(i.selectedIndex<i.list.length-1){++i.selectedIndex}}else if(e.keyCode==13){a(i.list[i.selectedIndex])}i.$apply()}};var a=function(e){i.isShowAutoComplete=false;i.subject=e.name};o.on("click",t);o.on("keydown",n);r.on("$destroy",function(){o.off("click",t);o.off("keydown",n)});i.search=function(){i.selectedIndex=0;i.isShowAutoComplete=true;l(function(){s.get("api/v1/tags/by_key.json?_count=10&key="+i.subject).then(function(e){i.list=e.data.result.tags},function(e){i.list=[]})},500)};i.itemMouseUp=function(e){for(var t in i.list){if(i.list.hasOwnProperty(t)){if(e.id==i.list[t].id){i.selectedIndex=t}}}};i.itemClick=function(e){a(e)}}}}]);