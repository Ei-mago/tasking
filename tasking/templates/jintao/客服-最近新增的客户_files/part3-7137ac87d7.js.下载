(function(z,Y){"use strict";z.module("eweiApp.common").controller("headerController",e);e.$inject=["$scope","$rootScope","$state","tabs","utils","$filter","$modal_","$timeout","userService","userGroupService","$http","alertService","permissions","license","toastr","locker","commonTools","EweiConfig","ConsoleConfig","ticketRecentViewService","ctiUsbService","$window","$location","$aside","$interval","coreNotifyService","providerJudgement","coreModelService","remoteControlService"];function e(d,c,u,e,p,f,l,n,m,s,g,v,r,t,h,i,y,a,k,o,C,b,w,T,S,F,A,E,O){var I;var L=false;var D=null;d.providerHelpCenterUrl=k.providerHelpCenterUrl;d.currentUser=k.user;c.nextTicketId=0;var P=i.driver("session").namespace("eweiApp.nextTicketId").get("lastid");if(P){c.nextTicketId=parseInt(P)}d.$on("$locationChangeSuccess",function(){d.locationPath=w.path()});if(!k.user.photo)d.$on("modal.hide",function(e,t){L=false;if(z.isDefined(d.data)){clearInterval(d.updateSecondsTimerId);if(I==null||I=="reject"){g({url:"reject_assist.json",method:"GET",params:{targetUserId:d.data.requesterUserId,ticketId:d.data.ticketId,reason:"reject"}}).success(function(e,t,i,n){if(e.success){}else{if(e.message!=null){v.add(f("translate")(e.message),"danger")}else{v.add("失败","danger")}}})}}});var x={provider_id:k.provider.id,_token:getCookie("user_token")};g.get("/api/v1/console_operate_quide.json",{params:x}).success(function(e){if(e.status==0&&e.result&&e.result.consoleOperateQuides&&e.result.consoleOperateQuides.length){var t=e.result.consoleOperateQuides;for(var i=0;i<t.length;i++){if(t[i].operate==="add"){c.guideAdd=true}if(t[i].operate==="setting"){c.guideSetting=true}}}});var N=function(e,r){if(c.chatRoleName=="handler"){d._messages="您确定退出当前会话吗？您是当前会话的主接人，退出后当前会话也将被结束。"}else{d._messages="您确定退出当前会话吗？"}var t=l({scope:d,title:"退出确认",contentTemplate:"source/views/alter_common.html",html:true,show:true,placement:"center"});d.hideConfirmModal=function(){t.$promise.then(t.hide)};d.$ok=function(){if(!o.submiting){o()}d.hideConfirmModal()};o.submiting=false;function o(){if(o.submiting){return}o.submiting=true;g({url:"close_chat/"+r+".json",method:"GET",params:{quitUserId:k.user.id,closeAction:e}}).success(function(e,t,i,n){o.submiting=false;c.$broadcast("pre_chat_assign");if(e.success){var s=false;for(var a=0;a<d.tabs.length;a++){if("webchats_new.detail"+r===d.tabs[a].id){s=true;break}}if(s){p.removeTabById(u,"webchats_new.detail"+r)}}else{if(e.message!=null){v.add(f("translate")(e.message),"danger")}else{v.add("失败","danger")}}}).error(function(){o.submiting=false})}};c.$on("exit_current_tab",function(e,t){if(t.stateName==="webchats_new.detail"){N("completed",t.params.id);i.driver("session").namespace("eweiApp.chat").forget(t.params.id)}else if(t.stateName==="tickets_new"){setTimeout(function(){i.driver("session").namespace("eweiApp.ticket").forget(t.params.id)},2e3)}});d.$on("accept_remote_desk",function(e,t){var i=eweiCommon.uuid();var n="2JD"+i+"|"+JSON.stringify(t.json);if(t.remoteFunction=="video_call"){n="2JV"+i+"|"+JSON.stringify(t.json)}Y.socketMgr.get().send(n);if(t.json&&t.json.jsparam&&!t.json.jsparam.chatId){O.parseMessage({cmd:"respondPT",result:t.json.addr.length>0?0:-1})}});var M=l({scope:d,title:"请求远程协助",contentTemplate:"source/views/assist.html",html:true,show:false,placement:"center",backdrop:"static"});d.hideModal=function(){M.$promise.then(M.hide)};d.$on("cancel_request_assist",function(e,t){I="canceled";L=false;d.hideModal()});d.$on("request_assist",function(e,s){if(L){g({url:"reject_assist.json",method:"GET",params:{targetUserId:s.requesterUserId,ticketId:s.ticketId,reason:"bustling"}}).success(function(e,t,i,n){if(e.success){}else{}});e.stopPropagation()}d.data=s;var t=function(){L=true;I=null;d.seconds=30;d.updateSecondsTimerId=setInterval(function(){d.$apply(i)},1e3)};t();d.playAudio("call-in.wav");M.$promise.then(M.show);var i=function(){d.seconds-=1;if(d.seconds==0){L=false;I="overtime";d.hideModal()}};d.requesterName=s.requesterName;d.ticketNo=s.ticketNo;d.$accept=function(){I="accept";L=false;g({url:"accept_assist.json",method:"GET",params:{targetUserId:s.requesterUserId,ticketId:s.ticketId,isWebChat:s.isWebChat}}).success(function(e,t,i,n){d.hideModal();if(e.success){if(s.isWebChat){$.ajax({url:"/ticket_assist/"+d.data.ticketId+".json",type:"GET",data:{requesterId:d.data.requesterId,userId:k.user.id,channel:"console",clientType:"WEB_PC",source:window.location.href},error:function(){},success:function(e){void 0;void 0;var t=p.findTabByIdAndStateName("webchats_new.detail"+e.id,"webchats_new.detail");if(t==null){p.addTab("webchats_new.detail"+e.id,e.message||"#"+e.id,"webchats_new.detail",{id:e.id},"",true,false);u.go("webchats_new.detail",{id:e.id},{reload:"webchats_new.detail"})}}})}}else{if(e.message!=null){v.add(f("translate")(e.message),"danger")}else{v.add("失败","danger")}}})}});d.$on("join_chat",function(e,t){if(t.chatId==d.waitingJoinChatId){var i=p.findTabByIdAndStateName("webchats_new.detail"+t.chatId,"webchats_new.detail");if(i==null){p.addTab("webchats_new.detail"+t.chatId,t.firstMessage||"#"+t.chatId,"webchats_new.detail",{id:t.chatId},"",true,false);u.go("webchats_new.detail",{id:t.chatId},{reload:"webchats_new.detail"})}else{if(!i.active){u.go("webchats_new.detail",{id:t.chatId},{reload:"webchats_new.detail"})}}d.waitingJoinChatId=null}});d.getProvider=function(){g({url:"get_console_style_custom_by_provider_id.json",method:"GET",params:{providerId:k.provider.id}}).success(function(e){if(e.success){c.provider={name:e.json.name,fontSize:14,contentUrl:e.json.contentUrl==null?"":"/no_auth_ewei_attachment?contentUrl="+e.json.contentUrl,headBackgroundColor:e.json.headBackgroundColor,dropDownColor:e.json.dropDownColor,titleTypefaceColor:e.json.titleTypefaceColor,titleTypeface:e.json.titleTypeface,buttonTypeface:e.json.buttonTypeface}}else{c.provider={name:"易维帮助台",fontSize:14,contentUrl:"",headBackgroundColor:"#1e8cce",dropDownColor:"#3bb6ee",titleTypefaceColor:"#FFFFFF",titleTypeface:"微软雅黑",buttonTypeface:"微软雅黑",defaultlogo:"source/images/logo_helpdesk.png"}}})},d.getProvider();d.getRGB=function(e,t){var i=[0,0,0];if(/#(..)(..)(..)/g.test(e)){i=[parseInt(parseInt(RegExp.$1,16)*(t+(255-parseInt(RegExp.$1,16))*.001)),parseInt(parseInt(RegExp.$2,16)*(t+(255-parseInt(RegExp.$2,16))*.001)),parseInt(parseInt(RegExp.$3,16)*(t+(255-parseInt(RegExp.$3,16))*.001))]}return"rgb("+i.join(",")+")"};d.tabs=e;d.addTabToTicket=function(e){if(!A.isTrue()){return false}if(c.nextTicketId==undefined){c.nextTicketId=p.countByStateName("tickets_new")+1}var t=++c.nextTicketId;i.driver("session").namespace("eweiApp.nextTicketId").put("lastid",t);u.go("tickets_new.normal",{id:t,type:"normal"})};d.cancelNotice=function(){_hmt.push(["_trackEvent","全局功能","添加"]);if(!d.guideAdd){g.post("/api/v1/console_operate_quide.json",{operate:"add"},{params:x}).success(function(e){void 0;if(e.status==0){d.guideAdd=true}})}if(c.ticketNoticeImgState){var e={ticketFlag:true,customerFlag:true,userId:k.user.id};g.post("save_user_flag.json",e).success(function(e){if(e.success){$("#ticketNoticeImgVisible").css("visibility","hidden");$("#customerNoticeImgVisible").css("visibility","hidden")}})}if(c.customerNoticeImgState){var e={customerFlag:true,ticketFlag:true,userId:k.user.id};g.post("save_user_flag.json",e).success(function(e){if(e.success){$("#ticketNoticeImgVisible").css("visibility","hidden");$("#customerNoticeImgVisible").css("visibility","hidden")}})}};var j=function(e){var t=/^1[34578][0-9]{9}$/i;return t.test(e)};var R=function(e){var t=/^[0-9]*[1-9][0-9]*$/i;return t.test(e)};d.$on("createNewUser",function(){d.addTabToCustomer()});var U;d.addTabToCustomer=function(){if(!A.isTrue()){return false}if(U){U.destroy()}U=l({scope:d,title:"新建客户",contentTemplate:"source/views/customer/user_add.html",html:true,show:true,placement:"center"});var i=function(e){var t=e;var i=[];for(var n=0;n<t.length;n++){var s=t[n];var a={id:null,value:s.value,customField:null};if(s.type=="options"){var r=jQuery.parseJSON(s.customFieldOptions);s.customFieldOptions=r;if(s.value==undefined){a.value=r[0].value}if((s.value==undefined||s.value=="")&&s.defaultValue){for(var o=0;o<r.length;o++){if(r[o].value==s.defaultValue){a.value=s.defaultValue}}}}if(s.type=="checkbox"){if(s.value=="true"){a.value=true}else{a.value=false}}if(s.type=="ip"||s.type=="url"||s.type=="mobile_phone"||s.type=="currency"){s.type="text"}if(s.notes!=undefined&&s.notes.length>40){s.notes=s.notes.substring(0,12)+". . . "}if(s.value){s.value=""}if(s.url){if(s.url.toLowerCase().indexOf("http://")!=0){s.url="http://"+s.url}if(s.url.indexOf("?")<0){a.fromParams="?"}else{a.fromParams="&"}var l=new String(s.url);if(l.indexOf("{value}")>0){l=l.replaceAll("{value}",a.value)}else{l=l+a.value}a.valueUrl=l}if(s.type=="date"){s.startForm=false}else if(s.type=="date_to_date"){s.startTimeForm=false;s.endTimeForm=false;if(s.value){var c=s.value.split("-");s.startTime=c[0];s.endTime=c[1]}}if(s.type=="multi_options"){var u="";z.forEach(JSON.parse(s.customFieldOptions),function(e){if(e.defaultValue){u+=e.value+","}});a.value=u.substring(0,u.length-1)}a.customField=s;a.id=s.userCustomFieldId;if(s.required){s.moreField=true}else{s.moreField=false}i.push(a)}d.userCustomFields=i};d.userCustomFields=[];if(d.userId==undefined){g.get("custom_field.json?scope=user&active=true").success(function(e,t){i(e.json)})}else{g.get("user_custom_field.json?userId="+d.userId).success(function(e,t){i(e.json)})}d.datepickers={startTo:false,updateFrom:false,updateTo:false};d.open=function(e,t){e.preventDefault();e.stopPropagation();if(t.startForm){t.startForm=false}else{t.startForm=true}};d.timeFrameOpen=function(e,t,i){e.preventDefault();e.stopPropagation();if(i=="startTimeForm"){t.startTimeForm=!t.startTimeForm}else{t.endTimeForm=!t.endTimeForm}};d.newUser={relatedUserGroups:[]};d.$save=function(){var e=/[\\\[\]]/im;if(d.newUser.email&&!verifyEmailAddress(d.newUser.email)){v.add("邮件地址需由字母、数字或下划线组成","danger");return false}if(d.newUser.phone&&!R(d.newUser.phone)){v.add("电话号码格式不正确","danger");return false}if(d.newUser.mobilePhone&&!validMobilePhone(d.newUser.mobilePhone)){v.add("手机号码格式不正确","danger");return false}if(d.newUser.password&&d.newUser.password.length<6){v.add("密码格式不正确，不能包含非法字符和汉字，长度在6-16位之间，请修改","danger");return false}else if(d.newUser.password&&d.newUser.password.length>5&&e.test(d.newUser.password)){v.add("密码格式不正确，不能包含非法字符和汉字，长度在6-16位之间，请修改","danger");return false}if(!A.isTrue()){return false}var t;var i=d.userCustomFields;var n=i.length;var s=[];var a;for(var r=0;r<n;r++){a={};t=i[r].customField;if(t.type=="date_to_date"){if(t.startTime||t.endTime){if(t.startTime&&t.endTime){var o=f("date")(t.startTime,"yyyy/MM/dd").toString();var l=f("date")(t.endTime,"yyyy/MM/dd").toString();a.value=o+"-"+l;a.customField=t;s.push(a)}else{v.add("请填写完整"+t.title,"danger");return false}}else{if(t.required){v.add("请填写完整"+t.title,"danger");return false}else{continue}}}else if(t.type=="cascade_options"){if(t.required){if(i[r].value=="-"){v.add("请填写完整"+t.title,"danger");return false}}if(i[r].value){a.value=i[r].value;a.customField=t;s.push(a)}}else{if(t.required){if(!i[r].value){v.add("请填写完整"+t.title,"danger");return false}}if(i[r].value){if(t.type=="date"){i[r].value=f("date")(i[r].value,"yyyy/MM/dd").toString()}a.value=i[r].value;a.customField=t;s.push(a)}}}d.newUser.customerCustomFields=s;m.add(d.newUser,function(e){if(e.success){_hmt.push(["_trackEvent","添加","添加-新建客户-保存"]);d.hideModal();g({url:"reset_user_password.json",method:"POST",data:{userId:e.id,password:d.newUser.password}}).success(function(e,t,i,n){});u.go("customers_detail",{id:e.id})}else{if(e.message!=null){var t="";if(e.message=="FIELD_NOT_EXIST"){t="自定义字段未找到"}else if(e.message.indexOf("REQUIRED_FIELD_IS_NULL_")>=0){var i=e.message.split("REQUIRED_FIELD_IS_NULL_")[1];var n;var s=d.newUser.customerCustomFields;for(var a in s){n=s[a].customField.id;if(i==n){t="请填写"+s[a].customField.title;break}}}else if(e.message.indexOf("FIELD_ERROR_")>=0){var i=e.message.split("FIELD_ERROR_")[1];var n;var s=d.newUser.customerCustomFields;for(var a in s){n=s[a].customField.id;if(i==n){t="请正确填写"+s[a].customField.title;break}}}else{t=e.message}v.add(f("translate")(t),"danger")}else{v.add("保存失败","danger")}}})};d.moreField=false;d.showMoreField=function(){d.moreField=true;var e=d.userCustomFields;var t=e.length;var i=[];var n=[];var s;for(var a=0;a<t;a++){s=e[a].customField;s.moreField=true;if(s.required==true){i.push(e[a])}else{n.push(e[a])}}d.userCustomFields=i.concat(n);void 0}};d.$on("createNewUserGroup",function(){d.addTabToUserGroup()});d.addTabToUserGroup=function(){if(!A.isTrue()){return false}M=l({scope:d,title:"新建客户分组",contentTemplate:"source/views/customer/user_group_add.html",html:true,show:true,placement:"center"});g.get("get_external_url_authorize.json").success(function(e){if(e.success&&e.json){d.externalUrlAuthorize=e.json}});d.newUserGroup={shared:false,userGroupCustomFields:[]};d.groupField={};d.$save=function(){var e=d.groupField.userGroupCustomFields;if(e&&e.length>0){for(var t=0;t<e.length;t++){if(e[t].customField.regexpForValidation&&e[t].value){var i=new RegExp(e[t].customField.regexpForValidation);if(!i.test(e[t].value)){v.add("请输入正确的"+e[t].customField.title,"danger");e[t].value="";return}}else if(e[t].customField&&e[t].customField.required&&(!e[t].value||e[t].value=="-")){v.add(e[t].customField.title+"不能为空","danger");return}}}d.newUserGroup.userGroupCustomFields=[];z.forEach(d.groupField.userGroupCustomFields,function(e){var t={value:e.value,customField:{id:e.customField.id}};d.newUserGroup.userGroupCustomFields.push(t)});s.add(d.newUserGroup,function(e){if(e.success){_hmt.push(["_trackEvent","添加","添加-客户分组-保存"]);d.hideModal();u.go("user_groups_detail",{id:e.id})}else{if(e.message!=null){v.add(f("translate")(e.message),"danger")}else{v.add("保存失败","danger")}}})}};var V=function(){var e=d.dropdown.length;var t=o.getTickets();for(var i=e-1;i>0;i--){if(d.dropdown[i].isTicket){d.dropdown.splice(i,1)}}z.forEach(t,function(e){var t='<i class="fa fa-caret-right"></i>&nbsp;';t+=e.subject.length>20?e.subject.substring(0,20)+"...":e.subject;d.dropdown.push({text:t,click:"$state.go('tickets_detail', {id:"+e.id+",})",isTicket:true})})};var q=u.current.name;var G=t.type()||"";d.hasBatchTicketCreateModule=G==="enterprise_basic"||G==="enterprise_trial"||G==="enterprise_basic_19";F.register(q,F.constant.EVENT_LICENSE,function(e,t){var i=E.config.license.get("license").type||"";d.hasBatchTicketCreateModule=i==="enterprise_basic"||i==="enterprise_trial"||i==="enterprise_basic_19"});d.showBatchTicket=function(){d.isShowBatchTicket=true};d.hideBatchTicket=function(){d.isShowBatchTicket=false};c.$on("$translateChangeSuccess",function(){d.dropdown=[];if(r.hasPermission("ticket_create")){d.dropdown.push({text:'<i class="iconfont" style="color:#999">&#xe64e;</i>&nbsp;'+f("translate")("TICKET"),click:"addTabToTicket()"})}if(r.hasPermission("batch_ticket_create")){d.dropdown.push({text:'<i class="iconfont" style="color:#999">&#xe7a9;</i>&nbsp;高级建单<i class="iconfont" style="position:absolute;right:20px;top:4px;color:#999">&#xe70e;</i>&nbsp;',click:"hideBatchTicket();",enter:"showBatchTicket();",leave:"hideBatchTicket();"})}if(r.hasPermission("customer_create")){d.dropdown.push({text:'<i class="iconfont" style="font-size:19px;color:#999">&#xe650;</i>&nbsp;'+f("translate")("CUSTOMER"),click:"addTabToCustomer()"})}if(r.hasPermission("customer_group_create")){d.dropdown.push({text:'<i class="iconfont" style="color:#999">&#xe665;</i>&nbsp;'+f("translate")("USER_GROUP"),click:"addTabToUserGroup()"})}if(d.dropdown.length>0){d.dropdown.push({divider:true})}d.dropdown.push({text:"最近查看",click:"addOther()",defaultCursor:true});o.init(V);z.forEach(d.messages["lists"],function(e,t){e["text"]=f("trusted")(e["text"])})});d.addOther=function(){};d.messages={title:"MESSAGES_CENTER",lists:[]};d.$on("close_chat",function(e,t){void 0;var i=p.findTabByIdAndStateName("webchats_new.detail"+t.chatId,"webchats_new.detail");if(z.isObject(i)){i.isClose=true}c.$broadcast("pre_chat_assign")});var K=function(){var t=0;d.tabs.forEach(function(e){if(e.stateName==="webchats_new.detail"&&!e.isClose){t++}});var e=c.concurrentChatNumber-t;e=e>0?e:0;return e};function B(){for(var e in d.messages.lists){if(!d.messages.lists[e].acceptCount||d.messages.lists[e].acceptCount<=0){return d.messages.lists[e].chatId}}return null}d.removeMessage=function(i,n){z.forEach(d.messages["lists"],function(e,t){if(e[i]==n){d.messages["lists"].splice(t,1)}})};d.component_popup=function(e){void 0;d.isInstall=false;d.isInstallTesting=false;d.isClose=false;d.isApp=false;var t="APP和微信客服端";if(e==2){_hmt.push(["_trackPageview","/全局功能/一级/远程协助组件"]);_hmt.push(["_setCustomVar",c.vertionNumber,"名称","全局功能-远程协助组件",1]);d.isApp=true;t=false;if(d.isInstallApplication){d.isClose=true;d.isInstall=true}}else{_hmt.push(["_trackPageview","/全局功能/一级/APP和微信客服端"]);_hmt.push(["_setCustomVar",c.vertionNumber,"名称","全局功能-APP和微信客服端",1])}var i=l({scope:d,title:t,contentTemplate:"source/views/component_popup.html",html:true,show:true,placement:"center",backdrop:"static"});d.$install=function(){d.isInstall=true;d.isInstallTesting=true};d.$isInstallTesting=function(){c.$broadcast("applicationBeenInstalled");d.isInstallTesting=false;var e=0;var t=setInterval(function(){document.getElementById("test").innerHTML+=">";e++;if(e==4){document.getElementById("test").innerHTML=">";e=0}},100);n(function(){clearInterval(t);if(!d.isInstallApplication){d.isInstall=false}else{d.isClose=true}},5e3)};d.whyFalse=false;d.installFlase=function(){d.whyFalse=true;d.isInstallTesting=false};d.$return=function(e){d.whyFalse=false;if(e==0){d.isInstall=true;d.isInstallTesting=true}else{d.isInstall=false}};d.closeModal=function(){i.$promise.then(i.hide)}};d.$on("request_chat",function(e,t){var i={chatId:t.chatId,userName:t.requesterName,firstMessage:t.firstMessage,time:t.nowTime};d.$apply(function(){d.messages["lists"].push(i);if(t.usableChatCount<=0){d.toastrShowRequest(t,"queue_chat");d.playAudio("DingDong.wav")}});c.$broadcast("refreshWaitingChatCount")});d.$on("cancel_request_chat",function(e,t){void 0;if(D==t.chatId){h.clear();D=null}d.$apply(function(){d.removeMessage("chatId",t.chatId)});c.$broadcast("refreshWaitingChatCount")});d.$on("accept_chat",function(e,s){if(s.engineerId==k.engineer.id){g({url:"join_chat/"+s.chatId+".json",method:"GET",params:{}}).success(function(e,t,i,n){if(s&&s.chatId){Q(s.chatId,s,false);void 0;if(s.desktop){O.parseMessage({cmd:"respondCT",result:0,jsparam:{chatId:s.chatId}})}}})}else{h.clear()}});var Q=function(e,t,i){var n="",s=null,a="";if(t&&!i){n=t.requesterName;a=t.firstMessage;s=t.chatId}else{for(var r=0;r<d.messages.lists.length;r++){if(d.messages.lists[r].chatId==e){n=d.messages.lists[r].userName;a=d.messages.lists[r].firstMessage;break}}s=e}if(D==s){h.clear();D=null}d.removeMessage("chatId",s);var o=p.findTabByIdAndStateName("webchats_new.detail"+s,"webchats_new.detail");if((t&&t.engineerId==k.engineer.id||i)&&!o){if(o==null){p.addTab("webchats_new.detail"+s,a||"#"+s,"webchats_new.detail",{id:s},"",true,false,true)}F.doNotify(F.constant.EVENT_OTHER_CHAT_RED_POINT,true);d.playAudio("auto-chat.wav");var l=window.contextpath+"/source/images/logo_helpdesk.png";if(c.provider.contentUrl){l=c.provider.contentUrl}y.browserNotify({body:"",title:"会话#"+s+"已接通！",icon:l,timeOut:3e4,callBack:function(){if(A.isFree()){u.go("no-license",{},{reload:true})}else{u.go("webchats_new.detail",{id:s},{reload:"webchats_new.detail"});d.$applyAsync(function(){var e=p.findTabByIdAndStateName("webchats_new.detail"+s,"webchats_new.detail");if(z.isObject(e)){e.shake=false;e.active=true}})}}})}c.$broadcast("refreshWaitingChatCount")};d.inviterName="";d.chatId="";d.inviteChatMode="";d.statusInfo="等待你的响应";var H=l({scope:d,title:"邀请会话",contentTemplate:"source/views/ticket/chat_invite.html",html:true,show:false,prefixEvent:"invite_modal",placement:"center",backdrop:"static"});d.hideInviteModal=function(){H.$promise.then(H.hide)};var W;d.$on("invite_modal.hide",function(e,t){void 0;if(I==null){d.$responseInvite(d.chatId,"reject",null)}L=false;d.statusInfo="";d.inviterName="";d.chatId="";d.inviteChatMode="";d.statusInfo="等待你的响应";I=null;d.userName="";d.inviterId=""});d.$on("chat_invite",function(e,l){d.playAudio("call-in.wav");d.inviterId=l.inviterId;d.inviteChatMode=l.inviteChatMode;d.userName=l.userName;if(l.inviteChatMode=="force_transfer"){g({url:"join_chat/"+l.chatId+".json",method:"GET",params:{joinRole:"handler"}}).success(function(e,t,i,n){if(e.success){var s=p.findTabByIdAndStateName("webchats_new.detail"+l.chatId,"webchats_new.detail");if(s==null){p.addTab("webchats_new.detail"+l.chatId,l.firstMessage||"#"+l.chatId,"webchats_new.detail",{id:l.chatId},"",true,false)}u.go("webchats_new.detail",{id:l.chatId},{reload:"webchats_new.detail"});var a={allowHtml:true,timeOut:"10000",extendedTimeOut:"10000",titleClass:"c07",toastClass:"toast-invited-chat",messageClass:"c07 message",position:"toast-top-right",type:"info",closeButton:false,tapToDismiss:false};var r='<div style="white-space:normal;word-break:break-all;width:125px;">'+l.description+"</div>";var o='<p style="font-weight:bolder;">来自'+l.inviterName+"的转接会话</p>";W=h.alert('<div><p style="margin:5px 0px;">'+"客户 : "+l.userName+"</p>"+r+"</div>",o,a)}})}else{var t=true;var i=false;if(l.invitedUserIds&&l.invitedUserIds.indexOf(",")>0){t=false;i=true}var n={allowHtml:true,timeOut:"30000",extendedTimeOut:"30000",timeOutFunction:function(){d.$responseInvite(l.chatId,"no_reply",l)},titleClass:"c07",toastClass:"toast-invited-chat",messageClass:"c07 message",position:"toast-top-right",type:"info",closeButton:false,tapToDismiss:false,showBtnYesNo:t,showBtnYes:i,btnYesText:"接受",btnNoText:"拒绝",btnYesClick:function(){d.$responseInvite(l.chatId,"accept",l)},btnNoClick:function(){d.$responseInvite(l.chatId,"reject",l)}};var s="会话转接，来自："+l.inviterName;if(d.inviteChatMode=="invite"){s=l.inviterName+"邀请你加入会话#"+l.chatId}var a=window.contextpath+"/source/images/logo_helpdesk.png";if(c.provider.contentUrl){a=c.provider.contentUrl}y.browserNotify({body:l.description||"",title:s,icon:a,timeOut:5e3});W=h.alert("<div><p>"+(l.description||"")+"</p></div>",s,n)}});d.$on("chat_transfer_responsed",function(e,t){h.clear(W);d.hideInviteModal()});d.$responseInvite=function(i,e,n){I=e;var s={id:i,chatId:i,responseUserId:k.user.id,targetUserId:d.inviterId,responseType:e,inviteChatMode:d.inviteChatMode,invitedUserIds:n.invitedUserIds,transferNo:n.transferNo,noticeId:n.noticeId};Y.sdk.OpenWebChatApi().responseChatInvite(s).then(function(e){if(e){if(I=="accept"){var t=p.findTabByIdAndStateName("webchats_new.detail"+i,"webchats_new.detail");if(t==null){p.addTab("webchats_new.detail"+i,n.firstMessage||"#"+i,"webchats_new.detail",{id:i},"",true,false)}else{t.active=true}c.$broadcast("response_chat_invite",s);u.go("webchats_new.detail",{id:i},{reload:"webchats_new.detail"})}}},function(e){if(e&&e.error_description){v.add(f("translate")(e.error_description),"danger")}})};d.$on("response_chat_invite",function(e,s){if(s.responseType=="accept"){if(s.inviteChatMode=="transfer"&&s.responseUserId!==k.user.id){g({url:"close_chat/"+s.chatId+".json",method:"GET",params:{quitUserId:k.user.id}}).success(function(e,t,i,n){if(e.success){p.removeTabById(u,"webchats_new.detail"+s.chatId)}else{if(e.message!=null){v.add(f("translate")(e.message),"danger")}else{v.add("失败","danger")}}})}}});d.$on("cancel_chat_invite",function(e,t){d.statusInfo="对方已经取消。";I="canceled";if(H){d.hideInviteModal()}});d.acceptWebchat=function(s,e,a){if(A.isFree()){u.go("no-license",{},{reload:true});return false}if(!A.isTrue()){return false}else{if(D==s){h.clear();D=null}var i={};z.forEach(d.messages["lists"],function(e,t){if(e["chatId"]==s){if(e["pincode"]!=undefined){i.pincode=e["pincode"];i.targetCometdClientId=c.cometdClientId}}});if(e){i.assignMe=e}g({url:"accept_chat/"+s+".json",method:"GET",params:i}).success(function(e,t,i,n){if(e.success){}else{if(e.message=="WEBCHAT_RESPONSED"||e.message=="WEBCHAT_CLOSED"){d.removeMessage("chatId",s)}else if(e.message=="WEBCHAT_PRIORITY_ON"){z.forEach(d.messages["lists"],function(e,t){if(e["chatId"]==s){var i=d.messages.lists[t].acceptCount;if(i==undefined){i=0}d.messages.lists[t].acceptCount=i+1}})}else if(e.message=="license_limit"){if(a!=true){M=l({scope:d,title:"提示",contentTemplate:"source/views/quantity_limitation.html",html:true,show:true,placement:"center"});d.limit={};d.limit.hasPermission=true;d.goUpgrade=function(){if(r.hasPermission("system_setting_company_account")){u.go("system_setting.detail.provider",{uri:"company_account",settingType:"system"});M.$promise.then(M.hide)}else{d.limit.hasPermission=false}};d.hideLimitModal=function(){M.$promise.then(M.hide)}}}}})}};d.$on("dashBoradacceptWebchat",function(e,t){d.acceptWebchat(t,true,false)});var J=null;d.$on("ticket_assist",function(e,t){if(J!=null&&J==t.chatId){return}if(t.engineerId==k.engineer.id){if(t.pincode!=undefined){setTimeout(function(){d.acceptWebchat(t.chatId,true,false)},1e3)}else{g({url:"join_chat/"+t.chatId+".json",method:"GET",params:{}}).success(function(e,t,i,n){if(e.success){var s=p.findTabByIdAndStateName("webchats_new.detail"+e.id,"webchats_new.detail");if(s==null){p.addTab("webchats_new.detail"+e.id,e.message||"#"+e.id,"webchats_new.detail",{id:e.id},"",true,false)}u.go("webchats_new.detail",{id:e.id},{reload:"webchats_new.detail"});J=e.id}})}}});d.$on("play_audio",function(e,t){d.playAudio(t)});d.playAudio=function(e){if(_.contains(["DingDong.wav","auto-chat.wav","call-in.wav"],e)){$("#playAudioContainer").empty();$("#playAudioContainer").html('<audio src="source/audio/'+e+'" autoplay="true"></audio>')}else{$("#playAudioContainer").empty();$("#playAudioContainer").html("<audio src='source/audio/DingDong.wav' autoplay='true'></audio>")}};d.loadmyNOresponseChats=function(){g({url:"waiting_chat_queue.json",method:"GET",params:{}}).success(function(e,t,i,n){if(e.chats&&e.chats.length){var s=e.chats;for(var a=0,r=s.length;a<r;a++){var o={chatId:s[a].id,userName:s[a].user.name,firstMessage:s[a].firstMessage,time:s[a].createdAt};d.messages["lists"].push(o)}}})};d.loadMyChats=function(){g({url:"user_chats.json",method:"GET",params:{userId:k.user.id}}).success(function(e,t,i,n){if(e.success){var s=e.json;for(var a=0,r=s.length;a<r;a++){var o=p.findTabByIdAndStateName("webchats_new.detail"+s[a].id,"webchats_new.detail");if(o==null){p.addTab("webchats_new.detail"+s[a].id,s[a].firstMessage||"#"+s[a].id,"webchats_new.detail",{id:s[a].id},"",false,false)}}}})};d.showRequestList=function(){var e;var t=d;e=l({scope:t,contentTemplate:"source/views/aside/messages.html",html:true,show:true,container:"body",animation:"am-slide-right",aside:"messages"});d.hideRequestModal=function(){e.$promise.then(e.hide)}};d.loadmyNOresponseChats();d.loadMyChats();d.toastrShowRequest=function(e,t){h.clear();var t=t||"danger_chat";if(t!="danger_chat"){F.doNotify(F.constant.EVENT_LIST_CHAT_WAITTING,true);F.doNotify(F.constant.EVENT_OTHER_CHAT_RED_POINT,true)}var i=function(e){if(e.photo&&e.photo.contentUrl){return"/no_auth_ewei_attachment?contentUrl="+e.photo.contentUrl+"-head.40.40"}else{return"/source/images/face/header_40.png"}};var n={allowHtml:true,timeOut:9999999999,extendedTimeOut:999999999,toastClass:"toast-invited-chat"+(t==="queue_chat"?" toast-broadcast-queue-chat":""),customStyles:t==="queue_chat"?"background-image: url('"+i(e.user)+"') !important; background-size: 24px !important;":"",titleClass:"c07 size16",messageClass:"c07",position:"toast-top-right",type:"alert",closeButton:true,tapToDismiss:false,onClick:function(){d.acceptWebchat(e.chatId,true,false)}};var s=e.requesterName+(t==="queue_chat"?" 等待会话":" 发起请求");D=e.chatId;if(t==="queue_chat"){var a="";if(typeof e.firstMessage!="undefined"){a='<a href="javascript:void(0)" class="waiting-chat-content">'+e.firstMessage+"</a>"}if(e.serviceCatalog&&e.serviceCatalog.fullname){a+='<p class="queue-chat-details">'+e.serviceCatalog.fullname+"</p>"}if(e.serviceDesk&&e.serviceDesk.name){a+='<p class="queue-chat-details">目标客服组: '+e.serviceDesk.name+"</p>"}if(e.via&&e.via.channelName){a+='<p class="queue-chat-details">来自: '+e.via.channelName+"</p>"}if(e.fromIp||e.fromLocation){var r=e.fromIp||"";a+='<p class="queue-chat-details">'+r+(e.fromLocation?"-"+e.fromLocation:"")+"</p>"}h.alert(a,s,n)}else{h.alert('<a href="javascript:void(0)">点击接受请求</a>',s,n)}};d.$on("uploadedWebchatAttachment",function(e,t){if(t.jsonObj.jsparam.chatId==null){return}var i="image";if(t.jsonObj.cmd=="respondCS"){i="image"}else if(t.jsonObj.cmd=="respondSC"){i="video"}var n={id:t.id,contentUrl:t.jsonObj.key};var s={id:t.jsonObj.jsparam.chatId,open:t.jsonObj.jsparam.open};d.sendChatMessage(i,s,n)});d.sendChatMessage=function(e,t,i){if(i==undefined){return}var n={type:e,isPublic:t.open,user:{id:k.user.id}};if(typeof i=="object"){n.attachment=i}n.chat={id:t.id};var s={channel:"/provider/"+k.provider.id+"/chat/"+t.id,from:k.user.name};if(typeof i=="object"){s.attachmentkey=i.contentUrl}s.log=n;s.log.uId=eweiCommon.uuid(32,16).toLowerCase();g({url:"webchat_message/"+t.id,method:"POST",params:{t:(new Date).getTime()},data:s}).success(function(e,t,i,n){})};d.$on("assign_chat",function(e,t){g({url:"join_chat/"+t.chatId+".json",method:"GET",params:{}}).success(function(e,t,i,n){if(e.success){var s=p.findTabByIdAndStateName("webchats_new.detail"+e.id,"webchats_new.detail");if(s==null){p.addTab("webchats_new.detail"+e.id,e.message||"#"+e.id,"webchats_new.detail",{id:e.id},"",true,false,true)}u.go("webchats_new.detail",{id:e.id},{reload:"webchats_new.detail"})}})});d.currentUserBuried=function(){_hmt.push(["_trackEvent","全局功能","个人信息"])};d.helpcenterBuried=function(){_hmt.push(["_trackEvent","全局功能","帮助中心"])};d.toSelectCurrentMember=function(e){_hmt.push(["_trackEvent","全局功能","并发会话上限"]);d.showCurrentSelectNum=!d.showCurrentSelectNum;d.showCurrentSetting=false;e.stopPropagation()};d.noviceguideBuried=function(){_hmt.push(["_trackEvent","全局功能","新手向导"])};d.helpTextBuried=function(){_hmt.push(["_trackEvent","全局功能","帮助文档"])};d.developerBuried=function(){_hmt.push(["_trackEvent","全局功能","开发者"])};d.logoutBuried=function(){_hmt.push(["_trackEvent","全局功能","登出"])};d.showCurrentSetting=false;d.toSelectCurrentSetting=function(e){d.showCurrentSetting=!d.showCurrentSetting;d.showCurrentSelectNum=false;e.stopPropagation()};d.logoutEnginerr=function(){g({url:"logout",method:"GET"}).success(function(e){window.location.href="/login?login_user_type=engineer"})};d.offChildSelect=function(){d.showCurrentSelectNum=false;d.showCurrentSetting=false};d.offSelectCurrentSetting=function(){d.showCurrentSetting=false};d.setCurrentChatNumber=function(t){d.showCurrentSelectNum=false;g({url:"update_concurrent_number",method:"GET",params:{t:(new Date).getTime(),number:t}}).success(function(e){if(e.success){c.concurrentChatNumber=t;c.$broadcast("concurrent-chat-number-changed",t)}})};d.loadVisibleWarning=function(){g({url:"chat_warning.json",method:"GET",params:{}}).success(function(e,t,i,n){if(e.success){d.chatTimeOutWarning["lists"]=e.json}})};d.loadVisibleWarning();d.acceptedChatWarning=function(a){g({url:"response_chat_warning.json",method:"GET",params:{id:a.id,chatId:a.chat_id}}).success(function(e,t,i,n){if(e.success){var s=p.findTabByIdAndStateName("webchats_new.detail"+e.json.chatId,"webchats_new.detail");if(s==null){p.addTab("webchats_new.detail"+e.json.chatId,e.json.firstMessage||"#"+e.json.chatId,"webchats_new.detail",{id:e.json.chatId},"",true,false)}u.go("webchats_new.detail",{id:e.json.chatId},{reload:"webchats_new.detail"});c.$broadcast("join_chat",e.json)}else{if(e.message==="CHAT_CLOSED"){v.add("会话#"+a.chat_id+"已关闭","danger")}else if(e.message==="CHAT_WARNING_REMOVE"){v.add("危险会话#"+a.chat_id+"已经被响应","danger")}z.forEach(d.chatTimeOutWarning["lists"],function(e,t){if(e["id"]==a.id){d.chatTimeOutWarning["lists"].splice(t,1)}})}})};d.dangerChatAlert=function(e){var t={allowHtml:true,timeOut:"15000",extendedTimeOut:"0",titleClass:"c07",toastClass:"toast-invited-chat",messageClass:"c07 message",position:"toast-top-right",type:"info",onClick:function(){d.acceptedChatWarning(e)},closeButton:false,tapToDismiss:false,showBtnYesNo:false};h.danger("<div><p>"+e.content+"</p></div>","会话#"+e.chat_id+"异常",t)};d.chatTimeOutWarning={title:"MESSAGES_CENTER",lists:[]};d.$on("chat_time_out_warning",function(e,t){d.dangerChatAlert(t);d.playAudio("call-in.wav");var i=window.contextpath+"/source/images/logo_helpdesk.png";if(c.provider.contentUrl){i=c.provider.contentUrl}y.browserNotify({body:t.content,title:"会话#"+t.chat_id+"异常",icon:i,timeOut:5e3});var n={type:"warning",id:t.id,chat_id:t.chat_id,created_at:t.created_at,content:t.content};d.chatTimeOutWarning["lists"].unshift(n)});d.$on("response_chat_time_out_warning",function(e,i){z.forEach(d.chatTimeOutWarning["lists"],function(e,t){if(e["id"]==i.id){d.chatTimeOutWarning["lists"].splice(t,1)}})});d.$on("update_role_permissions",function(e,t){void 0;var i=0;if(t.roleId){i=t.roleId}$.get("/permissions_list.json?roleId="+i,function(e){if(e.json){r.setPermissions(e.json)}})});d.$on("show_component_popup",function(e,t){d.component_popup(t)})}})(angular,org.ewei);angular.module("eweiApp.common").controller("mainNavigation",["$scope","$rootScope","$state","tabs","utils","$filter","$location","$http","permissions","license","$modal_","$alert","alertService","ConsoleConfig","appIframe","$sce","$stateParams","chatTypeTotalService","coreNotifyService","apiRestfulService","$timeout","coreModelService","providerJudgement",function(l,n,c,i,s,e,u,r,d,a,o,t,p,f,m,g,v,h,y,k,C,b,w){var T=this.__proto__.constructor.name+"_"+(new Date).valueOf();l.isShowPage={};l.leftIcon=true;l.newFavoriteCount=0;l.appAssetId=null;h("","",y.constant.EVENT_CHAT_LIST_COUNT,function(e){if(e.result.total_waiting<=0){y.doNotify(y.constant.EVENT_OTHER_CHAT_RED_POINT,false)}else{y.doNotify(y.constant.EVENT_OTHER_CHAT_RED_POINT,true)}});function S(){y.register(T,y.constant.EVENT_OTHER_CHAT_RED_POINT,function(e,t){if(c.current.name.indexOf("webchats_new.")===-1||!t){l.chatRedPoint=t}});y.register(T,y.constant.EVENT_LICENSE,function(e,t){P()});y.register(T,y.constant.EVENT_NEW_FAVORITE_ADDED,function(e,t){l.newFavoriteCount++;L();if(l.newFavoriteCount>99){l.newFavoriteCount=99}});y.register(T,y.constant.EVENT_NEW_FAVORITE_REMOVED,function(e,t){l.newFavoriteCount--;L();if(l.newFavoriteCount<0){l.newFavoriteCount=0}});y.register(T,y.constant.EVENT_NEW_FAVORITE_CLEARED,function(e,t){l.newFavoriteCount=0;L()});y.register(T,y.constant.EVENT_APP_OPEN_ASSET,function(e,t){l.openWebSiteApp({appId:l.appAssetId,param:{uuid:t.uuid,type:"console-open-asset"}})})}l.$location=u;S();function F(){y.unRegister(T)}l.$on("$destroy",function(){F()});function A(){for(var e in l.isShowPage){l.isShowPage[e]=false}}l.openFunModuleApp=function(e){c.go(e.redirectUrl)};l.sendIframeMessage=function(e,t){if(e){if(t){C(function(){document.getElementById("app_"+l.appAssetId).contentWindow.postMessage(e,"*")},2e3)}else{document.getElementById("app_"+l.appAssetId).contentWindow.postMessage(e,"*")}}};l.openWebSiteApp=function(s,a){c.go("apps",{appId:s.appId});if(!a){m.setObtainDisplayInfo(true)}l.leftIcon=false;A();if(l.isShowPage[s.appId]==undefined){r({method:"GET",url:"/api/authorize_to_app/"+s.appId+".json",params:{provider_id:f.provider.id,_token:getCookie("user_token")}}).success(function(e,t,i,n){if(e.status==0){if(a){m.setObtainDisplayInfo(true);m.setIsShowPage(l.isShowPage)}e.result.redirectUrl=e.result.redirectUrl.replace("http:",location.protocol);e.result.redirectUrl=e.result.redirectUrl.replace("https:",location.protocol);m.setAuthorize_to_app_url({id:s.appId,appurl:g.trustAsResourceUrl(e.result.redirectUrl)});l.sendIframeMessage(s.param,true)}else{void 0}});l.isShowPage[s.appId]=true}else{l.isShowPage[s.appId]=true;l.sendIframeMessage(s.param,false)}if(!a){m.setIsShowPage(l.isShowPage)}void 0};var E=u.path();if(E.substr(0,5)==="/apps"){l.openWebSiteApp({appId:E.substr(6)},true)}l.currentProviderId=f.provider.id;l.eweiAdminApiUrl=null;r.post("get_ewei_admin_api_url.json").success(function(e){if(e.success){if(e.json.indexOf("http://")!=0&&e.json.indexOf("https://")!=0){l.eweiAdminApiUrl="http://"+e.json}else{l.eweiAdminApiUrl=e.json}}});l.currentUser=f.user;l.mobileRegex={china:"^1\\d{10}$",other:"^\\d{5,16}$"};l.mobileRegexType="china";l.finishUserInfo=function(e){if(!e){return false}else{mobileModal.hide();r.put("/completed_engineer_personal_info.json",{user:l.currentUser}).success(function(){})}};function O(e){l.authorizeDeadline=new Date(a.authorizeDeadline());var t=new Date;l.curTime=l.authorizeDeadline-t.getTime();l.modalTitle="授权过期";if(e!=undefined){l.days=Math.abs(e);l.modalMessage="你的使用授权已过期"+l.days+"天"}else{l.modalMessage="你的使用授权已过期"}var i=o({scope:l,template:"modal/modal.tpl.w620.html",contentTemplate:"source/views/license_overdue.html",html:true,show:true,placement:"center",backdrop:"static",alwaysShow:true});l.goFeedback=function(){renewals.action=l.eweiAdminApiUrl+"order_service_page";renewals.submit()};l.linkEngineer=function(){$("#ewei-websdk-portal").trigger("click")};l.checkBalance=function(){i.$promise.then(i.hide);c.go("system_setting.detail.provider",{uri:"company_account",settingType:"system"})};l.buyCompanyServe=function(){buy_company_serve.action=l.eweiAdminApiUrl+"order_service_page";buy_company_serve.submit()}}function I(){D()}function L(){var e=f.provider.id+"."+f.user.id+".newFavoriteCount";var t={},i=(new Date).toLocaleDateString();t[i]=l.newFavoriteCount;localStorage.setItem(e,angular.toJson(t))}function D(){var e=f.provider.id+"."+f.user.id+".newFavoriteCount";today=(new Date).toLocaleDateString();var t=angular.fromJson(localStorage.getItem(e));if(t&&Object.hasOwnProperty.call(t,today)){l.newFavoriteCount=parseInt(t[today]);if(l.newFavoriteCount>99){l.newFavoriteCount=99}}}function P(){if(n.providerLicense!=null){if(!n.providerLicense.isInfoCompleted)return;var e=a.overdueDays();var t=a.expenseLevel();l.licenseType=a.type();if(a.type()=="public"||a.type()=="blend"||a.type()=="enterprise"||a.type()=="enterprise_plus"||a.type()=="professional"||a.type()=="oem"||a.hasModule("super_board")){I()}if(a.overduePayService()<=0&&l.licenseType!="free"&&l.licenseType!="trial"&&l.licenseType!="enterprise_trial"&&a.type()!="public"&&a.type()!="blend"){O()}else if(e<0&&(l.licenseType=="trial"||l.licenseType=="enterprise_trial")){O(e)}else if((a.type()=="public"||a.type()=="blend"||a.type()=="enterprise"||a.type()=="enterprise_plus"||a.type()=="professional"||a.type()=="oem")&&a.accountBalance()<0&&(!a.lastTime()||a.lastTime()<0)){l.modalTitle="账户余额不足，服务暂停";l.modalMessage="你的账户余额不足，请尽快充值以恢复服务";var i=o({scope:l,template:"modal/modal.tpl.w620.html",contentTemplate:"source/views/license_overdue.html",html:true,show:true,placement:"center",backdrop:"static"});l.hideModal=function(){i.$promise.then(i.hide)};l.goBuy=function(){l.hideModal();c.go("system_setting.detail.provider",{uri:"company_account"})};l.goFeedback=function(){renewals.action=l.eweiAdminApiUrl+"order_service_page";renewals.submit()};l.checkBalance=function(){l.hideModal();c.go("system_setting.detail.provider",{uri:"company_account",settingType:"system"})}}l.getFreeLicense=function(){if(typeof l.hideModal=="function"){l.hideModal()}var e=o({scope:l,template:"modal/modal.tpl.w620.html",contentTemplate:"source/views/system_setting/apply_free_license.html",html:true,show:true,placement:"center"});l.hideModalGetFreeLicense=function(){e.$promise.then(e.hide)};l.providerApplyFree={};l.update=function(){if(l.providerApplyFree.companyName==""||l.providerApplyFree.companyName==null||l.providerApplyFree.companyName==undefined){p.add("请输入公司全名","danger");return false}if(l.providerApplyFree.scale==""||l.providerApplyFree.scale==null||l.providerApplyFree.scale==undefined){p.add("请选择企业规模","danger");return false}if(l.providerApplyFree.scene==""||l.providerApplyFree.scene==null||l.providerApplyFree.scene==undefined){p.add("请选择应用场景","danger");return false}if(l.providerApplyFree.payIntentions==""||l.providerApplyFree.payIntentions==null||l.providerApplyFree.payIntentions==undefined){p.add("请选择付费意向","danger");return false}if(l.providerApplyFree.onlineProgram==""||l.providerApplyFree.onlineProgram==null||l.providerApplyFree.onlineProgram==undefined){p.add("请选择上线计划","danger");return false}if(l.providerApplyFree.name==""||l.providerApplyFree.name==null||l.providerApplyFree.name==undefined){p.add("请输入你的姓名","danger");return false}if(l.providerApplyFree.tel==""||l.providerApplyFree.tel==null||l.providerApplyFree.tel==undefined){p.add("请输入你的手机号码","danger");return false}if(!validMobilePhone(l.providerApplyFree.tel)){p.add("请输入正确的手机号","danger");return false}void 0;l.continue=true;$.post("/apply_free_license.json",l.providerApplyFree).success(function(e){if(e.success){p.add("更新成功！","success");l.hideModalGetFreeLicense()}else{l.errorMessage=e.message;p.add(e.message,"danger");l.continue=false}})}}}}l.goSettings=function(){var e=b.config.route.get("system-setting");if(e){c.go(e.name,e.params,{reload:true})}else{c.go("system_setting.detail",{uri:"my_account",settingType:"system"},{reload:true})}};l.$on("license_overdue",function(e,t){if(t==="time"){p.add("操作失败，您的授权已过期","danger")}else if(t==="disk"){var i=o({scope:l,template:"modal/modal.tpl.w380.html",contentTemplate:"source/views/license-over-usage.html",html:true,show:true,placement:"center",backdrop:"static",alwaysShow:true});l.hideLicenseOverUsageModal=function(){i.$promise.then(i.hide)}}else if(t==="account"){p.add("操作失败，您的账户余额不足","danger")}else{p.add("操作失败，您的授权已过期","danger")}});l.select=function(e){switch(e){case"system_set":if(!l.guideSetting){var t={provider_id:f.provider.id,_token:getCookie("user_token")};r.post("/api/v1/console_operate_quide.json",{operate:"setting"},{params:t}).success(function(e){void 0;if(e.status===0){l.guideSetting=true}})}break;case"chat":if(w.isFree()){c.go("no-license",{},{reload:true})}else{c.go("webchats_new.list",{type:"processing"})}break;default:}s.cancelSelect(i)};var x=n.$on("$stateChangeStart",function(e,t,i,n,s){m.setObtainDisplayInfo(false);l.leftIcon=true;var a=t.permission;if(angular.isFunction(a)){a=a(i)}if(_.isString(a)&&!d.hasPermission(a)){void 0;if(t.name.indexOf("system_setting")>-1){e.preventDefault();C(function(){c.go("system_setting.detail",{uri:"my_account",settingType:"system"})})}else{u.path("/unauthorized")}}else if(_.isArray(a)){var r=false;for(var o=0;o<a.length;o++){if(d.hasPermission(a[o])){r=true;break}}if(!r){void 0;if(t.name.indexOf("system_setting")>-1){e.preventDefault();C(function(){c.go("system_setting.detail",{uri:"my_account",settingType:"system"})})}else{u.path("/unauthorized")}}}});var N=n.$on("$locationChangeSuccess",function(){l.locationPath=u.path()});l.$on("$destroy",function(){x();N()});l.noticeCount=0;l.$on("notice",function(e,t){l.$apply(function(){l.noticeCount+=1})});l.$on("clear_notice_count",function(e,t){l.noticeCount=0});n.showStatisticsBtn=d.hasPermission("ticket_performance_statistics")||d.hasPermission("ticket_distributed_statistics")||d.hasPermission("customer_analyze_statistics")||d.hasPermission("statistics_engineer_performance")||d.hasPermission("statistics_ticket_statistics")||d.hasPermission("statistics_chat_statistics")||d.hasPermission("statistics_customer_statistics")||d.hasPermission("service_report");l.providerWebSiteApps=[];l.providerFunModuleApps=[];r({method:"GET",url:"/api/provider_app_by_app_kind_is_website.json",params:{provider_id:f.provider.id,_token:getCookie("user_token")}}).success(function(e,t,i,n){if(e.status===0){angular.forEach(e.result.providerApps,function(e){if(e.appName==="易维IT资产管理"||e.app&&e.app.name==="易维IT资产管理"){l.appAssetId=e.app.id;e.module="it_assets,remote_maintain";if(e.app.redirectUrl.indexOf("https")===0&&location.protocol!=="https:"){e.app.redirectUrl=e.app.redirectUrl.replace(/https/i,"http")}}});l.providerWebSiteApps=e.result.providerApps;m.setProviderApps(l.providerWebSiteApps)}else{void 0}});r({method:"GET",url:"/api/provider_app_by_app_kind_is_function_module.json",params:{provider_id:f.provider.id,_token:getCookie("user_token")}}).success(function(e){if(e.status===0){var t=[];angular.forEach(e.result.providerApps,function(e){if(e.app&&e.app.redirectUrl&&e.app.redirectUrl.indexOf("statistics-menggang")>-1){if(f.engineer.role.nameKey==="ROLE_NAME_ADMIN"||f.engineer.role.nameKey==="ROLE_NAME_CREATOR"){t.push(e)}}else{t.push(e)}});l.providerFunModuleApps=t}});r.get("find_provider_by_admin_userId.json",{params:{providerId:f.provider.id}}).success(function(e){l.providerNumber=e.providerNumber})}]);(function(){"use strict";angular.module("eweiApp").controller("providerInfoCompletionController",e);e.$inject=["$rootScope","$scope","$interval","$q","ConsoleConfig","ProviderLicenseInfo","$modal_","apiRestfulService","alertService"];function e(n,s,a,r,t,e,o,i,l){if(!t.engineer||!t.engineer.role||t.engineer.role.nameKey!=="ROLE_NAME_CREATOR"||e.isInfoCompleted)return;s.providerCompletion={launchPlanned:true,name:t.user.name,email:t.user.email,verifyCode:"",getCodeDisabled:false,verifyCodeTipText:"获取验证码"};s.employeesData=["50人以下","50-150人","150-300人","300-500人","500-1000人","1000人以上"];s.sceneList=["IT服务","在线客服","售后维保","其他"];s.multiselectSettings={showCheckAll:false,showUncheckAll:false,displayProp:"name",scrollable:true,buttonClasses:"form-control"};s.multiselectTranslateSettings={dynamicButtonTextSuffix:"项已选择",buttonDefaultText:"请选择应用场景"};var c=o({scope:s,title:"完善资料",template:"source/views/provider_completion.html",html:true,show:true,placement:"center",backdrop:"static",keyboard:false,alwaysShow:true});s.getCode=function(e){if(!validEmail(s.providerCompletion.email)){l.add("请输入正确的邮箱地址","danger");return false}s.showCaptcha().then(function(e){if(s.providerCompletion.getCodeDisabled){return false}var t={newEmail:s.providerCompletion.email,verifyCode:e.verifyCode,verifyCodeNo:e.verifyCodeNo};i.run({url:"/api/v1/send_binding_user_email_email.json",urlParam:null}).post(t,function(e){if(e.status===0){var t=60;s.providerCompletion.getCodeDisabled=true;s.providerCompletion.verifyCodeTipText=t+"s重新发送";var i=a(function(){if(t==0){a.cancel(i);s.providerCompletion.getCodeDisabled=false;s.providerCompletion.verifyCodeTipText="获取验证码"}else{t--;s.providerCompletion.verifyCodeTipText=t+"s重新发送"}},1e3)}else{s.providerCompletion.getCodeDisabled=false;l.add(e.result.error_description,"danger")}})})};s.openCalendar=function(e){e.preventDefault();e.stopPropagation();if(s.providerCompletion.showCalendar){s.providerCompletion.showCalendar=false}else{s.providerCompletion.showCalendar=true}};s.showCaptcha=function(){var t=r.defer();var i=n.$new();i.rnd=Date.now();i.verifyCodeNo=eweiCommon.uuid(32,16).toLowerCase();var e=o({scope:i,title:"图形验证码",template:"source/views/system_setting/captcha_modal.html",html:true,show:true,placement:"center"});i.hideCaptchaModal=function(){e.$promise.then(e.hide)};i.onOk=function(e){if(!e){l.add("请输入图形验证码!","danger");return}i.hideCaptchaModal();t.resolve({verifyCode:e,verifyCodeNo:i.verifyCodeNo})};i.refreshCaptcha=function(){i.rnd=Date.now()};return t.promise};s.$ok=function(){if(s.submitting){return false}if(!s.providerCompletion.name){l.add("请输入你的姓名","danger");return false}if(!validEmail(s.providerCompletion.email)){l.add("请输入正确的邮箱地址","danger");return false}if(!s.providerCompletion.verifyCode){l.add("请输入验证码","danger");return false}if(!s.providerCompletion.email){l.add("请输入正确的邮箱地址","danger");return false}if(s.providerCompletion.launchPlanned&&!s.providerCompletion.launchTime){l.add("请选择计划上线日期","danger");return false}var e={scene:s.providerCompletion.scene,name:s.providerCompletion.name,email:s.providerCompletion.email,verifyCode:s.providerCompletion.verifyCode,employees:s.providerCompletion.employees||"",launchPlanned:s.providerCompletion.launchPlanned,launchTime:s.providerCompletion.launchTime?moment(s.providerCompletion.launchTime).format("YYYY-MM-DD"):""};s.submitting=true;org.ewei.sdk.OpenProviderApi().completedProviderInfo(e).then(function(e){s.submitting=false;if(e){s.showTrialTip=true;t.user.email=s.providerCompletion.email;c.$promise.then(c.hide)}},function(e){s.submitting=false;l.add(e?e.error_description?e.error_description:JSON.stringify(e):"result is null","danger")})};s.hideTip=function(){s.showTrialTip=false}}})();(function(S){"use strict";S.module("eweiApp.account").controller("customerDetailController",e).controller("helpCenterFootprintsController",t).controller("chatLogsController",i);e.$inject=["$scope","$http","userService","alertService","utils","$state","$stateParams","$filter","$modal_","permissions","locker","groupUserTicketChainService"];function e(s,i,t,a,r,n,o,l,c,e,u,d){var p="";var f=null;s.displayNameView=false;s.displayNotes=false;s.externalUrlAuthorize={};s.userExternalIdValueUrl="";s.editableCustomer=e.hasPermission("customer_update");s.userNotes={text:"点击编辑客户备注",showEdit:false};var m=function(){var e=[];var t=u.driver("session").namespace("eweiApp.account").get("accountFlowMap");var i=u.driver("session").namespace("eweiApp.account").get("userGroupNum");if(t&&t.length){e=_.reject(t,function(e){return e.id==o.id});u.driver("session").namespace("eweiApp.account").put("accountFlowMap",e);s.showNextAccountBtn=e.length>0&&i==0;s.viewNextAccount=function(){u.driver("session").namespace("eweiApp.account").put("accountFlowPre","customers_detail"+o.id);n.go("customers_detail",{id:e[0].id,viewAccountList:e})}}};var g=function(e){if(e.requester!=null){f=e.requester.id}else if(e.user!=null){f=e.user.id}else{f=e.id}};var v=function(){if(s.customer!=null){s.oldMobilePhone=s.customer.contactMobilePhone;s.oldPhone=s.customer.phone;s.oldExternalId=s.customer.externalId;s.oldEmail=s.customer.contactEmail;s.oldNickname=s.customer.nickname;s.oldName=s.customer.name;s.oldNotes=s.customer.notes;if(s.customer.notes!=null&&s.customer.notes!=""){s.userNotes.text=s.customer.notes}var e=r.findTabByIdAndStateName("customers_detail"+s.customer.id,"customers_detail");var t=u.driver("session").namespace("eweiApp.account").get("accountFlowPre");var i=r.findTabByIdAndStateName(t,"customers_detail");if(e==null){if(S.isObject(i)){i.id="customers_detail"+s.customer.id;i.title=(s.customer.nickname!=undefined?s.customer.nickname:s.customer.name)||(s.customer.notes!=undefined?s.customer.notes:s.customer.name);i.params={id:s.customer.id}}else{r.addTab("customers_detail"+s.customer.id,s.customer.name,"customers_detail",{id:s.customer.id},"")}}else{e.active=true}}};var h=function(){if(s.ticket==null){s.customer=null}else{s.customer=s.ticket.requester;s.oldMobilePhone=s.customer.contactMobilePhone;s.oldPhone=s.customer.phone;s.oldExternalId=s.customer.externalId;s.oldEmail=s.customer.contactEmail;s.oldNickname=s.customer.nickname;s.oldName=s.customer.name;s.oldNotes=s.customer.notes;if(s.customer.notes!=null&&s.customer.notes!=""){s.userNotes.text=s.customer.notes}}};var y=function(){i.get("/ticket_count_by_user_id/"+f+".json").success(function(e){s.countTicketByUserId=e.id});i.get("/count_question_user_id/"+f+".json").success(function(e){s.countQuestionByUserId=e.id});i.get("get_external_url_authorize.json").success(function(e){if(e.success&&e.json){s.externalUrlAuthorize=e.json;var t=e.json.userExternalIdUrl;if(t){if(t.toLowerCase().indexOf("http://")>=0||t.toLowerCase().indexOf("https://")>=0){p=t}else{p="http://"+t}if(t.indexOf("?")<0){s.fromParams="?"}else{s.fromParams="&"}s.externalIdValueChange()}}})};var k=function(){if(s.webchat==null){s.customer=null}else{s.customer=s.webchat.user;s.oldMobilePhone=s.customer.contactMobilePhone;s.oldPhone=s.customer.phone;s.oldExternalId=s.customer.externalId;s.oldEmail=s.customer.contactEmail;s.oldNickname=s.customer.nickname;s.oldName=s.customer.name;s.oldNotes=s.customer.notes;if(s.customer.notes!=null&&s.customer.notes!=""){s.userNotes.text=s.customer.notes}}};var C=function(e,t,i){var n=r.findTabByIdAndStateName(e+i,e);if(n==null){r.addTab(e+i,t,e,{id:i},"")}else{n.active=true}};var b=function(){if(undefined!==s.webchat){C("webchats_new.detail",s.webchat.firstMessage||"#"+s.webchat.id,s.webchat.id)}else if(undefined!==s.ticket){C("tickets_detail",s.ticket.subject,s.ticket.id)}else if(undefined!==s.customer){C("customers_detail",s.customer.name,s.customer.id)}};var w=function(){var t={};var e=n.current.name;if(e.indexOf("customers_detail")>=0){s.customer={id:o.id};if(e.indexOf(".tickets")==-1){n.go("customers_detail.tickets",{status:"all_ticket"})}d.run("user",o.id,function(e){t=s.customer=e.json;b();g(t);y();v()})}else if(e.indexOf("requester_tickets_detail")>=0){s.ticket=o.ticket||{id:o.id};if(e.indexOf(".tickets")==-1){n.go("requester_tickets_detail.tickets",{status:"all_ticket"})}if(o.ticket){b();g(s.ticket);h();s.customer=s.ticket.requester;d.run("user",s.ticket.requester.id,function(e){t=s.customer=e.json;y()})}else{d.run("ticket",o.id,function(e){s.ticket=e.result;b();g(s.ticket);h();s.customer=s.ticket.requester;d.run("user",s.ticket.requester.id,function(e){t=s.customer=e.json;y()})})}}else if(e.indexOf("webchat_requester_detail")>=0){s.webchat={id:o.id};if(e.indexOf("webchat")==-1){n.go("webchat_requester_detail.tickets",{status:"all_ticket"})}d.run("webchat",o.id,function(e){s.webchat=e.result;s.ticket=s.webchat.ticket;b();g(s.webchat);s.customer=s.webchat.user;d.run("user",s.webchat.user.id,function(e){t=s.customer=e.json;y()})})}};var T=function(){m();w()};T();s.updateNotes=function(){_hmt.push(["_trackEvent","客户详情操作","编辑客户备注"]);var e="";if(s.customer.notes!=undefined){if(s.oldNotes!=s.customer.notes){e=s.customer.notes;i({url:"/update_user_notes.json",method:"POST",params:{userId:s.customer.id,notes:e}}).success(function(e,t,i,n){if(e.success){a.add("修改客户备注成功");s.oldMobilePhone=s.customer.contactMobilePhone;s.oldNotes=s.customer.notes}else{a.add("修改客户备注失败","danger")}if(s.customer.notes==null||s.customer.notes==""){s.userNotes.text="点击编辑客户备注"}else{s.userNotes.text=s.customer.notes}s.displayNotes=false})}else{s.displayNotes=false}}};s.externalIdValueChange=function(){if(p!=""){var e=new String(p);if(e.indexOf("{value}")>0){e=e.replaceAll("{value}",s.customer.externalId)}else{e=e+s.customer.externalId}s.userExternalIdValueUrl=e}};s.goTickets=function(){if(s.webchat!=null){n.go("webchat_requester_detail.tickets",{status:"all_ticket"})}else if(s.ticket!=null){n.go("requester_tickets_detail.tickets",{status:"all_ticket"})}else{n.go("customers_detail.tickets",{status:"all_ticket"})}};s.goHelpCenterFootprints=function(){if(s.webchat!=null){n.go("webchat_requester_detail.requester_webchat_help_center_footprints")}else if(s.ticket!=null){n.go("requester_tickets_detail.requester_tickets_help_center_footprints")}else{n.go("customers_detail.help_center_footprints")}};s.goChatLogs=function(){if(s.webchat!=null){n.go("webchat_requester_detail.requester_webchat_chat_logs")}else if(s.ticket!=null){n.go("requester_tickets_detail.requester_tickets_chat_logs")}else{n.go("customers_detail.chat_logs")}};s.updateMobilePhone=function(){if(s.oldMobilePhone!=s.customer.contactMobilePhone){if(s.customer.contactMobilePhone&&!validMobilePhone(s.customer.contactMobilePhone)){a.add("联系手机格式不正确","danger","left");return}i({url:"/update_user_contact_mobile_phone.json",method:"POST",data:{id:s.customer.id,contactMobilePhone:s.customer.contactMobilePhone}}).success(function(e,t,i,n){if(e.success){s.oldMobilePhone=s.customer.contactMobilePhone}else{if(e.message!=undefined){a.add(l("translate")(e.message),"danger","left")}else{a.add("修改客户手机失败","danger","left")}}})}};s.updatePhone=function(){if(s.oldPhone!=s.customer.phone){var e=/^[0-9]*[1-9][0-9]*$/i;if(!e.test(s.customer.phone)&&s.customer.phone!=""){a.add("电话号码格式不正确","danger","left");return}i({url:"update_user_phone.json",method:"POST",data:{id:s.customer.id,phone:s.customer.phone}}).success(function(e,t,i,n){if(e.success){s.oldPhone=s.customer.phone}else{a.add("修改客户电话失败","danger","left")}})}};s.updateExternalId=function(){if(s.oldExternalId!=s.customer.externalId){i({url:"update_external_id.json",method:"POST",data:{id:s.customer.id,externalId:s.customer.externalId}}).success(function(e,t,i,n){if(e.success){s.oldExternalId=s.customer.externalId}else{if(e.message!=undefined){a.add(l("translate")(e.message),"danger","left")}else{a.add("修改ExternalId失败","danger","left")}}})}};s.updateShared=function(){i({url:"update_shared.json",method:"POST",data:{id:s.customer.id,shared:s.customer.shared}}).success(function(e,t,i,n){if(e.success){}else{a.add("修改共享工单属性失败","danger","left")}})};s.updateEmail=function(){if(s.oldEmail!=s.customer.contactEmail||!s.oldEmail){var e=/^([a-zA-Z0-9-&._]+)@[a-zA-Z0-9-]([._]?[a-zA-Z0-9-])*(\.\w{2,6})+$/i;if(!e.test(s.customer.contactEmail)&&s.customer.contactEmail!=""){a.add("联系邮箱格式不正确","danger","left");return}i({url:"update_contact_email.json",method:"POST",data:{id:s.customer.id,contactEmail:s.customer.contactEmail}}).success(function(e,t,i,n){if(e.success){s.oldEmail=s.customer.contactEmail}else{if(e.message!=undefined){a.add(l("translate")(e.message),"danger","left")}else{a.add("修改Email失败","danger","left")}}})}};s.updateNickname=function(){if(!s.customer.nickname){a.add("客户昵称不能为空","danger","left");s.customer.nickname=s.oldNickname;return}if(s.oldNickname!=s.customer.nickname){i({url:"update_nickname.json",method:"POST",data:{id:s.customer.id,nickname:s.customer.nickname}}).success(function(e,t,i,n){if(e.success){s.oldNickname=s.customer.nickname}else{a.add("修改客户昵称失败","danger","left")}})}};s.mouseoverName=function(){s.displayNameView=true};s.mouseoverNotes=function(){s.displayNotes=true};s.mouseoutName=function(){s.displayNameView=false};s.mouseoutNotes=function(){s.displayNotes=false};s.updateName=function(){if(s.customer.name!=null){if(s.oldName!=s.customer.name){i({url:"update_name.json",method:"POST",data:{id:s.customer.id,name:s.customer.name}}).success(function(e,t,i,n){if(e.success){s.oldName=s.customer.name;s.displayNameView=false;a.add("修改客户姓名成功")}else{a.add("修改客户姓名失败","danger","left")}})}else{s.displayNameView=false}}else{s.customer.name=s.oldName}};s.addTicket=function(){var e=r.countByStateName("tickets_new.normal")+1;r.addTab("tickets_new"+e,"新建工单","tickets_new.normal",{id:e,type:"normal",requesterId:s.customer.id},"");n.go("tickets_new.normal",{id:e,type:"normal",requesterId:s.customer.id})};s.merge=function(){_hmt.push(["_trackEvent","合并客户","合并到另一个客户"]);s.mergeUser={};var t=c({scope:s,title:"合并到另一个客户",contentTemplate:"source/views/customer/merge_to_other_user.html",html:true,show:true,placement:"center"});s.$ok=function(){_hmt.push(["_trackEvent","合并客户-合并到另一个客户","确认"]);i({url:"merge_customer_to_other.json",method:"post",data:{sourceCustomerId:s.customer.id,targetCustomerId:s.mergeUser.targetUserNo}}).success(function(e){t.$promise.then(t.hide);if(e.success){a.add("合并成功");r.removeActiveTab(n)}else{a.add("请检查用户ID是否输入正确!","danger")}})};s.hideCustomer=function(){_hmt.push(["_trackEvent","合并客户-合并到另一个客户","取消"])}};s.modifyAccount=function(){s.newUser={userId:s.customer.id,email:s.customer.email||"",mobilePhone:s.customer.mobilePhone||""};var e=c({scope:s,title:"修改账号",contentTemplate:"source/views/customer/update_customer_account.html",html:true,show:true,placement:"center"});s.hideModal=function(){e.$promise.then(e.hide)};s.blurMobilePhoneOrEmail=function(){if(!s.newUser.email){s.newUser.email=s.customer.email}if(!s.newUser.mobilePhone){s.newUser.mobilePhone=s.customer.mobilePhone}};var t=/^([a-zA-Z0-9-&._]+)@[a-zA-Z0-9-]([._]?[a-zA-Z0-9-])*(\.\w{2,6})+$/i;s.$save=_.debounce(function(){if(s.newUser.email&&!t.test(s.newUser.email)){a.add("请输入正确的邮箱!","danger");return}if(s.newUser.mobilePhone&&!validMobilePhone(s.newUser.mobilePhone)){a.add("请输入正确的手机号码!","danger");return}org.ewei.sdk.OpenAccountApi().updateCustomerAccount(s.newUser).then(function(e){s.hideModal();a.add("修改成功");s.customer.email=s.newUser.email;s.customer.mobilePhone=s.newUser.mobilePhone},function(e){if(e&&e.error_description){a.add("修改失败,"+e.error_description,"danger")}else{a.add("修改失败,请重试。","danger")}})},500);s.hideBlack=function(){_hmt.push(["_trackEvent","客户详情操作-重置密码","取消"])}};s.resetPassword=function(){s.resetPasswordModel={userId:s.customer.id,password:"",notifyWithMail:false,notifyWithSMS:false};var e=c({scope:s,title:"设置密码",contentTemplate:"source/views/customer/update_customer_password.html",html:true,show:true,placement:"center"});s.hideModal=function(){e.$promise.then(e.hide)};var t=/^[ !"#$%&'()*+,-./0123456789:;<=>?@ABCDEFGHIJKLMNOPQRSTUVWXYZ[\]^_`abcdefghijklmnopqrstuvwxyz{|}~]{6,16}$/;s.$save=_.debounce(function(){if(s.resetPasswordModel.password&&!t.test(s.resetPasswordModel.password)){a.add("密码格式不正确，只能是字母、数字、常用字符或组合 ，长度在6-16位之间，请修改！","danger");return}org.ewei.sdk.OpenAccountApi().updateCustomerPassword(s.resetPasswordModel).then(function(e){s.hideModal();a.add("修改成功")},function(e){if(e&&e.error_description){a.add(e.error_description,"danger")}else{a.add("修改失败！请重试。","danger")}})},500);s.hideBlack=function(){_hmt.push(["_trackEvent","客户详情操作-重置密码","取消"])}};s.switchBlacklist=function(){if(s.customer.valid){_hmt.push(["_trackEvent","客户详情操作","加入黑名单"]);s.confirmContent="您确定要将此客户 "+s.customer.name+" 加入黑名单吗？"}else{_hmt.push(["_trackEvent","客户详情操作","移出黑名单"]);s.confirmContent="您确定要将此客户 "+s.customer.name+" 移出黑名单吗？"}var e=c({scope:s,title:"确认",contentTemplate:"source/views/confirm_template.html",html:true,show:true,placement:"center"});s.hideModal=function(){e.$promise.then(e.hide)};s.$ok=function(){if(s.customer.valid){_hmt.push(["_trackEvent","客户详情操作-加入黑名单","确认"])}else{_hmt.push(["_trackEvent","客户详情操作-移出黑名单","确认"])}i({url:"update_valid.json",method:"POST",data:{id:s.customer.id,valid:!s.customer.valid}}).success(function(e,t,i,n){s.hideModal();if(e.success){s.customer.valid=!s.customer.valid}else{a.add("操作失败","danger")}})};s.hideBlack=function(){if(s.customer.valid){_hmt.push(["_trackEvent","客户详情操作-加入黑名单","取消"])}else{_hmt.push(["_trackEvent","客户详情操作-移出黑名单","取消"])}}};s.deleteCustomer=function(){_hmt.push(["_trackEvent","客户详情操作","删除"]);s.confirmContent="您确定要删除此客户 "+s.customer.name+" 吗？";var e=c({scope:s,title:"确认",contentTemplate:"source/views/confirm_template.html",html:true,show:true,placement:"center"});s.hideModal=function(){e.$promise.then(e.hide)};s.$ok=function(){t["delete"]({id:s.customer.id},function(e){s.hideModal();if(e.success){if(s.showNextAccountBtn){r.removeActiveTab(n);s.viewNextAccount()}else{r.removeActiveTab(n)}}else{a.add("删除失败","danger")}})}}}t.$inject=["$scope","$http","userService","alertService","utils","$state","$stateParams"];function t(s,e,t,i,n,a,r){s.questViewItem="question_i_subscription";s.setQuestViewItem=function(e){s.questViewItem=e};e({url:"vote_count_user/"+s.customer.id+".json",method:"GET",data:{}}).success(function(e,t,i,n){if(e.success){s.voteCountMine=e.json.voteCount}});e({url:"question_user_subscription/"+s.customer.id+".json",method:"GET",data:{}}).success(function(e,t,i,n){if(e.success){s.questionsISubscription=e.json}else{void 0}});e({url:"question_user/"+s.customer.id+".json",method:"GET",data:{}}).success(function(e,t,i,n){if(e.success){s.questionsMine=e.json}else{void 0}});e({url:"question_user_answer/"+s.customer.id+".json",method:"GET",data:{}}).success(function(e,t,i,n){if(e.success){s.questionIAnswer=e.json}else{void 0}});e({url:"question_user_comment/"+s.customer.id+".json",method:"GET",data:{}}).success(function(e,t,i,n){if(e.success){s.questionIComment=e.json}else{void 0}})}i.$inject=["$scope","$http","userService","alertService","utils","$state","$stateParams"];function i(t,e,i,n,s,a,r){t.currentChatLogPage=1;t.chatLogs=[];t.getChatLogs=function(){e.get("customer_history_chatLog_list/"+t.customer.id+".json",{params:{_page:t.currentChatLogPage,_count:10}}).success(function(e){if(e.json&&e.json.length>0){t.chatLogs=t.chatLogs.concat(e.json)}})};t.getChatLogs();t.showMore=function(){t.currentChatLogPage+=1;t.getChatLogs()}}})(angular);angular.module("eweiApp.account").controller("viewListByCustomerController",["$rootScope","$scope","$state","$filter","permissions","viewService","coreModelService","coreNotifyService","apiCustomerViewsService",function(e,n,s,i,t,a,r,o,l){var c=o.constant.EVENT_DETAIL_CUSTOMERS_VIEWS;var u=this.__proto__.constructor.name+"_"+Date.now();var d={_count:9,_do_count:false,_filter:"{'$in':{'type':['user','userGroup']}}",_asc:"position",_page:1};var p;var f=function(){m()};var m=function(){g();if(JSON.stringify(d)!==JSON.stringify(p)){v();p=angular.copy(d)}};var g=function(){var e=r.list.customers.views.gets(d._page);var t=n.views=r.detail.customers.views.gets(e);if(n.views&&n.views.length>0){angular.forEach(n.views,function(e){if(e.title=="VIEW_TITLE_USER_BLACKLIST"){e.permission="customer_blacklist_manage"}else{e.permission=""}if(e.type=="user"||e.type=="userGroup"){e.module="customer_manage"}});if(s.current.name==="customer_views"||s.current.name==="customer_views.detail"){var i=r.config.route.get("customer_views.detail");if(!i){i={name:"customer_views.detail",params:{id:n.views[0].id,type:n.views[0].type}}}s.go(i.name,i.params);n.$broadcast(i.params.type+"ListViewLoad")}}};var v=function(){l.run(c,d,{},function(e){})};var h=function(){o.register(u,c,function(){m()})};h();f();n.$on("$destroy",function(){o.unRegister(u)});n.clickEvent=function(e){var t=i("translate")(e.title);if(t){_hmt.push(["_trackPageview","/用户管理/子级页面/"+t]);_hmt.push(["_trackEvent","用户管理",t])}}}]).controller("viewCustomerListController",["$rootScope","$scope","$stateParams","$filter","userService","userGroupService","utils","$state","$timeout","ngTableParams","$http","alertService","$upload","$modal_","permissions","$location","locker","license","providerJudgement","apiRestfulService","ConsoleConfig","coreModelService","coreNotifyService","apiCustomerService","apiCustomFieldListShowService","apiCustomerCustomFieldValueService","$ocLazyLoad","commonTools","DefaultColumnWidth",function(m,g,a,v,e,t,r,o,i,n,l,c,s,u,d,p,f,h,y,k,C,b,w,T,S,F,A,E,O){g.view={};var I;var L;var D="customers-"+a.id;var P=b.config.route.get("search."+D);var x=b.config.route.get("sort."+D);var N=this.__proto__.constructor.name+"_"+Date.now();g.advancedQueryCondition=P?P.advancedQueryCondition||{}:{};function M(){if(g.advancedQueryCondition.createdAtFrom!=null&&typeof g.advancedQueryCondition.createdAtFrom==="string"){g.advancedQueryCondition.createdAtFrom=E.parseDateTime(g.advancedQueryCondition.createdAtFrom,"yyyy-MM-dd HH:mm:ss")}if(g.advancedQueryCondition.createdAtTo!=null&&typeof g.advancedQueryCondition.createdAtTo==="string"){g.advancedQueryCondition.createdAtTo=E.parseDateTime(g.advancedQueryCondition.createdAtTo,"yyyy-MM-dd HH:mm:ss")}if(g.advancedQueryCondition.updatedAtFrom!=null&&typeof g.advancedQueryCondition.updatedAtFrom==="string"){g.advancedQueryCondition.updatedAtFrom=E.parseDateTime(g.advancedQueryCondition.updatedAtFrom,"yyyy-MM-dd HH:mm:ss")}if(g.advancedQueryCondition.updatedAtTo!=null&&typeof g.advancedQueryCondition.updatedAtTo==="string"){g.advancedQueryCondition.updatedAtTo=E.parseDateTime(g.advancedQueryCondition.updatedAtTo,"yyyy-MM-dd HH:mm:ss")}if(g.advancedQueryCondition.lastLoginAtFrom!=null&&typeof g.advancedQueryCondition.lastLoginAtFrom==="string"){g.advancedQueryCondition.lastLoginAtFrom=E.parseDateTime(g.advancedQueryCondition.lastLoginAtFrom,"yyyy-MM-dd HH:mm:ss")}if(g.advancedQueryCondition.lastLoginAtTo!=null&&typeof g.advancedQueryCondition.lastLoginAtTo==="string"){g.advancedQueryCondition.lastLoginAtTo=E.parseDateTime(g.advancedQueryCondition.lastLoginAtTo,"yyyy-MM-dd HH:mm:ss")}}g.argument={_page:1,_count:-1,_fields:"",_filter:"",_asc:x?x.order=="asc"?x.orderBy:"":"",_desc:x?x.order=="desc"?x.orderBy:"":"",searchType:P?P.searchType:null,advancedQueryCondition:P?P.advancedQueryCondition:null,searchKey:P?P.searchKey:null};M();g.argumentLast=angular.copy(g.argument);if(P&&P.searchType=="advancedQuery"){g.isAdvancedQuery=true}g.showCheckboxes=true;g.defaultSortParams={};g.serverDataLoaded=false;var j=false;g.placeholder="搜索分组名称/标签/email域名";var R=function(e){var t="w150";do{if("name"==e){t="w200";break}if("nickname"==e){t="w200";break}if("id"==e){t="w70";break}}while(0);return t};var U=function(e,t){for(var i in e){if(e[i]==t){return i}return""}};g.sorting=function(e){var t=g.tableParams.isSortBy(e.field,"desc");if(t){g.argument._asc=e.field;g.argument._desc=""}else{g.argument._desc=e.field;g.argument._asc=""}var i=g.tableParams.isSortBy(e.field,"desc")?"asc":"desc";e.sortable?g.tableParams.sorting(e.field,i):"";g.defaultSorting=e.field==g.defaultSortParams.orderBy&&i==g.defaultSortParams.order;x={order:i,orderBy:e.field}};var V=function(){var i=b.detail.fields.title.gets(b.list.fields.title.get(D).gets(1));g.columns=[];var n=[];if(g.view&&g.view.sortFields){g.view.sortFields=angular.fromJson(g.view.sortFields);angular.forEach(g.view.sortFields,function(e){for(var t=0;t<i.length;t++){if(i[t].id==e.id){n.push(i[t]);break}}})}n=n.length>0?n:i;var t=[];angular.forEach(n,function(e){g.columns.push({title:e.title,field:e.id,visible:true,sortable:e.systemFieldKey?true:false,widthClass:R(e.id),type:e.type,length:e.length});t.push(e.id)});b.list.fields.title.get(D).put(1,t);g.tableParams&&g.tableParams.reload()};var q=function(){g.tableParams=g.tableParams||new n({page:g.argument._page,count:g.argument._count,sorting:JSON.parse('{"'+g.view.orderBy+'":"'+g.view.order+'"}')},{counts:[],groupBy:function(e){if(g.searchKey!=null){return null}else{var t=g.view.groupBy;if(t==null||t==""){return null}var i=t.split(".");var n;var s=i.length;if(s==1){n=e[i[0]]}else if(s==2){if(e[i[0]]!=undefined){n=e[i[0]][i[1]]}}else if(s==3){if(e[i[0]]!=undefined&&e[i[0]][i[1]]!=undefined){n=e[i[0]][i[1]][i[2]]}}if(n==undefined){n="-"}var a="";if(t=="userGroup.name"){a="客户组："}return a+n}},total:0,getData:function(e,t){g.argument._page=angular.copy(t.page());b.list.customers.get(D).page(angular.copy(t.page()));H();t.total(b.list.customers.get(D).total());e.resolve(g.customers)}});if(x){g.tableParams.$params.sorting={};g.tableParams.$params.sorting[x.orderBy]=x.order}};var G=function(){S.run(D,w.constant.EVENT_LIST_FIELD_TITLE,1,"",{view_id:g.view.id},function(e){})};var K=function(){if(g.view&&g.view.customFields){var e=JSON.parse(g.view.customFields);var t=[];angular.forEach(e,function(e){t.push(e.id)});var i=b.list.customers.get(D).gets(g.argument._page).join(",");if(i&&i.length>0){F.run(D,w.constant.EVENT_DETAIL_CUSTOMERS,1,"",{customFieldIds:t.join(","),userIds:i},function(e){if(e){}})}}};var B=function(e){g.view=b.detail.customers.views.get(a.id);if(g.view){g.argument._fields=g.view.fields;g.argument._filter=g.view.filter;g.argument._page=b.list.customers.get(D).page();g.tableParams.page(g.argument._page);if(!x){if("desc"==g.view.order){g.argument._desc=g.view.orderBy}else if("asc"==g.view.order){g.argument._asc=g.view.orderBy}}g.defaultSortParams={order:g.view.order,orderBy:g.view.orderBy};g.defaultSorting=x?x.orderBy==g.defaultSortParams.orderBy&&x.order==g.defaultSortParams.order:true;G();if(angular.isString(g.view.customFields)&&angular.isString(g.view.customFieldsLength)){g.customFieldsLength={};var t=angular.fromJson(g.view.customFields);var i=g.view.customFieldsLength.split(",");if(angular.isDefined(t)&&t.length==i.length){t.forEach(function(e,t){g.customFieldsLength[parseInt(e.id)]=parseInt(i[t])})}}if(angular.isString(g.view.fields)&&angular.isString(g.view.fieldsLength)){g.fieldsLength={};var n=g.view.fields.split(",");var s=g.view.fieldsLength.split(",");if(n.length!=s.length&&n.length>s.length){n.splice(n.length-1,1)}if(n.length==s.length){n.forEach(function(e,t){if(e&&e.length>0){g.fieldsLength[e]=parseInt(s[t])}})}}if(g.view.title=="VIEW_TITLE_USER_BLACKLIST"){g.viewTitle="黑名单";g.columnType="user";if(!d.hasPermission("customer_blacklist_manage")){void 0;p.path("/unauthorized")}}if(g.view.title=="VIEW_TITLE_USER"){g.viewTitle="客户";g.columnType="user"}g.importData=null}};var Q=function(){z();V();q();B(a.id)};var H=function(){W();if(j&&JSON.stringify(g.argument)!=JSON.stringify(g.argumentLast)){J();g.argumentLast=angular.copy(g.argument)}};var W=function(){g.customers=b.detail.customers.gets(b.list.customers.get(D).gets(g.argument._page))};var J=function(){w.doNotify(w.constant.EVENT_LIST_DATA_LOADING,{typeKey:D,isLoading:true});T.run(D,w.constant.EVENT_LIST_CUSTOMER_REFRESH,g.argument._page,"",g.argument,function(e){w.doNotify(w.constant.EVENT_LIST_DATA_LOADING,{typeKey:D,isLoading:false})})};var z=function(){w.register(N,w.constant.EVENT_LIST_CUSTOMER_REFRESH,function(e){K();g.tableParams.reload()});w.register(N,w.constant.EVENT_DETAIL_CUSTOMERS,function(e,t){angular.forEach(g.customers,function(e){if(e.id==t.id){e=b.detail.customers.get(t.id)}})});w.register(N,w.constant.EVENT_LIST_FIELD_TITLE,function(e){V()});w.register(N,w.constant.EVENT_LIST_DATA_LOADING,function(e,t){if(t.typeKey==D){g.serverDataLoaded=true;if(g.customers&&g.customers.length>0){g.isCustomerLoading=false}else{g.isCustomerLoading=t.isLoading;if(!t.isLoading&&g.customers&&g.customers.length==0){g.noDataTip="没有相关数据"}}}})};Q();var Y=function(){w.unRegister(N)};g.$on("userListViewLoad",function(){B(a.id);V()});g.$on("$destroy",function(){Y();b.config.route.put("search."+D,{searchType:g.argument.searchType,advancedQueryCondition:g.argument.advancedQueryCondition,searchKey:g.argument.searchKey});if(x){b.config.route.put("sort."+D,x)}else{b.config.route.remove("sort."+D)}b.config.forceSave()});g.createUser=function(){m.$broadcast("createNewUser")};g.clearSorting=function(){delete g.argument._asc;delete g.argument._desc;if(g.defaultSortParams.order&&g.defaultSortParams.orderBy){if(g.defaultSortParams.order=="asc"){g.argument._asc=g.defaultSortParams.orderBy}else{g.argument._desc=g.defaultSortParams.orderBy}}g.defaultSorting=true;x=null;g.argumentLast=null;g.tableParams.$params.sorting={};g.tableParams.$params.sorting[g.defaultSortParams.orderBy]=g.defaultSortParams.order;g.tableParams.reload()};g.advancedQuery=function(){g.advancedQueryError="";if(g.advancedQueryCondition.lastLoginAtFrom==null&&g.advancedQueryCondition.lastLoginAtTo==null&&g.advancedQueryCondition.userGroup==null&&g.advancedQueryCondition.createdAtFrom==null&&g.advancedQueryCondition.createdAtTo==null&&g.advancedQueryCondition.updatedAtFrom==null&&g.advancedQueryCondition.updatedAtTo==null&&g.advancedQueryCondition.name==null&&g.advancedQueryCondition.nickname==null&&g.advancedQueryCondition.email==null&&g.advancedQueryCondition.mobilePhone==null&&g.advancedQueryCondition.phone==null&&(g.advancedQueryCondition.haveUserGroup==null||g.advancedQueryCondition.haveUserGroup=="")){g.advancedQueryError="查询条件不能为空";return}g.isAdvancedQuery=true;advancedQueryConditionByParam=angular.copy(g.advancedQueryCondition);if(g.advancedQueryCondition.createdAtFrom!=null){advancedQueryConditionByParam.createdAtFrom=v("date")(g.advancedQueryCondition.createdAtFrom,"yyyy-MM-dd HH:mm:ss")}if(g.advancedQueryCondition.createdAtTo!=null){advancedQueryConditionByParam.createdAtTo=v("date")(g.advancedQueryCondition.createdAtTo,"yyyy-MM-dd HH:mm:ss")}if(g.advancedQueryCondition.updatedAtFrom!=null){advancedQueryConditionByParam.updatedAtFrom=v("date")(g.advancedQueryCondition.updatedAtFrom,"yyyy-MM-dd HH:mm:ss")}if(g.advancedQueryCondition.updatedAtTo!=null){advancedQueryConditionByParam.updatedAtTo=v("date")(g.advancedQueryCondition.updatedAtTo,"yyyy-MM-dd HH:mm:ss")}if(g.advancedQueryCondition.lastLoginAtFrom!=null){advancedQueryConditionByParam.lastLoginAtFrom=v("date")(g.advancedQueryCondition.lastLoginAtFrom,"yyyy-MM-dd HH:mm:ss")}if(g.advancedQueryCondition.lastLoginAtTo!=null){advancedQueryConditionByParam.lastLoginAtTo=v("date")(g.advancedQueryCondition.lastLoginAtTo,"yyyy-MM-dd HH:mm:ss")}g.argument.searchType="advancedQuery";g.argument.advancedQueryCondition=advancedQueryConditionByParam;if(g.argument._page!=1){g.tableParams.page(1)}else{g.tableParams.reload()}$("#queryModal").modal("hide")};g.clearSearch=function(){if(g.argument.searchKey!=null||g.isAdvancedQuery){g.oldSearchKey=null;g.isAdvancedQuery=false;g.advancedQueryCondition={};g.argument.advancedQueryCondition={};g.argument.searchKey="";g.argument.searchType="";g.argumentLast=null;b.config.route.remove("customer-search."+D);b.config.forceSave();if(g.argument._page!=1){g.tableParams.page(1)}else{g.tableParams.reload()}}};g.search=function(e){_hmt.push(["_trackEvent","用户管理","搜索用户"]);if(g.argument.searchKey==""){g.clearSearch()}else{if(g.argument.searchKey!=g.oldSearchKey){g.oldSearchKey=g.argument.searchKey;g.argument.searchType="searchKeyQuery";if(g.argument._page!=1){g.tableParams.page(1)}else{g.tableParams.reload()}}}};g.setRows=function(e){if(!g.tableParams)return;j=true;var t=g.tableParams.count();if(e==t)return;g.tableParams.count(e);g.argument._count=e;g.tableParams.page(g.argument._page);g.tableParams.getData(g.tableParams)};g.checkboxes={checked:false,items:{}};g.$watch("checkboxes.checked",function(t){angular.forEach(g.customers,function(e){if(angular.isDefined(e.id)){g.checkboxes.items[e.id]=t}})});g.$watch("checkboxes.items",function(e){if(!g.customers){return}var t=0,i=0,n=g.customers.length;angular.forEach(g.customers,function(e){t+=g.checkboxes.items[e.id]||0;i+=!g.checkboxes.items[e.id]||0});if(i==0||t==0){g.checkboxes.checked=t==n}angular.element(document.getElementById("select_all")).prop("indeterminate",t!=0&&i!=0);g.hasSelected=false;for(var s in g.checkboxes.items){if(g.checkboxes.items[s]){g.hasSelected=true;break}g.hasSelected=false}},true);var X=function(){var e=[];for(var t in g.checkboxes.items){if(g.checkboxes.items[t]){e.push(t)}}g.checkboxes.items={};return e};g.cancelAllSelected=function(){g.checkboxes={checked:false,items:{}}};g.settingUserGroup=function(){Z();var e=u({scope:g,title:"移入一个客户组",contentTemplate:"source/views/select_user_group_template.html",html:true,show:true,placement:"center"});g.hideModal=function(){e.$promise.then(e.hide)};g.$ok=function(e){var t;var i=X();if(e==null){t={ids:i.join(","),userGroupId:null}}else{t={ids:i.join(","),userGroupId:e.id,shared:e.shared}}l({url:"batch_update_user_group.json",method:"POST",data:t}).success(function(e,t,i,n){g.hideModal();if(e.success){J()}else{c.add("移入客户组失败","danger")}})}};var Z=function(){l.get("user_group_list.json?_count=999&_do_count=false&_fields=id,name,shared",{}).then(function(e){userAginLogin(e);g.userGroups=e.data.userGroups})};g.temp=function(e,t){g.available=true;g.actived=e;l.get("user/"+t.list.id+".json").success(function(e,t){var i="";g.userCustom=e.json;angular.forEach(g.userCustom.tags,function(e){if(i==""){i+=e.name}else{i+=","+e.name}});g.userCustom.list=i});l.get("user_custom_field.json?userId="+t.list.id).success(function(e,t){g.ticketMerge=e.json;return false})};g.checkedOption=[{option:"是",value:true},{option:"否",value:false}];g.mergeUser=function(){var t=X();if(t.length>5){c.add("最多选择五项合并。","danger");return false}else if(t.length<=1){c.add("最少选择两项合并。","danger");return false}var i=[];g.actived=100;g.available=false;g.userInfo={target:{}};g.selection="settings0";angular.forEach(g.customers,function(e){if(t.indexOf(e.id.toString())>-1){i.push(e)}});g.lists=i;g.form={};g.nextTo=function(){if(!g.form.selectRadio){c.add("请选择合并到哪一个客户","danger");return false}var e=JSON.parse(g.form.selectRadio);g.selection="settings1";org.ewei.sdk.OpenUserApi().getUserInfo({userId:e}).then({success:function(e){g.userInfo.target=e}});org.ewei.sdk.OpenUserCustomFieldApi().list({userId:e}).then({success:function(e){g.ticket=e}})};g.editBox=function(e){g.available=false;g.actived=e};var e=u({scope:g,template:"modal/modal.tpl.w670.html",contentTemplate:"source/views/customer/merge_user.html",html:true,show:true,placement:"center"});g.hideModal=function(){e.$promise.then(e.destroy)};g.$ok=function(){var n=true;angular.forEach(g.ticket.ticketCustomFields,function(e){var t=new RegExp(e.customField.regexpForValidation);if(e.value&&!t.test(e.value)&&n==true){c.add("请输入正确的"+e.customField.title,"danger");n=false}else if(e.customField.required==true&&(!e.value||e.value=="-")&&n==true){c.add("请输入"+e.customField.title,"danger");n=false}if(e.customField.type=="date"&&e.value){e.value=v("date")(e.value,"yyyy/MM/dd").toString()}else if(e.customField.type=="date_time"&&e.value){e.value=v("date")(e.value,"yyyy/MM/dd HH:mm:ss").toString()}if(e.customField.url){if(e.customField.url.toLowerCase().indexOf("http://")!=0){e.customField.url="http://"+e.customField.url}if(e.customField.url.indexOf("?")<0){e.fromParams="?"}else{e.fromParams="&"}var i=new String(e.customField.url);if(i.indexOf("{value}")>0){i=i.replaceAll("{value}",e.value)}else{i=i+e.value}e.valueUrl=i}});if(!n){return false}void 0;g.userInfo.userCustomFields=g.ticket.ticketCustomFields;g.userInfo.customerIds=t.join(",");var e=/^\s*([A-Za-z0-9_]+[_\-\.\w]*@([_\-\w]+\.)+[_\-\w]{2,3})\s*$/;if(g.userInfo.target.name==undefined||g.userInfo.target.name==""){c.add("用户名不能为空","danger");return false}else if(!verifyEmailAddress(g.userInfo.target.email)&&g.userInfo.target.email){c.add("邮箱格式错误","danger");return false}else if(!validMobilePhone(g.userInfo.target.mobilePhone)&&g.userInfo.target.mobilePhone){c.add("请输入正确的手机号","danger");return false}l({url:"merge_customer.json",method:"POST",data:g.userInfo}).success(function(e,t,i,n){if(e.success){g.hideModal();g.importData="success";J()}else{if(e.message!=undefined){c.add(v("translate")(e.message),"danger")}else{c.add("合并客户失败","danger")}}})}};g.blacklist=function(){_hmt.push(["_trackEvent","客户管理","加入黑名单"]);if(g.view.title=="VIEW_TITLE_USER"){g._messages="您确定要将这些客户加入黑名单吗？";g._title="加入黑名单确认"}else{g._messages="您确定要将这些客户移出黑名单吗？";g._title="移出黑名单确认"}var e=u({scope:g,title:g._title,contentTemplate:"source/views/alter_common.html",html:true,show:true,placement:"center"});g.hideModal=function(){e.$promise.then(e.hide)};g.$ok=function(){if(g.view.title=="VIEW_TITLE_USER"){_hmt.push(["_trackEvent","客户管理","加入黑名单-确认"])}else{_hmt.push(["_trackEvent","客户管理","移出黑名单-确认"])}var e=X();l({url:"batch_update_valid.json",method:"POST",data:{ids:e.join(","),valid:g.view.title=="VIEW_TITLE_USER"?false:true}}).success(function(e,t,i,n){g.hideModal();if(e.success){g.importData="success";J()}else{if(g.view.title=="VIEW_TITLE_USER"){c.add("加入黑名单失败","danger")}else{c.add("移出黑名单失败","danger")}}})};g.hideBlack=function(){if(g.view.title=="VIEW_TITLE_USER"){_hmt.push(["_trackEvent","客户管理-加入黑名单","取消"])}else{_hmt.push(["_trackEvent","客户管理-移出黑名单","取消"])}}};g.deleteUsers=function(){_hmt.push(["_trackEvent","客户","删除"]);g.confirmContent="您确定要删除这些客户吗？";var e=u({scope:g,title:"确认",contentTemplate:"source/views/confirm_template.html",html:true,show:true,placement:"center"});g.hideModal=function(){e.$promise.then(e.hide)};g.hideBlack=function(){_hmt.push(["_trackEvent","客户-删除","取消"])};g.$ok=function(){_hmt.push(["_trackEvent","客户-删除","确认"]);var s=X();l({url:"batch_delete_users.json",method:"POST",data:{ids:s.join(",")}}).success(function(e,t,i,n){g.hideModal();if(e.success){g.importData="success";c.add("删除成功","success");J();s.forEach(function(e){if(r.findTabById("customers_detail"+e)){r.removeTabById(o,"customers_detail"+e)}})}else{c.add("批量删除失败","danger")}})}};g.viewAccounList=function(){_hmt.push(["_trackEvent","客户管理","客户遍历"]);if(g.customers.length<=0){return false}f.driver("session").namespace("eweiApp.account").put("accountFlowMap",g.customers);f.driver("session").namespace("eweiApp.account").put("userGroupNum",0);o.go("customers_detail",{id:g.customers[0].id,viewAccountList:g.customers})};g.editList=function(){_hmt.push(["_trackEvent","客户管理","编辑列表"]);if(g.view.type=="user"){o.go("system_setting.detail",{uri:"user_custom_view",settingType:"customer"})}else if(g.view.type=="userGroup"){o.go("system_setting.detail",{uri:"user_group_custom_view",settingType:"customer"})}};var ee=function(e){try{var a=m.batchWorker=new Worker("/source/scripts/customer-batch-export.js");var t=JSON.parse(g.view.customFields||null);var r=_.map(t,function(e){return e.id});var o=angular.copy(g.columns);var i=[];for(var n=0;n<o.length;n++){if(o[n].field==="name"){o.splice(n+1,0,{title:"客户组",field:"userGroup",visible:true,sortable:true,widthClass:"w200",length:180})}i.push(o[n].title)}var s=[];s.push({A:"查询条件"});s.push({A:"一般查询",B:g.argument.searchKey||""});s.push({A:"高级查询"});s.push({A:"创建于：",B:e.createdAtFrom||"",C:"至：",D:e.createdAtTo||""});s.push({A:"更新于：",B:e.updatedAtFrom||"",C:"至：",D:e.updatedAtTo||""});s.push({A:"最近登录：",B:e.lastLoginAtFrom||"",C:"至：",D:e.lastLoginAtTo||""});s.push({A:"姓名：",B:e.name||"",C:"昵称：",D:e.nickname||""});s.push({A:"分组：",B:e.userGroup||"",C:"email：",D:e.email||""});s.push({A:"手机：",B:e.mobilePhone||"",C:"电话：",D:e.phone||""});var l=100;var c=g.tableParams.total();var u=XLSX.utils.json_to_sheet(s,{skipHeader:true});XLSX.utils.sheet_add_aoa(u,[i],{origin:{r:10,c:0}});var d=angular.extend({},g.argument);delete d._count;delete d._page;var p=0;var f=11;u["!cols"]=_.map(o,function(e){return{wpx:e.length||O.userFields[e.field]||180}});u["!merges"]=[{s:{c:0,r:0},e:{c:3,r:0}},{s:{c:1,r:1},e:{c:3,r:1}},{s:{c:1,r:2},e:{c:3,r:2}}];a.onmessage=function(e){if(!e.data||!e.data.type)return;switch(e.data.type){case"ready":{a.postMessage({type:"batch-getdata",pageSize:l,total:c,customFields:r,credential:{provider_id:C.provider.id,_token:getCookie("user_token")},params:d});break}case"started":{break}case"progress":{var n=[];var t=e.data.data.data.customers;t.forEach(function(t){var i=[];o.forEach(function(e){if(e.field==="userGroup"){t[e.field]=t[e.field]?t[e.field].name:""}else if(e.type==="checkbox"&&!t[e.field]){t[e.field]="false"}i.push(t[e.field])});n.push(i)});XLSX.utils.sheet_add_aoa(u,n,{origin:{r:f,c:0}});f+=t.length;p+=t.length;m.$broadcast("batch-progress",{finished:p,total:e.data.data.data._total});break}case"finished":{a.terminate();delete m.batchWorker;m.$broadcast("batch-finished",{finished:p,total:c,reason:e.data.data.reason});var i=XLSX.utils.book_new();var s=(v("translate")(g.view.title)||"").replace(/[\\\/\?\*\[\]\'\:\<\>\|\"]/g,"_")+moment().format("YYYYMMDDHHmm");XLSX.utils.book_append_sheet(i,u,s);XLSX.writeFile(i,s+".xlsx");break}}}}catch(e){m.batchWorker=undefined;m.$broadcast("batch-finished",{finished:p,total:g.tableParams.total(),reason:"error"})}};g.exportExcel=function(){if(m.batchWorker){c.add("上一个批量任务尚未结束，请稍后再试","danger");return}m.$broadcast("batch-started",{total:g.tableParams.total(),batchType:"customer-batch-export"});A.load(["source/lib/xlsx/xlsx.full.min.js"]).then(function(){ee(g.argument.advancedQueryCondition||{})},function(e){m.batchWorker=undefined;m.$broadcast("batch-finished",{finished:0,total:g.tableParams.total(),reason:"error"})});return};g.datepickers={startForm:false,startTo:false,updateFrom:false,updateTo:false};g.open=function(e,t){e.preventDefault();e.stopPropagation();g.datepickers[t]=true};g.downLoadfailureCustomerRecored=function(){g.hideBatchAddCustomerModal();var e="/download_import_user_failure_record?recordId="+g.recordId;window.open(e)};g.importUserComplete=false;g["import"]=function(){_hmt.push(["_trackEvent","客户管理","批量导入客户"]);var e="客户导入";if(g.view.type=="userGroup"){e="客户分组导入"}else{if(!y.isTrue()){return false}}var t=u({scope:g,title:e,contentTemplate:"source/views/customer/user_excel_url.choice.html",html:true,show:true,placement:"center",backdrop:"static"});g.hideBatchAddCustomerModal=function(){g.importUserComplete=false;t.$promise.then(t.hide)};g.fileIsNUll=false;g.datas=[];g.titles=[];g.options=[];g.titleOptions=[];g.customFieldIdMap={};g.$read=function(e){if(e==null||e==undefined||e.length<=0){return}g.fileIsNUll=true;g.fileName=e[e.length-1].name;var t="resolve_customer_excel.json";if(g.view.type=="userGroup"){t="resolve_usergroup_excel.json"}e.upload=s.upload({url:t,method:"POST",file:e});e.upload.then(function(e){if(e.data.success){var t=e.data.json;g.titles=t.titles;g.options=t.selectPropertyOptions;var i;for(var n=0,s=t.titles.length;n<s;n++){i=t.titles[n];var a={title:i};g.options.some(function(e){if(e.option===i){a.selectProperty=e.value;return true}});g.titleOptions.push(a)}g.datas=t.datas;g.customFieldIdMap=t.customFieldIdMap;g.fileIsNUll=true}else{var r=e.data.message;c.add(r+" 请查看详细说明","danger");g.fileIsNUll=false}void 0},function(e){g.uploading=false;g.errorMsg=e.status+": "+e.data});e.upload.progress(function(e){g.uploading=true;void 0});e.upload.xhr(function(e){e.upload.addEventListener("abort",function(){void 0;g.uploading=false},false)})};g.$explain=function(){var e=u({scope:g,title:"客户导入详细说明",contentTemplate:"source/views/customer/user_import_explain.html",html:true,show:true,placement:"center",backdrop:"static"})};g.$template=function(e){g.hideBatchAddCustomerModal();var t="/export_user_template?&templateType="+e;window.open(t)};g.importting=false;g.importCustomerOrGroup=function(e){var t=document.getElementById("repeatedCustomerUpdate");var i=false;if(t.checked===true){i=true}g.importting=true;var n="/import_user.json?update="+i;if(g.view.type=="userGroup"){n="/import_user_group.json?update="+i}l({url:n,method:"POST",timeout:18e4,data:e}).success(function(e,t,i,n){g.importting=false;if(e.success){g.failureCount=e.json.failureCount;g.successCount=e.json.successCount;g.recordId=e.json.recordId;g.importData="success";g.importUserComplete=true;g.tableParams.reload()}else if(e.data&&e.data.message){c.add(e.data.message,"danger")}else{c.add("请检查文件类型，格式！","danger")}g.uploading=false}).error(function(e,t,i,n){c.add("导入失败,请稍候再试！","danger");g.importting=false})};g.$save=function(){var e=g.titleOptions;var t=new Array;var i=new Array;for(var n=0;n<e.length;n++){var s=e[n].selectProperty;if(s==undefined||s==null||s==""){c.add("请选择完整!","danger");return}for(var a=0;a<t.length;a++){if(t[a]==e[n].selectProperty){c.add("选择重复!","danger");return}}for(var r=0;r<g.options.length;r++){if(g.options[r].value===e[n].selectProperty){i[n]=g.options[r].option;break}}t[n]=e[n].selectProperty}var o={};o.titles=g.titles;o.fileds=i;o.selectPropertys=t;o.datas=g.datas;o.customFieldIdMap=g.customFieldIdMap;g.importCustomerOrGroup(o)}}}]);(function(L){"use strict";L.module("eweiApp.account").controller("customerDetailTicketsController",e).controller("requesterTicketsHelpCenterFootprintsController",t).controller("requesterTicketsChatLogsController",i);e.$inject=["$scope","$http","alertService","utils","$state","$stateParams","$filter","ticketService","$timeout","ngTableParams","ticketEvaluateService","groupUserTicketChainService"];function e(s,a,e,t,i,n,r,o,l,c,u,d){var p="";var f={};var m=i.current.name;var g=n.status;var v;var h;var y=function(){_()};var _=function(){if(m=="user_group_requester_tickets_detail.tickets"){f=d.getData("ticket");if(!f.requester.userGroup){f.requester.userGroup=d.getData("userGroup")}p="{'$and':[{'$eq':{'requester.userGroup.id':"+f.requester.userGroup.id+"}},{'$eq':{'requester.type':'customer'}}]}";v=f.requester.userGroup.id}else if(m=="requester_tickets_detail.tickets"){f=d.getData("ticket");p="{'$eq':{'requester.id':"+f.requester.id+"}}";h=f.requester.id}else if(m=="webchat_user_group_detail.tickets"){f=d.getData("webchat");p="{'$and':[{'$eq':{'requester.userGroup.id':"+f.user.userGroup.id+"}},{'$eq':{'requester.type':'customer'}}]}";v=f.user.userGroup.id}else if(m=="webchat_requester_detail.tickets"){f=d.getData("webchat");if(f&&f.user){p="{'$eq':{'requester.id':"+f.user.id+"}}";h=f.user.id}else{var e=i.params.id;i.go("webchats_new.detail",{id:e},{reload:"webchats_new.detail"});return}}else if(m=="user_group_customers_detail.tickets"){f=d.getData("user");p="{'$and':[{'$eq':{'requester.userGroup.id':"+f.userGroup.id+"}},{'$eq':{'requester.type':'customer'}}]}";v=f.userGroup.id}else if(m=="customers_detail.tickets"){f=d.getData("user");p="{'$eq':{'requester.id':"+f.id+"}}";h=f.id}else if(m=="user_groups_detail.tickets"){f=d.getData("userGroup");p="{'$and':[{'$eq':{'requester.userGroup.id':"+f.id+"}},{'$eq':{'requester.type':'customer'}}]}";v=f.id}A();$()};s.go=function(e){i.go(i.current.name,{status:e})};var k=function(){var e=f.id;var t=true;if(f.requester){if(m.indexOf("group")>0){e=f.requester.userGroup.id;t=true}else{e=f.requester.id;t=false}}else if(f.user){if(m.indexOf("group")>0){e=f.user.userGroup.id;t=true}else{e=f.user.id;t=false}}else if(f.type=="customer"){if(m.indexOf("group")>0){e=f.userGroup.id;t=true}else{e=f.id;t=false}}else{}var i="Bdsi_count_by_user_id";var n="sovle_count_by_user_id";if(t){i="Bdsi_count_by_user_group_id";n="sovle_count_by_user_group_id"}a({url:i+"/"+e+"/"+g,method:"GET"}).success(function(e){if(e.id!=null){s.countbisd=e.id}else{s.countbisd="0"}});a({url:n+"/"+e+"/"+g,method:"GET"}).success(function(e){if(e.id!=null){s.countsovle=e.id}else{s.countsovle="0"}})};var C=function(){u.run(false,function(e){s.evaluate={solveds:[],scores:[]};s.evaluate.solveds=e.firstQuestionOptions;s.evaluate.scores=e.secondQuestionOptions})};var b=function(){s.columns=[{title:"工单编号",field:"no",visible:true,widthClass:"w100"},{title:"更新于",field:"updatedAt",visible:true,widthClass:"w200"},{title:"创建于",field:"createdAt",visible:true,widthClass:"w200"},{title:"主题",field:"subject",visible:true,widthClass:"w500"},{title:"状态",field:"status",visible:true,widthClass:"w100"},{title:"处理人",field:"engineer.user.name",fieldCount:3,field0:"engineer",field1:"user",field2:"name",visible:true,widthClass:"w150"},{title:"客服组",field:"serviceDesk.name",fieldCount:2,field0:"serviceDesk",field1:"name",visible:true,widthClass:"w150"}];s.fields="id,deleted,no,subject,createdAt,updatedAt,status,engineer.user.name,serviceDesk.name";var e="";if(v!=null){e=",{'$in':{'id':[${copy_to_customer_user_group_ticket_ids!}]}}";s.copyToUserGroupId=v}else if(h!=null){e=",{'$in':{'id':[${copy_to_user_ticket_ids!}]}}";s.copyToUserId=h}s.filter="{'$or':["+p+e+"]}";s.sorting={updatedAt:"desc"};s.statusLabel="所有工单"};var w=function(){s.columns=[{title:"工单编号",field:"no",visible:true,widthClass:"w100"},{title:"更新于",field:"updatedAt",visible:true,widthClass:"w200"},{title:"创建于",field:"createdAt",visible:true,widthClass:"w200"},{title:"主题",field:"subject",visible:true,widthClass:"w500"},{title:"状态",field:"status",visible:true,widthClass:"w100"},{title:"处理人",field:"engineer.user.name",fieldCount:3,field0:"engineer",field1:"user",field2:"name",visible:true,widthClass:"w150"},{title:"客服组",field:"serviceDesk.name",fieldCount:2,field0:"serviceDesk",field1:"name",visible:true,widthClass:"w150"}];s.fields="id,deleted,no,subject,createdAt,updatedAt,status,engineer.user.name,serviceDesk.name";s.filter="{'$and':["+p+",{'$in':{'status':['new','open','solved','pending','suspended']}}]}";s.sorting={updatedAt:"desc"};s.statusLabel="未关闭的"};var T=function(){s.columns=[{title:"关闭于",field:"updatedAt",visible:true,widthClass:"w200"},{title:"创建于",field:"createdAt",visible:true,widthClass:"w200"},{title:"主题",field:"subject",visible:true,widthClass:"w500"},{title:"处理人",field:"engineer.user.name",fieldCount:3,field0:"engineer",field1:"user",field2:"name",visible:true,widthClass:"w200"},{title:"满意度",field:"evaluate.score",fieldCount:2,field0:"evaluate",field1:"score",visible:true,widthClass:"w150"},{title:"解决否",field:"evaluate.solved",fieldCount:2,field0:"evaluate",field1:"solved",visible:true,widthClass:"w150"},{title:"客户意见",field:"evaluate.suggestion",fieldCount:2,field0:"evaluate",field1:"suggestion",visible:true,widthClass:"w100"}];s.fields="id,deleted,subject,createdAt,updatedAt,status,engineer.user.name,evaluate.score,evaluate.solved,evaluate.suggestion";s.filter="{'$and':["+p+",{'$eq':{'status':'closed'}}]}";s.sorting={updatedAt:"desc"};document.getElementById("span").style.display="";s.statusLabel="已关闭的";k();C()};var S=function(){s.columns=[{title:"工单编号",field:"no",visible:true,widthClass:"w100"},{title:"主题",field:"subject",visible:true,widthClass:"w500"},{title:"删除于",field:"deletedAt",visible:true,widthClass:"w200"},{title:"处理人",field:"deleter.user.name",fieldCount:3,field0:"deleter",field1:"user",field2:"name",visible:true,widthClass:"w200"},{title:"删除原因",field:"deleteReason",visible:true,widthClass:"w100"}];s.fields="id,deleted,no,subject,createdAt,updatedAt,deletedAt,status,engineer.user.name,deleteType,deleteReason,deleter.user.name";s.filter="{'$and':["+p+",{'$eq':{'status':'deleted'}}]}";s.sorting={updatedAt:"desc"};s.statusLabel="已删除的"};var F=function(){s.columns=[{title:"工单编号",field:"no",visible:true,widthClass:"w100"},{title:"主题",field:"subject",visible:true,widthClass:"w500"},{title:"客户",field:"requester.name",fieldCount:2,field0:"requester",field1:"name",visible:true,widthClass:"w200"},{title:"状态",field:"status",visible:true,widthClass:"w100"},{title:"处理人",field:"engineer.user.name",fieldCount:3,field0:"engineer",field1:"user",field2:"name",visible:true,widthClass:"w200"},{title:"客服组",field:"serviceDesk.name",fieldCount:2,field0:"serviceDesk",field1:"name",visible:true,widthClass:"w100"}];s.fields="id,deleted,no,subject,createdAt,updatedAt,status,engineer.user.name,serviceDesk.name,requester.name";if(v!=null){s.filter="{'$in':{'id':[${copy_to_user_group_ticket_ids!}]}}";s.copyToUserGroupId=v}else if(h!=null){s.filter="{'$in':{'id':[${copy_to_user_ticket_ids!}]}}";s.copyToUserId=h}s.sorting={updatedAt:"desc"};s.statusLabel="抄送的"};var A=function(){if(g=="all_ticket"){b()}else if(g=="not_closed"){w()}else if(g=="closed"){T()}else if(g=="deleted"){S()}else if(g=="cc"){F()}};var E=function(e,t){for(var i in e){if(e[i]==t){return i}return""}};var $=function(){s.tableParams=new c({page:1,count:30,sorting:s.sorting},{groupBy:function(e){return null},total:0,getData:function(i,n){o.query({_page:n.page(),_count:n.count(),_fields:s.fields,_filter:s.filter,_asc:E(n.sorting(),"asc"),_desc:E(n.sorting(),"desc"),copyToUserId:L.isDefined(s.copyToUserId)?s.copyToUserId:null,copyToUserGroupId:L.isDefined(s.copyToUserGroupId)?s.copyToUserGroupId:null,searchType:"nonCurrentUser"},function(t){if(t.tickets==undefined||t.tickets.length==0){}var e=O(t.tickets);if(e.length>0){I(e)}l(function(){n.total(t._total);var e=n.sorting()?r("orderBy")(t.tickets,n.orderBy()):t.tickets;i.resolve(e);s.showCheckboxes=false;if(e.length==0){s.noDataTip="没有相关数据"}},100)})}})};var O=function(e){var t=[];L.forEach(e,function(e){if(L.isDefined(e.id)){t.push(e.id)}});return t};var I=function(e){a({url:"map_ticket_status_color_by_ticket_id.json",method:"POST",data:{ticketIds:e.join(",")}}).success(function(e,t,i,n){if(e.success){s.ticketStatusColors=e.json}else{}})};y()}t.$inject=["$scope","$http","alertService","utils","$state","$stateParams"];function t(s,e,t,i,n,a){s.questViewItem="question_i_subscription";s.setQuestViewItem=function(e){s.questViewItem=e};e({url:"vote_count_user/"+s.customer.id+".json",method:"GET",data:{}}).success(function(e,t,i,n){if(e.success){s.voteCountMine=e.json.voteCount}});e({url:"question_user_subscription/"+s.customer.id+".json",method:"GET",data:{}}).success(function(e,t,i,n){if(e.success){s.questionsISubscription=e.json}else{void 0}});e({url:"question_user/"+s.customer.id+".json",method:"GET",data:{}}).success(function(e,t,i,n){if(e.success){s.questionsMine=e.json}else{void 0}});e({url:"question_user_answer/"+s.customer.id+".json",method:"GET",data:{}}).success(function(e,t,i,n){if(e.success){s.questionIAnswer=e.json}else{void 0}});e({url:"question_user_comment/"+s.customer.id+".json",method:"GET",data:{}}).success(function(e,t,i,n){if(e.success){s.questionIComment=e.json}else{void 0}})}i.$inject=["$scope","$http","alertService","utils","$state","$stateParams"];function i(t,e,i,n,s,a){t.currentChatLogPage=1;t.chatLogs=[];t.getChatLogs=function(){e.get("customer_history_chatLog_list/"+t.customer.id+".json",{params:{_page:t.currentChatLogPage,_count:10}}).success(function(e){if(e.json&&e.json.length>0){t.chatLogs=t.chatLogs.concat(e.json)}else{i.add("没有更多了","danger")}})};t.getChatLogs();t.showMore=function(){t.currentChatLogPage+=1;t.getChatLogs()}}})(angular);(function(e){"use strict";e.module("eweiApp.account").controller("userGroupDetailCustomersController",t);t.$inject=["$scope","$http","alertService","utils","$state","$stateParams","$filter","$timeout","ngTableParams","groupUserTicketChainService","apiCustomerService","coreNotifyService"];function t(n,e,t,i,s,a,r,o,l,c,u,d){var p;var f=s.current.name;n.$on("reloadCustomer",function(){n.tableParams.reload()});n.$on("reloadCustomerData",function(){y()});var m=function(){n.columns=[{title:"ID",field:"id",visible:true,widthClass:"w100"},{title:"姓名",field:"name",visible:true,widthClass:"w200"},{title:"昵称",field:"nickname",visible:true,widthClass:"w200"},{title:"Email",field:"email",visible:true,widthClass:"w200"},{title:"手机",field:"mobilePhone",visible:true,widthClass:"w200"},{title:"电话",field:"phone",visible:true,widthClass:"w200"},{title:"最近登录",field:"lastLoginAt",visible:true,widthClass:"w200"},{title:"工单访问范围",field:"shared",visible:true,widthClass:"w200"}];n.fields="id,name,nickname,email,phone,mobilePhone,createdAt,lastLoginAt,shared"};var g=function(e,t){for(var i in e){if(e[i]==t){return i}return""}};var v=function(){n.filter="{'$and':[{'$eq':{'userGroup.id':"+p+"}},{'$eq':{'valid':true}},{'$eq':{'type':'customer'}}]}";n.sorting={id:"desc"};n.view={type:"user"};n.tableParams=new l({page:1,count:30,sorting:n.sorting},{groupBy:function(e){return null},total:0,getData:function(t,i){org.ewei.sdk.OpenUserApi().listCustomerByUserGroup({userGroupId:p,page:{pageNumber:i.page(),pageSize:i.count()}}).then(function(e){i.total(e.recordCount);t.resolve(e.list);n.showCheckboxes=false;if(e.list.length==0){n.noDataTip="没有相关数据"}})}})};var h=function(e){p=e&&e.id?e.id:undefined;if(p){m();v()}};var y=function(){h(c.getData("userGroup"))};y()}})(angular);(function(I){"use strict";I.module("eweiApp.account").controller("userGroupDetailController",e);e.$inject=["$rootScope","$scope","$http","userGroupService","userService","alertService","utils","$state","$stateParams","$modal_","serviceDeskService","$location","permissions","license","$filter","locker","groupUserTicketChainService","providerJudgement","commonTools"];function e(e,u,c,t,d,p,n,i,s,a,r,o,l,f,m,g,v,h,y){var k=null;u.displayNameView=false;var C=function(){var e=[];var t=g.driver("session").namespace("eweiApp.account").get("userGroupFlowMap");if(t&&t.length){e=_.reject(t,function(e){return e.id==s.id});g.driver("session").namespace("eweiApp.account").put("userGroupFlowMap",e);u.showNextUserGroupBtn=e.length>0;u.viewNextUserGroup=function(){g.driver("session").namespace("eweiApp.account").put("userGroupFlowPre","user_groups_detail"+s.id);i.go("user_groups_detail",{id:e[0].id,viewUserGroupList:e})}}};var b=function(e){if(e.userGroup!=null){k=e.userGroup.id}else if(e.requester!=null){k=e.requester.userGroup.id}else if(e.user!=null){k=e.user.userGroup.id}else{k=e.id}return k};var w=function(){c.get("/user_count_by_group_id/"+k).success(function(e){u.clientcount=e.id});c.get("/ticket_count_by_group_id/"+k).success(function(e){u.clientTicketcount=e.id});c.get("get_external_url_authorize.json").success(function(e){if(e.success&&e.json){u.externalUrlAuthorize=e.json}})};var T=function(){if(u.userGroup!=null){u.oldName=u.userGroup.name;u.oldDomainNames=u.userGroup.domainNames;u.oldNotes=u.userGroup.notes;var e=n.findTabByIdAndStateName("user_groups_detail"+u.userGroup.id,"user_groups_detail");var t=g.driver("session").namespace("eweiApp.account").get("userGroupFlowPre");var i=n.findTabByIdAndStateName(t,"user_groups_detail");if(e==null){if(I.isObject(i)){i.id="user_groups_detail"+u.userGroup.id;i.title=u.userGroup.nickname!=undefined?u.userGroup.nickname:u.userGroup.name;i.params={id:u.userGroup.id}}else{n.addTab("user_groups_detail"+u.userGroup.id,u.userGroup.name,"user_groups_detail",{id:u.userGroup.id},"")}}else{e.active=true}}};var S=function(){if(u.customer==null){u.userGroup=null}else{u.userGroup=u.customer.userGroup;u.oldName=u.userGroup.name;u.oldDomainNames=u.userGroup.domainNames;u.oldNotes=u.userGroup.notes}};var F=function(){if(u.ticket==null){u.customer=null;u.userGroup=null}else{u.customer=u.ticket.requester;if(u.customer.userGroup){u.userGroup=u.customer.userGroup;if(u.userGroup.name){u.oldName=u.userGroup.name}u.oldDomainNames=u.userGroup.domainNames;u.oldNotes=u.userGroup.notes}}};var A=function(){if(u.webchat==null){u.customer=null;u.userGroup=null;u.ticket=null}else{u.ticket=u.webchat.ticket;u.customer=u.webchat.user;u.userGroup=u.customer.userGroup;if(undefined!=u.userGroup){u.oldName=u.userGroup.name;u.oldDomainNames=u.userGroup.domainNames;u.oldNotes=u.userGroup.notes}}};var E=function(){r.query({_count:999,_do_count:false,_fields:"id,name"},function(e){u.serviceDesks=e.serviceDesks;I.forEach(u.serviceDesks,function(e){e.name=m("translate")(e.name)});if(u.userGroup.serviceDesk!=null){I.forEach(u.serviceDesks,function(e){if(e.id===u.userGroup.serviceDesk.id){u.userGroup.serviceDesk=e;return}})}})};var $=function(){var t=i.current.name;if(t.indexOf("user_groups_detail")>=0){u.userGroup={id:s.id};if(t.indexOf(".tickets")==-1&&t.indexOf(".customers")==-1){i.go("user_groups_detail.customers")}v.run("userGroup",s.id,function(e){u.userGroup=e.json;T();b(u.userGroup);w();E()})}else if(t.indexOf("user_group_customers_detail")>=0){u.customer={id:s.id};if(t.indexOf(".tickets")==-1&&t.indexOf(".customers")==-1){i.go("user_group_customers_detail.customers")}v.run("user",s.id,function(e){u.customer=e.json;S();b(u.customer);v.run("userGroup",u.customer.userGroup.id,function(e){u.userGroup=e.json;T();u.$broadcast("reloadCustomerData",{})});w();E()})}else if(t.indexOf("user_group_requester_tickets_detail")>=0){u.ticket=s.ticket||{id:s.id};if(s.ticket){v.run("ticket",s.id,function(e){u.ticket=e.result;F();v.run("user",u.ticket.requester.id,function(e){u.customer=e.json;S();b(u.customer);v.run("userGroup",u.customer.userGroup.id,function(e){u.userGroup=e.json;w();E();u.$broadcast("reloadCustomerData",{});if(t.indexOf(".tickets")==-1&&t.indexOf(".customers")==-1){i.go("user_group_requester_tickets_detail.customers")}})})})}else{v.run("ticket",s.id,function(e){u.ticket=e.result;F();v.run("user",u.ticket.requester.id,function(e){u.customer=e.json;S();b(u.customer);v.run("userGroup",u.customer.userGroup.id,function(e){u.userGroup=e.json;w();E();u.$broadcast("reloadCustomerData",{});if(t.indexOf(".tickets")==-1&&t.indexOf(".customers")==-1){i.go("user_group_requester_tickets_detail.customers")}})})})}}else if(t.indexOf("webchat_user_group_detail")>=0){u.webchat={id:s.id};v.run("webchat",s.id,function(e){u.webchat=e.result;A();u.userGroup={id:b(u.webchat)};v.run("userGroup",b(u.webchat),function(e){u.userGroup=e.json;w();E();u.$broadcast("reloadCustomerData",{});if(t.indexOf(".tickets")==-1&&t.indexOf(".customers")==-1){i.go("webchat_user_group_detail.customers")}})})}};var O=function(){C();$()};O();u.editableGroup=l.hasPermission("customer_group_update");u.mouseoverName=function(){u.displayNameView=true};u.mouseoutName=function(){u.displayNameView=false};u.updateName=function(){if(u.userGroup.name!=null){if(u.oldName!=u.userGroup.name){org.ewei.sdk.OpenUserGroupApi().updateUserGroupName({id:u.userGroup.id,name:u.userGroup.name}).then({success:function(e){u.oldName=u.userGroup.name;u.displayNameView=false;p.add("修改客户分组名称成功")},fail:function(e){u.userGroup.name=u.oldName;if(e&&e.error_description){p.add(e.error_description,"danger")}else{p.add("修改客户分组名称失败，请重试！","danger","left")}}})}else{u.displayNameView=false}}else{u.userGroup.name=u.oldName}};u.updateDomainNames=function(){if(u.oldDomainNames!=u.userGroup.domainNames){c({url:"update_domain_names.json",method:"POST",data:{id:u.userGroup.id,domainNames:u.userGroup.domainNames}}).success(function(e,t,i,n){if(e.success){u.oldDomainNames=u.userGroup.domainNames}else{p.add("修改Email域名失败","danger","left")}})}};u.updateShared=function(){c({url:"update_user_group_shared.json",method:"POST",data:{id:u.userGroup.id,shared:u.userGroup.shared}}).success(function(e,t,i,n){if(e.success){}else{p.add("修改共享工单属性失败","danger","left")}})};u.updateNotes=function(){if(u.oldNotes!=u.userGroup.notes){c({url:"update_user_group_notes.json",method:"POST",data:{id:u.userGroup.id,notes:u.userGroup.notes}}).success(function(e,t,i,n){if(e.success){u.oldNotes=u.userGroup.notes}else{p.add("修改客户分组备注失败","danger","left")}})}};u.updateServiceDesk=function(){c({url:"update_service_desk.json",method:"POST",data:{id:u.userGroup.id,serviceDeskId:u.userGroup.serviceDesk==null?null:u.userGroup.serviceDesk.id}}).success(function(e,t,i,n){if(e.success){}else{p.add("绑定客服组失败","danger","left")}})};u.addCustomer=function(){_hmt.push(["_trackEvent","客户组详情操作","添加客户"]);var e=a({scope:u,title:"新建客户",contentTemplate:"source/views/customer/user_add.html",html:true,show:true,placement:"top"});u.hideModal=function(){e.$promise.then(e.hide)};c.get("user_group_list.json?_count=999&_do_count=false&_fields=id,name,shared",{}).then(function(e){u.userGroups=e.data.userGroups});var i=function(e){var t=e;var i=[];for(var n=0;n<t.length;n++){var s=t[n];var a={id:null,value:s.value,customField:null};if(s.type=="options"){var r=jQuery.parseJSON(s.customFieldOptions);s.customFieldOptions=r;if(s.value==undefined){a.value=r[0].value}if((s.value==undefined||s.value=="")&&s.defaultValue){for(var o=0;o<r.length;o++){if(r[o].value==s.defaultValue){a.value=s.defaultValue}}}}if(s.type=="checkbox"){if(s.value=="true"){a.value=true}else{a.value=false}}if(s.type=="ip"||s.type=="url"||s.type=="mobile_phone"||s.type=="currency"){s.type="text"}if(s.notes!=undefined&&s.notes.length>40){s.notes=s.notes.substring(0,12)+". . . "}if(s.value){s.value=""}if(s.url){if(s.url.toLowerCase().indexOf("http://")!=0){s.url="http://"+s.url;void 0}if(s.url.indexOf("?")<0){a.fromParams="?"}else{a.fromParams="&"}var l=new String(s.url);if(l.indexOf("{value}")>0){l=l.replaceAll("{value}",a.value)}else{l=l+a.value}a.valueUrl=l}if(s.type=="date"){s.startForm=false;a.value=y.parseDate(a.value,"yyyy/MM/dd")}else if(s.type=="date_to_date"){s.startTimeForm=false;s.endTimeForm=false;if(s.value){var c=s.value.split("-");s.startTime=y.parseDate(c[0],"yyyy/MM/dd");s.endTime=y.parseDate(c[1],"yyyy/MM/dd")}}a.customField=s;a.id=s.userCustomFieldId;if(s.required){s.moreField=true}else{s.moreField=false}i.push(a)}u.userCustomFields=i};if(u.userId==undefined){c.get("custom_field.json?scope=user&active=true").success(function(e,t){i(e.json)})}else{c.get("user_custom_field.json?userId="+u.userId).success(function(e,t){i(e.json)})}u.datepickers={startTo:false,updateFrom:false,updateTo:false};u.open=function(e,t){e.preventDefault();e.stopPropagation();if(t.startForm){t.startForm=false}else{t.startForm=true}};u.timeFrameOpen=function(e,t,i){e.preventDefault();e.stopPropagation();if(i=="startTimeForm"){t.startTimeForm=!t.startTimeForm}else{t.endTimeForm=!t.endTimeForm}};u.newUser={userGroup:u.userGroup};u.selectUserGroupable=false;u.$save=function(){var e=/[\\\[\]]/im;if(u.newUser.email&&!verifyEmailAddress(u.newUser.email)){p.add("邮件地址需由字母、数字或下划线组成","danger");return false}if(u.newUser.mobilePhone&&!validMobilePhone(u.newUser.mobilePhone)){p.add("手机号码格式不正确","danger");return false}if(u.newUser.password&&u.newUser.password.length<6){p.add("密码格式不正确，不能包含非法字符和汉字，长度在6-16位之间，请修改","danger");return false}else if(u.newUser.password&&u.newUser.password.length>5&&e.test(u.newUser.password)){p.add("密码格式不正确，不能包含非法字符和汉字，长度在6-16位之间，请修改","danger");return false}if(!h.isTrue()){return false}var t;var i=u.userCustomFields;var n=i.length;var s=[];var a;for(var r=0;r<n;r++){a={};t=i[r].customField;if(t.type=="date_to_date"){if(t.startTime||t.endTime){if(t.startTime&&t.endTime){var o=m("date")(t.startTime,"yyyy/MM/dd").toString();var l=m("date")(t.endTime,"yyyy/MM/dd").toString();a.value=o+"-"+l;a.customField=t;s.push(a)}else{p.add("请填写完整"+t.title,"danger");return false}}else{if(t.required){p.add("请填写完整"+t.title,"danger");return false}else{continue}}}else if(t.type=="cascade_options"){if(t.required){if(i[r].value=="-"){p.add("请填写完整"+t.title,"danger");return false}}if(i[r].value){a.value=i[r].value;a.customField=t;s.push(a)}}else{if(t.required){if(!i[r].value){p.add("请填写完整"+t.title,"danger");return false}}if(i[r].value){if(t.type=="date"){i[r].value=m("date")(i[r].value,"yyyy/MM/dd").toString()}a.value=i[r].value;a.customField=t;s.push(a)}}}u.newUser.customerCustomFields=s;d.add(u.newUser,function(e){if(e.success){u.hideModal();c({url:"reset_user_password.json",method:"POST",data:{userId:e.id,password:u.newUser.password}}).success(function(e,t,i,n){});u.$broadcast("reloadCustomer",{})}else{if(e.message!=null){var t="";if(e.message=="FIELD_NOT_EXIST"){t="自定义字段未找到"}else if(e.message.indexOf("REQUIRED_FIELD_IS_NULL_")>=0){var i=e.message.split("REQUIRED_FIELD_IS_NULL_")[1];var n;var s=u.newUser.customerCustomFields;for(var a in s){n=s[a].customField.id;if(i==n){t="请填写"+s[a].customField.title;break}}}else if(e.message.indexOf("FIELD_ERROR_")>=0){var i=e.message.split("FIELD_ERROR_")[1];var n;var s=u.newUser.customerCustomFields;for(var a in s){n=s[a].customField.id;if(i==n){t="请正确填写"+s[a].customField.title;break}}}else{t=e.message}p.add(m("translate")(t),"danger")}else{p.add("保存失败","danger")}}})};u.moreField=false;u.showMoreField=function(){u.moreField=true;var e=u.userCustomFields;var t=e.length;var i=[];var n=[];var s;for(var a=0;a<t;a++){s=e[a].customField;s.moreField=true;if(s.required==true){i.push(e[a])}else{n.push(e[a])}}u.userCustomFields=i.concat(n)}};u.deleteUserGroup=function(){_hmt.push(["_trackEvent","客户组详情操作","删除"]);u.confirmContent="删除客户组可能会对自动化、触发器、工单视图、社区目录权限等设置有影响，是否确定删除？确定删除后，该客户组中的客户将变成未分组状态。";var e=a({scope:u,title:"确认",contentTemplate:"source/views/confirm_template.html",html:true,show:true,placement:"center"});u.hideModal=function(){e.$promise.then(e.hide)};u.$ok=function(){t["delete"]({id:u.userGroup.id},function(e){u.hideModal();if(e.success){if(u.showNextUserGroupBtn){n.removeActiveTab(i);u.viewNextUserGroup()}else{n.removeActiveTab(i)}}else{void 0}})}};u.goTickets=function(){if(u.customer==null){i.go("user_groups_detail.tickets",{status:"all_ticket"})}else{if(u.webchat!=null){i.go("webchat_user_group_detail.tickets",{status:"all_ticket"})}else if(u.ticket!=null){i.go("user_group_requester_tickets_detail.tickets",{status:"all_ticket"})}else{i.go("user_group_customers_detail.tickets",{status:"all_ticket"})}}};u.goCustomers=function(){if(u.customer==null){i.go("user_groups_detail.customers")}else{if(u.webchat!=null){i.go("webchat_user_group_detail.customers")}else if(u.ticket!=null){i.go("user_group_requester_tickets_detail.customers")}else{i.go("user_group_customers_detail.customers")}}};if(!l.hasPermission("customer_group_update")){u.hideSla=true}u.goSla=function(){var e=u.userGroup?u.userGroup:[];if(u.customer==null){i.go("user_groups_detail.sla",{userGroup:e})}else{if(u.webchat!=null){i.go("webchat_user_group_detail.sla",{userGroup:e})}else if(u.ticket!=null){i.go("user_group_requester_tickets_detail.sla",{userGroup:e})}else{i.go("user_group_customers_detail.sla",{userGroup:e})}}}}})(angular);(function(){"use strict";angular.module("eweiApp.system_setting").controller("systemSettingController",e).controller("access_controller",t).controller("signConfig_controller",i);e.$inject=["$scope","$rootScope","$state","$location","systemSettingMenus","permissions","$stateParams","$http","ConsoleConfig","license"];function e(o,e,i,t,l,n,s,a,r,c){o.subMenuNum={};o.$watch("$state.current.url",function(e,t){if(e){o.currentStateUrl=i.current.url}});var u=function(e){var t=angular.copy(l);var i=false;for(var n=0;n<t.length;n++){var s=t[n];if(s.subMenus&&s.subMenus.length&&!i){var a=s.subMenus.length;for(var r=0;r<a;r++){if(e.indexOf(s.subMenus[r].uri)!==-1){t[n].isCollapsed=true;if(n===2&&o.subMenuNum.run_engineers===undefined){f()}i=true;break}}}else{t[n].isCollapsed=false}}o.menus=t};if(i.params.uri){u(i.params.uri)}else{u(i.current.name)}var d={my_account:"你的账号",company_account:"公司账号",app_market:"应用市场",domain_setting:"独立域名",email_setting:"通知邮件",tag_setting:"标签",logo_setting:"界面Logo",oem_setting:"OEM",operation_log:"操作日志"};o.changeCollapsed=function(n){angular.forEach(o.menus,function(e,t,i){if(e.title!==n.title){e.isCollapsed=false}});if(n===o.menus[2]&&o.subMenuNum.run_engineers===undefined){f()}n.isCollapsed=!n.isCollapsed};o.listen=true;var p=e.$on("$stateChangeStart",function(e,t,i,n,s){if(o.listen){if(i.uri){u(i.uri)}else if(i.name){u(i.name)}}});o.$on("$destroy",function(){o.listen=false;p()});function f(){a({url:"/api/v1/engineer_role_servicedesk/count.json",params:{provider_id:r.provider.id,_token:getCookie("user_token")},method:"GET"}).success(function(e){if(e.status==0){var t=e.result;o.subMenuNum.run_engineers=t.countNormalEngineers;o.subMenuNum.stop_engineers=t.countDisableEngineers;o.subMenuNum.wait_engineers=t.countNoValidationEngineers;o.subMenuNum.service_desks=t.countServiceDesks;o.subMenuNum.roles=t.countRoles}})}o.detail=function(e,t,i){};o.hasPermissions=function(e){if(e){if(angular.isString(e)){e=e.split(",")}return n.anyPermissions(e)}return true};o.hasModule=function(e){if(e&&c.isVersion2017()){e=e.split(",");var t=false;e.forEach(function(e){if(e&&c.hasModule(e)){t=true}});return t}return true}}t.$inject=["$scope","$state","$stateParams","$http","alertService","$rootScope","helpcenterViewService","$filter","$translatePartialLoader","$location","ldapFields","eweiUserFields","$modal_","ConsoleConfig"];function t(a,e,t,i,s,r,n,o,l,c,u,d,p,f){a.consoleCenterUrl=c.protocol()+"://"+f.provider.subDomain+"."+f.domainRoot+"/console";a.location=location.host;a.eweiHelpcenterApiUrl=f.eweiHelpcenterApiUrl;a.accessConfig={requiredLogin:"false",restrictIp:false,ipWhiteList:"",excludeApp:false};a.signIn={type:"accountSignIn"};a.accountSignIn={signUp:true,qq:true,weibo:true};i({url:"getAccessConfigByProvider.json",method:"GET"}).success(function(e,t,i,n){if(e.json!==undefined){a.accessConfig.requiredLogin=e.json.requiredLogin+"";a.accessConfig.restrictIp=e.json.restrictIp;a.accessConfig.ipWhiteList=e.json.ipWhiteList===undefined?"":e.json.ipWhiteList;a.accessConfig.excludeApp=e.json.excludeApp;a.accessConfig.id=e.json.id}});a.isQiyeQQInputDisabled=true;i({url:"provider_qiye_qq_config.json",method:"GET"}).success(function(e,t,i,n){if(e&&e.success){var s=e.json;if(s&&s.id>0&&s.companyId!=undefined&&s.companyId!=null&&s.companyId!=""&&s.companyToken!=undefined&&s.companyToken!=null&&s.companyToken!=""){a.isQiyeQQInputDisabled=false}}});a.updateAccessConfig=function(){_hmt.push(["_trackEvent","社区设置-访问控制","访问控制更新"]);i({url:"updateAccessConfig.json",method:"POST",params:{id:a.accessConfig.id,requiredLogin:a.accessConfig.requiredLogin,restrictIp:a.accessConfig.restrictIp,ipWhiteList:a.accessConfig.ipWhiteList,excludeApp:a.accessConfig.excludeApp}}).success(function(e,t,i,n){if(e.id>0){s.add("修改成功！")}else{s.add("修改失败！","danger")}})};a.showAccessConfigDiv=function(){_hmt.push(["_trackEvent","社区设置-访问控制","访问控制"]);if(a.div.show!=1){i({url:"getAccessConfigByProvider.json",method:"GET"}).success(function(e,t,i,n){if(e.json!==undefined){a.accessConfig.requiredLogin=e.json.requiredLogin+"";a.accessConfig.restrictIp=e.json.restrictIp;a.accessConfig.ipWhiteList=e.json.ipWhiteList===undefined?"":e.json.ipWhiteList;a.accessConfig.excludeApp=e.json.excludeApp;a.accessConfig.id=e.json.id}});a.div.show=1}document.getElementById("access_setting_tab1").checked=true};a.oppenHelpCenter={isOpen:r.currentProviderIsOpenHelpcenter};a.updateProviderHelpcenter=function(){_hmt.push(["_trackEvent","社区设置-访问控制","对外公开社区内容更新"]);i({url:"updateProviderHelpcenter.json",method:"POST",params:{isOpen:a.oppenHelpCenter.isOpen}}).success(function(e,t,i,n){if(e.success==true||e.success=="true"){r.currentProviderIsOpenHelpcenter=a.oppenHelpCenter.isOpen;s.add("修改成功！")}else{s.add("修改失败！","danger")}})}}i.$inject=["$scope","$state","$stateParams","$http","alertService","$rootScope","helpcenterViewService","$filter","$translatePartialLoader","$location","ldapFields","eweiUserFields","$modal_","ConsoleConfig","providerJudgement"];function i(r,e,t,i,s,a,n,o,l,c,u,d,p,f,m){r.consoleCenterUrl=c.protocol()+"://"+f.provider.subDomain+"."+f.domainRoot+"/console";r.location=location.host;r.eweiHelpcenterApiUrl=f.eweiHelpcenterApiUrl;r.licenseIsFree=m.isFree();r.accessConfig={requiredLogin:"false",restrictIp:false,ipWhiteList:"",excludeApp:false};r.signIn={type:"accountSignIn"};r.div={show:1};r.accountSignIn={signUp:true,qq:true,weibo:true};i({url:"getAccessConfigByProvider.json",method:"GET"}).success(function(e,t,i,n){if(e.json!==undefined){r.accessConfig.requiredLogin=e.json.requiredLogin+"";r.accessConfig.restrictIp=e.json.restrictIp;r.accessConfig.ipWhiteList=e.json.ipWhiteList===undefined?"":e.json.ipWhiteList;r.accessConfig.excludeApp=e.json.excludeApp;r.accessConfig.id=e.json.id}});r.isQiyeQQInputDisabled=true;i({url:"provider_qiye_qq_config.json",method:"GET"}).success(function(e,t,i,n){if(e&&e.success){var s=e.json;if(s&&s.id>0&&s.companyId!=undefined&&s.companyId!=null&&s.companyId!=""&&s.companyToken!=undefined&&s.companyToken!=null&&s.companyToken!=""){r.isQiyeQQInputDisabled=false}}});r.oppenHelpCenter={isOpen:a.currentProviderIsOpenHelpcenter};r.updateAccessConfig=function(){_hmt.push(["_trackEvent","社区设置-访问控制","访问控制更新"]);i({url:"updateAccessConfig.json",method:"POST",params:{id:r.accessConfig.id,requiredLogin:r.accessConfig.requiredLogin,restrictIp:r.accessConfig.restrictIp,ipWhiteList:r.accessConfig.ipWhiteList,excludeApp:r.accessConfig.excludeApp}}).success(function(e,t,i,n){if(e.id>0){s.add("修改成功！")}else{s.add("修改失败！","danger")}})};r.showAccessConfigDiv=function(){_hmt.push(["_trackEvent","社区设置-访问控制","访问控制"]);if(r.div.show!=1){i({url:"getAccessConfigByProvider.json",method:"GET"}).success(function(e,t,i,n){if(e.json!==undefined){r.accessConfig.requiredLogin=e.json.requiredLogin+"";r.accessConfig.restrictIp=e.json.restrictIp;r.accessConfig.ipWhiteList=e.json.ipWhiteList===undefined?"":e.json.ipWhiteList;r.accessConfig.excludeApp=e.json.excludeApp;r.accessConfig.id=e.json.id}});r.div.show=1}document.getElementById("access_setting_tab1").checked=true};r.loginURL=f.providerHelpCenterUrl;r.signinConfig={};r.ldapFields=u;r.eweiUserFields=d;r.ldapverify=false;var g="";r.selected={selectedSSOType:"",selectedSSOUserType:"",selectedLdapUserType:"",selectedLdapSSLType:"",selectedLdapServerType:""};r.ldapSSLType=[{display:"是",value:true},{display:"否",value:false}];r.ssoType=[{display:"SAML",value:"saml"},{display:"JSON WEB TOKEN",value:"jwt"}];r.ssoUserType=[{display:"所有用户使用第三方账号单点登录",value:"all"},{display:"仅客服使用第三方账号单点登录",value:"engineer"},{display:" 仅客户使用第三方账号单点登录",value:"customer"}];r.ldapServerType=[{display:"AD",value:"ad"},{display:"OpenLdap",value:"open_ldap"},{display:"其他",value:"others"}];r.ldapUserType=[{display:"所有用户登录需LDAP验证",value:"all"},{display:"仅客服登录需LDAP验证",value:"engineer"},{display:"仅客户登录需LDAP验证",value:"customer"}];var v=[{required:true,userProperty:"name",userPropertyDisplay:"姓名",ldapProperty:"name",orderKey:1},{required:true,userProperty:"email",userPropertyDisplay:"Email",ldapProperty:"mail",orderKey:2}];r.ssoTypeChanged=function(e){if(e.value=="saml"){r.signinConfig.accountSignIn.saml=true;r.signinConfig.accountSignIn.jwt=false}else if(e.value=="jwt"){r.signinConfig.accountSignIn.jwt=true;r.signinConfig.accountSignIn.saml=false}};r.ssoUserTypeChanged=function(e){if(!r.signinConfig.ssoSignIn){return}if(r.signinConfig.ssoSignIn.userType){r.signinConfig.ssoSignIn.userType=e.value}};r.ldapUserTypeChanged=function(e){r.signinConfig.ldapSignIn.userType=e.value};r.ldapSSLTypeChanged=function(e){r.signinConfig.ldapSignIn.isSsl=e.value;r.ldapInfoChange()};r.ldapServerTypeChanged=function(e){r.signinConfig.ldapSignIn.serverType=e.value;r.ldapInfoChange()};var h=function(){if(r.signinConfig.accountSignIn.jwt){r.selected.selectedSSOType=r.ssoType[1]}else if(r.signinConfig.accountSignIn.saml){r.selected.selectedSSOType=r.ssoType[0]}angular.forEach(r.ssoUserType,function(e){if(!r.signinConfig.ssoSignIn){return}if(!r.signinConfig.ssoSignIn.userType){return}if(e.value==r.signinConfig.ssoSignIn.userType){r.selected.selectedSSOUserType=e}})};var y=function(){if(r.signinConfig.ldapSignIn==null||typeof r.signinConfig.ldapSignIn=="undefined"){r.signinConfig.ldapSignIn={filter:"(|(objectClass=account)(objectClass=user)(objectClass=person)(objectClass=inetOrgPerson))"};r.signinConfig.ldapSignIn.propertyFields=v}else{if(r.signinConfig.ldapSignIn.propertyFields==null||r.signinConfig.ldapSignIn.propertyFields.length==0){r.signinConfig.ldapSignIn.propertyFields=v}}if(r.signinConfig.ldapSignIn&&r.signinConfig.ldapSignIn.password){g=r.signinConfig.ldapSignIn.password=Base64.decode(r.signinConfig.ldapSignIn.password)}i({url:"custom_field.json?scope=user&active=true",method:"GET"}).success(function(e,t,i,n){if(e.json!==undefined){for(var s=0,a=e.json.length;s<a;s++){r.eweiUserFields.push({caption:e.json[s].title,value:"custom_field_"+e.json[s].id})}}angular.forEach(r.signinConfig.ldapSignIn.propertyFields,function(t){angular.forEach(r.eweiUserFields,function(e){if(t.userProperty==e.value){t.userPropertyDisplay=e.caption}else if(t.userProperty=="name"){t.userPropertyDisplay="姓名"}else if(t.userProperty=="email"){t.userPropertyDisplay="Email"}})})});angular.forEach(r.ldapServerType,function(e){if(e.value==r.signinConfig.ldapSignIn.serverType){r.selected.selectedLdapServerType=e}});angular.forEach(r.ldapUserType,function(e){if(e.value==r.signinConfig.ldapSignIn.userType){r.selected.selectedLdapUserType=e}});angular.forEach(r.ldapSSLType,function(e){if(e.value==r.signinConfig.ldapSignIn.isSsl){r.selected.selectedLdapSSLType=e}})};var _=function(e){switch(e){case"sso":h();break;case"ldap":y();break;case"ewei_account":break}};var k=function(){i({url:"signin_config.json",method:"GET"}).success(function(e,t,i,n){r.signinConfig=e.json;_(r.signinConfig.type)})};r.radioChange=function(){_(r.signinConfig.type)};r.toShowSelectLdapField=function(){r.selectFieldItem=null;var e=p({scope:r,title:"选择用户属性",contentTemplate:"source/views/help_center/select_ldap_fields.html",html:true,show:true,placement:"center"});r.hideSelectLdapFieldModal=function(){e.$promise.then(e.hide)};r.$fieldChange=function(e){r.selectFieldItem=e};r.$ok=function(){if(r.selectFieldItem==null||r.selectFieldItem==""){s.add("请选择！","danger");return}for(var e=0,t=r.signinConfig.ldapSignIn.propertyFields.length;e<t;e++){var i=r.signinConfig.ldapSignIn.propertyFields[e];if(i.userProperty==r.selectFieldItem){s.add("此项已经被选择！","danger");return}}var n={required:false,userProperty:r.selectFieldItem,ldapProperty:"name"};for(var e=0,t=r.eweiUserFields.length;e<t;e++){if(r.eweiUserFields[e].value==r.selectFieldItem){n.userPropertyDisplay=r.eweiUserFields[e].caption;break}}r.signinConfig.ldapSignIn.propertyFields.push(n);r.hideSelectLdapFieldModal()}};r.deleteLdapField=function(e){r.signinConfig.ldapSignIn.propertyFields.splice(e,1)};var C=function(e){if(e){if(e.toLowerCase().indexOf("http://")!=0&&e.toLowerCase().indexOf("https://")!=0){return"http://"+e;void 0}return e}};var b=function(){if(r.signinConfig.ldapSignIn.server==null||r.signinConfig.ldapSignIn.server==""||r.signinConfig.ldapSignIn.admin==""||r.signinConfig.ldapSignIn.admin==null||r.signinConfig.ldapSignIn.userDirectory==null||r.signinConfig.ldapSignIn.userDirectory==""||r.signinConfig.ldapSignIn.password==null||r.signinConfig.ldapSignIn.password==""||r.signinConfig.ldapSignIn.serverType==null||r.signinConfig.ldapSignIn.serverType==""){return false}else{return true}};r.updateSigninConfigSignIn=function(){_hmt.push(["_trackEvent","社区设置-访问控制","帐户和登录验证方式更新"]);if(r.signinConfig.type=="ldap"){if(false==b()){s.add("请填写完整ldap配置信息","danger");return}if(r.ldapverify){r.updateSigninConfigSignInRequest()}else{w(function(e){if(e.success){r.ldapverify=true;r.updateSigninConfigSignInRequest()}else{s.add("验证失败,无法保存","danger");r.ldapverify=false}})}}else if(r.signinConfig.type=="sso"){if(r.signinConfig.accountSignIn.saml){if(r.signinConfig.ssoSignIn==null||r.signinConfig.ssoSignIn.saml.loginUrl==""||r.signinConfig.ssoSignIn.saml.loginUrl==undefined||r.signinConfig.ssoSignIn.saml.samlUrl==""||r.signinConfig.ssoSignIn.saml.samlUrl==undefined){s.add("请填写完整saml配置信息","danger");return}if(r.signinConfig.ssoSignIn.saml.ticketParam==undefined||r.signinConfig.ssoSignIn.saml.ticketParam==""){r.signinConfig.ssoSignIn.saml.ticketParam="SAMLart"}if(r.signinConfig.ssoSignIn.saml.emailParam==undefined||r.signinConfig.ssoSignIn.saml.emailParam==""){r.signinConfig.ssoSignIn.saml.emailParam="NameID"}if(r.signinConfig.ssoSignIn.saml.loginParam==undefined||r.signinConfig.ssoSignIn.saml.loginParam==""){r.signinConfig.ssoSignIn.saml.loginParam="TARGET"}r.signinConfig.ssoSignIn.saml.loginUrl=C(r.signinConfig.ssoSignIn.saml.loginUrl);r.signinConfig.ssoSignIn.saml.samlUrl=C(r.signinConfig.ssoSignIn.saml.samlUrl);r.signinConfig.ssoSignIn.saml.logoutUrl=C(r.signinConfig.ssoSignIn.saml.logoutUrl)}else if(r.signinConfig.accountSignIn.jwt){if(r.signinConfig.ssoSignIn==null||r.signinConfig.ssoSignIn.jsonWebToken.loginUrl==""||r.signinConfig.ssoSignIn.jsonWebToken.loginUrl==undefined){s.add("请填写完整jsonWebToken配置信息","danger");return}r.signinConfig.ssoSignIn.jsonWebToken.loginUrl=C(r.signinConfig.ssoSignIn.jsonWebToken.loginUrl);r.signinConfig.ssoSignIn.jsonWebToken.logoutUrl=C(r.signinConfig.ssoSignIn.jsonWebToken.logoutUrl)}if(r.signinConfig.ldapSignIn&&(!r.signinConfig.ldapSignIn.id||r.signinConfig.ldapSignIn.id==null)){r.signinConfig.ldapSignIn=null}r.updateSigninConfigSignInRequest()}else{if(typeof r.signinConfig.ldapSignIn=="undefined"){r.signinConfig.ldapSignIn=null}else if(r.signinConfig.ldapSignIn.id==null||r.signinConfig.ldapSignIn.id==""){r.signinConfig.ldapSignIn=null}r.updateSigninConfigSignInRequest()}};r.ldapInfoChange=function(){r.ldapverify=false};r.importUser=false;r.updateSigninConfigSignInRequest=function(){var e="null";if(r.signinConfig.type=="ldap"&&g!=null){e=Base64.encode(g)}i({url:"signin_config.json?importUser="+r.importUser,method:"POST",data:r.signinConfig,headers:{Authorization:e}}).success(function(e,t,i,n){if(e.success&&e.id!=null){k();s.add("修改成功！")}else{s.add("修改失败！","danger")}})};var w=function(s){g=r.signinConfig.ldapSignIn.password;r.signinConfig.ldapSignIn.password="";i({url:"check_ldap_config.json",method:"POST",data:r.signinConfig,headers:{Authorization:Base64.encode(g)}}).success(function(e,t,i,n){r.signinConfig.ldapSignIn.password=g;if(typeof s==="function"){s(e)}})};r.verifyLdapSetting=function(){if(false==b()){s.add("请填写完整ldap配置信息","danger");return}w(function(e){if(e.success){r.ldapverify=true;s.add("验证成功")}else{s.add("验证失败","danger");r.ldapverify=false}})};r.showOppenHelpCenterDiv=function(){_hmt.push(["_trackEvent","社区设置-访问控制","对外公开社区内容"]);r.div.show=3;document.getElementById("access_setting_tab3").checked=true};r.showSigninConfigInDiv=function(){_hmt.push(["_trackEvent","社区设置-访问控制","帐户和登录验证方式"]);if(r.div.show!=2){k();r.div.show=2}};r.updateProviderHelpcenter=function(){_hmt.push(["_trackEvent","社区设置-访问控制","对外公开社区内容更新"]);i({url:"updateProviderHelpcenter.json",method:"POST",params:{isOpen:r.oppenHelpCenter.isOpen}}).success(function(e,t,i,n){if(e.success==true||e.success=="true"){a.currentProviderIsOpenHelpcenter=r.oppenHelpCenter.isOpen;s.add("修改成功！")}else{s.add("修改失败！","danger")}})};r.showSigninConfigInDiv()}})();(function(){"use strict";angular.module("eweiApp.system_setting").controller("brand_setting_controller",e);e.$inject=["$rootScope","$scope","$state","$http","$upload","$timeout","$stateParams","$location","alertService","engineerService","permissionsService","ConsoleConfig","routerConstant","coreModelService","permissions"];function e(e,t,i,n,s,a,r,o,l,c,u,d,p,f,m){t.roleId=d.engineer.role.id;t.eweiHelpcenterApiUrl=d.eweiHelpcenterApiUrl;var g;var v={"system_setting.detail.helpcenter_appearance":"system_setting_helpcenter_custom","system_setting.detail.announcement_setting":"release_helpcenter_announcement","system_setting.detail.logo_setting":"system_setting_logo","system_setting.detail.email_setting":"system_setting_email","system_setting.detail.domain_setting":"system_setting_domain","system_setting.detail.oem_setting":"system_setting_oem"};var h=function(){if(m.hasPermission("system_setting_helpcenter_custom")){g="system_setting.detail.helpcenter_appearance"}else if(m.hasPermission("release_helpcenter_announcement")){g="system_setting.detail.announcement_setting"}else if(m.hasPermission("system_setting_logo")){g="system_setting.detail.logo_setting"}else if(m.hasPermission("system_setting_email")){g="system_setting.detail.email_setting"}else if(m.hasPermission("system_setting_domain")){g="system_setting.detail.domain_setting"}else if(m.hasPermission("system_setting_oem")){g="system_setting.detail.oem_setting"}};var y=f.config.route.get("system-setting.brand-setting");if(y&&y.name){if(m.hasPermission(v[y.name])){g=y.name}else{h()}}else{h()}var _={"/system_setting/system/appearance":"system_setting.detail.helpcenter_appearance","/system_setting/system/announcement_setting":"system_setting.detail.announcement_setting","/system_setting/system/logo_setting":"system_setting.detail.logo_setting","/system_setting/system/email_setting":"system_setting.detail.email_setting","/system_setting/system/domain_setting":"system_setting.detail.domain_setting","/system_setting/system/system/oem_setting":"system_setting.detail.oem_setting"};var k=o.path();if(_.hasOwnProperty(k)){g=_[k]}if(p.getNotify()){g="system_setting.detail.notify";p.setNotify(null)}if(g=="system_setting.detail.group"){i.go(g,{id:t.roleId,type:"update"})}else{i.go(g)}}})();angular.module("eweiApp.account").controller("viewUserGroupListController",["$rootScope","$scope","$stateParams","$filter","userGroupService","utils","$state","$timeout","ngTableParams","$http","alertService","$upload","$modal_","permissions","$location","locker","license","providerJudgement","apiRestfulService","ConsoleConfig","coreModelService","coreNotifyService","apiCustomerGroupCustomFieldValueService","apiCustomFieldListShowService","apiUserGroupsService","$ocLazyLoad","DefaultColumnWidth",function(m,g,r,v,e,a,o,t,i,l,c,n,s,u,d,p,f,h,y,k,C,b,w,T,S,F,A){g.view={};var E;var O;var I="userGroup-"+r.id;var L=C.config.route.get("search."+I);var D=C.config.route.get("sort."+I);var P=this.__proto__.constructor.name+"_"+Date.now();g.advancedQueryCondition=L?L.advancedQueryCondition||{}:{};g.argument={_page:1,_count:-1,_fields:"",_filter:"",_asc:D?D.order=="asc"?D.orderBy:"":"",_desc:D?D.order=="desc"?D.orderBy:"":"",searchType:L?L.searchType:null,advancedQueryCondition:L?L.advancedQueryCondition:null,searchKey:L?L.searchKey:null};g.argumentLast=angular.copy(g.argument);if(L&&L.searchType=="advancedQuery"){g.isAdvancedQuery=true}g.showCheckboxes=true;g.defaultSortParams={};g.serverDataLoaded=false;var x=false;g.placeholder="搜索分组名称/标签/email域名";var N=function(e){var t="w150";do{if("name"==e){t="w200";break}if("nickname"==e){t="w200";break}if("id"==e){t="w70";break}}while(0);return t};var M=function(e,t){for(var i in e){if(e[i]==t){return i}return""}};g.sorting=function(e){var t=g.tableParams.isSortBy(e.field,"desc");if(t){g.argument._asc=e.field;g.argument._desc=""}else{g.argument._desc=e.field;g.argument._asc=""}var i=g.tableParams.isSortBy(e.field,"desc")?"asc":"desc";e.sortable?g.tableParams.sorting(e.field,i):"";g.defaultSorting=e.field==g.defaultSortParams.orderBy&&i==g.defaultSortParams.order;D={order:i,orderBy:e.field}};var j=function(){var i=C.detail.fields.title.gets(C.list.fields.title.get(I).gets(1));g.columns=[];var n=[];if(g.view&&g.view.sortFields){g.view.sortFields=angular.fromJson(g.view.sortFields);angular.forEach(g.view.sortFields,function(e){for(var t=0;t<i.length;t++){if(i[t].id==e.id){n.push(i[t]);break}}})}n=n.length>0?n:i;var t=[];angular.forEach(n,function(e){g.columns.push({title:e.title,field:e.id,visible:true,sortable:e.systemFieldKey?true:false,widthClass:N(e.id),type:e.type,length:e.length});t.push(e.id)});C.list.fields.title.get(I).put(1,t);g.tableParams&&g.tableParams.reload()};g.setRows=function(e){if(!g.tableParams)return;x=true;var t=g.tableParams.count();if(e==t)return;g.tableParams.count(e);g.argument._count=e;g.tableParams.page(g.argument._page);g.tableParams.getData(g.tableParams)};var R=function(){g.tableParams=g.tableParams||new i({page:g.argument._page,count:g.argument._count,sorting:JSON.parse('{"'+g.view.orderBy+'":"'+g.view.order+'"}')},{counts:[],groupBy:function(e){return null},total:0,getData:function(e,t){g.argument._page=angular.copy(t.page());C.list.userGroups.get(I).page(angular.copy(t.page()));K();t.total(C.list.userGroups.get(I).total());e.resolve(g.userGroups)}});if(D){g.tableParams.$params.sorting={};g.tableParams.$params.sorting[D.orderBy]=D.order}};var U=function(){T.run(I,b.constant.EVENT_LIST_FIELD_TITLE,1,"",{view_id:g.view.id},function(e){})};var V=function(){if(g.view&&g.view.customFields){var e=JSON.parse(g.view.customFields);var t=[];angular.forEach(e,function(e){t.push(e.id)});var i=C.list.userGroups.get(I).gets(g.argument._page).join(",");if(i&&i.length>0){w.run(I,b.constant.EVENT_DETAIL_CUSTOMERS,1,"",{customFieldIds:t.join(","),userGroupIds:i},function(e){if(e){}})}}};var q=function(e){g.view=C.detail.customers.views.get(r.id);if(g.view){g.argument._fields=g.view.fields;g.argument._filter=g.view.filter;g.argument._page=C.list.customers.get(I).page();g.tableParams.page(g.argument._page);if(!D){if("desc"==g.view.order){g.argument._desc=g.view.orderBy}else if("asc"==g.view.order){g.argument._asc=g.view.orderBy}}g.defaultSortParams={order:g.view.order,orderBy:g.view.orderBy};g.defaultSorting=D?D.orderBy==g.defaultSortParams.orderBy&&D.order==g.defaultSortParams.order:true;U();if(angular.isString(g.view.customFields)&&angular.isString(g.view.customFieldsLength)){g.customFieldsLength={};var t=angular.fromJson(g.view.customFields);var i=g.view.customFieldsLength.split(",");if(angular.isDefined(t)&&t.length==i.length){t.forEach(function(e,t){g.customFieldsLength[parseInt(e.id)]=parseInt(i[t])})}}if(angular.isString(g.view.fields)&&angular.isString(g.view.fieldsLength)){g.fieldsLength={};var n=g.view.fields.split(",");var s=g.view.fieldsLength.split(",");if(angular.isString(g.view.groupBy)&&n.length!=s.length){for(var a=0;a<n.length;a++){if(n[a]==g.view.groupBy){n.splice(a,1);break}}}if(n.length==s.length){n.forEach(function(e,t){if(e&&e.length>0){g.fieldsLength[e]=parseInt(s[t])}})}}g.viewTitle="客户组";g.columnType="userGroup";g.importData=null}};var G=function(){H();j();R();q(r.id)};var K=function(){B();if(x&&JSON.stringify(g.argument)!=JSON.stringify(g.argumentLast)){Q();g.argumentLast=angular.copy(g.argument)}};var B=function(){g.userGroups=C.detail.customerGroups.gets(C.list.userGroups.get(I).gets(g.argument._page))};var Q=function(){b.doNotify(b.constant.EVENT_LIST_DATA_LOADING,{typeKey:I,isLoading:true});S.run(I,b.constant.EVENT_LIST_CUSTOMERGROUP_REFRESH,g.argument._page,"",g.argument,function(e){b.doNotify(b.constant.EVENT_LIST_DATA_LOADING,{typeKey:I,isLoading:false})})};var H=function(){b.register(P,b.constant.EVENT_DETAIL_CUSTOMERGROUPS,function(e,t){angular.forEach(g.userGroups,function(e){if(e.id==t.id){e=C.detail.customerGroups.get(t.id)}})});b.register(P,b.constant.EVENT_LIST_CUSTOMERGROUP_REFRESH,function(e){V();g.tableParams.reload()});b.register(P,b.constant.EVENT_LIST_FIELD_TITLE,function(e){j()});b.register(P,b.constant.EVENT_LIST_DATA_LOADING,function(e,t){if(t.typeKey==I){g.serverDataLoaded=true;if(g.userGroups&&g.userGroups.length>0){g.isCustomerLoading=false}else{g.isCustomerLoading=t.isLoading;if(!t.isLoading&&g.userGroups&&g.userGroups.length==0){g.noDataTip="没有相关数据"}}}})};G();var W=function(){b.unRegister(P)};g.$on("userGroupListViewLoad",function(){q(r.id);j()});g.$on("$destroy",function(){W();C.config.route.put("search."+I,{searchType:g.argument.searchType,advancedQueryCondition:g.argument.advancedQueryCondition,searchKey:g.argument.searchKey});if(D){C.config.route.put("sort."+I,D)}else{C.config.route.remove("sort."+I)}C.config.forceSave()});g.createUser=function(){m.$broadcast("createNewUser")};g.clearSorting=function(){delete g.argument._asc;delete g.argument._desc;if(g.defaultSortParams.order&&g.defaultSortParams.orderBy){if(g.defaultSortParams.order=="asc"){g.argument._asc=g.defaultSortParams.orderBy}else{g.argument._desc=g.defaultSortParams.orderBy}}g.defaultSorting=true;D=null;g.argumentLast=null;g.tableParams.$params.sorting={};g.tableParams.$params.sorting[g.defaultSortParams.orderBy]=g.defaultSortParams.order;g.tableParams.reload()};g.advancedQuery=function(){g.advancedQueryError="";if(g.advancedQueryCondition.lastLoginAtFrom==null&&g.advancedQueryCondition.lastLoginAtTo==null&&g.advancedQueryCondition.userGroup==null&&g.advancedQueryCondition.createdAtFrom==null&&g.advancedQueryCondition.createdAtTo==null&&g.advancedQueryCondition.updatedAtFrom==null&&g.advancedQueryCondition.updatedAtTo==null&&g.advancedQueryCondition.name==null&&g.advancedQueryCondition.nickname==null&&g.advancedQueryCondition.email==null&&g.advancedQueryCondition.mobilePhone==null&&g.advancedQueryCondition.phone==null){g.advancedQueryError="查询条件不能为空";return}g.isAdvancedQuery=true;if(g.advancedQueryCondition.createdAtFrom!=null){g.advancedQueryCondition.createdAtFrom=v("date")(g.advancedQueryCondition.createdAtFrom,"yyyy-MM-dd")}if(g.advancedQueryCondition.createdAtTo!=null){g.advancedQueryCondition.createdAtTo=v("date")(g.advancedQueryCondition.createdAtTo,"yyyy-MM-dd")}if(g.advancedQueryCondition.updatedAtFrom!=null){g.advancedQueryCondition.updatedAtFrom=v("date")(g.advancedQueryCondition.updatedAtFrom,"yyyy-MM-dd")}if(g.advancedQueryCondition.updatedAtTo!=null){g.advancedQueryCondition.updatedAtTo=v("date")(g.advancedQueryCondition.updatedAtTo,"yyyy-MM-dd")}if(g.advancedQueryCondition.lastLoginAtFrom!=null){g.advancedQueryCondition.lastLoginAtFrom=v("date")(g.advancedQueryCondition.lastLoginAtFrom,"yyyy-MM-dd")}if(g.advancedQueryCondition.lastLoginAtTo!=null){g.advancedQueryCondition.lastLoginAtTo=v("date")(g.advancedQueryCondition.lastLoginAtTo,"yyyy-MM-dd")}g.argument.searchType="advancedQuery";g.argument.advancedQueryCondition=angular.copy(g.advancedQueryCondition);if(g.argument._page!=1){g.tableParams.page(1)}else{g.tableParams.reload()}$("#queryModal").modal("hide")};g.clearSearch=function(){if(g.argument.searchKey!=null||g.isAdvancedQuery){g.oldSearchKey=null;g.isAdvancedQuery=false;g.advancedQueryCondition={};g.argument.advancedQueryCondition={};g.argument.searchKey="";g.argument.searchType="";g.argumentLast=null;C.config.route.remove("customer-search."+I);C.config.forceSave();if(g.argument._page!=1){g.tableParams.page(1)}else{g.tableParams.reload()}}};g.search=function(e){_hmt.push(["_trackEvent","用户管理","搜索用户组"]);if(g.argument.searchKey==""){g.clearSearch()}else{if(g.argument.searchKey!=g.oldSearchKey){g.oldSearchKey=g.argument.searchKey;g.argument.searchType="searchKeyQuery";if(g.argument._page!=1){g.tableParams.page(1)}else{g.tableParams.reload()}}}};var M=function(e,t){for(var i in e){if(e[i]==t){return i}return""}};g.createUser=function(){m.$broadcast("createNewUser")};g.createUserGroup=function(){m.$broadcast("createNewUserGroup")};g.checkboxes={checked:false,items:{}};g.$watch("checkboxes.checked",function(t){angular.forEach(g.userGroups,function(e){if(angular.isDefined(e.id)){g.checkboxes.items[e.id]=t}})});g.$watch("checkboxes.items",function(e){if(!g.userGroups){return}var t=0,i=0,n=g.userGroups.length;angular.forEach(g.userGroups,function(e){t+=g.checkboxes.items[e.id]||0;i+=!g.checkboxes.items[e.id]||0});if(i==0||t==0){g.checkboxes.checked=t==n}angular.element(document.getElementById("select_all")).prop("indeterminate",t!=0&&i!=0);g.hasSelected=false;for(var s in g.checkboxes.items){if(g.checkboxes.items[s]){g.hasSelected=true;break}g.hasSelected=false}},true);var J=function(){var e=[];for(var t in g.checkboxes.items){if(g.checkboxes.items[t]){e.push(t)}}g.checkboxes.items={};return e};g.cancelAllSelected=function(){g.checkboxes={checked:false,items:{}}};var z=function(){l.get("user_group_list.json?_count=999&_do_count=false&_fields=id,name,shared",{}).then(function(e){userAginLogin(e);g.userGroups=e.data.userGroups})};g.deleteUserGroups=function(){_hmt.push(["_trackEvent","客户组","删除"]);g.confirmContent="删除客户组可能会对自动化、触发器、工单视图、社区目录权限等设置有影响，是否确定删除？确定删除后，该客户组中的客户将变成未分组状态。";var e=s({scope:g,title:"删除客户组",contentTemplate:"source/views/confirm_template.html",html:true,show:true,placement:"center"});g.hideModal=function(){e.$promise.then(e.hide)};g.$ok=function(){var t=J();l({url:"/api/v1/user_group/delete_by_ids.json",method:"delete",params:{_token:getCookie("user_token"),provider_id:k.provider.id},data:t}).success(function(e){g.hideModal();if(e.status===0){c.add("删除成功！","success");Q();t.forEach(function(e){if(a.findTabById("user_groups_detail"+e)){a.removeTabById(o,"user_groups_detail"+e)}})}else{c.add("删除失败，请重新尝试！","error")}void 0})}};g.settingUserGroup=function(){z();var e=s({scope:g,title:"移入一个客户组",contentTemplate:"source/views/select_user_group_template.html",html:true,show:true,placement:"center"});g.hideModal=function(){e.$promise.then(e.hide)};g.$ok=function(e){var t;var i=J();if(e==null){t={ids:i.join(","),userGroupId:null}}else{t={ids:i.join(","),userGroupId:e.id,shared:e.shared}}l({url:"batch_update_user_group.json",method:"POST",data:t}).success(function(e,t,i,n){g.hideModal();if(e.success){g.tableParams.reload()}else{c.add("移入客户组失败","danger")}})}};g.temp=function(e,t){g.available=true;g.actived=e;l.get("user/"+t.list.id+".json").success(function(e,t){var i="";g.userCustom=e.json;angular.forEach(g.userCustom.tags,function(e){if(i==""){i+=e.name}else{i+=","+e.name}});g.userCustom.list=i});l.get("user_custom_field.json?userId="+t.list.id).success(function(e,t){g.ticketMerge=e.json;return false})};g.mergeUser=function(){var t=J();if(t.length>5){void 0;return false}else if(t.length<=1){void 0;return false}var i=[];g.actived=100;g.available=false;g.userInfo={target:{}};g.selection="settings0";angular.forEach(g.customers,function(e){if(t.indexOf(e.id.toString())>-1){i.push(e)}});g.lists=i;g.form={};g.nextTo=function(){if(!g.form.selectRadio){c.add("请选择合并到哪一个客户","danger");return false}g.selection="settings1";l.get("user/"+g.form.selectRadio+".json").success(function(e,t){var i="";g.userInfo.target=e.json});l.get("user_custom_field.json?userId="+g.form.selectRadio).success(function(e,t){g.ticket=e.json})};g.editBox=function(e){g.available=false;g.actived=e};var e=s({scope:g,template:"modal/modal.tpl.w670.html",contentTemplate:"source/views/customer/merge_user.html",html:true,show:true,placement:"center"});g.hideModal=function(){e.$promise.then(e.destroy)};g.$ok=function(){var i=true;angular.forEach(g.ticket.ticketCustomFields,function(e){var t=new RegExp(e.customField.regexpForValidation);if(e.value&&!t.test(e.value)&&i==true){c.add("请输入正确的"+e.customField.title,"danger");i=false}else if(e.customField.required==true&&(!e.value||e.value=="-")&&i==true){c.add("请输入"+e.customField.title,"danger");i=false}});if(!i){return false}g.userInfo.userCustomFields=g.ticket.ticketCustomFields;g.userInfo.customerIds=t.join(",");var e=/^\s*([A-Za-z0-9_]+[_\-\.\w]*@([_\-\w]+\.)+[_\-\w]{2,3})\s*$/;if(g.userInfo.target.name==undefined||g.userInfo.target.name==""){c.add("用户名不能为空","danger");return false}else if(!verifyEmailAddress(g.userInfo.target.email)&&g.userInfo.target.email){c.add("邮箱格式错误","danger");return false}else if(!validMobilePhone(g.userInfo.target.mobilePhone)&&g.userInfo.target.mobilePhone){c.add("请输入正确的手机号","danger");return false}l({url:"merge_customer.json",method:"POST",data:g.userInfo}).success(function(e,t,i,n){if(e.success){g.hideModal();g.importData="success";g.tableParams.reload()}else{if(e.message!=undefined){c.add(v("translate")(e.message),"danger")}else{c.add("合并客户失败","danger")}}})}};g.blacklist=function(){_hmt.push(["_trackEvent","客户管理","加入黑名单"]);if(g.view.title=="VIEW_TITLE_USER"){g._messages="您确定要将这些客户加入黑名单吗？";g._title="加入黑名单确认"}else{g._messages="您确定要将这些客户移出黑名单吗？";g._title="移出黑名单确认"}var e=s({scope:g,title:g._title,contentTemplate:"source/views/alter_common.html",html:true,show:true,placement:"center"});g.hideModal=function(){e.$promise.then(e.hide)};g.$ok=function(){if(g.view.title=="VIEW_TITLE_USER"){_hmt.push(["_trackEvent","客户管理","加入黑名单-确认"])}else{_hmt.push(["_trackEvent","客户管理","移出黑名单-确认"])}var r=J();l({url:"batch_update_valid.json",method:"POST",data:{ids:r.join(","),valid:g.view.title=="VIEW_TITLE_USER"?false:true}}).success(function(e,t,i,n){g.hideModal();if(e.success){for(var s=0;s<E.length;s++){var a=E[s];if(g.view.title=="VIEW_TITLE_USER"&&a.title=="VIEW_TITLE_USER_BLACKLIST"){a.count=a.count+r.length;break}else if(g.view.title=="VIEW_TITLE_USER_BLACKLIST"&&a.title=="VIEW_TITLE_USER"){a.count=a.count+r.length;break}}g.importData="success";g.tableParams.reload()}else{if(g.view.title=="VIEW_TITLE_USER"){c.add("加入黑名单失败","danger")}else{c.add("移出黑名单失败","danger")}}})};g.hideBlack=function(){if(g.view.title=="VIEW_TITLE_USER"){_hmt.push(["_trackEvent","客户管理-加入黑名单","取消"])}else{_hmt.push(["_trackEvent","客户管理-移出黑名单","取消"])}}};g.deleteUsers=function(){_hmt.push(["_trackEvent","客户","删除"]);g.confirmContent="您确定要删除这些客户吗？";var e=s({scope:g,title:"确认",contentTemplate:"source/views/confirm_template.html",html:true,show:true,placement:"center"});g.hideModal=function(){e.$promise.then(e.hide)};g.hideBlack=function(){_hmt.push(["_trackEvent","客户-删除","取消"])};g.$ok=function(){_hmt.push(["_trackEvent","客户-删除","确认"]);var s=J();l({url:"batch_delete_users.json",method:"POST",data:{ids:s.join(",")}}).success(function(e,t,i,n){g.hideModal();if(e.success){g.importData="success";c.add("删除成功","success");g.tableParams.reload();s.forEach(function(e){if(a.findTabById("customers_detail"+e)){a.removeTabById(o,"customers_detail"+e)}})}else{c.add("批量删除失败","danger")}})}};g.viewAccounList=function(){_hmt.push(["_trackEvent","客户管理","遍历"]);if(g.userGroups.length<=0){return false}p.driver("session").namespace("eweiApp.account").put("userGroupFlowMap",g.userGroups);p.driver("session").namespace("eweiApp.account").put("userGroupNum",1);o.go("user_groups_detail",{id:g.userGroups[0].id,viewUserGroupList:g.userGroups})};g.editList=function(){_hmt.push(["_trackEvent","客户管理","编辑列表"]);if(g.view.type=="user"){o.go("system_setting.detail",{uri:"user_custom_view",settingType:"customer"})}else if(g.view.type=="userGroup"){o.go("system_setting.detail",{uri:"user_group_custom_view",settingType:"customer"})}};var Y=function(e){try{var a=m.batchWorker=new Worker("/source/scripts/user-group-batch-export.js");var t=JSON.parse(g.view.customFields||null);var r=_.map(t,function(e){return e.id});var o=angular.copy(g.columns);var i=_.map(o,function(e){return e.title});var n=[];n.push({A:"查询条件"});n.push({A:"一般查询",B:g.argument.searchKey||""});var l=100;var c=g.tableParams.total();var u=XLSX.utils.json_to_sheet(n,{skipHeader:true});XLSX.utils.sheet_add_aoa(u,[i],{origin:{r:3,c:0}});var d=angular.extend({},g.argument);delete d._count;delete d._page;var p=0;var f=4;u["!cols"]=_.map(o,function(e){return{wpx:e.length||A.userGroupFields[e.field]||180}});u["!merges"]=[{s:{c:0,r:0},e:{c:3,r:0}},{s:{c:1,r:1},e:{c:3,r:1}}];a.onmessage=function(e){if(!e.data||!e.data.type)return;switch(e.data.type){case"ready":{a.postMessage({type:"batch-getdata",pageSize:l,total:c,customFields:r,credential:{provider_id:k.provider.id,_token:getCookie("user_token")},params:d});break}case"started":{break}case"progress":{var n=[];var t=e.data.data.data.userGroups;t.forEach(function(t){var i=[];o.forEach(function(e){if(e.field==="shared"){t[e.field]=t[e.field]?"是":"否"}else if(e.type==="checkbox"&&!t[e.field]){t[e.field]="false"}i.push(t[e.field])});n.push(i)});XLSX.utils.sheet_add_aoa(u,n,{origin:{r:f,c:0}});f+=t.length;p+=t.length;m.$broadcast("batch-progress",{finished:p,total:e.data.data.data._total});break}case"finished":{a.terminate();delete m.batchWorker;m.$broadcast("batch-finished",{finished:p,total:c,reason:e.data.data.reason});var i=XLSX.utils.book_new();var s=(v("translate")(g.view.title)||"").replace(/[\\\/\?\*\[\]\'\:\<\>\|\"]/g,"_")+moment().format("YYYYMMDDHHmm");XLSX.utils.book_append_sheet(i,u,s);XLSX.writeFile(i,s+".xlsx");break}}}}catch(e){m.batchWorker=undefined;m.$broadcast("batch-finished",{finished:p,total:g.tableParams.total(),reason:"error"})}};g.exportExcel=function(){_hmt.push(["_trackEvent","客户组管理","导出Excel"]);if(m.batchWorker){c.add("上一个批量任务尚未结束，请稍后再试","danger");return}m.$broadcast("batch-started",{total:g.tableParams.total(),batchType:"user-group-batch-export"});F.load(["source/lib/xlsx/xlsx.full.min.js"]).then(function(){Y(g.argument.advancedQueryCondition||{})},function(e){m.batchWorker=undefined;m.$broadcast("batch-finished",{finished:0,total:g.tableParams.total(),reason:"error"})});return};g.datepickers={startForm:false,startTo:false,updateFrom:false,updateTo:false};g.open=function(e,t){e.preventDefault();e.stopPropagation();g.datepickers[t]=true};g.downLoadfailureCustomerRecored=function(){g.hideBatchAddCustomerModal();var e="/download_import_user_failure_record?recordId="+g.recordId;window.open(e)};g.importUserComplete=false;g["import"]=function(){if(!h.isTrue()){return false}_hmt.push(["_trackEvent","客户管理","批量导入客户"]);var e="客户导入";if(g.view.type=="userGroup"){e="客户分组导入"}else{if(!h.isTrue()){return false}}var t=s({scope:g,title:e,contentTemplate:"source/views/customer/user_excel_url.choice.html",html:true,show:true,placement:"center",backdrop:"static"});g.hideBatchAddCustomerModal=function(){g.importUserComplete=false;t.$promise.then(t.hide)};g.fileIsNUll=false;g.datas=[];g.titles=[];g.options=[];g.titleOptions=[];g.customFieldIdMap={};g.$read=function(e){if(e==null||e==undefined||e.length<=0){return}g.fileIsNUll=true;g.fileName=e[e.length-1].name;var t="resolve_customer_excel.json";if(g.view.type=="userGroup"){t="resolve_usergroup_excel.json"}e.upload=n.upload({url:t,method:"POST",file:e});e.upload.then(function(e){if(e.data.success){var t=e.data.json;g.titles=t.titles;g.options=t.selectPropertyOptions;var i;for(var n=0,s=t.titles.length;n<s;n++){i=t.titles[n];var a={title:i};g.options.some(function(e){if(e.option===i){a.selectProperty=e.value;return true}});g.titleOptions.push(a)}g.datas=t.datas;g.customFieldIdMap=t.customFieldIdMap;g.fileIsNUll=true}else{var r=e.data.message;c.add(r+" 请查看详细说明","danger");g.fileIsNUll=false}void 0},function(e){g.uploading=false;g.errorMsg=e.status+": "+e.data});e.upload.progress(function(e){g.uploading=true;void 0});e.upload.xhr(function(e){e.upload.addEventListener("abort",function(){void 0;g.uploading=false},false)})};g.$explain=function(){var e=s({scope:g,title:"客户导入详细说明",contentTemplate:"source/views/customer/user_import_explain.html",html:true,show:true,placement:"center",backdrop:"static"})};g.$template=function(e){g.hideBatchAddCustomerModal();var t="/export_user_template?&templateType="+e;if(g.view.type=="userGroup"){t="/export_group_template?&templateType="+e}window.open(t)};g.importting=false;g.importCustomerOrGroup=function(e){var t=document.getElementById("repeatedCustomerUpdate");var i=false;if(t.checked===true){i=true}g.importting=true;var n="/import_user.json?update="+i;if(g.view.type=="userGroup"){n="/import_user_group.json?update="+i}l({url:n,method:"POST",timeout:18e4,data:e}).success(function(e,t,i,n){g.importting=false;if(e.success){g.failureCount=e.json.failureCount;g.successCount=e.json.successCount;g.recordId=e.json.recordId;g.importData="success";g.importUserComplete=true;g.tableParams.reload()}else if(e.data&&e.data.message){c.add(e.data.message,"danger")}else{c.add("请检查文件类型，格式！","danger")}g.uploading=false}).error(function(e,t,i,n){c.add("导入失败,请稍候再试！","danger");g.importting=false})};g.$save=function(){var e=g.titleOptions;var t=new Array;var i=new Array;for(var n=0;n<e.length;n++){var s=e[n].selectProperty;if(s==undefined||s==null||s==""){c.add("请选择完整!","danger");return}for(var a=0;a<t.length;a++){if(t[a]==e[n].selectProperty){c.add("选择重复!","danger");return}}for(var r=0;r<g.options.length;r++){if(g.options[r].value===e[n].selectProperty){i[n]=g.options[r].option;break}}t[n]=e[n].selectProperty}var o={};o.titles=g.titles;o.fileds=i;o.selectPropertys=t;o.datas=g.datas;o.customFieldIdMap=g.customFieldIdMap;g.importCustomerOrGroup(o)}}}]).controller("userCustomViewController",["$rootScope","$scope","$state","$filter","$location","$http","alertService","DefaultColumnWidth",function(e,l,t,i,n,c,u,d){l.noUseOptions=[];l.useOptions=[];l.userSortModel={};var p=[];c.get("get_field_list.json?scope=user&ignore_scan_able=true").success(function(e){if(e.success&&e.json){l.userSortModel.groupBy=e.json.groupBy||"";l.userSortModel.orderBy=e.json.orderBy||"";l.userSortModel.order=e.json.order||"";l.description=e.json.description;p=p.concat(e.json.defaultFields,e.json.customFields);for(var t=0;t<p.length;t++){if(p[t].active==false){continue}var i=p[t].length||p[t].default_length||d.userFields[p[t].key];var n=p[t].default_length||d.userFields[p[t].key];var s=p[t].length||p[t].default_length||d["userDefault"];var a=p[t].default_length||d["userDefault"];if(p[t].checked){if(p[t].id){l.useOptions.push({key:p[t].id,value:p[t].title,type:"custom",length:s,default_length:a})}else{l.useOptions.push({key:p[t].key,value:p[t].value,type:"default",length:i,default_length:n})}}else{if(p[t].id){l.noUseOptions.push({key:p[t].id,value:p[t].title,type:"custom",length:s,default_length:a})}else{l.noUseOptions.push({key:p[t].key,value:p[t].value,type:"default",length:i,default_length:n})}}}if(e.json.sortFields){var r=JSON.parse(e.json.sortFields)}if(r&&r.length>0){var o=[];angular.forEach(r,function(e){for(var t=0;t<l.useOptions.length;t++){if(l.useOptions[t].key==e.id){o.push(l.useOptions[t]);break}}});l.useOptions=o}}});l.sortableOptions={connectWith:".sortable",beforeStop:function(e,t){},stop:function(e,t){}};l.useSortableOptions={connectWith:".sortable",beforeStop:function(e,t){if(t.item.context.textContent=="姓名"){var i=t.originalPosition.left;var n=t.position.left;if(i-n>50){t.item.sortable.cancel();u.add("姓名必须显示","danger")}}else if(t.item.context.textContent=="编号"){var i=t.originalPosition.left;var n=t.position.left;if(i-n>50){t.item.sortable.cancel();u.add("编号必须显示","danger")}}else{var i=t.originalPosition.left;var n=t.position.left;if(i-n>50&&l.useOptions.length<5){t.item.sortable.cancel();u.add("显示的列不能少于4个","danger")}}},stop:function(){}};l.showDefault=function(e){e.isShowDefault=!e.isShowDefault};l.setDefault=function(e){e.length=e.default_length};l.orderByChange=function(){if(l.userSortModel.orderBy){l.userSortModel.order="desc"}else{l.userSortModel.order=""}};l.updateView=function(){_hmt.push(["_trackEvent","自定义客户视图","更新"]);var e=[],t=[];var i=[],n=[];var s=l.useOptions;var a=[];var r;for(var o in s){r={};if(!isNaN(o)){if(!Number(s[o].length)||s[o].length<=0){u.add("列宽必须为正数","danger");return false}if(s[o].type=="default"){e.push(s[o].key);t.push(s[o].length);r.type="system"}else{i.push(s[o].key);n.push(s[o].length);r.type="custom"}r.id=s[o].key;a.push(r)}}c.post("update_user_view.json?scope=user&default="+e+"&defaultLength="+t+"&orderBy="+l.userSortModel.orderBy+"&order="+l.userSortModel.order+"&groupBy="+l.userSortModel.groupBy+"&custom="+i+"&customLength="+n+"&description="+(l.description?l.description:"")+"&sortFields="+JSON.stringify(a)).success(function(e,t){if(e.success){u.add("更新成功","success")}else{u.add("更新失败","danger")}})}}]);(function(){"use strict";angular.module("eweiApp.account").controller("userGroupCustomViewController",["$rootScope","$scope","$state","$filter","$location","$http","alertService","DefaultColumnWidth",function(e,l,t,i,n,c,u,o){l.customFields=[];l.defaultFields=[];l.showFields=[];l.noUseOptions=[];l.useOptions=[];l.fields={};c.get("get_group_field_list.json?scope=user_group&ignore_scan_able=true").success(function(e,t){l.fields=e.json;l.customFields=l.fields.customFields;l.defaultFields=l.fields.defaultFields;l.showFields=l.fields.showFields;l.description=l.fields.description;for(var i in l.defaultFields){if(!isNaN(i)){var n=l.defaultFields[i].length||l.defaultFields[i].default_length||o.userGroupFields[l.defaultFields[i].key];var s=l.defaultFields[i].default_length||o.userGroupFields[l.defaultFields[i].key];if(l.defaultFields[i].checked){l.useOptions.push({key:l.defaultFields[i].key,value:l.defaultFields[i].value,type:"default",length:n,default_length:s})}else{l.noUseOptions.push({key:l.defaultFields[i].key,value:l.defaultFields[i].value,type:"default",length:n,default_length:s})}}}for(var i in l.customFields){if(!isNaN(i)){if(l.customFields[i].active==false){continue}var n=l.customFields[i].length||l.customFields[i].default_length||o["userGroupDefault"];var s=l.customFields[i].default_length||o["userGroupDefault"];if(l.customFields[i].checked){l.useOptions.push({key:l.customFields[i].id,value:l.customFields[i].title,type:"custom",length:n,default_length:s})}else{l.noUseOptions.push({key:l.customFields[i].id,value:l.customFields[i].title,type:"custom",length:n,default_length:s})}}}if(e.json.sortFields){var a=JSON.parse(e.json.sortFields)}if(a&&a.length>0){var r=[];angular.forEach(a,function(e){for(var t=0;t<l.useOptions.length;t++){if(l.useOptions[t].key==e.id){r.push(l.useOptions[t]);break}}});l.useOptions=r}});l.showDefault=function(e){e.isShowDefault=!e.isShowDefault};l.setDefault=function(e){e.length=e.default_length};l.sortableOptions={connectWith:".sortable",beforeStop:function(e,t){},stop:function(e,t){}};l.useSortableOptions={connectWith:".sortable",beforeStop:function(e,t){if(t.item.context.textContent=="客户组名称"){var i=t.originalPosition.left;var n=t.position.left;if(i-n>50){t.item.sortable.cancel();u.add("客户组名称必须显示","danger")}}else{var i=t.originalPosition.left;var n=t.position.left;if(i-n>50&&l.useOptions.length<5){t.item.sortable.cancel();u.add("显示的列不能少于4个","danger")}}},stop:function(){}};l.checked=function(e){document.getElementById(e).checked=!document.getElementById(e).checked;if(document.getElementById(e).checked){document.getElementById("li_"+e).style.background="#999999"}else{document.getElementById("li_"+e).style.background="#F8F8F8"}};l.updateView=function(){_hmt.push(["_trackEvent","自定义客户组视图","更新"]);var e=[],t=[];var i=[],n=[];var s=l.useOptions;var a=[];var r;for(var o in s){r={};if(!isNaN(o)){if(!Number(s[o].length)||s[o].length<=0){u.add("列宽必须为正数","danger");return false}if(s[o].type=="default"){e.push(s[o].key);t.push(s[o].length);r.type="system"}else{i.push(s[o].key);n.push(s[o].length);r.type="custom"}r.id=s[o].key;a.push(r)}}c.post("update_user_group_view.json?scope=user&default="+e+"&defaultLength="+t+"&custom="+i+"&customLength="+n+"&description="+(l.description?l.description:"")+"&sortFields="+JSON.stringify(a)).success(function(e,t){if(e.success){u.add("更新成功","success")}else{u.add("更新失败","danger")}})}}])})(angular);(function(f){"use strict";f.module("eweiApp.account").controller("userGroupDetailSlaController",e);e.$inject=["$rootScope","$scope","alertService","$state","$stateParams","apiWorkingDayService"];function e(e,s,a,t,i,r){s.userGroup=i.userGroup;r.getWorkingDay({userGroupId:s.userGroup.id},function(e){s.workingTime=e;s.weekTimes=JSON.parse(e.detailsJson);s.oldWorkingTime=s.workingTime.id?f.copy(s.workingTime):{}});s.saveWorkingTime=function(){if(s.vm.getHours()){if(s.oldWorkingTime.status!=s.workingTime.status||s.oldWorkingTime.detailsJson!=JSON.stringify(s.vm.getHours())){s.workingTime.detailsJson=JSON.stringify(s.vm.getHours());s.workingTime.userGroupId=s.userGroup.id;r.saveWorkingTime({workTime:s.workingTime},function(e){if(e>0){s.workingTime.id=e;s.oldWorkingTime.id=e}s.oldWorkingTime.detailsJson=f.copy(JSON.stringify(s.vm.getHours()));s.oldWorkingTime.status=s.workingTime.status})}else{a.add("数据未改变","danger")}s.saveHolidays()}};s.currentYear=(new Date).getFullYear();s.currentMonth=(new Date).getMonth();var n=parseInt(s.currentYear+""+(parseInt(s.currentMonth)>=9?s.currentMonth+1:"0"+(s.currentMonth+1)));var o={};var l={};var c={};var u={};s.holidayArray=[];var d=function(t){s.loadingData=true;r.getHoliday({userGroupId:s.userGroup.id,yearMonth:parseInt(t)},function(e){o[t]=JSON.parse(e.holidays);l[t]=f.copy(o[t]);c[t]=e.id;s.holidayArray=o[t];s.loadingData=false})};var p=function(){r.getWeekendWorking({userGroupId:s.userGroup.id},function(e){u=e;s.saturdayAsHoliday=f.copy(!e.saturdayWorking);s.sundayAsHoliday=f.copy(!e.sundayWorking)})};d(n);p();s.onDateChange=function(e,t,i){var n=o[e];if(!n){n=o[e]=[]}var s=n.indexOf(t);if(s>-1&&!i){n.splice(s,1)}if(s==-1&&i){n.push(t)}};s.onYearMonthChange=function(e){if(o.hasOwnProperty(e)){s.holidayArray=o[e]}else{s.loadingData=true;d(e)}};s.saveHolidays=function(){f.forEach(o,function(e,t,i){if(JSON.stringify(l[t])!=JSON.stringify(e)){var n={userGroupId:s.userGroup.id,holidays:JSON.stringify(e),yearAndMonth:parseInt(t)};if(c.hasOwnProperty(t)){n.id=c[t]}r.saveHolidays({holiday:n},function(e){if(e>0){c[t]=e}l[t]=f.copy(o[t])})}else{a.add("修改成功","success")}});if(u&&(u.saturdayWorking!=!s.saturdayAsHoliday||u.sundayWorking!=!s.sundayAsHoliday)){u.saturdayWorking=!s.saturdayAsHoliday;u.sundayWorking=!s.sundayAsHoliday;r.saveWeekendWorking({weekendWorking:u},function(e){if(e>0){u.id=e}})}else{a.add(u.id?"修改成功":"保存成功","success")}}}})(angular);(function(){"use strict";angular.module("eweiApp.system_setting").controller("my_account_controller",e);e.$inject=["$rootScope","$scope","$state","$http","$upload","$timeout","$stateParams","$location","alertService","engineerService","permissionsService","ConsoleConfig","routerConstant","coreModelService"];function e(e,t,i,n,s,a,r,o,l,c,u,d,p,f){t.roleId=d.engineer.role.id;t.eweiHelpcenterApiUrl=d.eweiHelpcenterApiUrl;var m;var g=f.config.route.get("system-setting.my-account");if(g){m=g.name}else{m="system_setting.detail.user"}var v={"/system_setting/my_account/update":"system_setting.detail.user","/system_setting/system/my_account/log":"system_setting.detail.log","/system_setting/system/my_account/notify":"system_setting.detail.notify","/system_setting/system/my_account/my-tickets":"system_setting.detail.my-tickets","/system_setting/system/my_account/my-activity":"system_setting.detail.my-activity","/system_setting/system/my_account/calendar":"system_setting.detail.calendar"};var h=o.path();if(v.hasOwnProperty(h)){m=v[h]}if(p.getNotify()){m="system_setting.detail.notify";p.setNotify(null)}i.go(m)}})();(function(){"use strict";angular.module("eweiApp.system_setting").controller("my_account_log_controller",e);e.$inject=["$rootScope","$scope","$state","$stateParams","alertService","$http","ConsoleConfig","apiLogService","coreModelService","coreNotifyService"];function e(t,i,e,n,s,a,r,o,l,c){var u=this.__proto__.constructor.name+"_"+Date.now();var d="list.my_account_logs";var p={_page:1,_count:20};var f;i.isMore={show:false,page:1,loading:false};i.userLoginLogNotify=false;function m(){if(t.currentUserLoginLogNotify){i.userLoginLogNotify=true}v();g()}function g(){var e=JSON.stringify(p)===JSON.stringify(f);i.isMore.loading=!e;i.userLoginLogs=o.getUserLogs(d,p,e,true,function(e){i.isMore.loading=false;if(e.result&&e.result.userLoginLogs&&e.result.userLoginLogs.length==p._count){i.isMore.show=true}else{i.isMore.show=false}});f=angular.copy(p)}function v(){c.register(u,c.constant.EVENT_LIST_LOG_REFRESH,function(e){g()})}function h(){c.unRegister(u)}m();i.$on("$destroy",function(){h()});i.more=function(){p._page++;i.isMore.loading=true;g()};i.updateUserLoginLogNotify=function(){a({url:"update_user_login_log_notify.json",method:"POST",params:{loginLogNotify:i.userLoginLogNotify}}).success(function(e){if(e.success){t.currentUserLoginLogNotify=i.userLoginLogNotify;s.add("更新成功！")}else{s.add("更新失败！","danger")}})}}})();(function(){"use strict";angular.module("eweiApp.system_setting").controller("my_account_notify_controller",e);e.$inject=["$scope","$modal_","coreNotifyService","$rootScope","apiNotifySettingService","alertService","apiNotifyTipService","apiGetEmailCoderService","apiBindEmailService","ConsoleConfig","$interval","license"];function e(i,n,e,t,s,a,r,o,l,c,u,d){void 0;var p=this;var f=p.__proto__.constructor.name+"_"+Date.now();i.notifyForm={};var m="/source/images/mobile/dashboard_android.png";var g="/source/images/mobile/dashboard_ios.png";i.userEmail=c.user.email;i.emailModelObj={};i.emailModelObj.newEmail=c.user.email;i.emailModelObj.verifyCode="";i.emailModelObj.error_tip="";i.emailModelObj.disabled=false;i.emailModelObj.btnInfo="获取验证码";i.emailModelObj.btnInfoS="";i.licenseService=d;i.bindEmail=function(){var e=n({scope:i,title:"绑定邮箱",contentTemplate:"source/views/system_setting/setting_notify_modal/bind_email.html",template:"modal/modal.tpl.w400.html",html:true,show:true,placement:"center"});i.hideModal_email=function(){e.$promise.then(e.hide)};i.getEmailCoder=function(){var e=/^[A-Za-z0-9]+(\.?[\w-]+)*@[\w-]+(\.[\w-]+)+$/;if(i.emailModelObj.newEmail==""){a.add("邮箱不能为空","danger");return false}if(!e.test(i.emailModelObj.newEmail)){a.add("邮箱格式不正确","danger");return false}o.run("",{newEmail:i.emailModelObj.newEmail},function(e){if(e.status!=0){i.emailModelObj.error_tip=e.result.error_description}else{i.emailModelObj.disabled=true;i.emailModelObj.btnInfoS="s";i.emailModelObj.btnInfo=60;var t=u(function(){--i.emailModelObj.btnInfo;if(i.emailModelObj.btnInfo==0){u.cancel(t);i.emailModelObj.btnInfo="获取验证码";i.emailModelObj.btnInfoS="";i.emailModelObj.disabled=false}},1e3)}})};i.sureBindEmail=function(){var e=/^[A-Za-z0-9]+(\.?[\w-]+)*@[\w-]+(\.[\w-]+)+$/;if(i.emailModelObj.newEmail==""){a.add("邮箱不能为空","danger");return false}if(i.emailModelObj.verifyCode==""){a.add("验证码不能为空","danger");return false}if(!e.test(i.emailModelObj.newEmail)){a.add("邮箱格式不正确","danger");return false}l.run("",{newEmail:i.emailModelObj.newEmail,verifyCode:i.emailModelObj.verifyCode},function(e){if(e.status!=0){i.emailModelObj.error_tip=e.result.error_description}else{i.userEmail=c.user.email=i.emailModelObj.newEmail;i.hideModal_email()}})}};i.checkApp=function(e){if(!i.box.appLoginFlag){v();i.notifyForm[e]=false}};i.checkWeChat=function(e){i.weChatFlag=true;i.dingdingFlag=false};i.dingding=function(e){i.dingdingFlag=true;i.weChatFlag=false};i.switchFn=function(e){if(e=="ios"){i.imgUrl=g}else{i.imgUrl=m}};i.switchFn("ios");function v(){var t=n({scope:i,title:"提示信息",contentTemplate:"source/views/system_setting/setting_notify_modal/app_notify.html",template:"modal/modal.tpl.w500.html",html:true,show:true,placement:"center"});i.hideModal1=function(){t.$promise.then(t.hide);var e=n({scope:i,title:"APP和微信客服端",contentTemplate:"source/views/component_popup.html",html:true,show:true,placement:"center"})}}i.saveSettings=function(){i.savingSettings=true;if(t.providerLicense&&t.providerLicense.type=="oem"){i.notifyForm.monthlyEmail=false}if(d.hasModule("oem")){i.notifyForm.monthlyEmail=false}if(typeof i.notifyForm.monthlyEmail=="undefined"){i.notifyForm.monthlyEmail=false}s.run("update",e.constant.EVENT_DETAIL_NOTIFYCONFIG,null,i.notifyForm,function(e){i.savingSettings=false;if(e.success){a.add("保存成功","success")}else{a.add("保存失败","danger")}})};var h=function(){e.register(f,e.constant.EVENT_DETAIL_NOTIFYCONFIG,function(e,t){if(t&&t.config){i.notifyForm=t.config}});e.register(f,e.constant.EVENT_DETAIL_NOTIFYTIP,function(e,t){if(t){i.box=t}})};var y=function(){e.unRegister(f)};i.$on("$destroy",function(){y()});function _(){s.run("get",e.constant.EVENT_DETAIL_NOTIFYCONFIG,null,null,function(){});r.run(e.constant.EVENT_DETAIL_NOTIFYTIP,null,null,function(){})}function k(){h();_()}k()}})();(function(){"use strict";angular.module("eweiApp.system_setting").controller("my_account_user_controller",e).filter("platformicon",t);e.$inject=["$rootScope","$scope","$state","$stateParams","$http","$filter","alertService","engineerService","permissionsService","$upload","$timeout","$q","ConsoleConfig","$modal_","$interval","apiRestfulService","apiEngineerService","coreModelService","coreNotifyService"];function e(s,h,e,t,a,i,r,n,o,l,c,u,d,p,f,m,g,v,y){h.modal={};h.modal.btn="更换手机";h.modal.email_btn="更换邮箱";var _=y.constant.EVENT_DETAIL_ENGINEERS_THIRDS;var k=this.__proto__.constructor.name+"_"+(new Date).valueOf();var C=function(){b();w()};var b=function(){y.register(k,_,function(e){S()})};h.loadServer=true;var w=function(){S();if(h.loadServer!=h.lastLoadServer){F();h.lastLoadServer=h.loadServer}};var T=function(){y.unRegister(k)};var S=function(){h.engineer=v.detail.engineers.get(d.engineer.id);if(h.engineer){h.engineersOld={};angular.copy(h.engineer,h.engineersOld);if(h.engineer.user.mobilePhone){h.modal.mobilePhone=h.engineer.user.mobilePhone}if(h.engineer.user.email){h.modal.email=h.engineer.user.email}if(h.engineer.user.mobilePhone){if(h.engineer.user.mobilePhoneExamined){h.modal.btn="更换手机"}else{h.modal.btn="验证手机"}}else{h.modal.btn="绑定手机"}if(h.engineer.user.email){if(h.engineer.user.emailExamined){h.modal.email_btn="更换邮箱"}else{h.modal.email_btn="验证邮箱"}}else{h.modal.email_btn="绑定邮箱"}}};var F=function(){g.run(d.engineer.id,_,"","","",function(e){g.getEngineerThirds({engineerId:d.engineer.id,userId:d.user.id},_,"","",function(e){})})};C();h.$on("$destroy",function(){T()});h.ownPermission=function(){h.engineerAccessScopes=[{label:"全部客服组(含组内客服，下同)",value:"all_engineers"},{label:"本人所在的客服组及协同客服组",value:"your_and_joint_service_desk_engineers"},{label:"本人所在的客服组",value:"your_service_desks_engineers"}];h.customerAccessScopes=[{label:"全部客户组(含组内客户，下同)",value:"all_customers"},{label:"本人所在的客服组绑定的客户组",value:"your_service_desks_user_groups_customers"},{label:"本人创建客户和客户组",value:"your_create_customer_or_groups_customers"}];h.ticketAccessScopes=[{label:"全部工单",value:"all_tickets"},{label:"本人所在客服组的工单",value:"your_service_desks_tickets"},{label:"本人创建的、处理中的和被抄送的工单",value:"your_tickets"}];h.chatAccessScopes=[{label:"全部会话",value:"all_chats"},{label:"本人所在客服组的会话",value:"your_service_desks_chats"},{label:"本人创建的、处理中的和参与的会话",value:"your_chats"}];h.projectAccessScopes=[{label:"全部项目",value:"all_project"},{label:"可见分类下的全部项目",value:"visible_category_project"},{label:"仅本人创建和被分享的项目",value:"my_project"}];h.communityAccessScopes=[{label:"访客",value:"ROLE_NAME_VISITOR"},{label:"作者",value:"ROLE_NAME_AUTHOR"},{label:"编辑",value:"ROLE_NAME_EDITOR"}];h.reportAccessScopes=[{label:"全部数据",value:"all_report"},{label:"本人所在客服组的数据",value:"your_service_desks_report"},{label:"仅本人的数据",value:"your_report"}];h.callAccessScopes=[{label:"全部通话",value:"all_call_records"},{label:"本人所在客服组的通话",value:"your_service_desks_call_records"},{label:"我的通话",value:"your_call_records"}];a.get("permissions_engineer_id.json?engineerId="+d.engineer.id).success(function(e){h.permissionses=e.json;h.checkboxes={};angular.forEach(h.permissionses,function(e){h.checkboxes[e]=true})});a.get("access_scope_engineer_id.json?engineerId="+d.engineer.id).success(function(e){h.accessScopes=e.json;var t=function(){var e=v("ticket");for(var t=0;t<h.ticketAccessScopes.length;t++){var i=h.ticketAccessScopes[t];if(i.value==e){h.ticketAccessScope=i;break}}var n=v("customer");for(var t=0;t<h.customerAccessScopes.length;t++){var s=h.customerAccessScopes[t];if(s.value==n){h.customerAccessScope=s;break}}var a=v("engineer");for(var t=0;t<h.engineerAccessScopes.length;t++){var r=h.engineerAccessScopes[t];if(r.value==a){h.engineerAccessScope=r;break}}var o=true;angular.forEach(h.engineerAccessScopes,function(e,t){if(o){if(a==e.value){h.engineerAccessScope=e;o=false}}});var l=v("chat");for(var t=0;t<h.chatAccessScopes.length;t++){var c=h.chatAccessScopes[t];if(c.value==l){h.chatAccessScope=c;break}}var u=v("report");for(var t=0;t<h.reportAccessScopes.length;t++){var d=h.reportAccessScopes[t];if(d.value==u){h.reportAccessScope=d;break}}var p=v("project");for(var t=0;t<h.projectAccessScopes.length;t++){var f=h.projectAccessScopes[t];if(f.value==p){h.projectAccessScope=f;break}}var m=v("call_record");for(var t=0;t<h.callAccessScopes.length;t++){var g=h.callAccessScopes[t];if(g.value==m){h.callRecordAccessScope=g;break}}};var v=function(e){for(var t=0;t<h.accessScopes.length;t++){var i=h.accessScopes[t];if(i.type==e){return i.scope;break}}return null};t()});a.get("role/engineer/"+d.engineer.id+".json").success(function(e){h.role=e.json;var t=function(){for(var e=0;e<h.communityAccessScopes.length;e++){var t=h.communityAccessScopes[e];if(h.role.name){if(t.value==h.role.name){h.communityAccessScope=t;break}}else{h.communityAccessScope="";break}}};t()});var e=p({scope:h,title:"我的权限",contentTemplate:"source/views/system_setting/alter_own_permission.html",html:true,show:true,placement:"center"})};h.mouseoverName=function(e){switch(e){case"nickname":h.displayNickname=true;break;case"signature":h.displaySignature=true;break}};h.mouseoutName=function(e){switch(e){case"nickname":h.displayNickname=false;break;case"signature":h.displaySignature=false;break}};h.update=function(e,t){if(e=="nickname"&&!t){r.add("昵称不能为空！","danger");h.engineer.nickname=h.engineersOld.nickname;return}var i=false;var n=h.engineersOld;switch(e){case"nickname":i=n.nickname!=t?true:false;break;case"signature":i=n.user.signature!=t?true:false;break}if(i){a.post("update_engineer.json",{engineer:h.engineer,oldValid:h.engineer.user.valid}).success(function(e){if(e.success){angular.copy(h.engineer,h.engineersOld);v.detail.engineers.put(h.engineer.id,h.engineer);r.add("更新成功！","success")}else{r.add("更新失败！","danger")}})}};h.uploading=false;h.uploadFile=function(e){for(var t=0;t<e.length;t++){var i=e[t];if(i.size>51200){r.add("上传单个附件大小不能超过50kb","danger")}else{i.upload=l.upload({url:"upload",method:"POST",file:i});i.upload.then(function(e){c(function(){h.uploading=false;h.$emit("uploading",false);i.result=e.data;A(e.data);void 0})},function(e){h.uploading=false;h.$emit("uploading",false);h.errorMsg=e.status+": "+e.data})}}};var A=function(t){a.post("update_photo",{id:h.engineer.user.id,photoId:angular.fromJson(t).id}).success(function(e){if(e.success){r.add("头像更新成功!","success");if(h.engineer.user.photo){h.engineer.user.photo.contentUrl=angular.fromJson(t).contentUrl}else{h.engineer.user.photo={};h.engineer.user.photo.contentUrl=angular.fromJson(t).contentUrl}v.detail.engineers.put(h.engineer.id,h.engineer);s.currentUserPhoto=angular.fromJson(t).contentUrl}else{r.add("头像更新失败!","danger")}})};h.passwordModal=function(){_hmt.push(["_trackEvent","你的账号-账号密码","修改密码"]);var e=p({scope:h,title:"修改密码",contentTemplate:"source/views/system_setting/alter_password.html",html:true,show:true,placement:"center"});h.user={};h.updatePassword=function(){if(h.user.password!=h.user.password2){r.add("密码输入不一致!","danger");return}if(h.user.password.length<6){r.add("新密码必须等于或者大于6个字符!","danger");return}a({url:"update_engineer_password.json",method:"POST",data:{passwordOld:h.user.oldpassword,passwordNew:h.user.password2}}).success(function(e){if(e.success){var s="/redirect_to_helpcenter#/login?from_console_logout";a.get("/logout").success(function(e,t,i,n){window.location.href=s})}else{r.add("旧密码输入错误","danger")}})}};h.mobileModal=function(){_hmt.push(["_trackEvent","你的账号-账号密码","更改手机"]);h.user={};h.send_success=false;h.editable=true;h.sendMobileToUser="发送验证码";if(h.engineer.user.mobilePhone&&!h.engineer.user.mobilePhoneExamined){h.user.mobile=angular.copy(h.engineer.user.mobilePhone)}var e=p({scope:h,title:h.modal.btn,contentTemplate:"source/views/system_setting/alter_mobile.html",html:true,show:true,placement:"center"});h.hide=function(){e.$promise.then(e.hide)};h.updateMobile=function(){if(!validMobilePhone(h.user.mobile)){r.add("请输入正确的手机号码!","danger")}else{h.showCaptcha(function(e){var t=u.defer();m.run({url:"/api/v1/send_binding_user_phone",urlParam:{mobilePhone:h.user.mobile,verifyCode:e.verifyCode,verifyCodeNo:e.verifyCodeNo}}).post(null,function(e){if(e.status===0){t.resolve(e)}else{r.add(e.result.error_description,"danger");t.reject(e)}});return t.promise}).then(function(e){h.send_success=true;h.editable=false;var t=60;var i=f(function(){if(t==0){t=60;h.sendMobileToUser="发送验证码";f.cancel(i);h.editable=true}else{h.sendMobileToUser=t+"S重新发送";t--}},1e3)})}};h.updateMobileVerify=function(){var t=angular.copy(h.user.mobile);m.run({url:"/api/v1/engineers/binding_phone",urlParam:{mobilePhone:h.user.mobile,code:h.user.code}}).post(null,function(e){if(e.status===0){h.hide();h.engineer.user.mobilePhone=t;v.detail.engineers.put(h.engineer.id,h.engineer);if(h.modal.mobilePhone){a.get("/logout").success(function(e,t,i,n){window.location.href="/redirect_to_helpcenter#/login?from_console_logout"})}else{h.modal.mobilePhone=t}r.add("绑定成功","success")}else{r.add(e.result.error_description,"danger")}})}};h.emailModal=function(){_hmt.push(["_trackEvent","你的账号-账号密码","更改邮箱"]);h.user={};h.send_success=false;h.editable=true;h.sendEmailToUser="发送验证码";if(h.engineer.user.email&&!h.engineer.user.emailExamined){h.user.email=angular.copy(h.engineer.user.email)}var e=p({scope:h,title:h.modal.email_btn,contentTemplate:"source/views/system_setting/alter_email.html",html:true,show:true,placement:"center"});h.hideemail=function(){e.$promise.then(e.hide)};h.updateEmail=function(){if(!validEmail(h.user.email)){r.add("邮箱格式错误!","danger")}else{h.showCaptcha(function(e){var t=u.defer();a({url:"send_update_user_email_email.json",method:"POST",params:{email:h.user.email,verifyCode:e.verifyCode,verifyCodeNo:e.verifyCodeNo}}).success(function(e){if(e=="errorEmail"){r.add("邮箱格式错误!","danger")}else if(e=="new_email_is_super_user"){r.add("邮箱已经是其他服务商的创始人","danger");t.reject(e)}else if(e=="repeatedEmail"){r.add("邮箱已经存在","danger");t.reject(e)}else if(e=="errorUser"){r.add("请登录后操作","danger");t.reject(e)}else if(e=="verify_code_error"){r.add("验证码错误","danger");t.reject(e)}else if(e=="done"){t.resolve(e)}else{r.add("未知错误","danger");t.reject(e)}}).error(t.reject);return t.promise}).then(function(e){h.send_success=true;h.editable=false;var t=60;var i=f(function(){if(t==0){t=60;h.sendEmailToUser="发送验证码";f.cancel(i);h.editable=true}else{h.sendEmailToUser=t+"S重新发送";t--}},1e3)})}};h.updateEmailVerify=function(){h.emailErrorVerify="";a({url:"update_engineer_email.json",method:"POST",data:{newEmail:h.user.email,verifyCode:h.user.code}}).success(function(e){if(e.id==-1){r.add("验证信息错误或验证码已经失效!","danger")}else if(e.id==0){r.add("邮箱修改失败！","danger")}else if(e.id==1){h.hideemail();h.engineer.user.email=h.user.email;v.detail.engineers.put(h.engineer.id,h.engineer);if(h.modal.email){a.get("/logout").success(function(e,t,i,n){window.location.href="/redirect_to_helpcenter#/login?from_console_logout"})}else{h.modal.email=h.user.email}r.add("绑定成功","success")}else{r.add("未知错误！","danger")}})}};h.openUnbindModel=function(e,t){var i=p({scope:h,title:"提示",contentTemplate:"source/views/system_setting/alter_unbind_third.html",html:true,show:true,placement:"center"});h.makeSureUnbind=function(){a({method:"DELETE",url:"api/v1/user_thirds/"+e+".json",headers:{_token:$.cookie("user_token"),provider_id:h.engineer.provider.id}}).success(function(e){i.$promise.then(i.hide);if(e.status==0){h.engineer.userThirds.splice(t,1);v.detail.engineers.put(h.engineer.id,h.engineer)}else{r.add(e.result&&e.result.error_description?e.result.error_description:"解绑失败","danger")}})}};h.showCaptcha=function(t){var i=u.defer();var n=s.$new();n.rnd=Date.now();n.verifyCodeNo=eweiCommon.uuid(32,16).toLowerCase();var e=p({scope:n,title:"验证码",template:"source/views/system_setting/captcha_modal.html",html:true,show:true,placement:"center"});n.hideCaptchaModal=function(){e.$promise.then(e.hide)};n.onOk=function(e){if(!e){r.add("请输入验证码!","danger");return}t.call(this,{verifyCode:e,verifyCodeNo:n.verifyCodeNo}).then(function(){i.resolve();n.hideCaptchaModal()},i.reject)};n.refreshCaptcha=function(){n.rnd=Date.now()};return i.promise}}function t(){return function(e){if(e=="tencent"){return"showUserQQ_icon"}else if(e=="weixin_mp"){return"showUserWX_icon"}else if(e=="weibo"){return"showUserSina_icon"}else if(e=="qiye_qq"){return"showUserQQ_icon"}else if(e=="dingding"){return"showUserDD_icon"}else if(e=="weixin_mp"){return"showUserWX_icon"}else if(e=="weixin_mp_qiye"){return"showUserWX_icon"}else if(e=="weixin_small_app"){return"showUserWX_icon"}return e}}})();(function(){"use strict";angular.module("eweiApp.system_setting").controller("dynamicsViewDetailController",e);e.$inject=["$scope","$state","$http","$rootScope","ConsoleConfig","coreModelService","coreNotifyService","apiMyActivityService","NgTableParams"];function e(n,e,t,i,s,a,r,o,l){n.eweiHelpcenterApiUrl=s.eweiHelpcenterApiUrl;var c=n.questViewItem=a.config.route.get("system.setting.myactivity.view")||"question_i_subscription";n.datas=[];var u={_page:0,_count:18};var d;var p=vm.__proto__.constructor.name+"_"+Date.now();var f=false;n.communityBuried={question_i_subscription:"关注的",question_mine:"提问的",question_i_answer:"回答的",question_i_comment:"评论的",article_mine:"你的文章"};n.setQuestViewItem=function(e){if(n.communityBuried[e]){_hmt.push(["_trackPageview","/社区管理/子级页面/"+n.communityBuried[e]]);_hmt.push(["_setCustomVar",i.vertionNumber,"名称","我的社区动态"+n.communityBuried[e],1]);_hmt.push(["_trackEvent","社区管理-子级页面",n.communityBuried[e]])}n.questViewItem=e;c=e;d=null;n.tableParams.page(1);n.tableParams.reload()};function m(){n.datas=a.detail.myActivity[n.questViewItem].gets(a.list.myActivity[n.questViewItem].gets(u._page));h()}function g(){o.run(n.questViewItem,r.constant.EVENT_LIST_MYACTIVITY_REFRESH,u._page,u,"",function(){})}function v(){m();if(c!=n.questViewItem||JSON.stringify(u)!=JSON.stringify(d)){g();d=angular.copy(u)}}function h(){if(!f){o.getCount(r.constant.EVENT_LIST_MYACTIVITY_COUNT,function(){});f=true}n.countData={question_i_subscription:a.list.myActivity["question_i_subscription"].total(),question_mine:a.list.myActivity["question_mine"].total(),question_i_answer:a.list.myActivity["question_i_answer"].total(),question_i_comment:a.list.myActivity["question_i_comment"].total(),article_mine:a.list.myActivity["article_mine"].total()}}function y(){k();_()}function _(){n.tableParams=n.tableParams||new l({page:u._page,count:u._count},{counts:[],total:0,getData:function(e,t){u._page=angular.copy(t.page());v();var i=a.list.myActivity[n.questViewItem].total();n.tableParams.total(i);e.resolve(n.datas)}})}function k(){r.register(p,r.constant.EVENT_LIST_MYACTIVITY_REFRESH,function(e){n.tableParams.reload()});r.register(p,r.constant.EVENT_LIST_MYACTIVITY_COUNT,function(e){h()})}function C(){r.unRegister(p)}y();n.$on("$destroy",function(){C();a.config.route.put("system.setting.myactivity.view",c)})}})();(function(){"use strict";angular.module("eweiApp.system_setting").controller("my_account_calendar_controller",e);e.$inject=["$rootScope","$scope","$state","ConsoleConfig","alertService","apiWorkingDayService"];function e(e,i,t,s,a,r){i.currentYear=(new Date).getFullYear();i.currentMonth=(new Date).getMonth();var n=parseInt(i.currentYear+""+(parseInt(i.currentMonth)>=9?i.currentMonth+1:"0"+(i.currentMonth+1)));var o={};var l={};var c={};var u={};i.holidayArray=[];var d=function(t){i.loadingData=true;r.getHoliday({engineerId:s.engineer.id,yearMonth:parseInt(t)},function(e){o[t]=JSON.parse(e.holidays);l[t]=angular.copy(o[t]);c[t]=e.id;i.holidayArray=o[t];i.loadingData=false})};var p=function(){r.getWeekendWorking({engineerId:s.engineer.id},function(e){u=e;i.saturdayAsHoliday=angular.copy(!e.saturdayWorking);i.sundayAsHoliday=angular.copy(!e.sundayWorking)})};d(n);p();i.onDateChange=function(e,t,i){var n=o[e];if(!n){n=o[e]=[]}var s=n.indexOf(t);if(s>-1&&!i){n.splice(s,1)}if(s==-1&&i){n.push(t)}};i.onYearMonthChange=function(e){if(o.hasOwnProperty(e)){i.holidayArray=o[e]}else{i.loadingData=true;d(e)}};i.saveHolidays=function(){angular.forEach(o,function(e,t,i){if(JSON.stringify(l[t])!=JSON.stringify(e)){var n={engineerId:s.engineer.id,holidays:JSON.stringify(e),yearAndMonth:parseInt(t)};if(c.hasOwnProperty(t)){n.id=c[t]}r.saveHolidays({holiday:n},function(e){if(e>0){c[t]=e}l[t]=angular.copy(o[t])})}else{a.add("修改成功","success")}});if(u&&(u.saturdayWorking!=!i.saturdayAsHoliday||u.sundayWorking!=!i.sundayAsHoliday)){u.saturdayWorking=!i.saturdayAsHoliday;u.sundayWorking=!i.sundayAsHoliday;r.saveWeekendWorking({weekendWorking:u},function(e){if(e>0){u.id=e}})}else{a.add(u.id?"修改成功":"保存成功","success")}}}})();(function(){"use strict";angular.module("eweiApp.system_setting").controller("my_account_my_tickets_controller",e);e.$inject=["$rootScope","$scope","$state","coreModelService","coreNotifyService","apiMyTicketsService","NgTableParams","apiTicketStatusColorService"];function e(e,n,t,s,i,a,r,o){var l=n.myTicketViewItem=s.config.route.get("system.setting.my-tickets.view")||"all";n.datas=[];var c={_page:1,_count:20};var u;var d=vm.__proto__.constructor.name+"_"+Date.now();var p=false;n.myTicketBuried={all:"全部",openOrNew:"受理中的",pending:"需回复的",solved:"需评价的",closed:"已关闭的"};n.checkViewItem=function(e){if(n.myTicketBuried[e]){_hmt.push(["_trackPageview","/个人中心/子级页面/"+n.myTicketBuried[e]]);_hmt.push(["_trackEvent","个人中心-子级页面",n.myTicketBuried[e]])}n.myTicketViewItem=e;l=e;u=null;n.tableParams.page(1);n.tableParams.reload()};function f(){var e=s.list.myTickets[n.myTicketViewItem].gets(c._page).join(",");if(e&&e.length>0){o.run(n.myTicketViewItem,i.constant.EVENT_LIST_TICKET_STATUSCOLORS,c._page,"",{ticketIds:e},function(e){if(e){}})}}function m(){var e=s.list.myTickets[n.myTicketViewItem].gets(c._page);var t={};angular.forEach(e,function(e){t[e]=s.detail.statuscolors.get(e)});n.ticketStatusColors=t}function g(){n.datas=s.detail.myTickets[n.myTicketViewItem].gets(s.list.myTickets[n.myTicketViewItem].gets(c._page));y();m()}function v(){var e={};if(n.myTicketViewItem=="all"){e.status=""}else if(n.myTicketViewItem=="openOrNew"){e.status="['open','new']"}else{e.status=n.myTicketViewItem}a.run(n.myTicketViewItem,i.constant.EVENT_LIST_MYTICKETS_REFRESH,c._page,c,e,function(){})}function h(){g();if(l!=n.myTicketViewItem||JSON.stringify(c)!=JSON.stringify(u)){v();u=angular.copy(c)}}function y(){if(!p){a.getCount(i.constant.EVENT_LIST_MYTICKETS_COUNT,function(){});p=true}n.countData={all:s.list.myTickets["all"].total(),openOrNew:s.list.myTickets["openOrNew"].total(),solved:s.list.myTickets["solved"].total(),pending:s.list.myTickets["pending"].total(),closed:s.list.myTickets["closed"].total()}}function _(){C();k()}function k(){n.tableParams=n.tableParams||new r({page:c._page,count:c._count},{counts:[],total:0,getData:function(e,t){c._page=angular.copy(t.page());h();var i=s.list.myTickets[n.myTicketViewItem].total();t.total(i);e.resolve(n.datas)}})}function C(){i.register(d,i.constant.EVENT_LIST_MYTICKETS_REFRESH,function(e){n.tableParams.reload();f()});i.register(d,i.constant.EVENT_LIST_MYTICKETS_COUNT,function(e){y()});i.register(d,i.constant.EVENT_LIST_TICKET_STATUSCOLORS,function(e){m()})}function b(){i.unRegister(d)}_();n.$on("$destroy",function(){b();s.config.route.put("system.setting.my-tickets.view",l)})}})();(function(){"use strict";angular.module("eweiApp.system_setting").controller("my_account_gathering_controller",e);e.$inject=["$scope","$http","alertService","attachmentService"];function e(i,n,s,e){var a=null;i.gathering={};i.imgUpLoad={isUploading:false};org.ewei.sdk.OpenUserSettingApi().findUserQrcode().then({success:function(e){if(!e){return false}a=e.qrcodeId;i.gathering.qrcodeDescription=e.qrcodeDescription;i.gathering.imgUrl="/no_auth_ewei_attachment?contentUrl="+e.contentUrl}});i.uploadSuccess=function(e,t){i.gathering.imgUrl="/no_auth_ewei_attachment?contentUrl="+t.key;i.$apply();n({url:"save_attachment.json",method:"POST",params:{fileName:e.name,contentType:e.type,contentUrl:t.key,size:e.size}}).success(function(e,t,i,n){if(e.json){a=e.json.id}else{s.add("保存附件数据失败！","danger")}})};i.error=function(e){if(e=="F_EXCEED_SIZE"){s.add("上传文件不能大于500K。","danger")}};i.update=function(){if(!a){s.add("请添加收款码","danger");return false}var e=i.gathering.qrcodeDescription;org.ewei.sdk.OpenUserSettingApi().updateQrcode({qrcodeId:a,qrcodeDescription:e}).then({success:function(e){void 0;if(e===true){s.add("更新成功")}}})}}})();(function(){"use strict";angular.module("eweiApp.system_setting").controller("engineers_controller",["$rootScope","$scope","$state","$stateParams","$timeout","ngTableParams","$http","alertService","$upload","$modal_","$filter","permissions","ConsoleConfig","apiRestfulService","$q","coreNotifyService","coreModelService","apiEngineerAllService","apiRoleListService","apiServiceDeskService","apiEngineerService","providerJudgement",function(e,p,s,t,i,n,f,o,a,m,g,r,v,l,c,h,y,u,_,k,C,d){var b=this.__proto__.constructor.name+"_"+Date.now();p.showCheckboxes=true;p.isStop=t.uri;p.isHavePermissionEdit=true;p.serverDataLoad=false;if(!r.hasPermission("engieer_update")&&!r.hasPermission("engieer_delete")){p.isHavePermissionEdit=false}var w=true;var T=true;var S="";p.engineerList=[];p.argument={page:{pageNumber:1,pageSize:999},status:1,engineerQuery:{name:"",email:"",phone:"",roleId:null,defaultServiceDeskId:null,searchKey:"",searchType:null,pageSort:"SORT_TIME",pageOrderType:"DESC"}};p.defaultSortParams={pageSort:"SORT_TIME",pageOrderType:"DESC"};p.defaultSorting=true;if(t.uri=="stop_engineers"){p.argument.status=0;T=true;w=false;S="已停用";p.userStatus=0}else if(t.uri=="wait_engineers"){p.argument.status=2;T=true;w=false;S="尚未完成注册";p.userStatus=2}else{p.argument.status=1;T=false;w=true;S="";p.userStatus=1}p.argumentLast=angular.copy(p.argument);var F=function(e,t){for(var i in e){if(e[i]==t){return i}return""}};p.sortList={"user.name":"SORT_NAME","defaultServiceDesk.name":"SORT_SERVICEDESK","role.name":"SORT_ROLE","user.mobilePhone":"SORT_PHONE","user.email":"SORT_EMAIL","user.lastLoginAt":"SORT_TIME"};p.columns=[{title:"姓名",field:"user.name",fieldCount:2,field0:"user",field1:"name",visible:true,sortable:true,widthClass:"w200"},{title:"首选客服组",field:"defaultServiceDesk.name",fieldCount:2,field0:"defaultServiceDesk",field1:"name",visible:true,sortable:true,widthClass:"w200"},{title:"角色",field:"role.name",fieldCount:2,field0:"role",field1:"name",visible:true,sortable:true,widthClass:"w100"},{title:"手机",field:"user.mobilePhone",fieldCount:2,field0:"user",field1:"mobilePhone",visible:true,sortable:true,widthClass:"w200"},{title:"Email",field:"user.email",fieldCount:2,field0:"user",field1:"email",visible:true,sortable:true,widthClass:"w200"},{title:"最近登录",field:"user.lastLoginAt",fieldCount:2,field0:"user",field1:"lastLoginAt",visible:w,sortable:true,widthClass:"w150"}];p.clearSorting=function(){if(p.defaultSortParams.pageSort){p.argument.engineerQuery.pageSort=p.defaultSortParams.pageSort}if(p.defaultSortParams.pageOrderType){p.argument.engineerQuery.pageOrderType=p.defaultSortParams.pageOrderType}p.defaultSorting=true;p.argumentLast=null;p.tableParams.$params.sorting={};p.tableParams.$params.sorting["user.lastLoginAt"]="asc";p.tableParams.reload()};p.placeholder="搜索姓名/email/手机号码";p.defaultSorting=true;p.clearSearch=function(){if(p.searchKey!=null||p.isAdvancedQuery){if(t.uri=="stop_engineers"){p.argument.status=0}else if(t.uri=="wait_engineers"){p.argument.status=2}else{p.argument.status=1}p.searchKey=null;p.oldSearchKey=null;p.argument.engineerQuery.searchType=null;p.argument.engineerQuery.searchKey=null;p.argument.engineerQuery.name="";p.argument.engineerQuery.email="";p.argument.engineerQuery.phone="";p.argument.engineerQuery.roleId=null;p.argument.engineerQuery.defaultServiceDeskId=null;p.advancedQueryCondition={};p.isAdvancedQuery=false;p.argumentLast=null;if(p.argument.page.pageNumber!=1){p.tableParams.page(1)}else{p.tableParams.reload()}}};p.search=function(e){_hmt.push(["_trackEvent","客服","搜索客服"]);if(p.searchKey==""){p.clearSearch()}else{if(e!=p.oldSearchKey){p.oldSearchKey=e;p.argument.engineerQuery.searchType="EARCHKEYQUERY";p.argument.status=p.userStatus;p.argument.engineerQuery.searchKey=p.searchKey;if(p.argument.page.pageNumber!=1){p.tableParams.page(1)}else{p.tableParams.reload()}}}};p.advancedQuery=function(){p.advancedQueryError="";if(!p.advancedQueryCondition.name&&!p.advancedQueryCondition.email&&!p.advancedQueryCondition.phone&&!p.advancedQueryCondition.roleId&&!p.advancedQueryCondition.defaultServiceDeskId){p.advancedQueryError="查询条件不能为空";return}p.isAdvancedQuery=true;p.argument.engineerQuery.searchType="ADVANCEDQUERY";p.argument.engineerQuery=angular.extend(p.argument.engineerQuery,p.advancedQueryCondition);p.argument.engineerQuery.roleId=p.argument.engineerQuery.roleId?parseInt(p.argument.engineerQuery.roleId):null;p.argument.engineerQuery.defaultServiceDeskId=p.argument.engineerQuery.defaultServiceDeskId?parseInt(p.argument.engineerQuery.defaultServiceDeskId):null;p.argumentLast=null;if(p.argument.page.pageNumber!=1){p.tableParams.page(1)}else{p.tableParams.reload()}$("#engineerAdvancedModal").modal("hide")};p.setRows=function(e){if(!p.tableParams)return;A=true;var t=p.tableParams.count();if(e==t)return;p.argument.page.pageSize=e;p.tableParams.count(e);p.tableParams.page(p.argument.page.pageNumber);p.tableParams.getData(p.tableParams)};p.sorting=function(e){var t=p.tableParams.isSortBy(e.field,"desc");if(t){p.argument.engineerQuery.pageSort=p.sortList[e.field];p.argument.engineerQuery.pageOrderType=""}else{p.argument.engineerQuery.pageSort=p.sortList[e.field];p.argument.engineerQuery.pageOrderType=""}var i=p.tableParams.isSortBy(e.field,"desc")?"asc":"desc";e.sortable?p.tableParams.sorting(e.field,i):"";p.defaultSorting=p.sortList[e.field]==p.defaultSortParams.pageSort&&i.toUpperCase()==p.defaultSortParams.pageOrderType;p.argument.engineerQuery.pageOrderType=i.toUpperCase()};var A=false;function E(){p.tableParams=new n({page:p.argument.page.pageNumber,count:p.argument.page.pageSize,sorting:JSON.parse('{"user.lastLoginAt":"desc"}')},{$scope:p,counts:[],groupBy:function(e){return null},total:0,getData:function(e,t){p.argument.page.pageNumber=angular.copy(t.page());p.argument.page.pageSize=angular.copy(t.count());y.list.engineers[p.listName].page(angular.copy(t.page()));j();userAginLogin(p.engineerList);angular.forEach(p.engineerList,function(e){if(e.isCreator){e.canModify=false}else if(e.role.nameKey=="ROLE_NAME_ADMIN"&&(v.engineer.role.nameKey=="ROLE_NAME_ENGINEER"||!v.engineer.role.nameKey)){e.canModify=false}else{e.canModify=true}});t.total(y.list.engineers[p.listName].total());e.resolve(p.engineerList)}})}p.checkboxes={checked:false,items:{}};p.$watch("checkboxes.checked",function(t){angular.forEach(p.engineerList,function(e){if(angular.isDefined(e.id)&&e.canModify){p.checkboxes.items[e.id]=t}})});p.selectEngineerList=[];p.$watch("checkboxes.items",function(e){if(!p.engineerList||p.engineerList.length==0){return}var t=0,i=0,n=p.engineerList.length;angular.forEach(p.engineerList,function(e){t+=p.checkboxes.items[e.id]||0;i+=!p.checkboxes.items[e.id]||0});if(i==0||t==0){p.checkboxes.checked=t==n}angular.element(document.getElementById("select_all")).prop("indeterminate",t!=0&&i!=0);p.hasSelected=false;var s;var a=0;for(var r in p.checkboxes.items){s=p.selectEngineerList.indexOf(O(r));if(p.checkboxes.items[r]){if(s<0){p.selectEngineerList.push(I(r))}a++}else{if(s>-1){p.selectEngineerList.splice(s,1)}}}if(a>=1){p.hasSelected=true}else{p.hasSelected=false}},true);var O=function(e){for(var t=0;t<p.selectEngineerList.length;t++){var i=p.selectEngineerList[t];if(i.id==e){return i}}return null};var I=function(e){for(var t=0;t<p.engineerList.length;t++){var i=p.engineerList[t];if(i.id==e){return i}}return null};var L=function(){var e=[];for(var t in p.checkboxes.items){var i=I(t);if(p.checkboxes.items[t]){e.push(t)}}return e.join(",")};p.cancelAllSelected=function(){p.checkboxes={checked:false,items:{}}};p.starAndStopEngineers=function(e){var i="";var t={};if(e=="start"){i="true";p.confirmContent="您确定要启用这些客服吗？"}else{i="false";p.confirmContent="您确定要停用这些客服吗？"}var n=m({scope:p,title:"确认",contentTemplate:"source/views/confirm_template.html",html:true,show:true,placement:"center"});p.hideModal=function(){n.$promise.then(n.hide)};p.$ok=function(){var e={enable:i,engieers:p.selectEngineerList};f({url:"batch_enable_engineers.json",method:"POST",data:e}).success(function(e){if(!e.success){o.add(e.message,"danger");return}if(i=="true"){s.go("system_setting.detail",{settingType:"engineers",uri:"run_engineers"});for(var t=0;t<p.menus[0].subMenus.length;t++){p.menus[0].subMenus[t].active=false}p.menus[0].subMenus[0].active=true}else{s.go("system_setting.detail",{settingType:"engineers",uri:"stop_engineers"});for(var t=0;t<p.menus[0].subMenus.length;t++){p.menus[0].subMenus[t].active=false}p.menus[0].subMenus[4].active=true}})}};p.batchModifyEngineers=function(){var e=m({scope:p,title:"批量修改客服",contentTemplate:"source/views/customer/batch_modify_ngineers.html",html:true,show:true,placement:"top"});p.hideModal=function(){e.$promise.then(e.hide)};p.selectedServiceDeskNames=[];var i=function(e){for(var t=0;t<p.serviceDesks.length;t++){if(p.serviceDesks[t].name==e){return p.serviceDesks[t]}}return null};p.nullSelectError={};p.updateServiceDesks=function(){if(p.oldSelectedServiceDeskNames!=p.selectedServiceDeskNames){p.engineer.serviceDesks=[];p.engineer.defaultServiceDesk={};angular.forEach(p.selectedServiceDeskNames,function(e){var t=i(e);if(t!=null){p.engineer.serviceDesks.push(t)}});p.nullSelectError={color:"red"}}};p.checkPreferredServiceDesk=function(e){if(e&&e>0){p.nullSelectError={}}else{p.nullSelectError={color:"red"}}};p.save=function(){var e=L();f({url:"batch_update_engineers.json",method:"POST",data:{engineer:p.engineer,ids:e}}).success(function(e,t,i,n){if(e.success){p.hideModal();p.cancelAllSelected();P()}})};function n(){angular.forEach(p.serviceDesks,function(e){e.name=g("translate")(e.name)})}function s(e,t){p.engineer_defineRoles=e;angular.forEach(t,function(e){e.name=g("translate")(e.name)});if(v.engineer.role.nameKey=="ROLE_NAME_CREATOR"){p.engineer_roles=e}else if(v.engineer.role.nameKey=="ROLE_NAME_ADMIN"){p.engineer_roles=e}else{for(var i=0;i<e.length;i++){if(e[i].nameKey=="ROLE_NAME_ADMIN"){e.splice(i,1)}}p.engineer_roles=e}}var t=0;var a=true;var r;var o=p.checkboxes.items;for(var l in o){if(o[l]){t++;r=l}if(t>=2){a=false;break}}function c(e){if(a){if(e.role&&e.role.id){p.engineer.role.id=e.role.id}if(e.user&&e.user.tags&&e.user.id){p.engineer.user.tags=e.user.tags;p.engineer.user.id=e.user.id}if(e.defaultServiceDesk&&e.defaultServiceDesk.id){p.engineer.defaultServiceDesk.id=e.defaultServiceDesk.id}if(e.serviceDesks){angular.forEach(e.serviceDesks,function(e){e.name=g("translate")(e.name);if(p.selectedServiceDeskNames.indexOf(e.name)<=-1){p.selectedServiceDeskNames.push(e.name)}});p.oldSelectedServiceDeskNames=p.selectedServiceDeskNames}}else{p.engineer.role.id="";p.engineer.user.tags=[];p.engineer.defaultServiceDesk.id="";p.selectedServiceDeskNames=[];p.oldSelectedServiceDeskNames=[]}p.engineer.serviceDesks=e.serviceDesks}function u(){_.run("default",h.constant.EVENT_LIST_ROLES,"","",{_count:999,_do_count:false,_fields:"id,name,nameKey,updatedAt,updater.id,updater.name",_filter:"{'$and':[{'$is_null':['provider.id']},{'$eq':{'type':'engineer'}},{'$eq':{'nameKey':'ROLE_NAME_CREATOR'}}]}",_asc:"createdAt"},function(e){});_.run("define",h.constant.EVENT_LIST_ROLES,"","",{_count:999,_do_count:false,_fields:"id,name,nameKey,updatedAt,updater.id,updater.name",_filter:" {'$and':[{'$eq':{'provider.id':${current_provider_id}}},{'$eq':{'type':'engineer'}}]}",_asc:"createdAt"},function(e){});k.run(h.constant.EVENT_LIST_SERVICEDESK,1,"",{_count:999,_page:1,_do_count:false,_fields:"id,name,engineerCount"},function(e){});C.run(r,h.constant.EVENT_DETAIL_ENGINEERS,"","","",function(e){})}p.loadEnginnerInfoFromModel=function(e){if(e=="all"){var t=y.detail.roles.gets(y.list.roles["define"].getAll());var i=y.detail.roles.gets(y.list.roles["default"].getAll());if(t&&i){s(t,i)}p.serviceDesks=y.detail.servicedesks.gets(y.list.servicedesks.getAll());if(p.serviceDesks){n()}p.engineer=y.detail.engineers.get(r);if(p.engineer){c(p.engineer)}}else if(e=="roles"){var t=y.detail.roles.gets(y.list.roles["define"].getAll());var i=y.detail.roles.gets(y.list.roles["default"].getAll());s(t,i)}else if(e=="servicedesk"){p.serviceDesks=y.detail.servicedesks.gets(y.list.servicedesks.getAll());n()}else{p.engineer=y.detail.engineers.get(r);c(p.engineer)}};function d(){M();p.loadEnginnerInfoFromModel("all");u()}d()};p.deleteEngineers=function(){p.confirmContent="您确定要删除这些客服吗？";var e=m({scope:p,title:"确认",contentTemplate:"source/views/confirm_template.html",html:true,show:true,placement:"center"});p.hideModal=function(){e.$promise.then(e.hide)};p.$ok=function(){f({url:"batch_delete_engineers.json",method:"POST",data:{ids:L()}}).success(function(e,t,i,n){p.hideModal();if(e.success){P();p.cancelAllSelected()}else{o.add("批量删除失败","danger")}})}};p.engineerDetailBuried=function(){};p.addEngineer=function(){if(!d.isTrue()){return false}s.go("system_setting.engineer_detail",{id:-1,uri:"run_engineers"})};p.editList=function(){void 0};p.exportExcel=function(){p.fields=[];f({url:"get_checks.json",method:"POST"}).success(function(e,t,i,n){void 0;p.fields=[];p.fields=e.json});var e=m({scope:p,title:"导出客服",contentTemplate:"source/views/customer/fields_check_list.html",html:true,show:true,placement:"center",backdrop:"static"});p.hideModal=function(){e.$promise.then(e.hide)};p.allChecked=function(){var e=document.getElementsByName("checked");var t=document.getElementById("allChecked");if(t.checked){for(var i=0;i<e.length;i++){e[i].checked=true}}else{for(var i=0;i<e.length;i++){e[i].checked=""}}};p.isAll=function(){var e=document.getElementsByName("checked");var t=document.getElementById("allChecked");var i=0;for(var n=0;n<e.length;n++){if(!isNaN(n)&&e[n].checked){i++}}if(i==e.length){t.checked="checked"}else{t.checked=""}};p.$export=function(){var e=document.getElementsByName("checked");var t=[];for(var i=0;i<e.length;i++){if(!isNaN(i)&&e[i].checked){t.push(e[i].value)}}if(t.length<5){o.add("至少选择5项","danger");return}void 0;p.hideModal();var n="/export_engineer?values="+t;if(p.oldSearchKey!=null&&p.oldSearchKey!=undefined){n+="&searchKey="+p.oldSearchKey}window.open(n)}};p.importComplete=false;p["import"]=function(){if(!d.isTrue()){return false}var e=m({scope:p,title:"客服导入",contentTemplate:"source/views/system_setting/engineer_excel_url.choice.html",html:true,show:true,placement:"center",backdrop:"static"});p.hideImportModal=function(){p.importComplete=false;e.$promise.then(e.hide)};p.$template=function(e){p.hideImportModal();var t="/export_engineer_template";window.open(t)};p.$explain=function(){var e=m({scope:p,title:"客服导入详细说明",contentTemplate:"source/views/customer/engineer_import_explain.html",html:true,show:true,placement:"center",backdrop:"static"})};p.fileIsNUll=false;p.datas=[];p.titles=[];p.options=[];p.titleOptions=[];p.$read=function(e){if(e==null||e==undefined||e.length<=0){return}p.fileIsNUll=true;p.fileName=e[e.length-1].name;e.upload=a.upload({url:"resolve_engineer_excel.json",method:"POST",file:e});e.upload.then(function(e){if(e.data.success){var t=e.data.json;p.titles=t.titles;p.options=t.selectPropertyOptions;var i;var n;for(var s=0,a=t.titles.length;s<a;s++){i=t.titles[s];n={title:i};p.options.some(function(e){if(e.option===i){n.selectProperty=e.value;return true}});p.titleOptions.push(n)}p.datas=t.datas;p.fileIsNUll=true}else{var r=e.data.message;o.add(r+" 请查看详细说明","danger");p.fileIsNUll=false}void 0},function(e){p.uploading=false;p.errorMsg=e.status+": "+e.data});e.upload.progress(function(e){p.uploading=true;void 0});e.upload.xhr(function(e){e.upload.addEventListener("abort",function(){void 0;p.uploading=false},false)})};p.downLoadfailureRecored=function(){p.hideImportModal();var e="/download_import_engineer_failure_record?recordId="+p.recordId;window.open(e)};p.importting=false;p.importEngineer=function(e){var t=document.getElementById("repeatedUpdate");var i=false;if(t.checked===true){i=true}p.importting=true;f({url:"import_engineer.json?update="+i,method:"POST",timeout:18e4,data:e}).success(function(e,t,i,n){p.importting=false;if(e.success){p.failureCount=e.json.failureCount;p.successCount=e.json.successCount;p.recordId=e.json.recordId;p.importData="success";p.tableParams.reload();p.importComplete=true}else if(e.data&&e.data.message){o.add(e.data.message,"danger")}else{o.add("请检查文件类型，格式！","danger")}p.uploading=false}).error(function(e,t,i,n){o.add("导入失败,请稍候再试！","danger");p.importting=false})};p.$save=function(){var e=p.titleOptions;var t=new Array;var i=new Array;for(var n=0;n<e.length;n++){var s=e[n].selectProperty;if(s==undefined||s==null||s==""){void 0;return}if(t.indexOf(s)>-1){void 0;return}t.push(s);i.push(s)}var a={};a.titles=p.titles;a.fileds=i;a.selectPropertys=t;a.datas=p.datas;p.importEngineer(a)}};p.listName=D();function D(){if(p.userStatus==0){return"stop"}else if(p.userStatus==1){return"run"}else{return"wait"}}function P(){u.run(p.listName,h.constant.EVENT_LIST_ENGINEER_ALL,p.argument.page.pageNumber,p.argument,function(e){})}function x(){p.engineerList=y.detail.engineers.gets(y.list.engineers[p.listName].gets(p.argument.page.pageNumber))}function N(){h.register(b,h.constant.EVENT_LIST_ENGINEER_ALL,function(e){p.tableParams.reload();p.serverDataLoad=true})}function M(){var i=0;h.register(b,h.constant.EVENT_LIST_ROLES,function(e,t){if(t=="define"||t=="default"){i++}if(i==2){p.loadEnginnerInfoFromModel("roles")}});h.register(b,h.constant.EVENT_LIST_SERVICEDESK,function(e){p.loadEnginnerInfoFromModel("servicedesk")});h.register(b,h.constant.EVENT_DETAIL_ENGINEERS,function(e,t){p.loadEnginnerInfoFromModel("engineer")})}function j(){x();if(!A)return;if(JSON.stringify(p.argument)!=JSON.stringify(p.argumentLast)){P();p.argumentLast=angular.copy(p.argument)}}function R(){N();E()}R();function U(){h.unRegister(b)}p.$on("$destroy",function(){U()})}])})();(function(){"use strict";angular.module("eweiApp.system_setting").controller("engineer_edit_controller",e);e.$inject=["$rootScope","$scope","$state","$stateParams","$http","serviceDesks","alertService","roleService","$filter","license","$interval","$modal_","viewCustomerViews","permissions","providerJudgement","ConsoleConfig","coreNotifyService","coreModelService","apiRoleListService","apiEngineerService","apiServiceDeskService"];function e(e,s,a,n,r,t,o,i,l,c,u,d,p,f,m,g,v,h,y,_,k){s.init_engineer_serviceDesks=[];s.init_serviceDeskNames=[];s.state=n.uri;s.sendEmailSuccess=false;s.isHavePermissionEdit=false;s.isedit=false;var C=[];var b=[];var w=this.__proto__.constructor.name+"_"+Date.now();s.hasJurisdiction=true;s.backEngineerBuried=function(){_hmt.push(["_trackEvent","客服-添加客服","取消"])};s.deleteEngineer=function(){if(!f.hasPermission("engieer_delete")){o.add("您没有删除客服的权限","danger");return false}s.confirmContent="您确定要删除该客服吗？";var e=d({scope:s,title:"确认",contentTemplate:"source/views/confirm_template.html",html:true,show:true,placement:"center"});s.hideModal=function(){e.$promise.then(e.hide)};s.$ok=function(){r({url:"batch_delete_engineers.json",method:"POST",data:{ids:s.engineer.id}}).success(function(e,t,i,n){if(e.success){a.go("system_setting.detail",{uri:a.params.uri,settingType:"engineers"})}else{o.add("删除失败","danger")}})}};s.menus=p;s.starAndStopEngineer=function(e){var i="";if(e=="start"){if(!f.hasPermission("engieer_update")){o.add("您没有编辑客服的权限","danger");return false}i=true;s.confirmContent="您确定要启用该客服吗？"}else{i=false;s.confirmContent="您确定要停用该客服吗？"}var t=d({scope:s,title:"确认",contentTemplate:"source/views/confirm_template.html",html:true,show:true,placement:"center"});s.hideModal=function(){t.$promise.then(t.hide)};s.$ok=function(){var e=[];e.push(s.engineer);var t={enable:i,engieers:e};r({url:"batch_enable_engineers.json",method:"POST",data:t}).success(function(e){void 0;if(!e.success){o.add(e.message,"danger");return}if(i){a.go("system_setting.detail",{settingType:"engineers",uri:"run_engineers"});for(var t=0;t<s.menus[0].subMenus.length;t++){s.menus[0].subMenus[t].active=false}s.menus[0].subMenus[0].active=true}else{a.go("system_setting.detail",{settingType:"engineers",uri:"stop_engineers"});for(var t=0;t<s.menus[0].subMenus.length;t++){s.menus[0].subMenus[t].active=false}s.menus[0].subMenus[4].active=true}})}};var T=function(){var e=/^1\d{10}$/;if(s.engineer.user.email&&!verifyEmailAddress(s.engineer.user.email)){o.add("邮箱格式错误","danger");return false}if(s.engineer.serviceDesks==null||s.engineer.serviceDesks.length==0){o.add("请选择所属客服组","danger");return false}else if(s.engineer.user.mobilePhone&&!e.test(s.engineer.user.mobilePhone)){return true}else if(s.engineer.defaultServiceDesk.id==null){o.add("请选择首选客服组","danger");return false}else if(!s.engineer.nickname){o.add("客服昵称不能为空","danger");return false}else if(s.engineer.nickname!=undefined&&s.engineer.nickname.indexOf("\\")>-1){o.add("客服昵称中不能包含'\\'","danger");return false}else if(s.engineer.user.name!=undefined&&s.engineer.user.name.indexOf("\\")>-1){o.add("姓名中不能包含'\\'","danger");return false}else{return true}};s.validss=[{name:"可用",value:true},{name:"禁用",value:false}];var S=function(e){for(var t=0;t<s.serviceDesks.length;t++){if(s.serviceDesks[t].name==e){return s.serviceDesks[t]}}return null};s.nullSelectError={};s.checkPreferredServiceDesk=function(e){if(e&&e>0){s.nullSelectError={}}else{s.nullSelectError={color:"red"}}};s.$watch("engineer.role.id",function(e){if(s.admin_roleId==e){if(s.engineer.user&&s.engineer.user.role){s.engineer.user.role.id=s.customer_edit_roleId;s.customer_role_editable=false}}else{s.customer_role_editable=true}});function F(){if(n.id>0){s.isedit=true;if(f.hasPermission("engieer_update")){s.isHavePermissionEdit=true}else{s.isHavePermissionEdit=false}}else{s.engineer_type="run";s.engineer_status="客服";if(g.engineer.role.nameKey=="ROLE_NAME_CREATOR"){s.engineer_roles=C}else if(g.engineer.role.nameKey=="ROLE_NAME_ADMIN"){s.engineer_roles=C}else{for(var e=0;e<C.length;e++){if(C[e].nameKey=="ROLE_NAME_ADMIN"){C.splice(e,1)}}s.engineer_roles=C}if(f.hasPermission("engieer_create")){s.isHavePermissionEdit=true}else{s.isHavePermissionEdit=false}s.engineer={};s.engineer.user={};s.engineer.ISemailExamined=true;angular.forEach(C,function(e){if(e.name==="客服"){s.init_engineer_roleId=e.id}});s.engineer.user.status=2;s.engineer.user.valid=false;s.submit_button="添加";s.email_visble=false;s.engineer.serviceDesks=s.init_engineer_serviceDesks;s.$watch("init_default_serviceDesk_id",function(e){s.engineer.defaultServiceDesk={};s.engineer.defaultServiceDesk.id=e});var t=/^1[34578][0-9]{9}$/;if(s.submit_button=="添加"){s.emailHasRegisted=false;s.save=function(){s.engineer.user.nickname=s.engineer.nickname;if(!m.isTrue()){return false}else{var e=s.engineer.user.mobilePhone;if(e!=""&&e!=null&&e!=undefined&&!t.test(e)){o.add("请输入正确的手机号码！","danger");return}if(T()){s.processing=true;r({url:"save_engineer.json",method:"POST",data:s.engineer}).success(function(e){s.processing=false;if(e.success){if(e.json.emailError!=undefined){o.add(e.json.emailError,"danger");s.emailHasRegisted=true}else if(e.json.statusError!=undefined){o.add(e.json.statusError,"danger")}else if(e.json.phoneError!=undefined){o.add(e.json.phoneError,"danger")}else if(e.json.id>0){o.add("已发送注册链接到该客服的邮箱","success");s.engineer={user:{valid:false,status:2,role:{id:s.init_customer_roleId}},role:{id:s.init_engineer_roleId},serviceDesks:s.init_engineer_serviceDesks,defaultServiceDesk:{id:s.init_default_serviceDesk_id}};s.engineer.ISemailExamined=true}}else{o.add("添加失败！","danger")}}).error(function(){s.processing=false})}}}}}}function A(){angular.forEach(s.serviceDesks,function(e){e.name=l("translate")(e.name);if(e.name=="默认服务台"&&n.id<0){if(s.init_engineer_serviceDesks.indexOf(e)<0){s.init_engineer_serviceDesks.push(e);s.init_default_serviceDesk_id=e.id;s.init_serviceDeskNames.push("默认服务台")}}})}function E(){if(s.engineer){userAginLogin(s.engineer);if(s.engineer.user.mobilePhoneExamined&&s.engineer.user.mobilePhone){s.engineer.ISmobilePhoneExamined=true;s.engineer.ISemailExamined=false}else if(s.engineer.user.emailExamined){s.engineer.ISemailExamined=true;s.engineer.ISmobilePhoneExamined=false}else{s.engineer.ISmobilePhoneExamined=false;s.engineer.ISemailExamined=false}if(s.engineer.user.status==1){s.engineer_type="run";s.engineer_status="客服/工程师"}else if(s.engineer.user.status==2){s.engineer_type="wait";s.engineer_status="待激活的客服账号"}else{s.engineer_type="stop";s.engineer_status="已停用的客服账号"}angular.forEach(b,function(e){e.name=l("translate")(e.name);if(e.name=="客服"){s.init_engineer_roleId=e.id}if(e.name=="管理员"){s.admin_roleId=e.id}});if(g.engineer.role.nameKey=="ROLE_NAME_CREATOR"){if(s.engineer.isCreator){s.engineer_roles=b.concat(C)}else{s.engineer_roles=C}}else if(g.engineer.role.nameKey=="ROLE_NAME_ADMIN"){if(s.engineer.isCreator){s.engineer_roles=b.concat(C)}else{s.engineer_roles=C}}else{if(s.engineer.isCreator){s.engineer_roles=b.concat(C)}else{if(s.engineer.role&&s.engineer.role.nameKey=="ROLE_NAME_ADMIN"){s.hasJurisdiction=false}else{s.hasJurisdiction=true;for(var e=0;e<C.length;e++){if(C[e].nameKey=="ROLE_NAME_ADMIN"){C.splice(e,1)}}}s.engineer_roles=C}}s.engineerUserName=angular.copy(s.engineer.user.name);s.oldValid=s.engineer.user.valid;s.init_engineer_roleId=s.engineer.role.id;s.submit_button="更新";s.email_visble=true;var t;var i=true;var n=10;if(s.submit_button=="更新"){s.sendEmailAgain=function(){var e=d({scope:s,title:"重发注册邮件",contentTemplate:"source/views/customer/send_email_again.html",html:true,show:true,placement:"center"});s.emailBtn=function(){if(i){i=false;u.cancel(t);r({url:"send_reset_password_email.json?email="+s.engineer.user.email,method:"POST",data:{email:s.engineer.user.email}}).success(function(e){if(e=="mail_sent"){s.hideModal();o.add("邮件发送成功！","success");s.sendEmailSuccess=true;t=u(function(){if(n<=10){n-=1}if(n<=0){n=10;u.cancel(t);i=true}},1e3)}else if(e=="user_not_found"||e=="email_is_null"){o.add("当前客服账号不存在或者已激活","danger");n=0;i=true}}).error(function(){o.add("邮件发送失败！","danger")})}else{if(n>0){o.add("邮件已发送,剩余"+n+"秒后可再次发送！","danger")}}};s.hideModal=function(){e.$promise.then(e.hide)}};s.backEngineerBuried=function(){_hmt.push(["_trackEvent","客服组","编辑客服组信息-取消"])};s.save=function(){_hmt.push(["_trackEvent","客服组","编辑客服组信息-确认"]);if(T()){if(s.oldValid!=s.engineer.user.valid){s.engineer.user.status=s.engineer.user.valid?1:0}r({url:"update_engineer.json?type=engineer",method:"POST",data:{engineer:s.engineer,oldValid:s.oldValid}}).success(function(e){if(e.success){s.oldValid=s.engineer.user.valid;o.add("更新成功！","success");s.engineerUserName=angular.copy(s.engineer.user.name)}else{if(e.message!=undefined){o.add(l("translate")(e.message),"danger")}else{o.add("更新失败！","danger")}}})}}}}}function $(){if(n.id>0){_.run(n.id,v.constant.EVENT_DETAIL_ENGINEERS,"","","",function(e){})}y.run("default",v.constant.EVENT_LIST_ROLES,"","",{_count:999,_do_count:false,_fields:"id,name,nameKey,updatedAt,updater.id,updater.name",_filter:"{'$and':[{'$is_null':['provider.id']},{'$eq':{'type':'engineer'}},{'$eq':{'nameKey':'ROLE_NAME_CREATOR'}}]}",_asc:"createdAt"},function(e){});y.run("define",v.constant.EVENT_LIST_ROLES,"","",{_count:999,_do_count:false,_fields:"id,name,nameKey,updatedAt,updater.id,updater.name",_filter:" {'$and':[{'$eq':{'provider.id':${current_provider_id}}},{'$eq':{'type':'engineer'}}]}",_asc:"createdAt"},function(e){});k.run(v.constant.EVENT_LIST_SERVICEDESK,1,"",{_count:999,_page:1,_do_count:false,_fields:"id,name,engineerCount"},function(e){})}var O=0;function I(){if(n.id<=0&&O==2){F()}if(O==3){E();F()}}function L(e){if(e=="all"){C=h.detail.roles.gets(h.list.roles["define"].getAll());b=h.detail.roles.gets(h.list.roles["default"].getAll());s.serviceDesks=h.detail.servicedesks.gets(h.list.servicedesks.getAll());if(C.length==0||b.length==0||!s.serviceDesks){return}if(n.id>0){s.engineer=h.detail.engineers.get(n.id);E()}A();F()}else if(e=="roles"){C=h.detail.roles.gets(h.list.roles["define"].getAll());b=h.detail.roles.gets(h.list.roles["default"].getAll());O++;I()}else if(e=="servicedesk"){s.serviceDesks=h.detail.servicedesks.gets(h.list.servicedesks.getAll());A();O++;I()}else{s.engineer=h.detail.engineers.get(n.id);O++;I()}}function D(){if(n.id>0){v.register(w,v.constant.EVENT_DETAIL_ENGINEERS,function(e,t){if(t.id==n.id){L("engineer")}})}var i=0;v.register(w,v.constant.EVENT_LIST_ROLES,function(e,t){if(t=="define"||t=="default"){i++}if(i==2){L("roles")}});v.register(w,v.constant.EVENT_LIST_SERVICEDESK,function(e){L("servicedesk")})}function P(){L("all");$()}function x(){D();P()}x();function N(){v.unRegister(w)}s.$on("$destroy",function(){N()})}})();(function(){"use strict";angular.module("eweiApp.system_setting").controller("engineer_detail_controller",e);e.$inject=["$rootScope","$scope","$state","$http","$upload","$timeout","$stateParams","$location","alertService","engineerService","permissions","coreModelService","coreNotifyService","apiEngineerService"];function e(e,t,i,n,s,a,r,o,l,c,u,d,p,f){var m;var g=d.config.route.get("system-setting.engineer_detail");if(g){m=g}else{m={name:"system_setting.engineer_detail.engineer_edit"}}if(!u.hasPermission("engieer_update")||r.id==-1){t.hideSla=true;i.go("system_setting.engineer_detail.engineer_edit",{id:r.id})}else{i.go(m.name,{id:r.id})}t.engineer=d.detail.engineers.get(r.id);if(!t.engineer&&r.id!=-1){f.run(r.id,p.constant.EVENT_DETAIL_ENGINEERS,"","","",function(e){if(e.status==0){t.engineer=e.result;v()}})}else{v()}function v(){if(t.engineer&&t.engineer.user){if(t.engineer.user.status==1){t.engineer_type="run";t.engineer_status="客服/工程师"}else if(t.engineer.user.status==2){t.engineer_type="wait";t.engineer_status="待激活的客服账号"}else{t.engineer_type="stop";t.engineer_status="已停用的客服账号"}}else{t.engineer_type="run";t.engineer_status="客服/工程师"}}var h=this.__proto__.constructor.name+"_"+Date.now();function y(){p.register(h,p.constant.EVENT_DETAIL_ENGINEERS,function(e){t.engineer=d.detail.engineers.get(r.id);v()})}function _(){p.unRegister(h)}y();t.$on("$destroy",function(){_()})}})();(function(){"use strict";angular.module("eweiApp.system_setting").controller("engineer_flextime_controller",e);e.$inject=["$rootScope","$scope","$state","alertService","$stateParams","apiWorkingDayService"];function e(e,t,i,n,s,a){a.getWorkingDay({engineerId:parseInt(s.id)},function(e){t.workingTime=e;t.weekTimes=JSON.parse(e.detailsJson);t.oldWorkingTime=t.workingTime.id?angular.copy(t.workingTime):{}});t.saveWorkingTime=function(){if(t.vm.getHours()){if(t.oldWorkingTime.status!=t.workingTime.status||t.oldWorkingTime.detailsJson!=JSON.stringify(t.vm.getHours())){t.workingTime.detailsJson=JSON.stringify(t.vm.getHours());t.workingTime.engineerId=parseInt(s.id);a.saveWorkingTime({workTime:t.workingTime},function(e){if(e>0){t.workingTime.id=e;t.oldWorkingTime.id=e}t.oldWorkingTime.detailsJson=angular.copy(JSON.stringify(t.vm.getHours()));t.oldWorkingTime.status=t.workingTime.status})}else{n.add("数据未改变","danger")}}}}})();+function(){"use strict";angular.module("eweiApp.system_setting").config(e).factory("getHelpCenterIdService",t);e.$inject=["$stateProvider","$urlRouterProvider"];function e(e,t){e.state("system_setting.detail.client",{url:"/client",controller:"helpCenterClientController",templateUrl:"source/system-setting/help-center/templates/client.html",onEnter:i("system_setting_help_center")}).state("system_setting.detail.addTicketSetting",{url:"/addTicketSetting",controller:"helpCenterAddTicketSettingController",templateUrl:"source/system-setting/help-center/templates/add-ticket-setting.html",onEnter:i("system_setting_help_center")}).state("system_setting.detail.interfaceAppearance",{url:"/interfaceAppearance",controller:"helpCenterInterfaceAppearanceController",templateUrl:"source/system-setting/help-center/templates/interface-appearance.html",onEnter:i("system_setting_help_center")}).state("system_setting.detail.autoAeply",{url:"/autoAeply",controller:"helpCenterAutoAeplyController",templateUrl:"source/system-setting/help-center/templates/auto-reply.html",onEnter:i("system_setting_help_center")}).state("system_setting.detail.serviceRequestManage",{url:"/serviceRequestManage",controller:"helpCenterServiceRequestManageController",templateUrl:"source/system-setting/help-center/templates/service-request-manage.html",onEnter:i("system_setting_help_center")}).state("system_setting.detail.onlineCustomerNavigation",{url:"/onlineCustomerNavigation",controller:"helpCenterOnlineCustomerNavigationController",templateUrl:"source/system-setting/help-center/templates/online-customer-navigation.html",onEnter:i("system_setting_help_center")})}function i(n){e.$inject=["$state","$stateParams","coreModelService"];function e(e,t,i){i.config.route.put(n,{name:this.name,params:t,permission:this.permission||""})}return e}t.$inject=["$http","$q"];function t(e,t){return{getDesktopHelpId:function(){var s=t.defer();e.get("ticket_helpcenterchat_form.json").success(function(e,t,i,n){userAginLogin(e);if(e.success&&e.json){s.resolve(e.json)}}).error(function(e,t,i,n){s.reject(e)});return s.promise}}}}();(function(){"use strict";angular.module("eweiApp.system_setting").controller("helpCenterClientController",e);e.$inject=["$rootScope","$scope","ConsoleConfig"];function e(e,t,i){t.helpCenter={};t.helpCenter.protocolHref=window.location.host;org.ewei.sdk.OpenHelpCenterApi().getSmallAppQrCode({}).then({success:function(e){void 0;t.helpCenter.imgTwoSrc="/no_auth_ewei_attachment?contentUrl="+e.contentUrl}});t.desktopHelpDownload=function(){var e="";if(i.enviroment=="Production"){e="http://ewei-app-saas.ewei.com/Helpdesk.exe"}else if(i.enviroment=="Test"){e="http://apptest.cdn.ewei.com/Helpdesk.exe"}else{e="http://apptest.cdn.ewei.com/Helpdesk.exe"}window.open(e)}}})();(function(){"use strict";angular.module("eweiApp.system_setting").controller("helpCenterAddTicketSettingController",e);e.$inject=["$rootScope","$scope","alertService","$http","$q","coreNotifyService","$filter"];function e(e,d,i,t,n,s,p){d.ticketCustomFields=[{name:"验证码",showName:"验证码",tip:"请输入验证码",fieldName:"verifyCode",required:true,inputType:"text"}];d.userCustomFields=[{name:"Email",showName:"Email",tip:"请输入Email",fieldName:"email",required:false,inputType:"text"},{name:"手机号码",showName:"手机号码",tip:"请输入手机号码",fieldName:"mobilePhone",required:false,inputType:"text"},{name:"电话",showName:"电话",tip:"请输入电话号码",fieldName:"phone",required:false,inputType:"text"},{name:"名字",showName:"你的姓名",tip:"请输入你的姓名",fieldName:"name",required:false,inputType:"text"},{name:"联系邮箱",showName:"联系邮箱",tip:"请输入你的联系邮箱",fieldName:"contactEmail",required:false,inputType:"text"},{name:"联系手机",showName:"联系手机",tip:"请输入你的联系手机",fieldName:"contactMobilePhone",required:false,inputType:"text"}];d.ticketCustomFieldShowDemo=[];d.ticketSendRule={};d.ticketSendRule.serviceDesks=[];d.userInfArr=[];var f=[];var m=[],g=[],v=[];var h=null;var a=t({method:"GET",url:"custom_field.json?scope=user&active=true"});var r=t({method:"GET",url:"custom_field.json?scope=ticket&active=true"});var o=t({method:"GET",url:"getTicketSubmit.json"});var l=function(){n.all([a,r,o]).then(function(e){if(e[0].status===200&&e[0].data&&e[0].data.success&&e[0].data.json&&e[0].data.json.length>0){var t=e[0].data.json;for(var i=0;i<t.length;i++){var n={};n={name:t[i].title,showName:t[i].title,tip:t[i].notes,fieldName:"user_customField_"+t[i].id,required:t[i].required,showNameDisable:false};if(t[i].type=="checkbox"||t[i].type=="textarea"||t[i].type=="date"||t[i].type=="multi_options"||t[i].type=="cascade_options"||t[i].type=="date_to_date"||t[i].type=="date_time"){n.inputType=t[i].type}else if(t[i].type=="options"){n.inputType="select"}else{n.inputType="text"}m.push(n)}d.userCustomFields=d.userCustomFields.concat(m);f=f.concat(d.userCustomFields)}else{f=f.concat(d.userCustomFields)}if(e[1].status===200&&e[1].data&&e[1].data.success&&e[1].data.json&&e[1].data.json.length>0){var s=e[1].data.json;for(var i=0;i<s.length;i++){var a={};a={name:s[i].title,showName:s[i].title,tip:s[i].notes,required:s[i].required,showNameDisable:false};if(s[i].systemFieldKey=="priority"){a.fieldName="priority"}else if(s[i].systemFieldKey=="ticket_type"){a.fieldName="ticketType"}else if(s[i].systemFieldKey=="service_catalog"){a.fieldName="serviceCatalog"}else if(s[i].systemFieldKey=="subject"){a.fieldName="subject"}else if(s[i].systemFieldKey=="ticket_description"){a.fieldName="description"}else{a.fieldName="ticket_customField_"+s[i].id}if(s[i].type=="checkbox"||s[i].type=="textarea"||s[i].type=="date"||s[i].type=="multi_options"||s[i].type=="cascade_options"||s[i].type=="date_to_date"||s[i].type=="date_time"){a.inputType=s[i].type}else if(s[i].type=="options"){a.inputType="select"}else{a.inputType="text"}if(s[i].systemFieldKey!="tags"){g.push(a)}}d.ticketCustomFields=d.ticketCustomFields.concat(g);f=f.concat(d.ticketCustomFields)}else{f=f.concat(d.ticketCustomFields)}if(e[2].status===200&&e[2].data&&e[2].data.success&&e[2].data.json){if(e[2].data.json.ticketSubmitFields&&e[2].data.json.ticketSubmitFields.length>0){v=angular.copy(e[2].data.json.ticketSubmitFields);var r=angular.copy(f);for(var i=0;i<v.length;i++){var o=true;v[i].active=false;if(v[i].fieldName=="email"||v[i].fieldName=="mobilePhone"){d.userInfArr.push(v[i])}for(var l=0;l<r.length;l++){if(v[i].fieldName==r[l].fieldName){o=false;break}}if(o){v.splice(i,1);i--}}d.ticketCustomFieldShowDemo=angular.copy(v)}if(e[2].data.json.ticketSubmit){h=angular.copy(e[2].data.json.ticketSubmit);d.ticketSendRule=angular.copy(e[2].data.json.ticketSubmit);d.subject={subjectInf:h.subject||"",active:false}}if(e[2].data.json.serviceDesks&&e[2].data.json.serviceDesks.length>0){var c=e[2].data.json.serviceDesks;for(var i=0;i<c.length;i++){if(c[i].name=="DEFAULT_SERVICE_DESK_NAME"){c[i].name=p("translate")(c[i].name)}if(h.serviceDesk&&c[i].id==h.serviceDesk.id){d.ticketSendRule.serviceDesk=c[i]}}d.serviceDesks=c}}for(var i=0;i<v.length;i++){for(var l=0;l<d.ticketCustomFields.length;l++){if(v[i].fieldName==d.ticketCustomFields[l].fieldName){d.ticketCustomFields[l].activeShow=true;break}}for(var u=0;u<d.userCustomFields.length;u++){if(v[i].fieldName==d.userCustomFields[u].fieldName){d.userCustomFields[u].activeShow=true;break}}}})};l();d.checkedMenu=function(e){var t=false,i=null,n=null,s=null;for(var a=0;a<d.ticketCustomFieldShowDemo.length;a++){if(e.fieldName==d.ticketCustomFieldShowDemo[a].fieldName){t=true;i=a}if(d.ticketCustomFieldShowDemo[a].fieldName=="subject"){n=true}if(d.ticketCustomFieldShowDemo[a].fieldName=="description"){s=true}}if(t){if(e.fieldName=="subject"||e.fieldName=="description"){if(n&&s){}else{return false}}d.ticketCustomFieldShowDemo.splice(i,1)}else{d.ticketCustomFieldShowDemo.push(e)}e.activeShow=!e.activeShow;if(e.fieldName=="email"||e.fieldName=="mobilePhone"){if(e.activeShow){if(d.userInfArr.length<2){d.userInfArr.push(e)}}else{d.userInfArr.pop()}}};d.editMenu=function(e){e.active=true};d.editMenuOver=function(e){e.active=false};d.updateTicketSubmitFields=function(){_hmt.push(["_trackEvent","社区设置-提交工单","更新表单字段"]);h.subject=d.subject.subjectInf;var e=angular.copy(d.ticketCustomFieldShowDemo);for(var t=0;t<e.length;t++){delete e[t].active;delete e[t].activeShow;if(d.userInfArr.length==2&&(e[t].fieldName=="email"||e[t].fieldName=="mobilePhone")){e[t].required=false}e[t].orderKey=t}h.ticketSubmitFields=e;h.serviceDesk=d.ticketSendRule.serviceDesk;void 0;org.ewei.sdk.OpenHelpCenterSettingApi().updateHelpCenterTicketSubmit({ticketSubmit:h}).then({success:function(e){if(e){i.add("更新成功！")}else{i.add("修改失败！","danger")}}})}}})();(function(){"use strict";angular.module("eweiApp.system_setting").controller("helpCenterInterfaceAppearanceController",e).directive("logoUploading",t);e.$inject=["$scope","$rootScope","$stateParams","$state","$http","$q","$timeout","alertService","ConsoleConfig","getHelpCenterIdService","license"];t.$inject=[];function e(o,e,t,i,n,s,a,r,l,c,u){o.license=u.type();o.licenseService=u;o.webFormOutward={};o.objAd={url:""};o.imgUpLoad={isUploading:false};o.picHostName="http://ewei-web-saas.ewei.com/";if(l.enviroment=="Test"){o.picHostName="http://ewei-web-upload-test.ewei.com/"}else if(l.enviroment=="dev"){o.picHostName="http://webdev.cdn.itkeeping.com/"}o.fileQueued=function(e){void 0};o.uploadProgress=function(e,t){o.$apply(o.imgUpLoad.isUploading=true)};o.uploadSuccess=function(e,t){o.$apply(o.imgUpLoad.isUploading=false);var i={fileName:e.name,contentType:e.type,contentUrl:t.key,size:e.size};n({method:"POST",url:"attachment.json",data:i}).success(function(e){if(e.success&&e.json){if(o.webFormStype&&o.webFormStype.customWebFormAdvertisements){i.id=e.json.id;o.webFormStype.customWebFormAdvertisements.push({image:i,url:o.objAd&&o.objAd.url?o.objAd.url:""});o.slides.push({image:"/no_auth_ewei_attachment?contentUrl="+i.contentUrl});o.objAd={url:""}}}})};o.error=function(e){o.$apply(o.imgUpLoad.isUploading=false)};o.deleteCustomWebFormAd=function(e){if(o.webFormStype&&o.webFormStype.customWebFormAdvertisements){o.webFormStype.customWebFormAdvertisements.splice(o.webFormStype.customWebFormAdvertisements.indexOf(e),1);o.slides=o.webFormStype.customWebFormAdvertisements.map(function(e){return{image:"/no_auth_ewei_attachment?contentUrl="+e.image.contentUrl}});o.reloadCarousel=true;a(function(){o.reloadCarousel=false},300)}};var d=[{name:"Email",showName:"Email",tip:"请输入Email",fieldName:"email",required:false,inputType:"text"},{name:"手机号码",showName:"手机号码",tip:"请输入手机号码",fieldName:"mobilePhone",required:false,inputType:"text"},{name:"电话",showName:"电话",tip:"请输入电话号码",fieldName:"phone",required:false,inputType:"text"},{name:"名字",showName:"你的姓名",tip:"请输入你的姓名",fieldName:"name",required:false,inputType:"text"},{name:"联系邮箱",showName:"联系邮箱",tip:"请输入你的联系邮箱",fieldName:"contactEmail",required:false,inputType:"text"},{name:"联系手机",showName:"联系手机",tip:"请输入你的联系手机",fieldName:"contactMobilePhone",required:false,inputType:"text"}];var p=e.provider?e.provider.headBackgroundColor?e.provider.headBackgroundColor:"#1e8cce":"#1e8cce";var f={buttonBackgroundColor:p,buttonFontColor:"#FFFFFF",buttonHavePriority:"true",buttonTitle:"在线交谈",flagBackgroundColor:"#CC00FF",flagFontColor:"#FFFFFF",flagPicture:l.requestContextPath+"/source/images/form/paopao.png",flagTitle:"我在哦！随时等你来聊",loginable:true,openCountMessage:true,position:"right",searchable:true,style:"badge",windowHeight:335,windowTitle:"在线交谈",windowTitleColor:p,windowWidth:250,windowfontColor:"#FFFFFF",salutatory:"你好！欢迎体验远程协助服务。为保证服务质量，会话内容将被记录。投诉电话:company_phone",concierge:l.provider.name,signature:"没有解决不了的问题",conciergePicture:l.requestContextPath+"/source/images/logo_helpdesk.png",conciergePictureSrc:l.requestContextPath+"/source/images/logo_helpdesk.png",flagPictureSrc:l.requestContextPath+"/source/images/form/paopao.png"};var m=[];o.userInfArr=[];o.myInterval=5e3;o.slides=[];n({method:"GET",url:"custom_field.json?scope=user&active=true"}).success(function(e){if(e.success&&e.json){var t=e.json;for(var i=0;i<t.length;i++){var n={};n={name:t[i].title,showName:t[i].title,tip:t[i].notes,fieldName:"user_customField_"+t[i].id,required:t[i].required,showNameDisable:false};if(t[i].type=="checkbox"||t[i].type=="textarea"||t[i].type=="date"||t[i].type=="multi_options"||t[i].type=="cascade_options"||t[i].type=="date_to_date"||t[i].type=="date_time"){n.inputType=t[i].type}else if(t[i].type=="options"){n.inputType="select"}else{n.inputType="text"}m.push(n)}d=d.concat(m);o.userCustomFields=angular.copy(d)}c.getDesktopHelpId().then(function(e){if(e.customWebFormAdvertisements&&e.customWebFormAdvertisements.length>0){for(var t=0;t<e.customWebFormAdvertisements.length;t++){if(e.customWebFormAdvertisements[t].image&&e.customWebFormAdvertisements[t].image.contentUrl){o.slides.push({image:"/no_auth_ewei_attachment?contentUrl="+e.customWebFormAdvertisements[t].image.contentUrl})}else{e.customWebFormAdvertisements.splice(t,1);t--}}}o.webFormStype=angular.copy(e);if(e.webFormOutward){o.webFormOutward=e.webFormOutward;if(o.webFormOutward.style){o.webFormOutward.style=o.webFormOutward.style;if(e.webFormOutward.style=="badge"){o.webFormOutward.style="fillet"}}else{o.webFormOutward.style="fillet"}o.changeButtonStyle(o.webFormOutward.style)}else{o.webFormOutward=f}if(e.webFormFields){var i=angular.copy(e.webFormFields);for(var t=0;t<i.length;t++){i[t].showName=i[t].showName||i[t].name;var n=true;i[t].active=false;if(i[t].fieldName=="email"||i[t].fieldName=="mobilePhone"){o.userInfArr.push(i[t])}for(var s=0;s<d.length;s++){if(i[t].fieldName==d[s].fieldName){n=false;break}}if(n){i.splice(t,1);t--}}o.ticketCustomFieldShowDemo=angular.copy(i);for(var a=0;a<i.length;a++){for(var r=0;a<o.userCustomFields.length;r++){if(i[a].fieldName==o.userCustomFields[r].fieldName){o.userCustomFields[r].activeShow=true;break}}}}})});o.changeButtonStyle=function(e){o.webFormOutward.style=e;switch(e){case"fillet":o.webFormOutward.buttonLeftRadiusLeftTop="15px";o.webFormOutward.buttonLeftRadiusRightTop="initial";o.webFormOutward.buttonLeftRadiusLeftBottom="15px";o.webFormOutward.buttonLeftRadiusRightBottom="initial";o.webFormOutward.buttonLeftPaddingLeft="6px";o.webFormOutward.buttonRightRadiusLeftTop="initial";o.webFormOutward.buttonRightRadiusLeftBottom="initial";o.webFormOutward.buttonRightRadiusRightTop="15px";o.webFormOutward.buttonRightRadiusRightBottom="15px";o.webFormOutward.buttonRightPaddingRight="12px";o.webFormOutward.buttonLeftFloat="left";o.webFormOutward.buttonLeftWidth="36px";o.webFormOutward.buttonRightHeight="32px";o.webFormOutward.buttonRightWidth="144px";o.webFormOutward.buttonLeftFontSize="20px";o.webFormOutward.buttonRightLineHeight="32px";o.webFormOutward.buttonLeftHeight="32px";o.webFormOutward.buttonWidth="180px";o.webFormOutward.buttonLeftPosition="relative";o.webFormOutward.buttonLeftPositionTop="initial";o.webFormOutward.buttonLeftPosition="initial";break;case"square":o.webFormOutward.buttonLeftFloat="initial";o.webFormOutward.buttonLeftPaddingLeft="initial";o.webFormOutward.buttonLeftWidth="60px";o.webFormOutward.buttonLeftRadiusLeftTop="6px";o.webFormOutward.buttonLeftRadiusLeftBottom="6px";o.webFormOutward.buttonLeftRadiusRightTop="6px";o.webFormOutward.buttonLeftRadiusRightBottom="6px";o.webFormOutward.buttonLeftFontSize="24px";o.webFormOutward.buttonLeftHeight="60px";o.webFormOutward.buttonWidth="60px";o.webFormOutward.buttonLeftLineHeight="50px";break;case"roundness":o.webFormOutward.buttonLeftFloat="initial";o.webFormOutward.buttonLeftPaddingLeft="initial";o.webFormOutward.buttonLeftWidth="60px";o.webFormOutward.buttonLeftRadiusLeftTop="50%";o.webFormOutward.buttonLeftRadiusLeftBottom="50%";o.webFormOutward.buttonLeftRadiusRightTop="50%";o.webFormOutward.buttonLeftRadiusRightBottom="50%";o.webFormOutward.buttonLeftFontSize="24px";o.webFormOutward.buttonLeftHeight="60px";o.webFormOutward.buttonLeftLineHeight="50px";o.webFormOutward.buttonWidth="60px";break}};o.checkedMenu=function(e){var t=false,i=null;for(var n=0;n<o.ticketCustomFieldShowDemo.length;n++){if(e.fieldName==o.ticketCustomFieldShowDemo[n].fieldName){t=true;i=n}}if(t){o.ticketCustomFieldShowDemo.splice(i,1)}else{o.ticketCustomFieldShowDemo.push(e)}e.activeShow=!e.activeShow;if(e.fieldName=="email"||e.fieldName=="mobilePhone"){if(e.activeShow){if(o.userInfArr.length<2){o.userInfArr.push(e)}}else{o.userInfArr.pop()}}};o.editMenu=function(e){e.active=true};o.editMenuOver=function(e){e.active=false};o.colorOptions={showAlpha:true,replacerClassName:"w220 btn btn-default",cancelText:"取消",chooseText:"确定",showInput:true};o.positionOptions=[{option:"底部右侧",value:"bottom_right"},{option:"底部左侧",value:"bottom_left"},{option:"右侧浮动",value:"right"},{option:"左侧浮动",value:"left"}];o.updateOutward=function(){var e=angular.copy(o.ticketCustomFieldShowDemo);if(e.length<=0&&o.webFormOutward.chatFormShow){r.add("当前的表单字段为空，会导致客户无字段可用。请配置表单字段。","danger");return false}for(var t=0;t<e.length;t++){delete e[t].active;delete e[t].activeShow;if(o.userInfArr.length==2&&(e[t].fieldName=="email"||e[t].fieldName=="mobilePhone")){e[t].required=false;e[t].orderKey=0}else{e[t].orderKey=t+1}if(e[t].fieldName=="subject"||e[t].fieldName=="description"){if(!e[t].required){e[t].required=true}}}var i=angular.copy(o.webFormStype);i.webFormFields=e;i.webFormOutward=o.webFormOutward;angular.forEach(i.customWebFormAdvertisements,function(e){if(e.id){delete e.id}if(e.url&&e.url.toLowerCase().indexOf("http")==-1){e.url="http://"+e.url}if(e.image){e.image={id:e.image.id}}});if(o.webFormOutward.buttonTitle==""){r.add("请输入按钮标题","danger");return}void 0;n({url:"webchat_form_outward.json",method:"POST",data:i}).success(function(e,t,i,n){userAginLogin(e);if(e.success){r.add("更新成功")}else{r.add("更新失败","danger")}})};o.recoveryFormOutward=function(){o.webFormOutward=angular.copy(f);o.changeButtonStyle("fillet")}}function t(){return{restrict:"EA",link:function(e,t,i,n){var s=null;t[0].onclick=function(){var i=this.getElementsByTagName("div")[0].getElementsByTagName("span")[0];s=e.$watch("imgUpLoad.isUploading",function(e,t){if(e){i.style.display="inline-block";i.previousElementSibling.style.display="none"}else{i.style.display="none";i.previousElementSibling.style.display="block"}})};e.$on("$destroy",function(){if(typeof s=="function"){s()}})}}}})();(function(){"use strict";angular.module("eweiApp.ticket").controller("helpCenterAutoAeplyController",e);e.$inject=["$scope","$stateParams","$state","$http","alertService","ConsoleConfig","getHelpCenterIdService"];function e(s,e,t,a,r,i,n){n.getDesktopHelpId().then(function(e){var t="";var i=null;s.wechat={};a({url:"webchat_automatic_reply/"+e.id+".json",method:"GET"}).success(function(e){if(e.success&&e.json){for(var t in e.json){if(typeof e.json[t]=="string"&&e.json[t].indexOf("<save_ticket>")!=-1){e.json[t]=e.json[t].replace("<save_ticket>",'<save_ticket style="color: #6699CC;">')}}i=angular.copy(e.json);s.wechat=angular.copy(e.json)}});a({url:"is_set_webchat_service_catalog/"+e.id+".json",method:"GET"}).success(function(e){s.hasNav=!!e.success});var n={onlineWelcome:" 你好，请问有什么可以帮到你？",onlineAutomaticReply:"你是要联系客服吗？请回复【开始交谈】接通坐席代表。",offlineWelcome:'欢迎光临，如需帮助请<save_ticket style="color: #6699CC;">提交工单</save_ticket>。',offlineAutomaticReply:'请<save_ticket style="color: #6699CC;">提交工单</save_ticket>获得帮助。',offlineArticleList:'下列文章供你参考，<br/>{{article_list}}<br/>没有帮助？请<save_ticket style="color: #6699CC;">提交工单</save_ticket>获得帮助。',onlineWelcomeMenu:"欢迎光临，请问有什么可以帮到你？你是否遇到下列问题？<br/>{{guide_menu}}<br/>点击选择导航菜单，获得帮助。",onlineAutomaticReplyMenu:"请点击选择导航菜单，获得帮助。 <br/>{{guide_menu}}"};s.markLink=function(e){if(navigator.appName=="Microsoft Internet Explorer"){t=document.selection.createRange().text}else{t=window.getSelection().toString()}if(!t){return false}s.wechat[e]=s.wechat[e].replace(/<(?!\/?BR)[^<>]*>/gi,"").replace(t,'<save_ticket style="color: #6699CC;">'+t+"</save_ticket>")};s.navCheck=function(){if(i.isMenu){if(s.wechat.isMenu){s.wechat.onlineWelcome=i.onlineWelcome;s.wechat.onlineAutomaticReply=i.onlineAutomaticReply}else{s.wechat.onlineWelcome=n.onlineWelcome;s.wechat.onlineAutomaticReply=n.onlineAutomaticReply}}else{if(s.wechat.isMenu){s.wechat.onlineWelcome=n.onlineWelcomeMenu;s.wechat.onlineAutomaticReply=n.onlineAutomaticReplyMenu}else{s.wechat.onlineWelcome=i.onlineWelcome;s.wechat.onlineAutomaticReply=i.onlineAutomaticReply}}};s.resetDefault=function(){if(s.wechat.isMenu){s.wechat.onlineWelcome=n.onlineWelcomeMenu;s.wechat.onlineAutomaticReply=n.onlineAutomaticReplyMenu}else{s.wechat.onlineWelcome=n.onlineWelcome}s.wechat.offlineWelcome=n.offlineWelcome;s.wechat.offlineAutomaticReply=n.offlineAutomaticReply;s.wechat.offlineArticleList=n.offlineArticleList};s.updateWelcomes=function(){if(!s.hasNav&&s.isMenu){r.add("当前的导航菜单为空，会导致客户无菜单可用。请前往“在线客服导航”进行配置。","danger");return false}a({url:"webchat_automatic_reply/"+e.id+".json",method:"POST",data:s.wechat}).success(function(e){if(e.success){r.add("更新成功")}else{if(e.message){r.add(e.message,"danger")}else{r.add("更新失败","danger")}}})}})}})();(function(){"use strict";angular.module("eweiApp.ticket").controller("helpCenterServiceRequestManageController",e);e.$inject=["$scope","$stateParams","$http","alertService","serviceDeskService","$filter","getHelpCenterIdService"];function e(r,e,i,o,l,c,t){t.getDesktopHelpId().then(function(e){var t="ticket_web_chat_service_desk/"+e.id+".json";var s=null;var a=null;i.get(t).success(function(e,t,i,n){if(e.success&&e.json){a=e.json;r.webchat=a;s=e.json.serviceDesk;l.query({_count:999,_do_count:false,_fields:"id,name"},function(e){var t=e.serviceDesks;for(var i=0;i<t.length;i++){if(t[i].name=="DEFAULT_SERVICE_DESK_NAME"){t[i].name=c("translate")(t[i].name)}if(t[i].id==s.id){r.serviceDesk=t[i]}}r.serviceDesks=t})}});r.update=function(){if(!r.serviceDesk){o.add("更新失败","danger");return false}a.serviceDesk=r.serviceDesk;i.post("web_form_rules.json",a).success(function(e,t,i,n){if(e.success){o.add("更新成功")}})}})}})();(function(){"use strict";angular.module("eweiApp.ticket").controller("helpCenterOnlineCustomerNavigationController",e);e.$inject=["$scope","$stateParams","$state","$http","$timeout","alertService","ConsoleConfig","getHelpCenterIdService"];function e(u,e,t,d,i,p,n,s){s.getDesktopHelpId().then(function(e){var a=e;var t="list_webchat_service_catalogs/"+a.id+".json";u.serviceCatalogs=[];u.navList=[{name:"导航菜单",serviceCatalogId:a.id}];var l=null;var n=function(e,r){d.get(e).success(function(e,t,i,n){if(e.success&&e.json&&e.json.length>0){if(!l){l=e.id}var s=angular.copy(e.json);for(var a=0;a<s.length;a++){if(!s[a].name){s[a].name=s[a].serviceCatalogName||""}if(s[a].no){s[a].isChecked=true}s[a].uId=a+1}if(r){r(s)}}else{p.add("您还未增加服务目录","danger")}})};n(t,function(e){var t=1;for(var i=0;i<e.length;i++){if(e[i].no){t++}}u.serviceCatalogs=e;if(t>=e.length){t=e.length}c[u.nowServiceCatalogNo].nowNo=t;var n={};n[a.id]={nowNo:t,allArr:e};c[u.nowServiceCatalogNo]=n});u.nowServiceCatalogNo=0;var r=a.id;var s=true;var c=[{},{},{},{},{}];u.Arr=c;u.editServiceCatalog=function(e,t){e.isShowInput=true;t.stopPropagation()};u.ngFocus=function(){s=false};u.ngBlur=function(e){e.isShowInput=false;i(function(){s=true},500)};u.inputStopPropagation=function(e){e.stopPropagation()};u.setIndex=function(e){if(!s){return false}e.isChecked=!e.isChecked;var t=c[u.nowServiceCatalogNo][r];if(!e.no){e.no=t.nowNo;if(e.no>=u.serviceCatalogs.length){t.nowNo=u.serviceCatalogs.length}else{t.nowNo++}}else{var i=0;for(var n=0;n<u.serviceCatalogs.length;n++){if(u.serviceCatalogs[n].no){if(u.serviceCatalogs[n].no>e.no){u.serviceCatalogs[n].no--}i++}}if(e.no!==u.serviceCatalogs.length&&i<u.serviceCatalogs.length){t.nowNo--}e.no=""}};u.getNextServiceCatalog=function(s,e){if(s.isChecked){if(c[u.nowServiceCatalogNo+1]&&c[u.nowServiceCatalogNo+1][s.serviceCatalogId]&&c[u.nowServiceCatalogNo+1][s.serviceCatalogId].allArr.length>0){u.nowServiceCatalogNo++;var t=o(s.serviceCatalogId,c[u.nowServiceCatalogNo]);if(t){u.serviceCatalogs=t;r=s.serviceCatalogId;u.navList.push({name:s.name,serviceCatalogId:s.serviceCatalogId})}}else{var i="list_webchat_service_catalogs/"+a.id+".json?parentId="+s.serviceCatalogId;n(i,function(e){u.nowServiceCatalogNo++;r=s.serviceCatalogId;u.navList.push({name:s.name,serviceCatalogId:s.serviceCatalogId});var t=1;for(var i=0;i<e.length;i++){if(e[i].no){t++}}if(t>=e.length){t=e.length}var n={nowNo:t,allArr:e};u.serviceCatalogs=e;c[u.nowServiceCatalogNo][s.serviceCatalogId]=n})}e.stopPropagation()}};u.goServiceCatalog=function(e,t){u.nowServiceCatalogNo=t;r=e.serviceCatalogId;if(t==u.navList.length-1){return false}u.navList=u.navList.slice(0,t+1);var i=o(e.serviceCatalogId,c[t]);if(i){u.serviceCatalogs=i}};var o=function(e,t){for(var i in t){if(i==e){return t[i].allArr}}return false};u.updateServiceCatalogs=function(){var e=angular.copy(c);var t=[];var i=[];for(var n=0;n<e.length;n++){for(var s in e[n]){if(e[n][s]&&e[n][s].allArr&&e[n][s].allArr.length>0){t=t.concat(e[n][s].allArr)}}}for(var a=0;a<t.length;a++){if(t[a].no||t[a].id){var r={};if(t[a].id){r.id=t[a].id}r.name=t[a].name;if(t[a].no){r.no=t[a].no}r.serviceCatalogId=t[a].serviceCatalogId;r.viaWebchatId=l;i.push(r)}}var o="update_webchat_service_catalogs/"+l+".json";d.post(o,i).success(function(e,t,i,n){if(e.success){p.add("更新成功")}else{p.add("更新失败")}})}})}})();+function(){"use strict";angular.module("eweiApp.system_setting").config(e);e.$inject=["$stateProvider","$urlRouterProvider"];function e(e,t){e.state("system_setting.web-channel",{url:"/multi_channel/web-channel/:id",controller:"webChannelController",templateUrl:"source/system-setting/channel-settings/web-channel/templates/web-channel.html",permission:"ticket_setting_via"}).state("system_setting.web-channel.basic",{url:"/basic",controller:"webChannelBasicController",templateUrl:"source/system-setting/channel-settings/web-channel/templates/web-channel-basic.html",permission:"ticket_setting_via",onEnter:i("system_setting.web-channel")}).state("system_setting.web-channel.senior",{url:"/senior",controller:"webChannelSeniorController",templateUrl:"source/system-setting/channel-settings/web-channel/templates/web-channel-senior.html",permission:"ticket_setting_via",onEnter:i("system_setting.web-channel")}).state("system_setting.web-channel.auto-invite",{url:"/auto-invite",controller:"webChannelAutoInviteController",templateUrl:"source/system-setting/channel-settings/web-channel/templates/auto-invite.html",permission:"ticket_setting_via",onEnter:i("system_setting.web-channel")}).state("system_setting.web-channel.api",{url:"/api",controller:"webChannelApiController",templateUrl:"source/system-setting/channel-settings/web-channel/templates/web-channel-api.html",permission:"ticket_setting_via",onEnter:i("system_setting.web-channel")}).state("system_setting.emailChannel",{url:"/multi_channel/emailChannel/:id",templateUrl:"source/system-setting/channel-settings/email-channel/email-channel.html",controller:"systemChanneEmaillController",permission:"ticket_setting_via"}).state("system_setting.emailChannel.accessConfig",{url:"/accessConfig",templateUrl:"source/system-setting/channel-settings/email-channel/access-config.html",controller:"systemChannelEmailAccessConfigController",permission:"ticket_setting_via"}).state("system_setting.emailChannel.advancedSetting",{url:"/advancedSetting",templateUrl:"source/system-setting/channel-settings/email-channel/advanced-setting.html",controller:"systemChannelEmailAdvancedSettingController",permission:"ticket_setting_via"}).state("system_setting.help-center",{url:"/multi_channel/help-center/:id",controller:"helpCenterChannelController",templateUrl:"source/system-setting/channel-settings/help-center/templates/help-center-channel.html",permission:"ticket_setting_via"}).state("system_setting.help-center.basic",{url:"/basic",controller:"helpCenterBasicController",templateUrl:"source/system-setting/channel-settings/help-center/templates/help-center-channel-basic.html",permission:"ticket_setting_via",onEnter:i("system_setting.help-center")}).state("system_setting.help-center.senior",{url:"/senior",controller:"helpCenterSeniorController",templateUrl:"source/system-setting/channel-settings/help-center/templates/help-center-channel-senior.html",permission:"ticket_setting_via",onEnter:i("system_setting.help-center")}).state("system_setting.help-center.client",{url:"/client",controller:"helpCenterClientCideController",templateUrl:"source/system-setting/channel-settings/help-center/templates/help-center-channel-client.html",permission:"ticket_setting_via",onEnter:i("system_setting.help-center")}).state("system_setting.dingdingChannel",{url:"/multi_channel/dingdingChannel/:id",templateUrl:"source/system-setting/channel-settings/dingding-channel/dingding-channel.html",controller:"systemChannelDingdingSettingCtrl",permission:"ticket_setting_via"}).state("system_setting.dingdingChannel.accessConfig",{url:"/accessConfig",templateUrl:"source/system-setting/channel-settings/dingding-channel/access-config.html",controller:"systemChannelDingdingAccessConfigController",permission:"ticket_setting_via"}).state("system_setting.dingdingChannel.menuSetting",{url:"/menuSetting",templateUrl:"source/system-setting/channel-settings/dingding-channel/menu-setting.html",controller:"systemChannelDingdingMenuSettingController",permission:"ticket_setting_via"}).state("system_setting.dingdingChannel.advancedSetting",{url:"/advancedSetting",templateUrl:"source/system-setting/channel-settings/dingding-channel/advanced-setting.html",controller:"systemChannelDingdingAdvancedSettingController",permission:"ticket_setting_via"}).state("system_setting.yunzhijiaChannel",{url:"/multi_channel/yunzhijiaChannel/:id",templateUrl:"source/system-setting/channel-settings/yunzhijia-channel/yunzhijia-channel.html",controller:"systemChannelYunzhijiaSettingCtrl",permission:"ticket_setting_via"}).state("system_setting.yunzhijiaChannel.accessConfig",{url:"/accessConfig",templateUrl:"source/system-setting/channel-settings/yunzhijia-channel/access-config.html",controller:"systemChannelYunzhijiaAccessConfigController",permission:"ticket_setting_via"}).state("system_setting.yunzhijiaChannel.advancedSetting",{url:"/advancedSetting",templateUrl:"source/system-setting/channel-settings/yunzhijia-channel/advanced-setting.html",controller:"systemChannelYunzhijiaAdvancedSettingController",permission:"ticket_setting_via"}).state("system_setting.apiChannel",{url:"/multi_channel/apiChannel/:id",templateUrl:"source/system-setting/channel-settings/api-channel/api.html",controller:"systemChannelApiController",permission:"ticket_setting_via"}).state("system_setting.sdkChannel",{url:"/multi_channel/sdkChannel/:id",templateUrl:"source/system-setting/channel-settings/sdk-channel/sdk.html",controller:"systemChannelSdkController",permission:"ticket_setting_via"}).state("system_setting.sdkChannel.accessConfig",{url:"/accessConfig",templateUrl:"source/system-setting/channel-settings/sdk-channel/access-config.html",controller:"systemChannelSdkAccessConfigController",permission:"ticket_setting_via"}).state("system_setting.sdkChannel.advancedSetting",{url:"/advancedSetting",templateUrl:"source/system-setting/channel-settings/sdk-channel/advanced-setting.html",controller:"systemChannelSdkAdvancedSettingController",permission:"ticket_setting_via"}).state("system_setting.ctiChannel",{url:"/multi_channel/ctiChannel/:id",templateUrl:"source/system-setting/channel-settings/cti-channel/cti.html",controller:"systemChannelCtiController",permission:"ticket_setting_via"}).state("system_setting.ctiChannel.accessConfig",{url:"/accessConfig",templateUrl:"source/system-setting/channel-settings/cti-channel/access-config.html",controller:"systemChannelCtiConfigController",permission:"ticket_setting_via"}).state("system_setting.weixinChannel",{url:"/multi_channel/weixinChannel/:id/:type",templateUrl:"source/system-setting/channel-settings/weixin-channel/weixin-channel.html",controller:"systemChannelWeixinController",permission:"ticket_setting_via"}).state("system_setting.weixinChannel.accessConfig",{url:"/accessConfig",templateUrl:"source/system-setting/channel-settings/weixin-channel/access-config.html",controller:"systemChannelWeixinConfigController",permission:"ticket_setting_via"}).state("system_setting.weixinChannel.accessConfigPort",{url:"/accessConfigPort",templateUrl:"source/system-setting/channel-settings/weixin-channel/access-config-port.html",controller:"systemChannelWeixinConfigPortController",permission:"ticket_setting_via"}).state("system_setting.weixinChannel.menuSetting",{url:"/menuSetting",templateUrl:"source/system-setting/channel-settings/weixin-channel/menu-setting.html",controller:"systemChannelWeixinMenuSettingController",permission:"ticket_setting_via"}).state("system_setting.weixinChannel.advancedSetting",{url:"/advancedSetting",templateUrl:"source/system-setting/channel-settings/weixin-channel/advanced-setting.html",controller:"systemChannelWeixinAdvancedSettingController",permission:"ticket_setting_via"})}function i(n){e.$inject=["$state","$stateParams","coreModelService"];function e(e,t,i){i.config.route.put(n,{name:this.name,params:t,permission:this.permission||""})}return e}}();+function(){"use strict";angular.module("eweiApp.system_setting").service("systemSettingCtiService",e);e.$inject=["coreNotifyService","coreModelService","ctiSipService","ctiUsbService"];function e(i,n,s,a){return{handle:function(e,t){if(!t){i.doNotify(i.constant.EVENT_CHANNEL_STOP,{id:e});i.doNotify(i.constant.EVENT_PHONE_DIAL_SET,true);org.ewei.sdk.OpenChannelApi().getChannelPhone({id:e}).then(function(e){if(e&&e.channel&&e.config){if(e.config.type==="sip"){s.stop()}if(e.config.type==="phone_box"){a.stop()}}})}n.detail.ctis.set(e,"enabled",t)}}}}();(function(e){"use strict";angular.module("eweiApp.system_setting").controller("channelSettingsController",t);t.$inject=["$scope","$state","$modal_","$http","alertService","systemSettingCtiService","license"];function t(s,n,a,e,r,o,i){s.page={pageSize:20,pageNumber:1};s.reload=function(){org.ewei.sdk.OpenChannelApi().listChannel({page:s.page,channel:{name:s.searchKey}}).then(function(e){s.channelList=e.list;s.allCount=e.recordCount})};s.reload();s.searchChannel=function(){if(!s.searchKey||s.searchKey==s.oldSearchKey){return}s.oldSearchKey=angular.copy(s.searchKey);s.page.pageNumber=1;s.reload()};s.cancelSearch=function(){s.oldSearchKey="";s.searchKey="";s.page.pageNumber=1;s.reload()};s.$watch("searchKey",function(e,t){if(e==""&&s.oldSearchKey){s.oldSearchKey="";s.page.pageNumber=1;s.reload()}});s.enabled=function(t,i){if(!i){s._messages="您确定停用吗？";var n=a({scope:s,title:"停用确认",contentTemplate:"source/views/alter_common.html",html:true,show:true,placement:"center"});s.$ok=function(){s.isLoading=true;org.ewei.sdk.OpenChannelApi().updateChannelState({id:t.id,enabled:i}).then(function(e){if(e){s.isLoading=false;r.add("停用成功","success");t.enabled=i;l();n.$promise.then(n.hide);if(t.type==="phone"){o.handle(t.id,i)}}else{s.isLoading=false;r.add("停用失败","danger")}})};s.$hide=function(){n.$promise.then(n.hide)}}else{org.ewei.sdk.OpenChannelApi().updateChannelState({id:t.id,enabled:i}).then(function(e){if(e){t.enabled=i;l();if(t.type==="phone"){o.handle(t.id,i)}}else{r.add("启用失败","danger")}})}};var l=function(){var t=[];var i=[];var n=[];if(s.channelList&&s.channelList.length>0){angular.forEach(s.channelList,function(e){if(e.type=="helpcenter"){t.push(e)}else{if(e.enabled){i.push(e)}else{n.push(e)}}});i.sort(function(e,t){return new Date(t.createdAt).getTime()-new Date(e.createdAt).getTime()});n.sort(function(e,t){return new Date(t.createdAt).getTime()-new Date(e.createdAt).getTime()});s.channelList=t.concat(i,n)}};s.toEditchannel=function(e,t){if(t=="modify"){if(e.type=="web"){n.go("system_setting.web-channel",{id:e.id})}else if(e.type=="weixin"){n.go("system_setting.weixinChannel",{id:e.id,type:""})}else if(e.type=="email"){n.go("system_setting.emailChannel.accessConfig",{id:e.id})}else if(e.type=="helpcenter"){n.go("system_setting.help-center",{id:e.id})}else if(e.type=="sdk"){n.go("system_setting.sdkChannel.accessConfig",{id:e.id})}else if(e.type=="phone"){n.go("system_setting.ctiChannel.accessConfig",{id:e.id})}else if(e.type=="dingding"){n.go("system_setting.dingdingChannel.accessConfig",{id:e.id})}else if(e.type=="api"){n.go("system_setting.apiChannel",{id:e.id})}else if(e.type=="yunzhijia"){n.go("system_setting.yunzhijiaChannel.accessConfig",{id:e.id})}return}s.channelTypeList=[{iconclass:"web",name:"网页组件",description:"添加网页表单或在线客服渠道，发布在你的网页上，向客户提供网页在线交谈、远程协助、工单支持和FAQ自助等全方位服务。",sref:"system_setting.web-channel"},{iconclass:"weixin",name:"微信接入",description:"通过接口，将微信公众号接入客服系统。客户在微信内发起服务请求，接受在线客服、工单支持和FAQ自助等全方位的服务。",sref:"system_setting.web-channel",type:"weixin"},{iconclass:"dingding",name:"钉钉接入",description:"通过接口，将帮助中心接入钉钉企业号。客户可在钉钉内发起服务请求，接受在线客服、工单支持和FAQ自助等全方位的服务。",sref:"system_setting.dingdingChannel.accessConfig"},{iconclass:"yunzhijia",name:"云之家接入",description:"通过接口，将帮助中心接入云之家轻应用。客户可在应用内发起服务请求，接受在线客服、工单支持和FAQ自助等全方位的服务。",sref:"system_setting.yunzhijiaChannel.accessConfig"},{iconclass:"email",name:"邮件转工单",description:"配置邮件收件箱，公布给客户，接收客户发送的邮件，自动转为工单。工单的回复自动发送给客户，客户通过邮件回复工单。",sref:"system_setting.emailChannel.accessConfig"},{iconclass:"phone",name:"电话接入",description:"通过CTI电脑电话接口，将电话语音接入客服系统。来电/去电弹屏，自动关联客户，创建或插入工单，并保存通话录音。",sref:"system_setting.ctiChannel.accessConfig"},{iconclass:"sdk",name:"App-SDK",description:"SDK渠道是内置于你的APP或电脑客户端程序内部的客服渠道，方便客户在你的应用程序内发起服务请求和接受服务支持。",sref:"system_setting.sdkChannel.accessConfig"},{iconclass:"api",name:"API",description:"使用易维API访问易维功能，如创建、编辑和查询工单。可将易维功能整合到您的应用程序中，或建立app在您的易维中添加功能。",sref:"system_setting.apiChannel"}];s.license=i;c=a({scope:s,title:"选择渠道类型",template:"source/system-setting/channel-settings/modal/modal-tpl.html",contentTemplate:"source/system-setting/channel-settings/modal/select-chennel-modal.html",html:true,show:true,placement:"center"})};var c=null;s.goDetail=function(e){var t=s.license.type();if(t==="free"||t==="trial"||t==="enterprise_trial"){var i=a({scope:s,template:"modal/modal.tpl.w500.html",contentTemplate:"source/system-setting/channel-settings/modal/no-license-modal.html",html:true,show:true,placement:"center"});s.$ok=function(){$("#ewei-websdk-portal").trigger("click")};s.$hide=function(){i.$promise.then(i.hide)};return}if(e.type==="weixin"){c.$promise.then(c.hide);s.channel={name:"service"};var i=a({scope:s,contentTemplate:"source/system-setting/channel-settings/modal/select-weixin-type.html",html:true,show:true,placement:"center",title:"选择公众号类型"});s.addChannel=function(){var e={id:0,type:s.channel.name};if(s.channel.name==="service"){n.go("system_setting.weixinChannel.accessConfig",e)}else{n.go("system_setting.weixinChannel.accessConfigPort",e)}}}else{n.go(e.sref,{id:0})}};s.deletechannel=function(t){s._messages="渠道删除后无法恢复，请谨慎操作。确定删除？";var i=a({scope:s,title:"删除确认",contentTemplate:"source/views/alter_common.html",html:true,show:true,placement:"center"});s.$ok=function(){if(s.channelList.indexOf(t)===-1){return false}s.isLoading=true;org.ewei.sdk.OpenChannelApi().deleteChannel({id:t.id}).then(function(e){if(e){s.channelList.splice(s.channelList.indexOf(t),1);s.isLoading=false;r.add("删除成功","success");i.$promise.then(i.hide);s.allCount--}else{s.isLoading=false;r.add("删除失败","danger")}})};s.$hide=function(){i.$promise.then(i.hide)}};s.goArticle=function(e){var t={phone:760,weixin:720,email:717};var i="//help.ewei.com/new/#/article/detail/"+t[e.type];window.open(i)}}})(org.ewei);(function(e){"use strict";angular.module("eweiApp.system_setting").controller("webChannelController",t);t.$inject=["$scope","$state","$stateParams","coreModelService","alertService","license"];function t(t,i,e,n,s,a){var r=parseInt(e.id);if(r>0){t.navListData=[{title:"基础设置",self:"system_setting.web-channel.basic"},{title:"高级设置",self:"system_setting.web-channel.senior"},{title:"开发者文档",self:"system_setting.web-channel.api"}];if(a.type()==="enterprise_basic"||a.type()==="enterprise_basic_19"||a.type()==="enterprise_trial"){t.navListData.splice(2,0,{title:"自动邀请",self:"system_setting.web-channel.auto-invite"})}}else{t.navListData=[{title:"基础设置",self:"system_setting.web-channel.basic"}];t.webChannelName="增加网页组件渠道"}var o;var l=n.config.route.get("system_setting.web-channel");if(l&&r>0){o=l.name}else{o="system_setting.web-channel.basic"}if(r>0){org.ewei.sdk.OpenChannelApi().getChannelWeb({id:r}).then(function(e){if(e){t.webChannel=e;t.webChannelName=e.channel.name||"网页组件";t.$broadcast("web-channel-basic",true);i.go(o)}else{s.add("服务器异常","danger")}})}else{i.go(o)}}})(org.ewei);(function(_){"use strict";angular.module("eweiApp.system_setting").controller("webChannelBasicController",e);e.$inject=["$scope","$state","$stateParams","$http","$rootScope","$timeout","$filter","$modal_","ConsoleConfig","license","getWebChatFormCommonInf","alertService"];function e(a,n,e,i,t,s,r,o,l,c,u,d){a.positionOptions=[{option:"右侧居中",value:"right"},{option:"右侧底部",value:"bottom_right"},{option:"左侧居中",value:"left"},{option:"左侧底部",value:"bottom_left"}];a.colorList=["#32B1EB","#62A8EA","#57C7D4","#46BE8A","#F2A654","#F96868","#526069"];a.colorOptions={showAlpha:true,cancelText:"取消",chooseText:"确定",showInput:true};a.license=c.type();a.licenseService=c;a.objAd={url:""};a.imgUpLoad={isUploading:false};var p=t.provider?t.provider.headBackgroundColor?t.provider.headBackgroundColor:"#1e8cce":"#1e8cce";var f={buttonBackgroundColor:p,buttonTitle:"在线交谈",position:"right",style:"roundness",windowTitle:"在线交谈",windowTitleColor:p};a.slides=[];a.changeButtonStyle=function(e){a.webChannel.formOutward.style=e};var m;if(l.provider){m=l.provider.id||""}a.id=parseInt(e.id);org.ewei.sdk.OpenRobotApi().findRobotById().then({success:function(e){a.robotConfig=e||{};if(a.robotConfig.photo&&a.robotConfig.photo.contentUrl){a.robotAvatarUrl="/no_auth_ewei_attachment?contentUrl="+a.robotConfig.photo.contentUrl}else{a.robotAvatarUrl="source/images/face/robot.jpg"}}});var g=_.utils.uuid(32);var v=window.location.origin+"/client/?provider_id="+m+"&uid="+g;var h='<script src="'+window.location.origin+"/portal/"+m+"/"+g+'.js"><\/script>';a.isDisabled=false;var y=function(){if(a.id>0){var e=angular.copy(a.$parent.webChannel);if(e){if(e.imageAdvertisements&&e.imageAdvertisements.length>0){for(var t=0;t<e.imageAdvertisements.length;t++){if(e.imageAdvertisements[t].image&&e.imageAdvertisements[t].image.contentUrl){a.slides.push({image:"/no_auth_ewei_attachment?contentUrl="+e.imageAdvertisements[t].image.contentUrl,isDefault:e.imageAdvertisements[t].isDefault})}else{e.imageAdvertisements.splice(t,1);t--}}}if(e.formOutward){e.formOutward.style=e.formOutward.style?e.formOutward.style=="badge"?"fillet":e.formOutward.style:"fillet"}else{e.formOutward=f}g=e.channel.uid;a.webChannel=e;a.webChannel.config.keyCode=window.location.origin+"/client/?provider_id="+m+"&uid="+g;a.webChannel.config.code='<script src="'+window.location.origin+"/portal/"+m+"/"+g+'.js"><\/script>';a.imgTwoSrc="http://qr.topscan.com/api.php?text="+encodeURIComponent(a.webChannel.config.keyCode||v)}}else{a.imgTwoSrc="http://qr.topscan.com/api.php?text="+encodeURIComponent(v);a.webChannel={formOutward:f,imageAdvertisements:[],config:{code:h,keyCode:v,enabledAdvertisement:true},channel:{name:"",uid:g}}}};a.$on("web-channel-basic",function(e,t){if(t){y()}});y();a.notInColorList=function(e){return a.colorList.indexOf(e)==-1};a.fileQueued=function(e){void 0};a.uploadProgress=function(e,t){a.$apply(a.imgUpLoad.isUploading=true)};a.uploadSuccess=function(e,t){a.$apply(a.imgUpLoad.isUploading=false);var s={fileName:e.name,contentType:e.type,contentUrl:t.key,size:e.size};i({method:"POST",url:"attachment.json",data:s}).success(function(e){if(e.success&&e.json){if(a.webChannel&&a.webChannel.imageAdvertisements){s.id=e.json.id;var t=a.webChannel.imageAdvertisements;if(t&&t.length>0){for(var i=0;i<t.length;i++){if(t[i].isDefault){t.splice(i,1);i--}}}a.webChannel.imageAdvertisements.push({imageId:s.id,image:s,url:a.objAd&&a.objAd.url?a.objAd.url:""});if(a.slides&&a.slides.length>0){for(var n=0;i<a.slides.length;n++){if(a.slides[n].isDefault){a.slides.splice(n,1);n--}}}a.slides.push({image:"/no_auth_ewei_attachment?contentUrl="+s.contentUrl,isDefault:false});a.objAd={url:""}}}})};a.error=function(e){a.$apply(a.imgUpLoad.isUploading=false)};a.deleteCustomWebFormAd=function(e){if(a.webChannel&&a.webChannel.imageAdvertisements){a.webChannel.imageAdvertisements.splice(a.webChannel.imageAdvertisements.indexOf(e),1);a.slides=a.webChannel.imageAdvertisements.map(function(e){return{image:"/no_auth_ewei_attachment?contentUrl="+e.image.contentUrl,isDefault:e.isDefault}});a.reloadCarousel=true;s(function(){a.reloadCarousel=false},300)}};a.updateBasic=function(){if(!a.webChannel||!a.webChannel.channel||!a.webChannel.channel.name){d.add("渠道名称不能为空","danger");return}if(!a.webChannel.formOutward||a.webChannel.formOutward.style=="fillet"&&!a.webChannel.formOutward.buttonTitle){d.add("请输入标签文字","danger");return}if(r("specialChart")(a.webChannel.channel.name)){d.add("渠道名称不支持除中划线，下划线以外的特殊字符","danger");return}if(a.webChannel.formOutward.style=="fillet"&&a.webChannel.formOutward.buttonTitle&&r("specialChart")(a.webChannel.formOutward.buttonTitle)){d.add("标签文字不支持除中划线，下划线以外的特殊字符","danger");return}if(a.webChannel.formOutward&&a.webChannel.formOutward.windowTitle&&r("specialChart")(a.webChannel.formOutward.windowTitle)){d.add("界面标题不支持除中划线，下划线以外的特殊字符","danger");return}if(a.disableValue){return}a.disableValue=true;if(a.id>0){var e=angular.copy(a.webChannel);e.id=e.channel.id;e.name=e.channel.name;delete e.channel;delete e.config.keyCode;delete e.config.code;if(e.formOutward.style!="fillet"){e.formOutward.buttonTitle=""}var t=e.imageAdvertisements;if(t&&t.length>0){for(var i=0;i<t.length;i++){if(t[i].isDefault){t.splice(i,1);i--}}}org.ewei.sdk.OpenChannelApi().updateChannelWeb(e).then(function(e){a.disableValue=false;if(e){a.$parent.webChannel=angular.copy(a.webChannel);d.add("更新成功","success")}else{d.add("更新失败","danger")}})}else{var e=angular.copy(a.webChannel);e.name=e.channel.name;e.uid=e.channel.uid;delete e.channel;delete e.config.keyCode;delete e.config.code;org.ewei.sdk.OpenChannelApi().saveChannelWeb(e).then(function(e){a.disableValue=false;if(e){a.webChannel.id=e;n.go("system_setting.web-channel",{id:a.webChannel.id});d.add("更新成功","success")}else{d.add("更新失败","danger")}})}}}})(org.ewei);(function(o){"use strict";angular.module("eweiApp.system_setting").controller("webChannelSeniorController",e);e.$inject=["$scope","$state","$stateParams","alertService","$timeout"];function e(r,e,t,i,n){r.id=parseInt(t.id);var s=/^[ ]*$/;r.webConfig={};r.config={homeChecked:0};var a=function(){var e=angular.copy(r.$parent.webChannel);if(e&&e.config){e.config.modules=e.config.modules?typeof e.config.modules==="string"?JSON.parse(e.config.modules):e.config.modules:[];angular.forEach(e.config.modules,function(e,t,i){if(e.home){r.config.homeChecked=t}if(!e.funcName){e.funcName=e.func}});r.webConfig=e.config;r.webConfig.recommendKeywords=r.webConfig.recommendKeywords&&(typeof r.webConfig.recommendKeywords==="string"?JSON.parse(r.webConfig.recommendKeywords):r.webConfig.recommendKeywords)||[];o.sdk.OpenFormApi().listChatForm({}).then(function(e){r.listChatForm=e});o.sdk.OpenFormApi().listTicketForm({}).then(function(e){r.listTicketForm=e})}};r.$on("web-channel-basic",function(e,t){if(t){a()}});a();r.disableKeywordBtn=true;r.keyword={};r.currKeywordIdx=-1;r.onChangeKeyword=function(){r.disableKeywordBtn=s.test(r.keyword.text)};r.removeKeyword=function(e){r.webConfig.recommendKeywords.splice(e,1)};r.addKeyword=function(){if(!s.test(r.keyword.text)){r.webConfig.recommendKeywords.unshift(r.keyword.text);r.keyword.text="";r.disableKeywordBtn=true}};r.updateWebConfig=function(){var t=angular.copy(r.webConfig);var n=0;var s=null;var a=false;angular.forEach(t.modules,function(e,t,i){if(e.opened){n++}if(t==r.config.homeChecked){e.home=true;if(!e.opened){s=e}}else{e.home=false}if(!e.funcName){a=true}});if(n==0){i.add("功能配置至少需要开启一项","danger");return}if(s!=null){i.add(s.func+"没有开启,不能作为首页","danger");return}if(a){i.add("自定义菜单名称不能为空","danger");return}if(t.recommendKeywordsSwitch&&t.recommendKeywords.length===0){i.add("请至少添加一个关键词","danger");return}if(r.disableValue){return}r.disableValue=true;t.modules=JSON.stringify(t.modules);var e={id:r.id,config:t};o.sdk.OpenChannelConfigApi().updateChannelWebConfig(e).then(function(e){r.disableValue=false;if(e){r.$parent.webChannel.config=angular.copy(t);i.add("更新成功","success")}else{i.add("更新失败","danger")}})}}})(org.ewei);(function(){"use strict";angular.module("eweiApp.system_setting").controller("webChannelAutoInviteController",e);e.$inject=["$scope","$state","$stateParams","alertService"];function e(t,e,i,n){var s=parseInt(i.id);t.webChannelModel={config:{},autoinvite:{}};t.positionOptions=[{option:"屏幕居中",value:"center"},{option:"屏幕左上角",value:"left_top"},{option:"屏幕左下角",value:"left_bottom"},{option:"屏幕右上角",value:"right_top"},{option:"屏幕右下角",value:"right_bottom"}];var a=function(){var e=angular.copy(t.$parent.webChannel);if(e&&e.config){t.webChannelModel.config=e.config}if(e&&e.autoinvite){t.webChannelModel.autoinvite=e.autoinvite}};t.changeSetting=function(){void 0;var e={id:s,config:t.webChannelModel.config};org.ewei.sdk.OpenChannelConfigApi().updateChannelWebConfig(e).then(function(e){if(e){n.add("更新成功");t.$parent.webChannel.config=angular.copy(t.webChannelModel.config)}else{n.add("更新失败","danger")}})};t.updateAutoInviteConfig=function(){var e={id:s,autoinvite:t.webChannelModel.autoinvite};if(!e.autoinvite.title){n.add("邀请框标题不能为空","danger");return false}if(!e.autoinvite.message){n.add("邀请语不能为空","danger");return false}if(e.autoinvite.delayTime<0||e.autoinvite.intervalTime<0){n.add("时间不能为负数","danger");return false}org.ewei.sdk.OpenChannelConfigApi().updateChannelWebAutoinviteConfig(e).then(function(e){if(e&&e.autoinviteUid){n.add("更新成功");t.$parent.webChannel.autoinvite=angular.copy(t.webChannelModel.autoinvite)}else{n.add("更新失败","danger")}})};a();t.$on("web-channel-basic",function(e,t){if(t){a()}})}})();(function(a){"use strict";angular.module("eweiApp.system_setting").controller("webChannelApiController",e);e.$inject=["$scope","$state","$stateParams","getWebChatFormCommonInf"];function e(t,e,i,n){t.api={formFields:[]};var s=function(){if(t.$parent.webChannel&&t.$parent.webChannel.config&&t.$parent.webChannel.config.ticketFormUid){t.ticketFormUid=t.$parent.webChannel.config.ticketFormUid;a.sdk.OpenFormApi().getFormByUid({uid:t.ticketFormUid}).then(function(e){if(e){t.api.formFields=t.api.formFields.concat(e.formFields||[]);t.api.formFields=_.uniq(t.api.formFields,false,function(e){return e.fieldName});t.api.formFields=_.sortBy(t.api.formFields,"fieldName")}})}if(t.$parent.webChannel&&t.$parent.webChannel.config&&t.$parent.webChannel.config.chatFormUid){t.chatFormUid=t.$parent.webChannel.config.chatFormUid;a.sdk.OpenFormApi().getFormByUid({uid:t.chatFormUid}).then(function(e){if(e){t.api.formFields=t.api.formFields.concat(e.formFields||[]);t.api.formFields=_.uniq(t.api.formFields,false,function(e){return e.fieldName});t.api.formFields=_.sortBy(t.api.formFields,"fieldName")}})}};t.$on("web-channel-basic",function(e,t){if(t){s()}});s()}})(org.ewei);(function(e){"use strict";angular.module("eweiApp.system_setting").controller("systemChanneEmaillController",t).controller("systemChannelEmailAccessConfigController",i).controller("systemChannelEmailAdvancedSettingController",n);t.$inject=["$scope","ConsoleConfig","$stateParams"];i.$inject=["$scope","$state","$stateParams","alertService","ConsoleConfig"];n.$inject=["$scope","$stateParams","alertService","ConsoleConfig"];function t(e,t,i){e.emailSettingModel={id:Number(i.id)};e.eweiHelpcenterApiUrl=t.eweiHelpcenterApiUrl}function i(i,n,e,s,t){var a="";var r=Number(e.id);i.emailConfigModel={id:r,host:t.provider.subDomain+"."+t.domainRoot,config:{}};if(r>0){org.ewei.sdk.OpenChannelApi().getChannelEmail({id:r}).then(function(e){if(e&&e.channel&&e.config){i.emailConfigModel.config=e.config;i.emailConfigModel.name=e.channel.name;i.emailConfigModel.verified=e.channel.verified;a=e.config.email;if(!i.$parent.emailSettingModel.name){i.$parent.emailSettingModel.name=e.channel.name}}})}i.updateAccessConfigSetting=function(){if(!i.emailConfigModel.name){s.add("渠道名称不能为空","danger");return false}if(!verifyEmailAddress(i.emailConfigModel.config.email)){s.add("请输入的正确格式的邮箱","danger");return false}var e="support@"+i.suDdomain+".ewei."+i.com;if(i.emailConfigModel.config.email===e){s.add("系统转接邮箱不能设置为收件箱","danger");return false}if(a&&a!==i.emailConfigModel.config.email){i.emailConfigModel.verified=false}var t={name:i.emailConfigModel.name,config:i.emailConfigModel.config};if(r>0){t.id=r;org.ewei.sdk.OpenChannelApi().updateChannelEmail(t).then(function(e){if(e){s.add("保存成功")}})}else{i.isDisable=true;org.ewei.sdk.OpenChannelApi().saveChannelEmail(t).then(function(e){if(e){i.isDisable=false;s.add("保存成功");n.go("system_setting.detail",{uri:"channel_settings",settingType:"multi_channel"})}})}}}function n(n,e,a,t){var s=Number(e.id);n.emailAdvancedModel={};if(s>0){org.ewei.sdk.OpenChannelApi().getChannelEmail({id:s}).then(function(e){if(e&&e.channel&&e.config){n.emailAdvancedModel.config=e.config;n.emailAdvancedModel.name=e.channel.name;if(!n.$parent.emailSettingModel.name){n.$parent.emailSettingModel.name=e.channel.name}}})}var r=function(e){var t=/^([a-zA-Z0-9-&._]+)@[a-zA-Z0-9-]([._]?[a-zA-Z0-9-])*(\.\w{2,6})+$/i;var i=/^([a-zA-Z0-9]([a-zA-Z0-9\-]{0,61}[a-zA-Z0-9])?\.)+[a-zA-Z]{2,6}$/;var n=_.every(e,function(e){return t.test(e)||i.test(e)});if(!n){a.add("你输入的邮箱或域名格式不正确","danger");return false}var s=_.uniq(e);if(s.length<e.length){a.add("你输入的邮箱或域名重复","danger");return false}return true};n.updateAdvancedSetting=function(){var e=null,t=null;if(n.emailAdvancedModel.config.whiteList){e=n.emailAdvancedModel.config.whiteList.split(" ");if(e.length&&!r(e)){return false}}if(n.emailAdvancedModel.config.blackList){t=n.emailAdvancedModel.config.blackList.split(" ");if(t.length&&!r(t)){return false}}if(_.intersection(e,t).length){a.add("你输入的邮箱或域名不能同时存在黑白名单内","danger");return false}var i={id:s,config:n.emailAdvancedModel.config};org.ewei.sdk.OpenChannelApi().updateChannelEmail(i).then({success:function(e){if(e){a.add("保存成功")}}})}}})();(function(e){"use strict";angular.module("eweiApp.system_setting").controller("helpCenterChannelController",t);t.$inject=["$scope","$state","$stateParams","coreModelService"];function t(e,t,i,n){var s=i.id;if(s>0){e.navListData=[{title:"客户端",self:"system_setting.help-center.client"},{title:"基础设置",self:"system_setting.help-center.basic"},{title:"高级设置",self:"system_setting.help-center.senior"}]}else{e.navListData=[{title:"客户端地址",self:"system_setting.help-center.client"}]}var a;var r=n.config.route.get("system_setting.help-center");if(r&&s>0){a=r.name}else{a="system_setting.help-center.client"}t.go(a)}})(org.ewei);(function(e){"use strict";angular.module("eweiApp.system_setting").controller("helpCenterBasicController",t);t.$inject=["$scope","$state","$stateParams","$http","$rootScope","$timeout","$filter","$modal_","ConsoleConfig","license","getWebChatFormCommonInf","alertService"];function t(a,e,t,i,n,s,r,o,l,c,u,d){a.positionOptions=[{option:"右侧居中",value:"right"},{option:"右侧底部",value:"bottom_right"},{option:"左侧居中",value:"left"},{option:"左侧底部",value:"bottom_left"}];a.colorList=["#32B1EB","#62A8EA","#57C7D4","#46BE8A","#F2A654","#F96868","#526069"];a.colorOptions={showAlpha:true,cancelText:"取消",chooseText:"确定",showInput:true};a.license=c.type();a.licenseService=c;a.objAd={url:""};a.imgUpLoad={isUploading:false};var p=n.provider?n.provider.headBackgroundColor?n.provider.headBackgroundColor:"#1e8cce":"#1e8cce";var f={buttonBackgroundColor:p,buttonTitle:"在线交谈",position:"right",style:"roundness",windowTitle:"在线交谈",windowTitleColor:p};a.slides=[];a.changeButtonStyle=function(e){a.webChannel.formOutward.style=e};a.id=parseInt(t.id);if(a.id>0){org.ewei.sdk.OpenChannelApi().getChannelHelpcenterWebConfig({id:a.id}).then(function(e){if(e){if(e.imageAdvertisements&&e.imageAdvertisements.length>0){for(var t=0;t<e.imageAdvertisements.length;t++){if(e.imageAdvertisements[t].image&&e.imageAdvertisements[t].image.contentUrl){a.slides.push({image:"/no_auth_ewei_attachment?contentUrl="+e.imageAdvertisements[t].image.contentUrl,isDefault:e.imageAdvertisements[t].isDefault})}else{e.imageAdvertisements.splice(t,1);t--}}}if(e.formOutward){e.formOutward.style=e.formOutward.style?e.formOutward.style=="badge"?"fillet":e.formOutward.style:"fillet"}else{e.formOutward=f}a.webChannel=e}})}else{a.webChannel={formOutward:f,imageAdvertisements:[],enabledAdvertisement:false}}org.ewei.sdk.OpenRobotApi().findRobotById().then({success:function(e){a.robotConfig=e||{};if(a.robotConfig.photo&&a.robotConfig.photo.contentUrl){a.robotAvatarUrl="/no_auth_ewei_attachment?contentUrl="+a.robotConfig.photo.contentUrl}else{a.robotAvatarUrl="source/images/face/robot.jpg"}}});a.notInColorList=function(e){return a.colorList.indexOf(e)==-1};a.fileQueued=function(e){void 0};a.uploadProgress=function(e,t){a.$apply(a.imgUpLoad.isUploading=true)};a.uploadSuccess=function(e,t){a.$apply(a.imgUpLoad.isUploading=false);var s={fileName:e.name,contentType:e.type,contentUrl:t.key,size:e.size};i({method:"POST",url:"attachment.json",data:s}).success(function(e){if(e.success&&e.json){if(a.webChannel&&a.webChannel.imageAdvertisements){s.id=e.json.id;var t=a.webChannel.imageAdvertisements;if(t&&t.length>0){for(var i=0;i<t.length;i++){if(t[i].isDefault){t.splice(i,1);i--}}}a.webChannel.imageAdvertisements.push({imageId:s.id,image:s,url:a.objAd&&a.objAd.url?a.objAd.url:""});if(a.slides&&a.slides.length>0){for(var n=0;i<a.slides.length;n++){if(a.slides[n].isDefault){a.slides.splice(n,1);n--}}}a.slides.push({image:"/no_auth_ewei_attachment?contentUrl="+s.contentUrl,isDefault:false});a.objAd={url:""}}}})};a.error=function(e){a.$apply(a.imgUpLoad.isUploading=false)};a.deleteCustomWebFormAd=function(e){if(a.webChannel&&a.webChannel.imageAdvertisements){a.webChannel.imageAdvertisements.splice(a.webChannel.imageAdvertisements.indexOf(e),1);a.slides=a.webChannel.imageAdvertisements.map(function(e){return{image:"/no_auth_ewei_attachment?contentUrl="+e.image.contentUrl,isDefault:e.isDefault}});a.reloadCarousel=true;s(function(){a.reloadCarousel=false},300)}};a.updateBasic=function(){if(!a.webChannel.formOutward||a.webChannel.formOutward.style=="fillet"&&!a.webChannel.formOutward.buttonTitle){d.add("请输入标签文字","danger");return}if(a.webChannel.formOutward.style=="fillet"&&a.webChannel.formOutward.buttonTitle&&r("specialChart")(a.webChannel.formOutward.buttonTitle)){d.add("标签文字不支持除中划线，下划线以外的特殊字符","danger");return}if(a.webChannel.formOutward&&a.webChannel.formOutward.windowTitle&&r("specialChart")(a.webChannel.formOutward.windowTitle)){d.add("界面标题不支持除中划线，下划线以外的特殊字符","danger");return}if(a.disableValue){return}a.disableValue=true;if(a.id>0){var e=angular.copy(a.webChannel);e.id=e.channel.id;delete e.channel;if(e.formOutward.style!="fillet"){e.formOutward.buttonTitle=""}var t=e.imageAdvertisements;if(t&&t.length>0){for(var i=0;i<t.length;i++){if(t[i].isDefault){t.splice(i,1);i--}}}org.ewei.sdk.OpenChannelApi().updateChannelHelpcenterFormOutward(e).then(function(e){a.disableValue=false;if(e){d.add("更新成功","success")}else{d.add("更新失败","danger")}})}else{d.add("亲，不要随便修改路由Id哦，不然就保存不了了","danger")}}}})(org.ewei);(function(a){"use strict";angular.module("eweiApp.system_setting").controller("helpCenterSeniorController",e);e.$inject=["$scope","$state","$stateParams","alertService"];function e(n,e,t,s){n.id=parseInt(t.id);n.webConfig={};n.config={homeChecked:0};a.sdk.OpenChannelApi().getChannelHelpcenterWebConfig({id:n.id}).then(function(e){if(e){e.config.modules=e.config.modules?JSON.parse(e.config.modules):[{func:"帮助文档",funcName:"帮助文档",funcNameEn:"Documents"},{func:"论坛帖子",funcName:"论坛帖子",funcNameEn:"Community"},{func:"在线客服",funcName:"在线交谈",funcNameEn:"Livechat"},{func:"提交工单",funcName:"提交工单",funcNameEn:"New request"},{func:"查询工单",funcName:"查询工单",funcNameEn:"Tickets"},{func:"下载资源",funcName:"下载资源",funcNameEn:"Downloads"}];angular.forEach(e.config.modules,function(e,t,i){if(e.home){n.config.homeChecked=t}if(!e.funcName){e.funcName=e.func}});n.webConfig=e.config;a.sdk.OpenFormApi().listChatForm({}).then(function(e){n.listChatForm=e});a.sdk.OpenFormApi().listTicketForm({}).then(function(e){n.listTicketForm=e});a.sdk.OpenTicketTypeApi().list({page:{pageNumber:1,pageSize:999}}).then(function(e){n.ticketTypeList=e.list;n.ticketTypeList.unshift({name:"-",id:""})})}});n.toAddOption=function(){n.webConfig.ticketForms.push({helpcenterWebConfig:{id:n.webConfig.id}})};n.toDeleteOption=function(e){if(e===0)return;n.webConfig.ticketForms.splice(e,1)};n.updateWebConfig=function(){var e=angular.copy(n.webConfig);if(n.disableValue){return}for(var t=0;t<e.ticketForms.length;t++){if(!e.ticketForms[t].formName||/^[ ]*$/.test(e.ticketForms[t].formName)){s.add("表单名称不能为空","danger");return}if(!e.ticketForms[t].formUid){s.add("工单表单不能为空","danger");return}}for(var t=0;t<e.modules.length;t++){if(!e.modules[t].funcName||!e.modules[t].funcNameEn){s.add(e.modules[t].func+"的自定义菜单名称不能为空！","danger");return}}n.disableValue=true;e.modules=JSON.stringify(e.modules);var i={id:n.id,config:e};if(i.config.ticketForms&&i.config.ticketForms.length){i.config.ticketForms.forEach(function(e){if(!e.defaultTicketTypeId){delete e.defaultTicketTypeId}})}a.sdk.OpenChannelConfigApi().updateChannelHelpcenterWebConfig(i).then(function(e){n.disableValue=false;if(e){s.add("更新成功","success")}else{s.add("更新失败","danger")}})}}})(org.ewei);(function(a){"use strict";angular.module("eweiApp.system_setting").controller("helpCenterClientCideController",e);e.$inject=["$scope","$state","$stateParams","ConsoleConfig"];function e(t,e,i,n){t.id=parseInt(i.id);t.helpCenter={};t.helpCenter.protocolHref=window.location.host;t.helpCenter.showWeixinSmallAppQrcode=false;var s=false;org.ewei.sdk.OpenChannelApi().getChannelHelpcenterWebConfig({id:t.id}).then(function(e){if(e){t.helpCenter.channelId=e.channel.id;t.helpCenter.showWeixinSmallAppQrcode=e.config.showWeixinSmallAppQrcode;s=t.helpCenter.showWeixinSmallAppQrcode}});org.ewei.sdk.OpenHelpCenterApi().getSmallAppQrCode({}).then({success:function(e){t.helpCenter.imgTwoSrc="/no_auth_ewei_attachment?contentUrl="+e.contentUrl}});t.desktopHelpDownload=function(){var e="";if(n.enviroment=="Production"){e="http://ewei-app-saas.ewei.com/Helpdesk.exe"}else if(n.enviroment=="Test"){e="http://apptest.cdn.ewei.com/Helpdesk.exe"}else{e="http://apptest.cdn.ewei.com/Helpdesk.exe"}window.open(e)};t.onShowWeixinSmallAppQrcodeChange=function(){a.sdk.OpenChannelConfigApi().updateShowWeixinSmallAppQrcode({channelId:t.helpCenter.channelId,show:t.helpCenter.showWeixinSmallAppQrcode}).then(function(){s=t.helpCenter.showWeixinSmallAppQrcode},function(e){t.helpCenter.showWeixinSmallAppQrcode=s;alertService.add("保存失败！请重试。","danger")})}}})(org.ewei);(function(e){"use strict";angular.module("eweiApp.system_setting").controller("systemChannelApiController",t);t.$inject=["$scope","ConsoleConfig","alertService","$stateParams","$state","$filter"];function t(t,e,i,n,s,a){var r=Number(n.id);t.apiSettingModel={id:r};t.apiSettingTempModel={};t.eweiHelpcenterApiUrl=e.eweiHelpcenterApiUrl;if(r>0){org.ewei.sdk.OpenChannelApi().getChannelApi({id:r}).then(function(e){if(e&&e.channel&&e.config&&e.app){t.apiSettingModel.config=e.config;t.apiSettingModel.name=e.channel.name;t.apiSettingTempModel.name=e.channel.name;t.apiSettingModel.appKey=e.app.appKey;t.apiSettingModel.appSecret=e.app.appSecret}})}t.updateAccessConfigSetting=function(){if(!t.apiSettingModel.name){i.add("渠道名称不能为空","danger");return false}if(a("specialChart")(t.apiSettingModel.name)){i.add("名称不支持除中划线，下划线以外的特殊字符","danger");return false}var e={name:t.apiSettingModel.name};if(r>0){e.id=r;org.ewei.sdk.OpenChannelApi().updateChannelApi(e).then(function(e){if(e){i.add("保存成功")}})}else{t.isDisable=true;org.ewei.sdk.OpenChannelApi().saveChannelApi(e).then(function(e){if(e){t.isDisable=false;i.add("保存成功");s.go("system_setting.detail",{uri:"channel_settings",settingType:"multi_channel"})}})}}}})();(function(e){"use strict";angular.module("eweiApp.system_setting").controller("systemChannelSdkController",t).controller("systemChannelSdkAccessConfigController",i).controller("systemChannelSdkAdvancedSettingController",n);t.$inject=["$scope","ConsoleConfig","$stateParams"];i.$inject=["$scope","ConsoleConfig","$stateParams","$state","alertService","$window"];n.$inject=["$scope","$stateParams","alertService","coreModelService","$state"];function t(e,t,i){e.sdkSettingModel={id:Number(i.id)};e.eweiHelpcenterApiUrl=t.eweiHelpcenterApiUrl}function i(t,i,e,n,s,a){var r=Number(e.id);t.sdkConfigModel={id:r,config:{}};if(r>0){org.ewei.sdk.OpenChannelApi().getChannelSdkConfig({id:r}).then(function(e){if(e&&e.channel&&e.config){t.sdkConfigModel.config=e.config;t.sdkConfigModel.name=e.channel.name;if(!t.$parent.sdkSettingModel.name){t.$parent.sdkSettingModel.name=e.channel.name}}})}else{org.ewei.sdk.OpenChannelApi().getAppIdAndAppSecret().then(function(e){if(e){t.sdkConfigModel.config.appKey=e.appKey;t.sdkConfigModel.config.appSecret=e.appSecret;t.sdkConfigModel.config.appId=e.id}})}t.updateAccessConfigSetting=function(){if(!t.sdkConfigModel.name){s.add("渠道名称不能为空","danger");return false}var e={name:t.sdkConfigModel.name,config:t.sdkConfigModel.config};if(r>0){e.id=r;org.ewei.sdk.OpenChannelApi().updateChannelSdk(e).then(function(e){if(e){s.add("保存成功")}})}else{t.isDisable=true;org.ewei.sdk.OpenChannelApi().saveChannelSdk(e).then(function(e){if(e){t.isDisable=false;s.add("保存成功");n.go("system_setting.detail",{uri:"channel_settings",settingType:"multi_channel"})}})}};t.downloadViaSDK=function(e){if(i.enviroment==="Production"){if(e==="api"){a.open("http://api.ewei.com")}else{a.open("http://helpdesk.ewei.com/find_latest_release_by_os?os="+e)}}else if(i.enviroment==="Test"){if(e==="api"){a.open("http://api.itkeeping.com")}else{a.open("http://helpdesk.itkeeping.com/find_latest_release_by_os?os="+e)}}}}function n(n,e,t,i,s){var a=Number(e.id);n.sdkAdvancedModel={id:a,config:{}};org.ewei.sdk.OpenChannelApi().getChannelSdkConfig({id:a}).then(function(i){if(i&&i.channel&&i.config){n.sdkAdvancedModel.config=i.config;if(!n.$parent.sdkSettingModel.name){n.$parent.sdkSettingModel.name=i.channel.name}org.ewei.sdk.OpenFormApi().listTicketForm().then(function(e){if(e){n.ticketFormList=e||[];for(var t=0;t<e.length;t++){if(e[t].uid===i.config.ticketFormUid){n.ticketForm=e[t];break}}}});n.chatFormUid=i.config.chatFormUid}});n.updateAdvancedSetting=function(){var e={id:a,config:{chatFormUid:n.chatFormUid,ticketFormUid:n.ticketForm.uid,userRequired:n.sdkAdvancedModel.config.userRequired}};org.ewei.sdk.OpenChannelApi().updateChannelSdk(e).then(function(e){if(e){t.add("更新成功")}})}}})();(function(){"use strict";angular.module("eweiApp.system_setting").controller("systemChannelCtiController",e).controller("systemChannelCtiConfigController",t);e.$inject=["$scope","ConsoleConfig","$stateParams"];t.$inject=["$scope","ConsoleConfig","$stateParams","alertService","$state","apiCtiViaListService","coreNotifyService"];function e(e,t,i){e.ctiSettingModel={id:Number(i.id)};e.eweiHelpcenterApiUrl=t.eweiHelpcenterApiUrl}function t(t,e,i,n,s,a,r){var o=Number(i.id);t.ctiConfigModel={id:o,config:{}};if(o>0){org.ewei.sdk.OpenChannelApi().getChannelPhone({id:o}).then(function(e){if(e&&e.channel&&e.config){e.config.saveRecord=e.config.saveRecord?"true":"false";t.ctiConfigModel.config=e.config;t.ctiConfigModel.name=e.channel.name;t.ctiConfigModel.verified=e.channel.verified;t.$parent.ctiSettingModel.name=e.channel.name}})}else{t.ctiConfigModel.config={type:"sip",saveRecord:"true",sipPort:"5060"}}function l(){if(!t.ctiConfigModel.name){n.add("渠道名称不能为空！","danger");return false}switch(t.ctiConfigModel.config.type){case"sip":if(!t.ctiConfigModel.config.sipAddress){n.add("请填写SIP线路地址！","danger");return false}if(!t.ctiConfigModel.config.sipPort){n.add("请填写SIP线路端口！","danger");return false}return true;case"callcenter":if(!t.ctiConfigModel.config.pstnNo){n.add("请填写外线号码！","danger");return false}if(!t.ctiConfigModel.config.url){n.add("请填写服务器URL！","danger");return false}return true;case"cloud_callcenter":if(!t.ctiConfigModel.config.pstnNo){n.add("请填写外线号码！","danger");return false}if(!t.ctiConfigModel.config.companyId){n.add("请填写企业ID！","danger");return false}if(!t.ctiConfigModel.config.companyNo){n.add("请填写企业编号！","danger");return false}return true;default:return true}}t.updateAccessConfigSetting=function(){if(!l())return;var e={name:t.ctiConfigModel.name,config:angular.copy(t.ctiConfigModel.config)};e.config.saveRecord=e.config.saveRecord==="true"?true:false;if(o>0){e.id=o;org.ewei.sdk.OpenChannelApi().updateChannelPhone(e).then({success:function(e){if(e){a.run(r.constant.EVENT_DETAIL_CTIS);n.add("保存成功")}}})}else{t.isDisable=true;org.ewei.sdk.OpenChannelApi().saveChannelPhone(e).then({success:function(e){if(e){t.isDisable=false;a.run(r.constant.EVENT_DETAIL_CTIS);n.add("保存成功");s.go("system_setting.detail",{uri:"channel_settings",settingType:"multi_channel"})}}})}}}})();(function(e){"use strict";angular.module("eweiApp.system_setting").controller("systemChannelWeixinController",t).controller("systemChannelWeixinConfigController",i).controller("systemChannelWeixinConfigPortController",n).controller("systemChannelWeixinAdvancedSettingController",s);t.$inject=["$scope","ConsoleConfig","$stateParams","$state","alertService"];i.$inject=["$scope","ConsoleConfig","alertService","$stateParams","$sce","$state"];n.$inject=["$scope","ConsoleConfig","$stateParams","alertService","$state"];s.$inject=["$scope","$stateParams","alertService"];function t(t,e,i,n,s){var a=Number(i.id);var r=i.type;t.weixinSettingModel={id:a};t.eweiHelpcenterApiUrl=e.eweiHelpcenterApiUrl;if(a>0){org.ewei.sdk.OpenChannelApi().getChannelWexinConfig({id:a}).then(function(e){if(e&&e.config&&e.channel){t.weixinSettingModel.name=e.channel.name;t.weixinSettingModel.uid=e.channel.uid;if(e.config.componentAppid){t.weixinSettingModel.navList=[{title:"接入配置",self:"system_setting.weixinChannel.accessConfig"}];if(e.channel.verified){t.weixinSettingModel.navList.push({title:"菜单配置",self:"system_setting.weixinChannel.menuSetting"},{title:"高级设置",self:"system_setting.weixinChannel.advancedSetting"})}if(!r){n.go("system_setting.weixinChannel.accessConfig",{id:a,type:"service"})}}else{t.weixinSettingModel.navList=[{title:"接入配置",self:"system_setting.weixinChannel.accessConfigPort"},{title:"菜单配置",self:"system_setting.weixinChannel.menuSetting"},{title:"高级设置",self:"system_setting.weixinChannel.advancedSetting"}];if(!r){n.go("system_setting.weixinChannel.accessConfigPort",{id:a,type:e.config.isQiye?"qiye":"service"})}}}})}else{if(r==="service"){t.weixinSettingModel.navList=[{title:"接入配置",self:"system_setting.weixinChannel.accessConfig"}]}else{t.weixinSettingModel.navList=[{title:"接入配置",self:"system_setting.weixinChannel.accessConfigPort"}]}}}function i(n,t,i,e,s,a){var r=[{id:1,name:"消息管理权限"},{id:2,name:"用户管理权限"},{id:3,name:"账号服务权限"},{id:4,name:"网页服务权限"},{id:6,name:"微信多客服权限"},{id:7,name:"群发与通知权限"},{id:9,name:"微信扫一扫权限"},{id:15,name:"自定义菜单权限"}];var o=null;var l="account."+t.domainRoot;var c=Number(e.id);n.checkedModel={id:c,verified:true};n.weixinConfig={authorityList:r};if(c>0){org.ewei.sdk.OpenChannelApi().getChannelWexinConfig({id:c}).then(function(e){if(e&&e.config&&e.channel){void 0;n.weixinConfig.name=e.channel.name;n.checkedModel.verified=e.channel.verified;n.weixinConfig.id=e.channel.id;if(e.config.funcInfo){o=JSON.parse(e.config.funcInfo);angular.forEach(o,function(e){for(var t=0;t<n.weixinConfig.authorityList.length;t++){var i=n.weixinConfig.authorityList[t];if(e.funcscope_category&&e.funcscope_category.id===i.id){i.isAuthority=true;break}}})}}})}n.goAuthorityPage=function(){org.ewei.sdk.OpenChannelApi().getComponentAppIdAndPreAuthcode().then({success:function(e){if(e){n.checkedModel.authorityPageUrl=s.trustAsResourceUrl(location.protocol+"//"+l+"/weixin.html?redirectUrl="+encodeURIComponent("https://mp.weixin.qq.com/cgi-bin/componentloginpage?component_appid="+e.componentAppid+"&pre_auth_code="+e.preAuthcode+"&redirect_uri="+location.protocol+"//"+l+"/via_weixin_auth_callback/"+t.provider.id+"/"+n.weixinConfig.id))}}})};n.updateAccessConfigSetting=function(){if(!n.weixinConfig.name){i.add("渠道名称不能为空！","danger");return false}var e={name:n.weixinConfig.name};if(c>0){e.id=c;org.ewei.sdk.OpenChannelApi().updateChannelPublicWeixin(e).then({success:function(e){if(e){void 0;i.add("更新成功")}}})}else{org.ewei.sdk.OpenChannelApi().saveChannelPublicWeixin(e).then({success:function(e){if(e){void 0;n.weixinConfig.id=e;n.goAuthorityPage()}}})}};n.$on("weixin_auth_callback",function(e,t){if(t.result=="via_weixin_exist"){i.add("公众号对应的渠道已经存在","danger");n.goAuthorityPage()}else if(t.result=="verify_type_info_error"){i.add("公众号未认证","danger");n.goAuthorityPage()}else{a.go("system_setting.weixinChannel",{id:t.viaWeixinId,type:""})}})}function n(i,t,e,n,s){var a=Number(e.id);var r=e.type;i.checkedModel={id:a,type:r,verified:true};if(r==="service"){i.isDisable=true}i.weixinPort={config:{}};i.testDomain=window.location.host;if(a>0){org.ewei.sdk.OpenChannelApi().getChannelWexinConfig({id:a}).then(function(e){if(e&&e.config&&e.channel){i.weixinPort.id=e.channel.id;i.weixinPort.name=e.channel.name;i.weixinPort.config=e.config;i.checkedModel.verified=e.channel.verified;i.serviceUrl=window.location.origin+"/api/weixin_"+(r==="qiye"?"qiye_":"")+e.channel.uid+".json"}})}else{org.ewei.sdk.OpenChannelApi().getInfoBeforeSaveChannelQiYeWeixin().then(function(e){if(e&&e.channel&&e.config){i.weixinPort.id=e.channel.id;i.weixinPort.config.apiToken=e.config.apiToken;i.weixinPort.config.encodingAesKey=e.config.encodingAesKey;i.serviceUrl=window.location.origin+"/api/weixin_"+(r==="qiye"?"qiye_":"")+e.channel.uid+".json"}})}i.goAuthorityPage=function(){org.ewei.sdk.OpenChannelApi().getComponentAppIdAndPreAuthcode().then({success:function(e){if(e){i.checkedModel.authorityPageUrl=$sce.trustAsResourceUrl(location.protocol+"//"+hostname+"/weixin.html?redirectUrl="+encodeURIComponent("https://mp.weixin.qq.com/cgi-bin/componentloginpage?component_appid="+e.componentAppid+"&pre_auth_code="+e.preAuthcode+"&redirect_uri="+location.protocol+"//"+hostname+"/via_weixin_auth_callback/"+t.provider.id+"/"+i.weixinPort.id))}}})};i.updateAccessConfigSetting=function(){if(r==="service"){n.add("旧的微信服务号不能更新","danger");return false}if(!i.weixinPort.name||!i.weixinPort.config.appId||!i.weixinPort.config.agentId||!i.weixinPort.config.appSecret){n.add("渠道名称、企业ID、应用AgentId、应用Secret不能为空","danger");return false}var t={};if(a>0){t={id:i.weixinPort.id,name:i.weixinPort.name,config:{appId:i.weixinPort.config.appId,appSecret:i.weixinPort.config.appSecret}};if(r==="qiye"){t.config.agentId=i.weixinPort.config.agentId}}else{t=angular.copy(i.weixinPort)}org.ewei.sdk.OpenChannelApi().updateChannelQiYeWeixin(t).then(function(e){if(e){if(a>0){n.add("更新成功");return false}n.add("添加成功");s.go("system_setting.weixinChannel",{id:t.id,type:""})}},function(e){if(e&&e.error_description){if(e.error_description==="app_secret_valid_error"){n.add("应用Secret校验失败！","danger")}else{n.add(e.error_description,"danger")}}else{n.add("保存失败！请重试","danger")}})};i.$on("weixin_auth_callback",function(e,t){if(t.result=="via_weixin_exist"){n.add("公众号对应的渠道已经存在","danger");i.goAuthorityPage()}else if(t.result=="verify_type_info_error"){n.add("公众号未认证","danger");i.goAuthorityPage()}else{s.go("system_setting.weixinChannel",{id:t.viaWeixinId,type:""})}})}function s(n,e,t){var i=Number(e.id);n.weixinAdvancedConfig={};org.ewei.sdk.OpenChannelApi().getChannelWexinConfig({id:i}).then(function(i){if(i&&i.config&&i.channel){org.ewei.sdk.OpenFormApi().listTicketForm().then(function(e){if(e){n.ticketFormList=e||[];n.weixinAdvancedConfig.attentionWelcomes=i.config.attentionWelcomes;for(var t=0;t<e.length;t++){if(e[t].uid===i.config.ticketFormUid){n.ticketForm=e[t];break}}}})}});n.updateAdvancedSetting=function(){var e={id:i,config:{attentionWelcomes:n.weixinAdvancedConfig.attentionWelcomes,ticketFormUid:n.ticketForm.uid}};org.ewei.sdk.OpenChannelConfigApi().updateChannelWexinConfig(e).then(function(e){if(e){t.add("更新成功")}})}}})();(function(){"use strict";angular.module("eweiApp.system_setting").controller("systemChannelWeixinMenuSettingController",e).directive("wxFileUpload",t);t.$inject=["alertService","ConsoleConfig","commonProtocol"];e.$inject=["$q","$scope","$rootScope","$modal_","$stateParams","$http","alertService","$filter","ConsoleConfig","serviceDeskService","getWeixinCommonInf"];function e(r,o,e,l,a,t,c,i,u,n,s){o.verified=true;o.type=a.type;var d=Number(a.id);var p=null;var f=o.$watch("weixinSettingModel",function(){if(o.$parent.weixinSettingModel.uid){p=o.$parent.weixinSettingModel.uid;f()}},true);if(a.version=="old"){s.getWeinInf().then(function(e){o.verified=e.appVerified;o.isQiye=e.isQiye})}function m(e){var t=u.providerHelpCenterUrl;if(e.indexOf(t+"/memu_weixin_mp_login")>-1){if(e.indexOf("_helpcenter")>-1){return"ch"}if(e.indexOf("_submitticket")>-1){return"submit_ticket"}if(e.indexOf("_queryticket")>-1){return"st"}if(e.indexOf("_forum")>-1){return"forum"}if(e.indexOf("_resource")>-1){return"download"}return""}if(e.indexOf(t+"/weixin_mp_login")>-1){return"console"}return"url"}org.ewei.sdk.OpenChannelConfigApi().getChannelWexinMenu({id:d}).then(function(e){if(e){e=angular.fromJson(e);if(e.menu&&e.menu.button){angular.forEach(e.menu.button,function(t){if(t.sub_button&&t.sub_button.length>0){t.sub_button.push({name:t.name,key:""})}else{var i={};Object.keys(t).forEach(function(e){if(e!=="sub_button"){i[e]=t[e];if(e!=="name"){delete t[e]}}});t.sub_button.push(i)}angular.forEach(t.sub_button,function(e,t){if(e.key&&e.key.indexOf("reply_")>-1){if(e.url){e.key=m(e.url)}else if(e.replyNewsMessageJson){e.key="image"}else if(e.replyText||e.replyText===""){e.replyText=e.replyText.replace(/\n/g,"<br/>");e.key="reply"}}if(e.type==="view"&&e.url){e.key=m(e.url);void 0}if(e.type==="miniprogram"){if(e.appid===o.eweiMiniProgram.appid){e.key="em"}else{e.key="cm"}}if(e.key==="wc_human"){e.key="wc";e.autoStart=true}})});for(var t=0;t<3;t++){if(!e.menu.button[t]){e.menu.button[t]={}}}o.buttonMenus=e.menu.button;void 0;o.buttonMenusDefault=angular.copy(o.buttonMenus)}else{o.buttonMenus=[{},{},{}]}}else{o.buttonMenus=[{},{},{}]}},function(e){if(e&&e.error=="business_error"){c.add("微信菜单获取失败，请检查应用AgentId及应用Secret是否配置正确。","danger")}o.buttonMenus=[{},{},{}]});org.ewei.sdk.OpenChannelApi().getEweiSmallAppAppId().then(function(e){o.eweiMiniProgram={appid:e,pagepath:"pages/index/index?from=share&providerName="+u.provider.subDomain+"."+u.domainRoot+"&provider_id="+u.provider.id,URL:u.providerHelpCenterUrl}});o.delNavList=function(e,t,i,n){if(n=="btn"){o.isLoading=false;o._messages="您确定要清空数据吗？";var s=l({scope:o,title:"删除确认",contentTemplate:"source/views/alter_common.html",html:true,show:true,placement:"center"});o.$hide=function(){s.$promise.then(s.hide)};o.$ok=function(){o.$hide();i[i.indexOf(t)]={}}}else{i.splice(i.indexOf(t),1);if(i.length==0){angular.forEach(o.buttonMenus,function(e,t){if(e.sub_button==i){delete o.buttonMenus[t].sub_button;o.buttonMenus[t].type="click";o.buttonMenus[t].key="reply_"+t}})}}e.stopPropagation()};o.checkForm=function(){var e=o.navType;var t=/^[ ]*$/;switch(e.key){case"cm":if(!e.appid||t.test(e.appid)){c.add("appid不能为空！","danger");return false}if(!e.pagepath||t.test(e.pagepath)){c.add("路径不能为空！","danger");return false}if(!e.URL||t.test(e.URL)){c.add("备用网页不能为空！","danger");return false}break;default:}return true};o.clearMainMenu=function(e){var t=r.defer();if(!e.sub_button){t.resolve()}else{var i=e.sub_button[e.sub_button.length-1];var n=!!i.type;var s=e.sub_button.length>0;if(s&&n){o._messages="添加子菜单后，一级菜单的菜单类型将被清除。确认添加子菜单？";var a=l({scope:o,title:"温馨提示",contentTemplate:"source/views/alter_common.html",html:true,show:true,placement:"center"});o.$hide=function(){a.$promise.then(a.hide);t.reject()};o.$ok=function(){a.$promise.then(a.hide);e.sub_button[e.sub_button.length-1]={name:i.name};t.resolve()}}else{t.resolve()}}return t.promise};o.addNav=function(t,e){_hmt.push(["_trackEvent","微信客服","微信客服-微信菜单-添加微信菜单"]);o.navType={};if(a.version=="new"&&a.verified=="verified"){o.navType.newAndVerified=true;o.navType.isSetCallbackUrl=true}else{o.navType.newAndVerified=false}o.textImg={articles:[{title:"",description:"",url:"",picUrl:""}]};o.isSaveing=false;o.showMenu=true;var i=null;o.clearMainMenu(t).then(function(){i=l({scope:o,contentTemplate:"source/views/ticket/setting.wechat_modal_save.html",title:"增加菜单",html:true,show:true,placement:"center"})},function(){return});o.hideNavModal=function(){i.$promise.then(i.hide)};o.save=function(){if(!o.navType.name){c.add("菜单名不能为空！","danger");return}if(!(t.sub_button&&t.sub_button.length>0)&&o.navType.name.replace(/[^\x00-\xff]/g,"**").length>16){c.add("菜单标题不超过16个字节！","danger");return}if(t.sub_button&&t.sub_button.length>0&&o.navType.name.replace(/[^\x00-\xff]/g,"**").length>40){c.add("子菜单标题不超过40个字节！","danger");return}if(!o.checkForm()){return}o.isSaveing=true;var e={name:o.navType.name};if(o.navType.type){if(o.type==="service"){o.navType.isSetCallbackUrl=true}e.type=o.navType.type.type;e.key=o.navType.type.key;if(o.navType.key==="wc"){e.autoStart=o.navType.type.autoStart}if(o.navType.type.key=="reply"){e.replyText=o.navType.text}if(o.navType.type.key=="url"){e.url=o.navType.URL}if(o.navType.type.key=="image"){e.replyNewsMessageJson=JSON.stringify(o.textImg)}if(o.navType.type.key=="ch"){e.url=u.providerHelpCenterUrl;if(o.navType.isSetCallbackUrl){e.url=u.providerHelpCenterUrl+"/memu_weixin_mp_login_"+p+"_helpcenter"}}if(o.navType.type.key=="forum"){if(o.navType.isSetCallbackUrl){e.url=u.providerHelpCenterUrl+"/memu_weixin_mp_login_"+p+"_forum"}}if(o.navType.type.key=="submit_ticket"){if(o.navType.isSetCallbackUrl){e.type="view";e.url=u.providerHelpCenterUrl+"/memu_weixin_mp_login_"+p+"_submitticket";e.url=e.url+o.navType.formId}else{e.formId=o.navType.formId}}if(o.navType.type.key=="st"){if(o.navType.isSetCallbackUrl){e.type="view";e.url=u.providerHelpCenterUrl+"/memu_weixin_mp_login_"+p+"_queryticket"}}if(o.navType.type.key=="console"){e.url=u.providerHelpCenterUrl+"/weixin_mp_login_"+p}if(o.navType.type.key=="download"){if(o.navType.isSetCallbackUrl){e.url=u.providerHelpCenterUrl+"/memu_weixin_mp_login_"+p+"_resource"}}if(o.navType.type.key==="cm"||o.navType.type.key==="em"){e.url=o.navType.URL;e.appid=o.navType.appid;e.pagepath=o.navType.pagepath}}if(!t.sub_button){t.sub_button=[e]}else{t.sub_button.unshift(e)}o.hideNavModal()}};o.changeNavType=function(){o.navType.key=o.navType.type.key;if(o.navType&&o.navType.type){if(o.navType.type.key=="submit_ticket"){o.navType.formId="";g()}if(o.navType.type.key==="em"){o.navType.URL=o.eweiMiniProgram.URL;o.navType.appid=o.eweiMiniProgram.appid;o.navType.pagepath=o.eweiMiniProgram.pagepath}}};o.editNavList=function(t,e,i){o.navType=JSON.parse(JSON.stringify(t));o.navType.type={};if(a.version=="new"&&a.verified=="verified"){o.navType.newAndVerified=true;o.navType.isSetCallbackUrl=true}else{o.navType.newAndVerified=false}if(!o.textImg){o.textImg={articles:[{title:"",description:"",url:"",picUrl:""}]}}o.navType.type.key=t.key;angular.forEach(o.navTypeValues,function(e){if(e.key==t.key){o.navType.type=e}});if(t.key==="wc"){o.navType.type.autoStart=t.autoStart}if(t.replyNewsMessageJson){o.navType.type.replyNewsMessageJson=t.replyNewsMessageJson}if(t.replyText){o.navType.text=t.replyText}if(t.url){o.navType.URL=t.url;if(t.type==="view"){o.navType.isSetCallbackUrl=true}else{o.navType.isSetCallbackUrl=false}}if(t.replyNewsMessageJson){o.textImg=JSON.parse(t.replyNewsMessageJson)}o.isSaveing=false;o.showMenu=i<e.length-1&&e.length>1||e.length===1;var n=l({scope:o,contentTemplate:"source/views/ticket/setting.wechat_modal_save.html",title:"编辑菜单",html:true,show:true,placement:"center"});o.hideNavModal=function(){n.$promise.then(n.hide)};if(t.key=="submit_ticket"){if(t.type=="click"){if(angular.isUndefined(t.formId)){o.navType.formId=""}else{o.navType.formId=t.formId}}else{if(t.url){var s=t.url.split("submitticket");if(s[1]==""){o.navType.formId=""}else{o.navType.formId=s[1]}}}g()}o.save=function(){if(!o.navType.name){c.add("菜单名不能为空！","danger");return}if(!o.checkForm()){return}o.isSaveing=true;t.name=o.navType.name;t.type=o.navType.type.type;t.key=o.navType.type.key;t.autoStart=o.navType.type.autoStart;if(o.navType.type){if(o.type==="service"){o.navType.isSetCallbackUrl=true}if(o.navType.type.key=="reply"){t.replyText=o.navType.text;delete t.replyNewsMessageJson}if(o.navType.type.key=="url"){t.url=o.navType.URL}if(o.navType.type.key=="image"){t.replyNewsMessageJson=JSON.stringify(o.textImg);delete t.replyText}if(o.navType.type.key=="ch"){t.url=u.providerHelpCenterUrl;if(o.navType.isSetCallbackUrl){t.url=u.providerHelpCenterUrl+"/memu_weixin_mp_login_"+p+"_helpcenter"}}if(o.navType.type.key=="submit_ticket"){if(o.navType.isSetCallbackUrl){t.type="view";t.url=u.providerHelpCenterUrl+"/memu_weixin_mp_login_"+p+"_submitticket";if(t.url){var e=t.url.substring(0,t.url.indexOf("submitticket")+12);t.url=e+o.navType.formId;delete t.formId}}else{t.formId=o.navType.formId;if(t.url){var e=t.url.substring(0,t.url.indexOf("submitticket")+12);t.url=e}}}if(o.navType.type.key=="st"){if(o.navType.isSetCallbackUrl){t.type="view";t.url=u.providerHelpCenterUrl+"/memu_weixin_mp_login_"+p+"_queryticket"}}if(o.navType.type.key=="forum"){t.type="view";t.url=u.providerHelpCenterUrl+"/memu_weixin_mp_login_"+p+"_forum"}if(o.navType.type.key=="console"){t.url=u.providerHelpCenterUrl+"/weixin_mp_login_"+p}if(o.navType.type.key=="download"){t.url=u.providerHelpCenterUrl+"/memu_weixin_mp_login_"+p+"_resource"}if(o.navType.type.key==="cm"||o.navType.type.key==="em"){t.url=o.navType.URL;t.appid=o.navType.appid;t.pagepath=o.navType.pagepath}}o.hideNavModal()}};function g(){o.webFormList=[];org.ewei.sdk.OpenFormApi().listTicketForm().then(function(e){if(e){o.webFormList=e}})}var v=u.providerHelpCenterUrl||"";if(v.indexOf("http://")!=-1){v=v.substring(7)}else if(v.indexOf("https://")!=-1){v=v.substring(8)}o.providerDomain=v;o.navTypeValues=[{name:"请选择--",type:"click",key:""},{name:"请求在线客服",type:"click",key:"wc"},{name:"提交工单",type:"click",key:"submit_ticket"},{name:"查询工单",type:"click",key:"st"},{name:"下载资源",type:"view",key:"download"},{name:"打开帮助中心网页",type:"view",key:"ch"},{name:"论坛帖子",type:"view",key:"forum"},{name:"打开自定义网页",type:"view",key:"url"},{name:"回复文字消息",type:"click",key:"reply"},{name:"回复图文消息",type:"click",key:"image"},{name:"绑定账号",type:"click",key:"bind"}];if(o.type==="service"){o.navTypeValues.splice(7,0,{name:"跳转小程序【帮助台】",type:"miniprogram",key:"em"});o.navTypeValues.splice(8,0,{name:"跳转自定义小程序",type:"miniprogram",key:"cm"})}o.defaultMenu=function(){o.buttonMenus=angular.copy(o.buttonMenusDefault)};o.addImgInf=function(){var e=o.textImg.articles.length-1;if(o.textImg.articles[e].description||o.textImg.articles[e].picUrl||o.textImg.articles[e].title||o.textImg.articles[e].url){if(o.textImg.articles.length>9){c.add("超过上限，不能再进行添加","danger");return false}o.textImg.articles.push({title:"",description:"",url:"",picUrl:""})}else{c.add("信息填写不完整，不能再进行添加","danger")}};o.delImgInf=function(e){if(o.textImg.articles.length<=1){return false}o.textImg.articles.splice(e,1)};o.update=function(){var i=angular.copy(o.buttonMenus);for(var n=0;n<i.length;n++){if(!i[n].sub_button||i[n].sub_button.length==0){i.splice(n,1);n--;continue}angular.forEach(i[n].sub_button,function(t,e){if(!t.key||t.key==""){t.key="reply_"+(n+1)+(e+1);t.type="click"}if(t.key=="url"){if(t.url){if(t.url.toLowerCase().indexOf("http://")!=0&&t.url.toLowerCase().indexOf("https://")!=0){t.url="http://"+t.url}}else{t.url="http://"}}if(t.key=="ch"||t.key=="url"||t.key=="image"||t.key=="reply"){t.key="reply_"+(n+1)+(e+1)}if(t.replyText){t.replyText=h(t.replyText,true)}if(t.type=="view"){delete t.key}if(t.key==="wc"){if(t.autoStart){t.key="wc_human"}}if(t.hasOwnProperty("autoStart")){delete t.autoStart}if(e==i[n].sub_button.length-1){Object.keys(t).forEach(function(e){if(i[n].sub_button.length>1){i[n].name=t.name}else{i[n][e]=t[e]}});i[n].sub_button.splice(e,1)}})}var e={id:d,menu:angular.toJson({button:i})};org.ewei.sdk.OpenChannelConfigApi().updateChannelWexinMenu(e).then(function(e){var t=JSON.parse(e);if(t.errcode!==0){c.add("更新失败","danger")}else{c.add("更新成功")}})};o.sortableOptions={placeholder:"app",connectWith:".apps-container",update:function(e,t){if(e.target.id!=="list1"&&t.item.sortable.droptarget.attr("id")==="list1"){t.item.sortable.cancel()}if(e.target.id!=="list2"&&t.item.sortable.droptarget.attr("id")==="list2"){t.item.sortable.cancel()}if(e.target.id!=="list3"&&t.item.sortable.droptarget.attr("id")==="list3"){t.item.sortable.cancel()}},stop:function(e,t){},items:"li:not(.not-sortable)"}}function h(e,t){var i="";if(t){var n=document.createElement("div");n.innerHTML=e;var s=n.getElementsByTagName("a");for(var a=0;a<s.length;a++){s[a].removeAttribute("target");s[a].removeAttribute("title")}i=n.innerHTML.replace(/\"/g,"'").replace(/<br\s*\/?>/g,"\n").replace(/<p\s*\/?>/g,"").replace(/<\/p\s*\/?>/g,"\n").replace(/<div\s*\/?>/g,"").replace(/<\/div\s*\/?>/g,"\n").replace(/&nbsp;/g," ")}else{i=e.replace(/\"/g,"'").replace(/<br\s*\/?>/g,"\n")}return i}function t(p,e,f){return{restrict:"EA",link:function(n,e,t,i){var s=document.getElementById("showUploading");var a=s.getElementsByTagName("span")[0];var r=s.getElementsByTagName("span")[1];var o=s.getElementsByTagName("span")[2];var l=e[0].id?e[0].id:Date.now();e[0].id=l;var c=t.index;var u;var d=WebUploader.create({swf:"/source/lib/ueditor/third-party/webuploader/Uploader.swf",server:f.fn(),pick:"#"+l,resize:false,duplicate:true,formData:{}});d.on("uploadStart",function(e){if(u){d.option("formData",{key:eweiCommon.uuid(32,16).toLowerCase(),token:u})}else{$.ajax({url:"/qiniu_token.json",type:"GET",async:false,success:function(e){u=e;d.option("formData",{key:eweiCommon.uuid(32,16).toLowerCase(),token:u})},error:function(){if(console){void 0}}})}});d.on("fileQueued",function(e){void 0;if(e.type.indexOf("image")==-1){p.add("请选择上传图片","danger")}else{s.style.display="block";a.innerHTML="0%";r.style.width=0;o.innerHTML="正在上传请稍后...";d.upload()}});d.on("uploadProgress",function(e,t){a.innerHTML=parseInt(t*100)+"%";r.style.width=parseInt(t*100)+"%"});d.on("uploadSuccess",function(e,t){var i=t.key||"";n.textImg.articles[c].picUrl=window.location.origin+"/no_auth_ewei_attachment?contentUrl="+i;o.innerHTML="上传成功";setTimeout(function(){s.style.display="none"},1e3);n.$apply()});d.on("error",function(e){o.innerHTML="上传失败"})}}}})();(function(e){"use strict";angular.module("eweiApp.system_setting").controller("systemChannelDingdingSettingCtrl",t).controller("systemChannelDingdingAccessConfigController",i).controller("systemChannelDingdingAdvancedSettingController",n);t.$inject=["$scope","ConsoleConfig","$stateParams"];i.$inject=["$scope","ConsoleConfig","alertService","$stateParams","$upload","$state","$timeout"];n.$inject=["$scope","$stateParams","alertService"];function t(e,t,i){e.dingdingSettingModel={id:Number(i.id)};e.eweiHelpcenterApiUrl=t.eweiHelpcenterApiUrl}function i(i,e,n,t,s,a,r){var o=Number(t.id);var l=eweiCommon.uuid(32).toLowerCase();i.dingdingConfigModel={id:o,config:{homePageUrl:window.location.origin+"/dingdingHome.json?apiToken="+l,apiToken:l,channelUid:l}};org.ewei.sdk.OpenChannelApi().getServerIps({}).then(function(e){i.serverIps=e});if(o>0){org.ewei.sdk.OpenChannelApi().getChannelDingding({id:o}).then(function(e){if(e&&e.channel&&e.config){i.dingdingConfigModel.config=e.config;i.dingdingConfigModel.name=e.channel.name;if(!i.$parent.dingdingSettingModel.name){i.$parent.dingdingSettingModel.name=e.channel.name}}})}i.uploadFile=function(e){if(e.length){var t=e[0];if(t.size>102400){n.add("上传单个附件大小不能超过100kb","danger")}else{t.upload=s.upload({url:"upload",method:"POST",file:t});t.upload.then(function(e){r(function(){if(e&&e.data){i.dingdingConfigModel.config.iconUrl=e.data.contentUrl}})})}}};i.updateAccessConfigSetting=function(){if(!i.dingdingConfigModel.name){n.add("渠道名称不能为空","danger");return false}else if(!i.dingdingConfigModel.config.corpId){n.add("CorpId不能为空","danger");return false}else if(!i.dingdingConfigModel.config.agentId){n.add("Agent ID不能为空","danger");return false}else if(!i.dingdingConfigModel.config.appId){n.add("App Key不能为空","danger");return false}else if(!i.dingdingConfigModel.config.appSecret){n.add("App Secret不能为空","danger");return false}i.isDisable=true;var e={name:i.dingdingConfigModel.name,config:i.dingdingConfigModel.config};org.ewei.sdk.OpenChannelApi().saveChannelDingding(e).then(function(e){i.isDisable=false;if(e){n.add("保存成功");a.go("system_setting.detail",{uri:"channel_settings",settingType:"multi_channel"})}},function(e){i.isDisable=false;if(e&&e.error_description){n.add(e.error_description,"danger")}})}}function n(r,e,i){var o=Number(e.id);r.dingdingAdvancedModel={id:o,config:{}};r.config={homeChecked:0};org.ewei.sdk.OpenChannelApi().getChannelDingding({id:o}).then(function(i){if(i&&i.channel&&i.config){i.config.modules=i.config.modules?JSON.parse(i.config.modules):[];angular.forEach(i.config.modules,function(e,t,i){if(e.home){r.config.homeChecked=t}if(!e.funcName){e.funcName=e.func}});r.dingdingAdvancedModel.config=i.config;r.dingdingAdvancedModel.name=i.channel.name;r.dingdingAdvancedModel.autoSearch=i.config.autoSearch;if(!r.$parent.dingdingSettingModel.name){r.$parent.dingdingSettingModel.name=i.channel.name}org.ewei.sdk.OpenFormApi().listTicketForm().then(function(e){if(e){r.ticketFormList=e||[];for(var t=0;t<e.length;t++){if(e[t].uid===i.config.ticketFormUid){r.ticketForm=e[t];break}}}})}});r.updateAdvancedSetting=function(){var e=angular.copy(r.dingdingAdvancedModel.config);var n=0;var s=null;var a=false;angular.forEach(e.modules,function(e,t,i){if(e.opened){n++}if(t==r.config.homeChecked){e.home=true;if(!e.opened){s=e}}else{e.home=false}if(!e.funcName){a=true}});if(n==0){i.add("功能配置至少需要开启一项","danger");return}if(s!=null){i.add(s.func+"没有开启,不能作为首页","danger");return}if(a){i.add("自定义菜单名称不能为空","danger");return}var t={id:o,config:{ticketFormUid:r.ticketForm.uid,modules:JSON.stringify(e.modules),autoSearch:r.dingdingAdvancedModel.autoSearch}};org.ewei.sdk.OpenChannelConfigApi().updateChannelDingdingConfig(t).then(function(e){if(e){i.add("更新成功")}else{i.add("更新失败","danger")}})}}})();(function(){"use strict";angular.module("eweiApp.system_setting").controller("systemChannelDingdingMenuSettingController",e).directive("wxFileUpload",t);e.$inject=["$scope","$rootScope","$modal_","$stateParams","$http","alertService","$filter","ConsoleConfig","serviceDeskService","getdingdingCommonInf"];t.$inject=["alertService","ConsoleConfig","commonProtocol"];function e(a,e,i,t,n,r,s,o,l,c){var u=o.provider.id,d=getCookie("user_token");var p=Number(t.id);a.dingdingMenuSettingModel={id:p,config:{}};var f=[{sub_button:[{formId:120,isSetCallbackUrl:true,name:"657567",type:{id:9,name:"提交工单",type:"submit_ticket"}},{formId:157,isSetCallbackUrl:true,name:"个梵蒂冈",type:{id:9,name:"提交工单",type:"submit_ticket"}},{isSetCallbackUrl:true,name:"股份的股份的",type:{id:3,name:"帮助文档",type:"ch"}}]},{sub_button:[{formId:157,isSetCallbackUrl:true,name:"7657567",type:{id:9,name:"提交工单",type:"submit_ticket"}},{isSetCallbackUrl:true,name:"资源",type:{id:10,name:"下载资源",type:"download"}},{isSetCallbackUrl:true,name:"gfdgfd",type:{id:4,name:"服务记录",type:"st"}},{isSetCallbackUrl:true,name:"和规范化",type:{id:9,name:"提交工单",type:"submit_ticket"}}]},{sub_button:[{name:"论坛帖子",type:{id:11,name:"论坛帖子",type:"forum"}},{formId:"",isSetCallbackUrl:true,name:"434",type:{id:9,name:"提交工单",type:"submit_ticket"}},{isSetCallbackUrl:true,name:"回复",type:{id:9,name:"提交工单",type:"submit_ticket"}},{isSetCallbackUrl:true,name:"回复插入",type:{id:3,name:"帮助文档",type:"ch"}}]}];org.ewei.sdk.OpenChannelApi().getChannelDingding({id:p}).then(function(e){if(e&&e.channel&&e.config){a.dingdingMenuSettingModel.config=e.config;a.dingdingMenuSettingModel.name=e.channel.name;if(!a.$parent.dingdingSettingModel.name){a.$parent.dingdingSettingModel.name=e.channel.name}if(e.config.menu){var t=JSON.parse(e.config.menu);var i=[];for(var n=0;n<t.length;n++){if(t[n].sub_button){i[n]=t[n].sub_button}else{i[n]=[]}a.wxListData[n]=i[n]}}g()}});a.verified=true;var m=o.providerHelpCenterUrl||"";if(m.indexOf("http://")!=-1){m=m.substring(7)}else if(m.indexOf("https://")!=-1){m=m.substring(8)}a.providerDomain=m;a.navTypeValues=[{id:1,name:"请选择--"},{id:9,name:"提交工单",type:"submit_ticket"},{id:3,name:"帮助文档",type:"ch"},{id:11,name:"论坛帖子",type:"forum"},{id:4,name:"服务记录",type:"st"},{id:6,name:"打开自定义网页",type:"url"},{id:10,name:"下载资源",type:"download"}];a.wxListData=[[],[],[]];a.defaultMenu=function(){a.wxListData=[[],[],[]]};a.visible1=true;a.visible2=true;a.visible3=true;a.sortableOptions={placeholder:"app",connectWith:".apps-container",update:function(e,t){if(e.target.id!=="list1"&&t.item.sortable.droptarget.attr("id")==="list1"&&a.list1.length>5){t.item.sortable.cancel()}if(e.target.id!=="list2"&&t.item.sortable.droptarget.attr("id")==="list2"&&a.list2.length>5){t.item.sortable.cancel()}if(e.target.id!=="list3"&&t.item.sortable.droptarget.attr("id")==="list3"&&a.list3.length>5){t.item.sortable.cancel()}g()},stop:function(e,t){if(e.target.id!=="list1"&&t.item.sortable.droptarget.attr("id")=="list1"&&a.list1.length==2){a.list1.unshift(a.list1.pop())}if(e.target.id!=="list2"&&t.item.sortable.droptarget.attr("id")=="list2"&&a.list2.length==2){a.list2.unshift(a.list2.pop())}if(e.target.id!=="list3"&&t.item.sortable.droptarget.attr("id")=="list3"&&a.list3.length==2){a.list3.unshift(a.list3.pop())}},items:"li:not(.not-sortable)"};function g(){if(a.wxListData[0].length>5){a.visible1=false}else{a.visible1=true}if(a.wxListData[1].length>5){a.visible2=false}else{a.visible2=true}if(a.wxListData[2].length>5){a.visible3=false}else{a.visible3=true}}a.navType={};a.textImg={articles:[{title:"",description:"",url:"",picUrl:""}]};a.addNav=function(e){_hmt.push(["_trackEvent","微信客服","微信客服-微信菜单-添加或编辑微信菜单"]);a.navType={isSetCallbackUrl:true};a.textImg={articles:[{}]};a.edit=false;a.navType.type=a.navTypeValues[0];a.editTemp.num=e;a.showEditMenu(a.navType.type);var t=i({scope:a,template:"modal/modal.tpl.w630.html",contentTemplate:"source/views/ticket/setting.wechat_efit.html",title:"编辑菜单",html:true,show:true,placement:"center"});a.hideNavModal=function(){t.$promise.then(t.hide)};if(a.navType.type=="submit_ticket"){a.navType.formId="";h()}};a.dingdingMenue=true;a.showEditMenu=function(e){if(e){if(e.type=="reply"){a.showMenu1=true;a.showMenu2=false;a.showMenu3=true;a.showMenu4=false}else if(e.type=="url"){a.showMenu1=false;a.showMenu2=true;a.showMenu3=true;a.showMenu4=false}else if(e.type=="image"){a.showMenu1=false;a.showMenu2=false;a.showMenu3=true;a.showMenu4=true}else{a.showMenu1=false;a.showMenu2=false;a.showMenu3=true;a.showMenu4=false}if(e.type=="ch"||e.type=="st"||e.type=="submit_ticket"||e.type=="download"){a.showMenu5=true}else{a.showMenu5=false}if(e.type=="submit_ticket"&&angular.isUndefined(a.navType.formId)){a.navType.formId="";h()}}};function v(e,t){var i="";if(t){var n=document.createElement("div");n.innerHTML=e;var s=n.getElementsByTagName("a");for(var a=0;a<s.length;a++){s[a].removeAttribute("target");s[a].removeAttribute("title")}i=n.innerHTML.replace(/\"/g,"'").replace(/<br\s*\/?>/g,"\\n").replace(/<p\s*\/?>/g,"").replace(/<\/p\s*\/?>/g,"\\n").replace(/<div\s*\/?>/g,"").replace(/<\/div\s*\/?>/g,"\\n")}else{i=e.replace(/\"/g,"'").replace(/<br\s*\/?>/g,"\\n")}return i}function h(){a.webFormList=[];org.ewei.sdk.OpenFormApi().listTicketForm().then(function(e){if(e){a.webFormList=e}})}a.save=function(){void 0;_hmt.push(["_trackEvent","钉钉客户端","钉钉客户端-钉钉菜单-添加或编辑钉钉菜单-保存"]);if(a.edit){a.wxListData[a.editTemp.num][a.editTemp.index]={name:a.navType.name};if(a.navType.type){if(a.navType.type.type=="reply"){a.wxListData[a.editTemp.num][a.editTemp.index].text=a.navType.text}else if(a.navType.type.type=="url"){a.wxListData[a.editTemp.num][a.editTemp.index].URL=a.navType.URL}else if(a.navType.type.type=="image"){a.wxListData[a.editTemp.num][a.editTemp.index].text=a.textImg;a.wxListData[a.editTemp.num][a.editTemp.index].textNew=JSON.stringify(a.textImg)}if(a.navType.type.type=="ch"||a.navType.type.type=="st"||a.navType.type.type=="submit_ticket"||a.navType.type.type=="download"){a.wxListData[a.editTemp.num][a.editTemp.index].isSetCallbackUrl=a.navType.isSetCallbackUrl}if(a.navType.type.type=="submit_ticket"){a.wxListData[a.editTemp.num][a.editTemp.index].formId=a.navType.formId}a.wxListData[a.editTemp.num][a.editTemp.index].type=a.navType.type}a.hideNavModal()}else{if(a.navType.name&&a.wxListData[a.editTemp.num].length<=5){var e={name:a.navType.name,type:a.navType.type};if(a.navType.type.type=="reply"){e.text=a.navType.text}if(a.navType.type.type=="url"){e.URL=a.navType.URL}if(a.navType.type.type=="image"){e.text=a.textImg;e.textNew=JSON.stringify(a.textImg)}if(a.navType.type.type=="ch"||a.navType.type.type=="st"||a.navType.type.type=="submit_ticket"||a.navType.type.type=="download"){e.isSetCallbackUrl=a.navType.isSetCallbackUrl}if(a.navType.type.type=="submit_ticket"){e.formId=a.navType.formId}void 0;a.wxListData[a.editTemp.num].unshift(e);a.hideNavModal()}}g()};a.editTemp={index:0,num:0};var y=i({scope:a,template:"modal/modal.tpl.w630.html",contentTemplate:"source/views/ticket/setting.wechat_efit.html",title:"编辑菜单",html:true,show:false,placement:"center"});a.editNavList=function(e,t){a.navType={};a.edit=true;a.editTemp.index=e;a.editTemp.num=t;y.$promise.then(y.show);a.hideNavModal=function(){y.$promise.then(y.hide)};if(e==a.wxListData[t].length-1){}a.navType.name=a.wxListData[t][e].name;if(a.wxListData[t][e].type){a.navType.type={};for(var i=0;i<a.navTypeValues.length;i++){if(a.navTypeValues[i].id==a.wxListData[t][e].type.id){a.navType.type=a.navTypeValues[i]}}}if(a.wxListData[t][e].text){if(a.wxListData[t][e].text.articles){a.textImg=angular.copy(a.wxListData[t][e].text);a.wxListData[t][a.editTemp.index].textNew=JSON.stringify(a.textImg);a.navType.text=""}else{a.navType.text=a.wxListData[t][e].text;a.textImg={articles:[{}]}}}void 0;if(a.wxListData[t][e].isSetCallbackUrl){a.navType.isSetCallbackUrl=a.wxListData[t][e].isSetCallbackUrl}if(a.wxListData[t][e].URL){a.navType.URL=a.wxListData[t][e].URL}if(a.navType.type&&a.navType.type.type=="submit_ticket"){if(angular.isUndefined(a.wxListData[t][e].formId)){a.navType.formId=""}else{a.navType.formId=a.wxListData[t][e].formId}h()}if(a.navType.type){a.showEditMenu(a.navType.type)}};a.addImgInf=function(){var e=a.textImg.articles.length-1;if(a.textImg.articles[e].description||a.textImg.articles[e].picUrl||a.textImg.articles[e].title||a.textImg.articles[e].url){if(a.textImg.articles.length>9){r.add("超过上限，不能再进行添加","danger");return false}a.textImg.articles.push({title:"",description:"",url:"",picUrl:""})}else{r.add("信息填写不完整，不能再进行添加","danger")}};a.delImgInf=function(e){if(a.textImg.articles.length<=1){return false}a.textImg.articles.splice(e,1)};a.delNavList=function(e,t,i){if(t==a.wxListData[i].length-1){if(confirm("确定要清空数据吗？")){a.wxListData[i]=[]}}else{a.wxListData[i].splice(t,1)}g();e.stopPropagation()};a.disableValue=false;a.update=function(){var e=_(a.wxListData[0]);var t=_(a.wxListData[1]);var i=_(a.wxListData[2]);var n=[];n[0]=e;n[1]=t;n[2]=i;var s={id:p,menu:angular.toJson(n)};org.ewei.sdk.OpenChannelConfigApi().updateChannelDingdingMenu(s).then(function(e){if(e){r.add("更新成功")}})};function _(e){var t={};if(e.length>0){t.sub_button=[];for(var i=0;i<e.length;i++){t.sub_button[i]=angular.copy(e[i]);if(t.sub_button[i].text){t.sub_button[i].text=v(e[i].text,true)}if(t.sub_button[i].textNew){var n=JSON.parse(t.sub_button[i].textNew);for(var s=0;s<n.articles.length;s++){n.articles[s].picUrl=v(n.articles[s].picUrl)}t.sub_button[i].text=JSON.stringify(n);delete t.sub_button[i].textNew}if(t.sub_button[i].type.type=="url"){if(t.sub_button[i].URL){if(t.sub_button[i].URL.toLowerCase().indexOf("http://")!=0&&t.sub_button[i].URL.toLowerCase().indexOf("https://")!=0){t.sub_button[i].URL="http://"+t.sub_button[i].URL}}else{t.sub_button[i].URL="http://"}}}}return t}}function t(p,f,m){return{restrict:"EA",link:function(s,e,t,i){var a=document.getElementById("showUploading");var n=a.getElementsByTagName("span")[0];var r=a.getElementsByTagName("span")[1];var o=a.getElementsByTagName("span")[2];var l=e[0].id?e[0].id:Date.now();e[0].id=l;var c=t.index;var u;var d=WebUploader.create({swf:"/source/lib/ueditor/third-party/webuploader/Uploader.swf",server:m.fn(),pick:"#"+l,resize:false,duplicate:true,formData:{}});d.on("uploadStart",function(e){if(u){d.option("formData",{key:eweiCommon.uuid(32,16).toLowerCase(),token:u})}else{$.ajax({url:"/qiniu_token.json",type:"GET",async:false,success:function(e){u=e;d.option("formData",{key:eweiCommon.uuid(32,16).toLowerCase(),token:u})},error:function(){if(console){void 0}}})}});d.on("fileQueued",function(e){void 0;if(e.type.indexOf("image")==-1){p.add("请选择上传图片","danger")}else{a.style.display="block";n.innerHTML="0%";r.style.width=0;o.innerHTML="正在上传请稍后...";d.upload()}});d.on("uploadProgress",function(e,t){n.innerHTML=parseInt(t*100)+"%";r.style.width=parseInt(t*100)+"%"});d.on("uploadSuccess",function(e,t){var i=t.key||"";var n="http://ewei-web-saas.ewei.com/";if(f.enviroment=="Test"){n="http://ewei-web-upload-test.ewei.com/"}else if(f.enviroment=="dev"){n="http://webdev.cdn.itkeeping.com/"}s.textImg.articles[c].picUrl=n+i;o.innerHTML="上传成功";setTimeout(function(){a.style.display="none"},1e3);s.$apply()});d.on("error",function(e){o.innerHTML="上传失败"})}}}})();(function(e){"use strict";angular.module("eweiApp.system_setting").controller("systemChannelYunzhijiaSettingCtrl",t).controller("systemChannelYunzhijiaAccessConfigController",i).controller("systemChannelYunzhijiaAdvancedSettingController",n);t.$inject=["$scope","ConsoleConfig","$stateParams"];i.$inject=["$scope","ConsoleConfig","alertService","$stateParams","$upload","$state","$timeout"];n.$inject=["$scope","$stateParams","alertService"];function t(e,t,i){e.yunzhijiaSettingModel={id:Number(i.id)};e.eweiHelpcenterApiUrl=t.eweiHelpcenterApiUrl}function i(t,e,i,n,s,a,r){var o=Number(n.id);var l=eweiCommon.uuid(32).toLowerCase();t.yunzhijiaConfigModel={id:o,config:{mobileHomePageUrl:window.location.origin+"/static/yunzhijia?channelUid="+l,channelUid:l}};if(o>0){org.ewei.sdk.OpenChannelApi().getChannelYunZhiJia({id:o}).then(function(e){if(e&&e.channel&&e.config){t.yunzhijiaConfigModel.config=e.config;t.yunzhijiaConfigModel.name=e.channel.name;if(!t.$parent.yunzhijiaSettingModel.name){t.$parent.yunzhijiaSettingModel.name=e.channel.name}}})}t.updateAccessConfigSetting=function(){if(!t.yunzhijiaConfigModel.name){i.add("渠道名称不能为空","danger");return false}else if(!t.yunzhijiaConfigModel.config.resGroupSecret){i.add("通讯录秘钥不能为空","danger");return false}else if(!t.yunzhijiaConfigModel.config.appId){i.add("APP ID不能为空","danger");return false}else if(!t.yunzhijiaConfigModel.config.appSecret){i.add("APP Secret不能为空","danger");return false}t.isDisable=true;var e={name:t.yunzhijiaConfigModel.name,config:t.yunzhijiaConfigModel.config};if(o>0){e.id=o;org.ewei.sdk.OpenChannelApi().updateChannelYunZhiJia(e).then(function(e){t.isDisable=false;if(e){i.add("保存成功")}},function(e){t.isDisable=false;if(e&&e.error_description){i.add(e.error_description,"danger")}})}else{org.ewei.sdk.OpenChannelApi().saveChannelYunZhiJia(e).then(function(e){t.isDisable=false;if(e){i.add("添加成功");a.go("system_setting.detail",{uri:"channel_settings",settingType:"multi_channel"})}},function(e){t.isDisable=false;if(e&&e.error_description){i.add(e.error_description,"danger")}})}}}function n(r,e,i){var o=Number(e.id);r.yunzhijiaAdvancedModel={id:o,config:{}};r.config={homeChecked:0};org.ewei.sdk.OpenChannelApi().getChannelYunZhiJia({id:o}).then(function(i){if(i&&i.channel&&i.config){i.config.modules=i.config.modules?JSON.parse(i.config.modules):[];angular.forEach(i.config.modules,function(e,t,i){if(e.home){r.config.homeChecked=t}if(!e.funcName){e.funcName=e.func}});r.yunzhijiaAdvancedModel.config=i.config;r.yunzhijiaAdvancedModel.name=i.channel.name;if(!r.$parent.yunzhijiaSettingModel.name){r.$parent.yunzhijiaSettingModel.name=i.channel.name}org.ewei.sdk.OpenFormApi().listTicketForm().then(function(e){if(e){r.ticketFormList=e||[];for(var t=0;t<e.length;t++){if(e[t].uid===i.config.ticketFormUid){r.ticketForm=e[t];break}}}})}});r.updateAdvancedSetting=function(){var e=angular.copy(r.yunzhijiaAdvancedModel.config);var n=0;var s=null;var a=false;angular.forEach(e.modules,function(e,t,i){if(e.opened){n++}if(t==r.config.homeChecked){e.home=true;if(!e.opened){s=e}}else{e.home=false}if(!e.funcName){a=true}});if(n==0){i.add("功能配置至少需要开启一项","danger");return}if(s!=null){i.add(s.func+"没有开启,不能作为首页","danger");return}if(a){i.add("自定义菜单名称不能为空","danger");return}e.ticketFormUid=r.ticketForm.uid;e.modules=JSON.stringify(e.modules);var t={id:o,name:r.yunzhijiaAdvancedModel.name,config:e};org.ewei.sdk.OpenChannelApi().updateChannelYunZhiJia(t).then(function(e){if(e){i.add("更新成功")}else{i.add("更新失败","danger")}})}}})();(function(e){"use strict";angular.module("eweiApp.system_setting").controller("systemBusinessRuleRobotController",t);t.$inject=["$scope","$http","alertService","$filter","ConsoleConfig"];function t(s,i,a,e,t){s.eweiHelpcenterApiUrl=t.eweiHelpcenterApiUrl;org.ewei.sdk.OpenRobotApi().findRobotById().then({success:function(e){s.robotConfig=e||{};if(s.robotConfig.photo&&s.robotConfig.photo.contentUrl){s.imgUrl="/no_auth_ewei_attachment?contentUrl="+s.robotConfig.photo.contentUrl}else{s.imgUrl="source/images/face/robot.jpg"}}});s.uploadSuccess=function(e,t){s.imgUrl="/no_auth_ewei_attachment?contentUrl="+t.key;s.$apply();i({url:"save_attachment.json",method:"POST",params:{fileName:e.name,contentType:e.type,contentUrl:t.key,size:e.size}}).success(function(e,t,i,n){if(e.json){s.robotConfig.photo=e.json}else{a.add("保存附件数据失败！","danger")}})};s.error=function(e){if(e=="F_EXCEED_SIZE"){a.add("上传文件不能大于20K。","danger")}};s.update=function(){if(e("specialChart")(s.robotConfig.name)){a.add("名称不支持除中划线，下划线以外的特殊字符","danger");return false}else if(e("specialChart")(s.robotConfig.signature)){a.add("签名不支持除中划线，下划线以外的特殊字符","danger");return false}else if(s.robotConfig.welcomeReply.length>=600){a.add("机器人欢迎语 不能超过600个字符","danger");return false}else if(s.robotConfig.knowledgeReply.length>=1200){a.add("知识库命中回复 不能超过1200个字符","danger");return false}else if(s.robotConfig.missKnowledgeReply.length>=1200){a.add("知识库未命中回复 不能超过1200个字符","danger");return false}else if(s.robotConfig.turnReply.length>=1200){a.add("转人工引导 不能超过1200个字符","danger");return false}org.ewei.sdk.OpenRobotApi().updateRobot({robot:s.robotConfig}).then({success:function(e){void 0;if(e){a.add("更新成功","success")}}})}}})();(function(r){"use strict";angular.module("eweiApp.system_setting").controller("chatBasicSettingsController",e);e.$inject=["$scope","$modal_","alertService"];function e(i,t,n){i.config=null;function e(){r.sdk.OpenChatConfigApi().getChatConfig().then(function(e){if(e){i.config=e}})}function s(e){if(e.queueAppeaseNum.length>5){n.add("排队人数最大5位数","danger");return false}if(e.queueAppeaseNum*1!==parseInt(e.queueAppeaseNum)){n.add("排队人数必须是数字(正整数)","danger");return false}if(parseInt(e.queueAppeaseNum)<0){n.add("排队人数必须是数字(正整数)","danger");return false}if(e.queueAppeaseWelcome.length>512){n.add("安抚语最长512字符","danger");return false}if(!e.queueAppeaseWelcome){n.add("安抚语不能为空","danger");return false}return true}function a(e){if(e.connectWelcome.length>512){n.add("欢迎语最长512字符","danger");return false}if(!e.connectWelcome){n.add("欢迎语不能为空","danger");return false}return true}i.setQueueAppeaseWelcome=function(){i.cloneConfig=JSON.parse(JSON.stringify(i.config));var e=t({scope:i,contentTemplate:"source/system-setting/chat-settings/template/set-queue-appease-welcome-modal.html",html:true,show:true,placement:"center"});i.$ok=function(){if(s(i.cloneConfig)){i.config=JSON.parse(JSON.stringify(i.cloneConfig));i.update(function(){i.$hide()})}};i.$hide=function(){e.$promise.then(e.hide)}};i.setConnectWelcome=function(){i.cloneConfig=JSON.parse(JSON.stringify(i.config));var e=t({scope:i,contentTemplate:"source/system-setting/chat-settings/template/set-connect-welcome-modal.html",html:true,show:true,placement:"center"});i.$ok=function(){if(a(i.cloneConfig)){i.config=JSON.parse(JSON.stringify(i.cloneConfig));i.update(function(){i.$hide()})}};i.$hide=function(){e.$promise.then(e.hide)}};i.update=function(t){r.sdk.OpenChatConfigApi().saveOrUpdate({chatConfig:i.config}).then(function(e){if(e){n.add("更新成功","success");t&&t()}})};e()}})(org.ewei);!function(){"use strict";angular.module("eweiApp.system_setting").controller("chatQualitySettingController",e);e.$inject=["$scope","alertService","$state"];function e(a,r,o){a.chatQualitySettingModel={kpiConfigs:[],tabooConfigs:[]};var t=[{name:"服务禁忌",maxScore:5},{name:"服务意识",maxScore:5},{name:"用语得体",maxScore:5},{name:"是否解决问题",maxScore:5}];var i=[{name:"辱骂客户"},{name:"误导客户"},{name:"承诺客户"}];var l=[],c=[];org.ewei.sdk.OpenChatQualityApi().findQualityConfig().then(function(e){if(e.kpiConfigs&&!e.kpiConfigs.length){a.chatQualitySettingModel.forTheFirstTime=true;a.chatQualitySettingModel.kpiConfigs=t;a.chatQualitySettingModel.tabooConfigs=i}else{a.chatQualitySettingModel.kpiConfigs=e.kpiConfigs;a.chatQualitySettingModel.tabooConfigs=e.tabooConfigs}});a.getAllScore=function(){return _.reduce(a.chatQualitySettingModel.kpiConfigs,function(e,t){var i=Number(t.maxScore)||0;return e+i},0)};a.addConfig=function(e){if(e==="kpi"){a.chatQualitySettingModel.kpiConfigs.push({})}else{a.chatQualitySettingModel.tabooConfigs.push({})}};a.deleteConfig=function(e,t,i){if(i==="kpi"){a.chatQualitySettingModel.kpiConfigs.splice(e,1);if(t.id){l.push(t.id)}}else{a.chatQualitySettingModel.tabooConfigs.splice(e,1);if(t.id){c.push(t.id)}}};a.scoreChange=function(e){var t=/^[1-9]\d{0,2}$/;if(e.maxScore&&!t.test(e.maxScore)){e.maxScore="";r.add("满分值只能为数字且在1-999之间","danger")}};a.updateConfig=function(){var e=angular.copy(a.chatQualitySettingModel.kpiConfigs);var t=angular.copy(a.chatQualitySettingModel.tabooConfigs);for(var i=0;i<e.length;i++){if(!e[i].name||!e[i].maxScore){r.add("指标名称和满分值不能为空","danger");return false}else{e[i].priority=i}}for(var n=0;n<t.length;n++){if(!t[n].name){r.add("禁忌项不能为空","danger");return false}else{t[n].priority=n}}var s={kpiConfigs:e,kpiConfigDeleteIds:l,tabooConfigs:t,tabooConfigDeleteIds:c};org.ewei.sdk.OpenChatQualityApi().updateQualityConfig(s).then(function(e){if(e){var t={position:"SYSTEM",target:"EDIT_CHAT_QUALITY_CONFIG"};if(a.chatQualitySettingModel.forTheFirstTime){t.action="SAVE";r.add("保存成功")}else{t.action="UPDATE";r.add("更新成功")}org.ewei.sdk.OperationLogApi().saveOperationLog(t).then(function(e){});o.reload()}})}}}();(function(){"use strict";angular.module("eweiApp.system_setting").config(e);e.$inject=["$stateProvider","$urlRouterProvider"];function e(e,t){e.state("system_setting.form_detail",{url:"/formDetail/:showType/:id/:doType",controller:"formManagerDetailController",templateUrl:"source/system-setting/form-manager/templates/form-manager-detail.html"})}})();(function(l){"use strict";angular.module("eweiApp.system_setting").controller("formManagerController",e);e.$inject=["$scope","coreModelService","$state","alertService","$modal_"];function e(n,t,i,s,e){n.page={pageNumber:1,pageSize:20};n.switching=function(e){n.showType=e;a()};n.editForm=function(e,t){i.go("system_setting.form_detail",{showType:n.showType,id:e,doType:t})};var a=function(){if(n.showType=="ticket"){n.displayTicketForm=true;n.displayChatForm=false}else{n.displayTicketForm=false;n.displayChatForm=true}n.oldSearchKey="";n.searchKey="";n.page.pageNumber=1;n.getListForm()};n.$on("$destroy",function(){t.config.route.put("system.setting.form_manager.showType",n.showType)});n.getListForm=function(){l.sdk.OpenFormApi().listForm({page:n.page,form:{type:n.showType,name:n.searchKey}}).then(function(e){n.listForm=r(e.list);n.allCount=e.recordCount})};var r=function(e){var n={active:[],unActive:[]};e.forEach(function(e,t,i){if(e.enabled){n.active.push(e)}else{n.unActive.push(e)}});for(var t in n){n[t]=n[t].sort(function(e,t){return new Date(e.createdAt).getTime()-new Date(t.createdAt).getTime()})}return n.active.concat(n.unActive)};n.deleteForm=function(t){n.confirmContent="您确定要删除该表单吗？";var i=e({scope:n,title:"确认",contentTemplate:"source/views/confirm_template.html",html:true,show:true,placement:"center"});n.hideModal=function(){i.$promise.then(i.hide)};n.$ok=function(){l.sdk.OpenFormApi().deleteForm({id:t.id}).then(function(e){if(e){n.listForm.splice(n.listForm.indexOf(t),1);s.add("删除成功","success");i.$promise.then(i.hide)}})}};n.cancelSearch=function(){n.oldSearchKey="";n.searchKey="";n.page.pageNumber=1;n.getListForm()};n.$watch("searchKey",function(e,t){if(e==""&&n.oldSearchKey){n.oldSearchKey="";n.page.pageNumber=1;n.getListForm()}});n.searchForm=function(){if(!n.searchKey||n.searchKey==n.oldSearchKey){return}n.oldSearchKey=angular.copy(n.searchKey);n.page.pageNumber=1;n.getListForm()};n.updateFormState=function(t){l.sdk.OpenFormApi().updateFormState({id:t.id,enabled:!t.enabled}).then(function(e){if(e){t.enabled=!t.enabled;s.add("更新成功","success")}})};function o(){var e=t.config.route.get("system.setting.form_manager.showType")||"ticket";n.showType=e;a()}o()}})(org.ewei);(function(v){"use strict";angular.module("eweiApp.system_setting").controller("formManagerDetailController",e);e.$inject=["$scope","coreModelService","$stateParams","$http","alertService","$state","$filter"];function e(r,e,t,i,n,s,a){r.formTypeList=[{name:"工单表单",value:"ticket"},{name:"会话表单",value:"chat"}];r.form={};r.userInfArr=[];var o=function(){r.formType=t.showType;r.formId=parseInt(t.id);r.doType=t.doType;l()};r.changeFormType=function(){l()};var l=function(){if(r.formType==="ticket"){var n=[];var s=[];d.then(function(e){e.forEach(function(e,t,i){if(e.scope==="ticket"){n.push(e)}else{s.push(e)}});u(n);c(s)})}else{p.then(function(e){c(e)})}};var c=function(e){r.userCustomFields=[{name:"Email",showName:"Email",tip:"请输入Email",fieldName:"email",required:false,inputType:"text"},{name:"手机号码",showName:"手机号码",tip:"请输入手机号码",fieldName:"mobilePhone",required:false,inputType:"text"},{name:"电话",showName:"电话",tip:"请输入电话号码",fieldName:"phone",required:false,inputType:"text"},{name:"名字",showName:"你的姓名",tip:"请输入你的姓名",fieldName:"name",required:false,inputType:"text"},{name:"联系邮箱",showName:"联系邮箱",tip:"请输入你的联系邮箱",fieldName:"contactEmail",required:false,inputType:"text",tips:"仅用于收集用户资料，不验证，不匹配账号。"},{name:"联系手机",showName:"联系手机",tip:"请输入你的联系手机",fieldName:"contactMobilePhone",required:false,inputType:"text",tips:"仅用于收集用户资料，不验证，不匹配账号。"},{name:"ExternalId",showName:"ExternalId",tip:"请输入你的ExternalId",fieldName:"externalId",required:false,inputType:"text"}];var t=[];if(e&&e.length>0){var i=e;for(var n=0;n<i.length;n++){var s={};s={name:i[n].title,showName:i[n].title,tip:i[n].notes,fieldName:"user_customField_"+i[n].id,required:i[n].required,showNameDisable:false};if(i[n].type=="checkbox"||i[n].type=="textarea"||i[n].type=="date"||i[n].type=="multi_options"||i[n].type=="cascade_options"||i[n].type=="date_to_date"||i[n].type=="date_time"){s.inputType=i[n].type}else if(i[n].type=="options"){s.inputType="select"}else{s.inputType="text"}t.push(s)}r.userCustomFields=r.userCustomFields.concat(t)}f()};var u=function(e){r.ticketCustomFields=[{name:"验证码",showName:"验证码",tip:"请输入验证码",fieldName:"verifyCode",required:true,inputType:"text"}];var t=[];if(e&&e.length>0){var i=e;for(var n=0,s=i.length;n<s;n++){var a={};a={name:i[n].title,showName:i[n].title,tip:i[n].notes,required:i[n].required,showNameDisable:false};if(i[n].systemFieldKey=="priority"){a.fieldName="priority"}else if(i[n].systemFieldKey=="ticket_type"){a.fieldName="ticketType"}else if(i[n].systemFieldKey=="service_catalog"){a.fieldName="serviceCatalog"}else if(i[n].systemFieldKey=="subject"){a.fieldName="subject"}else if(i[n].systemFieldKey=="ticket_description"){a.fieldName="description"}else{a.fieldName="ticket_customField_"+i[n].id}if(i[n].type=="checkbox"||i[n].type=="textarea"||i[n].type=="date_to_date"||i[n].type=="date"||i[n].type=="multi_options"||i[n].type=="cascade_options"||i[n].type=="date_time"){a.inputType=i[n].type}else if(i[n].type=="options"){a.inputType="select"}else{a.inputType="text"}if(i[n].systemFieldKey!="tags"){t.push(a)}}r.ticketCustomFields=r.ticketCustomFields.concat(t)}};var d=v.sdk.OpenFormApi().getTicketFormCustomFiled({});var p=v.sdk.OpenFormApi().getChatFormCustomFiled({});var f=function(){if(r.formId===0){r.selectedCustomField=[];if(r.formType==="ticket"){r.ticketCustomFields.some(function(e,t,i){if(e.fieldName==="subject"||e.fieldName==="description"){r.selectedCustomField.push(e)}if(r.selectedCustomField.length===2){return true}})}r.userCustomFields.some(function(e,t,i){if(e.fieldName==="name"){r.selectedCustomField.push(e);return true}});m("init")}else{g()}};var m=function(e){if(r.selectedCustomField&&r.selectedCustomField.length>0){var t=angular.copy(r.selectedCustomField);var i=angular.copy(r.formType==="chat"?r.userCustomFields:r.userCustomFields.concat(r.ticketCustomFields));r.userInfArr=[];for(var n=0;n<t.length;n++){t[n].showName=t[n].showName||t[n].name;var s=true;t[n].active=false;if(t[n].fieldName=="email"||t[n].fieldName=="mobilePhone"||t[n].fieldName=="externalId"){r.userInfArr.push(t[n])}for(var a=0;a<i.length;a++){if(t[n].fieldName==i[a].fieldName){s=false;break}}if(s){t.splice(n,1);n--}}r.selectedCustomField=angular.copy(t);for(var n=0;n<t.length;n++){if(r.formType==="ticket"){for(var a=0;a<r.ticketCustomFields.length;a++){if(t[n].fieldName==r.ticketCustomFields[a].fieldName){r.ticketCustomFields[a].activeShow=true;break}}}for(var a=0;a<r.userCustomFields.length;a++){if(t[n].fieldName==r.userCustomFields[a].fieldName){r.userCustomFields[a].activeShow=true;break}}}}r.isDisabled(e);r.selectedCustomField.forEach(function(e){r.checkFun(e)})};var g=function(){v.sdk.OpenFormApi().getFormById({id:r.formId}).then(function(e){r.selectedCustomField=e.formFields;r.form=e.form;m("init")})};r.isDisabled=function(e){var t=0;r.isaa=false;for(var i=0;i<r.selectedCustomField.length;i++){var n=r.selectedCustomField[i];if(n.fieldName==="subject"||n.fieldName==="description"){t++;if(e!=="init"){n.required=true}}if(t>=2){r.isaa=true}}};r.checkedMenu=function(n){var e=false,t=null,i=null,s=null;for(var a=0;a<r.selectedCustomField.length;a++){if(n.fieldName==r.selectedCustomField[a].fieldName){e=true;t=a}if(r.selectedCustomField[a].fieldName==="subject"){i=true}if(r.selectedCustomField[a].fieldName==="description"){s=true}}if(e){if(n.fieldName==="subject"||n.fieldName==="description"){if(i&&s){}else{return false}}r.selectedCustomField.splice(t,1)}else{r.selectedCustomField.push(n)}if(n.fieldName==="subject"||n.fieldName==="description"){r.isDisabled();r.selectedCustomField.forEach(function(e){r.checkFun(e)})}n.activeShow=!n.activeShow;if(n.fieldName==="email"||n.fieldName==="mobilePhone"||n.fieldName==="externalId"){if(n.activeShow){if(r.userInfArr.length<3){r.userInfArr.push(n)}}else{r.userInfArr.splice(r.userInfArr.findIndex(function(e,t,i){return e.name===n.name}),1)}}};r.checkFun=function(e){var t={};for(var i=0;i<r.selectedCustomField.length;i++){var n=r.selectedCustomField[i];if(n.fieldName==="subject"){t["description"]=n}else if(n.fieldName==="description"){t["subject"]=n}}if(t[e.fieldName]){if(!e.required){t[e.fieldName].disabled=true;t[e.fieldName].required=true}else{t[e.fieldName].disabled=false}}};r.editMenu=function(e){e.active=true};r.editMenuOver=function(e){e.active=false};r.subForm=function(){var e=angular.copy(r.selectedCustomField);if(e.length<=0){n.add("当前的表单字段为空，会导致客户无字段可用。请配置表单字段。","danger");return false}for(var t=0;t<e.length;t++){delete e[t].active;delete e[t].activeShow;if(r.userInfArr.length>=2&&(e[t].fieldName=="email"||e[t].fieldName=="mobilePhone"||e[t].fieldName=="externalId")){e[t].required=false;e[t].orderKey=0}else{e[t].orderKey=t+1}}if(!r.form.name){n.add("请输入表单名称","danger");return}if(a("specialChart")(r.form.name)){n.add("表单名称不支持除中划线，下划线以外的特殊字符","danger");return}if(a("specialChart")(r.form.description)){n.add("附加说明不支持除中划线，下划线以外的特殊字符","danger");return}if(r.doType==="modify"){v.sdk.OpenFormApi().updateForm({form:r.form,formFields:e}).then(function(e){if(e&&e.error_description){n.add("更新失败","danger")}else{n.add("更新成功","success");s.go("system_setting.detail",{settingType:"multi_channel",uri:"form_manager"})}})}else{r.form.type=r.formType;v.sdk.OpenFormApi().saveForm({form:r.form,formFields:e}).then(function(e){n.add("添加成功","success");s.go("system_setting.detail",{settingType:"multi_channel",uri:"form_manager"})})}};o()}})(org.ewei);+function(){"use strict";angular.module("eweiApp.system_setting").config(e);e.$inject=["$stateProvider"];function e(e){e.state("system_setting.assignment_detail",{url:"/ticket/assignment/:showType/:type/:id",controller:"assignmentDetailCtrl",templateUrl:"source/system-setting/assignment/templates/assignment-detail.html",permission:"ticket_setting_via",params:{type:"",id:"0",name:"",showType:"ticket"}})}function t(i){e.$inject=["$stateParams","coreModelService"];function e(e,t){t.config.route.put(i,{name:this.name,params:e,permission:this.permission||""})}return e}}();(function(h){"use strict";angular.module("eweiApp.system_setting").controller("assignmentCtrl",e);e.$inject=["$scope","$state","coreModelService","$modal_","alertService","coreNotifyService","apiAssignRuleService","$filter"];function e(s,i,t,e,n,a,r,o){var l=this.__proto__.constructor.name+"_"+Date.now();s.isSearchResult=false;s.switching=function(e){s.showType=e;f();p();u()};s.editRule=function(e,t){i.go("system_setting.assignment_detail",{id:t===0?0:t.id,name:"",type:e,showType:s.showType})};var c=function(){if(s.robot){return}h.sdk.OpenRobotApi().findRobotById().then(function(e){s.robot=e})};var u=function(){if(s.showType=="ticket"){s.displayTicket=true;s.displayChat=false}else{s.displayTicket=false;s.displayChat=true}s.oldSearchKey="";s.searchKey="";s.isSearchResult=false};s.$on("$destroy",function(){t.config.route.put("system.setting.assignment.showType",s.showType)});s.sortableOptions={chosenClass:"sortable-chosen",handle:".sortable",onUpdate:function(e){var n=[];var t=angular.copy(s.ruleList);var i;t.forEach(function(e,t,i){e.num=t+1;n.push(e.id)});s.ruleList=t;if(s.showType==="ticket"){i="TYPE_RULE_TICKET"}else{i="TYPE_RULE_CHAT"}h.sdk.OpenAssignRuleApi().updateAssignRulePosition({ids:n,type:i}).then(function(e){})},onMove:function(e){if(s.isSearchResult){n.add("搜索结果不能拖动排序","danger");return false}},onEnd:function(e){if(e.newIndex+1>=s.isDefaultPosition){s.ruleList=angular.copy(s.oldRuleList);n.add("已启用的规则不能排在默认的和停用的规则之后","danger")}}};var d=function(e){e.forEach(function(t){if(t.attribute==="via"){t.name="渠道："}else if(t.attribute==="userGroup"){t.name="客户组："}else if(t.attribute==="user.tags"){t.name="客户标签："}else{t.name="客户区域："}if(t.compare==="$eq"){t.compare="是"}else if(t.compare==="$ne"){t.compare="不是"}else if(t.compare==="$include"){t.compare="包含以下字符串"}else{t.compare="不含以下字符串"}var i;try{i=JSON.parse(t.value)}catch(e){i=t.value}if(t.attribute==="via"){t.value=o("channelType")(i.viaType);if(i.via&&i.via.name){t.value+="/"+i.via.name}}else if(t.attribute==="userGroup"){t.value=i.name}else if(t.attribute==="user.tags"){t.value=i}else{t.value=i.city?i.provice.name+" "+i.city.name:i.provice.name}})};s.cancelSearch=function(){s.oldSearchKey="";s.searchKey="";s.ruleList=s.oldRuleList;s.isSearchResult=false};s.$watch("searchKey",function(e,t){if(e==""&&s.oldSearchKey){s.oldSearchKey="";s.ruleList=s.oldRuleList;s.isSearchResult=false}});s.searchRule=function(){if(!s.searchKey||s.searchKey==s.oldSearchKey){return}s.oldSearchKey=angular.copy(s.searchKey);s.getFormBySearchKey();s.isSearchResult=true};s.getFormBySearchKey=function(){var n=[];angular.forEach(s.oldRuleList,function(e,t,i){if(e.name.indexOf(s.searchKey)>-1){n.push(e)}});s.ruleList=n};s.deleteRule=function(t){s.confirmContent="您确定要删除吗？";var i=e({scope:s,title:"确认",contentTemplate:"source/views/confirm_template.html",html:true,show:true,placement:"center"});s.hideModal=function(){i.$promise.then(i.hide)};s.$ok=function(){h.sdk.OpenAssignRuleApi().deleteAssignRule({assignRuleId:t.id}).then(function(e){if(e){s.ruleList.splice(s.ruleList.indexOf(t),1);n.add("删除成功","success");i.$promise.then(i.hide)}})}};s.updateFormState=function(t){h.sdk.OpenAssignRuleApi().enabledAssignRule({assignRuleId:t.id,isEnabled:!t.active}).then(function(e){t.active=!t.active;p();n.add("更新成功","success")})};function p(){var e;if(s.showType==="ticket"){e="TYPE_RULE_TICKET"}else{e="TYPE_RULE_CHAT"}r.run(a.constant.EVENT_LIST_ASSIGN_RULE,{type:e,isNeedConditions:true,isNeedHandlers:true})}var f=function(){var e=angular.copy(t.detail.assginRule[s.showType].gets(t.list.assginRule[s.showType].gets(1)))||[];e.forEach(function(e,t,i){d(e.andConditions);d(e.orConditions);if(e.isDefault){s.isDefaultPosition=t+1}});e.forEach(function(e,t,i){e.num=t+1});s.ruleList=angular.copy(e);s.oldRuleList=angular.copy(e)};var m=function(){a.register(l,a.constant.EVENT_LIST_ASSIGN_RULE,function(e,t){f()})};function g(){var e=t.config.route.get("system.setting.assignment.showType")||"chat";s.showType=e;u();m();f();p()}g();function v(){a.unRegister(l)}s.$on("$destroy",function(){v()})}})(org.ewei);!function(d){"use strict";angular.module("com.ewei.angular.ui").controller("onlineCustomerNavigationCtrl",e).directive("onlineCustomerNavigation",t);e.$inject=["$scope","$state","$http","$timeout","alertService","ConsoleConfig"];function e(a,e,t,i,s,n){a.serviceCatalogs=[];a.navList=[{name:"导航菜单",serviceCatalogId:a.ruleId}];var r=function(e,n){d.sdk.OpenAssignRuleApi().listServiceCatalogsByReplyId({assignRuleId:a.ruleId==="0"?null:a.ruleId,parentId:e}).then(function(e){if(e&&e.length>0){var t=angular.copy(e);for(var i=0;i<t.length;i++){if(!t[i].name){t[i].name=t[i].serviceCatalogName||""}if(t[i].no){t[i].isChecked=true}t[i].uId=i+1}if(n){n(t)}}else{s.add("没有更多了","danger")}})};a.nowServiceCatalogNo=0;var o=a.ruleId;var l=true;a.editServiceCatalog=function(e,t){e.isShowInput=true;t.stopPropagation()};a.ngFocus=function(){l=false};a.ngBlur=function(e){e.isShowInput=false;i(function(){l=true},500)};a.inputStopPropagation=function(e){e.stopPropagation()};a.setIndex=function(e){if(!l){return false}e.isChecked=!e.isChecked;var t=a.arr[a.nowServiceCatalogNo][o];if(!e.no){e.no=t.nowNo;if(e.no>=a.serviceCatalogs.length){t.nowNo=a.serviceCatalogs.length}else{t.nowNo++}}else{var i=0;for(var n=0;n<a.serviceCatalogs.length;n++){if(a.serviceCatalogs[n].no){if(a.serviceCatalogs[n].no>e.no){a.serviceCatalogs[n].no--}i++}}if(e.no!==a.serviceCatalogs.length&&i<a.serviceCatalogs.length){t.nowNo--}e.no=""}};a.getNextServiceCatalog=function(s,e){if(s.isChecked){if(a.arr[a.nowServiceCatalogNo+1]&&a.arr[a.nowServiceCatalogNo+1][s.serviceCatalogId]&&a.arr[a.nowServiceCatalogNo+1][s.serviceCatalogId].allArr.length>0){a.nowServiceCatalogNo++;var t=c(s.serviceCatalogId,a.arr[a.nowServiceCatalogNo]);if(t){a.serviceCatalogs=t;o=s.serviceCatalogId;a.navList.push({name:s.name,serviceCatalogId:s.serviceCatalogId})}}else{r(s.serviceCatalogId,function(e){a.nowServiceCatalogNo++;o=s.serviceCatalogId;a.navList.push({name:s.name,serviceCatalogId:s.serviceCatalogId});var t=1;for(var i=0;i<e.length;i++){if(e[i].no){t++}}if(t>=e.length){t=e.length}var n={nowNo:t,allArr:e};a.serviceCatalogs=e;a.arr[a.nowServiceCatalogNo][s.serviceCatalogId]=n})}e.stopPropagation()}};a.goServiceCatalog=function(e,t){a.nowServiceCatalogNo=t;o=e.serviceCatalogId;if(t==a.navList.length-1){return false}a.navList=a.navList.slice(0,t+1);var i=c(e.serviceCatalogId,a.arr[t]);if(i){a.serviceCatalogs=i}};var c=function(e,t){for(var i in t){if(i==e){return t[i].allArr}}return false};function u(){r(null,function(e){var t=1;for(var i=0;i<e.length;i++){if(e[i].no){t++}}a.serviceCatalogs=e;if(t>=e.length){t=e.length}a.arr[a.nowServiceCatalogNo].nowNo=t;var n={};n[a.ruleId]={nowNo:t,allArr:e};a.arr[a.nowServiceCatalogNo]=n})}u()}t.$inject=[];function t(){return{restrict:"EA",templateUrl:"/source/system-setting/assignment/templates/online-customer-navigation.html",controller:"onlineCustomerNavigationCtrl",scope:{ruleId:"=",arr:"="}}}}(org.ewei);!function(v){"use strict";angular.module("com.ewei.angular.ui").controller("assignmentDetailCtrl",e);e.$inject=["$scope","coreModelService","$modal_","alertService","$state","$filter"];function e(o,e,t,r,i,a){o.assignId=i.params.id;o.showType=i.params.showType;o.operationType=i.params.type;o.assignRule={};o.assignRuleList=[{type:"person",name:"仅人工客服",content:"所有会话请求都将直接分派到客服进行处理"},{type:"robot_first",name:"机器人客服优先",content:"所有对话都将由机器人优先接待，需要机器人分担人工客服的接待压力的时候，一般选择此模式"},{type:"robot",name:"仅机器人客服",content:"只会由机器人接待客户，一般用在客户自助服务的场景下。"},{type:"person_first",name:"人工客服优先",content:"仅当非营业时间，及人工客服完全离线的时候启用机器人接待客户"}];o.assignModeList=[{type:"average",name:"平均分派",content:"优先分配访客最少的客服",isActive:true},{type:"polling",name:"轮询分派",content:"按照客服的签入顺序轮询分派",isActive:false},{type:"priority",name:"优先分配",content:"按照客服等级顺序优先分配，当前一个客服会话饱和时给下一优先级的客服分配",isActive:false},{type:"manual",name:"手动抢单",content:"系统将不进行自动派单，都由客服主动接通",isActive:false}];o.conditions=[{option:"来源渠道",value:"via"},{option:"客户：标签",value:"user.tags"},{option:"客户：组织名称",value:"userGroup"},{option:"客户：区域",value:"location"}];var n=function(){v.sdk.OpenAssignRuleApi().findAssignRule({assignRuleId:o.assignId}).then(function(t){if(o.showType==="chat"){o.currentAssignRule=o.assignRuleList.find(function(e){if(e.type===t.assignRuleInfo){return e}});o.defaultRobot=null;var e=_.filter(o.robotList,function(e){if(e.isDefault){o.defaultRobot=e}return e.id==t.automatonId});if(e&&e.length>0){o.robot=e[0]}else{o.robot=o.defaultRobot}t.automatonId=o.robot.id}else{o.currentAssignRule=o.assignRuleList[0];t.assignRuleHandlers.forEach(function(e,t,i){if(e.activitiWorkflowTemplate){e.workflow=e.activitiWorkflowTemplate}})}o.assignRule=t;o.serviceCatalogs=t.webchatServiceCatalogs})};var s=function(){o.isShowAssignRuleList=false;o.currentAssignRule=o.assignRuleList[0];o.serviceCatalogs=[{},{},{},{},{}];o.assignRule={isExclusive:true,assignRuleInfo:o.currentAssignRule.type,assignMode:"average",isRepeatCustomers:false,active:true,name:"",andConditions:[],orConditions:[],assignRuleHandlers:[{serviceDesk:""}]};if(o.showType==="chat"){setTimeout(function(){o.assignRule.assignAutomaticReply={offlineWelcome:'欢迎光临，如需帮助请<save_ticket style="color: #6699CC;">提交工单</save_ticket>。',onlineWelcome:"欢迎光临，请问有什么可以帮到你？",offlineAutomaticReply:'请<save_ticket style="color: #6699CC;">提交工单</save_ticket>获得帮助',isMenu:false,isCustomerService:true}},0);o.robot=_.filter(o.robotList,function(e){return e.isDefault})[0];o.defaultRobot=angular.copy(o.robot);o.assignRule.automatonId=o.robot.id}v.sdk.OpenServiceDeskApi().listServiceDesk({page:{pageSize:9999,pageNumber:1}}).then(function(e){e.list.find(function(e){if(e.isDefault){o.defaultServiceDesk=e;o.assignRule.assignRuleHandlers[0].serviceDesk=e}})})};o.toggle=function(e){o.activeStep=e;if(e===2&&o.operationType==="add"){o.switchServiceCatalogs()}if(e!=1){l()}};var l=function(){var t;var e={or:o.assignRule.orConditions,and:o.assignRule.andConditions};o.selectConditions={or:[],and:[]};for(var i in e){var n,s;e[i].map(function(e){n=e.thirdValue;s=e.firstValue.value;t={};t.name=e.firstValue.option;t.compare=e.secondValue.option;if(s==="via"){t.value=a("channelType")(n.viaType);if(n.via&&n.via.name){t.value+="/"+n.via.name}}else if(s==="userGroup"){t.value=n.name}else if(s==="user.tags"){t.value=n}else{t.value=n.city?n.provice.name+" "+n.city.name:n.provice.name}o.selectConditions[i].push(t)})}};o.toggleAssignRuleList=function(){o.isShowAssignRuleList=!o.isShowAssignRuleList};o.selectAssignRule=function(e){o.currentAssignRule=e;o.assignRule.assignRuleInfo=e.type;o.isShowAssignRuleList=false};o.selectAssignMode=function(e){o.assignRule.assignMode=e};o.switchServiceCatalogs=function(){var e=o.assignRule.assignAutomaticReply.isMenu;if(!e){o.assignRule.assignAutomaticReply={offlineWelcome:'欢迎光临，如需帮助请<save_ticket style="color: #6699CC;">提交工单</save_ticket>。',onlineWelcome:"欢迎光临，请问有什么可以帮到你？",offlineAutomaticReply:'请<save_ticket style="color: #6699CC;">提交工单</save_ticket>获得帮助。',isMenu:e,isCustomerService:true}}else{o.assignRule.assignAutomaticReply={offlineWelcome:'欢迎光临，如需帮助请<save_ticket style="color: #6699CC;">提交工单</save_ticket>。',onlineGuideWelcome:"欢迎光临，请问有什么可以帮到你？你是否遇到下列问题？<br/>{{guide_menu}}<br/>点击选择导航菜单，获得帮助。",offlineAutomaticReply:'请<save_ticket style="color: #6699CC;">提交工单</save_ticket>获得帮助。',onlineGuideReply:"请点击选择导航菜单，获得帮助。<br/>{{guide_menu}}",onlineGuideWelcomeWeixin:"您好，请问您是否遇到下列问题？<br/>{{guide_menu}}<br/>请回复数字序号进行选择。",onlineGuideReplyWeixin:"请回复数字序号进行选择。<br/>{{guide_menu}}",isMenu:e,isCustomerService:true}}};var c={offlineWelcome:'欢迎光临，如需帮助请<save_ticket style="color: #6699CC;">提交工单</save_ticket>。',onlineWelcome:"欢迎光临，请问有什么可以帮到你？",offlineAutomaticReply:'请<save_ticket style="color: #6699CC;">提交工单</save_ticket>获得帮助。',onlineGuideWelcome:"欢迎光临，请问有什么可以帮到你？你是否遇到下列问题？<br/>{{guide_menu}}<br/>点击选择导航菜单，获得帮助。",onlineGuideReply:"请点击选择导航菜单，获得帮助。<br/>{{guide_menu}}"};o.recover=function(e){o.assignRule.assignAutomaticReply[e]=c[e]};o.addAssignRuleHandlers=function(){if(o.assignRule.assignRuleHandlers.length<2){var e={serviceDesk:o.defaultServiceDesk};o.assignRule.assignRuleHandlers.push(e)}};o.deleteAssignRuleHandlers=function(e){if(o.assignRule.assignRuleHandlers.length>1){o.assignRule.assignRuleHandlers.splice(e,1)}else{r.add("至少保留一个处理人","danger")}};o.hasUpdated=false;o.saveRule=function(){if(o.hasUpdated||u()){return}var t={};if(o.showType==="chat"&&o.assignRule.assignAutomaticReply.isMenu&&o.currentAssignRule.type!=="robot"){t.webchatServiceCatalogs=p();if(t.webchatServiceCatalogs.length===0){r.add("请配置您的导航菜单","danger");return}}o.hasUpdated=true;if(o.showType==="ticket"){t.ruleType="TYPE_RULE_TICKET"}else{t.ruleType="TYPE_RULE_CHAT"}var s=[];var a=0;if(o.currentAssignRule.type!=="robot"){o.assignRule.assignRuleHandlers.forEach(function(e,t,i){var n={};if(e.engineer){n.engineerId=e.engineer.id;n.serviceDeskId=e.serviceDesk.id}else if(e.serviceDesk){n.serviceDeskId=e.serviceDesk.id}else{n.workflowTemplateId=e.workflow.id}n.position=a++;s.push(n)})}t.assignRule=angular.copy(o.assignRule);t.assignRule.assignRuleHandlers=s;if(o.showType==="chat"){t.assignRule.automatonId=t.assignRule.assignRuleInfo==="person"?o.defaultRobot.id:t.assignRule.automatonId}t.assignRule.andConditions=d("and");t.assignRule.orConditions=d("or");t.assignRule.assignAutomaticReply&&Object.keys(t.assignRule.assignAutomaticReply).forEach(function(e){if(typeof t.assignRule.assignAutomaticReply[e]==="string"){t.assignRule.assignAutomaticReply[e]=t.assignRule.assignAutomaticReply[e].replace(/&amp;/g,"&")}});if(o.operationType==="add"||o.operationType==="copy"){t.assignRule.uId=eweiCommon.uuid(32,16).toLowerCase();v.sdk.OpenAssignRuleApi().createAssignRule(t).then(function(e){r.add("创建成功","success");o.hasUpdated=false},function(e){r.add(e.error_description,"danger");o.hasUpdated=false})}else{v.sdk.OpenAssignRuleApi().updateAssignRule(t).then(function(e){r.add("更新成功","success");o.hasUpdated=false},function(e){r.add(e.error_description,"danger");o.hasUpdated=false})}};var u=function(){if(o.assignRule.name===""){r.add("规则名称不能为空","danger");return true}if(a("specialChart")(o.assignRule.name)){r.add("规则名称不支持除中划线，下划线以外的特殊字符","danger");return true}var e=o.assignRule.andConditions;var t=o.assignRule.orConditions;if(!o.assignRule.isDefault&&(e.length===0&&t.length===0)){r.add("触发条件不能为空","danger");return true}for(var i=0;i<e.length;i++){if(!e[i].firstValue||!e[i].firstValue.value||!e[i].secondValue||!e[i].secondValue.value||!e[i].thirdValue){r.add("请将所有条件填写完整","danger");return true}}for(var i=0;i<t.length;i++){if(!t[i].firstValue||!t[i].firstValue.value||!t[i].secondValue||!t[i].secondValue.value||!t[i].thirdValue){r.add("请将任何条件填写完整","danger");return true}}if(o.showType==="chat"){var n=o.assignRule.assignAutomaticReply;if(n.isMenu){if(n.onlineGuideWelcome===""){r.add("带有服务目录导航的欢迎语 不能为空","danger");return true}if(n.onlineGuideWelcome.length>1200){r.add("带有服务目录导航的欢迎语 不能超过1200个字符","danger");return true}if(n.onlineGuideReply===""){r.add("未命中时的回复 不能为空","danger");return true}if(n.onlineGuideReply.length>1200){r.add("未命中时的回复 不能超过1200个字符","danger");return true}if(n.onlineGuideWelcomeWeixin===""){r.add("带有服务目录导航的欢迎语 不能为空","danger");return true}if(n.onlineGuideWelcomeWeixin.length>1200){r.add("带有服务目录导航的欢迎语 不能超过1200个字符","danger");return true}if(n.onlineGuideReplyWeixin===""){r.add("未命中时的回复 不能为空","danger");return true}if(n.onlineGuideReplyWeixin.length>1200){r.add("未命中时的回复 不能超过1200个字符","danger");return true}}else{if(n.onlineWelcome===""){r.add("欢迎语 不能为空","danger");return true}if(n.onlineWelcome.length>1200){r.add("欢迎语 不能超过1200个字符","danger");return true}}if(n.offlineWelcome===""){r.add("离线欢迎语 不能为空","danger");return true}if(n.offlineWelcome.length>1200){r.add("离线欢迎语 不能超过1200个字符","danger");return true}if(n.offlineAutomaticReply===""){r.add("未命中时的回复 不能为空","danger");return true}if(n.offlineAutomaticReply.length>1200){r.add("未命中时的回复 不能超过1200个字符","danger");return true}}var s=o.assignRule.assignRuleHandlers;if(o.currentAssignRule&&o.currentAssignRule.type!=="robot"){if(o.showType==="chat"){for(var i=0;i<s.length;i++){if(!s[i].serviceDesk&&!s[i].engineer){r.add("请将分派处理人填写完整","danger");return true}}}else{for(var i=0;i<s.length;i++){if(!s[i].serviceDesk&&!s[i].engineer&&!s[i].workflow){r.add("请将分派处理人填写完整","danger");return true}}}}};var d=function(e){var t;var n=[];var s;if(e==="and"){t=angular.copy(o.assignRule.andConditions)}else{t=angular.copy(o.assignRule.orConditions)}t.forEach(function(e,t,i){s={};s.attribute=e.valueType;s.compare=e.secondValue.value;s.orderKey=t+1;s.tally="and";if(e.valueType==="location"){s.value=e.thirdOptions.id}s.value=e.thirdValue;n.push(s)});return n};var p=function(){var e=angular.copy(o.serviceCatalogs);var t=[];var i=[];for(var n=0;n<e.length;n++){for(var s in e[n]){if(e[n][s]&&e[n][s].allArr&&e[n][s].allArr.length>0){t=t.concat(e[n][s].allArr)}}}for(var a=0;a<t.length;a++){if(t[a].no||t[a].id){var r={};if(t[a].id){r.id=t[a].id}r.name=t[a].name;if(t[a].no){r.no=t[a].no}r.serviceCatalogId=t[a].serviceCatalogId;i.push(r)}}return i};var f=function(){o.activeStep=1;if(o.operationType==="add"){s()}else{n()}};var m=function(){if(o.robotList){f();return}if(o.showType==="chat"){v.sdk.OpenAutomatonApi().list({page:{pageSize:99999,pageNumber:1}}).then(function(e){e.list=e.list?_.filter(e.list,function(e){return e.active}):[];o.robotList=e.list;f()})}else{f()}};m();o.selectRobot=function(){o.robotList.forEach(function(e){if(o.assignRule.automatonId==e.id){o.robot=e}})};function g(){if(!o.currentAssignRule){return}if(!o.assignRule.assignAutomaticReply){return}var e={hasWelcome:false,hasWxWelcome:false,hasAutoReply:false,hasOfflineWelcome:false,hasOfflineAutoReply:false};switch(o.currentAssignRule.type){case"robot_first":e.hasOfflineAutoReply=true;if(o.assignRule.assignAutomaticReply.isMenu){e.hasWelcome=true;e.hasAutoReply=true;e.hasWxWelcome=true}break;case"person":e.hasWelcome=true;e.hasOfflineWelcome=true;e.hasOfflineAutoReply=true;if(o.assignRule.assignAutomaticReply.isMenu){e.hasAutoReply=true;e.hasWxWelcome=true}break;case"person_first":e.hasWelcome=true;e.hasOfflineAutoReply=true;if(o.assignRule.assignAutomaticReply.isMenu){e.hasAutoReply=true;e.hasWxWelcome=true}break;case"robot":break;default:}o.settings=JSON.parse(JSON.stringify(e));void 0}o.$watch("assignRule",function(){g()},true)}}(org.ewei);angular.module("eweiApp.ticket").controller("editSlaController",["$modal_","$scope","$state","$stateParams","$resource","$http","$filter","ticketTemplateNoteOptions","alertService","ticketSla","ConsoleConfig",function(e,s,t,i,n,a,r,o,d,l,c){var u=i.id;s.ticketSla=l;s.resolveHoursPattern="^\\d+(\\[1])?$";var p=angular.fromJson(localStorage.getItem("systemFieldPriority"));s.priority=angular.fromJson(p.customFieldOptions);s.eweiHelpcenterApiUrl=c.eweiHelpcenterApiUrl;if(l!==null){if(i.type==="copy"){s.ticketSla.id=0;s.ticketSla.isDefault=false}if(!s.ticketSla.serviceCatalogs){s.ticketSla.serviceDesk=null}else{s.ticketSla.serviceDesk=s.ticketSla.serviceCatalogs[0]}}else{s.ticketSla={id:0,p1_reply_hours:4,p1_reply_minutes:0,p2_reply_hours:8,p2_reply_minutes:0,p3_reply_hours:12,p3_reply_minutes:0,p4_reply_hours:16,p4_reply_minutes:0,p5_reply_hours:24,p5_reply_minutes:0,p1_resolve_hours:0,p1_resolve_days:3,p1_resolve_minutes:0,p2_resolve_hours:0,p2_resolve_days:5,p2_resolve_minutes:0,p3_resolve_hours:0,p3_resolve_days:10,p3_resolve_minutes:0,p4_resolve_hours:0,p4_resolve_days:15,p4_resolve_minutes:0,p5_resolve_hours:0,p5_resolve_days:22,p5_resolve_minutes:0,isDefault:false};if(!s.ticketSla.serviceCatalogs){s.ticketSla.serviceDesk=null}else{s.ticketSla.serviceDesk=s.ticketSla.serviceCatalogs[0]}}s.cancelEditSla=function(){t.go("system_setting.detail",{uri:"sla",settingType:"ticket"})};function f(e){var t=e.p1_reply_hours*60+e.p1_reply_minutes;var i=e.p2_reply_hours*60+e.p2_reply_minutes;var n=e.p3_reply_hours*60+e.p3_reply_minutes;var s=e.p4_reply_hours*60+e.p4_reply_minutes;var a=e.p5_reply_hours*60+e.p5_reply_minutes;if(t===0||i===0||n===0||s===0||a===0){d.add("响应耗时不能为0！","danger");return false}if(t>i||t>n||t>s||t>a){d.add("响应耗时P1-P5只能逐渐增加！","danger");return false}if(i>n||i>s||i>a){d.add("响应耗时P1-P5只能逐渐增加！","danger");return false}if(n>s||n>a){d.add("响应耗时P1-P5只能逐渐增加！","danger");return false}if(s>a){d.add("响应耗时P1-P5只能逐渐增加！","danger");return false}var r=e.p1_resolve_days*24*60+e.p1_resolve_hours*60+e.p1_resolve_minutes;var o=e.p2_resolve_days*24*60+e.p2_resolve_hours*60+e.p2_resolve_minutes;var l=e.p3_resolve_days*24*60+e.p3_resolve_hours*60+e.p3_resolve_minutes;var c=e.p4_resolve_days*24*60+e.p4_resolve_hours*60+e.p4_resolve_minutes;var u=e.p5_resolve_days*24*60+e.p5_resolve_hours*60+e.p5_resolve_minutes;if(r===0||o===0||l===0||c===0||u===0){d.add("处理耗时不能为0！","danger");return false}if(r>o||r>l||r>c||r>u){d.add("处理耗时P1-P5只能逐渐增加！","danger");return false}if(o>l||o>c||o>u){d.add("处理耗时P1-P5只能逐渐增加！","danger");return false}if(l>c||l>u){d.add("处理耗时P1-P5只能逐渐增加！","danger");return false}if(c>u){d.add("处理耗时P1-P5只能逐渐增加！","danger");return false}if(t>=r||i>=o||n>=l||s>=c||a>=u){d.add("处理时长必须大于响应时长！","danger");return false}return true}s.saveSla=function(e){s.isClick=true;if(e.serviceDesk){e.serviceCatalogs=[{id:e.serviceDesk.id,name:e.serviceDesk.name}];delete e.serviceDesk}else{e.serviceCatalogs=[]}if(e.id===0){}if(!f(e)){s.isClick=false;return}if(s.userGroupType===0){e.userGroups=null}else{var t=[];s.userGroupValue.forEach(function(e){t.push({id:e.id,name:e.name})});e.userGroups=t}a({url:"ticket_sla",method:"POST",data:e}).success(function(e,t,i,n){if(e.success){s.cancelEditSla()}else{s.isClick=false;if(e.message==="NAME_REPEAT"){d.add("名称不能重复","danger")}else if(e.message==="RULE_REPEAT"){d.add("SLA规则不能重复","danger")}else{d.add("保存失败,稍候再试","danger")}}})};var m={page:{pageNumber:1,pageSize:20},key:""};s.userGroupHasMore=true;s.userGroupTotal=0;s.userGroupList=[];s.userGroupType=s.ticketSla.userGroups&&s.ticketSla.userGroups.length>0?1:0;s.userGroupValue=[];if(s.ticketSla.userGroups){s.userGroupValue=s.ticketSla.userGroups}var g=function(i){org.ewei.sdk.OpenUserGroupApi().listUserGroup({page:m.page,key:m.key}).then(function(e){if(e.list){var t=[];e.list.forEach(function(e){t.push({id:e.id,name:e.name})});if(m.key===""){s.userGroupTotal=e.recordCount}if(i){s.userGroupList=_.union(s.userGroupList,t)}else{s.userGroupList=t}s.userGroupHasMore=s.userGroupList.length<e.recordCount}else{s.userGroupHasMore=false;s.userGroupList=[]}})};s.onSearch=function(e){m.key=e;m.page.pageNumber=1;g(false)};s.onLoadMore=function(){m.page.pageNumber+=1;g(true)};s.onLoad=function(){m.key="";m.page.pageNumber=1;g(false)};s.onChange=function(e,t){s.userGroupType=e;s.userGroupValue=t};s.onLoad()}]);+function(){"use strict";angular.module("eweiApp.system_setting").config(e);e.$inject=["$stateProvider","$urlRouterProvider"];function e(e,t){e.state("system_setting.detail.operation_log",{url:"/operation_log",templateUrl:"source/system-setting/company-setting/templates/operation-log.html",permission:"system_setting_operation_log",controller:"operation_log_controller",onEnter:["$state","$stateParams","coreModelService",function(e,t,i){i.config.route.put("system-setting.company-account",{name:this.name,params:t})}]}).state("system_setting.detail.sms_log",{url:"/sms_log",templateUrl:"source/system-setting/company-setting/templates/sms-log.html",controller:"sms_log_controller",permission:"system_setting_company_account",onEnter:["$state","$stateParams","coreModelService",function(e,t,i){i.config.route.put("system-setting.company-account",{name:this.name,params:t})}]}).state("system_setting.detail.provider",{url:"/provider",templateUrl:"source/system-setting/company-setting/templates/account.html",controller:"company_provider_controller",permission:"system_setting_company_account",onEnter:["$state","$stateParams","coreModelService",function(e,t,i){i.config.route.put("system-setting.company-account",{name:this.name,params:t})}]})}}();angular.module("eweiApp.system_setting").controller("company_account_controller",["$scope","$rootScope","$http","$state","$stateParams","$location","alertService","coreModelService","permissions",function(e,t,i,n,s,a,r,o,l){var c=o.config.route.get("system-setting.company-account");if(c){subRoute=c.name}else if(l.hasPermission("system_setting_company_account")){subRoute="system_setting.detail.provider"}else{subRoute="system_setting.detail.operation_log"}if(subRoute=="system_setting.detail.provider"&&!l.hasPermission("system_setting_company_account")){subRoute="system_setting.detail.operation_log"}if(subRoute=="system_setting.detail.operation_log"&&!l.hasPermission("system_setting_operation_log")){subRoute="system_setting.detail.provider"}n.go(subRoute,s);e.companyBuriedData={provider:"公司资料",license:"授权计划"}}]).controller("company_provider_controller",["$scope","$rootScope","$http","$state","$stateParams","$location","alertService","ConsoleConfig","$modal_","license","coreNotifyService","coreModelService","permissions","$filter",function(h,y,n,e,t,i,s,a,r,o,l,c,u,d){if(!u.hasPermission("system_setting_company_account")){e.go("unauthorized");return}y.currentSystemSettingCompanyState="system_setting.detail.provider";h.provider={};n.get("find_provider_by_admin_userId.json",{params:{providerId:a.provider.id}}).success(function(e){void 0;h.provider=angular.copy(e.provider);h.provider.providerNumber=e.providerNumber;if(h.provider.aloneDomain){h.provider.domain=h.provider.aloneDomain}else{h.provider.domain=window.location.hostname}if(e.user){h.provider.user=angular.copy(e.user)}else{h.provider.user={}}});h.updateProviderInf=function(){if(!h.provider.name){s.add("更新失败！","danger");return false}n({url:"provider_update.json",method:"POST",data:h.provider}).success(function(e){userAginLogin(e);if(e.success){s.add("更新成功！","success")}else{s.add("更新失败！","danger")}})};var p={free:"试用版",blend:"企业服务增强版",trial:"免费试用",public:"企业服务",professional:"专业版",enterprise:"企业版",enterprise_trial:"免费试用",enterprise_plus:"企业加强版",oem:"OEM版",online_service_basic:"标准版",enterprise_basic:"企业版",remote_assistance_basic:"专业版",enterprise_basic_19:"企业版"};var f=this.__proto__.constructor.name+"_"+(new Date).valueOf();function m(){l.register(f,l.constant.EVENT_LICENSE,function(e,t){_=c.config.license.get("license");v()})}function g(){l.unRegister(f)}m();h.$on("$destroy",function(){g()});h.providerInfObj={};var _=h.providerLicense=o.init();void 0;function k(){if(_.type!=="enterprise_basic_19")return;org.ewei.sdk.OpenProviderApi().countProviderVolumeSizeByType({authorizeDeadline:_.authorizeDeadline}).then(function(e){if(!e)e=[];var t=[{id:"ticket",name:"工单",color:"#CC0000"},{id:"chat",name:"会话",color:"#3399FF"},{id:"article",name:"文章",color:"#FFCC66"},{id:"question",name:"贴子",color:"#339900"},{id:"file",name:"附件",color:"#D7D7D7"}];h.usageList=[];var s=0;var i=null;e.forEach(function(e){s+=e.size});_.allSizeEnterpriseBasic19=s;var n=_.yearAddDataCapacity*1024*1024*1024;if(n>0){i={id:"empty",name:"empty",color:"#F2F2F2",percent:((n-s)/n).toFixed(6)*100+"%",usage:n-s};h.usagePercent=(s/n).toFixed(2)*100+"%";s=n}t.forEach(function(t){var i=0;var n="0%";e.forEach(function(e){if(t.id===e.type){i=e.size;n=(e.size/s).toFixed(6)*100+"%"}});h.usageList.push({id:t.type,name:t.name,color:t.color,usage:i,percent:n})});if(i){h.usageList.push(i)}})}function C(){var e=_.useDataCapacity===-1?"无限制":_.useDataCapacity+"GB";if(_.type==="enterprise_basic_19"){e=_.yearAddDataCapacity===-1?"无限制":_.yearAddDataCapacity+"GB"}switch(h.providerInfObj.typeE){case"enterprise_basic_19":h.storageUsageText="年新增数据量 "+e;break;case"enterprise_basic":h.storageUsageText="存储空间总量 "+e;if(_.is_cover_data){h.storageUsageText="存储空间总量 "+e+"（循环覆盖历史数据）"}break;case"remote_assistance_basic":h.storageUsageText="无限制";break;case"online_service_basic":h.storageUsageText="日新增工单"+h.providerInfObj.engineerCount*10+"张";break;default:h.storageUsageText="-"}}v();function v(){if(_&&_.type&&p[_.type]){h.providerInfObj.type=p[_.type];h.providerInfObj.typeE=_.type;if(_.authorizeDeadline){h.providerInfObj.authorizeDeadline=_.authorizeDeadline.substr(0,10);var e=new Date(_.now.substr(0,10).replace(/-/g,"/"));var t=new Date(_.authorizeDeadline.replace(/-/g,"/"));var i=parseInt((t.getTime()-e.getTime())/(1e3*60*60*24));h.providerInfObj.days=i}h.providerInfObj.accountBalance=_.accountBalance;h.providerInfObj.licenseStatus=_.licenseStatus;h.providerInfObj.useDataCapacity=_.useDataCapacity;h.providerInfObj.attachmentSize=(_.attachmentSize/1024/1024/1024).toFixed(2);h.providerInfObj.residueRate=((1-h.providerInfObj.attachmentSize/h.providerInfObj.useDataCapacity)*100).toFixed(2);if(h.providerInfObj.residueRate>=30){h.providerInfObj.color="#FF9900"}else if(h.providerInfObj.residueRate<30){h.providerInfObj.color="#FF0000"}h.providerInfObj.engineerCount=_.engineerCount;h.providerInfObj.smsInfo=_.smsInfo;h.providerInfObj.isOpenSmsNotify=_.isOpenSmsNotify;n.get("/api/v1/ewei_helpdesk_prise.json").success(function(e){var t=[],i=[];if(e.result&&e.result.productType&&e.result.modulePrise){t=e.result.modulePrise;i=e.result.servicePrise;var n=e.result.productType;for(var s=0;s<n.length;s++){if(n[s].type===h.providerInfObj.typeE){var a=n[s].standardModuleList||[];var r=_.moduleList||[];var o=_.serviceList||{};var l=[];var c=[];for(var u=0;u<r.length;u++){var d=false;for(var p=0;p<a.length;p++){if(r[u]===a[p]){d=true;break}}if(!d){for(var f=0;f<t.length;f++){if(r[u]===t[f].service){l.push(t[f]);break}}}}l.forEach(function(e,t,i){if(e.service==="remote_maintain"){e.serviceName+="("+y.providerLicense.limit_ve_count+"台)"}});h.providerInfObj.canCheckedFunctionModule=l;for(var m in o){for(var g=0;g<i.length;g++){if(i[g].service===m){var v={serviceName:i[g].serviceName,no:o[m]};c.push(v);break}}}}}k();C()}})}}h.openSmsNotify=function(){if(h.providerInfObj.smsInfo&&h.providerInfObj.smsInfo.availableSmsCount<=0){var e=r({scope:h,title:"提示",contentTemplate:"source/scripts/directives/alert-sms/alert-sms.html",html:true,show:true,placement:"center"});h.$hide=function(){e.$promise.then(e.hide)};h.providerInfObj.isOpenSmsNotify=!h.providerInfObj.isOpenSmsNotify;return}org.ewei.sdk.OpenProviderApi().updateIsOpenSmsNotify({providerId:a.provider.id,isOpenSmsNotify:h.providerInfObj.isOpenSmsNotify}).then(function(e){_.isOpenSmsNotify=h.providerInfObj.isOpenSmsNotify;c.config.license.put("license",_)})};var b=r({scope:h,template:"checked-function.html",contentTemplate:"checked-function-content.html",html:true,show:false,title:"选配功能",placement:"center"});n.post("get_ewei_admin_api_url.json").success(function(e){if(e.success){if(e.json.indexOf("http://")!=0&&e.json.indexOf("https://")!=0){h.eweiAdminApiUrl="http://"+e.json}else{h.eweiAdminApiUrl=e.json}}});h.pay=function(){var e={chargeType:"expanded",remainingCapacity:h.providerInfObj.useDataCapacity-h.providerInfObj.attachmentSize,engineerCount:h.providerInfObj.engineerCount};if(e.chargeType=="expanded"){expanded.action=h.eweiAdminApiUrl+"order_service_page?chargeType="+e.chargeType+"&remainingCapacity="+e.remainingCapacity+"&engineerCount="+e.engineerCount;expanded.submit()}else{}};h.paySms=function(){expanded.action=h.eweiAdminApiUrl+"sms_order_service_page";expanded.submit()}}]).directive("showOrHideInput",function(){return{restrict:"EA",scope:true,link:function(e,t,i){var n=t[0].querySelectorAll("input:not([disabled])");for(var s=0;s<n.length;s++){$(n[s]).mouseenter(function(){$(this).removeClass("hide_input");$(this).addClass("show_input")});$(n[s]).mouseleave(function(){$(this).removeClass(".show_input");$(this).addClass("hide_input")});$(n[s]).keypress(function(e){if(e.which==13){$(this).blur();e.preventDefault()}})}}}}).controller("company_license_controller",["$scope","$rootScope","$http","$state","$stateParams","$location","alertService","license","$modal_","$sce","ConsoleConfig","coreModelService","coreNotifyService","timeService",function(t,e,i,n,s,a,r,o,l,c,u,d,p,f){i.get("/api/v1/ewei_provider_order_list.json",{params:{provider_id:u.provider.id,_token:getCookie("user_token")}}).success(function(e){void 0;if(e.status===0&&e.result){t.payRecordObj=e.result}});e.currentSystemSettingCompanyState="system_setting.detail.license";t.eweiAdminApiUrlSce="";t.currentProviderId=u.provider.id;i.post("get_ewei_admin_api_url.json").success(function(e){if(e.success){if(e.json.indexOf("http://")!=0&&e.json.indexOf("https://")!=0){t.eweiAdminApiUrl="http://"+e.json}else{t.eweiAdminApiUrl=e.json}t.eweiAdminApiUrlSce=c.trustAsResourceUrl(t.eweiAdminApiUrl+"upgrade_serve.html")}})}]);angular.module("eweiApp.system_setting").controller("sms_log_controller",["$scope","$rootScope","NgTableParams",function(n,e,t){var s={pageNumber:1,pageSize:20};function i(){n.tableParams=n.tableParams||new t({page:s.pageNumber,count:s.pageSize},{counts:[],total:0,getData:function(t,i){s.pageNumber=angular.copy(i.page());org.ewei.sdk.OpenSmsSendLogApi().list({page:s}).then(function(e){n.datas=e.list;i.total(e.recordCount);t.resolve(n.datas)})}})}i()}]);(function(){"use strict";angular.module("eweiApp.system_setting").controller("operation_log_controller",e).controller("log_dynamic_controller",t);e.$inject=["$rootScope","$scope","$state","$http","$upload","$timeout","$stateParams","$location","alertService","engineerService","permissionsService","ConsoleConfig","coreModelService","coreNotifyService","apiLogService","permissions"];function e(e,t,i,n,s,a,r,o,l,c,u,d,p,f,m,g){t.eweiHelpcenterApiUrl=d.eweiHelpcenterApiUrl;if(!g.hasPermission("system_setting_operation_log")){i.go("unauthorized");return}var v=this.__proto__.constructor.name+"_"+Date.now();var h="list.operation_logs";var y={_page:1,_count:20};var _;t.isMore={show:false,page:1,loading:false};function k(){b();C()}function C(){var e=JSON.stringify(y)===JSON.stringify(_);t.isMore.loading=!e;t.operationLogs=m.getOperationLogs(h,y,e,true,function(e){t.isMore.loading=false;if(e.result&&e.result.operationLogs&&e.result.operationLogs.length==y._count){t.isMore.show=true}else{t.isMore.show=false}});_=angular.copy(y)}function b(){f.register(v,f.constant.EVENT_LIST_LOG_REFRESH,function(e){C()})}function w(){f.unRegister(v)}k();t.$on("$destroy",function(){w()});t.more=function(){y._page++;t.isMore.loading=true;C()}}t.$inject=["$state","$scope","permissions"];function t(e,t,i){if(i.hasPermission("system_setting_operation_log")){t.logShow=true}e.go("system_setting.detail.log")}})();(function(){"use strict";angular.module("com.ewei.angular.ui").directive("colorPercentBar",e).controller("colorPercentBarController",t);e.$inject=[];function e(){return{restrict:"EA",replace:true,templateUrl:"source/system-setting/company-setting/directive/color-percent-bar.html",controller:"colorPercentBarController",scope:{usageList:"=",usagePercent:"="}}}t.$inject=["$scope","$modal_","alertService"];function t(e,t,i){}})();angular.module("eweiApp.system_setting").controller("roles_controller",["$scope","$state","$stateParams","roleService","$modal_","$rootScope","ConsoleConfig","alertService","$location","permissions","coreNotifyService","coreModelService","apiRoleListService",function(a,i,e,s,r,n,t,o,l,c,u,d,p){a.eweiHelpcenterApiUrl=t.eweiHelpcenterApiUrl;var f=this.__proto__.constructor.name+"_"+Date.now();a.search=function(e){if(a.searchKey){var t=a.copyRoles;var i=[];for(var n=0;n<t.length;n++){if(t[n].name.indexOf(e)!=-1){i.push(t[n])}}a.defineRoles=i;var s="创始人";if(s.indexOf(e)==-1){a.defaultRoles=[]}else{a.defaultRoles=a.copyDefaultRoles}}else{a.defineRoles=a.copyRoles}};a.clearSearch=function(){a.defineRoles=a.copyRoles;a.defaultRoles=a.copyDefaultRoles;a.searchKey=""};a.addRole=function(){if(n.providerLicense.type=="blend"||n.providerLicense.type=="public"||n.providerLicense.type=="trial"||n.providerLicense.type=="enterprise"||n.providerLicense.type=="enterprise_trial"||n.providerLicense.type=="enterprise_plus"||n.providerLicense.type=="oem"||n.providerLicense.type=="online_service_basic"||n.providerLicense.type=="remote_assistance_basic"||n.providerLicense.type=="enterprise_basic"||n.providerLicense.type=="enterprise_basic_19"){i.go("system_setting.role_create")}else{var e=r({scope:a,title:"提示",contentTemplate:"source/views/fun_restriction_reminder.html",html:true,show:true,placement:"center"});a.hasPermission=true;a.tipNotSupportService="当前服务版本不支持此功能，请升级服务后再试。";a.goAuthorization=function(){void 0;if(c.hasPermission("system_setting_company_account")){i.go("system_setting.detail.provider",{uri:"company_account",settingType:"system"});e.$promise.then(e.hide)}else{a.hasPermission=false;a.tipNotSupportService="很抱歉，你没有访问授权计划的权限"}};a.hideModal_=function(){e.$promise.then(e.hide)}}};a.cloneRole=function(e){if(n.providerLicense.type=="blend"||n.providerLicense.type=="public"||n.providerLicense.type=="trial"||n.providerLicense.type=="enterprise"||n.providerLicense.type=="enterprise_trial"||n.providerLicense.type=="enterprise_plus"||n.providerLicense.type=="oem"||n.providerLicense.type=="online_service_basic"||n.providerLicense.type=="remote_assistance_basic"||n.providerLicense.type=="enterprise_basic"||n.providerLicense.type=="enterprise_basic_19"){i.go("system_setting.role_edit",{id:e,type:"copy"})}else{var t=r({scope:a,title:"提示",contentTemplate:"source/views/fun_restriction_reminder.html",html:true,show:true,placement:"center"});a.hasPermission=true;a.tipNotSupportService="当前服务版本不支持此功能，请升级服务后再试。";a.goAuthorization=function(){void 0;if(c.hasPermission("system_setting_company_account")){i.go("system_setting.provider",{uri:"company_account",settingType:"system"});t.$promise.then(t.hide)}else{a.hasPermission=false;a.tipNotSupportService="很抱歉，你没有访问授权计划的权限"}};a.hideModal_=function(){t.$promise.then(t.hide)}}};a.showEditDiv=function(e){var t=$("#role_showEditDiv"+e);t.css("display","none");t.next().css("display","block")};a.hiddenEditDiv=function(e){var t=$("#role_hiddenEditDiv"+e);t.css("display","none");t.prev().css("display","block")};a.roleEditBuried=function(){_hmt.push(["_trackEvent","角色","编辑角色"])};a.deleteRole=function(e,t,i){_hmt.push(["_trackEvent","角色","删除角色"]);a.confirmContent="是否确定要删除此角色 "+t+"？删除后，关联此角色的客服将自动绑定到默认的“客服”角色。";var n=r({scope:a,title:"确认",contentTemplate:"source/views/confirm_template.html",html:true,show:true,placement:"center"});a.hideModal=function(){n.$promise.then(n.hide)};a.$ok=function(){s["delete"]({id:e},function(e){a.hideModal();if(e.success){a.defineRoles.splice(i,1)}else{o.add("删除角色失败","danger")}})}};a.shareRole=function(e,t){_hmt.push(["_trackEvent","角色","分享"]);var i=r({scope:a,title:"分享角色",contentTemplate:"source/views/system_setting/share_role.html",html:true,show:true,placement:"center"});a.hideModal=function(){i.$promise.then(i.hide)};a.$ok=function(){a.hideModal()}};a.addRoleBuried=function(){_hmt.push(["_trackEvent","角色","添加角色"])};function m(e,t){a.defaultRoles=t;a.copyDefaultRoles=angular.copy(a.defaultRoles);a.defineRoles=e;a.copyRoles=angular.copy(a.defineRoles)}function g(){p.run("default",u.constant.EVENT_LIST_ROLES,"","",{_count:999,_do_count:false,_fields:"id,name,nameKey,updatedAt,updater.id,updater.name",_filter:"{'$and':[{'$is_null':['provider.id']},{'$eq':{'type':'engineer'}},{'$eq':{'nameKey':'ROLE_NAME_CREATOR'}}]}",_asc:"createdAt"},function(e){});p.run("define",u.constant.EVENT_LIST_ROLES,"","",{_count:999,_do_count:false,_fields:"id,name,nameKey,updatedAt,updater.id,updater.name",_filter:" {'$and':[{'$eq':{'provider.id':${current_provider_id}}},{'$eq':{'type':'engineer'}}]}",_asc:"createdAt"},function(e){})}function v(){var e=d.detail.roles.gets(d.list.roles["define"].getAll());var t=d.detail.roles.gets(d.list.roles["default"].getAll());m(e,t)}function h(){var i=0;u.register(f,u.constant.EVENT_LIST_ROLES,function(e,t){if(t=="define"||t=="default"){i++}if(i==2){v()}})}function y(){v();g()}function _(){h();y()}_();function k(){u.unRegister(f)}a.$on("$destroy",function(){k()})}]).controller("roleAddController",["$scope","$rootScope","$state","$http","$filter","alertService","roleService","$stateParams","ConsoleConfig","coreNotifyService","coreModelService","apiCustomerDefaultRolesService",function(i,e,s,t,a,r,n,o,l,c,u,d){i.myRoleNameKey=l.engineer.role.nameKey;var p=this.__proto__.constructor.name+"_"+Date.now();i.engineerAccessScopes=[{label:"全部客服组(含组内客服，下同)",value:"all_engineers"},{label:"本人所在的客服组及协同客服组",value:"your_and_joint_service_desk_engineers"},{label:"本人所在的客服组",value:"your_service_desks_engineers"}];i.customerAccessScopes=[{label:"全部客户组(含组内客户，下同)",value:"all_customers"},{label:"本人所在的客服组绑定的客户组",value:"your_service_desks_user_groups_customers"},{label:"本人创建客户和客户组",value:"your_create_customer_or_groups_customers"}];i.ticketAccessScopes=[{label:"全部工单",value:"all_tickets"},{label:"本人所在客服组的工单",value:"your_service_desks_tickets"},{label:"本人创建的、处理中的和被抄送的工单",value:"your_tickets"}];i.chatAccessScopes=[{label:"全部会话",value:"all_chats"},{label:"本人所在客服组的会话",value:"your_service_desks_chats"},{label:"仅本人创建的、处理中的和参与的会话",value:"your_chats"}];i.projectAccessScopes=[{label:"全部项目",value:"all_project"},{label:"可见分类下的全部项目",value:"visible_category_project"},{label:"仅本人创建和被分享的项目",value:"my_project"}];i.communityAccessScopes=[];i.reportAccessScopes=[{label:"全部数据",value:"all_report"},{label:"本人所在客服组的数据",value:"your_service_desks_report"},{label:"仅本人的数据",value:"your_report"}];i.callAccessScopes=[{label:"全部通话",value:"all_call_records"},{label:"本人所在客服组的通话",value:"your_service_desks_call_records"},{label:"我的通话",value:"your_call_records"}];i.engineerAccessScope=i.engineerAccessScopes[1];i.ticketAccessScope=i.ticketAccessScopes[1];i.customerAccessScope=i.customerAccessScopes[1];i.chatAccessScope=i.chatAccessScopes[1];i.reportAccessScope=i.reportAccessScopes[1];i.projectAccessScope=i.projectAccessScopes[2];i.callAccessScope=i.callAccessScopes[1];i.formEditable=true;i.role={};i.checkboxes={chat_reception:true,helpcenter_website_manage:true,ticket_create:true,ticket_update:true,ticket_export:true,customer_delete:true,customer_merge:true,customer_export:true,customer_import:true,customer_view_manage:true,ticket_public_reply:true,customer_blacklist_manage:true,ticket_private_reply:true,ticket_suspended:true,ticket_delete:true,ticket_merge:true,ticket_reply:true,ticket_print:true,ticket_detail_export:true,ticket_review:true,ticket_view_manage:true,ticket_suspended_manage:true,ticket_deleted_manage:true,chat_create:true,chat_delete:true,chat_transfer:true,chat_invite:true,chat_shows_busy:true,ticket_performance_statistics:true,ticket_distributed_statistics:true,customer_analyze_statistics:true,statistics_export:true,custom_statistics_report:true,customer_create:true,customer_update:true,customer_change_group:true,customer_into_blacklist:true,customer_group_create:true,customer_group_update:true,customer_group_delete:true,customer_blacklist:true,statistics_ticket:true,system_setting_my_account:true,ticket_reply_pending:true,ticket_reply_solved:true,ticket_force_handle:true,ticket_operate_log:true,service_report:true,statistics_engineer_performance:true,statistics_ticket_statistics:true,statistics_chat_statistics:true,statistics_customer_statistics:true};angular.forEach(i.permissionses,function(e){if(angular.isDefined(e.id)){i.checkboxes.items[e.id]=value}});var f=function(){var e=[];for(var t in i.checkboxes){if(i.checkboxes[t]){e.push(t)}}return e.join(",")};var m=function(){var e=[];e.push({type:"ticket",scope:i.ticketAccessScope.value});e.push({type:"customer",scope:i.customerAccessScope.value});e.push({type:"engineer",scope:i.engineerAccessScope.value});e.push({type:"chat",scope:i.chatAccessScope.value});e.push({type:"report",scope:i.reportAccessScope.value});e.push({type:"project",scope:i.projectAccessScope.value});e.push({type:"call_record",scope:i.callAccessScope.value});return e};i.backRoleBuried=function(){_hmt.push(["_trackEvent","角色-添加角色","取消"])};var g=true;i.save=function(){if(g){g=false;_hmt.push(["_trackEvent","角色-添加角色","确认"]);var e=i.role.name;if(e!=null&&e!=""){if(e=="管理员"||e=="客服"||e=="ROLE_NAME_ADMIN"||e=="ROLE_NAME_ENGINEER"||e=="创始人"||e=="ROLE_NAME_CREATOR"){r.add(a("translate")("ROLE_NAME_IS_NOT_UNIQUE"),"danger")}else{t({url:"role_add.json",method:"POST",data:{name:i.role.name,communityRole:{id:i.communityAccessScope.value},permissions:f(),accessScopes:m()}}).success(function(e,t,i,n){if(e.id){s.go("system_setting.detail",{uri:"roles",settingType:"engineers"})}else{if(e.message!=null){r.add(a("translate")(e.message),"danger")}else{r.add("添加新角色失败","danger")}}g=true})}}}};var v=function(){i.communityAccessScopes=[];angular.forEach(i.customerDefaultRoles,function(e){var t={label:a("translate")(e.name),value:e.id};i.communityAccessScopes.push(t)});i.communityAccessScope=i.communityAccessScopes[1]};function h(){d.run("customerDefaultRoles",c.constant.EVENT_DETAIL_CUSTOMERDEFAULTROLES,"","",{_count:999,_do_count:false,_fields:"id,name",_filter:"{'$and':[{'$is_null':['provider.id']},{'$eq':{'type':'customer'}}]}"},function(e){})}function y(){i.customerDefaultRoles=u.detail.customerDefaultRoles.get("customerDefaultRoles");if(!i.customerDefaultRoles){return}v()}function _(){c.register(p,c.constant.EVENT_DETAIL_CUSTOMERDEFAULTROLES,function(e,t){y()})}function k(){y();h()}function C(){_();k()}C();function b(){c.unRegister(p)}i.$on("$destroy",function(){b()})}]).controller("roleUpdateController",["$scope","$rootScope","$state","$filter","$http","alertService","$stateParams","roleService","ConsoleConfig","coreNotifyService","coreModelService","apiAccessScopeService","apiPermissionsesService","apiCustomerDefaultRolesService","apiRoleService",function(g,e,s,a,t,r,i,n,o,l,c,u,d,p,f){g.myRoleNameKey=o.engineer.role.nameKey;var m=this.__proto__.constructor.name+"_"+Date.now();g.engineerAccessScopes=[{label:"全部客服组(含组内客服，下同)",value:"all_engineers"},{label:"本人所在的客服组及协同客服组",value:"your_and_joint_service_desk_engineers"},{label:"本人所在的客服组",value:"your_service_desks_engineers"}];g.customerAccessScopes=[{label:"全部客户组(含组内客户，下同)",value:"all_customers"},{label:"本人所在的客服组绑定的客户组",value:"your_service_desks_user_groups_customers"},{label:"本人创建客户和客户组",value:"your_create_customer_or_groups_customers"}];g.ticketAccessScopes=[{label:"全部工单",value:"all_tickets"},{label:"本人所在客服组的工单",value:"your_service_desks_tickets"},{label:"本人创建的、处理中的和被抄送的工单",value:"your_tickets"}];g.chatAccessScopes=[{label:"全部会话",value:"all_chats"},{label:"本人所在客服组的会话",value:"your_service_desks_chats"},{label:"本人创建的、处理中的和参与的会话",value:"your_chats"}];g.projectAccessScopes=[{label:"全部项目",value:"all_project"},{label:"可见分类下的全部项目",value:"visible_category_project"},{label:"仅本人创建和被分享的项目",value:"my_project"}];g.communityAccessScopes=[];g.reportAccessScopes=[{label:"全部数据",value:"all_report"},{label:"本人所在客服组的数据",value:"your_service_desks_report"},{label:"仅本人的数据",value:"your_report"}];g.callAccessScopes=[{label:"全部通话",value:"all_call_records"},{label:"本人所在客服组的通话",value:"your_service_desks_call_records"},{label:"我的通话",value:"your_call_records"}];var v;var h=function(){if(!g.role){return}v=g.role.name;g.roleName=angular.copy(g.role.name);if(g.role.nameKey=="ROLE_NAME_CREATOR"){g.formEditable=false}else{g.formEditable=true}if(g.role==null){r.add(a("translate")(response.message),"danger")}else{g.role.name=a("translate")(g.role.name)}};var y=function(){if(!g.customerDefaultRoles||!g.role||!g.role.communityRole){return}if(g.communityAccessScopes.length==0){angular.forEach(g.customerDefaultRoles,function(e){var t={label:a("translate")(e.name),value:e.id};g.communityAccessScopes.push(t)})}for(var e=0;e<g.communityAccessScopes.length;e++){var t=g.communityAccessScopes[e];if(t.value==g.role.communityRole.id){g.communityAccessScope=t;break}}};var _=function(){g.checkboxes={};angular.forEach(g.permissionses,function(e){g.checkboxes[e]=true})};var k=function(){if(g.accessScopes==null||angular.equals({},g.accessScopes)){return}var e=C("ticket");for(var t=0;t<g.ticketAccessScopes.length;t++){var i=g.ticketAccessScopes[t];if(i.value==e){g.ticketAccessScope=i;break}}var n=C("customer");for(var t=0;t<g.customerAccessScopes.length;t++){var s=g.customerAccessScopes[t];if(s.value==n){g.customerAccessScope=s;break}}var a=C("engineer");for(var t=0;t<g.engineerAccessScopes.length;t++){var r=g.engineerAccessScopes[t];if(r.value==a){g.engineerAccessScope=r;break}}var o=C("chat");for(var t=0;t<g.chatAccessScopes.length;t++){var l=g.chatAccessScopes[t];if(l.value==o){g.chatAccessScope=l;break}}var c=C("report");for(var t=0;t<g.reportAccessScopes.length;t++){var u=g.reportAccessScopes[t];if(u.value==c){g.reportAccessScope=u;break}}var d=C("project");for(var t=0;t<g.projectAccessScopes.length;t++){var p=g.projectAccessScopes[t];if(p.value==d){g.projectAccessScope=p;break}}var f=C("call_record");for(var t=0;t<g.callAccessScopes.length;t++){var m=g.callAccessScopes[t];if(m.value==f){g.callAccessScope=m;break}}};var C=function(e){for(var t in g.accessScopes){if(g.accessScopes[t].type==e){return g.accessScopes[t].scope}}};var b=function(){var e=[];for(var t in g.checkboxes){if(g.checkboxes[t]){e.push(t)}}return e.join(",")};var w=function(){var e=[];e.push({type:"ticket",scope:g.ticketAccessScope.value});e.push({type:"customer",scope:g.customerAccessScope.value});e.push({type:"engineer",scope:g.engineerAccessScope.value});e.push({type:"chat",scope:g.chatAccessScope.value});e.push({type:"report",scope:g.reportAccessScope.value});e.push({type:"project",scope:g.projectAccessScope.value});e.push({type:"call_record",scope:g.callAccessScope.value});return e};g.backRoleBuried=function(){_hmt.push(["_trackEvent","角色-编辑角色","取消"])};g.save=function(){var e=g.role.name;if(e!=null&&e!=""&&g.ticketAccessScope!=null&&g.customerAccessScope!=null&&g.engineerAccessScope!=null&&g.chatAccessScope!=null&&g.reportAccessScope!=null&&g.communityAccessScope!=null){if(i.type=="update"){t({url:"role_update.json",method:"POST",data:{id:g.role.id,name:g.role.name,permissions:b(),accessScopes:w(),communityRole:{id:g.communityAccessScope.value}}}).success(function(e,t,i,n){if(e.success){s.go("system_setting.detail",{uri:"roles",settingType:"engineers"});g.roleName=angular.copy(g.role.name)}else{if(e.message!=null){r.add(a("translate")(e.message),"danger")}else{r.add("修改角色失败","danger")}}})}else{if(e=="管理员"||e=="客服"||e=="ROLE_NAME_ADMIN"||e=="ROLE_NAME_ENGINEER"||e=="创始人"||e=="ROLE_NAME_CREATOR"){r.add(a("translate")("ROLE_NAME_IS_NOT_UNIQUE"),"danger")}else{t({url:"role_add.json",method:"POST",data:{name:g.role.name,permissions:b(),accessScopes:w(),communityRole:{id:g.communityAccessScope.value}}}).success(function(e,t,i,n){if(e.id){s.go("system_setting.detail",{uri:"roles",settingType:"engineers"})}else{if(e.message!=null){r.add(a("translate")(e.message),"danger")}else{r.add("克隆角色失败","danger")}}})}}}else{r.add("请选择可见范围","danger")}};function T(){u.run("accessScope",l.constant.EVENT_DETAIL_ACCESSSCOPE,"",i.id,{_count:999,_do_count:false,_fields:"type,scope",_filter:"{'$eq':{'role.id':"+i.id+"}}"},function(e){});d.run("permissionses",l.constant.EVENT_DETAIL_PERMISSIONSES,"",{roleId:i.id},"",function(e){});p.run("customerDefaultRoles",l.constant.EVENT_DETAIL_CUSTOMERDEFAULTROLES,"","",{_count:999,_do_count:false,_fields:"id,name",_filter:"{'$and':[{'$is_null':['provider.id']},{'$eq':{'type':'customer'}}]}"},function(e){});f.run("role",l.constant.EVENT_DETAIL_ROLES,"",i.id,"",function(e){})}function S(e){if(e=="all"){g.accessScopes=c.detail.accessScope.get(i.id);k();g.permissionses=c.detail.permissionses.get(i.id);_();g.role=c.detail.roles.get(i.id);h();g.customerDefaultRoles=c.detail.customerDefaultRoles.get("customerDefaultRoles");y()}else if(e=="accessScope"){g.accessScopes=c.detail.accessScope.get(i.id);k()}else if(e=="permissionses"){g.permissionses=c.detail.permissionses.get(i.id);_()}else if(e=="role"){g.role=c.detail.roles.get(i.id);h();y()}else{g.customerDefaultRoles=c.detail.customerDefaultRoles.get("customerDefaultRoles");y()}}function F(){l.register(m,l.constant.EVENT_DETAIL_ACCESSSCOPE,function(e,t){S(t)});l.register(m,l.constant.EVENT_DETAIL_PERMISSIONSES,function(e,t){S(t)});l.register(m,l.constant.EVENT_DETAIL_CUSTOMERDEFAULTROLES,function(e,t){S(t)});l.register(m,l.constant.EVENT_DETAIL_ROLES,function(e,t){S(t)})}function A(){S("all");T()}function E(){F();A()}E();function $(){l.unRegister(m)}g.$on("$destroy",function(){$()})}]);angular.module("eweiApp.system_setting").controller("tag_setting_controller",["$scope","$state","$stateParams","$http","tagService","alertService","$rootScope","ConsoleConfig",function(i,e,t,n,s,a,r,o){i.eweiHelpcenterApiUrl=o.eweiHelpcenterApiUrl;s.query({_count:999,_do_count:false,_asc:"name"},function(e){i.tags=e.tags});i.add=function(){_hmt.push(["_trackEvent","标签","添加标签"]);if(i.tag&&i.tag.name&&i.tag.name.length>16){a.add("标签名称请限定在16个字符长度内","danger");return false}n.post("tag_add",i.tag).success(function(e){if(e.success){i.tags.push(i.tag);i.tag=null}else{if(e.message!=null){a.add(e.message,"danger")}else{a.add("添加失败！")}}})};i.show_deleteBtn=function(e){i.tags[e].deleteBtnVisible=true};i.hide_deleteBtn=function(e){i.tags[e].deleteBtnVisible=false};i["delete"]=function(t){_hmt.push(["_trackEvent","标签","删除标签"]);if(confirm("您确认要删除 <"+i.tags[t].name+"> 标签吗?")){s["delete"]({id:i.tags[t].id},function(e){if(e.success){i.tags.splice(t,1)}})}}}]);angular.module("eweiApp.system_setting").controller("email_setting_controller",["$rootScope","$scope","$state","$location","$http","alertService","license","ConsoleConfig","$modal_","permissions","providerJudgement","apiBrandSettingService","coreModelService","coreNotifyService",function(t,s,i,e,n,a,r,o,l,c,u,d,p,f){s.eweiHelpcenterApiUrl=o.eweiHelpcenterApiUrl;s.defaultTemplet=$("#email_setting_defaultTemplet").val();s.contentTag="{{content}}";s.emailSetting=null;var m=f.constant.EVENT_DETAIL_BRAND_SETTING_EMAIL;var g=this.__proto__.constructor.name+"_"+(new Date).valueOf();var v=function(){f.register(g,m,function(e){y()})};var h=function(){y();_()};var y=function(){s.emailSetting=p.config.brandSetting.emailSetting||{}};var _=function(){d.getEmailSetting(m,"","",function(e){})};var k=function(){v();h()};k();var C=function(){f.unRegister(g)};s.$on("$destroy",function(){C()});s.restoreDefaultSender=function(){_hmt.push(["_trackEvent","通知邮件","恢复默认发件箱"]);s.emailSetting.senderAddress="support@"+o.provider.subDomain+".ewei.com"};s.update=function(){if(false==verifyEmailAddress(s.emailSetting.senderAddress)){a.add("通知邮件发件箱格式错误","danger");return}n({url:"email_setting.json",method:"POST",data:s.emailSetting}).success(function(e,t,i,n){if(e.success){s.emailSetting.id=e.id;a.add("保存成功")}else{a.add("保存失败","danger")}})};var b;t.$watch("providerLicense",function(){if(t.providerLicense!=null){b=r.type()}});s.updateEmailSetting=function(){if(t.providerLicense.type=="blend"||t.providerLicense.type=="public"||t.providerLicense.type=="trial"||t.providerLicense.type=="enterprise"||t.providerLicense.type=="enterprise_trial"||t.providerLicense.type=="enterprise_plus"||t.providerLicense.type=="oem"||t.providerLicense.type=="online_service_basic"||t.providerLicense.type=="remote_assistance_basic"||t.providerLicense.type=="enterprise_basic"||t.providerLicense.type=="enterprise_basic_19"){_hmt.push(["_trackEvent","通知邮件","更新通知邮件"]);if(b=="trial"||b=="free"){a.add("您的服务计划不包含此项功能，请先升级为企业版再试！","danger");return}if(!u.isTrue()){return false}s.update()}else{var e=l({scope:s,title:"提示",contentTemplate:"source/views/fun_restriction_reminder.html",html:true,show:true,placement:"center"});s.hasPermission=true;s.tipNotSupportService="当前服务版本不支持此功能，请升级服务后再试。";s.goAuthorization=function(){void 0;if(c.hasPermission("system_setting_company_account")){i.go("system_setting.detail.provider",{uri:"company_account",settingType:"system"});e.$promise.then(e.hide)}else{s.hasPermission=false;s.tipNotSupportService="很抱歉，你没有访问授权计划的权限"}};s.hideModal_=function(){e.$promise.then(e.hide)}}};s.restoreDefaultTemplet=function(){s.emailSetting.emailTemplet=s.defaultTemplet};s.previewTemplate=function(){var e=window.open("","newWindow"+Math.random(),"height=500,width=800,scrollbars=auto");if(e!=null){e.document.write(s.emailSetting.emailTemplet);e.focus()}}}]);angular.module("eweiApp.system_setting").controller("service_desks_controller",["$scope","$state","serviceDesks","$filter","ConsoleConfig","alertService","permissions","coreNotifyService","coreModelService","apiServiceDeskService","providerJudgement",function(s,i,n,a,e,r,t,o,l,c,u){var d=this.__proto__.constructor.name+"_"+Date.now();s.isShowLine=false;s.serviceDesks=[];if(t.hasPermission("service_desk_update")&&t.hasPermission("service_desk_delete")){s.isShowLine=true}s.eweiHelpcenterApiUrl=e.eweiHelpcenterApiUrl;s.search=function(e){if(s.searchKey){var t=s.copyServiceDesks;var i=[];for(var n=0;n<t.length;n++){if(t[n].name.indexOf(e)>-1){i.push(t[n])}}s.serviceDesks=i}else{s.serviceDesks=s.copyServiceDesks}};s.clearSearch=function(){s.serviceDesks=s.copyServiceDesks;s.searchKey=""};s.toEditserviceDesk=function(e,t){if(!u.isTrue()){return false}if(t=="add"){_hmt.push(["_trackEvent","客服组","新增客服组"])}else{_hmt.push(["_trackEvent","客服组","编辑客服组"])}i.go("system_setting.service_desks_edit",{id:e,type:t})};s.deleteServiceDesk=function(t,e){if(confirm("您确定删除"+e.name+"吗?")){n["delete"]({id:e.id},function(e){if(e.success){s.serviceDesks.splice(t,1)}else{if(e.message=="servicedesk_has_ralation"){r.add("该客服组中有成员或智能分派规则中有使用，不可删除。请前往移除组内成员并更改或删除分派给该客服组的智能分派规则，再执行删除操作","danger")}else{r.add("删除失败","danger")}}})}else{_hmt.push(["_trackEvent","客服组-删除客服组","取消"])}};s.pageNum=1;s.hasMore=true;s.loadMore=function(){s.pageNum++;v()};function p(){c.run(o.constant.EVENT_LIST_SERVICEDESK,s.pageNum,"",{_count:999,_page:s.pageNum,_do_count:false,_fields:"id,name,engineerCount"},function(e){})}function f(e){userAginLogin(e);var t=e||[];for(var i=0;i<t.length;i++){if(t[i].name=="DEFAULT_SERVICE_DESK_NAME"){t[i].name=a("translate")(t[i].name);var n=t.splice(i,1);t.unshift(n[0])}s.serviceDesks=t}s.copyServiceDesks=angular.copy(s.serviceDesks)}function m(){var e=l.detail.servicedesks.gets(l.list.servicedesks.gets(s.pageNum))||[];if(e&&e.length===0){s.hasMore=false}else{s.hasMore=true}f(angular.copy(e))}function g(){o.register(d,o.constant.EVENT_LIST_SERVICEDESK,function(e){m()})}function v(){m();p()}function h(){g();v()}h();function y(){o.unRegister(d)}s.$on("$destroy",function(){y()})}]).controller("editServiceDesksController",["$scope","$http","$filter","$state","$stateParams","alertService","serviceDesks","userGroupService","ConsoleConfig","permissions","apiSetServiceDeskService","coreNotifyService","coreModelService","apiServiceDeskService","apiRoleListService",function(m,g,o,v,s,h,e,t,i,n,a,r,l,c,u){var y=s.id;var d=this.__proto__.constructor.name+"_"+Date.now();m.engineerGroupId=y;m.engineerGroupData={};m.checkedEngineerList=[];m.addEngineer=function(e,t){m.checkedEngineerList.push(e);m.searchList.splice(t,1);if(m.searchList.length==0){m.isShowSearchList=false}};m.delEngineer=function(e,t){m.checkedEngineerList.splice(t,1)};m.inviteEngineers=[];m.inviteEngineer=function(e){if(e){if(e.name){e.verifyNameFail=false}else{e.verifyNameFail=true}if(verifyEmailAddress(e.email)){e.verifyEmailFail=false}else{e.verifyEmailFail=true}if(!e.verifyNameFail&&!e.verifyEmailFail){m.inviteEngineers.push({verifyNameFail:false,verifyEmailFail:false,engineerRole:m.engineersRoleList[0].id})}}else{m.inviteEngineers.push({verifyNameFail:false,verifyEmailFail:false,engineerRole:m.engineersRoleList[0].id})}};m.cancelInviteEngineer=function(e){m.inviteEngineers.splice(e,1)};m.ngFocus=function(e){e.verifyNameFail=false;e.verifyEmailFail=false};m.ngBlur=function(e){if(verifyEmailAddress(e.email)){e.verifyEmailFail=false}else{e.verifyEmailFail=true}if(e.name){e.verifyNameFail=false}else{e.verifyNameFail=true}};m.isDefaultServiceDesk=false;m.selectedServiceDesk=[];var k=[];if(y>0){m.isHavePermissionEdit=n.hasPermission("service_desk_update")?true:false}else{m.isHavePermissionEdit=n.hasPermission("service_desk_create")?true:false;m.title="添加客服组"}org.ewei.sdk.OpenAssignRuleApi().listAssignRuleWithServiceDeskId({serviceDeskId:y}).then(function(e){if(e.length){m.Channel=e}});t.query({_count:999,_fields:"id,name",_filter:'{"$eq":{"serviceDesk.id":'+y+"}}"},function(e){m.bindUserGroup=e.userGroups||[]});m.sortOptions={handle:".sort-handle"};m.removeUserGroup=function(e){m.bindUserGroup.splice(e,1)};m.updateEngineerGroup=function(){var e={};var t=angular.copy(m.engineerGroupData);var i="post",n="service_desk.json";if(!t.name){h.add("客服组名称不能空","danger");return false}if(t.name=="默认服务台"){if(!m.isDefaultServiceDesk){h.add("客服组名称重复","danger");return false}}if(t.name.indexOf("\\")!=-1){h.add('客服组名称中不能包含"\\"',"danger");return false}var s=angular.copy(m.checkedEngineerList);for(var a=0;a<s.length;a++){if(s[a].id){s[a]={id:s[a].id}}}s=s.concat(k);var r=angular.copy(m.inviteEngineers);var o=[];for(var l=0;l<r.length;l++){if(!r[l].verifyNameFail&&!r[l].verifyEmailFail&&r[l].name&&r[l].email){var c={name:r[l].name,email:r[l].email};if(r[l].engineerRole){c.engineerRole={id:r[l].engineerRole}}o.push(c)}}var u=angular.copy(m.selectedServiceDesk);for(var d=0;d<u.length;d++){u[d]={id:u[d].id}}t.engineers=s;_.each(t.engineers,function(e,t){e.orderKey=t});t.jointServiceDesks=u;if(y>0){var p=angular.copy(m.bindUserGroup);for(var f=0;f<p.length;f++){p[f]={id:p[f].id}}t.bindUserGroups=p;i="put";n="service_desk/"+y+".json";t.id=y}e.inviteEngineers=o;e.serviceDesk=t;g({url:n,method:i,data:e}).success(function(e){if(e.success){h.add("更新成功");if(y==0){v.go("system_setting.detail",{uri:"service_desks",state:"run",settingType:"engineers"})}}else if(e.message=="name_repeat"){h.add("客服组名称重复","danger")}else{h.add("更新失败","danger")}})};function p(e){if(e.name=="DEFAULT_SERVICE_DESK_NAME"||e.name=="默认服务台"){m.isDefaultServiceDesk=true}m.engineerGroupData.name=o("translate")(e.name);m.title=angular.copy(m.engineerGroupData.name);if(e.engineers&&e.engineers.length>0){var t=e.engineers;var i=[];k=[];for(var n=0;n<t.length;n++){if(t[n].user){if(t[n].user.status==1&&t[n].user.valid==1&&t[n].user.deleted!=1){var s={id:t[n].id,user:{email:t[n].user.email,id:t[n].user.id,name:t[n].user.name}};if(t[n].defaultServiceDesk&&y==t[n].defaultServiceDesk.id){s.isDefault=true}if(i.indexOf(s)<=-1){i.push(s)}}else if(t[n].user.deleted==1){}else{var a={id:t[n].id};if(k.indexOf(a)<=-1){k.push(a)}}}}m.checkedEngineerList=i}if(e.jointServiceDesks&&e.jointServiceDesks.length>0){var r=e.jointServiceDesks;m.selectedServiceDesk=r}}function f(e){var t=e||[];var i=false,n=false;for(var s=0;s<t.length;s++){if(t[s].name=="DEFAULT_SERVICE_DESK_NAME"){t[s].name=o("translate")(t[s].name);if(y==0){break}i=true}if(y&&y==t[s].id){t.splice(s,1);n=true}if(i&&n){break}}m.serviceDesks=t}function C(){if(i.engineer.role.nameKey!="ROLE_NAME_CREATOR"&&i.engineer.role.nameKey!="ROLE_NAME_ADMIN"){for(var e=0;e<m.engineersRoleList.length;e++){if(m.engineersRoleList[e].nameKey=="ROLE_NAME_ADMIN"){m.engineersRoleList.splice(e,1)}}}m.engineersRoleList.unshift({id:0,name:"请选择角色--"})}function b(){a.run("get",r.constant.EVENT_DETAIL_SERVICEDESKS,{id:"@id"},{id:y},function(e){});c.run(r.constant.EVENT_LIST_SERVICEDESK,1,"",{_count:999,_page:1,_do_count:false,_fields:"id,name,engineerCount"},function(e){});u.run("define",r.constant.EVENT_LIST_ROLES,"","",{_count:999,_do_count:false,_fields:"id,name,nameKey,updatedAt,updater.id,updater.name",_filter:" {'$and':[{'$eq':{'provider.id':${current_provider_id}}},{'$eq':{'type':'engineer'}}]}",_asc:"createdAt"},function(e){})}function w(e){if(e=="all"){m.engineersRoleList=l.detail.roles.gets(l.list.roles["define"].getAll())||[];C();var t=l.detail.servicedesks.gets(l.list.servicedesks.getAll());f(t);var i=l.detail.servicedesks.get(s.id);if(!i){return}p(i)}else if(e=="serviceDesk"){var n=l.detail.servicedesks.get(s.id);if(!n){return}p(n)}else if(e=="roles"){m.engineersRoleList=l.detail.roles.gets(l.list.roles["define"].getAll())||[];C()}else{var n=l.detail.servicedesks.gets(l.list.servicedesks.getAll());f(n)}}function T(){r.register(d,r.constant.EVENT_DETAIL_SERVICEDESKS,function(e,t){if(t.action=="get"){w("serviceDesk")}});r.register(d,r.constant.EVENT_LIST_SERVICEDESK,function(e){w("serviceDeskList")});r.register(d,r.constant.EVENT_LIST_ROLES,function(e,t){w("roles")})}function S(){w("all");b()}function F(){T();S()}F();function A(){r.unRegister(d)}m.$on("$destroy",function(){A()})}]).directive("searchEngineerByUserGroup",["$timeout","$http",function(o,l){return{restrict:"EA",link:function(a,e){var t=e[0].getElementsByTagName("div")[0];var n=t.getElementsByTagName("input")[0];var i=e[0].getElementsByTagName("ul")[0];var s=null;a.searchList=[];a.isShowSearchList=false;var r=function(){o.cancel(s);s=o(function(){var e=n.value;var t={$and:[{$or:[{$like:{"user.name":"$"+e+"$"}},{$like:{"user.email":"$"+e+"$"}}]},{$eq:{"user.valid":1}},{$ne:{"user.deleted":1}}]};var i="engineer.json?_count=20&_do_count=false&_fields=id,user.id,user.name,user.email&_asc=user.name&_filter="+JSON.stringify(t);l.get(i).success(function(e){if(e.engineers&&e.engineers.length>0){var t=angular.copy(a.checkedEngineerList);var i=e.engineers;for(var n=0;n<t.length;n++){for(var s=0;s<i.length;s++){if(i[s].id==t[n].id){i.splice(s,1);break}}}a.searchList=i;if(i.length>0){a.isShowSearchList=true}else{a.isShowSearchList=false}}else{a.isShowSearchList=false;a.searchList=[]}})},500)};n.addEventListener("input",r,false);n.onfocus=r;document.onclick=function(){a.isShowSearchList=false;a.$apply()};t.onclick=i.onclick=function(e){if(a.searchList.length>0){a.isShowSearchList=true}a.$apply();e.stopPropagation()}}}}]).filter("serviceChannel",[function(){return function(e){if(e=="ticket"){return"工单"}else if(e=="chat"){return"会话"}}}]);angular.module("eweiApp.system_setting").controller("app_market_controller",["$scope","$rootScope","$state","$stateParams","$http","ConsoleConfig",function(e,t,s,i,n,a){e.createApp=function(){n({method:"POST",url:"/api/sso_from_ewei_web.json",params:{provider_id:a.provider.id,_token:getCookie("user_token")}}).success(function(e,t,i,n){if(e.status==0){void 0;s.go("system_setting.market_create")}else{void 0}})}}]).controller("ewapp_detail_controller",["$scope","$state","$stateParams",function(e,t,i){}]).controller("JIRA_app_detail_controller",["$scope","$state","$stateParams",function(e,t,i){}]).controller("sugarCEM_app_detail_controller",["$scope","$state","$stateParams",function(e,t,i){}]).controller("JIRA_app_install_controller",["$scope","$state","$stateParams",function(e,t,i){}]);angular.module("eweiApp.system_setting").controller("domain_setting_controller",["$rootScope","$scope","$state","$stateParams","$http","alertService","$modal_","license","$filter","ConsoleConfig","permissions","apiBrandSettingService","coreModelService","coreNotifyService",function(n,s,a,e,r,o,l,c,t,i,u,d,p,f){s.currentDomainRoot=i.domainRoot;s.submit_btn=false;var m=f.constant.EVENT_DETAIL_BRAND_SETTING_EMAIL;var g=this.__proto__.constructor.name+"_"+(new Date).valueOf();var v=function(){f.register(g,m,function(e){y()})};var h=function(){y();_()};var y=function(){s.provider=p.config.brandSetting.domainSetting||{};s.ewei_internet_url=s.provider.subDomain+"."+i.domainRoot};var _=function(){d.getProviderSetting(m,"","",function(e){})};var k=function(){v();h()};k();var C=function(){f.unRegister(g)};s.$on("$destroy",function(){C()});n.$watch("providerLicense",function(){if(n.providerLicense!=null){s.providerType=c.type()}});s.alterSubDomainModal=function(){var e=l({scope:s,title:'修改二级域名 <span class="subDomain-hint"><i class="iconfont">&#xe63b;</i>更改后，旧域名将立即失效，无法访问</span>',contentTemplate:"source/views/system_setting/alter_domain.html",html:true,show:true,placement:"center"});s.hideModal=function(){e.$promise.then(e.hide)};s.change=function(){s.errorMessage="";s.submit_btn=true;s.errorBorder=false;var e=new RegExp(/^[a-zA-Z0-9]+[a-zA-Z0-9-]*[a-zA-Z0-9]$/g);if(s.provider.subDomain){if(s.provider.subDomain.length<4){s.errorMessage="格式有误，请重新输入！";s.errorBorder=true;s.submit_btn=false}else if(!e.test(s.provider.subDomain)){s.errorMessage="格式有误，请重新输入！";s.errorBorder=true;s.submit_btn=false}}else{s.errorBorder=true;s.submit_btn=false;s.errorMessage="格式有误，请重新输入！"}};s.update=function(){_hmt.push(["_trackEvent","独立域名","更改二级域名-确定"]);s.errorMessage="";s.errorBorder=false;r.post("provider_update_subDomain.json",s.provider).success(function(e){if(e.success){o.add("更新成功！","success");s.errorBorder=false;r.post("update_domain_log");window.location.host=s.provider.subDomain+"."+i.domainRoot}else{s.errorMessage=e.message;s.errorBorder=true}})};s.backBuried=function(){_hmt.push(["_trackEvent","独立域名","更改二级域名-取消"])}};s.configAloneDomainModal=function(){if(n.providerLicense.type=="blend"||n.providerLicense.type=="enterprise"||n.providerLicense.type=="enterprise_trial"||n.providerLicense.type=="enterprise_plus"||n.providerLicense.type=="oem"||c.hasModule("self_domain")){_hmt.push(["_trackEvent","独立域名","配置独立域名"]);s.verify=false;s.buttonName="继续";s.newProvider={aloneDomain:s.provider.aloneDomain,recordNumber:s.provider.recordNumber,companyName:"",scale:"",scene:"",payIntentions:"",onlineProgram:"",name:"",tel:"",postscript:""};s.verifyProviderDomain=function(){r.post("verify_provider_domain.json",s.newProvider.aloneDomain).success(function(e){if(e.success){o.add("配置正确","success")}else{o.add("解析失败，请检查你的配置","danger")}})};var e=l({scope:s,contentTemplate:"source/views/system_setting/config_alone_domain.html",template:"modal/modal.tpl.w620.html",html:true,show:true,placement:"center"});s.$watch("newProvider.aloneDomain",function(e,t,i){s.verify=false;s.buttonName="继续"});s.hideModal=function(){e.$promise.then(e.hide)};var t=false;s.update=function(){if(s.newProvider.companyName==""||s.newProvider.companyName==null||s.newProvider.companyName==undefined){o.add("请输入公司全名","danger");return false}if(s.newProvider.scale==""||s.newProvider.scale==null||s.newProvider.scale==undefined){o.add("请选择企业规模","danger");return false}if(s.newProvider.scene==""||s.newProvider.scene==null||s.newProvider.scene==undefined){o.add("请选择应用场景","danger");return false}if(s.newProvider.payIntentions==""||s.newProvider.payIntentions==null||s.newProvider.payIntentions==undefined){o.add("请选择付费意向","danger");return false}if(s.newProvider.onlineProgram==""||s.newProvider.onlineProgram==null||s.newProvider.onlineProgram==undefined){o.add("请选择上线计划","danger");return false}if(s.newProvider.name==""||s.newProvider.name==null||s.newProvider.name==undefined){o.add("请输入你的姓名","danger");return false}if(s.newProvider.tel==""||s.newProvider.tel==null||s.newProvider.tel==undefined){o.add("请输入你的手机号码","danger");return false}if(!validMobilePhone(s.newProvider.tel)){o.add("请输入正确的手机号","danger");return false}void 0;if(s.newProvider.aloneDomain==""||s.newProvider.aloneDomain==undefined){o.add("请填写域名","danger");return}if(s.newProvider.aloneDomain.indexOf(".ewei.com")>=0){o.add("域名不能为ewei.com的二级域名","danger");return}if(s.newProvider.recordNumber==""||s.newProvider.recordNumber==undefined){o.add("请填写备案号","danger");return}void 0;if(!t){i()}};var i=function(){t=true;void 0;r.post("provider_update_alone_domain.json",s.newProvider).success(function(e){if(e.success){o.add("更新成功！","success");s.hideModal();s.provider.isAloneDomainChecked=null;s.provider=angular.extend(s.provider,s.newProvider);t=false}else{s.errorMessage=e.message;o.add(e.message,"danger");t=false}})};s.showTableNum=1;s.showTable=function(t){if(t==2){if(s.newProvider.aloneDomain==""||s.newProvider.aloneDomain==undefined){o.add("请填写域名","danger");return}if(s.newProvider.aloneDomain.indexOf(".ewei.com")>=0){o.add("域名不能为ewei.com的二级域名","danger");return}if(s.newProvider.recordNumber==""||s.newProvider.recordNumber==undefined){o.add("请填写备案号","danger");return}var e=/^(?=^.{3,255}$)[a-zA-Z0-9][-a-zA-Z0-9]{0,62}(\.[a-zA-Z0-9][-a-zA-Z0-9]{0,62})+$/;if(e.test(s.newProvider.aloneDomain)===false){o.add("独立域名应该只包含26个英文字母、 0到9的数字、 '-' 连字符。（注： '-' 英文中的连字符不得用于开头及结尾处）","danger");return}s.verify=true;s.buttonName="正在验证域名，请等待...";r.post("verify_provider_domain.json",s.newProvider.aloneDomain).success(function(e){s.verify=false;s.buttonName="继续";if(e.success){s.showTableNum=t}else{o.add("解析失败，请检查你的配置","danger");return}})}else{s.showTableNum=t}}}else{var e=l({scope:s,title:"提示",contentTemplate:"source/views/fun_restriction_reminder.html",html:true,show:true,placement:"center"});s.hasPermission=true;s.tipNotSupportService="当前服务版本不支持此功能，请升级服务后再试。";s.goAuthorization=function(){void 0;if(u.hasPermission("system_setting_company_account")){a.go("system_setting.detail.provider",{uri:"company_account",settingType:"system"});e.$promise.then(e.hide)}else{s.hasPermission=false;s.tipNotSupportService="很抱歉，你没有访问授权计划的权限"}};s.hideModal_=function(){e.$promise.then(e.hide)}}}}]);angular.module("eweiApp.account").controller("customerSettingController",["$modal_","$uibModal","$rootScope","$scope","$state","utils","$stateParams","$http","alertService","permissions","$filter","ConsoleConfig",function(e,t,i,n,s,a,r,o,l,c,u,d){n.customerSetBData={user_custom_field:"自定义客户字段",user_group_custom_field:"自定义客户组字段",user_list_custom:"自定义客户视图",user_group_list_custom:"自定义客户组视图",external_url_secret:"字段扩展URL密钥"};n.customerSetBuried=function(e){if(n.customerSetBData[e]){_hmt.push(["_trackPageview","/客户设置/子级页面/"+n.customerSetBData[e]]);_hmt.push(["_setCustomVar",i.vertionNumber,"名称","客户设置-"+n.customerSetBData[e],1]);_hmt.push(["_trackEvent","客户设置",n.customerSetBData[e]])}};n.menus=[{id:1,permission:"customer_setting_customfield",uri:"user_custom_field",title:"自定义客户字段"},{id:2,permission:"customer_group_setting_customfield",uri:"user_group_custom_field",title:"自定义客户组字段"},{id:3,permission:"customer_view_manage",uri:"user_list_custom",title:"自定义客户视图"},{id:4,permission:"customer_view_manage",uri:"user_group_list_custom",title:"自定义客户组视图"},{id:5,permission:"customer_setting_customfield_url_secret",uri:"external_url_secret",title:"字段扩展URL密钥"}];n.btnList=[{name:"工单设置",sref:"ticket_setting",show:true},{name:"社区设置",sref:"helpcenter_setting.detail({type:'integral'})",show:d.user.role.nameKey=="ROLE_NAME_EDITOR"||d.user.role.nameKey=="ROLE_NAME_ADMIN"},{name:"系统设置",sref:"system_setting",show:true}]}]).controller("userCustomFieldController",["$modal_","$uibModal","$rootScope","$scope","$state","utils","$stateParams","$http","alertService","permissions","$filter","ConsoleConfig",function(n,e,t,a,i,s,r,o,l,c,u,d){a.eweiHelpcenterApiUrl=d.eweiHelpcenterApiUrl;o.get("custom_field.json?scope=user").success(function(e,t){a.userCustomFields=e.json});a.editUserCustomField=function(e,t){a.UserCustomFieldData={add:"添加字段",update:"编辑字段",copy:"克隆字段"};if(a.UserCustomFieldData[t]){_hmt.push(["_trackEvent","自定义客户字段",a.UserCustomFieldData[t]])}i.go("system_setting.edit_user_custom_field",{id:e,type:t})};a.deleteUserCustomField=function(e,s,t){_hmt.push(["_trackEvent","自定义客户字段","删除字段"]);a.confirmContent="您确定要删除自定义客户字段吗？";s.userCustomField.active=!!e;s.userCustomField.deleted=true;var i=n({scope:a,title:"确认",contentTemplate:"source/views/confirm_template.html",html:true,show:true,placement:"center"});a.hideModal=function(){i.$promise.then(i.hide)};delete s.userCustomField.scan_able;delete s.userCustomField.edit_able;a.$ok=function(){o({url:"updateCustomField.json",method:"POST",data:s.userCustomField}).success(function(e,t,i,n){userAginLogin(e);a.hideModal();if(e.success){s.$parent.userCustomFields.remove(s.userCustomField)}else{l.add("删除失败","danger")}})}};a.enabled=function(t,i){i?_hmt.push(["_trackEvent","自定义客户字段","启用自定义客户字段"]):_hmt.push(["_trackEvent","自定义客户字段","停用自定义客户字段"]);if(!i){if(confirm("您确定停用吗?")){o({url:"enable_custom_field/"+t.userCustomField.id+".json",method:"put",params:{enable:i}}).success(function(e){if(e.success){t.userCustomField.active=i}else{l.add(e.message,"danger")}})}}else{o({url:"enable_custom_field/"+t.userCustomField.id+".json",method:"put",params:{enable:i}}).success(function(e){if(e.success){t.userCustomField.active=i}else{l.add(e.message,"danger")}})}}}]).controller("editUserCustomFieldController",["$modal_","$scope","$rootScope","$state","$stateParams","$resource","$http","alertService","customFieldOptions",function(e,o,l,c,u,t,d,p,i){o.userCustomField={};o.styleOptions=i;var n=false;var s=u.id;o.checkId=u.id;o.editType=u.type;if(s>0){d({url:"custom_field/"+s+".json",method:"GET",params:{}}).success(function(e,t,i,n){userAginLogin(e);if(e.success){o.userCustomField=e.json;if(o.userCustomField.required){o.isRequired=true}else{o.isRequired=false}if(!o.userCustomField.defaultLength){o.userCustomField.defaultLength="180"}if(o.userCustomField.required!=undefined){o.userCustomField.required=o.userCustomField.required.toString()}if(!o.userCustomField.regexpForValidation){for(var s=0;s<o.styleOptions.length;s++){if(o.styleOptions[s].value==o.userCustomField.type&&o.styleOptions[s].regexp){o.userCustomField.regexpForValidation=o.styleOptions[s].regexp}}}if((o.userCustomField.type=="options"||o.userCustomField.type=="multi_options")&&o.userCustomField.customFieldOptions!=undefined){o.userCustomField.customFieldOptions=angular.fromJson(o.userCustomField.customFieldOptions)}if(o.userCustomField.type=="cascade_options"){o.mulOptions=angular.fromJson(o.userCustomField.customFieldOptions)}}})}else{if(o.editType=="update"){d.get("external_url.json",{}).success(function(e,t){if(e.success&&e.json){o.userCustomField={id:0,title:"External ID",system:true,systemField:"externalId",regexpForValidation:"",notes:"用户外部ID",type:"text",defaultLength:"180",url:e.json.userExternalIdUrl}}})}else if(o.editType=="add"){o.userCustomField={type:"text",property:"text",active:true,defaultValue:"",required:"false",defaultLength:"180",customFieldOptions:[{name:"",value:"",defaultValue:""}]};o.mulOptions=[{name:"",value:"",children:[{name:"",value:""}]}]}}o.recoveryDefault=function(e){if(e.defaultLength==""||e.defaultLength==null){e.defaultLength="180"}};o.toAddOption=function(e){if(o.userCustomField.systemFieldKey!="ticket_type"&&o.userCustomField.systemFieldKey!="multi_options"){o.userCustomField.customFieldOptions.push({name:"",value:""})}else{o.userCustomField.customFieldOptions.push({name:"",value:"",defaultValue:""})}};o.toDeleteOption=function(e){var t=o.userCustomField.customFieldOptions;if(e&&t.length>1){t.splice(e,1)}};o.addMainOption=function(){o.mulOptions.push({name:"",value:"",children:[{name:"",value:""}]})};o.delMainOption=function(e){if(o.mulOptions.length==1){return false}else{o.mulOptions.splice(e,1)}};o.addSubOption=function(e){e.item.children.push({name:"",value:""})};o.delSubOption=function(e,t){if(t>0){e.item.children.splice(t,1)}};o.selectRadio=function(e){if(!o.userCustomField.systemFieldKey){o.selectId=e.$index}else{var t=e.$parent.userCustomField.customFieldOptions;for(var i=0;i<t.length;i++){if(i!=e.$index){t[i].defaultValue="false"}else{t[i].defaultValue="true"}}}};o.changeReg=function(e){for(var t=0;t<o.styleOptions.length;t++){if(o.styleOptions[t].value==e&&o.styleOptions[t].regexp!=undefined){o.userCustomField.regexpForValidation=o.styleOptions[t].regexp}}if(o.editType=="copy"){o.mulOptions=[{name:"",value:"",children:[{name:"",value:""}]}];o.userCustomField.customFieldOptions=[{name:"",value:"",defaultValue:""}]}};o.checkMultiValue=function(e){var t=window.event?e.keyCode:e.which;if(t==188){p.add("多选下拉框中不能输入逗号","danger");e.preventDefault()}};o.checkCascadetiValue=function(e){var t=window.event?e.keyCode:e.which;if(t==191){p.add('级联下拉框中不能输入"/"',"danger");e.preventDefault()}};o.saveUserExternalIdUrl=function(e){d.post("update_user_external_id_url.json?url="+e.url,{}).success(function(e){if(e.success){p.add("更新成功");c.go("system_setting.detail",{uri:"user_custom_field",settingType:"customer"})}else{p.add(e.message,"danger")}})};o.isRequiredChange=function(){if("true"==o.userCustomField.required){angular.forEach(o.fieldPermissions,function(e){e.scan_able=1;e.edit_able=1});o.showJurisdictionPromet=true;o.isRequired=true}else{o.isRequired=false;o.showJurisdictionPromet=false}};o.saveuserCustomField=function(e){_hmt.push(["_trackPageview","/自定义客户字段/子三类/添加字段-更新"]);_hmt.push(["_setCustomVar",l.vertionNumber,"名称","自定义客户字段-添加字段-更新",1]);if(e.systemField=="externalId"){o.saveUserExternalIdUrl(e);return}if(e.type==""){p.add("请选择样式","danger");return}if(!e.title){p.add("请输入字段名称","danger");return}var t={};if(e.type=="options"||e.type=="checkbox"||e.type=="date"||e.type=="date_to_date"||e.type=="date_time"||e.type=="cascade_options"||e.type=="multi_options"||e.systemField){if(e.regexpForValidation){delete e.regexpForValidation}}if(e.id!=undefined){t.id=e.id}if(o.editType=="copy"){t.id=0}var i={};t.fieldPermissions=[];angular.forEach(o.fieldPermissions,function(e){i={role:{id:""},customField:{id:""},scan_able:"",edit_able:""};i.role.id=e.role_id;i.customField.id=u.id;i.scan_able=e.scan_able;i.edit_able=e.edit_able;t.fieldPermissions.push(i)});t.required=e.required;t.active=e.active;t.type=e.type;t.title=e.title;t.regexpForValidation=e.regexpForValidation;t.notes=e.notes;t.url=e.url;t.defaultValue=e.defaultValue;t.scope="user";if(e.type=="options"||e.type=="multi_options"){for(var n=0;n<e.customFieldOptions.length;n++){if(e.customFieldOptions[n].name==""&&e.customFieldOptions[n].value==""){p.add("选项值不能为空","danger");return}else if(e.customFieldOptions[n].name==""){e.customFieldOptions[n].name=e.customFieldOptions[n].value}else if(e.customFieldOptions[n].value==""){if(e.systemFieldKey!="ticket_type"){e.customFieldOptions[n].value=e.customFieldOptions[n].name}}else if(e.customFieldOptions[n].value!=""&&e.customFieldOptions[n].name!=""&&e.systemFieldKey!="priority"){if(e.systemFieldKey!="ticket_type"){e.customFieldOptions[n].value=e.customFieldOptions[n].name}}}t.customFieldOptions=JSON.stringify(e.customFieldOptions);t.openSearch=e.openSearch}else if(e.type=="cascade_options"&&!e.systemFieldKey){for(var n=0;n<o.mulOptions.length;n++){if(o.mulOptions[n].name==""&&o.mulOptions[n].value==""){p.add("选项值不能为空","danger");return}else if(o.mulOptions[n].name==""){o.mulOptions[n].name=o.mulOptions[n].value}else if(o.mulOptions[n].value==""){o.mulOptions[n].value=o.mulOptions[n].name}else if(o.mulOptions[n].name!=""&&o.mulOptions[n].value!=""){o.mulOptions[n].name=o.mulOptions[n].value}var s=o.mulOptions[n].children;for(var a=0;a<s.length;a++){if(s[a].name==""&&s[a].value==""){p.add("选项值不能为空","danger");return}else if(s[a].name==""){s[a].name=s[a].value}else if(s[a].value==""){s[a].value=s[a].name}else if(s[a].value!=""&&s[a].name!=""){s[a].name=s[a].value}}}t.customFieldOptions=angular.toJson(o.mulOptions)}else if(e.type=="checkbox"){t.required=false}if(!e.defaultLength){p.add("字段默认列宽不能为空","danger");return}else{var r=/^\d+(?=\.{0,1}\d+$|$)/;if(!r.test(e.defaultLength)){p.add("字段默认列宽必须为正数","danger");return}t.defaultLength=e.defaultLength}o.btnDisabled=true;d({url:"custom_field.json",method:"POST",data:t}).success(function(e,t,i,n){userAginLogin(e);if(e.success){c.go("system_setting.detail",{uri:"user_custom_field",settingType:"customer"})}else{if(e.message=="option_name_not_unique"){p.add("选项不能重复","danger")}else{p.add("更新失败","danger")}o.btnDisabled=false}})}}]).controller("externalUrlSecretController",["$scope","$http","$state","alertService",function(t,e,i,n){t.externalUrl={};e.get("external_url.json",{}).success(function(e){if(e.success){t.externalUrl=e.json}});t.changeSecret=function(){_hmt.push(["_trackEvent","字段扩展URL密匙","更换密匙"]);if(confirm("更换密钥有可能会影响扩展URL对你的应用系统的访问，你确定要更改密钥吗？")){e.post("external_url_secret.json",{}).success(function(e){if(e.success&&e.json){t.externalUrl.externalUrlSecret=e.json;n.add("更新成功,如果你已经使用此密钥做认证，请及时更新您的应用系统。")}else{n.add(e.message,"danger")}}).error(function(e){n.add("更新失败稍候再试","danger")})}}}]);angular.module("eweiApp.account").controller("userGroupCustomFieldController",["$modal_","$uibModal","$rootScope","$scope","$state","utils","$stateParams","$http","alertService","permissions","$filter","ConsoleConfig",function(n,e,t,a,i,s,r,o,l,c,u,d){a.eweiHelpcenterApiUrl=d.eweiHelpcenterApiUrl;o.get("custom_field.json?scope=user_group&ignore_scan_able=true").success(function(e,t){userAginLogin(e);a.userGroupCustomFields=e.json;p(a.userGroupCustomFields)});function p(e){a.userGroupCustomFieldsActive=[];a.userGroupCustomFieldsSystem=[];a.userGroupCustomFieldsNoActive=[];for(var t=0;t<e.length;t++){if(e[t].systemFieldKey){a.userGroupCustomFieldsSystem.push(e[t])}else if(e[t].active){a.userGroupCustomFieldsActive.push(e[t])}else{a.userGroupCustomFieldsNoActive.push(e[t])}}}a.updateSortOrder=function(){var e={ids:[],values:[]};a.allUserGroupCustomFields=a.userGroupCustomFieldsSystem.concat(a.userGroupCustomFieldsActive);a.allUserGroupCustomFields=a.allUserGroupCustomFields.concat(a.userGroupCustomFieldsNoActive);for(var t=0;t<a.allUserGroupCustomFields.length;t++){e.ids.push(a.allUserGroupCustomFields[t].id);e.values.push(t+1)}o({url:"updateCustomFieldOrderKey.json",method:"POST",data:e}).success(function(e,t,i,n){userAginLogin(e)})};a.sortableOptions={"ui-floating":false,handle:".myHandle",update:function(e,t){},stop:function(e,t){a.updateSortOrder()}};a.editUserGroupCustomField=function(e,t){a.userGroupCustomFieldData={add:"添加字段",update:"编辑字段",copy:"克隆字段"};if(a.userGroupCustomFieldData[t]){_hmt.push(["_trackEvent","自定义客户组字段",a.userGroupCustomFieldData[t]])}i.go("system_setting.edit_user_group_custom_field",{id:e,type:t})};a.deleteUserGroupCustomField=function(e,s,t){_hmt.push(["_trackEvent","自定义客户组字段","删除字段"]);a.confirmContent="您确定要删除自定义客户组字段吗？";s.userGroupCustomField.active=!!e;s.userGroupCustomField.deleted=true;var i=n({scope:a,title:"确认",contentTemplate:"source/views/confirm_template.html",html:true,show:true,placement:"center"});a.hideModal=function(){i.$promise.then(i.hide)};delete s.userGroupCustomField.scan_able;delete s.userGroupCustomField.edit_able;a.$ok=function(){o({url:"updateCustomField.json",method:"POST",data:s.userGroupCustomField}).success(function(e,t,i,n){userAginLogin(e);a.hideModal();if(e.success){s.$parent.userGroupCustomFields.remove(s.userGroupCustomField);s.$parent.userGroupCustomFieldsNoActive.remove(s.userGroupCustomField)}else{l.add("删除失败","danger")}})}};a.enabled=function(t,i){i?_hmt.push(["_trackEvent","自定义客户组字段","启用自定义客户组字段"]):_hmt.push(["_trackEvent","自定义客户组字段","停用自定义客户组字段"]);if(!i){if(confirm("您确定停用吗?")){o({url:"enable_custom_field/"+t.userGroupCustomField.id+".json",method:"put",params:{enable:i}}).success(function(e){if(e.success){t.userGroupCustomField.active=i;a.userGroupCustomFieldsNoActive.push(t.userGroupCustomField);a.userGroupCustomFieldsActive.splice(a.userGroupCustomFieldsActive.indexOf(t.userGroupCustomField),1)}else{l.add(e.message,"danger")}})}}else{o({url:"enable_custom_field/"+t.userGroupCustomField.id+".json",method:"put",params:{enable:i}}).success(function(e){if(e.success){t.userGroupCustomField.active=i;a.userGroupCustomFieldsActive.push(t.userGroupCustomField);a.userGroupCustomFieldsNoActive.splice(a.userGroupCustomFieldsNoActive.indexOf(t.userGroupCustomField),1);a.updateSortOrder()}else{l.add(e.message,"danger")}})}}}]).controller("editUserGroupCustomFieldController",["$modal_","$scope","$rootScope","$state","$stateParams","$resource","$http","alertService","customFieldOptions",function(e,o,l,c,u,t,d,p,i){o.userGroupCustomField={};o.styleOptions=i;var n=false;var s=u.id;o.checkId=u.id;o.editType=u.type;if(s>0){d({url:"custom_field/"+s+".json",method:"GET",params:{}}).success(function(e,t,i,n){userAginLogin(e);if(e.success){o.userGroupCustomField=e.json;if(o.userGroupCustomField.required){o.isRequired=true}else{o.isRequired=false}if(!o.userGroupCustomField.defaultLength){o.userGroupCustomField.defaultLength="180"}if(o.userGroupCustomField.required!=undefined){o.userGroupCustomField.required=o.userGroupCustomField.required.toString()}if(!o.userGroupCustomField.regexpForValidation){for(var s=0;s<o.styleOptions.length;s++){if(o.styleOptions[s].value==o.userGroupCustomField.type&&o.styleOptions[s].regexp){o.userGroupCustomField.regexpForValidation=o.styleOptions[s].regexp}}}if((o.userGroupCustomField.type=="options"||o.userGroupCustomField.type=="multi_options")&&o.userGroupCustomField.customFieldOptions!=undefined){o.userGroupCustomField.customFieldOptions=angular.fromJson(o.userGroupCustomField.customFieldOptions)}if(o.userGroupCustomField.type=="cascade_options"){o.mulOptions=angular.fromJson(o.userGroupCustomField.customFieldOptions)}}})}else{o.userGroupCustomField={type:"text",property:"text",active:true,defaultValue:"",required:"false",defaultLength:"180",customFieldOptions:[{name:"",value:"",defaultValue:""}]};o.mulOptions=[{name:"",value:"",children:[{name:"",value:""}]}]}o.recoveryDefault=function(e){if(e.defaultLength==""||e.defaultLength==null){e.defaultLength="180"}};o.toAddOption=function(e){o.userGroupCustomField.customFieldOptions.push({name:"",value:""})};o.toDeleteOption=function(e){var t=o.userGroupCustomField.customFieldOptions;if(e&&t.length>1){t.splice(e,1)}};o.addMainOption=function(){o.mulOptions.push({name:"",value:"",children:[{name:"",value:""}]})};o.delMainOption=function(e){if(o.mulOptions.length==1){return false}else{o.mulOptions.splice(e,1)}};o.addSubOption=function(e){e.item.children.push({name:"",value:""})};o.delSubOption=function(e,t){if(t>0){e.item.children.splice(t,1)}};o.changeReg=function(e){for(var t=0;t<o.styleOptions.length;t++){if(o.styleOptions[t].value==e&&o.styleOptions[t].regexp!=undefined){o.userGroupCustomField.regexpForValidation=o.styleOptions[t].regexp}}if(o.editType=="copy"){o.mulOptions=[{name:"",value:"",children:[{name:"",value:""}]}];o.userGroupCustomField.customFieldOptions=[{name:"",value:"",defaultValue:""}]}};o.checkMultiValue=function(e){var t=window.event?e.keyCode:e.which;if(t==188){p.add("多选下拉框中不能输入逗号","danger");e.preventDefault()}};o.checkCascadetiValue=function(e){var t=window.event?e.keyCode:e.which;if(t==191){p.add('级联下拉框中不能输入"/"',"danger");e.preventDefault()}};o.isRequiredChange=function(){if("true"==o.userGroupCustomField.required){angular.forEach(o.fieldPermissions,function(e){e.scan_able=1;e.edit_able=1});o.showJurisdictionPromet=true;o.isRequired=true}else{o.showJurisdictionPromet=false;o.isRequired=false}};o.saveuserGroupCustomField=function(e){_hmt.push(["_trackPageview","/自定义客户组字段/子三类/添加字段-更新"]);_hmt.push(["_setCustomVar",l.vertionNumber,"名称","自定义客户组字段-添加字段-更新",1]);if(e.type==""){p.add("请选择样式","danger");return}if(!e.title){p.add("请输入字段名称","danger");return}var t={};if(e.type=="options"||e.type=="checkbox"||e.type=="date"||e.type=="date_to_date"||e.type=="date_time"||e.type=="cascade_options"||e.type=="multi_options"||e.systemField){if(e.regexpForValidation){delete e.regexpForValidation}}if(e.id!=undefined){t.id=e.id}if(o.editType=="copy"){t.id=0}var i={};t.fieldPermissions=[];angular.forEach(o.fieldPermissions,function(e){i={role:{id:""},customField:{id:""},scan_able:"",edit_able:""};i.role.id=e.role_id;i.customField.id=u.id;i.scan_able=e.scan_able;i.edit_able=e.edit_able;t.fieldPermissions.push(i)});t.required=e.required;t.active=e.active;t.type=e.type;t.title=e.title;t.regexpForValidation=e.regexpForValidation;t.notes=e.notes;t.url=e.url;t.defaultValue=e.defaultValue;t.scope="user_group";if(e.type=="options"||e.type=="multi_options"){for(var n=0;n<e.customFieldOptions.length;n++){if(e.customFieldOptions[n].name==""&&e.customFieldOptions[n].value==""){p.add("选项值不能为空","danger");return}else if(e.customFieldOptions[n].name==""){e.customFieldOptions[n].name=e.customFieldOptions[n].value}else if(e.customFieldOptions[n].value==""){e.customFieldOptions[n].value=e.customFieldOptions[n].name}else if(e.customFieldOptions[n].value!=""&&e.customFieldOptions[n].name!=""&&e.systemFieldKey!="priority"){e.customFieldOptions[n].value=e.customFieldOptions[n].name}}t.customFieldOptions=JSON.stringify(e.customFieldOptions);t.openSearch=e.openSearch}else if(e.type=="cascade_options"){for(var n=0;n<o.mulOptions.length;n++){if(o.mulOptions[n].name==""&&o.mulOptions[n].value==""){p.add("选项值不能为空","danger");return}else if(o.mulOptions[n].name==""){o.mulOptions[n].name=o.mulOptions[n].value}else if(o.mulOptions[n].value==""){o.mulOptions[n].value=o.mulOptions[n].name}else if(o.mulOptions[n].name!=""&&o.mulOptions[n].value!=""){o.mulOptions[n].name=o.mulOptions[n].value}var s=o.mulOptions[n].children;for(var a=0;a<s.length;a++){if(s[a].name==""&&s[a].value==""){p.add("选项值不能为空","danger");return}else if(s[a].name==""){s[a].name=s[a].value}else if(s[a].value==""){s[a].value=s[a].name}else if(s[a].value!=""&&s[a].name!=""){s[a].name=s[a].value}}}t.customFieldOptions=angular.toJson(o.mulOptions)}else if(e.type=="checkbox"){t.required=false}if(!e.defaultLength){p.add("字段默认列宽不能为空","danger");return}else{var r=/^\d+(?=\.{0,1}\d+$|$)/;if(!r.test(e.defaultLength)){p.add("字段默认列宽必须为正数","danger");return}t.defaultLength=e.defaultLength}o.btnDisabled=true;d({url:"custom_field.json",method:"POST",data:t}).success(function(e,t,i,n){userAginLogin(e);if(e.success){c.go("system_setting.detail",{uri:"user_group_custom_field",settingType:"customer"})}else{if(e.message=="option_name_not_unique"){p.add("选项不能重复","danger")}else{p.add("更新失败","danger")}o.btnDisabled=false}})}}]);(function(){angular.module("eweiApp.system_setting").controller("AppMarketCtrl",e);e.$inject=["$scope","$upload","$modal_"];function e(n,t,s){var i=this;i.uploadImage=e;i.createField=a;i.editField=r;i.fieldList=[];function e(e){if(e==null||e==undefined||e.length<=0){return}if(e[0].size>52428800){alertService.add("上传单个附件大小不能超过50M","danger")}else{n.fileSelectDisabled=true;n.fileUploading=true;e.upload=t.upload({url:"upload",method:"POST",file:e});e.upload.then(function(e){if(e.status==200){if(e.data.fileSize>52428800){alertService.add("上传单个附件大小不能超过50M","danger")}else{if(n.attachments==undefined||n.attachments==null){n.attachments=[]}n.fileSelectDisabled=false;n.fileUploading=false;n.attachments.push(e.data)}}else{alertService.add("请检查文件类型，格式！","danger")}},function(e){n.errorMsg=e.status+": "+e.data});e.upload.progress(function(e){void 0});e.upload.xhr(function(e){e.upload.addEventListener("abort",function(){void 0},false)})}}function a(e){n.field={};n.fieldType="new";var t=s({scope:n,prefixEvent:"confirm_moda",template:"modal/modal.tpl.w380.html",contentTemplate:"app_market_field_template.html",html:true,show:true,title:"创建自定义字段",placement:"center"});n.addField=function(e){void 0;n.$broadcast("show-errors-check-validity","fieldForm");i.fieldList.push(e);t.$promise.then(t.hide)}}function r(e){n.field=e;n.fieldType="edit";var i=s({scope:n,prefixEvent:"confirm_moda",template:"modal/modal.tpl.w380.html",contentTemplate:"app_market_field_template.html",html:true,show:true,title:"编辑自定义字段",placement:"center"});n.hideField=function(e,t){n.$broadcast("show-errors-check-validity","fieldForm");if(t.$valid){i.$promise.then(i.hide)}else{return false}}}n.save=function(){n.$broadcast("show-errors-check-validity");if(n.userForm.$valid){void 0;n.reset()}};n.reset=function(){n.$broadcast("show-errors-reset");n.user={name:"",email:""}}}})();(function(){"use strict";angular.module("eweiApp.polymerize_search").controller("polymerizeSearchController",e);e.$inject=["$scope","ConsoleConfig","$http","ticketListCustomOptions","ticketListCustomGroupByOptions","alertService","$state","tabs","polymerizeSearchService"];function e(e,t,l,a,i,n,s,r,o){var c=this;c.searchType="ticket";c.showSearchResult=false;c.gettingLastNewsUrl="";c.searchContent="";c.isShowCustomField=false;c.visibleCustomField=[];c.ticketCustomField=[];c.userCustomField=[];c.userGroupCustomField=[];c.articleCustomField=[];c.questionCustomField=[];c.isAbleSet=true;c.isAbleExport=true;c.isReaptSearch=true;c.searchView={};c.searchResult=[];c.searchResultIsNone=false;c.searchResultHasMore=false;c.page={pageNumber:1,pageSize:20};c.loading="";c.showDefaultField=true;c.visibleFieldId="";l({url:"dashborad_community_dynamics.json",method:"GET",params:{size:12}}).success(function(e){if(e.success&&e.json!=undefined){if(e.json.providerId&&e.json.providerId==t.provider.id){c.gettingLastNewsUrl=window.location.origin+"/"}else{c.gettingLastNewsUrl=t.eweiHelpcenterApiUrl}c.recommondQuestions=e.json.recommondQuestions}});c.goDetail=function(e){if(e.topic&&e.topic.type){var t=e.topic.type;var i=c.gettingLastNewsUrl+"new/#";if(t==="questions"||t==="deletes"||t==="default"){i+="/forum/detail/"+e.topic.id+"/"+e.id}else{i+="/article/detail/"+e.id+"?topicId="+e.topic.id}window.open(i)}};if(window.sessionStorage){var u;try{u=sessionStorage.getItem("polymerizeSearchData")}catch(e){void 0}if(u){var d=JSON.parse(u);if(d.isSenior){s.go("polymerize_search_senior_result")}else{c.showSearchResult=true;c.searchType=d.searchType;c.searchView=d.searchView;c.searchContent=d.searchContent;c.searchResult=d.searchResult;c.showDefaultField=d.showDefaultField;c.visibleFieldId=d.visibleFieldId;c.page.pageNumber=d.pageNum;c.searchTicketCount=d.searchTicketCount;c.isSearchTicketComment=d.isSearchTicketComment;m(c.searchView,c.searchResult)}}}for(var p=0;p<r.length;p++){if(r[p].active){r[p].active=false;break}}c.changeSearchType=function(e){if(e=="article"||e=="question"){c.isAbleSet=false}else{c.isAbleSet=true}c.searchType=e;c.isShowCustomField=false;c.searchResult=[];c.search()};c.selectCustomField=function(e){if(!e.ischecked){var t=0;angular.forEach(c.customFields,function(e){if(e.selected){t++}});if(e.selected){e.selected=false}else{if(t<10){e.selected=true}else{n.add("显示的列不能超过10个","danger")}}}};c.export=function(){var e="";var t="";if(c.searchType=="ticket"){e="/ticket_multi_export_excel.json"}else if(c.searchType=="user"){e="/user_multi_export_excel.json"}else if(c.searchType=="userGroup"){e="/user_group_multi_export_excel.json"}else if(c.searchType=="question"){e="/question_multi_export_excel.json"}else{e="/article_multi_export_excel.json"}angular.forEach(c.visibleCustomField,function(e){t+=e.field+","});t=t.substring(0,t.length-1);e+="?searchKey="+c.searchContent+"&title="+t+"&searchType=searchKeyQuery";if(c.searchType=="ticket"){e+="&isSearchTicketComment="+c.isSearchTicketComment}window.open(e)};c.showCustomField=function(){if(c.searchType=="ticket"||c.searchType=="user"||c.searchType=="userGroup"){c.isShowCustomField=!c.isShowCustomField}};c.saveVisibleCustomField=function(){var i={customFields:"",fields:"",otherFields:"",type:c.searchType,id:c.visibleFieldId};c.searchView=i;var t=[];angular.forEach(c.customFields,function(e){if(e.selected){t.push(e)}});angular.forEach(t,function(e){if(e.id&&!e.systemFieldKey){if(i.customFields==""){i.customFields+=e.id}else{i.customFields+=","+e.id}}else{var t="";if(e.systemFieldKey){if(e.systemFieldKey=="ticket_type"){t="ticketType.name"}else if(e.systemFieldKey=="service_catalog"){t="serviceCatalog.id"}else{t=e.systemFieldKey}}else{t=e.value}if(i.fields==""){i.fields=t}else{i.fields+=","+t}if(c.searchType=="ticket"){if(e.value=="copyTo"||e.value=="tags"){if(i.otherFields==""){i.otherFields=e.value}else{i.otherFields+=","+e.value}}}}});l({method:"POST",url:"/search_view.json",data:i}).success(function(e){if(e.success){c.visibleCustomField=[];m(i);c.isShowCustomField=false;c.showDefaultField=false}})};c.enterSearch=function(e){if(e.keyCode==13){c.search()}};c.search=function(){if(c.isReaptSearch){if(c.searchContent!=""){c.isReaptSearch=false;c.page.pageNumber=1;c.showSearchResult=true;l({method:"GET",url:"/search_view/"+c.searchType+".json"}).success(function(e){if(e.success){if(e.json){c.searchView=e.json;c.showDefaultField=false;c.visibleFieldId=e.json.id;f(c.searchView)}else{c.showDefaultField=true;f()}}})}}};c.searchMore=function(){c.page.pageNumber++;f(c.searchView,true)};function f(t,e){c.isReaptSearch=true;c.searchResultIsNone=false;c.searchResultHasMore=false;switch(c.searchType){case"ticket":c.oldIsSearchTicketComment=e===undefined?c.isSearchTicketComment:c.oldIsSearchTicketComment;c.loading="/ticket/multi_condition.json?isSearchTicketComment="+(c.oldIsSearchTicketComment?true:false)+"&_page="+c.page.pageNumber+"&_count="+c.page.pageSize+"&searchKey="+encodeURI(c.searchContent);l({url:c.loading,method:"GET"}).success(function(e){if(e){c.searchTicketCount=e.json.total;m(t,e.json.tickets||[])}});break;case"user":c.loading="/search_users.json?_page="+c.page.pageNumber+"&_count="+c.page.pageSize+"&searchKey="+encodeURI(c.searchContent);l({url:c.loading,method:"GET"}).success(function(e){if(e){m(t,e.json||[])}});break;case"userGroup":c.loading="/search_user_groups.json?_page="+c.page.pageNumber+"&_count="+c.page.pageSize+"&searchKey="+encodeURI(c.searchContent);l({url:c.loading,method:"GET"}).success(function(e){if(e){m(t,e.json||[])}});break;case"article":org.ewei.sdk.OpenArticleApi().multiCondition({page:c.page,searchKey:c.searchContent,topicTypes:["TYPE_ANNOUNCEMENT","TYPE_ARTICLES","TYPE_DRAFT","TYPE_MANAGE","TYPE_WEIXIN_JOKE"]}).then(function(e){m(t,e.list||[])});break;case"question":org.ewei.sdk.OpenArticleApi().multiCondition({page:c.page,searchKey:c.searchContent,topicTypes:["TYPE_QUESTIONS","TYPE_DELETE","TYPE_DEFAULT"]}).then(function(e){m(t,e.list||[])});break}}function m(o,e){var n="";var s;if(e){s=e.length;if(e.length>0){if(c.page.pageNumber==1){c.searchResult=e}else{c.searchResult=c.searchResult.concat(e);if(s&&s>=20){c.searchResultHasMore=true}return}}else{if(c.page.pageNumber==1){c.searchResult=[];c.searchResultIsNone=true}}}c.visibleCustomField=[];switch(c.searchType){case"ticket":l({method:"GET",url:"custom_field.json?scope=ticket&active=true"}).success(function(e){if(e.success&&e.json){var r={};c.customFields=e.json;var t=angular.copy(a);angular.forEach(t,function(e){var t={};if(e.value=="no"||e.value=="requester.name"){c.customFields.push({value:e.value,title:e.option,ischecked:true,selected:true});if(e.value=="no"){t={title:e.option,field:e.value,widthClass:"w150"}}else{t={title:e.option,field:e.value,fieldCount:2,field0:"requester",field1:"name",widthClass:"w150"}}c.visibleCustomField.push(t)}else{if(c.showDefaultField){if(e.value=="serviceDesk.name"||e.value=="via.channelName"||e.value=="createdAt"){c.customFields.push({value:e.value,title:e.option,selected:true});if(e.value=="serviceDesk.name"){t={title:e.option,field:e.value,fieldCount:2,field0:"serviceDesk",field1:"name",widthClass:"w150"}}else if(e.value=="via.channelName"){t={title:e.option,field:e.value,fieldCount:2,field0:"via",field1:"channelName",widthClass:"w150"}}else{t={title:e.option,field:e.value,widthClass:"w150"}}c.visibleCustomField.push(t)}else{c.customFields.push({value:e.value,title:e.option})}}else{var i=o.fields.split(",");for(var n=0;n<i.length;n++){if(e.value==i[n]){e.selected=true;var s=i[n].split(".");if(s.length==3){t={title:e.option,field:i[n],fieldCount:s.length,field0:s[0],field1:s[1],field2:s[2],widthClass:"w150"}}else if(s.length==2){t={title:e.option,field:i[n],fieldCount:s.length,field0:s[0],field1:s[1],widthClass:"w150"}}else if(s.length==1){t={title:e.option,field:i[n],widthClass:"w150"};if(i[n]=="copyTo"||i[n]=="tags"){var a=b(c.searchResult);if(i[n]=="copyTo"){w(a)}else if(i[n]=="tags"){T(a)}}}c.visibleCustomField.push(t);break}else{e.selected=false}}c.customFields.push({value:e.value,title:e.option,selected:e.selected})}}});angular.forEach(c.customFields,function(t){if(t.systemFieldKey!="ticket_description"){var i={};if(t.systemFieldKey&&t.systemFieldKey=="subject"){t.ischecked=true;t.selected=true}if(c.showDefaultField){if(t.systemFieldKey=="priority"||t.systemFieldKey=="subject"){t.selected=true;i={title:t.title,field:t.systemFieldKey,widthClass:"w150"};c.visibleCustomField.push(i)}}else{var e=o.customFields.split(",");angular.forEach(e,function(e){if(t.id==e){t.selected=true;i={title:t.title,field:t.id,fieldCount:"customFields",widthClass:"w150"};c.visibleCustomField.push(i)}});if(t.systemFieldKey=="status"||t.systemFieldKey=="subject"||t.systemFieldKey=="priority"||t.systemFieldKey=="tags"){var n=o.fields.split(",");for(var s=0;s<n.length;s++){if(t.systemFieldKey==n[s]){t.selected=true;i={title:t.title,field:t.systemFieldKey,widthClass:"w150"};c.visibleCustomField.push(i);break}}if(t.systemFieldKey=="tags"){var a=b(c.searchResult);T(a)}}else if(t.systemFieldKey=="service_catalog"){var n=o.fields.split(",");for(var s=0;s<n.length;s++){if("serviceCatalog.id"==n[s]){t.selected=true;i={title:t.title,field:"serviceCatalog.id",fieldCount:2,field0:"serviceCatalog",field1:"id",widthClass:"w150"};c.visibleCustomField.push(i);l.get("list_service_catalog_name.json").success(function(e){if(e.success){c.servicecatalogs=e.json}else{}});break}}}else if(t.systemFieldKey=="ticket_type"){var n=o.fields.split(",");for(var s=0;s<n.length;s++){if("ticketType.name"==n[s]){t.selected=true;i={title:t.title,field:"ticketType.name",fieldCount:2,field0:"ticketType",field1:"name",widthClass:"w150"};c.visibleCustomField.push(i);break}}}}}else{r=t}});angular.forEach(c.visibleCustomField,function(e){if(e.field=="subject"){c.visibleCustomField.splice(c.visibleCustomField.indexOf(e),1);e.widthClass="w500";c.visibleCustomField.splice(1,0,e)}});c.customFields.splice(c.customFields.indexOf(r),1);n=v();var i=b(c.searchResult);C(i,n);g(i);S(i);if(s&&s>=20){c.searchResultHasMore=true}F()}});break;case"user":l({method:"GET",url:"/get_field_list.json?scope=user"}).success(function(e){if(e.success&&e.json&&e.json.customFields&&e.json.defaultFields){c.customFields=angular.copy(e.json.customFields);angular.forEach(e.json.defaultFields,function(e){var t={};if(e.key=="id"||e.key=="name"||e.key=="email"||e.key=="mobilePhone"){c.customFields.push({value:e.key,title:e.value,ischecked:true,selected:true});t={title:e.value,field:e.key};c.visibleCustomField.push(t)}else{if(c.showDefaultField){if(e.key=="nickname"||e.key=="createdAt"||e.key=="lastLoginAt"){c.customFields.push({value:e.key,title:e.value,selected:true});t={title:e.value,field:e.key};c.visibleCustomField.push(t)}else{c.customFields.push({value:e.key,title:e.value})}}else{var i=o.fields.split(",");for(var n=0;n<i.length;n++){if(e.key==i[n]){e.selected=true;t={title:e.value,field:e.key};c.visibleCustomField.push(t);break}else{e.selected=false}}c.customFields.push({value:e.key,title:e.value,selected:e.selected})}}});angular.forEach(c.customFields,function(e){if(!c.showDefaultField){var t=o.customFields.split(",");for(var i=0;i<t.length;i++){if(e.id){if(e.id==t[i]){var n={};e.selected=true;n={title:e.title,field:e.id,fieldCount:"customFieldsUser",widthClass:"w150"};c.visibleCustomField.push(n);break}else{e.selected=false}}}}});n=v();var t=k(c.searchResult);h(t,n);if(s&&s>=20){c.searchResultHasMore=true}F()}});break;case"userGroup":l({method:"GET",url:"/get_group_field_list.json?scope=user_group"}).success(function(e){if(e.success&&e.json&&e.json.customFields&&e.json.defaultFields){c.customFields=angular.copy(e.json.customFields);angular.forEach(e.json.defaultFields,function(e){var t={};if(e.key=="name"){c.customFields.push({value:e.key,title:e.value,ischecked:true,selected:true});t={title:e.value,field:e.key};c.visibleCustomField.push(t)}else{if(c.showDefaultField){if(e.key=="shared"||e.key=="createdAt"||e.key=="updatedAt"){c.customFields.push({value:e.key,title:e.value,selected:true});t={title:e.value,field:e.key};c.visibleCustomField.push(t)}else{c.customFields.push({value:e.key,title:e.value})}}else{var i=o.fields.split(",");for(var n=0;n<i.length;n++){if(e.key==i[n]){e.selected=true;t={title:e.value,field:e.key};c.visibleCustomField.push(t);break}else{e.selected=false}}c.customFields.push({value:e.key,title:e.value,selected:e.selected})}}});angular.forEach(c.customFields,function(e){if(!c.showDefaultField){var t=o.customFields.split(",");for(var i=0;i<t.length;i++){if(e.id){if(e.id==t[i]){var n={};e.selected=true;n={title:e.title,field:e.id,fieldCount:"customFieldsUserGroup",widthClass:"w150"};c.visibleCustomField.push(n);break}else{e.selected=false}}}}});n=v();var t=k(c.searchResult);y(t,n);if(s&&s>=20){c.searchResultHasMore=true}F()}});break;case"article":c.visibleCustomField=[{title:"更新于",fieldCount:"articleQuestion",field:"updatedAt",widthClass:"w150"},{title:"更新人",fieldCount:"articleQuestion",field:"updater.nickname",widthClass:"w150"},{title:"主题",fieldCount:"articleQuestion",field:"title",widthClass:"w150"},{title:"评论/回答",fieldCount:"articleQuestion",field:"answerCount",widthClass:"w150"}];if(s&&s>=20){c.searchResultHasMore=true}F();break;case"question":c.visibleCustomField=[{title:"更新于",fieldCount:"articleQuestion",field:"updatedAt"},{title:"更新人",fieldCount:"articleQuestion",field:"updater.nickname"},{title:"主题",fieldCount:"articleQuestion",field:"title"},{title:"评论/回答",fieldCount:"articleQuestion",field:"answerCount"}];if(s&&s>=20){c.searchResultHasMore=true}F();break}}e.$watch("ps.searchContent",function(e,t,i){if(e==""){c.showSearchResult=false;c.searchResult=[];c.isShowDeleteSearchContent=false;sessionStorage.removeItem("polymerizeSearchData")}else{c.isShowDeleteSearchContent=true}});e.$watch("ps.searchResult",function(e,t,i){if(c.searchType=="ticket"){var n=[];if(e.length>0){angular.forEach(e,function(e){n.push(e.id)})}o.setSearchIds(n)}});var g=function(e){if(e&&e.length>0){org.ewei.sdk.OpenTicketApi().listSubscriptionTicketIds({ticketIds:e?_.map(e.split(","),function(e){return parseInt(e)}):[]}).then(function(e){c.ticketsubscriptions=e})}};var v=function(){var t="";angular.forEach(c.visibleCustomField,function(e){if(e.fieldCount=="customFields"||e.fieldCount=="customFieldsUser"||e.fieldCount=="customFieldsUserGroup"){if(t==""){t=e.field}else{t+=","+e.field}}});return t};var h=function(e,t){l({url:"get_user_custom_fields.json",method:"POST",data:{userIds:e,customFieldIds:t}}).success(function(e,t,i,n){if(e.success){c.customFieldList=e.json}else{}})};var y=function(e,t){l({url:"get_user_group_custom_fields.json",method:"POST",data:{userGroupIds:e,customFieldIds:t}}).success(function(e,t,i,n){if(e.success){c.customFieldList=e.json}else{}})};var k=function(e){var t="";angular.forEach(e,function(e){if(angular.isDefined(e.id)){if(t==""){t=e.id}else{t+=","+e.id}}});return t};var C=function(e,t){l({url:"get_ticket_custom_fields.json",method:"POST",data:{ticketIds:e,customFieldIds:t}}).success(function(e,t,i,n){if(e.success){c.customFieldList=e.json}else{}})};var b=function(e){var t="";for(var i=0;i<e.length;i++){if(t==""){t=""+e[i].id}else{t+=","+e[i].id}}return t};var w=function(e){l({url:"copy_to_by_ticket_ids.json",method:"POST",data:{ticketIds:e}}).success(function(e,t,i,n){if(e.success){c.relatedCopyTos=e.json}else{}})};var T=function(e){l({url:"tags_by_ticket_ids.json",method:"POST",data:{ticketIds:e}}).success(function(e,t,i,n){if(e.success){c.relatedtags=e.json}else{}})};var S=function(e){l({url:"map_ticket_status_color_by_ticket_id.json",method:"POST",data:{ticketIds:e}}).success(function(e,t,i,n){if(e.success){c.ticketStatusColors=e.json}else{}})};c.deleteSearchContent=function(){c.searchContent=""};function F(){var e={searchType:c.searchType,searchContent:c.searchContent,searchView:c.searchView,searchResult:c.searchResult,showDefaultField:c.showDefaultField,visibleFieldId:c.visibleFieldId,isSenior:false,pageNum:c.page.pageNumber,isSearchTicketComment:c.isSearchTicketComment};var t=JSON.stringify(e);if(window.sessionStorage){sessionStorage.setItem("polymerizeSearchData",t)}}return c}})();(function(){"use strict";angular.module("eweiApp.polymerize_search").controller("polymerizeSearchSeniorController",e);e.$inject=["$scope","ConsoleConfig","$http","$state","$filter","serviceDeskService"];function e(e,t,i,n,o,s){var c=this;c.searchType="ticket";c.searchTicketCount=0;c.isShowCustomField=false;c.customFields=[];c.ticketCustomFields=[];c.userCustomFields=[];c.userGroupCustomFields=[];c.conditions={};c.seniorConditions=[];c.conditionsParam={};c.serviceDesks=[];c.articleQuestionTopic=[];c.isReaptSearch=true;c.conditions.createdAtFrom={startTimeForm:false,endTimeForm:false,startTime:"",endTime:""};c.conditions.updatedAtFrom={startTimeForm:false,endTimeForm:false,startTime:"",endTime:""};c.conditions.lastLoginAtFrom={startTimeForm:false,endTimeForm:false,startTime:"",endTime:""};i.get("custom_field.json?scope=ticket&active=true").success(function(e,t){c.ticketCustomFields=e.json;a(e.json)});c.changeSearchType=function(e){if(c.searchType!=e){c.searchType=e;c.isShowCustomField=false;c.customFields=[];switch(c.searchType){case"ticket":if(c.ticketCustomFields.length<=0){i.get("/custom_field.json?scope=ticket&active=true").success(function(e,t){c.ticketCustomFields=e.json;a(e.json)})}else{a(c.ticketCustomFields)}break;case"user":if(c.userCustomFields.length<=0){i.get("/custom_field.json?scope=user&active=true").success(function(e,t){c.userCustomFields=e.json;a(e.json)})}else{a(c.userCustomFields)}break;case"userGroup":if(c.userGroupCustomFields.length<=0){i.get("/custom_field.json?scope=user_group&active=true").success(function(e,t){c.userGroupCustomFields=e.json;a(e.json)})}else{a(c.userGroupCustomFields)}if(c.serviceDesks.length<=0){s.query({_count:999,_do_count:false,_filter:"{'$ne':{'deleted':true}}",_fields:"id,name"},function(e){if(e.serviceDesks&&e.serviceDesks!=""){for(var t=0;t<e.serviceDesks.length;t++){if(e.serviceDesks[t].name=="DEFAULT_SERVICE_DESK_NAME"){e.serviceDesks[t].name="默认服务台";break}}c.serviceDesks=e.serviceDesks}})}break;case"article":if(c.articleQuestionTopic.length<=0){i.get("/list_topic.json").success(function(e,t){angular.forEach(e.json,function(e){if(e.childrenCount>0){angular.forEach(e.children,function(e){c.articleQuestionTopic.push({id:e.id,name:e.name})})}})})}break;case"question":if(c.articleQuestionTopic.length<=0){i.get("/list_topic.json").success(function(e,t){angular.forEach(e.json,function(e){if(e.childrenCount>0){angular.forEach(e.children,function(e){c.articleQuestionTopic.push({id:e.id,name:e.name})})}})})}break}}};c.showCustomField=function(){c.isShowCustomField=!c.isShowCustomField};var a=function(e){var t=e;var i=[];for(var n=0;n<t.length;n++){var s=t[n];t[n].required=false;if(s.active!=true||s.systemFieldKey!=null&&s.systemFieldKey!=""){continue}var a={id:null,value:s.value,customField:null};try{if(s.type=="options"&&s.customFieldOptions){var r=angular.fromJson(s.customFieldOptions);if(r[0].value!=""){r.unshift({name:"-",value:""})}s.customFieldOptions=r;if(s.value==undefined||s.value==""){a.value=""}}}catch(e){void 0}if(s.type=="checkbox"){if(s.value=="true"){a.value=true}else{a.value=false}}if(s.notes!=undefined&&s.notes.length>40){s.notes=s.notes.substring(0,12)+". . . "}if(s.url){if(s.url.toLowerCase().indexOf("http://")!=0){s.url="http://"+s.url}if(s.url.indexOf("?")<0){a.fromParams="?"}else{a.fromParams="&"}var o=new String(s.url);if(o.indexOf("{value}")>0){o=o.replaceAll("{value}",a.value)}else{o=o+a.value}a.valueUrl=o}if(s.type=="date"){s.startForm=false}else if(s.type=="date_to_date"){s.startTimeForm=false;s.endTimeForm=false;if(s.value){var l=s.value.split("-");s.startTime=l[0];s.endTime=l[1]}}a.customField=s;a.id=s.ticketCustomFieldId;i.push(a)}c.customFields=i};c.search=function(){if(c.isReaptSearch){var e="";c.isReaptSearch=false;r();i({method:"GET",url:"/search_view/"+c.searchType+".json"}).success(function(e){if(e.success){if(e.json){c.searchView=e.json;c.showDefaultField=false;c.visibleFieldId=e.json.id}else{c.showDefaultField=true}l()}})}};c.open=function(e,t){e.preventDefault();e.stopPropagation();if(t.startForm){t.startForm=false}else{t.startForm=true}};c.timeFrameOpen=function(e,t,i){e.preventDefault();e.stopPropagation();if(i=="startTimeForm"){t.startTimeForm=!t.startTimeForm}else{t.endTimeForm=!t.endTimeForm}};function r(){var e=c.conditions;c.conditionsParam={};c.customCoditions=[];c.seniorConditions=[];if(e.createdAtFrom.startTime){e.createdAtFrom.startTime.setHours(0,0,0,0);c.conditionsParam.createdAtFrom=o("date")(e.createdAtFrom.startTime,"yyyy-MM-dd HH:mm:ss");c.seniorConditions.push({name:"创建于",value:"开始于"+o("date")(e.createdAtFrom.startTime,"yyyy/MM/dd"),key:"createdAt",type:"systemFields"})}if(e.createdAtFrom.endTime){e.createdAtFrom.endTime.setHours(23,59,59,999);c.conditionsParam.createdAtTo=o("date")(e.createdAtFrom.endTime,"yyyy-MM-dd HH:mm:ss");if(e.createdAtFrom.startTime){c.seniorConditions[0].value=o("date")(e.createdAtFrom.startTime,"yyyy/MM/dd")+"-"+o("date")(e.createdAtFrom.endTime,"yyyy/MM/dd")}else{c.seniorConditions.push({name:"创建于",value:"截止于"+o("date")(e.createdAtFrom.endTime,"yyyy/MM/dd"),key:"createdAt",type:"systemFields"})}}if(e.updatedAtFrom.startTime){e.updatedAtFrom.startTime.setHours(0,0,0,0);c.conditionsParam.updatedAtFrom=o("date")(e.updatedAtFrom.startTime,"yyyy-MM-dd HH:mm:ss");c.seniorConditions.push({name:"更新于",value:"开始于"+o("date")(e.updatedAtFrom.startTime,"yyyy/MM/dd"),key:"updatedAt",type:"systemFields"})}if(e.updatedAtFrom.endTime){e.updatedAtFrom.endTime.setHours(23,59,59,999);c.conditionsParam.updatedAtTo=o("date")(e.updatedAtFrom.endTime,"yyyy-MM-dd HH:mm:ss");var t=0;for(var i=0;i<c.seniorConditions.length;i++){if(c.seniorConditions[i].key=="updatedAt"){c.seniorConditions[i].value=o("date")(e.updatedAtFrom.startTime,"yyyy/MM/dd")+"-"+o("date")(e.updatedAtFrom.endTime,"yyyy/MM/dd");t=1;break}}if(t==0){c.seniorConditions.push({name:"更新于",value:"截止于"+o("date")(e.updatedAtFrom.endTime,"yyyy/MM/dd"),key:"updatedAt",type:"systemFields"})}}switch(c.searchType){case"ticket":if(e.serviceDesk!=null){if(e.engineer){c.conditionsParam.engineer={id:e.engineer.id};c.conditionsParam.serviceDesk={id:e.serviceDesk.id};c.seniorConditions.push({name:"处理人",value:e.engineer.username,key:"engineer.user.name",type:"systemFields"})}else{c.conditionsParam.serviceDesk={id:e.serviceDesk.id};c.seniorConditions.push({name:"处理人",value:e.serviceDesk.name,key:"engineer.user.name",type:"systemFields"})}}if(e.ticketType!=null){c.conditionsParam.ticketType={id:e.ticketType.id,name:e.ticketType.name};c.seniorConditions.push({name:"工单类型",value:e.ticketType.name,key:"ticketType.name",type:"systemFields"})}if(e.user!=null){c.conditionsParam.user={id:e.user.id};c.seniorConditions.push({name:"创建人",value:e.user.name,key:"user.name",type:"systemFields"})}if(e.serviceCatalog!=null){c.conditionsParam.serviceCatalog={id:e.serviceCatalog.id};c.seniorConditions.push({name:"服务目录",value:e.serviceCatalog.name,key:"serviceCatalog.id",type:"systemFields"})}if(e.via!=null){c.conditionsParam.via={id:e.via.id,name:e.via.name,uid:e.via.uid};c.seniorConditions.push({name:"渠道",value:e.via.name,key:"via.channelName",type:"systemFields"})}if(e.viaType){c.conditionsParam.viaType=e.viaChannel}if(e.ccs!=null&&e.ccs.length>0){c.conditionsParam.ccs=[];var n="";angular.forEach(e.ccs,function(e){if(e.type==="engineer"){c.conditionsParam.ccs.push({id:e.id,serviceDeskId:e.groupId})}else{c.conditionsParam.ccs.push({id:e.id,userGroupId:e.groupId})}if(n==""){n=e.name}else{n+=","+e.name}});c.seniorConditions.push({name:"抄送给",value:n,key:"copyTo",type:"systemFields"})}if(e.status!=null){c.conditionsParam.status=e.status;c.seniorConditions.push({name:"工单状态",value:e.status,key:"status",type:"systemFields"})}break;case"user":if(e.lastLoginAtFrom.startTime){c.conditionsParam.lastLoginAtFrom=o("date")(e.lastLoginAtFrom.startTime,"yyyy-MM-dd HH:mm:ss");c.seniorConditions.push({name:"最近登录",value:"开始于"+o("date")(e.lastLoginAtFrom.startTime,"yyyy/MM/dd"),key:"lastLoginAtFrom",type:"systemFields"})}if(e.lastLoginAtFrom.endTime){c.conditionsParam.lastLoginAtTo=o("date")(e.lastLoginAtFrom.endTime,"yyyy-MM-dd HH:mm:ss");var t=0;for(var i=0;i<c.seniorConditions.length;i++){if(c.seniorConditions[i].key=="lastLoginAtFrom"){c.seniorConditions[i].value=o("date")(e.lastLoginAtFrom.startTime,"yyyy/MM/dd")+"-"+o("date")(e.updatedAtFrom.endTime,"yyyy/MM/dd");t=1;break}}if(t==0){c.seniorConditions.push({name:"最近登录",value:"截止于"+o("date")(e.lastLoginAtFrom.endTime,"yyyy/MM/dd"),key:"lastLoginAtFrom",type:"systemFields"})}}if(e.name){c.seniorConditions.push({name:"姓名",value:e.name,key:"name",type:"systemFields"});c.conditionsParam.name=encodeURI(e.name)}if(e.nickname){c.seniorConditions.push({name:"昵称",value:e.nickname,key:"nickname",type:"systemFields"});c.conditionsParam.nickname=encodeURI(e.nickname)}if(e.userGroup){c.seniorConditions.push({name:"分组",value:e.userGroup,key:"userGroup",type:"systemFields"});c.conditionsParam.userGroup=encodeURI(e.userGroup)}if(e.email){c.seniorConditions.push({name:"邮箱",value:e.email,key:"email",type:"systemFields"});c.conditionsParam.email=encodeURI(e.email)}if(e.mobilePhone){c.seniorConditions.push({name:"手机",value:e.mobilePhone,key:"mobilePhone",type:"systemFields"});c.conditionsParam.mobilePhone=encodeURI(e.mobilePhone)}if(e.phone){c.seniorConditions.push({name:"电话",value:e.phone,key:"phone",type:"systemFields"});c.conditionsParam.phone=encodeURI(e.phone)}break;case"userGroup":if(e.name){c.seniorConditions.push({name:"组名称",value:e.name,key:"name",type:"systemFields"});c.conditionsParam.name=encodeURI(e.name)}if(e.shared){c.conditionsParam.shared=e.shared;var s="";if(e.shared=="false"){s="否"}else{s="是"}c.seniorConditions.push({name:"工单共享",value:s,key:"shared",type:"systemFields"})}if(e.domain_names){c.seniorConditions.push({name:"Email域名",value:e.domain_names,key:"domain_names",type:"systemFields"});c.conditionsParam.domain_names=encodeURI(e.domain_names)}if(e.serviceDesk){c.conditionsParam.service_desk_id=e.serviceDesk.id+"";c.seniorConditions.push({name:"绑定的客服组",value:e.serviceDesk.name,key:"serviceDesk.id",type:"systemFields"})}break;case"article":if(e.author){c.conditionsParam.author={id:e.author.id};c.seniorConditions.push({name:"创建人",value:e.author.name,key:"author",type:"systemFields"})}if(e.topic){c.conditionsParam.topic={id:e.topic.id};c.seniorConditions.push({name:"目录",value:e.topic.name,key:"topic",type:"systemFields"})}if(e.title){c.seniorConditions.push({name:"主题",value:e.title,key:"title",type:"systemFields"});c.conditionsParam.title=e.title}break;case"question":if(e.author){c.conditionsParam.author={id:e.author.id};c.seniorConditions.push({name:"创建人",value:e.author.name,key:"author",type:"systemFields"})}if(e.topic){c.conditionsParam.topic={id:e.topic.id};c.seniorConditions.push({name:"目录",value:e.topic.name,key:"topic",type:"systemFields"})}if(e.title){c.seniorConditions.push({name:"主题",value:e.title,key:"title",type:"systemFields"});c.conditionsParam.title=e.title}break}var a=[];if(c.searchType=="ticket"||c.searchType=="user"||c.searchType=="userGroup"){var r={};angular.forEach(c.customFields,function(e){r=e.customField;if(r.type=="date_to_date"){if(r.startTime&&r.endTime){var t="";var i="";e.value=o("date")(r.startTime,"yyyy/MM/dd")+"-"+o("date")(r.endTime,"yyyy/MM/dd");a.push({id:r.id,value:e.value,type:r.type});c.seniorConditions.push({name:r.title,value:e.value,key:r.id,type:r.type})}}else{if(e.value&&e.value!="-"||e.customField.value){e.value=e.value?e.value:e.customField.value;if(r.type=="date"){e.value=o("date")(e.value,"yyyy/MM/dd")}c.seniorConditions.push({name:r.title,value:e.value,key:r.id,type:r.type});a.push({id:r.id,value:e.value,type:r.type})}}})}if(a.length>0){c.customCoditions=a}}function l(){var e={pageNumber:1,pageSize:20};c.isReaptSearch=true;switch(c.searchType){case"ticket":c.loading="/ticket/multi_condition.json?_page="+e.pageNumber+"&_count="+e.pageSize+"&conditions="+JSON.stringify(c.conditionsParam)+"&customCoditions="+JSON.stringify(c.customCoditions);i({url:c.loading,method:"GET"}).success(function(e){if(e.success){var t=e.json.tickets||[];c.searchTicketCount=e.json.total;u(t)}});break;case"user":c.loading="/search_users_advanced.json?_page="+e.pageNumber+"&_count="+e.pageSize+"&advancedCoditions="+JSON.stringify(c.conditionsParam)+"&customCoditions="+JSON.stringify(c.customCoditions);i({url:c.loading,method:"GET"}).success(function(e){if(e.success&&e.json){u(e.json)}});break;case"userGroup":c.loading="/search_user_groups_advanced.json?_page="+e.pageNumber+"&_count="+e.pageSize+"&advancedCoditions="+JSON.stringify(c.conditionsParam)+"&customCoditions="+JSON.stringify(c.customCoditions);i({url:c.loading,method:"GET"}).success(function(e){if(e.success&&e.json){u(e.json)}});break;case"article":org.ewei.sdk.OpenArticleApi().multiCondition({page:e,conditions:JSON.stringify(c.conditionsParam),topicTypes:["TYPE_ANNOUNCEMENT","TYPE_ARTICLES","TYPE_DRAFT","TYPE_MANAGE","TYPE_WEIXIN_JOKE"]}).then(function(e){u(e.list)});break;case"question":org.ewei.sdk.OpenArticleApi().multiCondition({page:e,conditions:JSON.stringify(c.conditionsParam),topicTypes:["TYPE_QUESTIONS","TYPE_DELETE","TYPE_DEFAULT"]}).then(function(e){u(e.list)});break}}c.goNormalSearch=function(){sessionStorage.removeItem("polymerizeSearchData");n.go("polymerize_search")};function u(e){var t={searchType:c.searchType,searchContent:"none",searchView:c.searchView,searchResult:e,showDefaultField:c.showDefaultField,visibleFieldId:c.visibleFieldId,isSenior:true,conditionsParam:c.conditionsParam,customCoditions:c.customCoditions,seniorConditions:c.seniorConditions,pageNum:1,searchTicketCount:c.searchTicketCount};var i=JSON.stringify(t);if(window.sessionStorage){sessionStorage.setItem("polymerizeSearchData",i)}n.go("polymerize_search_senior_result")}return c}})();(function(){"use strict";angular.module("eweiApp.polymerize_search").controller("polymerizeSearchSeniorResultController",e);e.$inject=["$scope","ConsoleConfig","$http","ticketListCustomOptions","ticketListCustomGroupByOptions","alertService","$state","tabs","polymerizeSearchService"];function e(e,t,l,a,i,n,s,r,o){var u=this;u.searchType="ticket";u.searchTicketCount=0;u.isShowCustomField=false;u.visibleCustomField=[];u.isAbleSet=true;u.searchView={};u.searchResult=[];u.searchResultIsNone=false;u.searchResultHasMore=false;u.page={pageNumber:1,pageSize:20};u.loading="";u.showDefaultField=true;u.visibleFieldId="";u.exactResult=[];u.exactCustomIds="";u.showLoading=false;u.showTable=true;if(window.sessionStorage){var c;try{c=sessionStorage.getItem("polymerizeSearchData")}catch(e){void 0}if(c){u.showLoading=true;u.showTable=false;var d=JSON.parse(c);u.searchType=d.searchType;u.searchView=d.searchView;u.searchResult=d.searchResult;u.showDefaultField=d.showDefaultField;u.visibleFieldId=d.visibleFieldId;u.page.pageNumber=1;u.conditionsParam=d.conditionsParam;u.customCoditions=d.customCoditions;u.seniorConditions=d.seniorConditions;u.searchTicketCount=d.searchTicketCount;for(var p=0;p<u.seniorConditions.length;p++){var f=u.seniorConditions[p];if(f.key=="engineer.user.name"){if(f.value=="DEFAULT_SERVICE_DESK_NAME"){f.value="默认服务台"}break}}if(u.searchResult.length<=20){v(u.searchView,u.searchResult)}else{m("again")}}}if(u.searchType=="ticket"||u.searchType=="user"||u.searchType=="userGroup"){u.isAbleSet=true}else{u.isAbleSet=false}if(u.seniorConditions){if(u.seniorConditions.length<=0){u.isNoneCondition=false}else{u.isNoneCondition=true}}for(var p=0;p<r.length;p++){if(r[p].active){r[p].active=false;break}}u.selectCustomField=function(e){if(!e.ischecked){var t=0;angular.forEach(u.customFields,function(e){if(e.selected){t++}});if(e.selected){e.selected=false}else{if(t<10){e.selected=true}else{n.add("显示的列不能超过10个","danger")}}}};u.export=function(){var e="";var t="";if(u.searchType=="ticket"){e="/ticket_multi_export_excel.json"}else if(u.searchType=="user"){e="/user_multi_export_excel.json"}else if(u.searchType=="userGroup"){e="/user_group_multi_export_excel.json"}else if(u.searchType=="question"){e="/question_multi_export_excel.json"}else{e="/article_multi_export_excel.json"}angular.forEach(u.visibleCustomField,function(e){t+=e.field+","});t=t.substring(0,t.length-1);e+="?searchType=advancedQuery&conditions="+JSON.stringify(u.conditionsParam)+"&customCoditions="+JSON.stringify(u.customCoditions)+"&title="+t;window.open(e)};u.showCustomField=function(){if(u.searchType=="ticket"||u.searchType=="user"||u.searchType=="userGroup"){u.isShowCustomField=!u.isShowCustomField}};u.saveVisibleCustomField=function(){u.showLoading=true;u.showTable=false;var i={customFields:"",fields:"",otherFields:"",type:u.searchType,id:u.visibleFieldId};u.searchView=i;var t=[];angular.forEach(u.customFields,function(e){if(e.selected){t.push(e)}});angular.forEach(t,function(e){if(e.id&&!e.systemFieldKey){if(i.customFields==""){i.customFields+=e.id}else{i.customFields+=","+e.id}}else{var t="";if(e.systemFieldKey){if(e.systemFieldKey=="ticket_type"){t="ticketType.name"}else if(e.systemFieldKey=="service_catalog"){t="serviceCatalog.id"}else{t=e.systemFieldKey}}else{t=e.value}if(i.fields==""){i.fields=t}else{i.fields+=","+t}if(u.searchType=="ticket"){if(e.value=="copyTo"||e.value=="tags"){if(i.otherFields==""){i.otherFields=e.value}else{i.otherFields+=","+e.value}}}}});l({method:"POST",url:"/search_view.json",data:i}).success(function(e){if(e.success){u.visibleCustomField=[];u.page.pageNumber=1;m("again");u.isShowCustomField=false;u.showDefaultField=false}})};u.clearAllSearchCondition=function(){sessionStorage.removeItem("polymerizeSearchData");s.go("polymerize_search_senior")};u.clearSearchCondition=function(e){u.showLoading=true;u.showTable=false;if(e.type=="systemFields"){if(e.key=="createdAt"){if(u.conditionsParam.createdAtFrom){delete u.conditionsParam.createdAtFrom}if(u.conditionsParam.createdAtTo){delete u.conditionsParam.createdAtTo}}else if(e.key=="updatedAt"){if(u.conditionsParam.updatedAtFrom){delete u.conditionsParam.updatedAtFrom}if(u.conditionsParam.updatedAtTo){delete u.conditionsParam.updatedAtTo}}else{switch(u.searchType){case"ticket":if(e.key=="engineer.user.name"){delete u.conditionsParam.serviceDesk}else if(e.key=="ticketType.name"){delete u.conditionsParam.ticketType}else if(e.key=="user.name"){delete u.conditionsParam.user}else if(e.key=="serviceCatalog.id"){delete u.conditionsParam.serviceCatalog}else if(e.key=="via.channelName"){delete u.conditionsParam.via}else if(e.key=="copyTo"){delete u.conditionsParam.ccs}else if(e.key=="status"){delete u.conditionsParam.status}break;case"user":if(e.key=="lastLoginAtFrom"){if(u.conditionsParam.lastLoginAtFrom){delete u.conditionsParam.lastLoginAtFrom}if(u.conditionsParam.lastLoginAtTo){delete u.conditionsParam.lastLoginAtTo}}else if(e.key=="name"){delete u.conditionsParam.name}else if(e.key=="nickname"){delete u.conditionsParam.nickname}else if(e.key=="userGroup"){delete u.conditionsParam.userGroup}else if(e.key=="email"){delete u.conditionsParam.email}else if(e.key=="mobilePhone"){delete u.conditionsParam.mobilePhone}else if(e.key=="phone"){delete u.conditionsParam.phone}break;case"userGroup":if(e.key=="name"){delete u.conditionsParam.name}else if(e.key=="shared"){delete u.conditionsParam.shared}else if(e.key=="domain_names"){delete u.conditionsParam.domain_names}else if(e.key=="serviceDesk.id"){delete u.conditionsParam.service_desk_id}break;case"article":if(e.key=="author"){delete u.conditionsParam.author}else if(e.key=="topic"){delete u.conditionsParam.topic}else if(e.key=="title"){delete u.conditionsParam.title}break;case"question":if(e.key=="author"){delete u.conditionsParam.author}else if(e.key=="topic"){delete u.conditionsParam.topic}else if(e.key=="title"){delete u.conditionsParam.title}break}}}else{var t=u.customCoditions;for(var i=0;i<t.length;i++){if(e.key==t[i].id){u.customCoditions.splice(i,1);break}}}u.page.pageNumber=1;u.seniorConditions.splice(u.seniorConditions.indexOf(e),1);m("again")};u.searchMore=function(){u.showLoading=true;u.page.pageNumber++;m("more")};function m(n){u.isReaptSearch=true;var s="";switch(u.searchType){case"ticket":u.loading="/ticket/multi_condition.json?_page="+u.page.pageNumber+"&_count="+u.page.pageSize+"&conditions="+JSON.stringify(u.conditionsParam)+"&customCoditions="+JSON.stringify(u.customCoditions);l({url:u.loading,method:"GET"}).success(function(e){if(e.success&&e.json.tickets){u.searchTicketCount=e.json.total;if(n=="more"){g(e.json.tickets);s=k();var t=S(u.searchResult);T(t,s);h();$();u.showLoading=false}else{v(u.searchView,e.json.tickets)}}else{u.showLoading=false}});break;case"user":u.loading="/search_users_advanced.json?_page="+u.page.pageNumber+"&_count="+u.page.pageSize+"&advancedCoditions="+JSON.stringify(u.conditionsParam)+"&customCoditions="+JSON.stringify(u.customCoditions);l({url:u.loading,method:"GET"}).success(function(e){if(e.success&&e.json){if(n=="more"){g(e.json);s=k();var t=w(u.searchResult);C(t,s);h();$();u.showLoading=false}else{v(u.searchView,e.json)}}else{u.showLoading=false}});break;case"userGroup":u.loading="/search_user_groups_advanced.json?_page="+u.page.pageNumber+"&_count="+u.page.pageSize+"&advancedCoditions="+JSON.stringify(u.conditionsParam)+"&customCoditions="+JSON.stringify(u.customCoditions);l({url:u.loading,method:"GET"}).success(function(e){if(e.success&&e.json){if(n=="more"){g(e.json);s=k();var t=w(u.searchResult);b(t,s);h();$();u.showLoading=false}else{v(u.searchView,e.json)}}else{u.showLoading=false}});break;case"article":org.ewei.sdk.OpenArticleApi().multiCondition({page:u.page,conditions:JSON.stringify(u.conditionsParam),topicTypes:["TYPE_ANNOUNCEMENT","TYPE_ARTICLES","TYPE_DRAFT","TYPE_MANAGE","TYPE_WEIXIN_JOKE"]}).then(function(e){var t=e.list;if(t.length>0){if(n=="more"){g(t);s=k();var i=w(u.searchResult);b(i,s);h();$();u.showLoading=false}else{v(u.searchView,t)}}else{u.showLoading=false}});break;case"question":org.ewei.sdk.OpenArticleApi().multiCondition({page:u.page,conditions:JSON.stringify(u.conditionsParam),topicTypes:["TYPE_QUESTIONS","TYPE_DELETE","TYPE_DEFAULT"]}).then(function(e){var t=e.list;if(t.length>0){if(n=="more"){g(t);h();$();u.showLoading=false}else{v(u.searchView,t)}}else{u.showLoading=false}});break}}function g(e){var t;if(e){t=e.length;if(e.length>0){if(u.page.pageNumber==1){u.searchResult=e}else{u.searchResult=u.searchResult.concat(e);if(t&&t>=20){u.searchResultHasMore=true}else{u.searchResultHasMore=false}return}}else{if(u.page.pageNumber==1){u.searchResult=[];u.searchResultIsNone=true}}}if(t&&t>=20){u.searchResultHasMore=true}}function v(o,e){var n="";var s;u.visibleCustomField=[];if(e){g(e);s=e.length;if(s>0){u.searchResultIsNone=false}else{u.searchResultIsNone=true}}switch(u.searchType){case"ticket":l({method:"GET",url:"custom_field.json?scope=ticket&active=true"}).success(function(e){if(e.success&&e.json){void 0;var r={};u.customFields=e.json;var t=angular.copy(a);angular.forEach(t,function(e){var t={};if(e.value=="no"||e.value=="requester.name"){u.customFields.push({value:e.value,title:e.option,ischecked:true,selected:true});if(e.value=="no"){t={title:e.option,field:e.value,widthClass:"w150"}}else{t={title:e.option,field:e.value,fieldCount:2,field0:"requester",field1:"name",widthClass:"w150"}}u.visibleCustomField.push(t)}else{if(u.showDefaultField){if(e.value=="serviceDesk.name"||e.value=="via.channelName"||e.value=="createdAt"){u.customFields.push({value:e.value,title:e.option,selected:true});if(e.value=="serviceDesk.name"){t={title:e.option,field:e.value,fieldCount:2,field0:"serviceDesk",field1:"name",widthClass:"w150"}}else if(e.value=="via.channelName"){t={title:e.option,field:e.value,fieldCount:2,field0:"via",field1:"channelName",widthClass:"w150"}}else{t={title:e.option,field:e.value,widthClass:"w150"}}u.visibleCustomField.push(t)}else{u.customFields.push({value:e.value,title:e.option})}}else{var i=o.fields.split(",");for(var n=0;n<i.length;n++){if(e.value==i[n]){e.selected=true;var s=i[n].split(".");if(s.length==3){t={title:e.option,field:i[n],fieldCount:s.length,field0:s[0],field1:s[1],field2:s[2],widthClass:"w150"}}else if(s.length==2){t={title:e.option,field:i[n],fieldCount:s.length,field0:s[0],field1:s[1],widthClass:"w150"}}else if(s.length==1){t={title:e.option,field:i[n],widthClass:"w150"};if(i[n]=="copyTo"||i[n]=="tags"){var a=S(u.searchResult);if(i[n]=="copyTo"){F(a)}else if(i[n]=="tags"){A(a)}}}u.visibleCustomField.push(t);break}else{e.selected=false}}u.customFields.push({value:e.value,title:e.option,selected:e.selected})}}});angular.forEach(u.customFields,function(t){if(t.systemFieldKey!="ticket_description"){var i={};if(t.systemFieldKey&&t.systemFieldKey=="subject"){t.ischecked=true;t.selected=true}if(u.showDefaultField){if(t.systemFieldKey=="priority"||t.systemFieldKey=="subject"){t.selected=true;i={title:t.title,field:t.systemFieldKey,widthClass:"w150"};u.visibleCustomField.push(i)}}else{var e=o.customFields.split(",");angular.forEach(e,function(e){if(t.id==e){t.selected=true;i={title:t.title,field:t.id,fieldCount:"customFields",widthClass:"w150"};u.visibleCustomField.push(i)}});if(t.systemFieldKey=="status"||t.systemFieldKey=="subject"||t.systemFieldKey=="priority"||t.systemFieldKey=="tags"){var n=o.fields.split(",");for(var s=0;s<n.length;s++){if(t.systemFieldKey==n[s]){t.selected=true;i={title:t.title,field:t.systemFieldKey,widthClass:"w150"};u.visibleCustomField.push(i);break}}if(t.systemFieldKey=="tags"){var a=S(u.searchResult);A(a)}}else if(t.systemFieldKey=="service_catalog"){var n=o.fields.split(",");for(var s=0;s<n.length;s++){if("serviceCatalog.id"==n[s]){t.selected=true;i={title:t.title,field:"serviceCatalog.id",fieldCount:2,field0:"serviceCatalog",field1:"id",widthClass:"w150"};u.visibleCustomField.push(i);l.get("list_service_catalog_name.json").success(function(e){if(e.success){u.servicecatalogs=e.json}else{}});break}}}else if(t.systemFieldKey=="ticket_type"){var n=o.fields.split(",");for(var s=0;s<n.length;s++){if("ticketType.name"==n[s]){t.selected=true;i={title:t.title,field:"ticketType.name",fieldCount:2,field0:"ticketType",field1:"name",widthClass:"w150"};u.visibleCustomField.push(i);break}}}}}else{r=t}});angular.forEach(u.visibleCustomField,function(e){if(e.field=="subject"){u.visibleCustomField.splice(u.visibleCustomField.indexOf(e),1);e.widthClass="w500";u.visibleCustomField.splice(1,0,e)}});h();u.customFields.splice(u.customFields.indexOf(r),1);n=k();var i=S(u.searchResult);T(i,n);y(i);E(i);if(s&&s>=20){u.searchResultHasMore=true}$();u.showLoading=false;u.showTable=true}});break;case"user":l({method:"GET",url:"/get_field_list.json?scope=user"}).success(function(e){if(e.success&&e.json&&e.json.customFields&&e.json.defaultFields){u.customFields=angular.copy(e.json.customFields);angular.forEach(e.json.defaultFields,function(e){var t={};if(e.key=="id"||e.key=="name"||e.key=="email"||e.key=="mobilePhone"){u.customFields.push({value:e.key,title:e.value,ischecked:true,selected:true});t={title:e.value,field:e.key,widthClass:"w150"};u.visibleCustomField.push(t)}else{if(u.showDefaultField){if(e.key=="nickname"||e.key=="createdAt"||e.key=="lastLoginAt"){u.customFields.push({value:e.key,title:e.value,selected:true});t={title:e.value,field:e.key,widthClass:"w150"};u.visibleCustomField.push(t)}else{u.customFields.push({value:e.key,title:e.value})}}else{var i=o.fields.split(",");for(var n=0;n<i.length;n++){if(e.key==i[n]){e.selected=true;t={title:e.value,field:e.key,widthClass:"w150"};u.visibleCustomField.push(t);break}else{e.selected=false}}u.customFields.push({value:e.key,title:e.value,selected:e.selected})}}});angular.forEach(u.customFields,function(e){if(!u.showDefaultField){var t=o.customFields.split(",");for(var i=0;i<t.length;i++){if(e.id){if(e.id==t[i]){var n={};e.selected=true;n={title:e.title,field:e.id,fieldCount:"customFieldsUser",widthClass:"w150"};u.visibleCustomField.push(n);break}else{e.selected=false}}}}});h();n=k();var t=w(u.searchResult);C(t,n);if(s&&s>=20){u.searchResultHasMore=true}$();u.showLoading=false;u.showTable=true}});break;case"userGroup":l({method:"GET",url:"/get_group_field_list.json?scope=user_group"}).success(function(e){if(e.success&&e.json&&e.json.customFields&&e.json.defaultFields){u.customFields=angular.copy(e.json.customFields);angular.forEach(e.json.defaultFields,function(e){var t={};if(e.key=="name"){u.customFields.push({value:e.key,title:e.value,ischecked:true,selected:true});t={title:e.value,field:e.key,widthClass:"w150"};u.visibleCustomField.push(t)}else{if(u.showDefaultField){if(e.key=="shared"||e.key=="createdAt"||e.key=="updatedAt"){u.customFields.push({value:e.key,title:e.value,selected:true});t={title:e.value,field:e.key,widthClass:"w150"};u.visibleCustomField.push(t)}else{u.customFields.push({value:e.key,title:e.value})}}else{var i=o.fields.split(",");for(var n=0;n<i.length;n++){if(e.key==i[n]){e.selected=true;t={title:e.value,field:e.key,widthClass:"w150"};u.visibleCustomField.push(t);break}else{e.selected=false}}u.customFields.push({value:e.key,title:e.value,selected:e.selected})}}});angular.forEach(u.customFields,function(e){if(!u.showDefaultField){var t=o.customFields.split(",");for(var i=0;i<t.length;i++){if(e.id){if(e.id==t[i]){var n={};e.selected=true;n={title:e.title,field:e.id,fieldCount:"customFieldsUserGroup",widthClass:"w150"};u.visibleCustomField.push(n);break}else{e.selected=false}}}}});h();n=k();var t=w(u.searchResult);b(t,n);if(s&&s>=20){u.searchResultHasMore=true}$();u.showLoading=false;u.showTable=true}});break;case"article":u.visibleCustomField=[{title:"创建于",fieldCount:"articleQuestion",field:"createdAt",widthClass:"w150"},{title:"更新于",fieldCount:"articleQuestion",field:"updatedAt",widthClass:"w150"},{title:"更新人",fieldCount:"articleQuestion",field:"updater.nickname",widthClass:"w150"},{title:"主题",fieldCount:"articleQuestion",field:"title",widthClass:"w150"},{title:"评论/回答",fieldCount:"articleQuestion",field:"answerCount",widthClass:"w150"}];if(s&&s>=20){u.searchResultHasMore=true}u.showLoading=false;u.showTable=true;break;case"question":u.visibleCustomField=[{title:"创建于",fieldCount:"articleQuestion",field:"createdAt",widthClass:"w150"},{title:"更新于",fieldCount:"articleQuestion",field:"updatedAt",widthClass:"w150"},{title:"更新人",fieldCount:"articleQuestion",field:"updater.nickname",widthClass:"w150"},{title:"主题",fieldCount:"articleQuestion",field:"title",widthClass:"w150"},{title:"评论/回答",fieldCount:"articleQuestion",field:"answerCount",widthClass:"w150"}];if(s&&s>=20){u.searchResultHasMore=true}u.showLoading=false;u.showTable=true;break}}function h(){u.exactResult=[];for(var e=0;e<u.searchResult.length;e++){var c=u.searchResult[e];c.exactResult=[];angular.forEach(u.seniorConditions,function(e){var t=false;for(var i=0;i<u.visibleCustomField.length;i++){if(e.key==u.visibleCustomField[i].field){t=true;break}}if(!t){if(Object.prototype.toString.call(e.key)=="[object String]"){var n=e.key.split(".");var s="";var a="";var r="";var o="";if(n.length==3){a=n[0];r=n[1];o=n[2];if(a=="engineer"){if(c[a]){s=c[a][r][o]}else{if(c.serviceDesk.name=="DEFAULT_SERVICE_DESK_NAME"){s="默认服务台"}else{s=c.serviceDesk.name}}}else{s=c[a][r][o]}}else if(n.length==2){a=n[0];r=n[1];s=c[a][r]}else{a=n[0];s=c[a];if(!s){s=e.value}}c.exactResult.push({name:e.name,value:s,type:"systemFields"})}else{u.exactCustomIds+=","+e.key;var l="";if(u.searchType=="user"){l="customFieldsUser"}else if(u.searchType=="userGroup"){l="customFieldsUserGroup"}else{l="customFields"}c.exactResult.push({name:e.name,id:c.id,field:e.key,type:l})}}})}void 0}u.goNormalSearch=function(){sessionStorage.removeItem("polymerizeSearchData");s.go("polymerize_search")};var y=function(e){if(e&&e.length>0){org.ewei.sdk.OpenTicketApi().listSubscriptionTicketIds({ticketIds:e?_.map(e.split(","),function(e){return parseInt(e)}):[]}).then(function(e){u.ticketsubscriptions=e})}};var k=function(){var t="";angular.forEach(u.visibleCustomField,function(e){if(e.fieldCount=="customFields"||e.fieldCount=="customFieldsUser"||e.fieldCount=="customFieldsUserGroup"){if(t==""){t=e.field}else{t+=","+e.field}}});if(t){t+=u.exactCustomIds}else{if(u.exactCustomIds){t=u.exactCustomIds.substring(1)}}return t};var C=function(e,t){l({url:"get_user_custom_fields.json",method:"POST",data:{userIds:e,customFieldIds:t}}).success(function(e,t,i,n){if(e.success){u.customFieldList=e.json}else{}})};var b=function(e,t){l({url:"get_user_group_custom_fields.json",method:"POST",data:{userGroupIds:e,customFieldIds:t}}).success(function(e,t,i,n){if(e.success){u.customFieldList=e.json}else{}})};var w=function(e){var t="";angular.forEach(e,function(e){if(angular.isDefined(e.id)){if(t==""){t=e.id}else{t+=","+e.id}}});return t};var T=function(e,t){l({url:"get_ticket_custom_fields.json",method:"POST",data:{ticketIds:e,customFieldIds:t}}).success(function(e,t,i,n){if(e.success){u.customFieldList=e.json}else{}})};var S=function(e){var t="";for(var i=0;i<e.length;i++){if(t==""){t=""+e[i].id}else{t+=","+e[i].id}}return t};var F=function(e){l({url:"copy_to_by_ticket_ids.json",method:"POST",data:{ticketIds:e}}).success(function(e,t,i,n){if(e.success){u.relatedCopyTos=e.json}else{}})};var A=function(e){l({url:"tags_by_ticket_ids.json",method:"POST",data:{ticketIds:e}}).success(function(e,t,i,n){if(e.success){u.relatedtags=e.json}else{}})};var E=function(e){l({url:"map_ticket_status_color_by_ticket_id.json",method:"POST",data:{ticketIds:e}}).success(function(e,t,i,n){if(e.success){u.ticketStatusColors=e.json}else{}})};e.$watch("ps.searchResult",function(e,t,i){if(u.searchType=="ticket"){var n=[];if(e.length>0){angular.forEach(e,function(e){n.push(e.id)})}o.setSeniorSearchIds(n)}});function $(){var e={searchType:u.searchType,searchContent:"none",searchView:u.searchView,searchResult:u.searchResult,showDefaultField:u.showDefaultField,visibleFieldId:u.visibleFieldId,isSenior:true,conditionsParam:u.conditionsParam,customCoditions:u.customCoditions,seniorConditions:u.seniorConditions,pageNum:u.page.pageNumber,searchTicketCount:u.searchTicketCount};var t=JSON.stringify(e);if(window.sessionStorage){sessionStorage.setItem("polymerizeSearchData",t)}}return u}})();angular.module("eweiApp.system_setting").controller("webhook_controller",["$scope","$state","$http","$modal_","$rootScope","alertService","permissions","license",function(s,n,e,a,r,o,l,c){e({url:"/search_webhook.json",method:"get"}).success(function(e){if(e.success){s.webhookList=e.json.list}else{s.webhookList=[]}});s.addWebhook=function(e,t){if(r.providerLicense.type=="blend"||r.providerLicense.type=="public"||r.providerLicense.type=="trial"||r.providerLicense.type=="enterprise_plus"||r.providerLicense.type=="oem"||c.hasModule("api_sdk")){n.go("system_setting.edit_webhook",{id:e,type:t})}else{var i=a({scope:s,title:"提示",contentTemplate:"source/views/fun_restriction_reminder.html",html:true,show:true,placement:"center"});s.hasPermission=true;s.tipNotSupportService="当前服务版本不支持此功能，请升级服务后再试。";s.goAuthorization=function(){void 0;if(l.hasPermission("system_setting_company_account")){n.go("system_setting.detail.license",{uri:"company_account",settingType:"system"});i.$promise.then(i.hide)}else{s.hasPermission=false;s.tipNotSupportService="很抱歉，你没有访问授权计划的权限"}};s.hideModal_=function(){i.$promise.then(i.hide)}}};s.editWebhook=function(e,t){n.go("system_setting.edit_webhook",{id:e,type:t})};s.enabled=function(t,i){if(!i){s._messages="您确定停用吗？";var n=a({scope:s,title:"停用确认",contentTemplate:"source/views/alter_common.html",html:true,show:true,placement:"center"});s.$ok=function(){s.isLoading=true;e({url:"/webhook/"+t.webhook.id+".json?enable="+i,method:"put"}).success(function(e){if(e.success){s.isLoading=false;o.add("停用成功","success");t.webhook.active=i;n.$promise.then(n.hide)}else{s.isLoading=false;o.add("停用失败","danger")}})};s.$hide=function(){n.$promise.then(n.hide)}}else{e({url:"/webhook/"+t.webhook.id+".json?enable="+i,method:"put"}).success(function(e){if(e.success){t.webhook.active=i}else{o.add("启用失败","danger")}})}};s.deleteWebhook=function(t,i){s._messages="您确定删除吗？";var n=a({scope:s,title:"删除确认",contentTemplate:"source/views/alter_common.html",html:true,show:true,placement:"center"});s.$ok=function(){s.isLoading=true;e({url:"/delete_webhook.json?id="+i.id,method:"DELETE"}).success(function(e){if(e.success){o.add("删除成功","success");s.isLoading=false;t.splice(t.indexOf(i),1);n.$promise.then(n.hide)}else{s.isLoading=false;o.add("删除失败","danger")}})};s.$hide=function(){n.$promise.then(n.hide)}}}]).controller("editWebhookController",["$scope","$state","$stateParams","$http","alertService",function(n,i,e,s,a){n.checkId=e.id;n.webhook={};if(e.id!="0"){s({url:"/webhook/"+e.id+".json",method:"get"}).success(function(e){if(e.success){n.webhook=e.json}})}else{n.webhook.method="GET";n.webhook.propertieName="message";s({url:"/url_secret.json",method:"get"}).success(function(e){if(e.success){n.webhook.secretKey=e.json}})}n.changeWebhook=function(e,t){var i=/[a-zA-z]+:\/\/[^/s]*/;if(t=="nameBorder"){n.nameBorder=e.name?false:true;return}if(t=="urlBorder"){n.urlBorder=i.test(e.url)?false:true;return}if(t=="methodBorder"){n.methodBorder=e.method?false:true;return}if(t=="propertieNameBorder"){n.methodBorder=e.method?false:true;return}};n.saveWebhook=function(t){if(!t.name){n.nameBorder=true;a.add("请输入正确的Webhook名称","danger");return}var e=/[a-zA-z]+:\/\/[^/s]*/;if(!e.test(t.url)){n.urlBorder=true;a.add("请输入正确的url","danger");return}if(!t.method){n.methodBorder=true;a.add("请选择正确的方法","danger");return}if(!t.propertieName){n.propertieNameBorder=true;a.add("请输入正确的属性名","danger");return}s({url:"/is_correct_url.json",method:"post",data:{url:t.url,method:t.method}}).success(function(e){if(e.success){if(t.id==null){s({url:"/save_webhook.json",method:"post",data:{name:t.name,url:t.url,method:t.method,propertieName:t.propertieName,secretKey:t.secretKey,active:true}}).success(function(e){if(e.success){a.add("新增成功","success");i.go("system_setting.detail",{uri:"webhook",settingType:"system"})}else{n.isLoading=false;a.add("新增失败","danger")}})}else{s({url:"/update_webhook_columns.json",method:"post",data:{id:t.id,name:t.name,url:t.url,method:t.method,propertieName:t.propertieName,secretKey:t.secretKey}}).success(function(e){if(e.success){a.add("修改成功","success");i.go("system_setting.detail",{uri:"webhook",settingType:"system"})}else{a.add("修改失败","danger")}})}}else{n.urlBorder=true;a.add("请输入能正常访问的url","danger");return}})}}]);(function(E){"use strict";E.module("eweiApp.ticket").controller("ticketSettingController",e).controller("serviceDeskController",t).directive("demoTicket",i);e.$inject=["$modal_","$http","$scope","$rootScope","$state","$location","ticketSettingMenus","permissions"];function e(e,t,n,s,i,a,r,o){n.menus=r;var l=false;var c=-1;var u=-1;for(var d=0;d<n.menus.length;d++){var p=n.menus[d];for(var f=0;f<p.subMenus.length;f++){var m=p.subMenus[f];if(m.active===true){c=d;u=f;n.menus[d].subMenus[f].active=false}if(a.path().indexOf("/ticket/setting/"+m.uri)>=0){m.active=true;l=true}}if(l){}}if(!l){if(c>=0&&u>=0){if(o.hasPermission("ticket_public_quick_reply")){i.go("system_setting.detail",{uri:n.menus[c].subMenus[u].uri,settingType:"ticket"});n.menus[c].subMenus[u].active=true}else{i.go("system_setting")}}else{i.go("system_setting.detail",{uri:n.menus[0].subMenus[0].uri,settingType:"ticket"});n.menus[0].subMenus[0].active=true}}n.ticketSetMenus={quick_reply:"快捷回复",ticket_template:"工单模板",workflow_templet:"工作流",via_email:"邮件渠道",wechat_setting:"微信客服",ticket_web_form:"网页表单（feedback）",webchat_form:"在线交谈 / 远程协助",api_setting:"API",sdk_setting:"SDK",cti_setting:"电话渠道",ticket_type:"工单类型",service_catalog:"服务目录",ticket_custom_field:"自定义字段",ticket_list_custom:"自定义视图",sla:"SLA",automations:"自动化程序",working_day:"营业时间",evaluate_edit:"调查问卷",desktop_help:"帮助中心桌面版"};n.detail=function(e,t,i){if(n.ticketSetMenus[i]){_hmt.push(["_trackPageview","/工单设置/子级页面/"+n.ticketSetMenus[i]]);_hmt.push(["_setCustomVar",s.vertionNumber,"名称","工单设置-"+n.ticketSetMenus[i],1]);_hmt.push(["_trackEvent","工单设置",n.ticketSetMenus[i]])}E.forEach(n.menus,function(e){E.forEach(e.subMenus,function(e){e.active=false})});n.menus[e].subMenus[t].active=true}}t.$inject=["$scope","$state","serviceDesks","$modal_"];function t(e,t,i,n){e.serviceDesks=i.query()}i.$inject=["$compile"];function i(A){return{restrict:"EA",scope:false,link:function(a,e,t){if(navigator.userAgent.indexOf("Firefox")>=0){var i=true}var r=document.getElementById("textarea");var n=e[0];var o=n.getElementsByTagName("button");var l=null;var c=1;var u="",d="";var p=document.createElement("img");p.src="/source/images/arrow_right.gif";p.style.cssText="position:absolute;left:350px;top:210px;z-index:9998;display:none;";document.body.appendChild(p);var f=document.createElement("img");f.src="/source/images/arrow_left.gif";f.style.cssText="position:absolute;left:480px;top:305px;z-index:9998;display:none;";document.body.appendChild(f);function s(e){return typeof e.textContent=="string"?e.textContent:e.innerText}if(a.ticket.requester&&a.ticket.requester.email&&a.ticket.requester.email.indexOf("robot@ewei.com")!=-1&&a.ticket.status.indexOf("open")!=-1){p.style.display="block";r.style.border="1px solid #fda977";var m=function(){r.style.border="";if(c==1&&s(o[0]).trim()=="回复"){p.style.left="310px";p.style.top="300px";p.style.display="block";o[0].style.border="1px solid #fda977";o[0].addEventListener("click",v,false);o[1].addEventListener("click",g,false)}else if(c==2){o[1].style.border="1px solid #fda977";o[1].addEventListener("click",h,false);p.style.display="none";f.style.display="block"}else if(c==3){o[1].style.border="1px solid #fda977";o[1].addEventListener("click",y,false);o[0].addEventListener("click",_,false);p.style.display="none";f.style.left="590px";f.style.top="330px";f.style.display="block"}};r.addEventListener("input",m,false);var g=function(){if(c==1){c=0;o[0].style.border="";p.style.display="none";f.style.display="none"}o[1].removeEventListener("click",g,false)};var v=function(){if(s(this).trim()=="回复"){p.style.top="210px";o[0].style.border="";r.style.border="1px solid #fda977";r.focus();c=2}o[0].removeEventListener("click",v,false)};var h=function(){o[1].style.border="";var e=n.getElementsByTagName("ul")[0];if(getComputedStyle(e,null)["display"].indexOf("none")!=-1){if(i){f.style.top="240px"}else{f.style.top="270px"}f.style.left="570px"}else if(getComputedStyle(e,null)["display"].indexOf("block")!=-1){f.style.left="530px";f.style.top="260px"}document.onclick=function(){if(getComputedStyle(e,null)["display"].indexOf("block")!=-1&&a.ticket.status.indexOf("open")!=-1){f.style.left="530px";f.style.top="260px";o[1].style.border="1px solid #fda977"}else if(getComputedStyle(e,null)["display"].indexOf("none")!=-1&&a.ticket.status.indexOf("pending")!=-1){f.style.left="590px";f.style.top="330px";o[1].style.border="1px solid #fda977"}else{o[1].style.border=""}};l=e.getElementsByTagName("a");l[1].style.border="1px solid #fda977";l[1].addEventListener("click",k,false);l[0].addEventListener("click",_,false)};var y=function(e){o[1].style.border="";var t=n.getElementsByTagName("ul")[0];if(getComputedStyle(t,null)["display"].indexOf("none")!=-1){if(i){f.style.top="286px"}else{f.style.top="266px"}f.style.left="580px";o[1].style.border="1px solid #fda977"}else if(getComputedStyle(t,null)["display"].indexOf("block")!=-1){f.style.left="590px";f.style.top="330px";o[1].style.border="1px solid #fda977"}e.stopPropagation();l=t.getElementsByTagName("a");l[0].addEventListener("click",_,false);l[0].style.border="1px solid #fda977";l[1].addEventListener("click",_,false)};var _=function(e){f.style.display="none";p.style.display="none";o[1].style.border="";c=0;if(s(this).trim()=="回复为处理中"){p.style.display="none";f.style.display="none";l[0].style.border=""}l[0].removeEventListener("click",_,false);e.stopPropagation()};var k=function(e){o[1].removeEventListener("click",h,false);l[1].style.border="";var s=a.$watch("latestTicketSla",function(e,t){if(e){if(e.operator){u=e.operator.name||""}if(e.operatedAt){var i=new Date(Date.parse(e.operatedAt.replace(/-/g,"/")));d=i.toLocaleString()}var n="<div style='background:#fff;width:175px;height:34px;margin-left:214px;margin-top:46px;text-align:center;line-height:34px;'>"+"<span class='Pending'>PENDING</span> 工单 #"+a.ticket.no+"</div>"+"<div class='alert alert-warning' style='margin-left:390px;margin-top:70px;'>"+u+" 暂停此工单，于 "+d+"。</div>"+"<p style='color:#fff;margin-left:360px;font-size:14px;'>该工单状态已改变为<span style='color:#fda578;'>“暂停状态”</span></p>"+"<div style='margin-left:390px;margin-top:16px;'><input style='width:80px;' type='button' value='知道了'></div>";b.innerHTML=n;b.getElementsByTagName("input")[0].onclick=function(){f.style.display="none";p.style.display="block";C.style.display="none";b.style.display="none";r.style.border="1px solid #fda977";r.focus();p.style.left="350px";p.style.top="280px";c=3};s()}});C.style.display="block";b.style.display="block";f.style.left="480px";f.style.top="260px";e.stopPropagation();l[1].removeEventListener("click",k,false)};var C=document.createElement("div");C.style.position="absolute";C.style.left=0;C.style.top=0;C.style.right=0;C.style.bottom=0;C.style.background="#000";C.style.opacity=.5;C.style.zIndex="9996";C.style.display="none";var b=document.createElement("div");b.style.position="absolute";b.style.left=0;b.style.top=0;b.style.right=0;b.style.bottom=0;b.style.zIndex="9997";b.style.display="none";document.body.appendChild(C);document.body.appendChild(b);var w=document.createElement("div");w.style.position="absolute";w.style.left=0;w.style.right=0;w.style.bottom=0;w.style.background="#000";w.style.opacity=.5;w.style.zIndex="9996";w.style.height="110px";w.style.display="none";w.id="oDivOver";document.body.appendChild(w);var T=document.createElement("div");T.style.position="absolute";T.style.left=0;T.style.right=0;T.style.bottom=0;T.style.zIndex="9997";T.style.height="110px";T.style.display="none";T.id="oDivTipsOver";var S="<p style='color:#fff;text-align:center;margin-top:25px;'>恭喜你已经学会处理工单了！</p>"+"<div style='margin-top:16px;text-align:center;'><input ng-click='demoTicketShow()' style='width:100px;' type='button' value='继续其它练习'></div>";T.innerHTML=S;var F=E.element(T);A(F)(a);document.body.appendChild(T);a.$on("$destroy",function(){document.body.removeChild(p);document.body.removeChild(f);document.body.removeChild(C);document.body.removeChild(b);document.body.removeChild(w);document.body.removeChild(T)})}}}}})(angular);+function(){"use strict";angular.module("eweiApp.ticket").controller("newTicketController",e);e.$inject=["$rootScope","$http","$scope","$state","$filter","$stateParams","utils","alertService","userService","engineerService","license","cachedTicket","locker","ConsoleConfig","$window","$modal_","permissions","providerJudgement","emojiService","apiRestfulService","coreModelService","apiServiceDesksService","$q","batchTicketService","coreNotifyService"];function e(o,r,l,c,u,d,p,f,e,t,i,m,g,v,n,h,y,k,C,b,w,a,s,T,S){l.newTicket={uId:eweiCommon.uuid(32).toLowerCase(),createType:c.params.type||"normal",selectedCustomers:[],selectedEngineers:[]};l.attachments=[];if(angular.isObject(m.ticket)){l.newTicket=m.ticket;if(!l.newTicket.createType){l.newTicket.createType=c.params.type||"normal"}if(l.newTicket.createType&&c.params.from){l.newTicket.createType=c.params.type||"normal"}if(!l.newTicket.selectedCustomers){l.newTicket.selectedCustomers=[]}if(!l.newTicket.selectedEngineers){l.newTicket.selectedEngineers=[]}if(m.ticket&&m.ticket.ticketComment&&m.ticket.ticketComment.attachments&&m.ticket.ticketComment.attachments.length>0){l.attachments=m.ticket.ticketComment.attachments}}if(!angular.isArray(l.newTicket.ccs)){l.newTicket.ccs=[]}l.newTicket=angular.extend({select_ticket_template_show:true,submit_ticket_template_show:false,is_use_template:false},l.newTicket);var F=d.id;var A=c.current.name;if(angular.isUndefined(o.nextTicketId)){o.nextTicketId=parseInt(F)+1}try{l.systemFieldSubject=JSON.parse(localStorage["systemFieldSubject"]);l.systemFieldTicketdescription=JSON.parse(localStorage["systemFieldTicketdescription"]);l.typeFiled=angular.fromJson(localStorage.getItem("systemFieldTicketType"));l.priorityFiled=angular.fromJson(localStorage.getItem("systemFieldPriority"));l.catalogFiled=angular.fromJson(localStorage.getItem("systemFieldServiceCatalog"))}catch(e){}var E=p.findTabByIdAndStateName("tickets_new"+F,"tickets_new.normal");if(E==null){}else{var $=E.params.requesterId;if($!=null){e.get({id:$},function(e){l.newTicket.requester=e.json})}E.active=true}l.showCustomForm=false;l.toggleCustomForm=function(e){l.showCustomForm=e};var O;l.setDefaultEngineer=function(){if(O){l.newTicket.engineer=O;l.newTicket.serviceDesk=O.defaultServiceDesk}else{if(!angular.isObject(l.newTicket.serviceDesk)&&!angular.isObject(l.newTicket.workflowTemplate)){t.get({id:v.engineer.id},function(e){O=e.json;l.newTicket.engineer=e.json;l.newTicket.serviceDesk=e.json.defaultServiceDesk})}}};l.setDefaultEngineer();l.$on("selectedTicketTemplate",function(e,t){if(!l.newTicket.ticketComment){l.newTicket.ticketComment={ccs:[]}}if(t!=null){l.newTicket.is_use_template=t.is_use_template;l.newTicket.subject=t.subject;if(t.comment){l.newTicket.ticketComment.content=t.comment}if(t.open!==undefined){l.newTicket.ticketComment.open=t.open}}if(t.open===false){l.setOpenNew()}P()});l.private_reply={isopenreply:true};l.setOpenNew=function(){l.private_reply.isopenreply=!l.private_reply.isopenreply;l.newTicket.ticketComment.open=l.private_reply.isopenreply};l.$on("applyTicketTemplateCompleted",function(){m.noSave=true});l.downloadApplication=function(){n.open(o.applicationUrl);o.plugPrometStatus="download-done"};var I=function(e){var t="";var i=window.location.href;if(i.indexOf("?")!=-1){var n=i.substring(i.indexOf("?")+1);var s=n.split("&");var a=s.length;for(var r=0;r<a;r++){var o=s[r];if(o&&o.indexOf("=")!=-1){var l=o.substring(0,o.indexOf("="));var c=o.substring(o.indexOf("=")+1);if(l==e){t=c;break}}}}return t};var L=I("questionId");if(L!=""&&parseInt(L,10)>0){l.loadQuestion=function(){r({url:"questionTicket/"+L+".json",method:"GET",data:l.newTicket}).success(function(e,t,i,n){if(e.json!==undefined&&e.json.id>0){void 0;l.newTicket.subject=e.json.title;l.newTicket.ticketComment.content=e.json.remark;if(e.json.author!==undefined&&e.json.author.type=="customer"){l.newTicket.requester=e.json.author}}})};l.loadQuestion()}l.replying=false;l.save=function(e){if(l.newTicket.is_use_template){l.$broadcast("save-with-template",e);return}m.noSave=true;g.driver("session").namespace("eweiApp.chat").forget(d.id);var t=C.parseHtmlToSend(angular.copy(l.newTicket.ticketComment.content));var i=angular.copy(t)||"";if(navigator.userAgent.indexOf("Firefox")!==-1){i=i.replace(/&nbsp;/g,"").replace(/<br>/g,"");void 0}i=i.replace(/^\s*|\s*$/g,"");t=i;if(t){if(t.length>1e4){f.add("消息不能超过10000个字符","danger");return}}if(!k.isTrue()){return false}else{l.newTicket.status=e;var n={channel:"console",channelName:"客服界面 ",source:v.user.name};l.newTicket.via=n;l.newTicket.ticketComment.attachments=l.attachments;var s=angular.copy(l.newTicket);s.ticketComment.content=t;s.ccs=[];angular.forEach(l.newTicket.ccs,function(e){if(e.id&&Object.prototype.toString.call(e.id)==="[object Number]"){var t={};if(e.type==="userGroup"){s.ccs.push({userGroup:e})}else if(e.type==="serviceDesk"){s.ccs.push({serviceDesk:e})}else{s.ccs.push({user:e})}}else{s.ccs.push({email:e.name})}});var a=function(t){return _.find(l.customFormFields,function(e){return e.id==t.id})};s.ticketCustomFields=_.filter(s.ticketCustomFields,function(e){return e.customField&&(e.customField.sysCustomForm||a(e.customField))});angular.forEach(s.ticketCustomFields,function(e,t){if(e.value=="-"){e.value=""}if(e.customField&&e.customField.type=="date"&&e.value){s.ticketCustomFields[t].value=u("date")(e.value,"yyyy/MM/dd")}if(e.customField&&e.customField.type=="date_time"&&e.value){s.ticketCustomFields[t].value=u("date")(e.value,"yyyy/MM/dd HH:mm:ss")}});l.replying=true;if(s.ticketMetric&&s.ticketMetric.planSolvedAt){s.ticketMetric.planSolvedAt=u("date")(s.ticketMetric.planSolvedAt,"yyyy-MM-dd HH:mm:ss").toString()}s=l.cleanupSaveData(s);if(l.newTicket.createType!=="normal"){l.batchSave(s);return}r({url:"/api/v1/ticket/save.json",method:"POST",data:s}).success(function(e,t,i,n){if(e.status==0&&e.result){f.add("添加工单成功");if(d.projectid){var s={bindType:"id"};b.run({url:"/api/v1/projects/"+d.projectid+"/tickets/"+e.result.ticketId,urlParam:s}).post(null,function(e){if(e.status===0){f.add("项目已关联工单#"+e.result.ticket.no+"！");o.$broadcast("addTickets",e.result.ticket);o.$broadcast("sendTimeLineLogs",{log:e.result.log})}else{f.add("与项目关联失败！","danger")}})}w.config.route.remove("tickets_new_"+d.id);var a=p.findTabById(A.split(".")[0]+F);if(a!=null){p.splice(a)}m.noSave=true;l.newTicket.ticketComment.content="";g.driver("session").namespace("eweiApp.chat").forget(d.id);g.forget(d.id);if(d.categoryid&&d.projectid){c.go("project_detail",{categoryid:d.categoryid,id:d.projectid})}else{c.go("tickets_detail",{id:e.result.ticketId})}}else{if(e.result&&e.result.error){if(e.result.error=="provider_license_error"){var r=h({scope:l,title:"提示",contentTemplate:"source/views/quantity_limitation.html",html:true,show:true,placement:"center"});l.limit={};l.limit.hasPermission=true;l.goUpgrade=function(){if(y.hasPermission("system_setting_company_account")){c.go("system_setting.detail.provider",{uri:"company_account",settingType:"system"});r.$promise.then(r.hide)}else{l.limit.hasPermission=false}};l.hideLimitModal=function(){r.$promise.then(r.hide)}}else{f.add(e.result.error_description,"danger")}}else{f.add("添加工单失败","danger")}l.replying=false}}).error(function(e,t,i,n){l.replying=false;f.add("error"+e,"danger")})}};l.cleanupSaveData=function(n){if(!n)return n;if(n.engineer){n.engineer={id:n.engineer.id,name:n.engineer.user.name}}if(n.requester){n.requester={id:n.requester.id,name:n.requester.name}}if(n.serviceCatalog){n.serviceCatalog={id:n.serviceCatalog.id}}if(n.serviceDesk){n.serviceDesk={id:n.serviceDesk.id,name:n.serviceDesk.name}}if(n.workflowTemplate){n.activitiWorkflowTemplateId=n.workflowTemplate.id;delete n.workflowTemplate}if(n.ccs&&n.ccs.length>0){angular.forEach(n.ccs,function(e){if(e.user){e.user={id:e.user.id,name:e.user.name}}if(e.userGroup){e.userGroup={id:e.userGroup.id,name:e.userGroup.name}}if(e.serviceDesk){e.serviceDesk={id:e.serviceDesk.id,name:e.serviceDesk.name}}})}var e=["select_ticket_template_show","is_use_template","submit_ticket_template_show","ticketCustomFieldsCopy"];angular.forEach(e,function(e){if(n.hasOwnProperty(e)){delete n[e]}});if(n.ticketCustomFields&&n.ticketCustomFields.length>0){angular.forEach(n.ticketCustomFields,function(e,t){var i=e.value;n.ticketCustomFields[t]={value:e.value,customField:{id:e.customField.id,defaultValue:e.customField.defaultValue}}})}if(n.createType!=="batch-customer"&&n.selectedCustomers){delete n.selectedCustomers}if(n.createType!=="batch-engineer"&&n.selectedEngineers){delete n.selectedEngineers}delete n.createType;return n};function D(){if(!l.newTicket||!l.newTicket.ticketType||!l.newTicket.ticketType.id){return s.resolve(null)}return r({url:"/api/v1/ticket_custom_form/get/"+l.newTicket.ticketType.id+".json",method:"GET"}).then(function(e){if(e.data&&e.data.status==0&&e.data.result){return e.data.result.ticketCustomForm}else{return s.reject(e.data)}})}function P(){if(!l.newTicket||!l.newTicket.ticketCustomFields){return}l.customFormLoading=true;D().then(function(e){l.customFormLoading=false;if(e&&e.customFormFields){var i=[];angular.forEach(e.customFormFields,function(t){var e=_.find(l.newTicket.ticketCustomFields,function(e){return t&&t.customField&&t.customField.id==e.id});if(e&&!e.customField.sysCustomForm){if(!e.sysCustomForm&&(!t.deleted||t.deleted&&e.value&&(l.newTicket.status=="solved"||l.newTicket.status=="closed"))){e.customFormInfo={deleted:t.deleted,position:t.position};i.push(e)}}});l.customFormFields=_.sortBy(i,function(e){return e.customFormInfo.position});l.showCustomForm=l.customFormFields.length>0}else{l.showCustomForm=false;l.customFormFields=[]}},function(e){f.add("获取扩展表单失败，请重试！","danger")})}P();l.$watch("newTicket.ticketType",function(e,t){if(e!==t){P()}},true);l.$watchCollection("newTicket.ticketCustomFields",function(e,t){if(e!==t){if(e&&!t){P();return}var i=false;for(var n=0;n<e.length;n++){if(e[n]!=t[n]&&e[n].id!=t[n].id){i=true;break}}if(i){P()}}});l.$watch("newTicket",function(e,t,i){if(e!==t){m.ticket=angular.copy(e)}},true);l.$watchCollection("attachments",function(e,t,i){if(e!==t&&l.newTicket.ticketComment){l.newTicket.ticketComment.attachments=l.attachments}},true);l.$on("uploading",function(e,t){l.uploading=t;l.$broadcast("file-uploading",t)});var x=i.type()||"";l.hasBatchTicketCreateModule=x==="enterprise_basic"||x==="enterprise_trial"||x==="enterprise_basic_19";S.register(A,S.constant.EVENT_LICENSE,function(e,t){var i=w.config.license.get("license").type||"";l.hasBatchTicketCreateModule=i==="enterprise_basic"||i==="enterprise_trial"||i==="enterprise_basic_19"});function N(i,n){if((!i.selectedCustomers||i.selectedCustomers.length===0)&&n==="customer"){f.add("请至少选择一个客户！","danger");l.replying=false;return}if((!i.selectedEngineers||i.selectedEngineers.length===0)&&n==="engineer"){f.add("请至少选择一个处理人！","danger");l.replying=false;return}if(!i.requester&&n==="engineer"){f.add("请选择一个客户！","danger");l.replying=false;return}if(o.providerLicense.useDataCapacity&&o.providerLicense.useDataCapacity!==-1){var e=o.providerLicense.useDataCapacity*1024*1024*1024;if(o.providerLicense.attachmentSize>=e&&!o.providerLicense.is_cover_data){f.add("数据空间授权不足","danger");l.replying=false;return}}if(i.activitiWorkflowTemplateId&&n==="engineer"){delete i.activitiWorkflowTemplateId}var s=o.batchWorker=new Worker("/source/scripts/ticket-batch-customer.js");s.onmessage=function(e){if(!e.data||!e.data.type)return;switch(e.data.type){case"ready":{s.postMessage({type:"batch-create",ticket:i,engineer_id:v.engineer.id,params:{provider_id:v.provider.id,_token:getCookie("user_token")}});break}case"started":{o.$broadcast("batch-started",e.data.data);break}case"progress":{o.$broadcast("batch-progress",e.data.data);break}case"finished":{s.terminate();delete o.batchWorker;var t=e.data.data.saveFailedData||[];if(t.length>0){t.forEach(function(t){var e=t.uId;delete t.uId;t.id=e;if(t.engineer&&t.engineer.id){t.engineer={id:t.engineer.id,user:{name:t.engineer.name}}}if(t.ticketCustomFields){var i=angular.copy(t.ticketCustomFields);delete t.ticketCustomFields;angular.forEach(i,function(e){if(e.customField){t["custom_field_"+e.customField.id]={value:e.value}}})}})}T.saveFaileExceldData=t;if(e.data.data){e.data.data.fromId=d.id}if(n==="engineer"){a.setCacheData(d.id,[])}o.$broadcast("batch-finished",e.data.data);break}}};m.noSave=true;g.driver("session").namespace("eweiApp.chat").forget(d.id);f.add("批量任务开始执行，请不要刷新页面或关闭浏览器！","success");p.removeActiveTab(c)}l.batchSave=function(e){if(o.batchWorker){f.add("上一个批量派单尚未结束，请稍后再试","danger");l.replying=false;return}var t="BATCH_CREATE_TICKET";var i="customer";if(l.newTicket.createType==="batch-customer"){i="customer";t="BATCH_CUSTOMER_CREATE_TICKET";var n=[];var s={};var a=[];e.selectedCustomers.forEach(function(e){if(!e.type&&e.userGroup){a=_.filter(e.userGroup.users,function(e){return!s[e.id]});a.forEach(function(e){s[e.id]=e});n=n.concat(a)}else{if(!s[e.id]){s[e.id]=e;n.push(e)}}});e.selectedCustomers=n}else if(l.newTicket.createType==="batch-engineer"){i="engineer";t="BATCH_ENGINEER_CREATE_TICKET"}org.ewei.sdk.OperationLogApi().saveOperationLog({action:"CREATE",position:"TICKET",target:t}).then(function(){N(e,i)},function(){N(e,i)})};function M(){if(!i.type()||i.type()!="enterprise_basic"&&i.type()!="enterprise_trial"&&i.type()!=="enterprise_basic_19"){f.add("您当前的版本不支持批量派单功能，请升级后再使用！","danger");return false}if(!y.hasPermission("batch_ticket_create")){f.add("您没有批量建单权限，不能使用此功能！","danger");return false}return true}l.batchNew=function(e){if(!M())return;l.newTicket.createType=e;if(e==="batch-create-ticket"){c.go("tickets_new.batch")}};o.$on("ticket-cached-no-save",function(e,t){if(t){m.noSave=true}})}}();+function(pe){"use strict";angular.module("eweiApp.ticket").controller("ticketDetailController",e);e.$inject=["$rootScope","$scope","$http","$state","$stateParams","alertService","utils","$filter","$modal_","permissions","$location","ticket","license","cachedTicket","locker","EweiConfig","ConsoleConfig","$ocLazyLoad","$window","ticketRecentViewService","ticketDetailService","tabs","ticketStatusColorExtendService","chatDetailService","serviceDesks","groupUserTicketChainService","ticketSaveCommentService","ticketLogService","$timeout","providerJudgement","emojiService","coreModelService","coreNotifyService","apiTicketSubscriptionsService","cachedTicketService","$document","$q","polymerizeSearchService"];function e(l,f,o,c,u,m,d,p,g,v,e,i,t,h,y,n,k,s,a,r,C,b,w,T,S,F,A,E,$,O,I,L,D,P,x,N,M,j){f.hasReviewOrReply=v.anyPermissions(["ticket_review","ticket_reply"]);f.showCustomForm=false;f.toggleCustomForm=function(e){f.showCustomForm=e};f.newComment={ticket:{},attachments:[],content:"",open:true};l.$broadcast("open-ticket");f.cacheFiles=[];function R(){for(var e in f.newComment){if(f.newComment.hasOwnProperty(e)&&e!=="content"){delete f.newComment[e]}}f.newComment.ticket={};f.newComment.attachments=[];f.newComment.open=f.private_reply.isopenreply}f.ticketLogs=[];var U=window.document.body.offsetWidth;f.plugPrometStyle={width:U-380};window.onresize=function(){U=window.document.body.offsetWidth;f.plugPrometStyle={width:U-380}};f.demoTicketShow=function(){le();d.removeTabById(c,"tickets_detail"+f.ticket.id,true);c.go("noviceguide.accidence")};var V=_.debounce(function(){f.$broadcast("scrollLoadTicket")},1e3);f.scrollLoadEvent=function(){V()};f.selectedEngineerMessage={open:true};var q=function(){var e;if(u.from==="polymerize-search"){e=j.getSearchIds()}else if(u.from==="polymerize-search-senior-result"){e=j.getSeniorSearchIds()}else{e=L.list.cachedTickets.get("tickets-"+u.viewId).gets(u.page)}if(e&&e.length>0){var n=0;angular.forEach(e,function(e,t,i){if(e==u.id){n=t;f.showNextTicketBtn=t<i.length-1;f.showpreTicketBtn=t>0}});f.viewNextTicket=function(){c.go("tickets_detail",{id:e[n+1],view:u.view,nextOrPre:"next",from:u.from})};f.viewPreTicket=function(){c.go("tickets_detail",{id:e[n-1],view:u.view,nextOrPre:"pre",from:u.from})}}};var G=function(e){f.latestTicketSla=null;if(e.status=="pending"||e.status=="solved"){o({url:"/api/v1/ticket/"+e.id+"/latest_sla/get_by_type.json?type="+e.status}).success(function(e,t,i,n){if(e.status==0&&e.result){f.latestTicketSla=e.result.ticketSla}})}};f.setOpen=function(e){e?_hmt.push(["_trackEvent","工单工具","公开回复"]):_hmt.push(["_trackEvent","工单工具","私密回复"]);f.newComment.open=e;if(e){f.isPrivateReply=false}else{f.isPrivateReply=true}};var K=function(){if(!v.hasPermission("ticket_reply")){f.showReply=false}else{f.showReply=true}};f.private_reply={isopenreply:true};f.setOpenNew=function(){f.private_reply.isopenreply=!f.private_reply.isopenreply;f.newComment.open=f.private_reply.isopenreply};var B=function(e){R();f.newComment.ticket.id=f.ticket.id;f.newComment.open=e};var Q=function(){var e=f.ticket.id+"";if(e&&e.length>0){P.run("",D.constant.EVENT_DETAIL_TICKETS,1,"",{ticketIds:e},function(e){if(e){if(e.status==0&&angular.isDefined(e.result)){x.updateSubscriptionCached(e.result);f.ticketsubscriptions=e.result;f.$broadcast("backPageToTop")}}})}};function H(){var e=d.findTabByIdAndStateName("tickets_detail"+f.ticket.id,"tickets_detail");if(e==null){if(!u.nextOrPre){d.addTab("tickets_detail"+f.ticket.id,f.ticket.subject,"tickets_detail",{id:f.ticket.id,page:u.page,viewId:u.viewId,from:u.from},"")}else{var t;if(u.from==="polymerize-search"){t=j.getSearchIds()}else if(u.from==="polymerize-search-senior-result"){t=j.getSeniorSearchIds()}else{t=L.list.cachedTickets.get("tickets-"+u.viewId).gets(u.page)}if(t&&t.length>0){var n=0;angular.forEach(t,function(e,t,i){if(e==u.id){n=t;f.showNextTicketBtn=t<i.length-1;f.showpreTicketBtn=t>0}});d.updateById("tickets_detail"+(u.nextOrPre=="pre"?t[n+1]:t[n-1]),{id:"tickets_detail"+f.ticket.id,title:f.ticket.subject,ico:"",stateName:"tickets_detail",params:u,active:true,closeAble:true,shake:""})}}}else{e.active=true}}var W=function(e){f.isSavingComment=false;if(angular.isObject(h.ticket)){if(h.ticket.attachments&&h.ticket.attachments.length>0){f.newComment.attachments=h.ticket.attachments}}G(f.ticket);f.oldSubject=f.ticket.subject;if(e){return}else{H()}};C.setUpdateCallback(function(e){if(e.json!=undefined&&f.ticket!=undefined){if(e.json.id==f.ticket.id){angular.extend(f.ticket,e.json);f.ticket.id=f.ticket.id}}});f.setReplyBoxDefaultMessage=function(e){if(e==="assigned"&&f.ticket.engineer&&f.ticket.engineer.id===k.engineer.id){f.replyBoxDefaultMessage="未输入内容直接接单将默认回复：“确认接单”"}else if(e==="new"){if(f.ticket.engineer){if(f.ticket.engineer.id===k.engineer.id){f.replyBoxDefaultMessage="未输入内容直接抢单将默认回复：“我来处理”"}else{f.replyBoxDefaultMessage=""}}else{var t;var i=false;for(var n=0;n<k.serviceDeskIds.length;n++){t=k.serviceDeskIds[n];if(f.ticket.serviceDesk){if(t===f.ticket.serviceDesk.id){i=true;break}}}if(i){f.replyBoxDefaultMessage="未输入内容直接抢单将默认回复：“我来处理”"}else{f.replyBoxDefaultMessage=""}}}else{f.replyBoxDefaultMessage=""}};var J=function(e,t,i){q();K();C.run(e,{},true,function(e){if(e.status==0&&e.result){if(e&&e.result&&e.ticketCustomFields){delete e.result.ticketCustomFields}angular.extend(f.ticket,e.result);if(!e.result.engineer){delete f.ticket.engineer}f.solutionId=e.result.solutionId;f.setReplyBoxDefaultMessage(f.ticket.status);f.newComment.ticket.id=f.ticket.id;W(t);f.$broadcast("ticket-loaded");K();Q();r.appendTicket(f.ticket);L.detail.tickets.put(f.ticket.id,{id:f.ticket.id,no:f.ticket.no,subject:f.ticket.subject,status:f.ticket.status,user:{name:f.ticket.user?f.ticket.user.name:""},updatedAt:f.ticket.updatedAt})}else{r.deleteTicket(f.ticket.id);c.go("unauthorized")}});o({url:"/api/v1/ticket/"+f.ticket.id+"/ccs.json",method:"GET"}).success(function(e){if(e.status==0&&e.result){f.ticket.ccs=e.result.ticketCcs}})};var z=function(i){T.run(i,"",false,function(e){f.webchat=e.result;if(e.status==0){var t=d.findTabByIdAndStateName("webchats_new.detail"+i,"webchats_new.detail");if(t==null){d.addTab("webchats_new.detail"+i,f.webchat.firstMessage||"#"+i,"webchats_new.detail",{id:u.id},"",true,false)}else{t.active=true}}})};var Y=function(e){f.ticket=i;var t=x.getTicket(u.ticketId,null,null,true,null);if(t){angular.extend(f.ticket,t);if(f.ticket.ticketType){de()}if(!t.engineer){delete f.ticket.engineer}if(c.current.name.indexOf("webchat_ticket_detail")===-1){H()}}if(c.current.name.indexOf("webchat_ticket_detail")>=0){J(u.ticketId,true,e);z(u.id)}else{J(u.id,false,e)}};Y();f.ticketDetailByNo=function(e){if(e!=null&&e!="null"){o({url:"/api/v1/ticket/get_id_by_no/"+e+".json"}).success(function(e,t,i,n){if(e.status==0){c.go("tickets_detail",{id:e.result.id})}else{if(e.result&&e.result.error!=null){m.add(p("translate")(e.result.error_description),"danger")}else{m.add("工单编号不正确，访问失败","danger")}}})}else{m.add("工单编号不正确，访问失败","danger")}};f.cancelDelete=function(e){if(!e)return;o({url:"/api/v1/tickets/"+e.id+"/cancel_delete.json",method:"GET"}).success(function(e,t,i,n){if(e.status==0){f.ticket.deleted=false;f.ticket.deleteType=null;f.ticket.deletedAt=null;f.ticket.deleteReason=null;f.ticket.deleter=null;l.$broadcast("removeDisabled");x.updateCached(f.ticket)}else{m.add("恢复工单失败","danger")}})};f.replying=false;f.allReceivedMsg={};var X=function(e,t,i,n,s,a){h.noSave=true;f.isSavingComment=true;var r=angular.copy(e?e:f.newComment);if(angular.isString(i)){r.content=i}if(angular.isNumber(n)){r.questionId=n}else if(angular.isNumber(r.textQuestionId)){r.questionId=r.textQuestionId}r=_.omit(r,"textQuestionId");var o={createdAt:(new Date).format("yyyy-MM-dd hh:mm:ss"),ticketComment:r,user:k.user};o.user.type="engineer";y.driver("session").namespace("eweiApp.chat").forget(u.id);B(f.newComment.open);r.user={id:k.user.id};r.uId=eweiCommon.uuid(32).toLowerCase();f.allReceivedMsg[r.uId]=true;if(s){f.ticketLogs.unshift(o);f.newComment.content="";f.saveTicketCommentOnlyComment(r,t,a);return false}if(f.statusTransfer(t)!=f.ticket.status){w.clearCache()}if(!r.open&&(t.indexOf("solved")>-1||t.indexOf("Solved")>-1)){f._messages="处理完毕时的回复消息都将以公开回复的方式发送，是否继续操作？";var l=g({scope:f,title:"处理完毕工单",contentTemplate:"source/views/alter_common.html",html:true,show:true,placement:"center"});f.$ok=function(){r.open=true;f.ticketLogs.unshift(o);f.saveTicketCommentToDB(r,t,a);l.$promise.then(l.hide)};f.hideCallback=function(){f.isSavingComment=false;f.newComment.attachments=r.attachments}}else{f.ticketLogs.unshift(o);f.saveTicketCommentToDB(r,t,a)}};f.saveTicketCommentToDB=function(t,i,n){f.newComment.content="";$(function(){if(!t.sendStatus){t.sendStatus="send"}},1e3);if(t.questionId&&t.attachments.length==0){f.newComment.content=t.content;f.$broadcast("sendKnowledgeStatus",{sendKnowledgeStatus:"send",questionId:t.questionId});delete t.content}else{f.$broadcast("sendKnowledgeStatus")}var s=angular.copy(t);delete s.sendStatus;delete s.sendKnowledgeStatus;var e="";if(t.questionId||t.type===7){e="/api/v1/ticket_comment/only.json"}else{if(i==="rob"){e="/api/v1/ticket_comment/grab.json"}else if(i==="robSolved"){e="/api/v1/ticket_comment/grab_to_solved.json"}else if(i==="robPending"){e="/api/v1/ticket_comment/grab_to_pending.json"}else if(i==="get"){e="/api/v1/ticket_comment/receive.json"}else if(i==="getSolved"){e="/api/v1/ticket_comment/receive_to_solved.json"}else if(i==="getPending"){e="/api/v1/ticket_comment/receive_to_pending.json"}else if(i==="solved"){e="/api/v1/ticket_comment/reply_to_solved.json"}else if(i==="pending"){e="/api/v1/ticket_comment/reply_to_pending.json"}else{e="/api/v1/ticket_comment/reply_cancel_pending.json"}}le();if(i=="WorkflowsNext"){org.ewei.sdk.OpenTicketApi().ticketWorkFlowToNext({ticketId:f.ticket.id,ticketComment:s}).then({success:function(e){void 0;t.sendStatus="success";if(f.ticketLogs[0].ticketComment){f.ticketLogs[0].ticketComment.id=e}else{f.ticketLogs[0].ticketComment={id:e}}ce()}})}else if(i=="WorkflowsPre"){org.ewei.sdk.OpenTicketApi().ticketWorkFlowToPre({ticketId:f.ticket.id,ticketComment:s}).then({success:function(e){void 0;t.sendStatus="success";if(f.ticketLogs[0].ticketComment){f.ticketLogs[0].ticketComment.id=e}else{f.ticketLogs[0].ticketComment={id:e}}ce()}})}else if(i=="asSolution"){org.ewei.sdk.OpenTicketCommentApi().saveTicketCommentAsSolution({ticketId:f.ticket.id,ticketComment:s}).then({success:function(e){f.isSavingComment=false;t.sendStatus="success";if(f.ticketLogs[0].ticketComment){f.ticketLogs[0].ticketComment.id=e}else{f.ticketLogs[0].ticketComment={id:e}}ce();B(f.newComment.open);f.cacheFiles.splice(0,f.cacheFiles.length);if(n&&angular.isFunction(n)){n()}},error:function(e){f.isSavingComment=false;ce();t.sendStatus="error"}})}else{o.post(e,s).success(function(e){if(e.result.success){t.sendStatus="success";if(f.ticketLogs[0].ticketComment){f.ticketLogs[0].ticketComment.id=e.result.ticketCommentId}else{f.ticketLogs[0].ticketComment={id:e.result.ticketCommentId}}i=f.statusTransfer(i);if(i=="solved"&&f.ticket.status!="solved"){if(f.showNextTicketBtn){if(f.ticket.requester&&f.ticket.requester.email&&f.ticket.requester.email.indexOf("robot@ewei.com")!=-1){document.getElementById("oDivOver").style.display="block";document.getElementById("oDivTipsOver").style.display="block"}else{d.removeTabById(c,"tickets_detail"+f.ticket.id)}}else{d.removeTabById(c,"tickets_detail"+f.ticket.id)}m.add("工单#"+f.ticket.no+"处理完毕，窗口已关闭","success")}else if(i=="open"&&f.ticket.status!="open"||i=="pending"&&f.ticket.status!="pending"||f.ticket.status=="new"){ce();C.run(f.ticket.id,{},true,function(e){if(e.status==0&&e.result){if(e&&e.result&&e.ticketCustomFields){delete e.result.ticketCustomFields}angular.extend(f.ticket,e.result);G(f.ticket)}else{void 0;c.go("unauthorized")}})}else if(i!=null){ce();f.ticket.status=i;if(f.ticket.workflowTemplate!=undefined&&i=="open"){D.doNotify(D.constant.EVENT_TICKET_WORKFLOWS)}}if(s.questionId&&s.attachments.length==0){f.$broadcast("sendKnowledgeStatus",{sendKnowledgeStatus:"success",questionId:t.questionId});E.query({_fields:"id,createdAt,operations,ticketComment,ticketComment.richTextContent,user.type,user.name,user.photo.contentUrl",_filter:"{'$eq':{'ticketComment.id':"+e.result.ticketCommentId+"}}",_do_count:false},function(e){if(e.ticketLogs.length&&e.ticketLogs[0].createdAt){f.ticketLogs.unshift(e.ticketLogs[0])}})}if(n&&angular.isFunction(n)){n()}f.setReplyBoxDefaultMessage(i)}else{ce();t.sendStatus="error";f.ticketLogs[0].ticketComment.ticket.status=i;if(s.questionId){f.$broadcast("sendKnowledgeStatus",{sendKnowledgeStatus:"error",questionId:t.questionId})}if(e.result&&e.result.error){if(e.result.error=="license_limit"){m.add("回复失败：你的服务商授权不允许将此工单移除出隔离区","danger")}else{m.add("回复失败："+e.result.error_description,"danger")}}else{m.add("回复失败","danger")}}f.isSavingComment=false;if(f.cacheFiles){f.cacheFiles.splice(0,f.cacheFiles.length)}}).error(function(){ce();t.sendStatus="error";if(s.questionId){f.$broadcast("sendKnowledgeStatus",{sendKnowledgeStatus:"error",questionId:t.questionId})}})}};f.saveTicketCommentOnlyComment=function(i,n,s,a){$(function(){if(!i.sendStatus){i.sendStatus="send"}},1e3);var e=angular.copy(i);delete e.sendStatus;delete e.showSend;delete e.id;delete e.sendKnowledgeStatus;i.sending=true;o.post("/api/v1/ticket_comment/only.json",e).success(function(e){delete i.sending;if(e.result&&e.result.ticketCommentId){i.sendStatus="success";f.ticketLogs[0].ticketComment.id=e.result.ticketCommentId;if(s=="resend"){angular.forEach(f.ticketLogs,function(e){if(e.ticketComment==i){f.ticketLogs.splice(f.ticketLogs.indexOf(e),1);return}});var t={createdAt:(new Date).format("yyyy-MM-dd hh:mm:ss"),ticketComment:angular.copy(i),user:k.user};t.user.type="engineer";f.ticketLogs.unshift(t);f.allReceivedMsg[i.uId]=true}}else{i.sendStatus="error";f.ticketLogs[0].ticketComment.ticket.status=f.statusTransfer(n);if(e.message){m.add("回复失败："+e.message,"danger")}else{m.add("回复失败","danger")}}f.isSavingComment=false;B(f.newComment.open);f.cacheFiles.splice(0,f.cacheFiles.length);if(a&&angular.isFunction(a)){a()}}).error(function(){i.sendStatus="error";delete i.sending})};A.saveTicketComment(function(e,t){f.saveTicketCommentOnlyComment(e,t,"resend")});f.reply=function(e,t,i,n,s){if(f.newComment.textQuestionId){f.newComment.textQuestionId=""}var a=I.parseHtmlToSend(angular.copy(f.newComment.content||t));f.newComment.content=a;if(!f.newComment.content&&!f.newComment.attachments.length){m.add("请输入消息或添加附件!","danger");return false}if(f.newComment.content){if(f.newComment.content.length>1e4){m.add("消息不能超过10000个字符","danger");return}}if(e=="solved"||e=="assignSolved"||e=="robSolved"||e=="getSolved"){var r=angular.fromJson(localStorage.getItem("systemFieldServiceCatalog"));var o=angular.fromJson(localStorage.getItem("systemFieldTicketType"));var l=angular.fromJson(localStorage.getItem("systemFieldPriority"));if(!f.ticket.serviceCatalog&&r.required){m.add(r.title+"不能为空","danger");return}if(!f.ticket.ticketType&&o.required||f.ticket.ticketType&&!f.ticket.ticketType.id&&o.required){m.add(o.title+"不能为空","danger");return}if(!f.ticket.priority&&l.required){m.add(l.title+"不能为空","danger");return}var c=f.ticket.ticketCustomFields||[];for(var u=0;u<c.length;u++){var d=c[u];var p=_.find(f.customFormFields,function(e){return e.id==d.id});if(f.customFormFields&&p){if(p.customFormInfo&&!p.customFormInfo.deleted){if(d.customField.required&&(!d.value||d.value=="-")){m.add(d.customField.title+"不能为空","danger");return false}}}else{if(d.customField.sysCustomForm&&d.customField.required&&(!d.value||d.value=="-")){m.add(d.customField.title+"不能为空","danger");return false}}}f.ticketSolved=true}if(!O.isTrue()){return false}else{if(e==null){e=f.ticket.status=="new"?"open":f.ticket.status}if(!f.isSavingComment){X("",e,t,i,n,s)}}};f.statusTransfer=function(e){if(e==="get"||e==="rob"||e==="cancelPending"){e="open"}else if(e==="getSolved"||e==="robSolved"){e="solved"}else if(e==="getPending"||e==="robPending"||e==="pending"){e="pending"}else{e=e}return e};f.addResLink=function(e,t,i){var n=angular.copy(f.newComment);f.newComment.attachments=[];f.newComment.type=7;var s="";if(e){s+="["+e.replace(/\[/g,"&#91;").replace(/\]/g,"&#93")+"]"}if(t.indexOf("http")!=0&&t.indexOf("//")!=0){t="http://"+t}s+="("+t.replace(/\(/g,"%28").replace(/\)/g,"%29")+")";f.reply(null,s,null,null,function(){f.newComment=n;if(i&&angular.isFunction(i)){i()}})};f.displaySubjectView=false;var Z;f.sidebar=function(e){e.stopPropagation();f.appVisiable=!f.appVisiable;if(f.appVisiable){c.go("tickets_detail.apps");Z="apps"}else{Z=null}f.$broadcast("backPageToTop")};f.showSearchList=function(e){e.stopPropagation()};f.goAssist=function(e,t){t.stopPropagation();if(!v.hasPermission("chat_create")){m.add("您没有创建会话的权限","danger");return false}if(!O.isTrue()){return false}else{if(e.requester.id==k.user.id){m.add("不能给自己发起远程协助","danger");return false}l.assistUser={id:e.requester.id,name:e.requester.name,email:null,type:e.requester.type,number:"#"+e.no,serviceName:k.user.name,ticketId:e.id};if(e.requester.email){l.assistUser.email=e.requester.email}else if(e.requester.contactEmail){l.assistUser.email=e.requester.contactEmail}else{l.assistUser.email=""}if(f.appVisiable&&Z!="assist"){c.go("tickets_detail.assist",{});Z="assist"}else{f.appVisiable=!f.appVisiable;if(f.appVisiable){c.go("tickets_detail.assist",{});Z="assist"}else{Z=null}}}};f.isolation=function(){if(!v.hasPermission("ticket_suspended_manage")){m.add("您没有权限移除该工单！","danger");return}o({url:"/api/v1/tickets/remove_from_suspended.json",method:"GET",params:{ids:f.ticket.id}}).success(function(e,t,i,n){if(e.status==0){void 0;var s=d.findTabById("tickets_detail"+f.ticket.id);var a=b[s];void 0;if(a.stateName==="webchats_new.detail"&&!a.isClose){l.$emit("exit_current_tab",a);return false}if(true){var r=null;if(s>0){r=b[s-1]}else{if(b.length>1){r=b[1]}}if(r==null){switch(a.stateName){case"webchats_new.detail":case"tickets_new":case"tickets_detail":c.go("ticket_views");break;case"user_groups_detail":case"customers_detail":c.go("customer_views");break;default:c.go("quickentry");break}}else{r.active=true;c.go(r.stateName,r.params)}}b.splice(s,1)}else{if(e.result&&e.result.error){var o=g({scope:f,title:"提示",contentTemplate:"source/views/quantity_limitation.html",html:true,show:true,placement:"center"});f.limit={};f.limit.hasPermission=true;f.goUpgrade=function(){if(v.hasPermission("system_setting_company_account")){c.go("system_setting.detail.provider",{uri:"company_account",settingType:"system"});o.$promise.then(o.hide)}else{f.limit.hasPermission=false}};f.hideLimitModal=function(){o.$promise.then(o.hide)}}else{m.add("删除失败","danger")}}})};f.mouseoverName=function(){f.displaySubjectView=v.hasPermission("ticket_update")};f.mouseoutName=function(){f.displaySubjectView=false};f.updateSubject=function(){if(f.ticket&&f.ticket.status==="deleted"){f.ticket.subject=f.oldSubject;m.add("工单已删除，不可修改工单主题","danger");return false}if(f.ticket&&f.ticket.status==="closed"){f.ticket.subject=f.oldSubject;m.add("工单已关闭，不可修改工单主题","danger");return false}if(!v.hasPermission("ticket_update")){f.ticket.subject=f.oldSubject;m.add("您没有权限编辑工单主题","danger");return false}f.displaySubjectView=false;if(!O.isTrue()){return false}else{if(f.ticket.subject!=null){if(f.oldSubject!=f.ticket.subject){o({url:"/api/v1/ticket_update/"+f.ticket.id+"/subject.json",method:"PUT",data:{subject:f.ticket.subject}}).success(function(e,t,i,n){if(e.status==0){f.oldSubject=f.ticket.subject;f.displaySubjectView=false;m.add("修改工单主题成功");x.updateCached(f.ticket)}else{m.add("修改工单主题失败","danger","left")}})}else{f.displaySubjectView=false}}else{f.ticket.subject=f.oldSubject}}};f.merger=function(){f.mergerUnit={list:[]};f.mergerUnit.submiting=false;f.mergerUnit.openMenu=false;f.mergerUnit.showSearch=true;f.mergerUnit.selectedTicket=null;f.mergerUnit.lastText=f.mergerUnit.curText="";f.mergerUnit.list=angular.copy(r.getTickets());f.mergerUnit.list.forEach(function(e,t){if(e.id===f.ticket.id){f.mergerUnit.list.splice(t,1)}if(e.status==="suspended"||e.deleted){f.mergerUnit.list.splice(t,1)}});var e=g({scope:f,title:"工单合并",contentTemplate:"source/views/ticket/confirm_merger_template.html",html:true,show:true,placement:"center"});f.mergerUnit.search=function(){if(f.mergerUnit.curText.trim()==="")return;pe.sdk.OpenTicketApi().listTicketBySubjectOrNo({key:f.mergerUnit.curText||"",page:{pageSize:10}}).then(function(e){f.mergerUnit.list=e.list;f.mergerUnit.showSearch=false;f.mergerUnit.openMenu=true})};f.mergerUnit.clear=function(){f.mergerUnit.selectedTicket=null;f.mergerUnit.openMenu=true;f.mergerUnit.showSearch=true;f.mergerUnit.lastText=f.mergerUnit.curText=""};f.mergerUnit.select=function(e){f.mergerUnit.selectedTicket=e;f.mergerUnit.lastText=f.mergerUnit.curText="#"+e.no+"  "+e.subject;f.mergerUnit.openMenu=false;f.mergerUnit.showSearch=false};f.mergerUnit.focus=function(){if(f.mergerUnit.curText===""){f.mergerUnit.openMenu=true}};f.mergerUnit.change=function(){if(f.mergerUnit.lastText!==f.mergerUnit.curText){f.mergerUnit.showSearch=true;f.mergerUnit.selectedTicket=null;f.mergerUnit.openMenu=f.mergerUnit.curText===""}};f.mergerUnit.keyup=function(e){var t=window.event?e.keyCode:e.which;if(t===13){f.mergerUnit.search()}};f.hideModal=function(){e.$promise.then(e.hide)};f.$ok=function(t){if(t.id!==f.ticket.id){f.mergerUnit.submiting=true;pe.sdk.OpenTicketApi().merge({ids:[f.ticket.id],targetId:parseInt(t.id)}).then({success:function(e){f.mergerUnit.submiting=false;f.hideModal();d.removeTabById(c,"tickets_detail"+f.ticket.id);m.add("工单#"+f.ticket.no+"已合并到#"+t.no,"success")},fail:function(e){f.mergerUnit.submiting=false;m.add(e.error_description,"danger")}})}else{m.add("合并工单不能为自已","danger")}}};f.helpCenter=function(){if(k.user.role.name!=="ROLE_NAME_VISITOR"){window.open("/new/#/article/new?id="+f.ticket.id+"&subject="+f.ticket.subject+"&link="+n.bucket_domain+"/","_blank")}else{m.add("你无权进行此项操作","danger")}};f.ticketTemplate=function(){void 0};var ee=function(){var e={};e.providerLogo=l.provider&&l.provider.contentUrl?l.provider.contentUrl:l.provider.defaultlogo;e.providerName=l.provider&&l.provider.name?l.provider.name:"";e.ticketNo=f.ticket.no?f.ticket.no:"";e.ticketSubject=f.ticket.subject?f.ticket.subject:"";e.ticketCreatedAt=f.ticket.createdAt?f.ticket.createdAt:"";e.ticketRequesterName=f.ticket.requester&&f.ticket.requester.name?f.ticket.requester.name:"";e.ticketRequesterMobilePhone=f.ticket.requester&&f.ticket.requester.mobilePhone?f.ticket.requester.mobilePhone:"";e.ticketRequesterEmail=f.ticket.requester&&f.ticket.requester.email?f.ticket.requester.email:"";e.QRCode=l.provider.contentUrl;var t='<div style="border-bottom: 1px solid #e4e4e4;padding-bottom: 3px;position: relative;">'+'<div style="float: left;width: 80%;">'+'<div style="display: flex;display: -webkit-flex;align-items:center;">'+'<img src="'+e.providerLogo+'" alt="没有LOGO图片" style="width:34px;height:34px;" />'+'<label style="margin-left: 10px;">'+e.providerName+"</label>"+"</div>"+'<div style="margin-top: 20px;">'+'<p style="font-weight: bold;margin: 0;word-wrap: break-word;">#'+e.ticketNo+e.ticketSubject+"</p>"+"</div>"+'<div style="margin-top: 14px;color: #e6e6e6;">'+"<span>"+e.ticketCreatedAt+"</span> | "+"<span>"+e.ticketRequesterName+" </span>"+'<span class="font_size14px">'+(e.ticketRequesterMobilePhone||e.ticketRequesterEmail?"&lt;":"")+e.ticketRequesterMobilePhone+(e.ticketRequesterMobilePhone&&e.ticketRequesterEmail?"&nbsp;&nbsp;":"")+e.ticketRequesterEmail+(e.ticketRequesterMobilePhone||e.ticketRequesterEmail?"&gt;":"")+"</span>"+"</div>"+"</div>"+'<div style="display: flex;display: -webkit-flex;display:none;align-items:center;position: absolute;bottom: 15px;right:0px;">'+'<div style="float: left;">'+'<img src="'+e.QRCode+'" style="width:60px;height:60px;" />'+"</div>"+'<div style="margin-left: 10px;">扫码查看<br>全部附件</div>'+"</div>"+'<div class="clear"></div>'+"</div>";return t};var te=function(){var n=[{name:"客户"},{name:"处理人"},{name:"抄送给"}];n[0].value=f.ticket.requester&&f.ticket.requester.name?f.ticket.requester.name:"";n[1].value="";if(f.ticket.workflowTemplate){n[1].value=f.ticket.workflowTemplate.name?f.ticket.workflowTemplate.name:""}if(f.ticket.serviceDesk){n[1].value=f.ticket.serviceDesk.name?p("translate")(f.ticket.serviceDesk.name):""}if(f.ticket.engineer){n[1].value+=f.ticket.engineer.user&&f.ticket.engineer.user.name?"/"+f.ticket.engineer.user.name:""}var s=[];angular.forEach(f.ticket.ccs,function(e,t,i){if(e.name){s[t]=e.name}});n[2].value=s.join(",");var e=angular.fromJson(localStorage.getItem("systemFieldTicketType"));if(e){n.push({name:(e.required?"* ":"")+e.title?e.title:"类型"})}else{n.push({name:"类型"})}n[3].value=f.ticket.ticketType&&f.ticket.ticketType.name?f.ticket.ticketType.name:"";var t=angular.fromJson(localStorage.getItem("systemFieldPriority"));if(t){n.push({name:(t.required?"* ":"")+t.title?t.title:"优先级"})}else{n.push({name:"优先级"})}var t=angular.fromJson(angular.fromJson(localStorage["systemFieldPriority"]).customFieldOptions);if(t){n[4].value="";angular.forEach(t,function(e,t,i){if(e.value==f.ticket.priority){n[4].value=e.name;return}})}else{n[4].value=""}var i=angular.fromJson(localStorage.getItem("systemFieldServiceCatalog"));if(i){n.push({name:(i.required?"* ":"")+i.title?i.title:"服务目录"})}else{n.push({name:"服务目录"})}n[5].value=f.ticket.serviceCatalogList?f.ticket.serviceCatalogList:"";n.push({name:"标签"});var a=[];angular.forEach(f.ticket.tags,function(e,t,i){if(e.name){a[t]=e.name}});n[6].value=a.join(",");var r=[];angular.forEach(f.ticket.ticketCustomFields,function(e,t,i){var n={};if(e.customField){n.value=e.customField.value?e.customField.value:"";n.name=e.customField.title?e.customField.title:"";if(e.customField.type=="checkbox"){n.type="checkbox"}}if(e.value){n.value=e.value}r.push(n)});var o=n.concat(r);void 0;var l="";angular.forEach(o,function(e,t,i){if(e.type=="checkbox"){l+='<div class="allfiled"><input style="margin-top: 33px;" type="checkbox" '+(e.value==true?"checked":"")+"/> "+e.name+"</div>"}else{l+='<div class="allfiled">'+'<div class="allfiled-name">'+e.name+"</div>"+'<div class="allfiled-value">'+e.value+"</div>"+"</div>"}});return l};var ie=function(e){void 0;var l="";var r="source/images/face/header_40.png";angular.forEach(e,function(i){var e=i.user&&i.user.photo&&i.user.photo.contentUrl?i.user.photo.contentUrl:"";var t=i.user?i.user.name||i.user.nickname||i.user.email:"";var n=i.ticketComment&&i.ticketComment.content?i.ticketComment.content.replace(/\n/g,"<br/>"):"";if(n&&i.ticketComment.type==5){n=n.split(",")?n.split(",")[2]:n}var s=n?'<div class="content">'+n+"</div>":"";var a="";if(i.ticketComment&&i.ticketComment.attachments&&i.ticketComment.attachments.length>0){angular.forEach(i.ticketComment.attachments,function(e){var t=p("judgeType")(e.contentType,i.ticketComment.type);if(t=="image"||t=="map"){a+='<img style="display: block;max-width: 100%;" src="/attachment/download/'+e.contentUrl+'" />'}if(t=="files"){a+='<p clas="log-title">'+(e.fileName?e.fileName:"")+'\x3c!--<span  class="message">（附件消息，请扫码下载查看）</span>--\x3e</p>'}if(t=="audio"){a+='<p clas="log-title">'+(e.fileName?e.fileName:"")+'\x3c!--<span class="message">（语音消息，请扫码试听）</span>--\x3e</p>'}if(t=="video"){a+='<p clas="log-title">'+(e.fileName?e.fileName:"")+'\x3c!--<span  class="message">（视频消息，请扫码查看）</span>--\x3e</p>'}})}if(i.question){l+='<li style="position: relative;"><div class="clear" >'+'<img src="'+p("changeLogoUrl")(e,r)+'"class="logourl">'+'<div style="margin-left: 46px;padding-right: 36px;">'+'<p clas="log-title"><span style="color:#558EFC;margin-right: 10px;">'+t+'</span><span style="color: #e6e6e6;">'+p("dateFilter_style1")(i.createdAt)+"</span></p>"+'<div class="log-inner">'+(i.question.title?'<p class="question-title">'+i.question.title+"</p>":"")+(i.question.summary?'<p class="question-summary">'+i.question.summary+"</p>":"")+'\x3c!--<span  class="message">（知识库文章，请扫码查看）</span--\x3e'+"</div>"+"</div>"+"</div></li>"}else{l+=s||a?'<li style="position: relative;"><div class="clear" >'+'<img src="'+p("changeLogoUrl")(e,r)+'"class="logourl">'+'<div style="margin-left: 46px;padding-right: 36px;">'+'<p clas="log-title"><span style="color:#558EFC;margin-right: 10px;">'+t+'</span><span style="color: #e6e6e6;">'+p("dateFilter_style1")(i.createdAt)+"</span></p>"+'<div class="log-inner">'+s+a+"</div>"+"</div>"+"</div></li>":""}if(i.chatLogs&&i.chatLogs.length>0){void 0;l+='<li style="position: relative;text-align: center;height: 30px;line-height: 30px;"><span style="border-radius: 15px;padding: 5px 15px;border: 1px solid #ccc;">会话#'+(i.id?i.id:"")+"开始</span></li>";angular.forEach(i.chatLogs,function(e){var t="source/images/face/header_40.png";var i=e.user&&e.user.photo&&e.user.photo.contentUrl?e.user.photo.contentUrl:"";var n=e.user?e.user.name||e.user.nickname||e.user.email:"";var s=e.content?e.content.replace(/\n/g,"<br/>"):"";if(s&&e.type=="map"){s=s.split(",")?s.split(",")[2]:s}var a=s?'<div class="content">'+s+"</div>":"";var r="";if(e.attachment){var o=p("judgeType")(e.attachment.contentType,e.type=="map"?5:e.type);if(o=="image"||o=="map"){r+='<img style="display: block;max-width: 100%;" src="/attachment/download/'+e.attachment.contentUrl+'" />'}if(o=="files"){r+='<p clas="log-title">'+(e.attachment.fileName?e.attachment.fileName:"")+'<span  class="message">（附件消息，请扫码下载查看）</span></p>'}if(o=="audio"){r+='<p clas="log-title">'+(e.attachment.fileName?e.attachment.fileName:"")+'<span class="message">（语音消息，请扫码试听）</span></p>'}if(o=="video"){r+='<p clas="log-title">'+(e.attachment.fileName?e.attachment.fileName:"")+'<span  class="message">（视频消息，请扫码查看）</span></p>'}}if(e.question){l+='<li style="position: relative;"><div class="clear" >'+'<img src="'+p("changeLogoUrl")(i,t)+'"class="logourl">'+'<div style="margin-left: 46px;padding-right: 36px;">'+'<p clas="log-title"><span style="color:#558EFC;margin-right: 10px;">'+n+'</span><span style="color: #e6e6e6;">'+p("dateFilter_style1")(e.createdAt)+"</span></p>"+'<div class="log-inner">'+(e.question.title?'<p class="question-title">'+e.question.title+"</p>":"")+(e.question.summary?'<p class="question-summary">'+e.question.summary+"</p>":"")+'<span  class="message">（知识库文章，请扫码查看）</span>'+"</div>"+"</div>"+"</div></li>"}else{l+=a||r?'<li style="position: relative;"><div class="clear" >'+'<img src="'+p("changeLogoUrl")(i,t)+'"class="logourl">'+'<div style="margin-left: 46px;padding-right: 36px;">'+'<p clas="log-title"><span style="color:#558EFC;margin-right: 10px;">'+n+'</span><span style="color: #e6e6e6;">'+p("dateFilter_style1")(e.createdAt)+"</span></p>"+'<div class="log-inner">'+a+r+"</div>"+"</div>"+"</div></li>":""}});l+='<li style="position: relative;text-align: center;height: 30px;line-height: 30px;"><span style="border-radius: 15px;padding: 5px 15px;border: 1px solid #ccc;">会话#'+(i.id?i.id:"")+"结束</span></li>"}});return"<ul>"+l+"</ul>"};var ne=function(t){var i=ee();var n=te();var s="";var a="";se(function(e){s=ie(e);ae(t,i,n,s,a)})};var se=function(r){var e="api/ticket/"+f.ticket.id+"/log.json?_token="+getCookie("user_token")+"&_page=1&_count=10000&_desc=createdAt&provider_id="+k.provider.id;var t=0;o.get(e).success(function(t,e,i,n){if(t.status==0&&t.result){var s=0;var a=function(e){s=e?--s:s;void 0;if(s==0){r(t.result.ticketLogs)}};angular.forEach(t.result.ticketLogs,function(t){if(t.ticketComment&&t.ticketComment.content&&t.ticketComment.questionId){s++;var e=t.ticketComment.content+"/phone.json";o.get(e).success(function(e){if(e.success&&e.json&&e.json.question){t.question={title:e.json.question.title?e.json.question.title:"",summary:e.json.question.summary?e.json.question.summary:""}}a(true)})}if(t.ticketComment&&t.ticketComment.chat&&t.ticketComment.chat.id){s++;var e="api/chat/"+t.ticketComment.chat.id+"/log.json";o.get(e,{params:{_token:getCookie("user_token"),provider_id:k.provider.id,_count:1e4,_page:1}}).success(function(e){if(e.status==0&&e.result&&e.result.chatLogs){t.chatLogs=e.result.chatLogs;angular.forEach(t.chatLogs,function(t){if(t.questionId){s++;var e="/question/"+t.questionId+".json";o.get(e).success(function(e){if(e.success&&e.json){t.question={title:e.json.title?e.json.title:"",summary:e.json.summary?e.json.summary:""}}a(true)})}})}a(true)})}});a(false)}}).error(function(){m.add("服务器异常！","danger")})};var ae=function(t,e,i,n,s){if(navigator.userAgent.toLowerCase().indexOf("chrome")>-1){t.document.open()}else{t.document.open()}t.document.write("<!DOCTYPE html>"+"<html><head></head>"+"<style>"+'body {min-width: 600px;font-weight: normal;overflow-y: auto;color: #666;font-style: normal;font-size: 14px;font-family: "微软雅黑", Tahoma, Arial, "宋体";display: block;padding: 20px 0px;margin: 0;}'+"label {font-size: 16px;font-weight: bold;color: #666}"+"p {margin: 5px 0px;}"+"ul {list-style: none;margin: 27px 0 0 0;padding: 0;}"+".font_size14px {font-size: 14px;}"+".allfiled {float: left;margin-left:3%;margin-top: 20px;min-height: 60px;}"+".allfiled-name {word-wrap:break-word;font-weight: bold;}"+".allfiled-value {border: 1px solid #ccc;padding: 5px;word-wrap:break-word;margin-top: 10px;min-height: 19px;border-radius:5px;}"+'.clear:after {content: "";height: 0;visibility: hidden;display: block;clear: both;}'+".log-title{font-size: 14px;word-wrap:break-word;max-width: 100%;}"+".content {font-size: 14px;color: #333;word-wrap:break-word;max-width: 100%;}"+".log-inner {max-width: 100%;margin-top:16px;margin-bottom:28px;padding:10px;border: 1px solid #E4E4E4;display: inline-block;border-radius: 5px;}"+".logourl {width: 40px; height: 40px; position: absolute; top: 0px; border-radius: 50%; left: 0px; right: auto;}"+".question-title {font-size:14px;color:#333;}"+".question-summary {font-size:14px;color:#c3c3c3;}"+".message {color:#e6e6e6;font-size: 12px;}"+"</style>"+'<body onload="window.print()">'+"<div>"+e+i+'<div style="clear: both"></div> '+"</div>"+'<div class="ticket-log">'+'<div style="display: flex;display: -webkit-flex;justify-content: center;align-items:center;margin-top: 20px;"><div style="width: 20%;border-bottom: 1px dashed  #ccc;"></div><div style="padding: 0 10px;"> 会话内容 </div><div style="width: 20%;border-bottom: 1px dashed #ccc;"></div></div>'+n+"</div>"+'<div class="footer">'+s+"</div>"+"</body>"+"<script>"+'var allfiled = document.getElementsByClassName("allfiled");'+"var number = 0;"+"for(var i=0;i<allfiled.length;i++){"+"if(allfiled[i].clientWidth>283){"+'allfiled[i].style.width= "94%";'+"if(number==0){"+"if(i%2 !=0){"+'allfiled[i-1].style.width= "94%";'+"};"+"number = i;"+"}else{"+'console.log(i+":::"+number);'+"console.log((i-number)%2);"+"if((i-number)%2 ==0){"+'allfiled[i-1].style.width= "94%";'+"};"+"number = i;"+"}"+"}else {"+'allfiled[i].style.width= "45.5%";'+"}"+"}"+"<\/script>"+"</html>");if(navigator.userAgent.toLowerCase().indexOf("chrome")>-1){t.onbeforeunload=function(e){t.close();return".\n"};t.onabort=function(e){t.document.close();t.close()}}t.document.close()};f.print=function(){_hmt.push(["_trackEvent","工单处理","打印"]);var e=window.open("","_blank","width="+window.screen.availWidth+",height="+window.screen.availHeight+",top=0,left=0");ne(e)};var re=null;f.printWord=function(e){re=g({scope:f,title:"导出word",contentTemplate:"source/scripts/directives/export-temp/export-template.html",html:true,show:true,placement:"center",backdrop:"static"});oe(e,"TYPE_DOC")};f.printPDF=function(e){re=g({scope:f,title:"导出PDF",contentTemplate:"source/scripts/directives/export-temp/export-template.html",html:true,show:true,placement:"center",backdrop:"static"});oe(e,"TYPE_PDF")};f.$on("$destroy",function(){if(re){re.$promise.then(re.hide)}});var oe=function(e,t){var i={ticketId:e,exportType:t};org.ewei.sdk.OpenTicketExportApi().ticketExportById(i).then({success:function(e){}})};f.refuseReasons=["无效信息","重复信息","恶意骚扰","其他原因"];f["delete"]=function(){_hmt.push(["_trackEvent","工单处理","删除"]);if(!v.hasPermission("ticket_delete")){m.add("您没有权限删除该工单！","danger");return}var e=g({scope:f,title:"请选择删除工单的理由",template:"modal/modal.tpl.w380.html",contentTemplate:"source/views/ticket/confirm_delete_template.html",html:true,show:true,placement:"center"});f.hideModal=function(){e.$promise.then(e.hide)};f.$ok=function(e){if(!e||!e.length||e==""){f.refuseErrorMessage="请选择删除工单理由";return}le();f.deleting=true;o({url:"/api/v1/tickets/batch_delete.json",method:"POST",data:{ids:""+f.ticket.id,deleteReason:e}}).success(function(e,t,i,n){f.deleting=false;f.hideModal();if(e.status==0){if(f.webchat!=null&&f.webchat!=undefined){ce()}else{d.removeTabById(c,"tickets_detail"+f.ticket.id);m.add("工单#"+f.ticket.no+"删除成功，窗口已关闭","success")}}else{ce();m.add("删除失败","danger")}}).error(function(){ce()})}};f.downloadApplication=function(){a.open(l.applicationUrl);l.plugPrometStatus="download-done"};f.closedownloadApplication=function(){l.$broadcast("installEweiHubServer","remote_desk",null,true)};f.destroy=function(){_hmt.push(["_trackEvent","工单处理","删除"]);f.confirmContent="您确定要彻底删除此工单吗？";var e=g({scope:f,title:"确认",contentTemplate:"source/views/confirm_template.html",html:true,show:true,placement:"center"});f.hideModal=function(){e.$promise.then(e.hide)};f.$ok=function(){le();o({url:"/api/v1/tickets/batch_destroy.json",method:"DELETE",params:{ids:""+f.ticket.id}}).success(function(e,t,i,n){f.hideModal();if(e.status==0){r.deleteTicket(f.ticket.id);d.removeTabById(c,"tickets_detail"+f.ticket.id)}else{ce();m.add("删除失败","danger")}}).error(function(){ce()})}};f.$on("serviceCatalogList",function(e,t){f.ticket.serviceCatalogList=t});f.$on("selectedUser",function(e,s){if(f.ticket.id!=null){var t=s==null?null:s.id;var i=f.ticket.requester==null?null:f.ticket.requester.id;var n=i==null?null:f.ticket.requester.name;if(t!=i){o({url:"/api/v1/ticket_update/"+f.ticket.id+"/requester.json",method:"PUT",data:{requester_id:t}}).success(function(e,t,i,n){if(e.status==0){f.ticket.requester=s;if(undefined!==f.webchat){f.webchat.user=s}F.setUser(s);l.$broadcast("ticket_sla_update",{ticketId:f.ticket.id});x.updateCached(f.ticket)}else{m.add("修改工单客户失败","danger","left")}})}}});f.$on("selectedPlanSolvedAt",function(e,s){if(f.ticket.id!=null&&!f.ticket.sla){var t=f.ticket.ticketMetric.planSolvedAt;if(s!=t){o({url:"api/v1/ticket_update/"+f.ticket.id+"/plan_solved_at.json",method:"PUT",data:{planSolvedAt:s}}).success(function(e,t,i,n){if(e.status==0){f.ticket.ticketMetric.planSolvedAt=s;x.updateCached(f.ticket)}else{m.add("修改要求完成的时间失败","danger","left")}})}}});var le;function ce(){if(le){le();$(function(){f.refreshTicketDetail()},800)}le=f.$on("ticket_change",function(e,t){if(!t||t.changeType!="update")return;if(!f.$$destroyed&&t&&t.ticketIds&&t.ticketIds.indexOf(f.ticket.id)>-1&&t.updaterId!==k.user.id){f.refreshTicketDetail()}})}ce();f.star_target=function(s){s.isTarget=!s.isTarget;var e;if(s.isTarget){e="/api/v1/tickets/"+s.id+"/add_subscription.json"}else{e="/api/v1/tickets/"+s.id+"/cancel_subscription.json"}o({url:e,method:"PUT"}).success(function(e,t,i,n){if(e.status!=0){s.isTarget=!s.isTarget}})};f.refreshTicketDetail=function(){if(c.current.name.indexOf("webchat_ticket_detail")>=0){J(u.ticketId,true)}else{J(u.id,false)}};function ue(){if(!f.ticket||!f.ticket.ticketType||!f.ticket.ticketType.id){return M.resolve(null)}return o({url:"/api/v1/ticket_custom_form/get/"+f.ticket.ticketType.id+".json",method:"GET"}).then(function(e){if(e.data&&e.data.status==0&&e.data.result){return e.data.result.ticketCustomForm}else{return M.reject(e.data)}})}function de(){if(!f.ticket||!f.ticket.ticketCustomFields){return}f.customFormLoading=true;ue().then(function(e){f.customFormLoading=false;if(e&&e.customFormFields){var i=[];angular.forEach(e.customFormFields,function(t){var e=_.find(f.ticket.ticketCustomFields,function(e){return t&&t.customField&&t.customField.id==e.id});if(e&&!e.customField.sysCustomForm){if(!e.sysCustomForm&&(!t.deleted||t.deleted&&e.value&&(f.ticket.status=="solved"||f.ticket.status=="closed"))){e.customFormInfo={deleted:t.deleted,position:t.position};i.push(e)}}});f.customFormFields=_.sortBy(i,function(e){return e.customFormInfo.position});f.showCustomForm=f.customFormFields.length>0}else{f.showCustomForm=false;f.customFormFields=[]}},function(e){m.add("获取扩展表单失败，请重试！","danger")})}f.$watch("ticket.ticketType",function(e,t){if(e!==t){de()}},true);f.$watchCollection("ticket.ticketCustomFields",function(e,t){if(e!==t){if(e&&!t){de();return}var i=false;for(var n=0;n<e.length;n++){if(e[n]!=t[n]&&(e[n].id!=t[n].id||e[n].value!=t[n].value)){i=true;break}}if(i){de()}}});f.$on("ticket-custom-field-value-updated",function(e,t,i,n){if(f.ticket&&f.ticket.id===t&&f.ticket.ticketCustomFields){var s=_.find(f.ticket.ticketCustomFields,function(e){return e.id===i});if(s){s.value=n;if(s.customField){s.customField.value=n}}}});f.$watch("newComment",function(e,t){if(e!==t){h.ticket=e}},true)}}(org.ewei);(function(le,ce){"use strict";le.module("eweiApp.ticket").controller("viewListByTicketController",e).controller("viewTicketListController",t);e.$inject=["$rootScope","$scope","$state","$filter","$location","$http","alertService","commonTools","ConsoleConfig","apiRestfulService","coreModelService","coreNotifyService","apiTicketViewService"];function e(i,n,t,s,e,a,r,o,l,c,u,d,p){var f="VIEW_TITLE_TICKET_SUBSCRIPTION";var m="{'$and':[{'$and':[{'$eq':{'type':'ticket'}},{'$eq':{'provider.id':${current_provider_id}}},{'$eq':{'active':1}}]},{'$or':[{'$eq':{'engineer.id':${current_engineer_id}}},{'$eq':{'isAllServiceDesk':true}},{'$in':{'id':[${current_engineer_service_desk_view_ids!}]}}]}]}";n.ticketListBuried=function(e){if(s("translate")(e)){_hmt.push(["_trackPageview","/工单管理/子级页面/"+s("translate")(e)]);_hmt.push(["_setCustomVar",i.vertionNumber,"名称","工单管理-"+s("translate")(e),1]);_hmt.push(["_trackEvent","工单管理",s("translate")(e)])}};n.ticketSettingBuried=function(){_hmt.push(["_trackPageview","/工单管理/子级页面/工单设置"]);_hmt.push(["_setCustomVar",i.vertionNumber,"名称","工单管理-工单设置",1]);_hmt.push(["_trackEvent","工单管理","工单设置"])};n.ticketViewBuried=function(e){_hmt.push(["_trackPageview","/工单管理/子级页面/添加自定义视图"]);_hmt.push(["_setCustomVar",i.vertionNumber,"名称","工单管理-添加自定义视图",1]);_hmt.push(["_trackEvent","工单管理","添加自定义视图"]);i.customViewType=e};var g=this.__proto__.constructor.name+"_"+Date.now();var v={_fields:"",_filter:{},_asc:"",_desc:"",_count:999,_page:1};var h;n.refreshViewList=_.throttle(function(){le.forEach(n.views,function(e){e.count=0});n.rotate=n.rotate?n.rotate+360:360;n.transform={transform:"rotate("+n.rotate+"deg)"};n.$broadcast("refreshTableData");n.refresh()},3e3,{trailing:false});n.refresh=function(){w()};a.get("get_user_flag.json",{params:{userId:l.user.id}}).success(function(e){userAginLogin(e);if(e.success){var t=e.json;if(t.ticketFlag==undefined||!t.ticketFlag){$("#ticketNoticeImgVisible").css("visibility","visible");$("#customerNoticeImgVisible").css("visibility","hidden");i.ticketNoticeImgState=true}}else{$("#ticketNoticeImgVisible").css("visibility","visible");i.ticketNoticeImgState=true}});var y=function(){T()};var k=false,C=false;var b=function(){var t=u.list.ticket.orderedViews.gets(1);var e=u.detail.ticket.views.gets(u.list.ticket.views.gets(1));n.views=_.sortBy(e,function(e){if(t.indexOf(e.id)>-1){return t.indexOf(e.id)}return 99999})};var w=function(){n.loading=true;p.getSorted(d.constant.EVENT_DETAIL_TICKET_ORDERED_VIEWS);p.run({_count:999,_do_count:false,_filter:"{'$and':[{'$eq':{'type':'ticket'}},{'$eq':{'active':1}}]}"},"",d.constant.EVENT_DETAIL_TICKET_VIEWS,function(e){n.loading=false;if(e.status!=0&&(e.status==3001||e.status==3002||e.status==3003)){r.add("登录过期，请重新登录","danger")}else if(e.status!=0){r.add(e.result.error_description,"danger")}n.$broadcast("loadTicketListView")})};var T=function(){b();if(JSON.stringify(v)!==JSON.stringify(h)){w();h=le.copy(v)}if(n.views&&n.views.length>0){if(t.current.name==="ticket_views"){var e=u.config.route.get("ticket_views.detail");if(!e){e={name:"ticket_views.detail",params:{id:n.views[0].id}}}t.go(e.name,e.params)}}};var S=function(){d.register(g,d.constant.EVENT_DETAIL_TICKET_ORDERED_VIEWS,function(){k=true;T()});d.register(g,d.constant.EVENT_DETAIL_TICKET_VIEWS,function(){C=true;T()});d.register(g,d.constant.EVENT_LIST_CACHED_TICKETS_AVAILABLE,function(e,t){for(var i in n.views){if(n.views.hasOwnProperty(i)){if(t.listName==="tickets-"+n.views[i].id){if(t.type==="add"){n.views[i].count++}else if(t.type==="remove"){n.views[i].count--}}}}})};n.sortOptions={handle:".sort-handle",setData:function(e,t){e.setData("data",t.textContent)},onUpdate:function(e){var t=[];le.forEach(n.views,function(e){t.push(e.id)});c.run({url:"/api/v1/view_sequence/save_or_update.json"}).post({sequence:t.join(",")})}};S();y();n.$on("$destroy",function(){d.unRegister(g)});n.$on("addSubscription",function(){le.forEach(n.views,function(e){if(e.title==f){e.count++}})});n.$on("deleteSubscription",function(){le.forEach(n.views,function(e){if(e.title==f){e.count--}})});n.$on("refreshTicketViewCount",function(){n.refresh()});n.$on("onloadTicektViews",function(e,t){le.forEach(n.views,function(e){if(t.id==e.id){e.count=t.count}})})}t.$inject=["$rootScope","$http","$stateParams","$scope","coreNotifyService","coreModelService","apiTicketService","apiTicketStatusColorService","apiTicketSubscriptionsService","apiSetTicketSubscriptionService","apiTicketCustomFieldValueService","apiCustomFieldListShowService","NgTableParams","utils","$state","ConsoleConfig","apiTicketServiceCatalogNameService","apiTicketEvaluateConfigService","apiTicketCopytoService","apiTicketTagsService","permissions","locker","$modal_","$filter","alertService","cachedTicketService","cachedTicketTagService","commonTools","ticketRecentViewService","apiTicketSolutionService","ticketListCustomOptions","$ocLazyLoad","DefaultColumnWidth","$q"];function t(R,n,e,U,s,V,t,i,a,r,o,l,c,u,d,q,p,f,m,g,v,h,y,G,k,C,b,w,T,S,K,F,B,A){var E=U.__proto__.constructor.name+"_"+Date.now();U.listName="tickets-"+e.id;U.statusColors={};U.servicecatalogs=[];U.columns=[];var O=[];U.tickets=[];U.view={};U.viewClientWidth=window.screen.width-55-330;U.isShowCreateNewTicket=false;U.isShowHowToCreateTicket=false;U.isAuthorTicketSettingVia=false;U.isShowSimulationTicketPointer=false;U.submitNewTicketTip=q.providerHelpCenterUrl+"/showAddTicket";U.placeholder="搜索主题、编号";var I=V.config.route.get(U.listName+"-search");var L=V.config.route.get(U.listName+"-sort");var D=V.list.cachedTickets.get(U.listName).page();var P=I?le.copy(I.advancedQueryConditionByParam)||{}:{};U.advancedQueryCondition=I?le.copy(I.advancedQueryCondition)||{}:{};function x(){if(U.advancedQueryCondition.createdAtFrom!=null&&typeof U.advancedQueryCondition.createdAtFrom==="string"){U.advancedQueryCondition.createdAtFrom=w.parseDateTime(U.advancedQueryCondition.createdAtFrom,"yyyy-MM-dd HH:mm:ss")}if(U.advancedQueryCondition.createdAtTo!=null&&typeof U.advancedQueryCondition.createdAtTo==="string"){U.advancedQueryCondition.createdAtTo=w.parseDateTime(U.advancedQueryCondition.createdAtTo,"yyyy-MM-dd HH:mm:ss")}if(U.advancedQueryCondition.updatedAtFrom!=null&&typeof U.advancedQueryCondition.updatedAtFrom==="string"){U.advancedQueryCondition.updatedAtFrom=w.parseDateTime(U.advancedQueryCondition.updatedAtFrom,"yyyy-MM-dd HH:mm:ss")}if(U.advancedQueryCondition.updatedAtTo!=null&&typeof U.advancedQueryCondition.updatedAtTo==="string"){U.advancedQueryCondition.updatedAtTo=w.parseDateTime(U.advancedQueryCondition.updatedAtTo,"yyyy-MM-dd HH:mm:ss")}}U.argument={_fields:"",_filter:{},_asc:L?L.order=="asc"?L.orderBy:"":"",_desc:L?L.order=="desc"?L.orderBy:"":"",_count:99999,_page:D||1,searchType:I?I.searchType:null,advancedQueryCondition:I?I.advancedQueryConditionByParam:null,searchKey:I?I.searchKey:null};x();if(I&&I.searchType=="advancedQuery"){U.isAdvancedQuery=true}U.showCheckboxes=true;U.defaultSortParams={};U.checkboxes={checked:false,items:{}};U.datepickers={startForm:false,startTo:false,updateFrom:false,updateTo:false};U.refuseReasons=["无效信息","重复信息","恶意骚扰","其他原因"];U.serverDataLoaded=false;function N(){if(U.view.fields&&(-1!=U.view.fields.indexOf("evaluate.score")||-1!=U.view.fields.indexOf("evaluate.solved"))){f.run()}}U.setEvaluates=function(){var e=V.config.evaluate;le.forEach(U.tickets,function(t){if(t&&t.evaluate){le.forEach(e.firstQuestionOptions,function(e){if(e.value==String(t.evaluate.solved)){t.evaluate.solvedName=e.name}});le.forEach(e.secondQuestionOptions,function(e){if(e.value==t.evaluate.score){t.evaluate.scoreName=e.name}})}})};U.getStatusColors=function(){var e=V.list.cachedTickets.get(U.listName).gets(U.argument._page).join(",");if(e&&e.length>0){i.run(U.listName,s.constant.EVENT_LIST_TICKET_STATUSCOLORS,U.argument._page,"",{ticketIds:e},function(e){if(e){}})}};U.setStatusColors=function(){var e=V.list.cachedTickets.get(U.listName).gets(U.argument._page);var t={};le.forEach(e,function(e){t[e]=V.detail.statuscolors.get(e)});U.ticketStatusColors=t};U.getSubscriptions=function(){var e=V.list.cachedTickets.get(U.listName).gets(U.argument._page).join(",");if(e&&e.length>0){a.run(U.listName,s.constant.EVENT_DETAIL_TICKETS,U.argument._page,"",{ticketIds:e},function(e){if(e){if(e.status==0&&le.isDefined(e.result)){C.updateSubscriptionCached(e.result);J()}}})}};U.getCopyto=function(){if(!U.view)return;if(U.view.otherFields&&-1!=U.view.otherFields.indexOf("copyTo")){var e=V.list.cachedTickets.get(U.listName).gets(U.argument._page).join(",");if(e&&e.length>0){m.run(U.listName,s.constant.EVENT_DETAIL_TICKETS,U.argument._page,"",{ticketIds:e},function(e){if(e.status==0&&le.isDefined(e.result)){C.updateCopyToCached(e.result);J()}})}}};U.getSolution=function(){if(!U.view)return;if(U.view.fields&&-1!=U.view.fields.indexOf("solutionId")){var t=[],i=[];var e=V.detail.cachedTickets.gets(V.list.cachedTickets.get(U.listName).gets(U.argument._page));e.forEach(function(e){if(e.solutionId){t.push(e.solutionId);i.push({sId:e.solutionId,tId:e.id})}});if(t&&t.length>0){S.run({ids:t},i,function(){J()})}}};U.getTags=function(){if(!U.view)return;if(U.view.otherFields&&-1!=U.view.otherFields.indexOf("tags")){var e=V.list.cachedTickets.get(U.listName).gets(U.argument._page).join(",");if(e&&e.length>0){g.run(U.listName,s.constant.EVENT_DETAIL_TICKETS,U.argument._page,"",{ticketIds:e},function(e){if(e.status==0&&le.isDefined(e.result)){b.updateCached(e.result);J()}})}}};U.getServiceCatalogName=function(){if(!U.view)return;if(U.view.fields&&-1!=U.view.fields.indexOf("serviceCatalog.id")){var e=V.list.cachedTickets.get(U.listName).gets(U.argument._page).join(",");if(e&&e.length>0){p.run(U.listName,s.constant.EVENT_DETAIL_TICKETS,U.argument._page,"",{ticketIds:e},function(e){if(e.status==0&&le.isDefined(e.result)){C.updateServiceCatalogCached(e.result);J()}})}}};var M={lastClickTime:0,ticketId:0};U.setSubscription=function(t){var e=(new Date).getTime();if(t.id===M.ticketId){if(e-M.lastClickTime<5e3){k.add("设置星标太快，休息一下，稍后再试","danger");return}}M.ticketId=t.id;M.lastClickTime=e;var i=!t.isTarget;for(var n=0;n<U.views.length;n++){if("VIEW_TITLE_TICKET_SUBSCRIPTION"==U.views[n].title){if(i){U.$emit("addSubscription")}else{U.$emit("deleteSubscription")}}}r.run(t.isTarget,s.constant.EVENT_DETAIL_TICKETS,{ticket_id:t.id},"",function(e){if(e.status==0){C.updateSubscriptionCached({ticketId:t.id,isTarget:t.isTarget})}})};function j(){l.run(U.listName,s.constant.EVENT_LIST_FIELD_TITLE,1,"",{view_id:U.view.id},function(e){})}U.getCustomFieldValue=function(){if(!U.view)return;if(U.view.customFields){var e=JSON.parse(U.view.customFields||null);var t=[];le.forEach(e,function(e){t.push(e.id)});var i=V.list.cachedTickets.get(U.listName).gets(U.argument._page).join(",");if(i&&i.length>0){o.run(U.listName,s.constant.EVENT_DETAIL_TICKETS,1,"",{customFieldIds:t.join(","),ticketIds:i},function(e){if(e.status==0&&le.isDefined(e.result)){C.updateCustomFieldCached(e.result);J()}})}}};function Q(e,t,i,n){var s=2;for(var a in e){if(e.hasOwnProperty(a)){s++;var r=i&&i[e[a].id];var o=n&&n[e[a].id];t=t-(r|o);if(t<=0){break}}}return s}function H(e){var i=V.detail.fields.title.gets(V.list.fields.title.get(U.listName).gets(1));U.columns=[{title:"",visible:true,sortable:false,widthClass:"w15",field:"subscription",fieldCount:1}];var n=[];if(U.view&&U.view.sortFields){U.view.sortFields=le.fromJson(U.view.sortFields);le.forEach(U.view.sortFields,function(e){for(var t=0;t<i.length;t++){if(i[t].id==e.id){n.push(i[t]);break}}})}var s=["serviceCatalog.id","tags","copyTo","solutionId","ticketMetric.slaResponseTarget","ticketMetric.slaSolveTarget"];O=[];n=n.length>0?n:i;var a=e?i.length:Q(n,U.viewClientWidth,U.fieldsLength,U.customFieldsLength);le.forEach(n,function(e,t){if(t<=a){var i={};i.title=e.title;i.visible=true;i.sortable=e.systemFieldKey&&s.indexOf(e.id)===-1;i.widthClass=Z(e.id);i.field=e.id;if("status"!==e.id&&"id"!==e.id){U.columns.push(i)}}if("id"!==e.id){O.push(e.id)}});U.tableParams&&U.tableParams.reload()}var W=0;U.loadMoreFields=function(){if(W++===0){H(true)}};U.sorting=function(e){var t=U.tableParams.isSortBy(e.field,"desc");if(t){U.argument._asc=e.field;U.argument._desc=""}else{U.argument._desc=e.field;U.argument._asc=""}var i=U.tableParams.isSortBy(e.field,"desc")?"asc":"desc";e.sortable?U.tableParams.sorting(e.field,i):"";U.defaultSorting=e.field==U.defaultSortParams.orderBy&&i==U.defaultSortParams.order;L={order:i,orderBy:e.field}};function J(){if(!U.viewInitialized){return}var e=!Y||JSON.stringify(U.argument)==JSON.stringify(U.argumentLast);if(!e){U.argumentLast=le.copy(U.argument)}U.tableParams.isTicketLoading=!e;U.tickets=C.getTickets(U.listName,U.argument._page,U.argument,null,e,function(e){U.tableParams.isTicketLoading=false;if(U.view){U.view.count=V.list.cachedTickets.get(U.listName).total();U.$emit("onloadTicektViews",U.view)}});U.setEvaluates();U.setStatusColors()}function z(e){if(le.isUndefined(e)){e=0}var t={},i=V.detail.ticket.views.gets(V.list.ticket.views.gets(1));for(var n in i){t[i[n].id]=i[n]}U.view=t[parseInt(e)];if(!U.view)return;U.argument._fields=U.view.fields;U.argument._filter=U.view.filter;U.argument._custom_field_filter=U.view.customFieldFilter?U.view.customFieldFilter:null;U.argument._page=V.list.cachedTickets.get(U.listName).page();if(!L){if("desc"==U.view.order){U.argument._desc=U.view.orderBy}else if("asc"==U.view.order){U.argument._asc=U.view.orderBy}if(U.view.orderBy){U.tableParams.$params.sorting={};U.tableParams.$params.sorting[U.view.orderBy]=U.view.order}}U.defaultSortParams={order:U.view.order,orderBy:U.view.orderBy};U.defaultSorting=L?L.orderBy==U.defaultSortParams.orderBy&&L.order==U.defaultSortParams.order:true;if(!U.viewInitialized){j();N();U.viewInitialized=true}if(U.view&&le.isString(U.view.customFields)&&le.isString(U.view.customFieldsLength)){U.customFieldsLength={};var s=le.fromJson(U.view.customFields);var a=U.view.customFieldsLength.split(",");if(le.isDefined(s)&&s.length==a.length){s.forEach(function(e,t){if(e){U.customFieldsLength[parseInt(e.id)]=parseInt(a[t])}})}}if(U.view&&le.isString(U.view.fields)&&le.isString(U.view.fieldsLength)){U.fieldsLength={};var r=U.view.fields.split(",");var o=U.view.fieldsLength.split(",");if(le.isString(U.view.groupBy)&&r.length!=o.length){for(var l=0;l<r.length;l++){if(r[l]==U.view.groupBy){r.splice(l,1);break}}}if(r.length==o.length){r.forEach(function(e,t){if(e&&e.length>0){U.fieldsLength[e]=parseInt(o[t])}})}}if(U.view&&le.isString(U.view.otherFields)&&le.isString(U.view.otherFieldsLength)){U.fieldsLength=U.fieldsLength||{};var c=U.view.otherFields.split(",");var u=U.view.otherFieldsLength.split(",");if(le.isDefined(c)&&c.length==u.length){c.forEach(function(e,t){if(e&&e.length>0&&u[t]){U.fieldsLength[e]=parseInt(u[t])}})}}}U.setRows=function(e){if(!U.tableParams)return;Y=true;var t=U.tableParams.count();if(e==t)return;U.tableParams.count(e);U.argument._count=e;U.tableParams.page(U.argument._page);U.tableParams.getData(U.tableParams)};var Y=false;function X(){U.tableParams=U.tableParams||new c({page:U.argument._page,count:U.argument._count,sorting:JSON.parse('{"'+U.view.orderBy+'":"'+U.view.order+'"}')},{counts:[],groupBy:function(e){if(U.argument.searchKey!=null||U.isAdvancedQuery||!U.view){return null}else{var t=U.view.groupBy;if(t==null||t==""){return null}var i=t.split(".");var n;var s=i.length;if(s==1){n=e[i[0]]}else if(s==2){if(e[i[0]]!=undefined){n=e[i[0]][i[1]]}}else if(s==3){if(e[i[0]]!=undefined&&e[i[0]][i[1]]!=undefined){n=e[i[0]][i[1]][i[2]]}}if(n==undefined){n="-"}var a="";if(t=="requester.name"){return"客户："+n}else if(t=="requester.userGroup.name"){return"客户组："+n}else if(t=="priority"){return"优先级："+n}else if(t=="status"){return"状态："+G("ticketStatusFilter")(n)}else if(t=="serviceDesk.name"){return"客服组："+G("translate")(n)}else if(t=="via.channel"){return"渠道："+n}else if(t=="engineer.user.name"){return"处理人："+n}else if(t=="ticketType.name"){return"类型："+n}else if(t=="evaluate.score"){return"满意度："+G("evaluateScoreFilter")(n)}else{return n}}},total:0,getData:function(e,t){U.argument._page=le.copy(t.page());V.list.cachedTickets.get(U.listName).page(le.copy(t.page()));J();t.total(V.list.cachedTickets.get(U.listName).total());e.resolve(U.tickets)}});if(L){U.tableParams.$params.sorting={};U.tableParams.$params.sorting[L.orderBy]=L.order}}function Z(e){var t="w100";do{if("subject"==e){t="w320";break}if("serviceDesk.name"==e||"via.name"==e){t="w200"}}while(0);return t}function ee(){s.register(E,s.constant.EVENT_LIST_CACHED_TICKETS_AVAILABLE,function(e,t){if(t.listName==U.listName&&t.page==U.argument._page){U.serverDataLoaded=true;if(["add","remove"].indexOf(t.type)>=0){U.getStatusColors()}else{U.getSolution();U.getServiceCatalogName();U.getStatusColors();U.getSubscriptions();U.getCustomFieldValue();U.getCopyto();U.getTags()}U.tableParams.reload();if(U.tickets&&U.tickets.length==0&&U.argument._page>1){U.$evalAsync(function(){void 0;var e=V.list.cachedTickets.get(U.listName).total();var t=Math.ceil(e/U.argument._count);U.argument._page=t;if(U.argument._page<1){U.argument._page=1}U.tableParams.page(U.argument._page);U.tableParams.getData(U.tableParams)})}}});s.register(E,s.constant.EVENT_LIST_TICKET_STATUSCOLORS,function(e){U.setStatusColors()});s.register(E,s.constant.EVENT_LIST_FIELD_TITLE,function(e){H()})}function te(){ee();X();z(e.id);if(U.view){H()}}te();function ie(){s.unRegister(E)}U.$on("loadTicketListView",function(){if(!U.viewInitialized){z(e.id);H()}});U.$on("$destroy",function(){ie();V.config.route.put(U.listName+"-search",{searchType:U.argument.searchType,advancedQueryCondition:U.advancedQueryCondition,searchKey:U.argument.searchKey,advancedQueryConditionByParam:P});if(L){V.config.route.put(U.listName+"-sort",L)}else{V.config.route.remove(U.listName+"-sort")}V.config.forceSave()});var ne=function(e,t){for(var i in e){if(e[i]==t){return i}return""}};U.clearSorting=function(){delete U.argument._asc;delete U.argument._desc;if(U.defaultSortParams.order&&U.defaultSortParams.orderBy){if(U.defaultSortParams.order=="asc"){U.argument._asc=U.defaultSortParams.orderBy}else{U.argument._desc=U.defaultSortParams.orderBy}}U.defaultSorting=true;L=null;U.argumentLast=null;U.tableParams.$params.sorting={};U.tableParams.$params.sorting[U.defaultSortParams.orderBy]=U.defaultSortParams.order;U.tableParams.reload()};U.advancedQuery=function(){U.advancedQueryError="";if(U.advancedQueryCondition.createdAtFrom==null&&U.advancedQueryCondition.createdAtTo==null&&U.advancedQueryCondition.updatedAtFrom==null&&U.advancedQueryCondition.updatedAtTo==null&&U.advancedQueryCondition.priority==null&&U.advancedQueryCondition.ticketType==null&&U.advancedQueryCondition.serviceCatalog==null&&(U.advancedQueryCondition.ccs==null||U.advancedQueryCondition.ccs.length==0)&&U.advancedQueryCondition.serviceDesk==null&&U.advancedQueryCondition.engineer==null&&U.advancedQueryCondition.via==null&&U.advancedQueryCondition.status==null&&U.advancedQueryCondition.requester==null&&U.advancedQueryCondition.user==null&&U.advancedQueryCondition.userGroup==null&&(U.advancedQueryCondition.tags==null||U.advancedQueryCondition.tags.length==0)){U.advancedQueryError="查询条件不能为空";return}U.isAdvancedQuery=true;P=le.copy(U.advancedQueryCondition);if(U.advancedQueryCondition.createdAtFrom!=null){U.advancedQueryCondition.createdAtFrom.setHours(0,0,0,0);P.createdAtFrom=G("date")(U.advancedQueryCondition.createdAtFrom,"yyyy-MM-dd HH:mm:ss")}if(U.advancedQueryCondition.createdAtTo!=null){U.advancedQueryCondition.createdAtTo.setHours(23,59,59,999);P.createdAtTo=G("date")(U.advancedQueryCondition.createdAtTo,"yyyy-MM-dd HH:mm:ss")}if(U.advancedQueryCondition.updatedAtFrom!=null){U.advancedQueryCondition.updatedAtFrom.setHours(0,0,0,0);P.updatedAtFrom=G("date")(U.advancedQueryCondition.updatedAtFrom,"yyyy-MM-dd HH:mm:ss")}if(U.advancedQueryCondition.updatedAtTo!=null){U.advancedQueryCondition.updatedAtTo.setHours(23,59,59,999);P.updatedAtTo=G("date")(U.advancedQueryCondition.updatedAtTo,"yyyy-MM-dd HH:mm:ss")}if(U.advancedQueryCondition.serviceDesk!=null){P.serviceDesk={id:U.advancedQueryCondition.serviceDesk.id}}if(U.advancedQueryCondition.engineer!=null){P.engineer={id:U.advancedQueryCondition.engineer.id}}if(U.advancedQueryCondition.user!=null){if(U.advancedQueryCondition.user.id==="${current_user_id}"){P.user={id:q.user.id}}else{P.user={id:U.advancedQueryCondition.user.id}}}if(U.advancedQueryCondition.userGroup!=null){delete P.userGroup;P.userGroupId=U.advancedQueryCondition.userGroup.id}if(U.advancedQueryCondition.requester!=null){delete P.requester;if(U.advancedQueryCondition.requester.id==="${current_user_id}"){P.requesterId=q.user.id}else{P.requesterId=U.advancedQueryCondition.requester.id}}if(U.advancedQueryCondition.serviceCatalog!=null){P.serviceCatalog={id:U.advancedQueryCondition.serviceCatalog.id}}if(U.advancedQueryCondition.via!=null){P.via={id:U.advancedQueryCondition.via.id,name:U.advancedQueryCondition.via.name,uid:U.advancedQueryCondition.via.uid}}if(U.advancedQueryCondition.ccs!=null&&U.advancedQueryCondition.ccs.length>0){P.ccs=[];le.forEach(U.advancedQueryCondition.ccs,function(e){if(e.type==="engineer"){P.ccs.push({id:e.id,serviceDeskId:e.groupId,name:e.name})}else{P.ccs.push({id:e.id,userGroupId:e.groupId,name:e.name})}})}if(U.advancedQueryCondition.tags!=null&&U.advancedQueryCondition.tags.length>0){delete P.tags;P.tagIds=U.advancedQueryCondition.tags.map(function(e){return e.id})}U.argument.searchType="advancedQuery";U.argument.advancedQueryCondition=P;U.argumentLast=null;if(U.argument._page!=1){U.tableParams.page(1)}else{U.tableParams.reload()}$("#queryModal").modal("hide")};U.clearSearch=function(){if(U.argument.searchKey!=null||U.isAdvancedQuery){U.argument.searchKey=null;U.oldSearchKey=null;U.isAdvancedQuery=false;U.argument.searchType=null;U.advancedQueryCondition={};P={};U.argument.advancedQueryCondition={};U.argumentLast=null;V.config.route.remove(U.listName+"-search");V.config.forceSave();if(U.argument._page!=1){U.tableParams.page(1)}else{U.tableParams.reload()}}};U.search=function(){if(U.argument.searchKey==""){U.clearSearch()}else{if(U.argument.searchKey!=U.oldSearchKey){U.oldSearchKey=U.argument.searchKey;U.argument.searchType="searchKeyQuery";U.argumentLast=null;if(U.argument._page!=1){U.tableParams.page(1)}else{U.tableParams.reload()}}}};U.$on("refreshTableData",function(){U.refresh=true;U.argumentLast=null;U.tableParams.reload()});var se=function(){U.argumentLast=null;U.tableParams.reload();U.checkboxes={checked:false,items:{}};U.$emit("refreshTicketViewCount")};U.ticketDetail=function(e){d.go("tickets_detail",{id:e})};U.$watch("checkboxes.checked",function(t){le.forEach(U.tickets,function(e){if(le.isDefined(e.id)){U.checkboxes.items[e.id]=t}})});U.$watch("checkboxes.items",function(e){U.selectedTicketIds=[];le.forEach(e,function(e,t){if(e){U.selectedTicketIds.push(t)}});if(undefined===U.tickets||U.tickets.length==0){return}else{var t=0,i=0,n=U.tickets.length;le.forEach(U.tickets,function(e){t+=U.checkboxes.items[e.id]||0;i+=!U.checkboxes.items[e.id]||0});if(i==0||t==0){U.checkboxes.checked=t==n}le.element(document.getElementById("select_all")).prop("indeterminate",t!=0&&i!=0)}},true);U.editList=function(){_hmt.push(["_trackEvent","工单管理","编辑列表"]);d.go("system_setting.ticket_list_custom_edit",{id:U.view.id,type:"update",isSystemDefault:U.view.isSystemDefault?1:0})};U.batchDeleteTicketList=function(){if(!v.hasPermission("ticket_delete")){k.add("您没有权限删除该工单！","danger");return}if(!U.selectedTicketIds){k.add("请选择需要删除的工单！","danger");return false}U._messages="回收站的工单被删除之后将不可恢复，是否要继续操作？";var t=y({scope:U,title:"批量删除",contentTemplate:"source/views/alter_common.html",html:true,show:true,placement:"center"});U.$hide=function(){t.$promise.then(t.hide)};U.$ok=function(){U.isLoading=true;n({url:"/api/v1/tickets/batch_destroy.json",method:"DELETE",params:{ids:U.selectedTicketIds.join(",")}}).success(function(e){if(e.status==0){U.isLoading=false;t.$promise.then(t.hide);se();k.add("删除成功","success")}else{U.isLoading=false;k.add("删除失败","danger")}})}};U.exportExcel=function(e){if(R.batchWorker){k.add("上一个批量任务尚未结束，请稍后再试","danger");return}R.$broadcast("batch-started",{total:U.tableParams.total(),batchType:"batch-ticket-export"});function l(e){R.batchWorker=undefined;R.$broadcast("batch-finished",{finished:0,total:U.tableParams.total(),reason:"error"})}F.load(["source/lib/xlsx/xlsx.full.min.js"]).then(function(){n({url:"/custom_field.json?scope=ticket&active=true",method:"GET"}).then(function(e){var t={};if(le.isArray(e.data.json)){var i=e.data.json;var n=[];for(var s=0,a=i.length;s<a;s++){var r=i[s];if(r.systemFieldKey=="priority"){t["systemFieldPriority"]=le.toJson(r)}else if(r.systemFieldKey=="service_catalog"){t["systemFieldServiceCatalog"]=le.toJson(r)}else if(r.systemFieldKey=="subject"){t["systemFieldSubject"]=le.toJson(r)}else if(r.systemFieldKey=="ticket_description"){t["systemFieldTicketdescription"]=le.toJson(r)}else if(r.systemFieldKey=="ticket_type"){var o=le.copy(r);o.customFieldOptions=le.fromJson(o.customFieldOptions);t["systemFieldTicketType"]=le.toJson(o)}else if(r.systemFieldKey=="tags"){t["systemFieldTags"]=le.toJson(r)}else{n.push(r)}}t["systemFieldPlanSolvedAt"]=le.toJson({scan_able:1,edit_able:1,type:"date_time",defaultLength:180,title:"要求完成时间",active:true,required:false,defaultValue:"",notes:"要求完成时间",systemFieldKey:"plan_solved_at"});t["ticketCustomFields"]=le.toJson(n)}U.exportFieldData=t;if(U.argument.advancedQueryCondition&&Object.keys(U.argument.advancedQueryCondition).length>0){re(U.argument.advancedQueryCondition).then(oe,l)}else{oe(U.argument.advancedQueryCondition||{})}},l)},l)};function ae(e,t){if(e&&e.length>0){for(var i=0;i<e.length;i++){var n=e[i];if(n.id&&t&&n.id==t){return n.name}for(var s=0;s<n.children_count;s++){var a=n.children[s];if(a.id&&t&&a.id==t){return n.name+"/"+a.name}for(var r=0;r<a.children_count;r++){var o=a.children[r];if(o.id&&t&&o.id==t){return n.name+"/"+a.name+"/"+o.name}for(var l=0;l<o.children_count;l++){var c=o.children[l];if(c.id&&t&&c.id==t){return n.name+"/"+a.name+"/"+o.name+"/"+c.name}for(var u=0;u<c.children_count;u++){var d=c.children[u];if(d.id&&t&&d.id==t){return n.name+"/"+a.name+"/"+o.name+"/"+c.name+"/"+d.name}}}}}}}return""}function re(t){var i=A.defer();var e={};if(t.engineer&&t.engineer.id){e.engineer=n.get("/api/v1/engineers/"+t.engineer.id+".json")}if(t.serviceDesk&&t.serviceDesk.id){e.serviceDesk=n.get("/api/service_desk/get/"+t.serviceDesk.id+".json?_token="+getCookie("user_token"))}if(t.serviceCatalog&&t.serviceCatalog.id){e.serviceCatalog=n.get("/api/v1/service_catalogs/list_include_children.json")}if(t.user&&t.user.id){e.user=n.get("/api/user/"+t.user.id+".json?_token="+getCookie("user_token"))}A.all(e).then(function(e){if(e.engineer&&e.engineer.data&&e.engineer.data.result){t.engineer=e.engineer.data.result;delete t.engineer.serviceDesks}if(e.serviceDesk&&e.serviceDesk.data&&e.serviceDesk.data.result){t.serviceDesk=e.serviceDesk.data.result;delete t.serviceDesk.engineers;delete t.serviceDesk.jointServiceDesks}if(e.serviceCatalog&&e.serviceCatalog.data&&e.serviceCatalog.data.result){t.serviceCatalog={id:t.serviceCatalog.id,name:ae(e.serviceCatalog.data.result.serviceCatalogs,t.serviceCatalog.id)}}if(e.user&&e.user.data&&e.user.data.result){t.user=e.user.data.result}i.resolve(t)},function(e){i.reject(e)});return i.promise}function oe(e){var t=U.exportFieldData;try{var n=R.batchWorker=new Worker("/source/scripts/ticket-batch-export.js");if(typeof U.view.sortFields==="string"){U.view.sortFields=JSON.parse(U.view.sortFields||null)}var i=JSON.parse(t["ticketCustomFields"]||null);i=_.reduce(i,function(e,t){e[t.id]=t;return e},{});var r=U.view.sortFields;if(!r||r.length===0){r=_.map(V.detail.fields.title.gets(V.list.fields.title.get(U.listName).gets(1)),function(e){return{id:e.id,type:e.systemFieldKey?"system":"custom"}})}r=_.filter(r,function(e){if(e.type==="custom"){return Object.prototype.hasOwnProperty.call(i,e.id)&&i[e.id].active}return true});if(!_.find(r,function(e){return e.id==="status"})){var s=_.find(r,function(e){return e.id==="subject"});if(s){var a=r.indexOf(s);r.splice(a+1,0,{id:"status",type:"system"})}else{r.push({id:"status",type:"system"})}}var o=_.find(r,function(e){return e.id==="id"});if(o){r.splice(r.indexOf(o),1)}var l=JSON.parse(U.view.customFields||null);var c=_.reduce(K,function(e,t){if(t.value==="ticketMetric.slaResponseTarget"||t.value==="ticketMetric.slaSolveTarget"){t.option+="(分钟)"}e[t.value]=t.option;return e},{});c=_.reduce(l,function(e,t){e[t.id]=t.title;return e},c);c["status"]="状态";c["subject"]="主题";c["serviceCatalog.id"]="服务目录";c["priority"]="优先级";c["ticketType.name"]="类型";c["tags"]="标签";var u=_.map(r,function(e){return e.id});var d=[];if(U.view.otherFields){d=U.view.otherFields.split(",")}var p=_.map(l,function(e){return e.id});var f=_.map(u,function(e){if(e==="subject"&&t["systemFieldSubject"]){try{return JSON.parse(t["systemFieldSubject"]).title}catch(e){return""}}if(e==="priority"&&t["systemFieldPriority"]){try{return JSON.parse(t["systemFieldPriority"]).title}catch(e){return""}}if(e==="serviceCatalog.id"&&t["systemFieldServiceCatalog"]){try{return JSON.parse(t["systemFieldServiceCatalog"]).title}catch(e){return""}}if(e==="ticketType.name"&&t["systemFieldTicketType"]){try{return JSON.parse(t["systemFieldTicketType"]).title}catch(e){return""}}if(Object.prototype.hasOwnProperty.call(c,e)){return c[e]}return e});var m={requester:"user",requesterUserGroup:"userGroup"};var g=function(e){if(Object.prototype.hasOwnProperty.call(m,e)){return m[e]}return e};var v=_.reduce(JSON.parse(JSON.parse(t["systemFieldPriority"]).customFieldOptions),function(e,t){e[t.value]=t.name;return e},{});var h=[];h.push({A:"查询条件"});h.push({A:"一般查询",B:U.argument.searchKey||""});h.push({A:"高级查询"});h.push({A:"创建于：",B:e.createdAtFrom||"",C:"至：",D:e.createdAtTo||""});h.push({A:"更新于：",B:e.updatedAtFrom||"",C:"至：",D:e.updatedAtTo||""});h.push({A:"状态",B:e.status?G("ticketStatusFilter")(e.status)||"":""});h.push({A:"创建人：",B:e.user?e.user.name||e.user.nickname:""});var y="";if(U.advancedQueryCondition.requester){if(U.advancedQueryCondition.requester.id==="${current_user_id}"){y=q.user.name}else{y=U.advancedQueryCondition.requester.name}}h.push({A:"客户：",B:y});var k="";if(U.advancedQueryCondition.userGroup){if(U.advancedQueryCondition.userGroup.id==="${current_user_id}"){k=q.user.name}else{k=U.advancedQueryCondition.userGroup.name}}h.push({A:"客户组：",B:k});var C="";if(e.engineer&&e.engineer.user){C=e.engineer.user.name||e.engineer.user.nickname}else if(e.serviceDesk&&e.serviceDesk.name){C=G("translate")(e.serviceDesk.name)}h.push({A:"处理人：",B:C||""});var b=_.map(e.ccs||[],function(e){return e.name}).join(",");h.push({A:"抄送给：",B:b});h.push({A:"服务目录：",B:e.serviceCatalog?e.serviceCatalog.name:""});var w=G("channelType")(e.viaType)||"";if(e.via&&e.via.name){w+=">"+e.via.name}h.push({A:"渠道：",B:w});var T="";if(e.tagIds&&e.tagIds.length>0){T=_.map(U.advancedQueryCondition.tags,function(e){return e.name}).join(",")}h.push({A:"标签：",B:T});var S="";if(e.priority){S=v[e.priority]||""}h.push({A:"类型：",B:e.ticketType?e.ticketType.name:"",C:"优先级：",D:S});h.push({A:""});var F=100;var A=U.tableParams.total();var E=XLSX.utils.json_to_sheet(h,{skipHeader:true});XLSX.utils.sheet_add_aoa(E,[f],{origin:{r:16,c:0}});var $=le.extend({},U.argument);delete $._count;delete $._page;if($._desc){delete $._desc}$._asc="id";var O=0;var I=17;var L=U.view.fields?U.view.fields.split(","):[];var D=U.view.fieldsLength?U.view.fieldsLength.split(","):[];var P=U.view.otherFields?U.view.otherFields.split(","):[];var x=U.view.otherFieldsLength?U.view.otherFieldsLength.split(","):[];E["!cols"]=_.map(r,function(e){if(U.customFieldsLength&&Object.prototype.hasOwnProperty.call(U.customFieldsLength,e.id)){return{wpx:U.customFieldsLength[e.id]}}else if(L.length>0&&D.length>0&&L.indexOf(e.id)>-1){return{wpx:parseInt(D[L.indexOf(e.id)])}}else if(P.length>0&&x.length>0&&P.indexOf(e.id)>-1){return{wpx:parseInt(x[P.indexOf(e.id)])}}else if(B.ticketFields&&Object.prototype.hasOwnProperty.call(B.ticketFields,e.id)){return{wpx:B.ticketFields[e.id]}}return{wpx:B.ticketDefault}});E["!merges"]=[{s:{c:0,r:0},e:{c:3,r:0}},{s:{c:1,r:1},e:{c:3,r:1}},{s:{c:1,r:2},e:{c:3,r:2}},{s:{c:1,r:5},e:{c:3,r:5}},{s:{c:1,r:6},e:{c:3,r:6}},{s:{c:1,r:7},e:{c:3,r:7}},{s:{c:1,r:8},e:{c:3,r:8}},{s:{c:1,r:9},e:{c:3,r:9}},{s:{c:1,r:10},e:{c:3,r:10}},{s:{c:1,r:11},e:{c:3,r:11}},{s:{c:1,r:12},e:{c:3,r:12}},{s:{c:1,r:13},e:{c:3,r:13}}];var N=function(e,t){var i=moment(e);if(i.isValid()){return i.format(t||"YYYY-MM-DD HH:mm:ss")}return e};var M=function(e,t,i,n,s){if(n==="serviceCatalog.id"){n="serviceCatalog.serviceCatalogNames"}if(n.indexOf(".")>-1){var a=n.split(".");var r=a[0];a.splice(0,1);if(typeof i[r]==="object"&&Object.prototype.hasOwnProperty.call(e,g(r)+"s")){i[r]=Object.assign(i[r],j(e[g(r)+"s"],r==="serviceCatalog"?i.id:i[r].id))}if(Object.prototype.hasOwnProperty.call(i,r)){return M(e,t,i[r],a.join("."),s)}return""}if(i&&Object.prototype.hasOwnProperty.call(i,n)){if(n==="solutionId"){var o=j(e.solutions,i[n]);return o?o.solution:""}if(n==="status"){if(i.deleted){i.status="deleted"}return G("ticketStatusFilter")(i[n])}if(s==="serviceDesk.name"||s==="role.name"||s==="defaultServiceDesk.name"||s==="user.role.name"){return G("translate")(i[n])}if(s==="createdAt"||s==="updatedAt"||s==="deletedAt"||s==="lastLoginAt"||s==="ticketMetric.pausedAt"||s==="ticketMetric.responseAt"){return N(i[n])}if(s==="ticketMetric.solvedAt"){if(t.status==="solved"||t.status==="closed"){return N(i[n])}else{return""}}if(s==="ticketMetric.responseMinutes"||s==="ticketMetric.solveMinutes"){if(n==="solveMinutes"&&t.status!="solved"&&t.status!="closed"){return""}return i[n]}if(s==="deleteReason"){return G("nullStringFilter")(i[n])}return i[n]}return""};var j=function(e,t){for(var i=0;i<e.length;i++){if(e[i].id===t){return e[i]}}return};n.onmessage=function(a){if(!a.data||!a.data.type)return;switch(a.data.type){case"ready":{n.postMessage({type:"batch-getdata",pageSize:F,total:A,customFields:p,evaluationConfig:V.config.evaluate,otherFields:d,priorityMap:v,credential:{provider_id:q.provider.id,_token:getCookie("user_token")},params:$});break}case"started":{break}case"progress":{var t=[];a.data.data.data.tickets.forEach(function(n){var e=_.find(a.data.data.data.ticketMetrics,function(e){return e.id===n.ticketMetric.id});if(e){if(e.planResponseAt){if(e.responseAt){e.slaResponseTarget=parseInt(-moment(e.responseAt).diff(moment(e.planResponseAt))/1e3/60)}else{e.slaResponseTarget=parseInt(-moment().diff(moment(e.planResponseAt))/1e3/60)}}if(e.planSolvedAt){if(e.solvedAt){e.slaSolveTarget=parseInt(-moment(e.solvedAt).diff(moment(e.planSolvedAt))/1e3/60)}else{e.slaSolveTarget=parseInt(-moment().diff(moment(e.planSolvedAt))/1e3/60)}}}var s=[];r.forEach(function(e){if(e.type==="custom"){var t=a.data.data.data.customFieldValues[n.id][e.id];var i;if(t.value&&t.type==="date_time"){t.value=N(t.value)}if(t.value&&t.type==="date"){t.value=N(t.value,"YYYY-MM-DD")}s.push(t.value)}else{s.push(M(a.data.data.data,n,n,e.id,e.id))}});t.push(s)});XLSX.utils.sheet_add_aoa(E,t,{origin:{r:I,c:0}});I+=a.data.data.data.tickets.length;O+=a.data.data.data.tickets.length;R.$broadcast("batch-progress",{finished:O,total:a.data.data.data._total});break}case"finished":{n.terminate();delete R.batchWorker;R.$broadcast("batch-finished",{finished:O,total:A,reason:a.data.data.reason});var e=XLSX.utils.book_new();var i=(U.view.displayTitle||U.view.title||"").replace(/[\\\/\?\*\[\]\'\:\<\>\|\"]/g,"_")+moment().format("YYYYMMDDHHmm");XLSX.utils.book_append_sheet(e,E);XLSX.writeFile(e,i+".xlsx");break}}}}catch(e){R.batchWorker=undefined;R.$broadcast("batch-finished",{finished:O,total:U.tableParams.total(),reason:"error"})}}U.open=function(e,t){e.preventDefault();e.stopPropagation();U.datepickers[t]=true};U.clearCheckBoxs=function(){U.checkboxes={checked:false,items:{}}};U.viewTicketList=function(){if(!U.tickets.length>0){return false}d.go("tickets_detail",{id:U.tickets[0].id,viewId:U.view.id,page:U.argument._page})};U.mergeTickets=function(){if(!U.selectedTicketIds.length){return false}U.mergerUnit={list:[]};U.mergerUnit.submiting=false;U.mergerUnit.openMenu=false;U.mergerUnit.showSearch=true;U.mergerUnit.selectedTicket=null;U.mergerUnit.lastText=U.mergerUnit.curText="";U.mergerUnit.list=le.copy(T.getTickets());U.mergerUnit.list.forEach(function(e,t){if(e.status==="suspended"||e.deleted){U.mergerUnit.list.splice(t,1)}});var e=y({scope:U,title:"工单合并",contentTemplate:"source/views/ticket/confirm_merger_template.html",html:true,show:true,placement:"center"});U.mergerUnit.search=function(){if(U.mergerUnit.curText.trim()==="")return;ce.sdk.OpenTicketApi().listTicketBySubjectOrNo({key:U.mergerUnit.curText||"",page:{pageSize:10}}).then(function(e){U.mergerUnit.list=e.list;U.mergerUnit.showSearch=false;U.mergerUnit.openMenu=true})};U.mergerUnit.clear=function(){U.mergerUnit.selectedTicket=null;U.mergerUnit.openMenu=true;U.mergerUnit.showSearch=true;U.mergerUnit.lastText=U.mergerUnit.curText=""};U.mergerUnit.select=function(e){U.mergerUnit.selectedTicket=e;U.mergerUnit.lastText=U.mergerUnit.curText="#"+e.no+"  "+e.subject;U.mergerUnit.openMenu=false;U.mergerUnit.showSearch=false};U.mergerUnit.focus=function(){if(U.mergerUnit.curText===""){U.mergerUnit.openMenu=true}};U.mergerUnit.change=function(){if(U.mergerUnit.lastText!==U.mergerUnit.curText){U.mergerUnit.showSearch=true;U.mergerUnit.selectedTicket=null;U.mergerUnit.openMenu=U.mergerUnit.curText===""}};U.mergerUnit.keyup=function(e){var t=window.event?e.keyCode:e.which;if(t===13){U.mergerUnit.search()}};U.hideModal=function(){e.$promise.then(e.hide)};U.$ok=function(t){var i=[];U.selectedTicketIds.forEach(function(e){if(t.id!==parseInt(e))i.push(parseInt(e))});if(i.length>0){U.mergerUnit.submiting=true;ce.sdk.OpenTicketApi().merge({ids:i,targetId:parseInt(t.id)}).then({success:function(e){U.mergerUnit.submiting=false;U.hideModal();se();k.add("工单已合并到#"+t.no,"success")},fail:function(e){U.mergerUnit.submiting=false;k.add(e.error_description,"danger")}})}else{k.add("没有要合并的工单(合并工单不能为自已)","danger")}}};U.isolation=function(){if(!v.hasPermission("ticket_suspended_manage")){k.add("您没有权限移除该工单！","danger");return}if(!U.selectedTicketIds.length){return false}n({url:"/api/v1/tickets/remove_from_suspended.json",method:"GET",params:{ids:U.selectedTicketIds.join(",")}}).success(function(e,t,i,n){if(e.status==0){se()}else{if(e.result&&e.result.error){var s=y({scope:U,title:"提示",contentTemplate:"source/views/quantity_limitation.html",html:true,show:true,placement:"center"});U.limit={};U.limit.hasPermission=true;U.goUpgrade=function(){if(v.hasPermission("system_setting_company_account")){d.go("system_setting.detail.provider",{uri:"company_account",settingType:"system"});s.$promise.then(s.hide)}else{U.limit.hasPermission=false}};U.hideLimitModal=function(){s.$promise.then(s.hide)}}else{k.add("删除失败","danger")}}})};U.deleteTickets=function(){if(!v.hasPermission("ticket_delete")){k.add("您没有权限删除该工单！","danger");return}if(!U.selectedTicketIds.length){return false}var s=y({scope:U,title:"请选择删除工单的理由",template:"modal/modal.tpl.w380.html",contentTemplate:"source/views/ticket/confirm_delete_template.html",html:true,show:true,placement:"center"});U.$ok=function(e){if(!e||!e.length||e==""){U.refuseErrorMessage="请选择删除工单理由";return}U.deleting=true;n({url:"/api/v1/tickets/batch_delete.json",data:{ids:U.selectedTicketIds.join(","),deleteReason:e},method:"POST"}).success(function(e,t,i,n){U.deleting=false;s.$promise.then(s.hide);if(e.status==0){se()}else{k.add("删除失败","danger")}})}};U.ticketDetailBuried=function(){_hmt.push(["_trackPageview","/工单操作/子级页面/工单详情页"]);_hmt.push(["_setCustomVar",R.vertionNumber,"名称","工单管理-工单列表",1]);_hmt.push(["_trackEvent","工单管理","点击工单列表"])}}})(angular,org.ewei);(function(P){P.module("eweiApp.chat",[]).config(e).controller("chatQueueController",t).controller("waitChatQueueController",i).controller("endChatQueueController",n).controller("untreatedChatQueueController",s).controller("viewListByChatController",a);e.$inject=["$stateProvider"];function e(e){e.state("chat_list",{url:"/chat",templateUrl:"source/views/chat_list/chat_list.html",controller:a}).state("chat_list.waitChatQueue",{url:"/waitChatQueue",templateUrl:"source/views/chat_list/waitChatQueue.html",controller:i}).state("chat_list.chatQueue",{url:"/chatQueue",templateUrl:"source/views/chat_list/chatQueue.html",controller:t}).state("chat_list.endChatQueue",{url:"/endChatQueue",templateUrl:"source/views/chat_list/endChatQueue.html",controller:n}).state("chat_list.untreatedChatQueue",{url:"/untreatedChatQueue",templateUrl:"source/views/chat_list/untreatedChatQueue.html",controller:s})}t.$inject=["$scope","NgTableParams","chatQueueSetUp","chatQueueSetUpDefault","chatQueueService","chatColunmSetUpId","$state","alertService","ConsoleConfig","permissions","forceJoinChatService","coreNotifyService","coreModelService","closeChatService"];function t(i,e,n,s,t,a,r,o,l,c,u,d,p,f){i.chat={};i.chatHeader=s;i.chatList=[];i.showSetUp=false;i.params={_total:0,_page:10,_currentPage:""};var m="";var g=this.__proto__.constructor.name+"_"+(new Date).valueOf();i.params={_page:0,_currentPage:0,_desc:"response_at"};var v=P.copy(i.params);i.setRows=function(e){h=true;var t=i.tableParams.count();if(e==t)return;i.tableParams.count(e);i.params._page=e;i.tableParams.getData(i.tableParams)};var h=false;function y(){i.tableParams=i.tableParams||new e({page:1,count:i.params._page,sorting:{response_at:"desc"}},{total:0,counts:[],getData:function(e,t){i.params._currentPage=P.copy(t.page());k(i.params._currentPage);t.total(p.list.chats.chatting.total());if(!h)return;if(v._currentPage!=i.params._currentPage||v._page!=i.params._page||v._asc!=i.params._asc||v._desc!=i.params._desc){_(i.params._currentPage);v=P.copy(i.params)}e.resolve(i.chatList)}})}i.searchChatList=function(){_(1)};i.clearSearch=function(){i.searchKey="";_(1)};i.hoverFun=function(e){i.hoverEffect=e};function _(e){i.tableParams.isLoading=true;i.tableParams.page(e);i._currentPage=e;t({pageNo:e,pageSize:i.params._page,searchKey:i.searchKey,_asc:i.params._asc,_desc:i.params._desc},"",d.constant.EVENT_LIST_CHAT_CHATTING,function(e){i.tableParams.isLoading=false})}i.sorting=function(e){var t=i.tableParams.isSortBy(e.field,"desc");if(t){i.params._asc=e.field==="responseAt"?"response_at":e.field;i.params._desc=""}else{i.params._desc=e.field==="responseAt"?"response_at":e.field;i.params._asc=""}e.sortable?i.tableParams.sorting(e.field,i.tableParams.isSortBy(e.field,"desc")?"asc":"desc"):""};function k(e){i.chatList=p.detail.chats.chatting.gets(p.list.chats.chatting.gets(e))}function C(){d.register(g,d.constant.EVENT_LIST_CHAT_CHATTING,function(e,t){if(t){_(i.params._currentPage)}else{i.tableParams.reload();d.doNotify(d.constant.EVENT_CHAT_LIST_COUNT,true)}});d.register(g,d.constant.EVENT_LIST_CHAT_REFRESH,function(e,t){if(t=="chatQueue"){i.tableParams.page(1);_(1)}})}function b(){d.unRegister(g)}i.$on("$destroy",function(){b()});function w(){y();C();T();i.placeholderVal="主题、客户、客服、客服组、ID"}w();function T(){n.getChatOption(function(e){i.chatHeader=P.copy(s);m=P.copy(s)})}i.chat.selectColumn=function(e){if(i.chatHeader[e].active){i.chatHeader[e].active=false}else{i.chatHeader[e].active=true}};i.chat.setUp=function(){i.showSetUp=true};i.chat.sureSetUp=function(){var e="";for(var t=0;t<i.chatHeader.length;t++){if(typeof i.chatHeader[t].active!="undefined"&&i.chatHeader[t].active){e+=i.chatHeader[t].field+","}}void 0;e=e.substring(0,e.length-1);n.saveChatOption(e,function(e){if(e.status==0){i.showSetUp=false;a.setChatID(e.result.id);m=P.copy(s);T()}else{o.add("保存失败","danger")}})};i.chat.cancelSetUp=function(){i.showSetUp=false;T()};i._gotoChatCenter=function(t,e,i){var n;if(i.clientType=="USB_PHONE"){o.add("语音会话暂不支持加入","danger");return false}if(e){n=e.id}if(n==l.engineer.id){r.go("webchats_new.detail",{id:t},{reload:"webchats_new.detail"})}else if(c.hasPermission("ticket_force_join_chat")){u(t).then(function(e){if(e.success){r.go("webchats_new.detail",{id:t},{reload:"webchats_new.detail"})}else{if(e.message!=null){o.add($filter("translate")(e.message),"danger")}else{o.add("失败","danger")}}})}else{o.add("对不起，您没有权限加入此会话","danger")}}}i.$inject=["$scope","NgTableParams","waitChatQueueSetUpDefault","waitChatQueueService","waitChatQueueSetUp","license","chatColunmSetUpId","alertService","$rootScope","waitChatHandleService","$http","permissions","$modal_","$filter","getCustomerServiceList","ConsoleConfig","$window","coreNotifyService","coreModelService","$state","providerJudgement"];function i(r,e,i,t,n,s,a,o,l,c,u,d,p,f,m,g,v,h,y,_,k){r.waitChat={};r.waitChatHeader=i;r.waitChatList=[];r.licenseService=s;var C=this.__proto__.constructor.name+"_"+(new Date).valueOf();var b="";function w(){n.getWaitChatOption(function(e){r.waitChatHeader=P.copy(i);b=P.copy(i)})}r.params={_page:0,_currentPage:0};void 0;r.serviceProvider=g.providerHelpCenterUrl;var T=P.copy(r.params);r.setRows=function(e){S=true;var t=r.tableParams.count();if(e==t)return;r.tableParams.count(e);r.params._page=e;r.tableParams.getData(r.tableParams)};var S=false;function F(){r.tableParams=r.tableParams||new e({page:1,count:r.params._page},{total:0,counts:[],getData:function(e,t){r.params._currentPage=P.copy(t.page());t.total(y.list.chats.waitting.total());E(r.params._currentPage);if(!S)return;if(T._currentPage!=r.params._currentPage||T._page!=r.params._page){A(r.params._currentPage);T=P.copy(r.params)}e.resolve(r.waitChatList)}})}r.searchChatList=function(){A(1)};r.clearSearch=function(){r.searchKey="";A(1)};r.hoverFun=function(e){r.hoverEffect=e};function A(e){r.tableParams.isLoading=true;r.tableParams.page(e);r._currentPage=e;t({pageNo:e,pageSize:r.params._page,searchKey:r.searchKey},"",h.constant.EVENT_LIST_CHAT_WAITTING,function(e){r.tableParams.isLoading=false})}function E(e){r.waitChatList=y.detail.chats.waitting.gets(y.list.chats.waitting.gets(e))}function $(){h.register(C,h.constant.EVENT_LIST_CHAT_WAITTING,function(e,t){if(t){A(r.params._currentPage)}else{r.tableParams.reload();h.doNotify(h.constant.EVENT_CHAT_LIST_COUNT,true)}});h.register(C,h.constant.EVENT_LIST_CHAT_REFRESH,function(e,t){if(t=="waitChatQueue"){r.tableParams.page(1);A(1)}})}function O(){h.unRegister(C)}r.$on("$destroy",function(){O()});function I(){F();$();w();r.placeholderVal="主题、客户、客服、客服组、ID"}I();r.showSetUp=false;r.waitChat.selectColumn=function(e){if(r.waitChatHeader[e].active){r.waitChatHeader[e].active=false}else{r.waitChatHeader[e].active=true}};r.waitChat.setUp=function(){r.showSetUp=true};r.waitChat.sureSetUp=function(){var e="";for(var t=0;t<r.waitChatHeader.length;t++){if(typeof r.waitChatHeader[t].active!="undefined"&&r.waitChatHeader[t].active){e+=r.waitChatHeader[t].field+","}}e=e.substring(0,e.length-1);void 0;n.saveWaitChatOption(e,function(e){if(e.status==0){r.showSetUp=false;a.setWaitChatID(e.result.id);b=P.copy(i);w()}else{o.add("保存失败","danger")}})};r.waitChat.cancelSetUp=function(){r.showSetUp=false;w()};r.myselfHandleWaitingSession=function(t){if(!k.isTrue()){return false}var e=r;var i;r.disabledVal=false;r.hideMyselfHandleModal=function(){i.$promise.then(i.hide)};e._messages="您确定要接通该会话，自己处理吗？";i=p({scope:e,title:"接通确认",contentTemplate:"source/views/alter_common.html",html:true,show:true,placement:"center"});e.$ok=function(){if(!k.isTrue()){return false}c.myselfHandleWaitingSession(t).then(function(e){if(e.success){h.doNotify(h.constant.EVENT_LIST_CHAT_WAITTING,true);h.doNotify(h.constant.EVENT_LIST_CHAT_CHATTING,true);_.go("webchats_new.detail",{id:t},{reload:"webchats_new.detail"})}else if(e.message!=null){if(e.message=="license_limit"){o.add("很抱歉，你今日的工单数量已经达到上限，暂时无法接通会话。","danger")}else{o.add(f("translate")(e.message),"danger");h.doNotify(h.constant.EVENT_LIST_CHAT_WAITTING,true)}}else{o.add("失败","danger")}});r.hideMyselfHandleModal()}};r.selectEngineerHandleWaitingSession=function(e){if(!d.hasPermission("ticket_chat_assign")){o.add("您没有权限分派会话","danger");return false}if(!k.isTrue()){return false}var t=r;var i;var a="";r.setwaitingEngineer=function(e){if(e){i=e.userId}};r.sendChatRequest=function(){r.disabledVal=true;if(typeof i=="undefined"){o.add("请选择一个客服分派","danger");r.disabledVal=false;return false}c.sendChatRequest(e,i).then(function(e){if(e.success){h.doNotify(h.constant.EVENT_LIST_CHAT_WAITTING,true);o.add(f("translate")("ASSIGN_WAITINGCHAT_SUCC"))}else if(e.message=="license_limit"){o.add("很抱歉，你今日的工单数量已经达到上限，暂时无法接通会话。","danger")}else{o.add(f("translate")(e.message),"danger");h.doNotify(h.constant.EVENT_LIST_CHAT_WAITTING,true)}r.disabledVal=false});r.hideSelectEngineerModal()};var n=function(e){var t=new Array;function i(e,t){for(var i=0,n=e.length;i<n;i++){if(e[i].id==t){return true}}return false}for(var n=0,s=e.length;n<s;n++){var a=e[n];if(!i(t,a.servicedeskId)){var r={id:a.servicedeskId,name:a.servicedeskName,engineers:[]};t.push(r)}}for(var n=0,s=t.length;n<s;n++){for(var o=0,l=e.length;o<l;o++){var a=e[o];if(a.webSessionId==undefined||a.webSessionId==""){continue}if(t[n].id==a.servicedeskId){var c={id:a.engineerId,name:a.userName,userId:a.userId,chatCount:a.chatCount,concurrentChatNumber:a.concurrentChatNumber};t[n].engineers.push(c)}}}return t};var s;r.hideSelectEngineerModal=function(){s.$promise.then(s.hide)};s=p({scope:t,title:"选择客服人员",contentTemplate:"source/dashboard/select__engineers_single.html",html:true,show:true,placement:"top"});r.loadtime=0;r.loadEngineers=function(){var e=(new Date).getTime();if(r.loadtime!=0&&e-r.loadtime<1500){return}r.loadtime=e;r.onlineCount=0;m().then(function(e){r.selectServiceDesks=n(e.json);a=r.selectServiceDesks})};r.loadEngineers();r.searchCustomer=function(){void 0;var e=new RegExp(transferConversation.searchCustomerCond.value);var t=a;var i=[];if(transferConversation.searchCustomerCond.value==""){r.selectServiceDesks=a}else{for(var n in t){i[n]=[];i[n].engineers=[];for(var s in t[n].engineers){if(e.test(t[n].engineers[s].name)){i[n].id=t[n].id;i[n].name=t[n].name;i[n].engineers.push(t[n].engineers[s])}}}r.selectServiceDesks=i}}};r.downloadApplication=function(){if(g.enviroment=="Production"){v.open("http://ewei-app-saas.ewei.com/Helpdesk.exe")}else if(g.enviroment=="Test"){v.open("http://apptest.cdn.ewei.com/Helpdesk.exe")}else{v.open("http://apptest.cdn.ewei.com/Helpdesk.exe")}};r.permissionValue=d.hasPermission("ticket_setting_via");r.providerLicense=l.providerLicense&&l.providerLicense.type?l.providerLicense.type:""}n.$inject=["$scope","NgTableParams","endChatQueueSetUpDefault","endChatQueueService","ConsoleConfig","coreNotifyService","coreModelService","apiTicketEvaluateConfigService","apiTicketStatusColorService","$modal_","apiRestfulService","$state","permissions"];function n(n,e,t,i,s,a,r,o,l,c,u,d,p){n.endChat={};n.endChatHeader=t;n.endChatList=[];n.checkboxes={checked:false,items:{}};n.isCanDeleteChat=false;var f=[];var m=this.__proto__.constructor.name+"_"+(new Date).valueOf();n.params={_page:0,_currentPage:0,_asc:"",_desc:"created_at"};var g=P.copy(n.params);n.setRows=function(e){v=true;var t=n.tableParams.count();if(e==t)return;n.tableParams.count(e);n.params._page=e;n.tableParams.getData(n.tableParams)};var v=false;function h(){n.tableParams=n.tableParams||new e({page:1,count:n.params._page,sorting:{created_at:"desc"}},{total:0,counts:[],getData:function(e,t){n.params._currentPage=P.copy(t.page());_(n.params._currentPage);t.total(r.list.chats.closed.total());if(!v)return;if(g._currentPage!=n.params._currentPage||g._page!=n.params._page||g._asc!=n.params._asc||g._desc!=n.params._desc){y(n.params._currentPage);g=P.copy(n.params)}e.resolve(n.endChatList)}})}n.sorting=function(e){var t=n.tableParams.isSortBy(e.field,"desc");if(t){n.params._asc=e.field;n.params._desc=""}else{n.params._desc=e.field;n.params._asc=""}e.sortable?n.tableParams.sorting(e.field,n.tableParams.isSortBy(e.field,"desc")?"asc":"desc"):""};n.searchChatList=function(){y(1)};n.clearSearch=function(){n.searchKey="";y(1)};n.selectAllCheckbox=function(){if(n.checkboxes.checked&&p.hasPermission("chat_delete")){n.isCanDeleteChat=true}else{n.isCanDeleteChat=false}P.forEach(n.endChatList,function(e){if(P.isDefined(e.id)){n.checkboxes.items[e.id]=n.checkboxes.checked}})};n.selectSingleCheckbox=function(e){var t=0;P.forEach(n.endChatList,function(e){if(P.isDefined(e.id)&&n.checkboxes.items[e.id]){t++}});if(t>0&&p.hasPermission("chat_delete")){n.isCanDeleteChat=true}else{n.isCanDeleteChat=false}if(n.endChatList.length===t){n.checkboxes.checked=true}else{n.checkboxes.checked=false}};n.deleteChat=function(){var i=c({scope:n,title:"删除会话",contentTemplate:"source/views/chat_list/deleteChat.html",html:true,show:true,placement:"center"});n.modalTip="确认删除选择的会话内容及附件？";n.$ok=function(){var t=[];P.forEach(n.endChatList,function(e){if(P.isDefined(e.id)&&n.checkboxes.items[e.id]){t.push(e.id)}});var e={url:"/api/v1/chats/delete.json",urlParam:"",dataParam:t};u.run(e).post(e.dataParam,function(e){if(e&&e.status==0){i.$promise.then(i.hide);d.reload()}})}};function y(t){n.tableParams.isLoading=true;n.tableParams.page(t);n._currentPage=t;i({pageNo:t,pageSize:n.params._page,searchKey:n.searchKey,_asc:n.params._asc,_desc:n.params._desc},"",a.constant.EVENT_LIST_CHAT_ClOSED,function(e){n.tableParams.isLoading=false;f=k(r.detail.chats.closed.gets(r.list.chats.closed.gets(t)))})}function _(e){n.endChatList=r.detail.chats.closed.gets(r.list.chats.closed.gets(e));if(n.endChatList.length>0){}}function k(e){var t=[];P.forEach(e,function(e){if(P.isDefined(e.ticket_id)){t.push(e.ticket_id)}});return t}function C(){a.register(m,a.constant.EVENT_LIST_CHAT_ClOSED,function(e,t){n.tableParams.reload()});a.register(m,a.constant.EVENT_LIST_CHAT_REFRESH,function(e,t){if(t=="endChatQueue"){n.tableParams.page(1);y(1)}})}function b(){a.unRegister(m)}n.$on("$destroy",function(){b()});function w(){h();o.run();C();n.placeholderVal="主题、客户、客服、客服组、ID"}w()}s.$inject=["$scope","NgTableParams","untreatedChatQueueSetUpDefault","untreatedChatQueueService","untreatedChatQueueSetUp","license","chatColunmSetUpId","alertService","$rootScope","waitChatHandleService","$http","permissions","$modal_","$filter","getCustomerServiceList","ConsoleConfig","$window","coreNotifyService","coreModelService","$state","providerJudgement","filterFilter","apiRestfulService","permissions"];function s(n,e,i,t,s,a,r,o,l,c,u,d,p,f,m,g,v,h,y,_,k,C,b,d){n.untreatedChat={};n.untreatedChatHeader=i;n.untreatedChatList=[];n.hasDeletePermission=false;var w=this.__proto__.constructor.name+"_"+(new Date).valueOf();var T="";function S(){s.getUntreatedChatOption(function(e){n.untreatedChatHeader=P.copy(i);T=P.copy(i)})}n.params={_page:0,_currentPage:0};void 0;n.serviceProvider=g.providerHelpCenterUrl;var F=P.copy(n.params);n.setRows=function(e){A=true;var t=n.tableParams.count();if(e==t)return;n.tableParams.count(e);n.params._page=e;n.tableParams.getData(n.tableParams)};var A=false;function E(){n.tableParams=n.tableParams||new e({page:1,count:n.params._page},{total:0,counts:[],getData:function(e,t){n.params._currentPage=P.copy(t.page());t.total(y.list.chats.untreated.total());O(n.params._currentPage);if(!A)return;if(F._currentPage!=n.params._currentPage||F._page!=n.params._page){$(n.params._currentPage);F=P.copy(n.params)}e.resolve(n.untreatedChatList)}})}n.clearSelected=function(){n.untreatedChat.checked=false;n.setMutipleEngineer(true)};n.selectedId=[];n.setMutipleEngineer=function(e){if(e){if(n.untreatedChat.checked){n.untreatedChatList.forEach(function(e){e.checked=n.untreatedChat.checked;n.selectedId.push(e.id)})}else{n.untreatedChatList.forEach(function(e){e.checked=n.untreatedChat.checked});n.selectedId=[]}return false}else{if(this.item.checked){n.selectedId.push(this.item.id)}else{n.selectedId.remove(this.item.id)}}void 0;var t=C(n.untreatedChatList,{checked:true});if(t.length&&t.length===n.untreatedChatList.length){n.untreatedChat.checked=true}else{n.untreatedChat.checked=false}};n.deleteChat=function(){n.selectedId=[this.item.id];void 0};n.deleteChats=function(t){var i=p({scope:n,title:"删除会话",contentTemplate:"source/views/chat_list/deleteChat.html",html:true,show:true,placement:"center"});n.modalTip="确认删除选择的会话内容？";n.$ok=function(){var e={url:"/api/v1/chats/delete.json",urlParam:"",dataParam:t||n.selectedId};b.run(e).post(e.dataParam,function(e){if(e&&e.status==0){i.$promise.then(i.hide);_.reload();n.selectedId=[]}})}};n.chatToTicket=function(e){var t=p({scope:n,title:"生成工单",contentTemplate:"source/views/chat_list/deleteChat.html",html:true,show:true,placement:"center"});n.modalTip="确定要将该条漏接的会话请求生成工单？";var i={url:"api/v1/chat_to_ticket/"+e.id+".json",urlParam:"",dataParam:{subject:e.firstMessage||e.user.name+"的会话"}};n.$ok=function(){n.disabled=true;b.run(i).put(i.dataParam,function(e){if(e.status==0){t.$promise.then(t.hide);n.disabled=false;_.go("tickets_detail",{id:e.result.ticketId})}})}};n.searchChatList=function(){$(1)};n.clearSearch=function(){n.searchKey="";$(1)};n.hoverFun=function(e){n.hoverEffect=e};function $(e){n.tableParams.isLoading=true;n.tableParams.page(e);n._currentPage=e;t({pageNo:e,pageSize:n.params._page,searchKey:n.searchKey},"",h.constant.EVENT_LIST_CHAT_UNTREATED,function(e){n.tableParams.isLoading=false})}function O(e){n.untreatedChatList=y.detail.chats.untreated.gets(y.list.chats.untreated.gets(e))}function I(){h.register(w,h.constant.EVENT_LIST_CHAT_UNTREATED,function(e,t){if(t){$(n.params._currentPage)}else{n.tableParams.reload();h.doNotify(h.constant.EVENT_CHAT_LIST_COUNT,true)}});h.register(w,h.constant.EVENT_LIST_CHAT_REFRESH,function(e,t){if(t=="untreatedChatQueue"){n.tableParams.page(1);$(1)}})}function L(){h.unRegister(w)}n.$on("$destroy",function(){L()});function D(){E();I();S();n.placeholderVal="主题、客户、客服组、ID";if(d.hasPermission("chat_delete")){n.hasDeletePermission=true}}D();n.showSetUp=false;n.untreatedChat.selectColumn=function(e){if(n.untreatedChatHeader[e].active){n.untreatedChatHeader[e].active=false}else{n.untreatedChatHeader[e].active=true}};n.untreatedChat.setUp=function(){n.showSetUp=true};n.untreatedChat.sureSetUp=function(){var e="";for(var t=0;t<n.untreatedChatHeader.length;t++){if(typeof n.untreatedChatHeader[t].active!="undefined"&&n.untreatedChatHeader[t].active){e+=n.untreatedChatHeader[t].field+","}}e=e.substring(0,e.length-1);void 0;s.saveUntreatedChatOption(e,function(e){if(e.status==0){n.showSetUp=false;r.setUntreatedChatID(e.result.id);T=P.copy(i);S()}else{o.add("保存失败","danger")}})};n.untreatedChat.cancelSetUp=function(){n.showSetUp=false;S()}}a.$inject=["$scope","$state","chatTypeTotalService","coreModelService","coreNotifyService","ConsoleConfig","$location"];function a(e,t,i,n,s,a,r){var o=this.__proto__.constructor.name+"_"+(new Date).valueOf();void 0;var l=0;e.refreshChatList=function(){l+=360;e.rotateObj={transform:"rotate("+l+"deg)"};e.total_closed=0;e.total_ongoing=0;e.total_waiting=0;e.total_untreated=0;if(r.absUrl().indexOf("/chat/waitChatQueue")>-1){s.doNotify(s.constant.EVENT_LIST_CHAT_REFRESH,"waitChatQueue")}else if(r.absUrl().indexOf("/chat/chatQueue")>-1){s.doNotify(s.constant.EVENT_LIST_CHAT_REFRESH,"chatQueue")}else if(r.absUrl().indexOf("/chat/endChatQueue")>-1){s.doNotify(s.constant.EVENT_LIST_CHAT_REFRESH,"endChatQueue");c()}else if(r.absUrl().indexOf("/chat/untreatedChatQueue")>-1){s.doNotify(s.constant.EVENT_LIST_CHAT_REFRESH,"untreatedChatQueue")}};e.chat={};e.chat.chatViewMenus={VIEW_TITLE_WAIT_CHAT_QUEUE:"等待中的会话",VIEW_TITLE_CHAT_QUEUE:"进行中的会话",VIEW_TITLE_END_CHAT_QUEUE:"已结束的会话"};function c(){i("","",s.constant.EVENT_CHAT_LIST_COUNT,function(e){})}function u(){e.total_closed=n.detail.chats.closed.get("total_closed");e.total_ongoing=n.detail.chats.closed.get("total_ongoing");e.total_waiting=n.detail.chats.closed.get("total_waiting");e.total_untreated=n.detail.chats.closed.get("total_untreated");if(n.detail.chats.closed.get("total_waiting")>0){s.doNotify(s.constant.EVENT_OTHER_CHAT_RED_POINT,true)}else{s.doNotify(s.constant.EVENT_OTHER_CHAT_RED_POINT,false)}}function d(){s.register(o,s.constant.EVENT_CHAT_LIST_COUNT,function(e,t){if(t){c()}else{u()}})}function p(){s.unRegister(o)}e.$on("$destroy",function(){p()});function f(){u();c();d()}f()}})(angular);angular.module("eweiApp.help_center").controller("helpCenterController",["$modal_","$rootScope","$scope","$state","$http","$stateParams","$location","serviceDeskService","engineerService","alertService","helpcenterViewService","ConsoleConfig","permissions","coreModelService",function(e,t,s,n,i,a,r,o,l,c,u,d,p,f){u.query({_count:999,_do_count:false,_fields:"id,title,filter,type",_filter:'{"$and":[{"$or":[{"$eq":{"type":"topic"}},{"$eq":{"type":"article"}},{"$eq":{"type":"resource"}},{"$eq":{"type":"question"}}]},{"$eq":{"provider.id":${current_provider_id}}}]}',_asc:"position"},function(e){if(n.current.name.indexOf("community")<0){return}userAginLogin(e);s.views=[];for(var t=0;t<e.views.length;t++){if(d.user.role.name!="ROLE_NAME_EDITOR"&&e.views[t].type=="topic"||d.user.role.name!="ROLE_NAME_EDITOR"&&e.views[t].type=="resource"){continue}else{s.views.push(e.views[t])}}var i=f.config.route.get("community.detail");if(i){n.go("community.detail",{id:i.id,type:i.type})}else{n.go("community.detail",{id:s.views[0].id,type:s.views[0].type});s.views[0].active=true}});s.settingShow=false;if(d.user.role.name=="ROLE_NAME_EDITOR"||d.user.role.name=="ROLE_NAME_ADMIN"){s.settingShow=true}t.$on("sync_view_count",function(e,t){void 0;for(var i=0,n=s.views.length;i<n;i++){if(s.views[i].type==t.type){s.views[i].count=t.count;break}}})}]).controller("topicViewDetailController",["$rootScope","$scope","$state","topicViewDetailService","$filter","$translatePartialLoader","$http","$modal_","alertService","$location","ConsoleConfig","permissions","multipleGroupService","coreModelService","apiHelpCenterCommunityService","coreNotifyService",function(l,c,t,e,i,n,o,u,d,s,a,r,p,f,m,g){if(a.user.role.name!="ROLE_NAME_EDITOR"){s.path("/unauthorized");return}c.eweiHelpcenterApiUrl=a.eweiHelpcenterApiUrl;c.AreaTopics=[];function v(){c.catalogExpend=[];o({url:"list_topic.json",method:"GET"}).success(function(e){c.AreaTopics=e.json;for(var t=0;t<c.AreaTopics.length;t++){if(c.AreaTopics[t].type=="manage"||c.AreaTopics[t].type=="questions"||c.AreaTopics[t].type=="announcement"){c.AreaTopics[t].showDelete=false}else{c.AreaTopics[t].showDelete=true}c.catalogExpend.push(f.list.communitys.catalog.gets(t))}})}c.catalogExpend=[];var h=g.constant.EVENT_DETAIL_HELPCENTER_CATALOG;var y=this.__proto__.constructor.name+"_"+(new Date).valueOf();var _=function(){g.register(y,h,function(e){C()})};var k=function(){C();b()};var C=function(){c.AreaTopics=f.detail.helpCenterCatalog.topics||[];for(var e=0;e<c.AreaTopics.length;e++){if(c.AreaTopics[e].type=="manage"||c.AreaTopics[e].type=="questions"||c.AreaTopics[e].type=="announcement"){c.AreaTopics[e].showDelete=false}else{c.AreaTopics[e].showDelete=true}c.catalogExpend.push(f.list.communitys.catalog.gets(e))}};var b=function(){m.getHelpCenterCatalog(h,"","",function(e){g.doNotify(h)})};var w=function(){_();k()};w();var T=function(){g.unRegister(y)};c.$on("$destroy",function(){T()});c.expendList=function(e){if(f.list.communitys.catalog.gets(e)){f.list.communitys.catalog.put(e,false)}else{f.list.communitys.catalog.put(e,true)}c.catalogExpend[e]=f.list.communitys.catalog.gets(e)};c.syncViewCount=function(e){var t={type:e};t.count=0;for(var i=0;i<c.AreaTopics.length;i++){t.count+=c.AreaTopics[i].childrenCount}l.$broadcast("sync_view_count",t)};c.initPositions=function(e){for(var t=0;t<c.AreaTopics[e].children.length;t++){c.AreaTopics[e].children[t].position=t+1}};c.sortableOptions={"ui-floating":false,handle:".myHandle",update:function(e,t){},stop:function(e,t){void 0;var i=t.item.attr("id");var s=i.split("_");var n={ids:[],values:[]};for(var a=0;a<c.AreaTopics[s[1]].children.length;a++){n.ids.push(c.AreaTopics[s[1]].children[a].id);n.values.push(a+1)}o({url:"topic_position/"+s[0]+".json",method:"POST",data:n}).success(function(e,t,i,n){userAginLogin(e);if(e.success){void 0;c.initPositions(s[1])}else{d.add("拖动失败","danger","left")}})}};c.parentSortableOptions={"ui-floating":false,handle:".myParentHandle",update:function(e,t){},start:function(e,t){},stop:function(e,t){void 0;var i=t.item.attr("id");var s=i.split("_");var n={ids:[],values:[]};for(var a=0;a<c.AreaTopics.length;a++){n.ids.push(c.AreaTopics[a].id);n.values.push(a+1)}o({url:"topic_position/"+s[0]+".json",method:"POST",data:n}).success(function(e,t,i,n){userAginLogin(e);if(e.success){void 0;c.initPositions(s[1])}else{d.add("拖动失败","danger","left")}})}};function S(){var e=u({scope:c,title:"提示",contentTemplate:"source/views/fun_restriction_reminder.html",html:true,show:true,placement:"center"});c.hasPermission=true;c.tipNotSupportService="当前服务版本不支持此功能，请升级服务后再试。";c.goAuthorization=function(){void 0;if(r.hasPermission("system_setting_company_account")){t.go("system_setting.detail.provider",{uri:"company_account",settingType:"system"});e.$promise.then(e.hide)}else{c.hasPermission=false;c.tipNotSupportService="很抱歉，你没有访问授权计划的权限"}};c.hideModal_=function(){e.$promise.then(e.hide)}}function F(e,t,i){o({url:"topic.json",method:"POST",data:e}).success(function(e){void 0;userAginLogin(e);if(e.success){var t=e.json;if(t!=undefined){if(i!=null){i.children.push(t);i.childrenCount+=1;c.syncViewCount("topic")}else{t.childrenCount=0;t.children=[];t.showDelete=true;c.AreaTopics.push(t)}}else{v()}c.hideModal()}else{d.add("更新失败","danger")}})}var A=[{name:"所有用户",access:"all_user"},{name:"仅登录用户",access:"login_user"},{name:"管理员和客服（客户不可见）",access:"agent_user"},{name:"指定客服组（客户不可见）",access:"specify_servicedesk"},{name:"指定客户组",access:"specify_usergroup"}];var E=[{name:"管理员和客服（客户不可见）",access:"agent_user"},{name:"指定客服组（客户不可见）",access:"specify_servicedesk"}];c.showCatalog=function(i,e,n,t){void 0;p.resetServiceGroup();p.resetUserGroup();var s=c;var a;s.options=n.type=="manage"?E:A;s.newTopic={};if(n!=null){var r={id:n.id};s.newTopic.parent=r}o({url:"topic/"+i.id+".json ",method:"get"}).success(function(e){s.newTopic.access=e.json.access;s.newTopic.type=e.json.type;s.newTopic.name=e.json.name;if(e.json.access=="specify_servicedesk"){for(var t=0;t<e.json.accessServiceDesk.length;t++){p.setServiceGroup(e.json.accessServiceDesk[t])}}else if(e.json.access=="specify_usergroup"){for(var t=0;t<e.json.accessUserGroup.length;t++){p.setUserGroup(e.json.accessUserGroup[t])}}for(var t=0;t<A.length;t++){if(A[t].access==i.access){s.newTopicAccessObj=A[t].access}}a=u({scope:s,title:"修改目录",contentTemplate:"source/views/help_center/addCatalog.html",html:true,show:true,placement:"center"})});s.hideModal=function(){a.$promise.then(a.hide)};s.$save=function(e){if(e.name==""||e.name==undefined){d.add("名称不能为空!","danger");return}else if(n!=null&&e.access!="agent_user"&&l.providerLicense.type=="free"){S();return}void 0;if(e.access=="specify_servicedesk"){e.accessServiceDesk=[];for(var t=0;t<p.getServiceGroup().length;t++){e.accessServiceDesk.push({id:p.getServiceGroup()[t].id})}if(e.accessServiceDesk.length<=0){d.add("请选择指定客服组","danger");return false}}else if(e.access=="specify_usergroup"){e.accessUserGroup=[];for(var t=0;t<p.getUserGroup().length;t++){e.accessUserGroup.push({id:p.getUserGroup()[t].id})}if(e.accessUserGroup.length<=0){d.add("请选择指定客服组","danger");return false}}e.id=i.id;e.parent=s.newTopic.parent;F(e,i,n)}};c.addCatalog=function(i,e,n,t){void 0;p.resetServiceGroup();p.resetUserGroup();var s=c;var a;s.options=e=="manage"?E:A;s.newTopic={};s.newTopic.access=e=="manage"?"agent_user":"all_user";s.newTopic.type=e=="manage"?"articles":e;if(n!=null){var r={id:n.id};s.newTopic.parent=r}a=u({scope:s,title:"添加目录",contentTemplate:"source/views/help_center/addCatalog.html",html:true,show:true,placement:"center"});s.hideModal=function(){a.$promise.then(a.hide)};s.$save=function(e){if(e.name==""||e.name==undefined){d.add("名称不能为空!","danger");return}else if(n!=null&&e.access!="agent_user"&&l.providerLicense.type=="free"){S();return}void 0;if(e.access=="specify_servicedesk"){e.accessServiceDesk=[];for(var t=0;t<p.getServiceGroup().length;t++){e.accessServiceDesk.push({id:p.getServiceGroup()[t].id})}if(e.accessServiceDesk.length<=0){d.add("请选择指定客服组","danger");return false}}else if(e.access=="specify_usergroup"){e.accessUserGroup=[];for(var t=0;t<p.getUserGroup().length;t++){e.accessUserGroup.push({id:p.getUserGroup()[t].id})}if(e.accessUserGroup.length<=0){d.add("请选择指定客服组","danger");return false}}F(e,i,n)}};c.editTopic=function(t,e,i,n){if(t){_hmt.push(["_trackEvent","社区管理-目录","编辑目录"])}else{_hmt.push(["_trackEvent","社区管理-目录","添加目录"])}var s;var a=c;var r="编辑版块";a.editName="版块名称";if(t==null){a.newTopic={};a.newTopic.access="agent_user";a.newTopic.type=e;r="添加版块";a.editName="版块名称"}else{a.newTopic=t;if(i!=null){var o={id:i.id};a.newTopic.parent=o;r="编辑目录";a.editName="目录名称"}}s=u({scope:a,title:r,contentTemplate:"source/views/help_center/topic_edit.html",html:true,show:true,placement:"center"});c.hideModal=function(){s.$promise.then(s.hide)};c.oldTopic={};c.oldTopic.name=c.newTopic.name;a.$save=function(e){if(c.oldTopic.name==""||c.oldTopic.name==undefined){d.add("名称不能为空!","danger");return}else if(i!=null&&l.providerLicense.type=="free"){S();return}a.newTopic.name=c.oldTopic.name;F(a.newTopic,t,i)}};c.deleteTopic=function(s,e,a,r){_hmt.push(["_trackEvent","社区管理-目录","删除目录"]);var t="你所要删除的目录中可能包含文章或者问题,如果删除此目录,该目录下的文章和问题将会被删除,确定删除"+e.name+"吗？";if(a==0){t="你所要删除的版块中可能包含目录,如果删除此版块,该版块下的目录将会被删除,确定删除"+e.name+"吗？"}c.isLoading=false;c._messages=t;var i=u({scope:c,title:"删除确认",contentTemplate:"source/views/alter_common.html",html:true,show:true,placement:"center"});c.$hide=function(){i.$promise.then(i.hide)};c.$ok=function(){o({url:"topic/"+e.id,method:"DELETE",params:{}}).success(function(e,t,i,n){userAginLogin(e);if(e.success){if(a>0){r.children.splice(s,1);r.childrenCount-=1}else{c.AreaTopics.splice(s,1)}c.$hide();c.syncViewCount("topic")}else{d.add("删除失败","danger")}})}}}]).controller("articleViewDetailController",["$http","$rootScope","alertService","$scope","$stateParams","$filter","questionService","utils","$state","$timeout","ngTableParams","permissions","$location","coreModelService","apiHelpCenterCommunityService","coreNotifyService",function(t,a,r,o,e,l,i,n,s,c,u,d,p,f,m,g){var v='{"$and":[{"$ne":{"topic.type":"questions"}},{"$ne":{"topic.type":"deletes"}}]}';o.oldFilter='{"$and":[{"$ne":{"topic.type":"questions"}},{"$ne":{"topic.type":"deletes"}}]}';o.recommendIndexShow=[];o.recommendIndexOldId=0;o.searchKey=null;o.placeholderVal="搜索主题";o.oldSearchKey=null;var h=function(e,t){for(var i in e){if(e[i]==t){return i}return""}};o.columnType="article";o.columns=[{title:"主题",field:"title",visible:true,sortable:true,widthClass:"w400"},{title:"目录",field:"topic.name",fieldCount:2,field0:"topic",field1:"name",visible:true,sortable:true,widthClass:"w150"},{title:"评论",field:"commentCount",visible:true,sortable:true,widthClass:"w150"},{title:"关注",field:"subscriptionCount",visible:true,sortable:true,widthClass:"w150"},{title:"分享",field:"shareCount",visible:true,sortable:true,widthClass:"w150"},{title:"创建人",field:"author.name",fieldCount:2,field0:"author",field1:"name",visible:true,sortable:true,widthClass:"w200"},{title:"创建于",field:"createdAt",visible:true,sortable:true,widthClass:"w200"},{title:"推荐指数",field:"recommendIndex",visible:true,sortable:true,widthClass:"w200"}];if(a.currentArticlePage==undefined){a.currentArticlePage=1}o.showUpdate=function(e){o.recommendIndexShow[o.recommendIndexOldId]=false;o.recommendIndexShow[e.id]=true;o.recommendIndexOldId=e.id};o.updateRecommendIndex=function(s){if(s.recommendIndex==undefined||s.recommendIndex==""){s.recommendIndex=0}var e=/^\d+$/;if(!e.test(s.recommendIndex)||s.recommendIndex>1e3){void 0;return}t({url:"updateRecommendIndex.json",method:"POST",params:{id:s.id,recommendIndex:s.recommendIndex}}).success(function(e,t,i,n){if(e.id>0){r.add("更新成功！");o.recommendIndexShow[s.id]=false}else{r.add("更新失败！")}})};o.clearSorting=function(){o.tableParams.sorting(JSON.parse('{"id":"desc"}'));o.defaultSorting=true};o.defaultSorting=true;o.clearSearch=function(){if(o.searchKey!=null){v=o.oldFilter;o.searchKey=null;o.oldSearchKey=null;if(a.currentArticlePage!=1){o.tableParams.page(1)}else{o.tableParams.reload()}}};o.placeholder="搜索主题";o.search=function(e){_hmt.push(["_trackEvent","社区管理-文章","搜索文章"]);if(o.searchKey==""){o.clearSearch()}else{if(e!=o.oldSearchKey){o.oldSearchKey=e;v='{"$and":[{"$like":{"title":"$'+o.searchKey+'$"}},'+o.oldFilter+"]}";if(a.currentArticlePage!=1){o.tableParams.page(1)}else{o.tableParams.reload()}}}};o.setRows=function(e){y=true;var t=o.tableParams.count();if(e==t)return;o.tableParams.count(e);o.tableParams.page(a.currentArticlePage);o.tableParams.getData(o.tableParams)};var y=false;function _(){o.tableParams=new u({page:a.currentArticlePage,count:50,sorting:JSON.parse('{"id":"desc"}')},{$scope:o,counts:[],groupBy:function(e){},total:0,getData:function(e,t){var i=h(t.sorting(),"asc");var n=h(t.sorting(),"desc");w({_page:t.page(),_count:t.count(),_filter:v,_asc:i,_desc:n});a.currentArticlePage=t.page();t.total(f.list.helpManageDocument.total());if("id"!=n){o.defaultSorting=false}var s=t.sorting()?l("orderBy")(o.helpManageDocument,t.orderBy()):o.helpManageDocument;e.resolve(s);o.showCheckboxes=false;o.questions=s;if(s.length==0){o.noDataTip="没有相关数据"}}})}var k=g.constant.EVENT_DETAIL_HELP_MANAGE_DOCUMENT;var C=this.__proto__.constructor.name+"_"+(new Date).valueOf();var b=function(){g.register(C,k,function(e){o.tableParams.reload()})};var w=function(e){T();if(y&&JSON.stringify(e)!=JSON.stringify(o.argumentLast)){S(e);o.argumentLast=angular.copy(e)}};var T=function(){o.helpManageDocument=f.detail.helpManageDocument.gets(f.list.helpManageDocument.gets(a.currentArticlePage))||[];if(o.helpManageDocument&&o.helpManageDocument.length>0){o.tableLoading=false}else{o.tableLoading=true}};var S=function(e){m.getHelpManageDocument(k,e._page,e,"",function(e){g.doNotify(k)})};var F=function(){b();_()};F();var A=function(){g.unRegister(C)};o.$on("$destroy",function(){A()})}]).controller("questionViewDetailController",["$http","$rootScope","alertService","$scope","$stateParams","$filter","questionService","utils","$state","$timeout","ngTableParams","permissions","$location","apiQuestionService","coreModelService","coreNotifyService",function(i,s,a,r,e,o,t,n,l,c,u,d,p,f,m,g){var v='{"$or":[{"$eq":{"topic.type":"questions"}},{"$eq":{"topic.type":"deletes"}}]}';var h=this.__proto__.constructor.name+"_"+Date.now();r.serverDataLoad=false;r.questions=[];r.oldFilter='{"$or":[{"$eq":{"topic.type":"questions"}},{"$eq":{"topic.type":"deletes"}}]}';r.recommendIndexShow=[];r.recommendIndexOldId=0;r.searchKey=null;r.oldSearchKey=null;r.placeholderVal="搜索主题";var y=function(e,t){for(var i in e){if(e[i]==t){return i}return""}};r.columnType="question";r.columns=[{title:"主题",field:"title",visible:true,sortable:true,widthClass:"w400"},{title:"目录",field:"topic.name",fieldCount:2,field0:"topic",field1:"name",visible:true,sortable:true,widthClass:"w150"},{title:"回答",field:"answerCount",visible:true,sortable:true,widthClass:"w150"},{title:"关注",field:"subscriptionCount",visible:true,sortable:true,widthClass:"w150"},{title:"分享",field:"shareCount",visible:true,sortable:true,widthClass:"w150"},{title:"创建人",field:"author.name",fieldCount:2,field0:"author",field1:"name",visible:true,sortable:true,widthClass:"w200"},{title:"创建于",field:"createdAt",visible:true,sortable:true,widthClass:"w200"},{title:"推荐指数",field:"recommendIndex",visible:true,sortable:true,widthClass:"w200"}];if(s.currentQuestionPage==undefined){s.currentQuestionPage=1}r.showUpdate=function(e){r.recommendIndexShow[r.recommendIndexOldId]=false;r.recommendIndexShow[e.id]=true;r.recommendIndexOldId=e.id};r.updateRecommendIndex=function(e){if(e.recommendIndex==undefined||e.recommendIndex==""){e.recommendIndex=0}var t=/^\d+$/;if(!t.test(e.recommendIndex)||e.recommendIndex>1e3){void 0;return}i({url:"updateRecommendIndex.json",method:"POST",params:{id:e.id,recommendIndex:e.recommendIndex}}).success(function(e,t,i,n){if(e.id>0){a.add("更新成功！")}else{a.add("更新失败！")}});r.recommendIndexShow[e.id]=false};r.clearSorting=function(){r.tableParams.sorting(JSON.parse('{"id":"desc"}'));r.defaultSorting=true};r.defaultSorting=true;r.clearSearch=function(){if(r.searchKey!=null){v=r.oldFilter;r.searchKey=null;r.oldSearchKey=null;if(s.currentQuestionPage!=1){r.tableParams.page(1)}else{r.tableParams.reload()}}};r.placeholder="搜索主题";r.search=function(e){_hmt.push(["_trackEvent","社区管理-问题","搜索问题"]);if(r.searchKey==""){r.clearSearch()}else{if(e!=r.oldSearchKey){r.oldSearchKey=e;v='{"$and":[{"$like":{"title":"$'+r.searchKey+'$"}},'+r.oldFilter+"]}";if(s.currentQuestionPage!=1){r.tableParams.page(1)}else{r.tableParams.reload()}}}};r.setRows=function(e){_=true;var t=r.tableParams.count();if(e==t)return;r.tableParams.count(e);r.tableParams.page(s.currentQuestionPage);r.tableParams.getData(r.tableParams)};var _=false;function k(){r.tableParams=new u({page:s.currentQuestionPage,count:50,sorting:JSON.parse('{"id":"desc"}')},{$scope:r,counts:[],groupBy:function(e){},total:0,getData:function(e,t){var i=y(t.sorting(),"asc");var n=y(t.sorting(),"desc");T({_page:t.page(),_count:t.count(),_filter:v,_asc:i,_desc:n});userAginLogin(r.questions);if(r.questions==undefined||r.questions.length==0){}s.currentQuestionPage=t.page();t.total(m.list.question.total());if("id"!=n){r.defaultSorting=false}r.questions=t.sorting()?o("orderBy")(r.questions,t.orderBy()):r.questions;e.resolve(r.questions);r.showCheckboxes=false;if(r.questions.length==0&&r.serverDataLoad){r.noDataTip="没有相关数据"}}})}function C(){r.questions=m.detail.question.gets(m.list.question.gets(s.currentQuestionPage));if(r.questions&&r.questions.length>0){r.tableLoading=false}else{r.tableLoading=true}}function b(e){f.run(g.constant.EVENT_DETAIL_QUESTION,e._page,e,"",function(e){})}function w(){g.register(h,g.constant.EVENT_DETAIL_QUESTION,function(e,t){r.tableParams.reload();r.serverDataLoad=true})}function T(e){C();if(!_)return;if(JSON.stringify(e)!=JSON.stringify(r.argumentLast)){b(e);r.argumentLast=angular.copy(e)}}function S(){w();k()}S();function F(){g.unRegister(h)}r.$on("$destroy",function(){F()})}]).controller("resourceViewDetailController",["$uibModal","$modal_","$scope","$state","$http","apiRestfulService","alertService","commonTools","ConsoleConfig","$rootScope","permissions","multipleGroupService","coreModelService","apiHelpResourcesCatalogAllService","apiHelpResourcesAllService","coreNotifyService",function(e,o,l,s,r,t,c,i,n,u,a,d,p,f,m,g){l.isEditor=false;var v=this.__proto__.constructor.name+"_"+Date.now();if(n.user&&n.user.role){if(n.user.role.name=="ROLE_NAME_EDITOR"||n.user.role.name=="ROLE_NAME_ADMIN"){l.isEditor=true}}l.editTopic=function(t,e,i,n){void 0;if(t.accessServiceDesk){d.setServiceGroupNew(t.accessServiceDesk)}else if(t.accessUserGroup){d.setUserGroupNew(t.accessUserGroup)}else{d.resetServiceGroup();d.resetUserGroup()}var s;var a=l;a.options=[{name:"所有用户",access:"all_user"},{name:"仅登录用户",access:"login_user"},{name:"管理员和客服（客户不可见）",access:"agent_user"},{name:"指定客服组（客户不可见）",access:"specify_servicedesk"},{name:"指定客户组",access:"specify_usergroup"}];var s;var a=l;var r="编辑版块";a.editName="版块名称";a.newTopic=t;s=o({scope:a,title:r,contentTemplate:"source/views/help_center/resource_edit.html",html:true,show:true,placement:"center"});l.hideModal=function(){s.$promise.then(s.hide)};l.oldTopic={};l.oldTopic.name=l.newTopic.name;l.oldTopic.access=l.newTopic.access;a.$save=function(e){if(l.oldTopic.name==""||l.oldTopic.name==undefined){c.add("名称不能为空!","danger");return}else if(i!=null&&u.providerLicense.type=="free"){y();return}a.newTopic.name=l.oldTopic.name;a.newTopic.access=l.oldTopic.access;h(a.newTopic,t,i)}};function h(e,t,i){var n={id:e.id,name:e.name,access:e.access};if(e.access=="specify_servicedesk"){n.accessServiceDesk=[];for(var s=0;s<d.getServiceGroup().length;s++){n.accessServiceDesk.push({id:d.getServiceGroup()[s].id})}if(n.accessServiceDesk.length<=0){c.add("请选择指定客服组","danger");return false}}else if(e.access=="specify_usergroup"){n.accessUserGroup=[];for(var s=0;s<d.getUserGroup().length;s++){n.accessUserGroup.push({id:d.getUserGroup()[s].id})}if(n.accessUserGroup.length<=0){c.add("请选择指定客服组","danger");return false}}r({url:"helpResourceCatalog/update.json",method:"POST",data:n}).success(function(e){l.hideModal();void 0;if(e.success){c.add("更新成功","success")}else{c.add("更新失败","danger")}})}function y(){var e=o({scope:l,title:"提示",contentTemplate:"source/views/fun_restriction_reminder.html",html:true,show:true,placement:"center"});l.hasPermission=true;l.tipNotSupportService="当前服务版本不支持此功能，请升级服务后再试。";l.goAuthorization=function(){void 0;if(a.hasPermission("system_setting_company_account")){s.go("system_setting.detail.provider",{uri:"company_account",settingType:"system"});e.$promise.then(e.hide)}else{l.hasPermission=false;l.tipNotSupportService="很抱歉，你没有访问授权计划的权限"}};l.hideModal_=function(){e.$promise.then(e.hide)}}l.parentSortableOptions={"ui-floating":false,handle:".myHandleP",update:function(e,t){},stop:function(e,t){void 0;var i=t.item.attr("id");var n={ids:[],values:[]};for(var s=0;s<l.catalogs.length;s++){n.ids.push(l.catalogs[s].id);n.values.push(s+1)}r({url:"helpCatalog_position",method:"POST",data:n}).success(function(e,t,i,n){if(e.success){}else{c.add("拖动失败","danger")}})}};l.sortableOptions={"ui-floating":false,handle:".myHandle",update:function(e,t){},stop:function(e,t){void 0;var i=t.item.attr("id");var n=i.split("_");var s={ids:[],values:[]};angular.forEach(l.catalogs,function(e){if(n[0]==e.id){for(var t=0;t<e.resources.length;t++){s.ids.push(e.resources[t].id);s.values.push(t+1)}}});void 0;r({url:"helpResource_position",method:"POST",data:s}).success(function(e,t,i,n){if(e.success){}else{c.add("拖动失败","danger")}})}};l.expendList=function(e){if(p.list.communitys.resources.gets(e)){p.list.communitys.resources.put(e,false)}else{p.list.communitys.resources.put(e,true)}l.catalogExpend[e]=p.list.communitys.resources.gets(e)};l.editHelpcenterResourceCatalog=function(){_hmt.push(["_trackEvent","社区管理-资源","添加目录"]);d.resetServiceGroup();d.resetUserGroup();var e;var t=l;t.options=[{name:"所有用户",access:"all_user"},{name:"仅登录用户",access:"login_user"},{name:"管理员和客服（客户不可见）",access:"agent_user"},{name:"指定客服组（客户不可见）",access:"specify_servicedesk"},{name:"指定客户组",access:"specify_usergroup"}];t.newHelpResourceCatalogtitle="";t.newHelpResourceCatalog="agent_user";e=o({scope:t,title:"增加子目录",contentTemplate:"source/views/help_center/resources_catalog_edit.htm",html:true,show:true,placement:"center"});t.hideModal=function(){e.$promise.then(e.hide)};t.$save=function(e){if(e!="agent_user"&&u.providerLicense.type=="free"){var t=o({scope:l,title:"提示",contentTemplate:"source/views/fun_restriction_reminder.html",html:true,show:true,placement:"center"});l.hasPermission=true;l.tipNotSupportService="当前服务版本不支持此功能，请升级服务后再试。";l.goAuthorization=function(){void 0;if(a.hasPermission("system_setting_company_account")){s.go("system_setting.detail.provider",{uri:"company_account",settingType:"system"});t.$promise.then(t.hide)}else{l.hasPermission=false;l.tipNotSupportService="很抱歉，你没有访问授权计划的权限"}};l.hideModal_=function(){t.$promise.then(t.hide)};return}if(!Catalog.value){c.add("请输入目录名称","danger");return false}var i={name:Catalog.value,access:e};if(e=="specify_servicedesk"){i.accessServiceDesk=[];for(var n=0;n<d.getServiceGroup().length;n++){i.accessServiceDesk.push({id:d.getServiceGroup()[n].id})}if(i.accessServiceDesk.length<=0){c.add("请选择指定客服组","danger");return false}}else if(e=="specify_usergroup"){i.accessUserGroup=[];for(var n=0;n<d.getUserGroup().length;n++){i.accessUserGroup.push({id:d.getUserGroup()[n].id})}if(i.accessUserGroup.length<=0){c.add("请选择指定客服组","danger");return false}}r({url:"helpResourceCatalog_add.json",method:"POST",data:i}).success(function(e,t,i,n){userAginLogin(e);if(e.success){var s=e.json;s.resources=[];l.catalogs.push(s);l.hideModal()}else{c.add("更新失败","danger")}})}};l.deleteHelpcenterResourceCatalog=function(s,e){if(confirm("确定删除目录"+e.name+"及其下的资源 吗？")){r({url:"helpResourceCatalog/"+e.id,method:"DELETE"}).success(function(e,t,i,n){userAginLogin(e);if(e.success){l.catalogs.splice(s,1)}else{c.add("删除失败","danger")}})}};l.$on("uploading",function(e,t){l.addBtnVisble=t.state;i.safeApply(l);if(l.stopUpload){t.file.uploading&&t.uploader.stop()}});l.$on("uploadedAttachment",function(e,t){var i=angular.fromJson(t);l.attachment=i;l.attachments.push(i)});l.addHelpcenterResource=function(i,e){l.addBtnVisble=true;var n;l.stopUpload=false;l.newHelpResourceCatalog=new Object;n=o({scope:l,title:"添加资源",contentTemplate:"source/views/help_center/resource_add.htm",html:true,show:true,placement:"center",hideCallback:function(){l.stopUpload=true}});l.file={};l.attachments=[];l.attachment={};l.$save=function(){if(angular.isUndefined(l.attachment.id)){c.add("您还没有选择上传附件！","danger");return}if(l.file.name!=""&&l.file.name!=undefined){l.attachment.fileName=l.file.name}r({url:"helpResource_add/"+e+".json",method:"POST",data:l.attachment}).success(function(e){userAginLogin(e);if(e.success){var t=e.json;l.catalogs[i].resources.push(t);n.destroy();l.syncViewCount("resource")}else{if(e.message=="license_limit"){c.add("授权已经过期或者欠费！","danger")}else{c.add("添加失败！","danger")}}})}};l.deleteHelpcenterResourceCatalog=function(s,e){_hmt.push(["_trackEvent","社区管理-资源","删除目录"]);l.isLoading=false;l._messages="如果删除此目录，该目录下的资源也将会被删除，确定删除目录"+e.name+" 吗？";var t=o({scope:l,title:"删除确认",contentTemplate:"source/views/alter_common.html",html:true,show:true,placement:"center"});l.$hide=function(){t.$promise.then(t.hide)};l.$ok=function(){r({url:"helpResourceCatalog/"+e.id,method:"DELETE"}).success(function(e,t,i,n){userAginLogin(e);l.$hide();if(e.success){l.catalogs.splice(s,1);l.syncViewCount("resource")}else{c.add("删除失败","danger")}})}};l.deleteHelpcenterResource=function(s,a,e){_hmt.push(["_trackEvent","社区管理-资源","删除资源"]);l.isLoading=false;l._messages="确定删除 "+e.name+" 吗？";var t=o({scope:l,title:"删除确认",contentTemplate:"source/views/alter_common.html",html:true,show:true,placement:"center"});l.$hide=function(){t.$promise.then(t.hide)};l.$ok=function(){r({url:"helpResource/"+e.id,method:"DELETE"}).success(function(e,t,i,n){userAginLogin(e);l.$hide();if(e.success){a.resources.splice(s,1);l.syncViewCount("resource")}else{c.add("删除失败","danger")}})}};l.syncViewCount=function(e){var t={type:e};t.count=0;for(var i=0;i<l.catalogs.length;i++){t.count+=l.catalogs[i].resources.length}u.$broadcast("sync_view_count",t)};function _(){l.catalogExpend=[];angular.forEach(l.catalogs,function(i,e){i.resources=[];angular.forEach(l.helpResources,function(e,t){if(e.catalog.id==i.id){i.resources.push(e)}});l.catalogExpend.push(p.list.communitys.resources.gets(e))})}function k(){l.catalogs=p.detail.helpResourcesCatologs.gets(p.list.helpResourcesCatologs.getAll());l.helpResources=p.detail.helpResources.gets(p.list.helpResources.getAll());if(!angular.equals({},l.catalogs)){_()}}function C(){f.run(g.constant.EVENT_DETAIL_HELPRESOURCESCATOLOGS,{_count:999,_do_count:true},"",function(e){});m.run(g.constant.EVENT_DETAIL_HELPRESOURCES,{_count:999,_do_count:true},"",function(e){})}function b(){var i=0;g.register(v,g.constant.EVENT_DETAIL_HELPRESOURCESCATOLOGS,function(e,t){i++;if(i>=2){k()}});g.register(v,g.constant.EVENT_DETAIL_HELPRESOURCES,function(e,t){i++;if(i>=2){k()}})}function w(){k();C()}function T(){b();w()}T();function S(){g.unRegister(v)}l.$on("$destroy",function(){S()})}]).controller("helpcenterSettingController",["$scope","$rootScope","$state","helpcenterSettingMenus","$translatePartialLoader","$location",function(i,n,e,t,s,a){i.menus=t;i.btnList=[{name:"工单设置",sref:"ticket_setting"},{name:"客户设置",permission:"customer_view_manage,customer_setting_customfield,customer_group_setting_customfield,customer_setting_customfield_url_secret",sref:"customer_setting.user_custom_field"},{name:"系统设置",sref:"system_setting"}];i.helpcenterSetBuried={"访问控制":"访问控制","界面个性化":"界面个性化","提交工单":"提交工单","积分规则":"积分规则"};i.divShow=true;i.leftDivShow=false;i.uiStyle={left:"390px"};i.detail=function(e,t){if(i.helpcenterSetBuried[t]){_hmt.push(["_trackPageview","/社区设置/子级页面/"+i.helpcenterSetBuried[t]]);_hmt.push(["_setCustomVar",n.vertionNumber,"名称","社区设置"+i.helpcenterSetBuried[t],1]);_hmt.push(["_trackEvent","社区设置",i.helpcenterSetBuried[t]])}}}]).factory("multipleGroupService",multipleGroupService);multipleGroupService.$inject=[];function multipleGroupService(){var n=[];var s=[];return{setUserGroup:function(e){var t=true;for(var i=0;i<n.length;i++){if(n[i].id==e.id){t=false}}if(t){n.push(e)}},setUserGroupNew:function(e){angular.forEach(e,function(t){var e=_.find(n,function(e){return e.id==t.id});if(!e){n.push(t)}})},setServiceGroupNew:function(e){angular.forEach(e,function(t){var e=_.find(s,function(e){return e.id==t.id});if(!e){s.push(t)}})},deleteUserGroup:function(e){for(var t=0;t<n.length;t++){if(n[t].id==e){n.splice(t,1)}}},getUserGroup:function(){return n},resetUserGroup:function(){n=[]},setServiceGroup:function(e){var t=true;for(var i=0;i<s.length;i++){if(s[i].id==e.id){t=false}}if(t){s.push(e)}},deleteServiceGroup:function(e){for(var t=0;t<s.length;t++){if(s[t].id==e){s.splice(t,1)}}},getServiceGroup:function(){return s},resetServiceGroup:function(){s=[]}}}angular.module("eweiApp.help_center").controller("helpcenteraccessSettingController",["$scope","$state","$stateParams","$http","alertService","$rootScope","helpcenterViewService","$filter","$translatePartialLoader","$location","ldapFields","eweiUserFields","$modal_","ConsoleConfig",function(a,e,t,i,s,r,n,o,l,c,u,d,p,f){a.consoleCenterUrl=c.protocol()+"://"+f.provider.subDomain+"."+f.domainRoot+"/console";a.location=location.host;a.eweiHelpcenterApiUrl=f.eweiHelpcenterApiUrl;a.accessConfig={requiredLogin:"false",restrictIp:false,ipWhiteList:"",excludeApp:false};a.signIn={type:"accountSignIn"};a.div={show:1};a.accountSignIn={signUp:true,qq:true,weibo:true};i({url:"getAccessConfigByProvider.json",method:"GET"}).success(function(e,t,i,n){if(e.json!==undefined){a.accessConfig.requiredLogin=e.json.requiredLogin+"";a.accessConfig.restrictIp=e.json.restrictIp;a.accessConfig.ipWhiteList=e.json.ipWhiteList===undefined?"":e.json.ipWhiteList;a.accessConfig.excludeApp=e.json.excludeApp;a.accessConfig.id=e.json.id}});a.isQiyeQQInputDisabled=true;i({url:"provider_qiye_qq_config.json",method:"GET"}).success(function(e,t,i,n){if(e&&e.success){var s=e.json;if(s&&s.id>0&&s.companyId!=undefined&&s.companyId!=null&&s.companyId!=""&&s.companyToken!=undefined&&s.companyToken!=null&&s.companyToken!=""){a.isQiyeQQInputDisabled=false}}});a.oppenHelpCenter={isOpen:r.currentProviderIsOpenHelpcenter};a.updateAccessConfig=function(){_hmt.push(["_trackEvent","社区设置-访问控制","访问控制更新"]);i({url:"updateAccessConfig.json",method:"POST",params:{id:a.accessConfig.id,requiredLogin:a.accessConfig.requiredLogin,restrictIp:a.accessConfig.restrictIp,ipWhiteList:a.accessConfig.ipWhiteList,excludeApp:a.accessConfig.excludeApp}}).success(function(e,t,i,n){if(e.id>0){s.add("修改成功！")}else{s.add("修改失败！","danger")}})};a.showAccessConfigDiv=function(){_hmt.push(["_trackEvent","社区设置-访问控制","访问控制"]);if(a.div.show!=1){i({url:"getAccessConfigByProvider.json",method:"GET"}).success(function(e,t,i,n){if(e.json!==undefined){a.accessConfig.requiredLogin=e.json.requiredLogin+"";a.accessConfig.restrictIp=e.json.restrictIp;a.accessConfig.ipWhiteList=e.json.ipWhiteList===undefined?"":e.json.ipWhiteList;a.accessConfig.excludeApp=e.json.excludeApp;a.accessConfig.id=e.json.id}});a.div.show=1}document.getElementById("access_setting_tab1").checked=true};a.signinConfig={};a.ldapFields=u;a.eweiUserFields=d;a.ldapPassword=null;a.ldapverify=false;a.loadSigninConfig=function(){i({url:"signin_config.json",method:"GET"}).success(function(e,t,i,n){a.signinConfig=e.json;if(a.signinConfig.ldapSignIn==null){a.signinConfig.ldapSignIn={filter:"(|(objectClass=account)(objectClass=user)(objectClass=person)(objectClass=inetOrgPerson))"};a.signinConfig.ldapSignIn.propertyFields=m()}else{a.ldapPassword=Base64.decode(a.signinConfig.ldapSignIn.password);if(a.signinConfig.ldapSignIn.propertyFields==null||a.signinConfig.ldapSignIn.propertyFields.length==0){a.signinConfig.ldapSignIn.propertyFields=m()}}})};a.showSigninConfigInDiv=function(){_hmt.push(["_trackEvent","社区设置-访问控制","帐户和登录验证方式"]);if(a.div.show!=2){a.loadSigninConfig();a.div.show=2}document.getElementById("access_setting_tab2").checked=true};a.toShowSelectLdapField=function(){a.selectFieldItem=null;var e=p({scope:a,title:"选择用户属性",contentTemplate:"source/views/help_center/select_ldap_fields.html",html:true,show:true,placement:"center"});a.hideSelectLdapFieldModal=function(){e.$promise.then(e.hide)};a.$fieldChange=function(e){a.selectFieldItem=e};a.$ok=function(){void 0;if(a.selectFieldItem==null||a.selectFieldItem==""){s.add("请选择！","danger");return}for(var e=0,t=a.signinConfig.ldapSignIn.propertyFields.length;e<t;e++){var i=a.signinConfig.ldapSignIn.propertyFields[e];if(i.userProperty==a.selectFieldItem){s.add("此项已经被选择！","danger");return}}a.signinConfig.ldapSignIn.propertyFields.push({required:false,userProperty:a.selectFieldItem,ldapProperty:"name"});a.hideSelectLdapFieldModal()}};a.deleteLdapField=function(e){a.signinConfig.ldapSignIn.propertyFields.splice(e,1)};var m=function(){var e=[{required:true,userProperty:"name",ldapProperty:"name",orderKey:1},{required:true,userProperty:"email",ldapProperty:"mail",orderKey:2}];return e};a.radioChange=function(){if(a.signinConfig.type=="sso"){if(!a.signinConfig.accountSignIn.jwt){a.signinConfig.accountSignIn.saml=true;return}}a.signinConfig.accountSignIn.saml=false};a.checkBoxChange=function(e){if("jwt"==e){a.signinConfig.accountSignIn.saml=false}else if("saml"==e){a.signinConfig.accountSignIn.jwt=false}if(!a.signinConfig.accountSignIn.saml&&!a.signinConfig.accountSignIn.jwt){if("jwt"==e){a.signinConfig.accountSignIn.saml=true}else if("saml"==e){a.signinConfig.accountSignIn.jwt=true}}};var g=function(e){if(e){if(e.toLowerCase().indexOf("http://")!=0&&e.toLowerCase().indexOf("https://")!=0){return"http://"+e;void 0}return e}};a.updateSigninConfigSignIn=function(){_hmt.push(["_trackEvent","社区设置-访问控制","帐户和登录验证方式更新"]);if(a.signinConfig.type=="ldap"){if(a.signinConfig.ldapSignIn.server==null||a.signinConfig.ldapSignIn.server==""||a.signinConfig.ldapSignIn.admin==""||a.signinConfig.ldapSignIn.admin==null||a.signinConfig.ldapSignIn.userDirectory==null||a.signinConfig.ldapSignIn.userDirectory==""||a.ldapPassword==null||a.ldapPassword==""||a.signinConfig.ldapSignIn.serverType==null||a.signinConfig.ldapSignIn.serverType==""){s.add("请填写完整ldap配置信息","danger");return}a.signinConfig.ldapSignIn.password="";if(a.ldapverify){a.updateSigninConfigSignInRequest()}else{i({url:"check_ldap_config.json",method:"POST",data:a.signinConfig,headers:{Authorization:Base64.encode(a.ldapPassword)}}).success(function(e,t,i,n){if(e.success){a.ldapverify=true;a.updateSigninConfigSignInRequest()}else{s.add("验证失败,无法保存","danger");a.ldapverify=false}})}}else if(a.signinConfig.type=="sso"){if(a.signinConfig.accountSignIn.saml){if(a.signinConfig.ssoSignIn==null||a.signinConfig.ssoSignIn.saml.loginUrl==""||a.signinConfig.ssoSignIn.saml.loginUrl==undefined||a.signinConfig.ssoSignIn.saml.samlUrl==""||a.signinConfig.ssoSignIn.saml.samlUrl==undefined){s.add("请填写完整saml配置信息","danger");return}if(a.signinConfig.ssoSignIn.saml.ticketParam==undefined||a.signinConfig.ssoSignIn.saml.ticketParam==""){a.signinConfig.ssoSignIn.saml.ticketParam="SAMLart"}if(a.signinConfig.ssoSignIn.saml.emailParam==undefined||a.signinConfig.ssoSignIn.saml.emailParam==""){a.signinConfig.ssoSignIn.saml.emailParam="NameID"}if(a.signinConfig.ssoSignIn.saml.loginParam==undefined||a.signinConfig.ssoSignIn.saml.loginParam==""){a.signinConfig.ssoSignIn.saml.loginParam="TARGET"}a.signinConfig.ssoSignIn.saml.loginUrl=g(a.signinConfig.ssoSignIn.saml.loginUrl);a.signinConfig.ssoSignIn.saml.samlUrl=g(a.signinConfig.ssoSignIn.saml.samlUrl);a.signinConfig.ssoSignIn.saml.logoutUrl=g(a.signinConfig.ssoSignIn.saml.logoutUrl)}else if(a.signinConfig.accountSignIn.jwt){if(a.signinConfig.ssoSignIn==null||a.signinConfig.ssoSignIn.jsonWebToken.loginUrl==""||a.signinConfig.ssoSignIn.jsonWebToken.loginUrl==undefined){s.add("请填写完整jsonWebToken配置信息","danger");return}a.signinConfig.ssoSignIn.jsonWebToken.loginUrl=g(a.signinConfig.ssoSignIn.jsonWebToken.loginUrl);a.signinConfig.ssoSignIn.jsonWebToken.logoutUrl=g(a.signinConfig.ssoSignIn.jsonWebToken.logoutUrl)}if(a.signinConfig.ldapSignIn.id==null){a.signinConfig.ldapSignIn=null}a.updateSigninConfigSignInRequest()}else{if(a.signinConfig.ldapSignIn.id==null){a.signinConfig.ldapSignIn=null}a.updateSigninConfigSignInRequest()}};a.ldapInfoChange=function(){a.ldapverify=false};a.updateSigninConfigSignInRequest=function(){var e="null";if(a.signinConfig.type=="ldap"&&a.ldapPassword!=null){e=Base64.encode(a.ldapPassword)}i({url:"signin_config.json",method:"POST",data:a.signinConfig,headers:{Authorization:e}}).success(function(e,t,i,n){if(e.success&&e.id!=null){a.loadSigninConfig();s.add("修改成功！")}else{s.add("修改失败！","danger")}})};a.verifyLdapSetting=function(){if(a.signinConfig.ldapSignIn.server==null||a.signinConfig.ldapSignIn.server==""||a.signinConfig.ldapSignIn.admin==""||a.signinConfig.ldapSignIn.admin==null||a.signinConfig.ldapSignIn.userDirectory==null||a.signinConfig.ldapSignIn.userDirectory==""||a.ldapPassword==null||a.ldapPassword==""||a.signinConfig.ldapSignIn.serverType==null||a.signinConfig.ldapSignIn.serverType==""){s.add("请填写完整ldap配置信息","danger");return}a.signinConfig.ldapSignIn.password="";i({url:"check_ldap_config.json",method:"POST",data:a.signinConfig,headers:{Authorization:Base64.encode(a.ldapPassword)}}).success(function(e,t,i,n){if(e.success){a.ldapverify=true;s.add("验证成功")}else{s.add("验证失败","danger");a.ldapverify=false}})};a.showOppenHelpCenterDiv=function(){_hmt.push(["_trackEvent","社区设置-访问控制","对外公开社区内容"]);a.div.show=3;document.getElementById("access_setting_tab3").checked=true};a.updateProviderHelpcenter=function(){_hmt.push(["_trackEvent","社区设置-访问控制","对外公开社区内容更新"]);i({url:"updateProviderHelpcenter.json",method:"POST",params:{isOpen:a.oppenHelpCenter.isOpen}}).success(function(e,t,i,n){if(e.success==true||e.success=="true"){r.currentProviderIsOpenHelpcenter=a.oppenHelpCenter.isOpen;s.add("修改成功！")}else{s.add("修改失败！","danger")}})};var v=t.item;if(v==="account"){a.showSigninConfigInDiv()}else if(v==="community"){a.showOppenHelpCenterDiv()}else{a.showAccessConfigDiv()}}]).controller("helpcenteruiSettingController",["$scope","$state","$http","alertService","$upload","helpcenterViewService","$filter","$translatePartialLoader","$rootScope",function(a,e,s,i,n,t,r,o,l){a.eweiHelpcenterApiUrl=ConsoleConfig.eweiHelpcenterApiUrl;a.colorOptions={showAlpha:false,replacerClassName:"w200 btn btn-default",cancelText:"取消",chooseText:"确定",showInput:true};a.externalLinks=[{text:"",url:""}];a.helpcenter={name:"易维帮助台帮助中心",logo:{id:"",contentUrl:""},icon:{id:"",contentUrl:""},providerNameColor:"#333333",headBackgroundColor:"#08A99A",linkBackgroundColor:"#1E8CCE",headFontColor:"#FFFFFF",searchBackgroundColor:"#E4E4E4",searchButtonBackgroundColor:"#1E8CCE",saveQuestionButtonBackgroundColor:"#04A650",contentBackgroundColor:"#F0F0F0"};a.helpCenterChannel={title:"联系我们",phone:"",tip:"",webchatForm:{},feedbackForm:{},qq:""};a.webchatForms=[{name:"请选择"}];a.feedbackForms=[{name:"请选择"}];a.viaWeixins=[{name:"请选择"}];s({url:"getHelpCenter.json",method:"GET"}).success(function(e,t,i,n){if(e.json!==undefined){a.helpcenter=e.json;if(a.helpcenter.logo===undefined){a.helpcenter.logo={}}if(a.helpcenter.icon===undefined){a.helpcenter.icon={}}if(e.json.externalLinks!=""){a.externalLinks=e.json.externalLinks}if(e.json.helpCenterChannel!==undefined){a.helpCenterChannel=e.json.helpCenterChannel}s({url:"getCustomWebForm.json",method:"GET",params:{type:"ticket"}}).success(function(e,t,i,n){if(e.json!==undefined){a.feedbackForms=e.json;a.feedbackForms.splice(0,0,{name:"--请选择--"});if(a.helpCenterChannel.feedbackForm===undefined){a.helpCenterChannel.feedbackForm=a.feedbackForms[0]}else{for(var s=0;s<e.json.length;s++){if(e.json[s].id==a.helpCenterChannel.feedbackForm.id){a.helpCenterChannel.feedbackForm=e.json[s];break}}}}else{a.helpCenterChannel.feedbackForm=a.feedbackForms[0]}});s({url:"getCustomWebForm.json",method:"GET",params:{type:"webchat"}}).success(function(e,t,i,n){if(e.json!==undefined){a.webchatForms=e.json;a.webchatForms.splice(0,0,{name:"--请选择--"});if(a.helpCenterChannel.webchatForm===undefined){a.helpCenterChannel.webchatForm=a.webchatForms[0]}else{for(var s=0;s<e.json.length;s++){if(e.json[s].id==a.helpCenterChannel.webchatForm.id){a.helpCenterChannel.webchatForm=e.json[s];break}}}}else{a.helpCenterChannel.webchatForm=a.webchatForms[0]}});s({url:"getViaWeixinList.json",method:"GET"}).success(function(e,t,i,n){if(e.json!==undefined){a.viaWeixins=e.json;a.viaWeixins.splice(0,0,{name:"--请选择--"});if(a.helpCenterChannel.viaWeixin===undefined){a.helpCenterChannel.viaWeixin=a.viaWeixins[0]}else{for(var s=0;s<e.json.length;s++){if(e.json[s].id==a.helpCenterChannel.viaWeixin.id){a.helpCenterChannel.viaWeixin=e.json[s];break}}}}else{a.helpCenterChannel.viaWeixin=a.viaWeixins[0]}})}});a.updateHelpcenter=function(){if(a.helpcenter.logo.id==""){a.helpcenter.logo={}}if(a.helpcenter.icon.id==""){a.helpcenter.icon={}}for(var e=0;e<a.externalLinks.length;e++){if(a.externalLinks[e].text==""){a.externalLinks.splice(e,1)}}a.helpcenter.externalLinks=[];if(a.externalLinks.length>0){a.helpcenter.externalLinks=a.externalLinks}void 0;a.helpcenter.helpCenterChannel=a.helpCenterChannel;org.ewei.sdk.OpenHelpCenterApi().updateProviderHelpCenterBrand({info:a.helpcenter}).then(function(e){if(e.result){i.add("修改成功！")}else{i.add("修改失败！","danger")}})};a.uploadImage=function(e,t){if(e==null||e==undefined||e.length<=0){return}if(e[0].size>52428800){i.add("上传单个附件大小不能超过50M","danger")}else if(e[0].type==undefined||e[0].type==""||e[0].type.indexOf("image/")==-1){i.add("亲，请上传图片！","danger")}else{e.upload=n.upload({url:"upload",method:"POST",file:e});e.upload.then(function(e){if(e.status==200){if(e.data.fileSize>52428800){i.add("上传单个附件大小不能超过50M","danger")}else{if(t=="logo"){a.helpcenter.logo.id=e.data.id;a.helpcenter.logo.contentUrl=e.data.contentUrl}else{a.helpcenter.icon.id=e.data.id;a.helpcenter.icon.contentUrl=e.data.contentUrl}}}else{i.add("请检查文件类型，格式！","danger")}},function(e){a.errorMsg=e.status+": "+e.data});e.upload.progress(function(e){void 0});e.upload.xhr(function(e){e.upload.addEventListener("abort",function(){void 0},false)})}};a.selectchange=function(e){if(a.helpCenterChannel.webchatForm!==undefined&&a.helpCenterChannel.feedbackForm!==undefined){if(a.helpCenterChannel.webchatForm.webFormOutward!==undefined&&a.helpCenterChannel.feedbackForm.webFormOutward!==undefined){if(a.helpCenterChannel.webchatForm.webFormOutward.position==a.helpCenterChannel.feedbackForm.webFormOutward.position){if(e=="ticket"){i.add("您选择的反馈频道会和在线交谈频道重叠！","danger")}else{i.add("您选择的在线交谈频道会和反馈频道重叠！","danger")}}}}};a.toAddAndDeleteExternalLinks=function(e){if(e<0){a.externalLinks.splice(a.externalLinks.length,0,{text:"",url:""})}else{a.externalLinks.splice(e,1)}};a.divShow="ui";a.uiDivShow=function(){if(a.divShow!="ui"){a.divShow="ui"}else{a.divShow=""}};a.layoutDivShow=function(){if(a.divShow!="layout"){a.divShow="layout"}else{a.divShow=""}};a.channelDivShow=function(){if(a.divShow!="channel"){a.divShow="channel"}else{a.divShow=""}};a.footerDivShow=function(){if(a.divShow!="footer"){a.divShow="footer"}else{a.divShow=""}}}]).controller("helpcenterintegralSettingController",["$modal_","$scope","$state","$http","alertService","$upload","helpcenterViewService","$filter","$translatePartialLoader","$rootScope","ConsoleConfig","coreModelService",function(e,s,t,i,n,a,r,o,l,c,u,d){s.eweiHelpcenterApiUrl=u.eweiHelpcenterApiUrl;if(u.user.role.nameKey!="ROLE_NAME_EDITOR"){t.go("system_setting.detail",{uri:"my_account",settingType:"system"});return}s.displayPublic=true;s.displayPrivate=false;s.userIntegralConfig={validRule:"false",validAd:false,adImage:{},adUrl:"http://",integralRule:{id:0,attentionSmallAppScore:200,joinQuestionnaireMaxScore:30,joinQuestionnaireScore:10,registerScore:200,installAppScore:100,ticketScore:10,ticketMonthlyMaxScore:30,articleCommentScore:50,articleCommentMonthlyMaxScore:200,questionScore:50,questionMonthlyMaxScore:200,answerScore:100,answerMonthlyMaxScore:500,votedScore:100,votedMonthlyMaxScore:500,shareScore:20,shareMonthlyMaxScore:100,ticketPenalty:-20,articleCommentPenalty:-20,questionPenalty:-20,answerPenalty:-20,questionToTickeScore:70,questionToTickeMaxScore:280}};s.userBadgeConfig=[{borderScore:1,badge:""}];s.ids=[];var p=d.config.route.get("system.setting.integral.show");s.display=p===undefined?true:p;org.ewei.sdk.OpenHelpCenterSettingApi().getUserIntegralConfig({}).then({success:function(e){if(e!==undefined){s.userIntegralConfig=e;s.userIntegralConfig.adUrl=e.adUrl==undefined?"http://":e.adUrl;s.userIntegralConfig.validAd=e.validAd;s.userIntegralConfig.validRule=e.validRule+"";s.userIntegralConfig.id=e.id;if(e.adImage!==undefined){s.userIntegralConfig.adImage.id=e.adImage.id;s.userIntegralConfig.adImage.contentUrl=e.adImage.contentUrl}if(e.integralRule!==undefined){s.userIntegralConfig.integralRule=e.integralRule}}}});s.checkNumber=function(e){var t=$("#"+e).val();var i=/^-?[0-9]\d*$/;if(!i.exec(t)){n.add("请输入正确的数字！","danger");$("#"+e).focus()}};s.integralShow=function(){s.display=true;i({url:"getUserIntegralConfigByProvider.json",method:"GET"}).success(function(e,t,i,n){if(e.json!==undefined){s.userIntegralConfig=e.json;s.userIntegralConfig.adUrl=e.json.adUrl==undefined?"http://":e.json.adUrl;s.userIntegralConfig.validAd=e.json.validAd;s.userIntegralConfig.validRule=e.json.validRule+"";s.userIntegralConfig.id=e.json.id;if(e.json.adImage!==undefined){s.userIntegralConfig.adImage.id=e.json.adImage.id;s.userIntegralConfig.adImage.contentUrl=e.json.adImage.contentUrl}if(e.json.integralRule!==undefined){s.userIntegralConfig.integralRule=e.json.integralRule}}})};s.badgeShow=function(){s.display=false;org.ewei.sdk.OpenHelpCenterSettingApi().getUserBadgeConfig({}).then({success:function(e){if(e!==undefined&&e!=""){s.userBadgeConfig=e}}})};if(p!=undefined){if(s.display){s.integralShow()}else{s.badgeShow()}}s.updateUserIntegralConfig=function(){_hmt.push(["_trackEvent","社区设置-积分规则","更新积分规则"]);if(parseInt(s.userIntegralConfig.integralRule.ticketMonthlyMaxScore)<parseInt(s.userIntegralConfig.integralRule.ticketScore)){n.add("帮助中心提交工单月封顶不能小于单个积分！","danger");return}if(parseInt(s.userIntegralConfig.integralRule.joinQuestionnaireMaxScore)<parseInt(s.userIntegralConfig.integralRule.joinQuestionnaireScore)){n.add("参加问卷调查封顶不能小于单个积分！","danger");return}if(parseInt(s.userIntegralConfig.integralRule.articleCommentMonthlyMaxScore)<parseInt(s.userIntegralConfig.integralRule.articleCommentScore)){n.add("文章后面追问/评论月封顶不能小于单个积分！","danger");return}if(parseInt(s.userIntegralConfig.integralRule.questionMonthlyMaxScore)<parseInt(s.userIntegralConfig.integralRule.questionScore)){n.add("社区提问/发帖月封顶不能小于单个积分！","danger");return}if(parseInt(s.userIntegralConfig.integralRule.answerMonthlyMaxScore)<parseInt(s.userIntegralConfig.integralRule.answerScore)){n.add("回答别人的提问/跟贴月封顶不能小于单个积分！","danger");return}if(parseInt(s.userIntegralConfig.integralRule.votedMonthlyMaxScore)<parseInt(s.userIntegralConfig.integralRule.votedScore)){n.add("回答/跟贴被赞月封顶不能小于单个积分！","danger");return}if(parseInt(s.userIntegralConfig.integralRule.shareMonthlyMaxScore)<parseInt(s.userIntegralConfig.integralRule.shareScore)){n.add("转发/分享社区内容到社交平台月封顶不能小于单个积分！","danger");return}if(parseInt(s.userIntegralConfig.integralRule.questionToTickeMaxScore)<parseInt(s.userIntegralConfig.integralRule.questionToTickeScore)){n.add("提问/发帖被转为工单月封顶不能小于单个积分！","danger");return}org.ewei.sdk.OpenHelpCenterSettingApi().updateUserIntegralConfig({userIntegralConfig:s.userIntegralConfig}).then({success:function(e){if(e>0){n.add("更新成功")}else{n.add("修改失败！","danger")}}})};s.uploadImage=function(e){if(e==null||e==undefined||e.length<=0){return}if(e.size>204800){n.add("上传单个附件大小不能超过200K","danger")}else{e.upload=a.upload({url:"upload",method:"POST",file:e});e.upload.then(function(e){if(e.status==200){if(e.data.fileSize>204800){n.add("上传单个附件大小不能超过200K","danger")}else{void 0;s.userIntegralConfig.adImage=e.data}}else{n.add("请检查文件类型，格式！","danger")}},function(e){s.errorMsg=e.status+": "+e.data});e.upload.progress(function(e){void 0});e.upload.xhr(function(e){e.upload.addEventListener("abort",function(){void 0},false)})}};s.toAddAndDeleteFields=function(e){_hmt.push(["_trackEvent","社区设置-设置头衔","新增积分区间"]);if(e<0){s.userBadgeConfig.splice(s.userBadgeConfig.length,0,{id:0,borderScore:s.userBadgeConfig.length*1e3,badge:""})}else{if(s.userBadgeConfig[e].id>0){s.ids.splice(s.ids.length,0,s.userBadgeConfig[e].id)}s.userBadgeConfig.splice(e,1)}};s.updateUserBadgeConfig=function(){_hmt.push(["_trackEvent","社区设置-积分规则","更新设置头衔"]);if(s.userBadgeConfig!=""){var e=false;for(var t=0;t<s.userBadgeConfig.length;t++){for(var i=0;i<s.userBadgeConfig.length;i++){if(t==i){continue}if(s.userBadgeConfig[t].borderScore==s.userBadgeConfig[i].borderScore){e=true;break}}if(e){break}}if(e){n.add("积分区间不能相同！","danger");return}}org.ewei.sdk.OpenHelpCenterSettingApi().updateUserBadgeConfig({userBadgeConfigs:s.userBadgeConfig}).then({success:function(e){if(e!==undefined){s.userBadgeConfig=e;n.add("修改成功！")}else{n.add("修改失败！","danger")}}})};s.$on("$destroy",function(){d.config.route.put("system.setting.integral.show",s.display)})}]).directive("submitTicketSetForm",[function(){return{restrict:"EA",link:function(e,t,i){var n=t[0].getElementsByTagName("ul");n[1].onclick=function(e){var e=e||window.event;var i=e.srcElement||e.target;if(i.nodeName.toLowerCase()=="i"){i.previousElementSibling.focus();i.previousElementSibling.onkeypress=function(e){var t=e||window.event;if(t.keyCode==13){i.previousElementSibling.blur()}}}else if(i.nodeName.toLowerCase()=="input"){}else{var t=document.getElementById("ticketCustomFieldsListBox");var n=t.getElementsByTagName("input");for(var s=0;s<n.length;s++){n[s].blur()}}}}}}]);angular.module("eweiApp.system_setting").controller("uiv2_controller",["$scope","$state","$http","alertService","$upload","helpcenterViewService","$filter","$translatePartialLoader","$rootScope","EweiConfig","ConsoleConfig","apiBrandSettingService","coreModelService","coreNotifyService",function(i,e,t,n,s,a,r,o,l,c,u,d,p,f){i.colorOptions={showAlpha:false,replacerClassName:"w300 btn btn-default",cancelText:"取消",chooseText:"确定",showInput:true};var m=f.constant.EVENT_DETAIL_BRAND_SETTING_HELPCENTER;var g=this.__proto__.constructor.name+"_"+(new Date).valueOf();var v=function(){f.register(g,m,function(e){y()})};var h=function(){y();_()};var y=function(){i.helpcenter=p.config.brandSetting.helpCenter||{};void 0;if(!i.helpcenter.logo){i.helpcenter.logo={}}if(!i.helpcenter.icon){i.helpcenter.icon={}}if(i.helpcenter.rewardEnabled===undefined){i.helpcenter.rewardEnabled=true}};var _=function(){d.getHelpCenter(m,"","",function(e){f.doNotify(m)})};var k=function(){v();h()};k();var C=function(){f.unRegister(g)};i.$on("$destroy",function(){C()});i.uploadImage=function(e,t){if(e==null||e==undefined||e.length<=0){return}if(e[0].size>51200){n.add("上传LOGO大小不能超过50KB。","danger")}else if(e[0].type==undefined||e[0].type==""||e[0].type.indexOf("image/")==-1){n.add("亲，请上传图片！","danger")}else{e.upload=s.upload({url:"upload",method:"POST",file:e});e.upload.then(function(e){if(e.status==200){if(e.data.fileSize>51200){n.add("上传LOGO大小不能超过50KB。","danger")}else{if(t=="logo"){i.helpcenter.logo.id=e.data.id;i.helpcenter.logo.contentUrl=e.data.contentUrl}else{i.helpcenter.icon.id=e.data.id;i.helpcenter.icon.contentUrl=e.data.contentUrl}}}else{n.add("请检查文件类型，格式！","danger")}},function(e){i.errorMsg=e.status+": "+e.data});e.upload.progress(function(e){void 0});e.upload.xhr(function(e){e.upload.addEventListener("abort",function(){void 0},false)})}};i.updateHelpcenter=function(){org.ewei.sdk.OpenHelpCenterApi().updateProviderHelpCenterBrand({info:i.helpcenter}).then(function(e){if(e){n.add("修改成功！")}else{n.add("修改失败！","danger")}})}}]).controller("layout_Controller",["$scope","$state","permissions","coreModelService",function(e,t,i,n){var s=n.config.route.get("system-setting.detai.layout");if(!s){s={name:"system_setting.detail.layout"}}t.go(s.name,s.params)}]);(function(Y){angular.module("eweiApp.ticket").controller("ticketSettingDetailController",["$modal_","$uibModal","$rootScope","$scope","$state","utils","$stateParams","$http","serviceDesks","alertService","$upload","permissions","$filter","$location","ConsoleConfig","NgTableParams","quickreplyService","ticketTemplateListService","ticketEvaluateService","apiCustomTicketViewsService","coreNotifyService","coreModelService","license","$timeout","apiWorkingDayService","apiListWorkflowsService",function(c,e,r,u,o,t,l,d,n,p,s,f,m,a,g,v,h,y,_,k,C,b,w,T,S,F){u.eweiHelpcenterApiUrl=g.eweiHelpcenterApiUrl;if("ticket_type"===l.uri){u.editTicketType=function(r,o){o?_hmt.push(["_trackEvent","工单类型","克隆工单类型"]):_hmt.push(["_trackEvent","工单类型","编辑工单类型"]);var e;var l=u;u.isClick=false;l.newTicketType=angular.copy(r);e=c({scope:l,title:"编辑工单类型",contentTemplate:"source/views/ticket/ticket_type_add.html",html:true,show:true,placement:"center"});u.hideModal=function(){e.$promise.then(e.hide)};l.$save=function(a){u.isClick=true;if(a.name==""){p.add("请输入类型","danger");u.isClick=false;return}if(a.description.length>255){p.add("描述长度不超过255个字符","danger");u.isClick=false;return}if(o){a.id=0}d({url:"ticket_type",method:"POST",data:a}).success(function(e,t,i,n){userAginLogin(e);if(e.success){u.isClick=false;if(o){var s={id:e.id,name:a.name,description:a.description};u.ticketTypes.push(s)}else{r.name=a.name;r.description=a.description}void 0;u.hideModal()}else{if(e.message!=null){p.add(m("translate")(e.message),"danger");l.isClick=false;return}p.add("更新失败","danger")}})}};u.deleteTicketType=function(s,e){_hmt.push(["_trackEvent","工单类型","删除工单类型"]);if(confirm("如果此工单类型已经关联一个工单，此工单的工单类型将被清空，您确定删除工单类型:"+e.name+" 吗?")){d({url:"ticket_type/"+e.id,method:"delete",params:{}}).success(function(e,t,i,n){userAginLogin(e);if(e.success){u.ticketTypes.splice(s,1)}else{p.add("删除失败","danger")}})}};u.addTicketType=function(){_hmt.push(["_trackEvent","工单类型","添加工单类型"]);u.isClick=false;var e;var t=u;if(undefined!=t.newTicketType){t.newTicketType.name="";t.newTicketType.description=""}e=c({scope:t,title:"编辑工单类型",contentTemplate:"source/views/ticket/ticket_type_add.html",html:true,show:true,placement:"center"});u.hideModal=function(){e.$promise.then(e.hide)};t.$save=function(a){a.id=0;u.isClick=true;if(!angular.isUndefined(a)){if(angular.isUndefined(a.name)||a.name==""){void 0;u.isClick=false;return}}else{void 0;u.isClick=false;return}d({url:"ticket_type",method:"POST",data:a}).success(function(e,t,i,n){userAginLogin(e);if(e.success){var s={id:e.id,name:a.name,description:a.description};u.ticketTypes.push(s);void 0;u.hideModal()}else{if(e.message!=null){p.add(m("translate")(e.message),"danger");u.isClick=false;return}p.add("添加失败","danger")}})}};u.queryTicketTypes=function(){d.get("ticket_type.json?_fields=id,name,description,isDefault&_count=1111111&_do_count=false").success(function(e,t){userAginLogin(e);if(typeof e=="string"){p.add("未经授权无法访问！","danger","right",3e3,0,true)}else{u.ticketTypes=e.ticketTypes}})};u.queryTicketTypes()}else if("ticket_custom_field"===l.uri){u.editTicketCustomField=function(e,t){u.TicketCustomFieldData={add:"添加字段",update:"编辑字段",copy:"克隆字段"};if(u.TicketCustomFieldData[t]){_hmt.push(["_trackEvent","自定义工单字段",u.TicketCustomFieldData[t]])}o.go("system_setting.ticket_custom_field_edit",{id:e,type:t})};u.activeTicketCustomField=function(e,s,t){var i=s.ticketCustomField;u.confirmContent="如果该字段在自定义视图里被使用，则需要你更新相应视图，并且历史工单内的该字段也会被删除。你确定要删除该自定义工单字段吗？";var n=c({scope:u,title:"确认",contentTemplate:"source/views/confirm_template.html",html:true,show:true,placement:"center"});u.hideModal=function(){n.$promise.then(n.hide)};u.$ok=function(){d({url:"custom_field/"+i.id+".json",method:"delete"}).success(function(e,t,i,n){userAginLogin(e);u.hideModal();if(e.success){s.$parent.ticketCustomFieldsNoActive.remove(s.ticketCustomField)}else{p.add("删除失败","danger")}})}};u.enabled=function(t,i){i?_hmt.push(["_trackEvent","网页表单","启用网页表单"]):_hmt.push(["_trackEvent","网页表单","停用网页表单"]);if(!i){if(confirm("您确定停用吗?")){d({url:"enable_custom_field/"+t.ticketCustomField.id+".json",method:"put",params:{enable:i}}).success(function(e){if(e.success){t.ticketCustomField.active=i;u.ticketCustomFieldsNoActive.push(t.ticketCustomField);u.ticketCustomFieldsActive.splice(u.ticketCustomFieldsActive.indexOf(t.ticketCustomField),1)}else{p.add(e.message,"danger")}})}}else{d({url:"enable_custom_field/"+t.ticketCustomField.id+".json",method:"put",params:{enable:i}}).success(function(e){if(e.success){t.ticketCustomField.active=i;u.ticketCustomFieldsActive.push(t.ticketCustomField);u.ticketCustomFieldsNoActive.splice(u.ticketCustomFieldsNoActive.indexOf(t.ticketCustomField),1)}else{p.add(e.message,"danger")}})}};d.get("custom_field.json?scope=ticket&ignore_scan_able=true").success(function(e,t){userAginLogin(e);u.ticketCustomFields=e.json;A(u.ticketCustomFields)});function A(e){u.ticketCustomFieldsActive=[];u.ticketCustomFieldsSystem=[];u.ticketCustomFieldsNoActive=[];for(var t=0;t<e.length;t++){if(e[t].systemFieldKey){u.ticketCustomFieldsSystem.push(e[t])}else if(e[t].active){u.ticketCustomFieldsActive.push(e[t])}else{u.ticketCustomFieldsNoActive.push(e[t])}}}u.sortableOptions={"ui-floating":false,handle:".myHandle",update:function(e,t){},stop:function(e,t){var i={ids:[],values:[]};u.allTicketCustomFields=u.ticketCustomFieldsSystem.concat(u.ticketCustomFieldsActive);u.allTicketCustomFields=u.allTicketCustomFields.concat(u.ticketCustomFieldsNoActive);for(var n=0;n<u.allTicketCustomFields.length;n++){i.ids.push(u.allTicketCustomFields[n].id);i.values.push(n+1)}d({url:"updateCustomFieldOrderKey.json",method:"POST",data:i}).success(function(e,t,i,n){userAginLogin(e)})}}}else if("ticket_list_custom"===l.uri){u.argument={_count:0,_page:1};var E=C.constant.EVENT_LIST_CUSTOM_TICKETVIEWS;var $=this.__proto__.constructor.name+"_"+(new Date).valueOf();var O=function(){I();L()};var I=function(){C.register($,E,function(e){x()})};var L=function(){x();if(JSON.stringify(u.argument)!==JSON.stringify(u.argumentLast)){P();u.argumentLast=angular.copy(u.argument)}};var D=function(){C.unRegister($)};var P=function(){k.run(E,"",u.argument,function(e){})};var x=function(){var e=b.detail.custom.ticketViews.gets(b.list.custom.ticketViews.gets(u.argument._page));u.defaultCustomList=[];u.defaultEnableList=[];u.defaultDisabledList=[];u.publicCustomList=[];u.publicEnableList=[];u.publicDisabledList=[];u.privateCustomList=[];u.privateEnableList=[];u.privateDisabledList=[];if(e&&e.length>0){angular.forEach(e,function(e){if(e.isSystemDefault){u.defaultCustomList.push(e);if(e.active){u.defaultEnableList.push(e)}else{u.defaultDisabledList.push(e)}}else{if(!e.engineer){u.publicCustomList.push(e);if(e.active){u.publicEnableList.push(e)}else{u.publicDisabledList.push(e)}}else{u.privateCustomList.push(e);if(e.active){u.privateEnableList.push(e)}else{u.privateDisabledList.push(e)}}}})}};O();u.$on("$destroy",function(){D();b.config.route.put("system.setting.ticket_list_custom.showType",u.showType)});var N=b.config.route.get("system.setting.ticket_list_custom.showType")||"default";u.viewManage=f.hasPermission("ticket_view_manage")?true:false;u.showType=f.hasPermission("ticket_view_manage")?r.customViewType?r.customViewType:N:"private";u.switching=function(e){u.showType=e;r.customViewType=e};u.switching(u.showType);u.enabled=function(t,i){var e={enable:i};if(!i){if(confirm("您确定停用吗?")){d({url:"enable_view/"+t.list.id+".json",method:"put",params:e}).success(function(e){if(e.success){t.list.active=i;k.enabled(t.list.id,i);if(!t.list.engineer){u.publicDisabledList.push(t.list);u.publicEnableList.remove(t.list)}else{u.privateDisabledList.push(t.list);u.privateEnableList.remove(t.list)}}else{p.add(e.message,"danger")}})}}else{d({url:"enable_view/"+t.list.id+".json",method:"put",params:e}).success(function(e){if(e.success){t.list.active=i;k.enabled(t.list.id,i);if(!t.list.engineer){u.publicDisabledList.remove(t.list);u.publicEnableList.push(t.list)}else{u.privateDisabledList.remove(t.list);u.privateEnableList.push(t.list)}}else{p.add(e.message,"danger")}})}};u.editTicketListCustom=function(e,t){u.TicketListCustomData={add:"添加",update:"编辑",copy:"克隆"};if(u.TicketListCustomData[t]){_hmt.push(["_trackEvent","自定义工单视图",u.TicketListCustomData[t]])}o.go("system_setting.ticket_list_custom_edit",{id:t=="add"?e:e.id,type:t,isSystemDefault:e.isSystemDefault?1:0})};u.deleteTicketListCustom=function(s,e){_hmt.push(["_trackEvent","自定义工单视图","删除"]);u.confirmContent="您确定要删除自定义视图吗？";var t=c({scope:u,title:"确认",contentTemplate:"source/views/confirm_template.html",html:true,show:true,placement:"center"});u.hideModal=function(){t.$promise.then(t.hide)};u.$ok=function(){d({url:"delete_view.json",method:"DELETE",params:{id:s.id}}).success(function(e,t,i,n){userAginLogin(e);u.hideModal();if(e.success){k.remove(s.id);if(!s.engineer){u.publicDisabledList.remove(s);u.publicCustomList.remove(s)}else{u.privateDisabledList.remove(s);u.privateCustomList.remove(s)}}else{p.add("删除失败","danger")}})}}}else if("ticket_template"===l.uri){var M=b.config.route.get("system.setting.ticket_public_template.showType")||"public";if(!f.hasPermission("ticket_public_template")){M="private"}u.showType=M;u.edit=f.hasPermission("ticket_public_template");if(u.showType=="public"){u.displayPublic=true;u.displayPrivate=false}else{u.displayPublic=false;u.displayPrivate=true}u.$on("$destroy",function(){b.config.route.put("system.setting.ticket_public_template.showType",u.showType)});u.publicTicketTemplets=[];u.privateTicketTemplets=[];y.run("",{_fields:"id,name,engineer.id",_count:1e4,_do_count:false,_asc:"orderKey"},true,function(e){userAginLogin(e);var t=e.ticketTemplates;for(var i=0,n=t.length;i<n;i++){if(t[i].engineer!=undefined){u.privateTicketTemplets.push(t[i])}else{u.publicTicketTemplets.push(t[i])}}if(u.showType=="public"){u.ticketTemplates=u.publicTicketTemplets}else{u.ticketTemplates=u.privateTicketTemplets}});u.singleTemplate={"ui-floating":false,handle:".myHandle",stop:function(e,t){var i={ids:[],values:[]};for(var n=0;n<u.ticketTemplates.length;n++){void 0;i.ids.push(u.ticketTemplates[n].id);i.values.push(n+1)}d({url:"updateTicketInfosOrderKey.json",method:"POST",data:i}).success(function(e,t,i,n){userAginLogin(e)})}};u.switching=function(e){if(e=="public"){u.ticketTemplates=u.publicTicketTemplets;u.displayPublic=true;u.displayPrivate=false}else{u.ticketTemplates=u.privateTicketTemplets;u.displayPublic=false;u.displayPrivate=true}u.showType=e};u.deleteTicketTemplate=function(s,e){_hmt.push(["_trackEvent","工单模板","删除工单模板"]);if(confirm("您确定删除吗?")){d({url:"ticket_template/"+e.id,method:"DELETE"}).success(function(e,t,i,n){if(e.success){u.ticketTemplates.splice(s,1)}else{void 0}})}};u.toEditTicketTemplate=function(e,t){o.go("system_setting.ticket_template_edit",{id:e,type:t})}}else if("workflow_templet"===l.uri){var M=b.config.route.get("system.setting.workflow_templet.showType")||"public";if(!f.hasPermission("ticket_public_workflow")){M="private"}u.showType=M;u.edit=f.hasPermission("ticket_public_workflow");if(u.showType==="public"){u.displayPublic=true;u.displayPrivate=false}else{u.displayPublic=false;u.displayPrivate=true}u.$on("$destroy",function(){b.config.route.put("system.setting.workflow_templet.showType",u.showType)});F.getWorkflowTemplate("list.workflows",{page:{pageNumber:1,pageSize:9999}},function(e){u.publicWorkflowTemplets=[];u.privateWorkflowTemplets=[];for(var t=0,i=e.length;t<i;t++){if(e[t].engineerId!==undefined){u.privateWorkflowTemplets.push(e[t])}else{u.publicWorkflowTemplets.push(e[t])}}if(u.showType==="public"){u.workflowTemplets=u.publicWorkflowTemplets;u.displayPublic=true;u.displayPrivate=false}else{u.workflowTemplets=u.privateWorkflowTemplets;u.displayPublic=false;u.displayPrivate=true}});u.switching=function(e){if(e=="public"){u.workflowTemplets=u.publicWorkflowTemplets;u.displayPublic=true;u.displayPrivate=false}else{u.workflowTemplets=u.privateWorkflowTemplets;u.displayPublic=false;u.displayPrivate=true}u.showType=e};u.deleteWorkflowTemplate=function(t,e){if(confirm("您确定删除吗?")){Y.sdk.OpenActivitiWorkflowTemplateApi().deleteById({id:e.id}).then({success:function(e){u.workflowTemplets.splice(t,1)},fail:function(){p.add("删除失败","danger")}})}};u.toEditWorkflowTemplate=function(e,t){o.go("system_setting.workflow_template_edit",{id:e,type:t})}}else if("common_url"===l.uri){r.language="zh";var j="ticket1";r[j]={time:(new Date).getTime()};u.$watch(j,function(){n.query(function(e){u.serviceDesks=e.serviceDesks})},true);n.get({id:1},function(e){u.serviceDeskDetail=e.serviceDesk});var R={id:null,name:"服务台5",notes:null,deleted:false,createdAt:"2008-08-08 18:08:08",updatedAt:"2006-06-06 18:08:08"};n.add(R,function(e){void 0})}else if("quick_reply"===l.uri){var M=b.config.route.get("system.setting.ticket_public_quick_reply.showType")||"public";if(M=="public"&&!f.hasPermission("ticket_public_quick_reply")){M="private"}u.showType=M;u.edit=f.hasPermission("ticket_public_quick_reply");if(u.showType=="public"){u.displayPublic=true;u.displayPrivate=false}else{u.displayPublic=false;u.displayPrivate=true}u.$on("$destroy",function(){b.config.route.put("system.setting.ticket_public_quick_reply.showType",u.showType)});u.tableParams=new v({page:1,count:5,sorting:{id:"desc"}},{counts:[5,10,15,20]});u.queryQuickReplys=function(){h.run("",{_fields:"id,title,content,engineer.id",_count:1e4,_do_count:false},true,function(e){userAginLogin(e);u.publicQuickReplys=[];u.privateQuickReplys=[];var t=e.quickReplys;for(var i=0,n=t.length;i<n;i++){if(t[i].engineer!=undefined){u.privateQuickReplys.push(t[i])}else{u.publicQuickReplys.push(t[i])}}if(u.showType=="public"){u.quickReplys=u.publicQuickReplys}else{u.quickReplys=u.privateQuickReplys}u.tableParams.settings({data:u.quickReplys})})};u.queryQuickReplys();u.switching=function(e){if(e=="public"){u.quickReplys=u.publicQuickReplys;u.displayPublic=true;u.displayPrivate=false}else{u.quickReplys=u.privateQuickReplys;u.displayPublic=false;u.displayPrivate=true}u.showType=e;u.tableParams.settings({data:u.quickReplys})};function U(e){if(!e.id){return org.ewei.sdk.OpenQuickReplyApi().save({quickreply:e})}return org.ewei.sdk.OpenQuickReplyApi().update({quickreply:e})}u.editquickReply=function(e,n,t){_hmt.push(["_trackEvent","快捷回复","快捷回复-添加或更新快捷回复"]);if(t==="add"){_hmt.push(["_trackEvent","快捷回复","添加快捷回复"])}else if(t==="edit"){_hmt.push(["_trackEvent","快捷回复","编辑快捷回复"])}else{_hmt.push(["_trackEvent","快捷回复","克隆快捷回复"])}u.isClick=false;var i;var s=u;s.iscopy=n;s.quickReplyDetail=angular.copy(e);s.selectItems=[{id:0,option:"私有(仅个人可用)"}];if(f.hasPermission("ticket_public_quick_reply")){s.selectItems.push({id:1,option:"公有"})}if(e==undefined){if(u.showType=="public"){s.selectInfo=s.selectItems[1]}else{s.selectInfo=s.selectItems[0]}}else{if(e.engineer!=undefined){s.selectInfo=s.selectItems[0]}else{s.selectInfo=s.selectItems[1]}}i=c({scope:s,title:"快捷回复",contentTemplate:"source/views/ticket/setting.quick_reply_add.html",html:true,show:true,placement:"center"});u.hideModal=function(){i.$promise.then(i.hide)};u.change=function(e){if(e){s.selectInfo=e}};s.$save=function(e){u.isClick=true;if(!angular.isUndefined(e)){if(angular.isUndefined(e.title)||e.title==""){p.add("请输入快捷词1","danger");u.isClick=false;return}if(angular.isUndefined(e.content)||e.content==""){p.add("请输入完整消息","danger");u.isClick=false;return}}else{p.add("请输入快捷词2","danger");u.isClick=false;return}var t={};if(n){t.id=0}else{t.id=e.id}t.content=e.content;t.title=e.title;var i=s.selectInfo.id==0?"private":"public";if(i==="private"){t.engineer=g.engineer}U(t).then(function(e){if(e){void 0;_hmt.push(["_trackEvent","快捷回复","快捷回复-添加或更新快捷回复-更新"]);u.switching(i);u.queryQuickReplys();u.hideModal()}else{p.add("添加失败","danger");u.isClick=false}})}};u.deleteQuickReply=function(i){_hmt.push(["_trackEvent","快捷回复","删除快捷回复"]);u._messages="您确定删除吗?";var n=c({scope:u,title:"删除确认",contentTemplate:"source/views/alter_common.html",html:true,show:true,placement:"center"});u.$ok=function(){if(u.quickReplys.indexOf(i)===-1){return false}u.isLoading=true;org.ewei.sdk.OpenQuickReplyApi().delete({id:i.id}).then(function(e){if(e){for(var t=0;t<u.quickReplys.length;t++){if(u.quickReplys[t].id===i.id){u.quickReplys.splice(t,1);u.tableParams.settings({data:u.quickReplys,hasDatasetChanged:true})}}p.add("删除成功","success");n.$promise.then(n.hide)}else{p.add("删除失败","danger")}u.isLoading=false})};u.$hide=function(){n.$promise.then(n.hide)}}}else if("service_catalog"===l.uri){u.uploading=false;u.uploadFile=function(e){if(e==null||e==undefined||e.length<=0){return}if(e[0].size>52428800){p.add("上传单个附件大小不能超过50M","danger")}else{e.upload=s.upload({url:"import_service_catalog",method:"POST",file:e});e.upload.then(function(e){u.uploading=false;if(e.data.success){p.add("导入成功！");u.loadServiceCatalog()}else if(e.data.message){p.add(e.data.message,"danger")}else{p.add("请检查文件类型，格式！","danger")}void 0},function(e){u.uploading=false;u.errorMsg=e.status+": "+e.data});e.upload.progress(function(e){u.uploading=true;void 0});e.upload.xhr(function(e){e.upload.addEventListener("abort",function(){void 0;u.uploading=false},false)})}};u.parameters={emptyPlaceholderEnabled:false,maxDepth:10,dragDelay:0,dragDistance:0,lockX:false,lockY:false,boundTo:"",spacing:20,coverage:50,cancelKey:"esc",copyKey:"shift",selectKey:"ctrl",enableExpandOnHover:true,expandOnHover:500};u.callbacks={beforeDrop:function(e){if(e&&e.dest&&e.dest.nodesScope&&e.source&&e.source.nodesScope){return e.dest.nodesScope.$id===e.source.nodesScope.$id}return false},dropped:function(e){var t=e&&e.dest&&e.dest.nodesScope&&e.dest.nodesScope.$modelValue;if(!angular.isArray(t)&&t.length<1){return false}var i={ids:[],values:[]};for(var n=0;n<t.length;n++){i.ids.push(t[n].id);i.values.push(n)}d({url:"service_catalog_change_orderkey.json",method:"POST",data:i}).success(function(e){if(e.success){p.add("拖动成功")}else{p.add("拖动失败","danger","left")}})}};var V=function(e,t){d.get("/service_catalog_list.json?parentId="+e).success(function(e){userAginLogin(e);if(t){if(e.success&&e.json){t(e.json)}}})};V(0,function(e){void 0;maincatalog=e;var t=[{id:0,name:"服务目录",bottom:false,items:maincatalog}];u.serviceCatalogs=t});u.getNextCatalog=function(t,e){if(e&&t.id>0&&!t.items){V(t.id,function(e){void 0;if(e.length){t.items=e}})}};u.ticketServiceExcelBuried=function(){_hmt.push(["_trackEvent","服务目录","下载Excel模板"])};u.ticketServiceImportBuried=function(){_hmt.push(["_trackEvent","服务目录","导入"])};u.ticketServiceExportBuried=function(){_hmt.push(["_trackEvent","服务目录","导出"])};u.deleteServiceCatalog=function(e,s){var t=0;if(!s.parent){for(var i=0;i<u.serviceCatalogs[0].items.length;i++){var n=u.serviceCatalogs[0].items[i];if(n&&n.id>-1){t++}}if(t<2){p.add("请至少保留一个服务目录","danger");return}}_hmt.push(["_trackEvent","服务目录","删除子节点"]);if(confirm("如果此服务目录已经关联一个工单，此工单的服务目录将被清空，您确定删除服务目录:"+s.name+" 吗?")){d({url:"service_catalog",method:"DELETE",params:{id:s.id}}).success(function(e,t,i,n){userAginLogin(e);if(e.success){void 0;s.id=-1}else{p.add("删除失败","danger")}})}};u.batchModifyChildrenServiceDesk=function(e){var t=0;if(e.items){t=e.items.length}for(var i=0;i<t;i++){e.items[i].serviceDesk=e.serviceDesk;u.batchModifyChildrenServiceDesk(e.items[i])}};u.editServiceCatalog=function(e,a,r){if(r==="add"){_hmt.push(["_trackEvent","服务目录","添加子节点"])}else{_hmt.push(["_trackEvent","服务目录","编辑子节点"])}u.isClick=false;var t;var i=u;var o=e.$modelValue;if(r=="edit"){i.serviceCatalogDetail=angular.copy(a)}else{i.serviceCatalogDetail={};if(a.id!=0){i.serviceCatalogDetail.parent={id:a.id}}var n=false;if(a.parent!=undefined&&a.parent.parent!=undefined&&a.parent.parent.parent!=undefined&&(a.parent.parent.parent.parent==undefined||a.parent.parent.parent.parent.id==undefined||a.parent.parent.parent.parent.id<=0)){n=true}if(n){i.serviceCatalogDetail.bottom=true}else{i.serviceCatalogDetail.bottom=false}}t=c({scope:i,title:"服务目录",contentTemplate:"source/views/ticket/setting.serviceCatalog_edit.html",html:true,show:true,placement:"center"});u.hideModal=function(){t.$promise.then(t.hide)};i.$save=function(s){u.isClick=true;if(s.name==undefined||s.name==""){p.add("请输入服务目录名","danger");u.isClick=false;return}d({url:"service_catalog.json",method:"POST",data:s}).success(function(e,t,i,n){userAginLogin(e);if(e.success){u.hideModal();if(r=="edit"){a.name=s.name;a.serviceDesk=s.serviceDesk?s.serviceDesk:null}if(e.json!=undefined){if(o.id>0){e.json.parent={id:o.id,name:o.name,parent:o.parent}}if(o.items!=undefined){o.items.push(e.json)}else{o.items=[];o.items.push(e.json)}p.add("新增成功！")}else{p.add("更新成功！")}}else{p.add("更新失败","danger");u.isClick=false}})}}}else if("sla"===l.uri){u.pageSize=500;u.currentPage=1;u.allCount=0;u.pageCount=0;u.slaList=[];u.filterGroupName="";u.getPagedDataAsync=function(e){if(e<=0){e=1}else if(e>u.pageCount&&u.pageCount>0){e=u.pageCount}u.currentPage=e;var t="";var i="ticket_sla.json?_count="+u.pageSize+"&_page="+e+"&_fields="+t;d({url:i,method:"GET",params:{userGroupName:u.filterGroupName}}).success(function(e,t,i,n){userAginLogin(e);u.slaList=e.slaList;u.allCount=e._total;u.pageCount=parseInt(u.allCount/u.pageSize)+1})};u.queryByFilter=function(){u.getPagedDataAsync(1)};u.getPagedDataAsync(u.currentPage);u.toEditSla=function(e,t){if(t==="add"){_hmt.push(["_trackEvent","SLA","添加SLA"])}else if(t==="modify"){_hmt.push(["_trackEvent","SLA","编辑SLA"])}else{_hmt.push(["_trackEvent","SLA","克隆SLA"])}o.go("system_setting.sla_edit",{id:e,type:t})};u.deleteSla=function(e,t){_hmt.push(["_trackEvent","SLA","删除SLA"]);if(confirm("您确定删除吗?")){d({url:"ticket_sla/"+t.id,method:"DELETE"}).success(function(e,t,i,n){userAginLogin(e);if(e.success){u.getPagedDataAsync(u.currentPage)}else{p.add("删除失败","danger")}})}};u.sortableOptions={"ui-floating":true,handle:".my-handle",items:">tr",update:function(e,t){},stop:function(e,t){var i={ids:[],values:[]};for(var n=0;n<u.slaList.length;n++){i.ids.push(u.slaList[n].id);i.values.push(n+1)}d({url:"update_sla_orderKey.json",method:"POST",data:i}).success(function(e,t,i,n){})}}}else if("via_email"==l.uri){u.pageSize=20;u.currentPage=1;u.allCount=0;u.reload=O;function O(){d({url:"via_email.json",method:"GET",params:{_count:u.pageSize,_page:u.currentPage,_fields:"id,username,name,verified,enable"}}).success(function(e,t,i,n){userAginLogin(e);var s=e.viaEmailList;u.viaEmailList=s;u.allCount=e._total})}O();u.enabled=function(t,i){i?_hmt.push(["_trackEvent","邮件渠道","启用邮件渠道"]):_hmt.push(["_trackEvent","邮件渠道","停用邮件渠道"]);var e={id:t.viaEmail.id,enable:i};if(!i){if(confirm("您确定停用吗?")){d({url:"via_email",method:"post",data:e}).success(function(e){if(e.success){t.viaEmail.enable=i}else{p.add(e.message,"danger")}})}}else{d({url:"via_email",method:"post",data:e}).success(function(e){if(e.success){t.viaEmail.enable=i}else{p.add(e.message,"danger")}})}};u.deleteViaEmail=function(a){_hmt.push(["_trackEvent","邮件渠道","删除邮件渠道"]);if(confirm("您确定删除吗?")){d({url:"via_email/"+a.id,method:"DELETE",params:{}}).success(function(e,t,i,n){userAginLogin(e);if(e.success){for(var s=0;s<u.viaEmailList.length;s++){if(u.viaEmailList[s].id==a.id){u.viaEmailList.splice(s,1)}}}else{p.add("删除失败","danger")}})}};u.toEditViaEmail=function(e,t){if(t==="add"){_hmt.push(["_trackEvent","邮件渠道","添加邮件渠道"])}else{_hmt.push(["_trackEvent","邮件渠道","编辑邮件渠道"])}o.go("system_setting.via_email_edit.email_address",{id:e,type:t})}}else if("working_day"==l.uri){var M=b.config.route.get("system.setting.working_day.show");u.displayPublic=M===undefined?true:M;u.displayPrivate=!u.displayPublic;S.getWorkingDay({},function(e){u.workingTime=e;u.weekTimes=JSON.parse(e.detailsJson);u.oldWorkingTime=u.workingTime.id?angular.copy(u.workingTime):{}});u.saveWorkingTime=function(){if(u.vm.getHours()){if(u.oldWorkingTime.status!=u.workingTime.status||u.oldWorkingTime.detailsJson!=JSON.stringify(u.vm.getHours())){u.workingTime.detailsJson=JSON.stringify(u.vm.getHours());S.saveWorkingTime({workTime:u.workingTime},function(e){if(e>0){u.workingTime.id=e;u.oldWorkingTime.id=e}u.oldWorkingTime.detailsJson=angular.copy(JSON.stringify(u.vm.getHours()));u.oldWorkingTime.status=u.workingTime.status})}else{p.add("数据未改变","danger")}}};u.currentYear=(new Date).getFullYear();u.currentMonth=(new Date).getMonth();var q=parseInt(u.currentYear+""+(parseInt(u.currentMonth)>=9?u.currentMonth+1:"0"+(u.currentMonth+1)));var G={};var K={};var B={};var Q={};u.holidayArray=[];var H=function(t){u.loadingData=true;S.getHoliday({yearMonth:parseInt(t)},function(e){G[t]=JSON.parse(e.holidays);K[t]=angular.copy(G[t]);B[t]=e.id;u.holidayArray=G[t];u.loadingData=false})};var W=function(){S.getWeekendWorking({},function(e){Q=e;u.saturdayAsHoliday=angular.copy(!e.saturdayWorking);u.sundayAsHoliday=angular.copy(!e.sundayWorking)})};H(q);W();u.onDateChange=function(e,t,i){var n=G[e];if(!n){n=G[e]=[]}var s=n.indexOf(t);if(s>-1&&!i){n.splice(s,1)}if(s==-1&&i){n.push(t)}};u.onYearMonthChange=function(e){if(G.hasOwnProperty(e)){u.holidayArray=G[e]}else{u.loadingData=true;H(e)}};u.saveHolidays=function(){angular.forEach(G,function(e,t,i){if(JSON.stringify(K[t])!=JSON.stringify(e)){var n={holidays:JSON.stringify(e),yearAndMonth:parseInt(t)};if(B.hasOwnProperty(t)){n.id=B[t]}S.saveHolidays({holiday:n},function(e){if(e>0){B[t]=e}K[t]=angular.copy(G[t])})}else{p.add("修改成功","success")}});if(Q&&(Q.saturdayWorking!=!u.saturdayAsHoliday||Q.sundayWorking!=!u.sundayAsHoliday)){Q.saturdayWorking=!u.saturdayAsHoliday;Q.sundayWorking=!u.sundayAsHoliday;S.saveWeekendWorking({weekendWorking:Q},function(e){if(e>0){Q.id=e}})}else{p.add(Q.id?"修改成功":"保存成功","success")}};u.switching=function(e){if(e=="public"){u.displayPublic=true;u.displayPrivate=false}else{u.displayPublic=false;u.displayPrivate=true}};u.$on("$destroy",function(){b.config.route.put("system.setting.working_day.show",u.displayPublic)})}else if("ticket_web_form"==l.uri){u.randomString=function(e){e=e||32;var t="ABCDEFGHJKMNPQRSTWXYZabcdefhijkmnprstwxyz2345678";var n=t.length;var s="";for(i=0;i<e;i++){if(i==3){s+="ti"}else if(i==6){s+="ck"}else if(i==9){s+="ett"}else{s+=t.charAt(Math.floor(Math.random()*n))}}return s};u.ticketCustomWebForms=[];d({url:"ticket_web_form.json",method:"GET",params:{_count:1e4,_fields:"id,name,isDefault",_do_count:false}}).success(function(e,t,i,n){userAginLogin(e);u.ticketCustomWebForms=e.customWebForms});u.toEditTicketCustomWebForm=function(e,t){if(t==="add"){_hmt.push(["_trackEvent","网页表单","添加网页表单"])}else if(t==="modify"){_hmt.push(["_trackEvent","网页表单","编辑网页表单"])}else{_hmt.push(["_trackEvent","网页表单","克隆网页表单"])}o.go("system_setting.ticket_web_form_edit.plug_in",{id:e,type:t})};u.deleteTicketCustomWebForm=function(e,s){_hmt.push(["_trackEvent","网页表单","删除网页表单"]);if(confirm("您确定删除'"+s.name+"'吗?")){d({url:"ticket_web_form/"+s.id,method:"DELETE",params:{}}).success(function(e,t,i,n){userAginLogin(e);if(e.success){u.ticketCustomWebForms.remove(s)}})}};u.enabled=function(t,i){i?_hmt.push(["_trackEvent","网页表单","启用网页表单"]):_hmt.push(["_trackEvent","网页表单","停用网页表单"]);if(!i){if(confirm("您确定停用吗?")){d({url:" enable_ticket_web_form/"+t.form.id+".json",method:"put",params:{enable:i}}).success(function(e){if(e.success){t.form.active=i}else{p.add(e.message,"danger")}})}}else{d({url:" enable_ticket_web_form/"+t.form.id+".json",method:"put",params:{enable:i}}).success(function(e){if(e.success){t.form.active=i}else{p.add(e.message,"danger")}})}}}else if("wechat_setting"==l.uri){u.lists=[];d({url:"listViaWeixin.json",method:"GET",params:{_count:1e4,_fields:"id,name,weixinNo,isQiye",_do_count:false}}).success(function(e,t,i,n){userAginLogin(e);u.lists=e.viaWeixins});u.wechat={name:"",appId:"",appSecret:"",apiToken:""};u.wechatqiye={name:"",appId:"",appSecret:"",apiToken:"",agentId:""};u.newWechatId=0;u.errorShow={appError:false,appMsg:"",urlError:false,urlMsg:"",nameError:false,nameMsg:""};u.items=["settings0","settings1","settings2","settings3","settings4","settings5","settings6","settings7","settings8"];u.selection=u.items[0];u.next=function(a){u.errorShow={appError:false,appMsg:"",urlError:false,urlMsg:"",nameError:false,nameMsg:""};if(a==2){d({url:"saveViaWeixin.json",method:"POST",data:u.wechat}).success(function(e,t,i,n){userAginLogin(e);if(e.id>0){var s=e.id;d({url:"via_weixin_get_token/"+s+".json",method:"GET"}).success(function(e,t,i,n){u.wechat.id=s;u.newWechatId=s;u.wechat.apiToken=e.json.apiToken;u.wechat.url=e.json.url;u.selection=u.items[a]})}else if(e.id==-1){u.errorShow.appMsg="appId和appSecret验证失败";u.errorShow.appError=true}else if(e.id==-2){u.errorShow.appMsg='该appid已被"'+e.message+'"渠道占用';u.errorShow.appError=true}else{u.errorShow.appMsg="验证失败";u.errorShow.appError=true}})}else if(a==3){d({url:"via_weixin_get_verified/"+u.newWechatId+".json",method:"GET"}).success(function(e,t,i,n){userAginLogin(e);if(e.success==true||e.success=="true"){u.lists.push(u.wechat);u.wechat={};u.selection=u.items[a]}else{u.errorShow.urlMsg="请把url和token准确填写到微信公众平台";u.errorShow.urlError=true}})}else if(a==1){if(u.wechat.name==""||u.wechat.weixinNo==""){u.errorShow.nameMsg="渠道名称和微信号不能为空";u.errorShow.nameError=true;return}u.selection=u.items[a]}else if(a==6){if(u.wechatqiye.name==""||u.wechatqiye.weixinNo==""){u.errorShow.nameMsg="渠道名称和微信号不能为空";u.errorShow.nameError=true;return}u.selection=u.items[a]}else if(a==7){if(u.wechatqiye.agentId==""){u.errorShow.appMsg="应用ID不能为空";u.errorShow.appError=true;return false}d({url:"save_via_qiye_weixin.json",method:"POST",data:u.wechatqiye}).success(function(e,t,i,n){userAginLogin(e);if(e.id>0){var s=e.id;d({url:"via_weixin_get_token/"+s+".json",method:"GET"}).success(function(e,t,i,n){u.wechatqiye.id=s;u.newWechatId=s;u.wechatqiye.apiToken=e.json.apiToken;u.wechatqiye.url=e.json.url;u.wechatqiye.encodingAesKey=e.json.encodingAesKey;u.selection=u.items[a]})}else if(e.id==-1){u.errorShow.appMsg="CorpID和appSecret验证失败";u.errorShow.appError=true}else if(e.id==-2){u.errorShow.appMsg='该CorpID已被"'+e.message+'"渠道占用';u.errorShow.appError=true}else{u.errorShow.appMsg="验证失败";u.errorShow.appError=true}})}else if(a==8){d({url:"via_weixin_qiye_get_verified/"+u.newWechatId+".json",method:"GET"}).success(function(e,t,i,n){userAginLogin(e);if(e.success==true||e.success=="true"){u.lists.push(u.wechatqiye);u.wechatqiye={};u.selection=u.items[a]}else{u.errorShow.urlMsg="请把url和token准确填写到微信公众平台";u.errorShow.urlError=true}})}else{u.selection=u.items[a]}};u.addWechatServiceNum=function(){_hmt.push(["_trackEvent","微信客服","添加微信渠道"]);var e=c({scope:u,contentTemplate:"source/views/ticket/setting.wechat_inf.html",html:true,show:true,placement:"center",title:"选择公众号类型"})};u.channel={name:"service"};u.addChannel=function(){if(u.channel.name=="service"){o.go("system_setting.wechat_detail.weixin_new_service_port",{id:0,type:u.channel.name,version:"add",verified:"add"})}else{o.go("system_setting.wechat_detail.weixin_port",{id:0,type:u.channel.name,version:"add",verified:"add"})}};u.deleteWeChat=function(a){_hmt.push(["_trackEvent","微信客服","删除微信客服"]);if(confirm("您确定删除吗?")){d({url:"deleteViaWeixin/"+a.id+".json",method:"delete"}).success(function(e,t,i,n){userAginLogin(e);if(e.success){for(var s=0;s<u.lists.length;s++){if(u.lists[s].id==a.id){u.lists.splice(s,1)}}}else{p.add(e.message,"danger")}})}};u.enabled=function(t,i){i?_hmt.push(["_trackEvent","微信客服","启用微信渠道"]):_hmt.push(["_trackEvent","微信客服","停用微信渠道"]);if(!i){if(confirm("您确定停用吗?")){d({url:"enable_viaweixin/"+t.list.id+".json",method:"put",params:{enable:i}}).success(function(e){if(e.success){t.list.enable=i}else{p.add(e.message,"danger")}})}}else{d({url:"enable_viaweixin/"+t.list.id+".json",method:"put",params:{enable:i}}).success(function(e){if(e.success){t.list.enable=i}else{p.add(e.message,"danger")}})}};u.toWechatDetail=function(e,t){_hmt.push(["_trackEvent","微信客服","编辑微信渠道"]);void 0;if(t.list.componentAppid){o.go("system_setting.wechat_detail.weixin_new_service_port",{id:e,type:t.list.isQiye?"qiye":"service",version:"new",verified:t.list.verified?"verified":"no_verified"})}else{o.go("system_setting.wechat_detail.weixin_port",{id:e,type:t.list.isQiye?"qiye":"service",version:"old",verified:t.list.verified?"verified":"no_verified"})}}}else if("sdk_setting"==l.uri){u.lists=[];d({url:"/api/list_via_sdk.json",method:"GET",params:{_count:1e4,_fields:"id,name,description",_do_count:false,provider_id:g.provider.id,_token:getCookie("user_token")}}).success(function(e,t,i,n){if(e.result){u.lists=e.result.viaSDKs}});u.deleteViaSDK=function(s,e){_hmt.push(["_trackEvent","SDK","删除SDK渠道"]);if(confirm("您确定删除吗?")){d({url:"/api/delete_via_sdk/"+e.id+".json",method:"delete",params:{provider_id:g.provider.id,_token:getCookie("user_token")}}).success(function(e,t,i,n){if(e.status=="0"){p.add("删除成功！");d({url:"add_desk_log?type=delete",method:"post"}).success(function(e,t,i,n){});u.lists.splice(s,1)}else{p.add("删除失败！","danger")}})}};u.toViaSdkDetail=function(e){_hmt.push(["_trackEvent","SDK","编辑SDK渠道"]);o.go("system_setting.sdk_detail.advance_preparation",{id:e})};u.addViaSdk={name:"",description:""};u.addViaSdkService=function(e){if(r.providerLicense.type=="blend"||r.providerLicense.type=="public"||r.providerLicense.type=="trial"||r.providerLicense.type=="enterprise"||r.providerLicense.type=="enterprise_trial"||r.providerLicense.type=="enterprise_plus"||r.providerLicense.type=="oem"||w.hasModule("api_sdk")){_hmt.push(["_trackEvent","SDK","添加SDK渠道"]);u.errorShow=false;var t=c({scope:u,template:"modal/modal.tpl.notitle.noclose.w445.html",contentTemplate:"source/views/ticket/setting.sdk_inf.html",html:true,show:true,placement:"center"});u.continueAddViaSdk=function(){if(u.addViaSdk.name==""){u.errorShow=true}else{u.errorShow=false;var e={id:0,addViaSdk:u.addViaSdk};o.go("system_setting.sdk_detail.advance_preparation",e);t.$promise.then(t.hide)}}}else{var i=c({scope:u,title:"提示",contentTemplate:"source/views/fun_restriction_reminder.html",html:true,show:true,placement:"center"});u.hasPermission=true;u.tipNotSupportService="当前服务版本不支持此功能，请升级服务后再试。";u.goAuthorization=function(){void 0;if(f.hasPermission("system_setting_company_account")){o.go("system_setting.detail.provider",{uri:"company_account",settingType:"system"});i.$promise.then(i.hide)}else{u.hasPermission=false;u.tipNotSupportService="很抱歉，你没有访问授权计划的权限"}};u.hideModal_=function(){i.$promise.then(i.hide)}}}}else if("cti_setting"==l.uri){u.ctiLoad=function(){d({url:"via_phone_list.json",method:"GET"}).success(function(e){userAginLogin(e);u.lists=e.json})};u.ctiLoad();u.toCtiDetail=function(e){_hmt.push(["_trackEvent","CTI客服","编辑CTI客服"]);o.go("system_setting.cti_detail.cti_port",{id:e})};u.addCtiServiceNum=function(){if(r.providerLicense.type=="blend"||r.providerLicense.type=="public"||r.providerLicense.type=="trial"||r.providerLicense.type=="professional"||r.providerLicense.type=="enterprise"||r.providerLicense.type=="enterprise_trial"||r.providerLicense.type=="enterprise_plus"||r.providerLicense.type=="oem"||r.providerLicense.type=="online_service_basic"||r.providerLicense.type=="remote_assistance_basic"||r.providerLicense.type=="enterprise_basic"||r.providerLicense.type=="enterprise_basic_19"){_hmt.push(["_trackEvent","CTI客服","添加CTI客服"]);u.MsgError=false;var e=c({scope:u,template:"modal/modal.tpl.w670.html",contentTemplate:"source/views/cti-setting/templates/setting.cti_inf.html",html:true,show:true,placement:"center"});u.hideModal=function(){e.$promise.then(e.hide)};u.channel="phone_box";u.goToCti=function(){if(u.lists.length>0){p.add("暂不支持添加多个USB盒子渠道","danger");return false}else{o.go("system_setting.cti_detail.cti_port",{id:u.channel})}}}else{var t=c({scope:u,title:"提示",contentTemplate:"source/views/fun_restriction_reminder.html",html:true,show:true,placement:"center"});u.hasPermission=true;u.tipNotSupportService="当前服务版本不支持此功能，请升级服务后再试。";u.goAuthorization=function(){void 0;if(f.hasPermission("system_setting_company_account")){o.go("system_setting.detail.provider",{uri:"company_account",settingType:"system"});t.$promise.then(t.hide)}else{u.hasPermission=false;u.tipNotSupportService="很抱歉，你没有访问授权计划的权限"}};u.hideModal_=function(){t.$promise.then(t.hide)}}};u.enabledCti=function(t,i){i?_hmt.push(["_trackEvent","电话渠道","启用电话渠道"]):_hmt.push(["_trackEvent","电话渠道","停用微信渠道"]);if(!i){if(confirm("您确定停用吗?")){d({url:"enable_via_phone/"+t.list.id+".json",method:"put",params:{enabled:i}}).success(function(e){if(e.success){t.list.enabled=i}else{p.add(e.message,"danger")}})}}else{d({url:"enable_via_phone/"+t.list.id+".json",method:"put",params:{enabled:i}}).success(function(e){if(e.success){t.list.enabled=i}else{p.add(e.message,"danger")}})}};u.deleteCti=function(t){_hmt.push(["_trackEvent","电话渠道","删除电话渠道"]);if(confirm("您确定删除吗?")){d({url:"via_phone/"+t.id+".json",method:"delete"}).success(function(e){userAginLogin(e);if(e.success){u.lists.remove(t)}else{p.add("删除失败！","danger")}})}}}else if("triggerTask"==l.uri){u.triggerTasks=[];u.$on("search-triggerTask",function(e,t){u.getFormBySearchKey(t)});u.getFormBySearchKey=function(n){var s=[];var a=0;angular.forEach(u.oldTriggerTasks,function(e,t,i){if(e.name.indexOf(n)>-1){s.push(e);if(e.accessed){a++}}});u.triggerTasks=s;u.triggerTasksLen=a};if(l.type=="ticket"){Y.sdk.OpenTicketTriggerApi().listTicketTrigger({page:{pageSize:99999,pageNumber:1}}).then(function(e){userAginLogin(e);if(e&&e.list){u.triggerTasks=e.list;u.oldTriggerTasks=angular.copy(u.triggerTasks);var n=0;u.triggerTasks.forEach(function(e,t,i){if(e.accessed){n++}});u.triggerTasksLen=n}})}else if(l.type=="webchat"){Y.sdk.OpenChatTriggerApi().listChatTrigger({page:{pageSize:99999,pageNumber:1}}).then(function(e){if(e&&e.list){u.triggerTasks=e.list;u.oldTriggerTasks=angular.copy(u.triggerTasks);var n=0;u.triggerTasks.forEach(function(e,t,i){if(e.accessed){n++}});u.triggerTasksLen=n}})}u.addTriggerTask=function(e,t,i){if(l.type=="ticket"||!l.type){if(e==0){o.go("system_setting.triggerTask_edit_ticket",{id:0,type:t})}else{o.go("system_setting.triggerTask_edit_ticket",{id:e,type:t})}}else if(l.type=="webchat"){if(e==0){o.go("system_setting.triggerTask_edit_webchat",{id:0,type:t})}else{o.go("system_setting.triggerTask_edit_webchat",{id:e,type:t})}}};u.toEditTrigger=function(e,t,i){if(l.type=="ticket"||!l.type){if(e==0){o.go("system_setting.triggerTask_edit_ticket",{id:0,type:t})}else{o.go("system_setting.triggerTask_edit_ticket",{id:e,type:t})}}else if(l.type=="webchat"){if(e==0){o.go("system_setting.triggerTask_edit_webchat",{id:0,type:t})}else{o.go("system_setting.triggerTask_edit_webchat",{id:e,type:t})}}};u.deleteTicketTriggerTask=function(s,e){_hmt.push(["_trackEvent","自动化程序","删除自动化程序"]);if(confirm("您确定删除'"+e.name+"'吗?")){if(l.type==="webchat"){org.ewei.sdk.OpenChatTriggerApi().delete({id:e.id}).then({success:function(e){u.triggerTasks.splice(s,1);u.oldTriggerTasks=angular.copy(u.triggerTasks)},fail:function(){p.add("删除失败！","danger")}})}else{d({url:"ticket_trigger/"+e.id+".json",method:"delete",params:{}}).success(function(e,t,i,n){userAginLogin(e);if(e.success){void 0;u.triggerTasks.splice(s,1);u.oldTriggerTasks=angular.copy(u.triggerTasks)}})}}};u.toActivateTriggerTask=function(s,a,e){e?_hmt.push(["_trackEvent","自动化程序","激活"]):_hmt.push(["_trackEvent","自动化程序","取消激活"]);if(l.type==="webchat"){org.ewei.sdk.OpenChatTriggerApi().updateChatTriggerState({id:a.id,active:!a.active}).then({success:function(e){u.triggerTasks[s].active=!a.active;u.oldTriggerTasks=angular.copy(u.triggerTasks)},fail:function(){p.add("操作失败！","danger")}})}else{d({url:"ticket_trigger_active/"+a.id+".json?active="+!a.active,method:"put",params:{}}).success(function(e,t,i,n){userAginLogin(e);if(e.success){u.triggerTasks[s].active=!a.active;u.oldTriggerTasks=angular.copy(u.triggerTasks)}})}};u.updateActiveAutomation=function(e,t){d({url:"ticket_trigger/"+e+".json",method:"GET",params:{active:t}}).success(function(e,t,i,n){userAginLogin(e);if(e.success){u.automations=e.automations}})};u.businessHoursBuried=function(){_hmt.push(["_trackEvent","营业时间","营业时间"])};u.holidaysBuried=function(){_hmt.push(["_trackEvent","营业时间","节假日"])};u.sortableOptions={"ui-floating":false,handle:".myHandle",update:function(e,t){},stop:function(e,t){var i={ids:[],values:[]};for(var n=0;n<u.triggerTasks.length;n++){i.ids.push(u.triggerTasks[n].id);i.values.push(n+1)}if(l.type=="webchat"){org.ewei.sdk.OpenChatTriggerApi().updateOrderKey(i).then({success:function(e){}})}else{d({url:"ticket_trigger_order_change.json",method:"put",data:i}).success(function(e,t,i,n){userAginLogin(e)})}}}}else if("api_setting"==l.uri){u.viaApi={name:""};u.viaApiList=[];u.loadViaApiList=function(){d({url:"list_via_api.json",method:"get"}).success(function(e){userAginLogin(e);u.viaApiList=e.json})};u.loadViaApiList();var J="";var z=window.location.href;if(z.indexOf("itkeeping.com")>-1||z.indexOf("ewei.dev")>-1||z.indexOf("localhost")>-1){J="org"}else{J="com"}u.apiUrl="http://api.ewei."+J+"/index#/index/developer_read/join_guide";u.MsgError=false;u.showAddViaApiModal=function(e,t,i,n){if(i==="add"){_hmt.push(["_trackEvent","API","添加API"])}else{_hmt.push(["_trackEvent","API","编辑API"])}u.viaApi.name=t;u.viaApi.type=i;u.MsgError=false;if(r.providerLicense.type=="blend"||r.providerLicense.type=="public"||r.providerLicense.type=="trial"||r.providerLicense.type=="enterprise"||r.providerLicense.type=="enterprise_trial"||r.providerLicense.type=="enterprise_plus"||r.providerLicense.type=="oem"||w.hasModule("api_sdk")){var s=c({scope:u,template:"modal/modal.tpl.notitle.noclose.w445.html",contentTemplate:"source/views/ticket/setting.api_inf.html",html:true,show:true,placement:"center"})}else{var a=c({scope:u,title:"提示",contentTemplate:"source/views/fun_restriction_reminder.html",html:true,show:true,placement:"center"});u.hasPermission=true;u.tipNotSupportService="当前服务版本不支持此功能，请升级服务后再试。";u.goAuthorization=function(){void 0;if(f.hasPermission("system_setting_company_account")){o.go("system_setting.detail.provider",{uri:"company_account",settingType:"system"});a.$promise.then(a.hide)}else{u.hasPermission=false;u.tipNotSupportService="很抱歉，你没有访问授权计划的权限"}};u.hideModal_=function(){a.$promise.then(a.hide)}}u.saveViaApi=function(){if(u.viaApi.name==undefined||u.viaApi.name==""||u.viaApi.name==null){u.MsgError=true}else{d({url:"create_via_api.json",params:{name:u.viaApi.name},method:"post"}).success(function(e){userAginLogin(e);if(e.id!=undefined&&e.id!=""&&e.id>0){d({url:"find_via_api_"+e.id+".json",method:"get"}).success(function(e){u.viaApiList.push(e.json);s.$promise.then(s.hide)})}else{u.saveErrorMsg=true}})}};u.updateViaApi=function(){if(u.viaApi.name==undefined||u.viaApi.name==null||u.viaApi.name==""){u.MsgError=true}else{d({url:"update_via_api_"+e+".json",params:{name:u.viaApi.name},method:"post"}).success(function(e){userAginLogin(e);if(e.success){u.viaApiList[n].name=u.viaApi.name;s.$promise.then(s.hide);p.add("更新成功")}else{p.add("更新失败","danger")}})}}};u.deleteViaApi=function(t,e){_hmt.push(["_trackEvent","API","删除API"]);if(confirm("您确定删除'"+e.name+"'吗?")){d({url:"del_via_api_"+e.id+".json",method:"delete"}).success(function(e){userAginLogin(e);if(e.success){p.add("删除成功");u.viaApiList.splice(t,1)}else{p.add("删除失败","danger")}})}}}else if("automations"==l.uri){u.automations=[];if(!l.type&&f.hasPermission("ticket_setting_automation")){return o.go("system_setting.automations.ticket")}else if(!l.type&&f.hasPermission("chat_edit_automation")){return o.go("system_setting.automations.webchat")}Y.sdk.OpenAutomationApi().listAutomation({page:{pageSize:150,pageNumber:1},type:l.type=="webchat"?"chat":"ticket"}).then(function(e){if(e&&e.list){u.automations=e.list;var n=0;u.automations.forEach(function(e,t,i){if(e.accessed){n++}});u.automationsLen=n}});u.toEditAutomation=function(e,t,i){var n="system_setting.automation_edit_ticket";if(l.type=="webchat"){n="system_setting.automation_edit_webchat"}if(i){o.go("system_setting.automation_default",{id:parseInt(e),type:t})}else{o.go(n,{id:parseInt(e),type:t})}};u.deleteTicketAutomations=function(t,e){_hmt.push(["_trackEvent","自动化程序","删除自动化程序"]);if(confirm("您确定删除'"+e.name+"'吗?")){org.ewei.sdk.OpenAutomationApi().deleteAutomation({id:e.id}).then({success:function(e){u.automations.splice(t,1)},fail:function(e){p.add("删除失败！","danger")}})}};u.cloneAutomation=function(e,t,i){var n="system_setting.automation_edit_ticket";if(l.type=="webchat"){n="system_setting.automation_edit_webchat"}o.go(n,{id:e,type:t})};u.toActivateAutomations=function(t,i,n){n?_hmt.push(["_trackEvent","自动化程序","激活"]):_hmt.push(["_trackEvent","自动化程序","取消激活"]);org.ewei.sdk.OpenAutomationApi().updateActiveAutomation({id:i.id,active:!i.active}).then({success:function(e){u.automations[t].active=!i.active},fail:function(e){p.add(n?"激活失败":"取消激活失败","danger")}})};u.updateActiveAutomation=function(e,t){org.ewei.sdk.OpenAutomationApi().updateActiveAutomation({id:parseInt(e),active:t}).then({success:function(e){u.automations[index].active=!automation.active},fail:function(e){}})};u.businessHoursBuried=function(){_hmt.push(["_trackEvent","营业时间","营业时间"])};u.holidaysBuried=function(){_hmt.push(["_trackEvent","营业时间","节假日"])};u.sortableOptions={"ui-floating":false,handle:".myHandle",update:function(e,t){},stop:function(e,t){var i={ids:[],values:[]};for(var n=0;n<u.automations.length;n++){i.ids.push(u.automations[n].id);i.values.push(n+1)}org.ewei.sdk.OpenAutomationApi().updateOrderKey(i).then({fail:function(e){p.add("保存排序失败","danger")}})}}}else if("evaluate_edit"==l.uri){if(!l.type){if(o.current.name==="system_setting.detail.evaluate-chat"&&f.hasPermission("chat_edit_evaluate")){return o.go("system_setting.detail.evaluate-chat")}else if(f.hasPermission("system_setting_ticket_evaluate")){return o.go("system_setting.detail.evaluate-ticket")}else if(f.hasPermission("chat_edit_evaluate")){return o.go("system_setting.detail.evaluate-chat")}}u.evaluate={};if(l.type==="ticket"){org.ewei.sdk.OpenHelpCenterTicketApi().findTicketEvaluateConfig().then(function(e){e.firstQuestionOptions=JSON.parse(e.firstQuestionOptions);u.evaluate=e})}else{org.ewei.sdk.OpenChatEvaluateConfigApi().findEvaluateConfig().then(function(e){e.firstQuestionOptions=JSON.parse(e.firstQuestionOptions);u.evaluate=e})}u.updateEvaluateConfig=function(e){var t={},i=true;if(e){u.evaluate.open=!u.evaluate.open;t={id:u.evaluate.id,open:u.evaluate.open}}else{t=u.evaluate;if(!u.evaluate.title){p.add("标题不能为空","danger");return false}if(!u.evaluate.firstQuestionTitle){p.add("解决否问题描述不能为空","danger");return false}angular.forEach(u.evaluate.firstQuestionOptions,function(e){if(!e.name){i=false}});if(!i){p.add("解决否选项名称不能为空","danger");return false}if(!u.evaluate.secondQuestionTitle){p.add("满意度问题描述不能为空","danger");return false}if(!u.evaluate.loyaltyQuestionTitle){p.add("忠诚度问题描述不能为空","danger");return false}if(!u.evaluate.recommendQuestionTitle){p.add("推荐度问题描述不能为空","danger");return false}if(!u.evaluate.description){p.add("意见反馈不能为空","danger");return false}}if(l.type==="ticket"){org.ewei.sdk.OpenTicketEvaluateConfigApi().updateEvaluateConfig({ticketEvaluateConfig:t}).then(function(e){if(e){p.add("更新成功")}else{p.add("更新失败","danger")}})}else{org.ewei.sdk.OpenChatEvaluateConfigApi().updateEvaluateConfig({config:t}).then(function(e){if(e){p.add("更新成功")}else{p.add("更新失败","danger")}})}};u.selectFirstQuestionOptionsRadio=function(t){angular.forEach(u.evaluate.firstQuestionOptions,function(e){if(t==e){e.defaultValue=""}else{delete e.defaultValue}})}}}])})(org.ewei);(function(v){"use strict";angular.module("eweiApp.ticket").controller("editWorkflowTemplateController",["$rootScope","$modal_","$scope","$state","$stateParams","$resource","$http","workflowTemplateService","alertService","permissions","$filter","ConsoleConfig","coreModelService",function(e,i,n,t,r,s,a,o,l,c,u,d,p){var f=null;n.eweiHelpcenterApiUrl=d.eweiHelpcenterApiUrl;n.workflowTemplateEngineer={};n.workflowTemplate={};n.questionTip=["点击开始按钮添加第一个节点","处理人节点可以是客服组","判断节点可按照一定的条件自动分派给下一个处理人","可添加或删除中间节点"];n.workflowSelectItems=[{id:0,option:"私有(仅个人可用)"}];if(c.hasPermission("ticket_public_workflow")){n.workflowSelectItems.push({id:1,option:"公有"})}n.workflowSelectInfo=n.workflowSelectItems[0];function m(e){var t=v.utils.uuid(32,16).toLowerCase();var i={type:"start",display:"开始",children:[],uId:t};if(e){e.parentUId=t;i.children.push(e)}return i}var g=r.id;if(g>0){v.sdk.OpenActivitiWorkflowTemplateApi().getById({id:v.utils.s2n(g)}).then(function(e){n.workflowTemplate.rootNode=m(e.rootNode);n.workflowTemplate.name=e.name;n.workflowTemplate.engineerId=e.engineerId;n.workflowTemplate.uId=e.uId;n.workflowTemplate.id=e.id;if(e.engineerId){n.workflowSelectInfo=n.workflowSelectItems[0]}else{n.workflowSelectInfo=n.workflowSelectItems[1]}f=angular.copy(n.workflowTemplate)})}else{n.workflowTemplate.uId=v.utils.uuid(32,16).toLowerCase();n.workflowTemplate.rootNode=m();f=angular.copy(n.workflowTemplate)}n.updateWorkflowNote=function(){var s=[];var e=false;n.isClick=true;var a=angular.copy(n.workflowTemplate);if(a.name===undefined||a.name===""){l.add("请输入模板名称","danger");n.isClick=false;return}v.utils.traverse(a.rootNode,function(e){delete e.completed;delete e.display});e=JSON.stringify(f.rootNode.children[0])!==JSON.stringify(a.rootNode.children[0]);a.rootNode=a.rootNode.children[0];if(a.rootNode){delete a.rootNode.parentUId}else{l.add("你还没有添加节点，请检查后再试","danger");n.isClick=false;return}a.workflowTemplateNodes=[];v.utils.traverse(a.rootNode,function(e){if(e.type==="handler"){if(e.serviceDeskId||e.engineerId){a.workflowTemplateNodes.push({type:e.type,uId:e.uId,parentUId:e.parentUId,engineerId:e.engineerId,serviceDeskId:e.serviceDeskId})}else{s.push(e.uId)}}else if(e.type==="getway"){var n=["attribute","compare","tally","value"];var t=function(e,t){if(["options","multi_options","cascade_options"].indexOf(e.valueType)!==-1){e.value=e.valueOptions.value}for(var i in e){if(e.hasOwnProperty(i)&&n.indexOf(i)===-1){delete e[i]}}e.workflowTemplateNodeUId=t};for(var i=e.andConditions.length-1;i>=0;i--){if(e.andConditions[i].attribute==="-1"){e.andConditions.splice(i,1)}else{t(e.andConditions[i],e.uId)}}for(var i=e.orConditions.length-1;i>=0;i--){if(e.orConditions[i].attribute==="-1"){e.orConditions.splice(i,1)}else{t(e.orConditions[i],e.uId)}}a.workflowTemplateNodes.push({type:e.type,uId:e.uId,parentUId:e.parentUId,trueUId:e.trueUId,falseUId:e.falseUId,andConditions:e.andConditions,orConditions:e.orConditions});if(e.andConditions.length===0&&e.orConditions.length===0){s.push(e.uId)}}});if(s.length>0){v.utils.traverse(n.workflowTemplate.rootNode,function(e){if(s.indexOf(e.uId)!==-1){e.valid=false}});l.add("节点信息不完整,请检查后再试","warning");n.isClick=false;return}delete a["rootNode"];delete a["activitiXml"];if(n.workflowSelectInfo.id===0){a.engineerId=d.engineer.id}else{delete a.engineerId}var t={success:function(e){l.add("保存成功");p.config.route.put("system.setting.workflow_templet.showType",["private","public"][n.workflowSelectInfo.id]);n.cancelEdit()},fail:function(){l.add("保存失败","danger");n.isClick=false}};if(r.type==="copy"||v.utils.isUndefined(f.id)){v.sdk.OpenActivitiWorkflowTemplateApi().addWorkflowTemplate({workflowTemplate:a}).then(t)}else{n.$ok=function(){v.sdk.OpenActivitiWorkflowTemplateApi().updateWorkflowTemplate({id:a.id,workflowTemplate:a,nodeChange:e}).then(t)};if(e){v.sdk.OpenActivitiWorkflowTemplateApi().ticketCountByActivitiWorkflowTemplateId({id:a.id}).then(function(e){if(e>0){a.name=a.name+"-复制";n._messages="当前工作流已经被【"+e+"】张工单使用，无法完成更新操作。点击确定将本次修改保存为新的工作流";i({scope:n,title:"工作流更新",contentTemplate:"source/views/alter_common.html",html:true,show:true,placement:"center",hideCallback:function(){n.isClick=false}})}else{n.$ok()}})}else{n.$ok()}}};n.cancelEdit=function(){t.go("system_setting.detail",{uri:"workflow_templet",settingType:"ticket"})}}]).controller("editTicketTemplateController",["$modal_","$scope","$state","$stateParams","$resource","$http","ticketTemplateNoteOptions","serviceDeskService","engineerService","permissions","alertService","$filter","$timeout","coreModelService","commonTools",function(e,f,t,d,i,m,n,s,a,r,g,v,o,h,l){var p=angular.copy(n);m.get("custom_field.json?scope=ticket&active=true").success(function(e,t){f.customField=e.json;angular.forEach(e.json,function(e,t,i){var n={};if(e.systemFieldKey=="priority"){n={option:"工单："+e.title,value:"priority",valueType:"select",edit_able:e.edit_able}}else if(e.systemFieldKey=="ticket_type"){n={option:"工单："+e.title,value:"ticket_type",valueType:"select",edit_able:e.edit_able}}else if(e.systemFieldKey=="service_catalog"){n={option:"工单："+e.title,value:"servicecatalog",valueType:"servicecatalog",edit_able:e.edit_able}}else if(e.systemFieldKey=="subject"){n={option:"工单："+e.title,value:"subject",valueType:"text",edit_able:e.edit_able}}else if(e.systemFieldKey=="tags"){return}else if(e.systemFieldKey=="ticket_description"){return}else{n={option:"工单：自定义字段-"+e.title,value:e.type+"|"+e.id,valueType:"",edit_able:e.edit_able}}if(e.type=="text"||e.type=="email"){n.valueType="text";n.edit_able=e.edit_able}else if(e.type=="regexp"){f.regexpForValidationData=e;n.valueType="text"}else if(e.type=="number"||e.type=="decimal"){n.valueType="number"}else if(e.type=="textarea"||e.type=="date"||e.type=="date_time"){n.valueType=e.type}else if(e.type=="options"||e.type=="checkbox"){if(e.systemFieldKey){n.valueType="select"}else{n.valueType="options";if(e.customFieldOptions){n.valueOptions=e}}}else if(e.type=="cascade_options"){if(e.systemFieldKey=="service_catalog"){n.valueType="servicecatalog"}else{n.valueType="cascade_options";if(e.customFieldOptions){n.valueOptions=e}}}else if(e.type=="multi_options"){n.valueType="multi_options";if(e.customFieldOptions){n.valueOptions=e}}else if(e.type=="date_to_date"){n.valueType="date_to_date";n.startTimeForm=false;n.endTimeForm=false}else{n.valueType="text"}n.edit_able=e.edit_able;if(e.systemFieldKey!="tags"){p.push(n)}})});f.ticketTemplateNotes=[];f.ticketTemplate={};f.ticketTemplateSelectItems=[{id:0,option:"私有(仅个人可用)"}];if(r.hasPermission("ticket_public_template")){f.ticketTemplateSelectItems.push({id:1,option:"公有(所有客服都可用)"})}var y=function(e){var t=e.length,i,n,s,a;for(i=0;i<t;i++){a=0;for(n=t-1;n>i;n--){if(e[n].id<e[n-1].id){s=e[n];e[n]=e[n-1];e[n-1]=s;a=1}}if(!a)return e}return e};f.ticketTemplateSelectInfo=f.ticketTemplateSelectItems[0];var c=function(){var e=d.id;m({url:"ticket_template/"+e+".json",method:"GET",params:{}}).success(function(e,t,i,n){userAginLogin(e);if(e.success){var s=e.json;f.ticketTemplate.name=s.name;if(d.type!="copy"){f.ticketTemplate.id=s.id}if(s.engineer!=undefined){f.ticketTemplateSelectInfo=f.ticketTemplateSelectItems[0]}else{f.ticketTemplateSelectInfo=f.ticketTemplateSelectItems[1]}var a=s.operations;a=y(a);for(var r=0,o=a.length;r<o;r++){var l=a[r];for(var c=0;c<p.length;c++){if(p[c].value=="subject"){var u="";try{u=JSON.parse(localStorage["systemFieldSubject"]).title}catch(e){}p[c].option="工单："+u}}l.options=p;f.ticketTemplateNotes.push(f.setNoteValue(l))}}})};if(d.id>0){o(function(){c()},100)}f.addTicketTemplateNote=function(){var e=f.ticketTemplateNotes;var t=[];for(var i=0,n=p.length;i<n;i++){var s=false;for(var a=0,r=e.length;a<r;a++){if(e[a].type==p[i].value){s=true;break}}if(!s){if(p[i].value=="subject"){var o="";try{o=JSON.parse(localStorage["systemFieldSubject"]).title}catch(e){}p[i].option="工单："+o}t.push(p[i])}}var l={type:"",value:"",textvalue:"",serviceCatalog:{},requester:{},engineer:{},add_ticket_cc:{},valueType:"select",options:t,values:[],startTimeForm:false,endTimeForm:false,edit_able:""};f.ticketTemplateNotes.push(l)};f.typeChange=function(s){for(var e=0,t=p.length;e<t;e++){if(s.type==p[e].value){s.valueType=p[e].valueType;s.valueOptions=p[e].valueOptions;s.edit_able=p[e].edit_able;break}}if(s.type.split("|").length>1){if(s.type.split("|")[0]=="checkbox"){s.values=[{option:"选中",value:"true"},{option:"未选中",value:"false"}];s.valueType="select"}else if(s.type.split("|")[0]=="options"){angular.forEach(f.customField,function(e){if(s.type.split("|")[1]==e.id){s.values=[];e.customFieldOptions=angular.fromJson(e.customFieldOptions);angular.forEach(e.customFieldOptions,function(e){var t={option:e.name,value:e.value};s.values.push(t)})}})}}else{if(s.type=="status"){s.values=[{option:"处理中",value:"open"},{option:"暂停",value:"pending"},{option:"处理完毕",value:"solved"}]}else if(s.type=="ticket_type"){m.get("ticket_type.json?_fields=id,name&_count=1111111").success(function(e,t){if(typeof e=="string"){g.add("未经授权无法访问！","danger","right",3e3,0,true)}else{var i=e.ticketTypes;s.values=[];for(var n=0;n<i.length;n++){s.values.push({option:i[n].name,value:i[n].id})}}})}else if(s.type=="priority"){s.values=[{option:"P1",value:"P1"},{option:"P2",value:"P2"},{option:"P3",value:"P3"},{option:"P4",value:"P4"},{option:"P5",value:"P5"}]}else if(s.type=="comment_attribute"){s.values=[{option:"公开回复",value:"public"},{option:"私密回复",value:"private"}]}else{s.values=[]}}};f.datepickers={startForm:false,startTo:false,updateFrom:false,updateTo:false};f.open=function(e,t){e.preventDefault();e.stopPropagation();f.datepickers[t]=!f.datepickers[t]};f.openTime=function(e,t,i){e.preventDefault();e.stopPropagation();i[t]=!i[t]};f.showNoteValue=function(e){};f.setNoteValue=function(s){if(s.type=="requester"){s.valueType="requester";m({url:"user/"+s.value+"/no_access_scope.json",method:"GET",params:{}}).success(function(e,t,i,n){s.requester=e.json})}else if(s.type=="status"){s.values=[{option:"处理中",value:"open"},{option:"暂停",value:"pending"},{option:"处理完毕",value:"solved"}];s.valueType="select"}else if(s.type=="ticket_type"){s.valueType="select";m.get("ticket_type.json?_fields=id,name&_count=1111111").success(function(e,t){if(typeof e=="string"){g.add("未经授权无法访问！","danger","right",3e3,0,true)}else{var i=e.ticketTypes;s.values=[];for(var n=0;n<i.length;n++){s.values.push({option:i[n].name,value:i[n].id});if(i[n].id==s.value){s.value=i[n].id}}}})}else if(s.type=="priority"){s.values=[{option:"P1",value:"P1"},{option:"P2",value:"P2"},{option:"P3",value:"P3"},{option:"P4",value:"P4"},{option:"P5",value:"P5"}];s.valueType="select"}else if(s.type=="engineer"){s.valueType="engineer";var e=s.value.split(",");if(e!=null&&e[0]!=null&&e[0]>0){if(e[0]!="workflow_template"){m({url:"service_desk/"+e[0]+".json",method:"GET",params:{}}).success(function(e,t,i,n){s.engineer_serviceDesk=e.json})}}if(e!=null&&e[1]!=null&&e[1]>0){if(e[0]=="workflow_template"){s.workflowTemplate={id:e[1]}}else{m({url:"engineer/"+e[1]+".json",method:"GET",params:{}}).success(function(e,t,i,n){s.engineer=e.json})}}}else if(s.type=="add_ticket_cc"){f.isCopy=true;var t={};s.ccs=[];t.value="0,";var i=s.value.split(",")||[];for(var n=0;n<i.length;n++){if(validEmail(i[n])){s.ccs.push({name:i[n]})}else{t.value+=i[n]+","}}m({url:"/api/v1/customers/by_ids.json?ids="+t.value,method:"GET"}).success(function(e){if(e.status==0&&e.result){s.valueType="add_ticket_cc";s.ccs=s.ccs.concat(e.result.users)}})}else if(s.type=="add_ticket_cc_servicedesk"){s.value=JSON.parse(s.value);s.valueType="servicedesk"}else if(s.type=="comment_attribute"){s.valueType="select";s.values=[{option:"公开回复",value:"public"},{option:"私密回复",value:"private"}]}else if(s.type=="servicecatalog"){s.valueType="servicecatalog";s.serviceCatalog={id:s.value}}else if(s.type=="comment"){s.valueType="textarea";s.textvalue=s.value}else if(s.type=="ticket_custom_field"){m.get("custom_field/"+s.ticketCustomFieldId+".json").success(function(e,t){var i=e.json;if(i){s.type=i.type+"|"+i.id;if(i.type=="text"||i.type=="email"||i.type=="regexp"||i.type=="regexp"||i.type=="ip"||i.type=="mobile_phone"||i.type=="phone"||i.type=="currency"||i.type=="url"){s.valueType="text";s.edit_able=i.edit_able}else if(i.type=="number"||i.type=="decimal"){s.valueType="number";s.textvalue=Number(s.textvalue);s.edit_able=i.edit_able}else if(i.type=="textarea"||i.type=="date_time"){s.valueType=i.type;s.edit_able=i.edit_able}else if(i.type=="checkbox"){s.valueType="select";s.edit_able=i.edit_able;s.values=[{option:"选中",value:"true"},{option:"未选中",value:"false"}]}else if(i.type=="options"){s.valueType="options";i.value=s.value;s.valueOptions=i;s.edit_able=i.edit_able}else if(i.type=="cascade_options"){s.valueType="cascade_options";i.value=s.value;s.valueOptions=i;s.edit_able=i.edit_able}else if(i.type=="multi_options"){s.valueType="multi_options";i.value=s.value;s.valueOptions=i;s.edit_able=i.edit_able}else if(i.type=="date_to_date"){s.valueType="date_to_date";var n=s.value.split("-");s.startTime=l.parseDate(n[0],"yyyy/MM/dd");s.endTime=l.parseDate(n[1],"yyyy/MM/dd");s.edit_able=i.edit_able}else if(i.type=="date"){s.valueType="date";s.value=s.value?s.value.replace(/-/g,"/"):"";s.value=l.parseDate(s.value,"yyyy/MM/dd");s.textvalue=s.value}angular.forEach(f.customField,function(e){if(e.id==s.ticketCustomFieldId){s.edit_able=e.edit_able;if(s.valueOptions){s.valueOptions.edit_able=e.edit_able}}})}});s.textvalue=s.value}else{s.valueType="text";s.textvalue=s.value}return s};f.cancelEdit=function(){t.go("system_setting.detail",{uri:"ticket_template",settingType:"ticket"})};f.checkValue=function(e){if(e&&e.type&&e.type.split("|")[0]=="email"){if(!verifyEmailAddress(e.textvalue)){e.textvalue="";g.add("请输入正确的邮箱","danger");return false}}else if(e&&e.type&&e.type.split("|")[0]=="regexp"){var t=new RegExp(f.regexpForValidationData.regexpForValidation);if(!t.test(e.textvalue)){e.textvalue="";g.add("请输入正确的"+f.regexpForValidationData.title,"danger");return false}}};f.saveTicketTemplateNote=function(e){void 0;f.isClick=true;if(e===null||e.name===undefined||e.name===""){g.add("请输入模板名称","danger");f.isClick=false;return}var t=f.ticketTemplateNotes;if(t.length<=0){g.add("请选择需要执行的操作","danger");f.isClick=false;return}var a={};if(e.id!=undefined){a.id=e.id}a.name=e.name;a.engineer={id:f.ticketTemplateSelectInfo.id};var i=[];for(var n=0,s=t.length;n<s;n++){var r={id:t[n].id,type:t[n].type};if(r.type.split("|").length>1){if(r.type.split("|")[0]=="text"||r.type.split("|")[0]=="textarea"||r.type.split("|")[0]=="email"||r.type.split("|")[0]=="regexp"||r.type.split("|")[0]=="ip"||r.type.split("|")[0]=="mobile_phone"||r.type.split("|")[0]=="phone"||r.type.split("|")[0]=="currency"||r.type.split("|")[0]=="url"){if(t[n].textvalue==""){g.add("请把信息填写完整","danger");f.isClick=false;return}r.value=t[n].textvalue;r.ticketCustomFieldId=r.type.split("|")[1]}else if(r.type.split("|")[0]=="date"){if(!t[n].textvalue){g.add("请把信息填写完整","danger");f.isClick=false;return}else{var o=t[n].textvalue;r.value=v("date")(o,"yyyy/MM/dd").toString();r.ticketCustomFieldId=r.type.split("|")[1]}}else if(r.type.split("|")[0]=="date_to_date"){if(t[n].startTime&&t[n].endTime){var l=v("date")(t[n].startTime,"yyyy/MM/dd").toString();var c=v("date")(t[n].endTime,"yyyy/MM/dd").toString();var u=l+"-"+c;r.value=u}}else if(r.type.split("|")[0]=="number"||r.type.split("|")[0]=="decimal"){if(t[n].textvalue==""){g.add("请把信息填写完整","danger");f.isClick=false;return}else if(t[n].textvalue===undefined){g.add("数字格式不正确","danger");f.isClick=false;return}r.value=t[n].textvalue;r.ticketCustomFieldId=r.type.split("|")[1]}else if(r.type.split("|")[0]=="multi_options"||r.type.split("|")[0]=="cascade_options"||r.type.split("|")[0]=="options"){r.value=t[n].valueOptions.value;r.ticketCustomFieldId=r.type.split("|")[1]}else{if(t[n].value===undefined||t[n].value==""){g.add("请把信息填写完整","danger");f.isClick=false;return}r.value=t[n].value}}else{if(t[n].type=="subject"||t[n].type=="addtag"||t[n].type=="deletetag"||t[n].type=="modifytag"||t[n].type=="comment"){if(t[n].textvalue==""){g.add("请把信息填写完整","danger");f.isClick=false;return}r.value=t[n].textvalue}else if(t[n].type=="servicecatalog"){if(t[n].serviceCatalog===undefined||t[n].serviceCatalog.id===undefined){g.add("请把服务目录信息填写完整","danger");f.isClick=false;return}r.value=t[n].serviceCatalog.id}else if(t[n].type=="requester"){if(t[n].requester===undefined||t[n].requester.id===undefined){g.add("请把客户信息填写完整","danger");f.isClick=false;return}r.value=t[n].requester.id}else if(t[n].type=="engineer"){if((!t[n].engineer_serviceDesk||!t[n].engineer_serviceDesk.id)&&t[n].workflowTemplate===undefined){g.add("请把处理人信息填写完整","danger");f.isClick=false;return}if(t[n].engineer!=null&&t[n].engineer!=undefined){r.value=t[n].engineer_serviceDesk.id+","+t[n].engineer.id}else if(t[n].engineer_serviceDesk!=null&&t[n].engineer_serviceDesk!=undefined){r.value=t[n].engineer_serviceDesk.id}else if(t[n].workflowTemplate!=null&&t[n].workflowTemplate!=undefined){r.value="workflow_template,"+t[n].workflowTemplate.id}}else if(t[n].type=="add_ticket_cc"){if(t[n].ccs===undefined){g.add("请选择抄送人","danger");f.isClick=false;return}var d="";for(var p=0;p<t[n].ccs.length;p++){if(t[n].ccs[p]&&t[n].ccs[p].id>0){if(d!==""){d=d+","+t[n].ccs[p].id}else{d=t[n].ccs[p].id}}else if(t[n].ccs[p]&&t[n].ccs[p].name){if(d!==""){d=d+","+t[n].ccs[p].name}else{d=t[n].ccs[p].name}}}if(d!=""){}else{g.add("请把抄送人信息填写完整","danger");f.isClick=false;return}r.value=d.toString()}else if(t[n].type=="add_ticket_cc_servicedesk"){if(t[n].value===undefined||t[n].value===""){g.add("请选择客服组","danger");f.isClick=false;return}r.value=JSON.stringify(t[n].value)}else{if(t[n].value===undefined||t[n].value===""){g.add("请把信息填写完整","danger");f.isClick=false;return}r.value=t[n].value}}i.push(r)}a.operations=i;m({url:"ticket_template",method:"POST",data:a}).success(function(e,t,i,n){userAginLogin(e);if(e.success){_hmt.push(["_trackEvent","工单模板","工单模板-添加或编辑工单模板-更新"]);var s=["private","public"];h.config.route.put("system.setting.ticket_public_template.showType",s[a.engineer.id]);f.cancelEdit()}else{if(e.message){g.add(e.message,"danger")}else{g.add("更新失败","danger")}f.isClick=false}})};f.deleteTicketTemplateNote=function(e){f.ticketTemplateNotes.splice(e,1)}}]).controller("editViaEmailController",["$modal_","$scope","$state","$stateParams","$resource","$http","serviceDeskService","alertService","$filter","ConsoleConfig",function(e,l,r,s,t,c,i,u,a,n){l.showMailAddress=1;var o=s.id;l.protocols=["POP3","IMAP"];l.viaEmail={type:"forward",allUserSubmit:"true",blackList:"",whiteList:"",enable:true,copyMailCc:false};var d="";l.suDdomain=n.provider.subDomain;if(n.enviroment=="Production"){l.com="com"}else if(n.enviroment=="Test"){l.com="org"}else{l.com="dev"}if(!l.viaEmail.username&&!l.viaEmail.name&&o>0){l.viaEmail.username=sessionStorage.getItem("viaEmailUsername");l.viaEmail.name=sessionStorage.getItem("viaEmailName")}i.query({_count:999,_do_count:false,_fields:"id,name"},function(e){var t=e.serviceDesks;for(var i=0,n=t.length;i<n;i++){if(t[i].name=="DEFAULT_SERVICE_DESK_NAME"){t[i].name=a("translate")("DEFAULT_SERVICE_DESK_NAME");break}}l.serviceDesks=t;if(o>0){c({url:"via_email/"+o+".json",method:"GET",params:{}}).success(function(e,t,i,n){userAginLogin(e);if(e.success){l.viaEmail=e.json;d=angular.copy(l.viaEmail.username);if(s.type=="copy"){l.viaEmail.id=0}l.blacklist=l.viaEmail.blackList;l.whitelist=l.viaEmail.whiteList;l.viaEmail.protocol=angular.uppercase(l.viaEmail.protocol);if(l.viaEmail.allUserSubmit){l.viaEmail.allUserSubmit="true";l.everyoneClass="tryu";l.customerClass="no_tryu"}else{l.viaEmail.allUserSubmit="false";l.everyoneClass="no_tryu";l.customerClass="customer_tryu"}}})}else{l.viaEmail.serviceDesk=l.serviceDesks[0]}});l.requestting=false;l.saveEmailAddress=function(e){if(!verifyEmailAddress(e.username)){u.add("请输入的正确格式的邮箱","danger");return}var t="support@"+l.suDdomain+".ewei."+l.com;if(e.username===t){u.add("系统转接邮箱不能设置为收件箱","danger");return}if(e.username!=d){e.verified=false}var i=e;l.requestSaveEmail("via_email",i)};l.requestSaveEmail=function(s,a){if(!verifyEmailAddress(a.username)){u.add("请输入的正确格式的邮箱","danger");return}l.requestting=true;c({url:s,method:"POST",data:a}).success(function(e,t,i,n){userAginLogin(e);l.requestting=false;if(e.success){if(o==0){r.go("system_setting.detail",{uri:"via_email",settingType:"ticket"})}sessionStorage.setItem("viaEmailName",a.name);sessionStorage.setItem("viaEmailUsername",a.username);if(s.indexOf("rule")>=0||s.indexOf("list")>=0){u.add("保存成功")}else{u.add("保存成功")}}else{if(e.message=="via_email_username_repeat"||e.message=="via_email_username_is_user_email"||e.message=="via_email_username_is_user_email"){u.add("邮箱已占用，请换一个填写","danger")}else{u.add(e.message,"danger")}}})};l.blackWhite=function(e,t,i,n,s){n=i.split(" ");for(var a=0;a<n.length;a++){if(n[a]=="")continue;if(!verifyEmailAddress(n[a])){if(!s.test(n[a])){u.add("你输入的邮箱或域名格式不正确","danger");return true}}var r=n.slice(a+1);for(var o=0;o<r.length;o++){if(n[a]==r[o]){u.add("你输入的邮箱或域名重复","danger");return true}}}if(t==e.blackList){e.blackList=n.join(" ")}else if(t==e.whiteList){e.whiteList=n.join(" ")}};l.saveEmailRule=function(s,e,t){if(!e.serviceDesk){u.add("更新失败","danger");return false}var i=[];var n=[];var a=/^([a-zA-Z0-9]([a-zA-Z0-9\-]{0,61}[a-zA-Z0-9])?\.)+[a-zA-Z]{2,6}$/;if(t==2){if(l.blacklist){if(l.blackWhite(e,e.blackList,l.blacklist,i,a)){return}else{l.blackWhite(e,e.blackList,l.blacklist,i,a)}}else{e.blackList=l.blacklist}if(l.whitelist){if(l.blackWhite(e,e.whiteList,l.whitelist,n,a)){return}else{l.blackWhite(e,e.whiteList,l.whitelist,n,a)}}else{e.whiteList=l.whitelist}if(l.blacklist&&l.whitelist){i=l.blacklist.split(" ");n=l.whitelist.split(" ");for(var r=0;r<i.length;r++){for(var o=0;o<n.length;o++){if(i[r]==n[o]){u.add("你输入的邮箱或域名不能同时存在黑白名单内","danger");return}}}}}if(e.allUserSubmit=="true"){e.whiteList=""}else{e.blackList=""}c({url:s,method:"POST",data:e}).success(function(e,t,i,n){userAginLogin(e);l.requestting=false;if(e.success){l.viaEmail.id=e.id;if(s.indexOf("rule")>=0||s.indexOf("list")>=0){u.add("保存成功")}else{u.add("保存成功")}}else{u.add("保存失败","danger")}})}}]).controller("editTicketCustomFieldController",["$modal_","$scope","$state","$stateParams","$resource","$http","alertService","customFieldOptions",function(e,l,c,u,t,d,p,i){l.ticketCustomField={};l.styleOptions=i;var n=u.id;l.checkId=u.id;l.editType=u.type;l.ticketSortableOptions={handle:".myHandle",beforeStop:function(e,t){},stop:function(e,t){}};if(n>0){d({url:"custom_field/"+n+".json",method:"GET",params:{}}).success(function(e,t,i,n){userAginLogin(e);if(e.success){l.ticketCustomField=e.json;if(l.ticketCustomField.required){l.isRequired=true}else{l.isRequired=false}if(!l.ticketCustomField.defaultLength){if("subject"==l.ticketCustomField.systemFieldKey){l.ticketCustomField.defaultLength="400"}else if("ticket_description"==l.ticketCustomField.systemFieldKey||"service_catalog"==l.ticketCustomField.systemFieldKey){l.ticketCustomField.defaultLength="200"}else if("ticket_type"==l.ticketCustomField.systemFieldKey){l.ticketCustomField.defaultLength="180"}else if("priority"==l.ticketCustomField.systemFieldKey){l.ticketCustomField.defaultLength="130"}else{l.ticketCustomField.defaultLength="180"}}if(l.ticketCustomField.required!=undefined){l.ticketCustomField.required=l.ticketCustomField.required.toString()}if(!l.ticketCustomField.regexpForValidation){for(var s=0;s<l.styleOptions.length;s++){if(l.styleOptions[s].value==l.ticketCustomField.type&&l.styleOptions[s].regexp){l.ticketCustomField.regexpForValidation=l.styleOptions[s].regexp}}}if((l.ticketCustomField.type=="options"||l.ticketCustomField.type=="multi_options")&&l.ticketCustomField.customFieldOptions!=undefined){l.ticketCustomField.customFieldOptions=angular.fromJson(l.ticketCustomField.customFieldOptions)}if(l.ticketCustomField.type=="cascade_options"){l.mulOptions=angular.fromJson(l.ticketCustomField.customFieldOptions)}}})}else{l.ticketCustomField={type:"text",property:"text",active:true,defaultValue:"",required:"false",defaultLength:"180",sysCustomForm:true,customFieldOptions:[{name:"",value:"",defaultValue:""}]};l.mulOptions=[{name:"",value:"",children:[{name:"",value:""}]}]}l.recoveryDefault=function(e){if(e.defaultLength==""||e.defaultLength==null){if("subject"==l.ticketCustomField.systemFieldKey){l.ticketCustomField.defaultLength="400"}else if("ticket_description"==l.ticketCustomField.systemFieldKey||"service_catalog"==l.ticketCustomField.systemFieldKey){l.ticketCustomField.defaultLength="200"}else if("ticket_type"==l.ticketCustomField.systemFieldKey){l.ticketCustomField.defaultLength="180"}else if("priority"==l.ticketCustomField.systemFieldKey){l.ticketCustomField.defaultLength="130"}else{l.ticketCustomField.defaultLength="180"}}};l.toAddOption=function(e){if(l.ticketCustomField.systemFieldKey!="ticket_type"&&l.ticketCustomField.systemFieldKey!="multi_options"){l.ticketCustomField.customFieldOptions.push({name:"",value:""})}else{l.ticketCustomField.customFieldOptions.push({name:"",value:"",defaultValue:""})}};l.toDeleteOption=function(e){var t=l.ticketCustomField.customFieldOptions;if(e&&t.length>1){t.splice(e,1)}};l.addMainOption=function(){l.mulOptions.push({name:"",value:"",children:[{name:"",value:""}]})};l.delMainOption=function(e){if(l.mulOptions.length==1){return false}else{l.mulOptions.splice(e,1)}};l.addSubOption=function(e){e.item.children.push({name:"",value:""})};l.delSubOption=function(e,t){if(t>0){e.item.children.splice(t,1)}};l.selectRadio=function(e){if(!l.ticketCustomField.systemFieldKey){l.selectId=e.$index}else{var t=e.$parent.ticketCustomField.customFieldOptions;for(var i=0;i<t.length;i++){if(i!=e.$index){t[i].defaultValue="false"}else{t[i].defaultValue="true"}}}};l.checkMultiValue=function(e){var t=window.event?e.keyCode:e.which;if(t==188){p.add("多选下拉框中不能输入逗号","danger");e.preventDefault()}};l.checkCascadetiValue=function(e){var t=window.event?e.keyCode:e.which;if(t==191){p.add('级联下拉框中不能输入"/"',"danger");e.preventDefault()}};l.changeReg=function(e){for(var t=0;t<l.styleOptions.length;t++){if(l.styleOptions[t].value==e&&l.styleOptions[t].regexp!=undefined){l.ticketCustomField.regexpForValidation=l.styleOptions[t].regexp}}if(l.editType=="copy"){l.mulOptions=[{name:"",value:"",children:[{name:"",value:""}]}];l.ticketCustomField.customFieldOptions=[{name:"",value:"",defaultValue:""}]}};l.reset=function(e){angular.forEach(l.fieldPermissions,function(e){e.scan_able=1;e.edit_able=1});if(e.systemFieldKey=="priority"){l.ticketCustomField.title="优先级";l.ticketCustomField.customFieldOptions=[{name:"P1",value:"P1"},{name:"P2",value:"P2"},{name:"P3",value:"P3"},{name:"P4",value:"P4"},{name:"P5",value:"P5"}];l.ticketCustomField.defaultValue="P3";l.ticketCustomField.required="false";l.ticketCustomField.defaultLength="130"}else if(e.systemFieldKey=="ticket_type"){l.ticketCustomField.title="类型";delete l.ticketCustomField.defaultValue;l.ticketCustomField.required="false";l.ticketCustomField.customFieldOptions=[{name:"事件",value:""},{name:"问题",value:""},{name:"任务",value:""},{name:"问询",value:""}];l.ticketCustomField.defaultLength="180"}else if(e.systemFieldKey=="service_catalog"){l.ticketCustomField.title="服务目录";l.ticketCustomField.defaultValue="";l.ticketCustomField.required="false";l.ticketCustomField.notes="工单服务目录";l.ticketCustomField.defaultLength="200"}else if(e.systemFieldKey=="ticket_description"){l.ticketCustomField.title="描述";l.ticketCustomField.required="false";l.ticketCustomField.notes="工单描述";l.ticketCustomField.defaultLength="200"}else if(e.systemFieldKey=="subject"){l.ticketCustomField.title="主题";l.ticketCustomField.notes="工单主题";l.ticketCustomField.defaultLength="400"}};l.isRequiredChange=function(){if("true"==l.ticketCustomField.required){angular.forEach(l.fieldPermissions,function(e){e.scan_able=1;e.edit_able=1});l.showJurisdictionPromet=true;l.isRequired=true}else{l.showJurisdictionPromet=false;l.isRequired=false}};l.saveTicketCustomField=function(e){if(e.type==""){p.add("请选择样式","danger");return}if(!e.title){p.add("请输入字段名称","danger");return}var a={};if(e.type=="options"||e.type=="checkbox"||e.type=="date"||e.type=="date_to_date"||e.type=="cascade_options"||e.type=="date_time"||e.type=="multi_options"||e.systemFieldKey){if(e.regexpForValidation){delete e.regexpForValidation}}if(e.id!=undefined){a.id=e.id}if(l.editType=="copy"){a.id=0}var t={};a.fieldPermissions=[];angular.forEach(l.fieldPermissions,function(e){t={role:{id:""},customField:{id:""},scan_able:"",edit_able:""};t.role.id=e.role_id;t.customField.id=u.id;t.scan_able=e.scan_able;t.edit_able=e.edit_able;a.fieldPermissions.push(t)});a.required=e.required;a.active=e.active;a.type=e.type;a.title=e.title;a.regexpForValidation=e.regexpForValidation;a.notes=e.notes;a.url=e.url;a.defaultValue=e.defaultValue;if(e.systemFieldKey){a.sysCustomForm=true}else{if(angular.isUndefined(e.sysCustomForm)){a.sysCustomForm=false}else{a.sysCustomForm=e.sysCustomForm}}a.scope="ticket";var i=false;if(e.type=="options"||e.type=="multi_options"){i=false;for(var n=0;n<e.customFieldOptions.length;n++){if(e.customFieldOptions[n].name==""&&e.customFieldOptions[n].value==""){p.add("选项值不能为空","danger");return}else if(e.customFieldOptions[n].name==""){e.customFieldOptions[n].name=e.customFieldOptions[n].value}else if(e.customFieldOptions[n].value==""){if(e.systemFieldKey!="ticket_type"){e.customFieldOptions[n].value=e.customFieldOptions[n].name}}else if(e.customFieldOptions[n].value!=""&&e.customFieldOptions[n].name!=""&&e.systemFieldKey!="priority"){if(e.systemFieldKey!="ticket_type"){e.customFieldOptions[n].value=e.customFieldOptions[n].name}}if(e.customFieldOptions[n].value==a.defaultValue){i=true}}a.customFieldOptions=JSON.stringify(e.customFieldOptions);a.openSearch=e.openSearch;if(!i){a.defaultValue=""}}else if(e.type=="cascade_options"&&!e.systemFieldKey){for(var n=0;n<l.mulOptions.length;n++){if(l.mulOptions[n].name==""&&l.mulOptions[n].value==""){p.add("选项值不能为空","danger");return}else if(l.mulOptions[n].name==""){l.mulOptions[n].name=l.mulOptions[n].value}else if(l.mulOptions[n].value==""){l.mulOptions[n].value=l.mulOptions[n].name}else if(l.mulOptions[n].name!=""&&l.mulOptions[n].value!=""){l.mulOptions[n].name=l.mulOptions[n].value}var s=l.mulOptions[n].children;for(var r=0;r<s.length;r++){if(s[r].name==""&&s[r].value==""){p.add("选项值不能为空","danger");return}else if(s[r].name==""){s[r].name=s[r].value}else if(s[r].value==""){s[r].value=s[r].name}else if(s[r].value!=""&&s[r].name!=""){s[r].name=s[r].value}}}a.customFieldOptions=angular.toJson(l.mulOptions)}else if(e.type=="checkbox"){a.required=false}if(!e.defaultLength){p.add("字段默认列宽不能为空","danger");return}else{var o=/^\d+(?=\.{0,1}\d+$|$)/;if(!o.test(e.defaultLength)){p.add("字段默认列宽必须为正数","danger");return}a.defaultLength=e.defaultLength}l.btnDisabled=true;d({url:"custom_field.json",method:"POST",data:a}).success(function(e,t,i,n){userAginLogin(e);if(e.success){if(l.ticketCustomField.systemFieldKey==="priority"){var s=JSON.parse(localStorage.getItem("systemFieldPriority"));s.customFieldOptions=a.customFieldOptions;s.notes=a.notes;s.title=a.title;s.defaultValue=a.defaultValue;s.defaultLength=a.defaultLength;localStorage["systemFieldPriority"]=JSON.stringify(s)}p.add("更新成功","success");c.go("system_setting.detail",{uri:"ticket_custom_field",settingType:"ticket"})}else{if(e.message=="option_name_not_unique"){p.add("选项不能重复","danger")}else if(e.message=="priority_option_error"){p.add("优先级选项错误","danger")}else{p.add("更新失败","danger")}l.btnDisabled=false}})}}]).controller("editTicketListCustomController",["$modal_","$scope","$rootScope","$state","$stateParams","$resource","$http","permissions","alertService","ticketListCustomOptions","ticketListFilterOptions","ticketListCustomGroupByOptions","ticketListCustomOrderByOptions","ConsoleConfig","ticketEvaluateService","serviceDesks","$filter","DefaultColumnWidth","coreModelService","ticketStatusCompareService","commonTools",function(e,L,m,t,D,i,c,n,g,s,P,a,r,v,o,l,x,N,h,y,u){L.ticketListCustom={};L.ticketAllListFilters=[];L.ticketAnyListFilters=[];if(n.hasPermission("ticket_view_manage")){L.viewPermissions=true}else{L.viewPermissions=false}if(D.id==0){if(m.customViewType!="private"){if(n.hasPermission("ticket_view_manage")){L.listCustomType={type:"public"}}else{L.listCustomType={type:"private"}}}else{L.listCustomType={type:"private"}}}L.ticketListCustom.isSystemDefault=D.isSystemDefault=="1"?true:false;var M=angular.copy(s);var d=D.id;function j(e,t){if(Object.prototype.toString.call(e)==="[object Array]"&&typeof t==="object"){for(var i=0;i<e.length;i++){if(e[i].value===t.id){return true}}}return false}function R(e){var t=L.ticketListCustom.filterEngineerDeskIds&&L.ticketListCustom.filterEngineerDeskIds.split(",");var i=0;if(e.$or!=undefined&&angular.isArray(e.$or)){for(var n=0;n<e.$or.length;n++){L.ticketAnyListFilters.push({firstValue:"",secondValue:"",thirdValue:"",firstOptions:L.ticketAllCustomField,secondOptions:"",thirdOptions:"",valueType:"select"});var s=e.$or[n];for(var a in s){for(var r in s[a]){if(r=="id"&&s[a][r].indexOf("copy_to_user_or_email_ticket_ids_")!=-1){L.ticketAnyListFilters[n].firstValue="copyTo";L.ticketAnyListFilters[n].secondValue=a;var o=s[a][r].replace("[${copy_to_user_or_email_ticket_ids_","").replace("!}]","");var l=o.split(",");L.ticketAnyListFilters[n].thirdValue=L.ticketCcValues(l);void 0;L.ticketAnyListFilters[n].secondOptions=P.secondFilterOptions("copyTo");L.ticketAnyListFilters[n].isExist=true;K(L.ticketAnyListFilters[n],"copyTo");G(L.ticketAnyListFilters[n],"copyTo")}else if(r=="user.id"&&Object.prototype.toString.call(s[a][r])==="[object String]"&&s[a][r].indexOf("creator_service_desk_id_")!=-1){L.ticketAnyListFilters[n].firstValue="engineerGroup";L.ticketAnyListFilters[n].secondValue=a;L.ticketAnyListFilters[n].thirdValue=s[a][r].replace("[${creator_service_desk_id_","").replace("!}]","");L.ticketAnyListFilters[n].secondOptions=P.secondFilterOptions("engineerGroup");L.ticketAnyListFilters[n].isExist=true;K(L.ticketAnyListFilters[n],"engineerGroup");G(L.ticketAnyListFilters[n],"engineerGroup")}else if(r==="via.channel"){var c=s[a][r].split("_");L.ticketAnyListFilters[n].thirdValue={viaType:c[0],channel:c[0]};if(c[1]){L.ticketAnyListFilters[n].thirdValue.via={uid:c[1],name:c[2]||""}}L.ticketAnyListFilters[n].firstValue=r;L.ticketAnyListFilters[n].secondValue=a;L.ticketAnyListFilters[n].secondOptions=P.secondFilterOptions(r);L.ticketAnyListFilters[n].isExist=true;K(L.ticketAnyListFilters[n],r);G(L.ticketAnyListFilters[n],r)}else{L.ticketAnyListFilters[n].firstValue=r;if(r==="requester.userGroup.id"||r==="serviceDesk.id"){if(a!="$in"&&a!="$not_in"){L.ticketAnyListFilters[n].secondValue=a==="$eq"?"$in":"$not_in"}else{L.ticketAnyListFilters[n].secondValue=a}}else{L.ticketAnyListFilters[n].secondValue=a}if(typeof s[a][r]=="number"){L.ticketAnyListFilters[n].thirdValue=s[a][r]}else{if(r==="status"||r==="serviceDesk.id"){if(angular.isArray(s[a][r])){L.ticketAnyListFilters[n].thirdValue=s[a][r][0]}else{L.ticketAnyListFilters[n].thirdValue=s[a][r]}}else if(r==="ticketMetric.planSolvedAt"){var o=s[a][r].replace("${remainder_plan_solved_minute_time_","").replace("!}","");L.ticketAnyListFilters[n].thirdValue=parseInt(o)}else if(r==="requester.userGroup.id"){L.ticketAnyListFilters[n].thirdValue=s[a][r]}else{if(typeof s[a][r]==="boolean"){L.ticketAnyListFilters[n].thirdValue=true}else{L.ticketAnyListFilters[n].thirdValue=s[a][r].replace("[${service_catalog_and_children_id_","").replace("!}]","")}}}var u;for(var d in L.ticketAllCustomField){u=L.ticketAllCustomField[d].value;if(u&&u.indexOf(r)>-1){r=u;L.ticketAnyListFilters[n].isExist=true;break}}L.ticketAnyListFilters[n].firstValue=r;L.ticketAnyListFilters[n].secondOptions=P.secondFilterOptions(r);K(L.ticketAnyListFilters[n],r);G(L.ticketAnyListFilters[n],r)}if(r=="engineer.id"){V(t[i++],L.ticketAnyListFilters[n]);q(s[a][r],L.ticketAnyListFilters[n])}}}}}}function U(){var e=[{option:"状态",value:"status"}];var t=[];for(var i=0;i<L.useOptions.length;i++){for(var n=0;n<a.length;n++){if(L.useOptions[i].value==a[n].value){e.push(a[n])}}for(var n=0;n<r.length;n++){if(L.useOptions[i].value==r[n].value){t.push(r[n])}}}L.ticketListCustomGroupByOptions=e;L.ticketListCustomOrderByOptions=t}L.ticketCcValues=function(e){var t="";var i=false;var n=[];for(var s=0;s<e.length;s++){if(validEmail(e[s])){n.push({name:e[s]})}else{var a=parseInt(e[s]);t+=a+",";i=true}}if(i){n.push({ids:t})}return n};var V=function(e,s){if(e){c({url:"service_desk/"+e+".json",method:"GET",params:{}}).success(function(e,t,i,n){s.engineerDesk=e.json})}};var q=function(e,s){if(e==="${current_engineer_id}"){s.thirdValue={name:"（当前客服）",id:"${current_engineer_id}"}}else{c({url:"engineer/"+e+".json",method:"GET",params:{}}).success(function(e,t,i,n){s.thirdValue=e.json})}};L.selectedServiceDesk={serviceDesk:[]};l.query({_count:999,_do_count:false,_filter:'{"$ne":{"deleted":true}}',_fields:"id,name"},function(e){var t=e.serviceDesks||[];var i=false,n=false;for(var s=0;s<t.length;s++){if(t[s].name=="DEFAULT_SERVICE_DESK_NAME"){t[s].name=x("translate")(t[s].name);i=true}if(i&&n){break}}L.serviceDesks=t});L.showDefault=function(e){e.isShowDefault=!e.isShowDefault};L.setDefault=function(e){e.length=e.default_length};function p(){if(d>0){L.title="编辑自定义工单视图";c({url:"get_view_id.json",method:"GET",params:{id:d}}).success(function(e,t,i,n){userAginLogin(e);if(e.success){L.ticketListCustom=e.json;if(e.json.engineer){L.listCustomType={type:"private"}}else{L.listCustomType={type:"public"}}if(L.ticketListCustom.isSystemDefault){L.ticketListCustom.copyTitle=angular.copy(L.ticketListCustom.title)}L.ticketListCustom.title=x("translate")(L.ticketListCustom.title);if(L.ticketListCustom.filter!=undefined&&L.ticketListCustom.filter!=""&&!L.ticketListCustom.isSystemDefault){var s=JSON.parse(L.ticketListCustom.filter);var a;var r;if(L.ticketListCustom.customFieldFilter){a=JSON.parse(L.ticketListCustom.customFieldFilter)}else{a={}}if(a.$and&&a.$and.length===2&&a.$and[0].$and){if(s.$and&&s.$and.length===2&&s.$and[0].$and){s.$and[0].$and=s.$and[0].$and.concat(a.$and[0].$and);s.$and[1].$or=s.$and[1].$or.concat(a.$and[1].$or)}}if(s.$and&&s.$and.length===2&&s.$and[0].$and){r=s.$and[1];s=s.$and[0]}var o=0;var l=L.ticketListCustom.filterEngineerDeskIds&&L.ticketListCustom.filterEngineerDeskIds.split(",");if(s.$and!=undefined&&angular.isArray(s.$and)){for(var c=0;c<s.$and.length;c++){var u=s.$and[c];for(var d in u){if(d=="$or"){R(u)}else{L.ticketAllListFilters.push({firstValue:"",secondValue:"",thirdValue:"",firstOptions:L.ticketAllCustomField,secondOptions:"",thirdOptions:"",valueType:"select",engineerDesk:""});for(var p in u[d]){var f=u[d][p];if(p=="id"&&f.indexOf("copy_to_user_or_email_ticket_ids_")!=-1){L.ticketAllListFilters[c].firstValue="copyTo";L.ticketAllListFilters[c].secondValue=d;var m=u[d][p].replace("[${copy_to_user_or_email_ticket_ids_","").replace("!}]","");var g=m.split(",");L.ticketAllListFilters[c].thirdValue=L.ticketCcValues(g);L.ticketAllListFilters[c].secondOptions=P.secondFilterOptions("copyTo");L.ticketAllListFilters[c].isExist=true;K(L.ticketAllListFilters[c],"copyTo");G(L.ticketAllListFilters[c],"copyTo")}else if(p=="user.id"&&Object.prototype.toString.call(f)==="[object String]"&&f.indexOf("creator_service_desk_id_")!=-1){L.ticketAllListFilters[c].firstValue="engineerGroup";L.ticketAllListFilters[c].secondValue=d;L.ticketAllListFilters[c].thirdValue=u[d][p].replace("[${creator_service_desk_id_","").replace("!}]","");L.ticketAllListFilters[c].secondOptions=P.secondFilterOptions("engineerGroup");L.ticketAllListFilters[c].isExist=true;K(L.ticketAllListFilters[c],"engineerGroup");G(L.ticketAllListFilters[c],"engineerGroup")}else{L.ticketAllListFilters[c].firstValue=p;if(p==="requester.userGroup.id"||p==="serviceDesk.id"){if(d!="$in"&&d!="$not_in"){L.ticketAllListFilters[c].secondValue=d==="$eq"?"$in":"$not_in"}else{L.ticketAllListFilters[c].secondValue=d}}else{L.ticketAllListFilters[c].secondValue=d}if(typeof u[d][p]=="number"){L.ticketAllListFilters[c].thirdValue=u[d][p]}else{if(p==="status"||p==="serviceDesk.id"){if(angular.isArray(u[d][p])){L.ticketAllListFilters[c].thirdValue=u[d][p][0]}else{L.ticketAllListFilters[c].thirdValue=u[d][p]}}else if(p==="ticketMetric.planSolvedAt"){var m=u[d][p].replace("${remainder_plan_solved_minute_time_","").replace("!}","");L.ticketAllListFilters[c].thirdValue=parseInt(m)}else if(p==="requester.userGroup.id"){L.ticketAllListFilters[c].thirdValue=u[d][p]}else if(p==="via.channel"){var v=u[d][p].split("_");L.ticketAllListFilters[c].thirdValue={viaType:v[0],channel:v[0]};if(v[1]){L.ticketAllListFilters[c].thirdValue.via={uid:v[1],name:v[2]||""}}}else{if(typeof u[d][p]==="boolean"){L.ticketAllListFilters[c].thirdValue=true}else{L.ticketAllListFilters[c].thirdValue=u[d][p].replace("[${service_catalog_and_children_id_","").replace("!}]","")}}}var h;for(var y in L.ticketAllCustomField){h=L.ticketAllCustomField[y].value;if(h&&h.indexOf(p)>-1){p=h;L.ticketAllListFilters[c].isExist=true;break}}L.ticketAllListFilters[c].firstValue=p;L.ticketAllListFilters[c].secondOptions=P.secondFilterOptions(p);K(L.ticketAllListFilters[c],p);G(L.ticketAllListFilters[c],p)}if(p=="engineer.id"){V(l[o++],L.ticketAllListFilters[c]);q(u[d][p],L.ticketAllListFilters[c])}}}}}}R(r||s)}if(D.type=="copy"){L.ticketListCustom.id="";L.ticketListCustom.title="";L.ticketListCustom.isSystemDefault=0;L.ticketListCustom.isCustomField=1;L.ticketListCustom.position=20}var _=JSON.parse(L.ticketListCustom.ticketCustomFields);for(var c=0;c<_.length;c++){if(_[c].systemFieldKey=="priority"){M.push({option:_[c].title,value:"priority",width:"w150",isDefault:true,default_length:_[c].default_length})}else if(_[c].systemFieldKey=="ticket_type"){M.push({option:_[c].title,value:"ticketType.name",width:"w150",isDefault:true,default_length:_[c].default_length})}else if(_[c].systemFieldKey=="service_catalog"){M.push({option:_[c].title,value:"serviceCatalog.id",width:"w150",isDefault:true,default_length:_[c].default_length})}else if(_[c].systemFieldKey=="subject"){M.push({option:_[c].title,value:"subject",width:"w150",isDefault:true,default_length:_[c].default_length})}else if(_[c].systemFieldKey=="tags"){M.push({option:_[c].title,value:"tags",width:"w150",isDefault:true,default_length:_[c].default_length})}}var k=[];var C=[];if(L.ticketListCustom.fields!=undefined){var b=L.ticketListCustom.fields.split(",");if(L.ticketListCustom.fieldsLength){var w=L.ticketListCustom.fieldsLength.split(",")}for(var d=0;d<b.length;d++){for(var c=0;c<M.length;c++){if(b[d]==M[c].value){if(w&&w.length){M[c].length=w[d]}k.push(M[c]);break}}}}if(L.ticketListCustom.otherFields!=undefined){var T=L.ticketListCustom.otherFields.split(",");if(L.ticketListCustom.otherFieldsLength){var S=L.ticketListCustom.otherFieldsLength.split(",")}for(var d=0;d<T.length;d++){for(var c=0;c<M.length;c++){if(T[d]==M[c].value){if(S&&S.length){M[c].length=S[d]}k.push(M[c]);break}}}}if(L.ticketListCustom.customFields!=undefined&&L.ticketListCustom.customFields!=""&&L.ticketListCustom.ticketCustomFields!=undefined){var F=JSON.parse(L.ticketListCustom.customFields);if(L.ticketListCustom.customFieldsLength){var A=L.ticketListCustom.customFieldsLength.split(",")}for(var c=0;c<F.length;c++){for(var d=0;d<_.length;d++){if(_[d].title==F[c].title){if(_[d].systemFieldKey==null||_[d].systemFieldKey==""){var E={option:F[c].title,value:F[c].id,default_length:_[c].default_length};if(A&&A.length){E.length=A[c]}k.push(E);break}}}}}if(L.ticketListCustom.sortFields){var $=JSON.parse(L.ticketListCustom.sortFields)}if($&&$.length>0){var O=[];angular.forEach($,function(e){for(var t=0;t<k.length;t++){if(k[t].value==e.id){O.push(k[t]);break}}});k=O}for(var c=0;c<M.length;c++){var m=true;for(var d=0;d<k.length;d++){if(k[d].value==M[c].value){m=false;break}}if(m){C.push(M[c])}}if(L.ticketListCustom.ticketCustomFields!=undefined&&L.ticketListCustom.ticketCustomFields!=""){var _=JSON.parse(L.ticketListCustom.ticketCustomFields);for(var c=0;c<_.length;c++){if(k==undefined||k.length==0||!j(k,_[c])){if(!_[c].systemFieldKey&&(_[c].scan_able===1&&!L.ticketListCustom.isSystemDefault||L.ticketListCustom.isSystemDefault)){C.push({option:_[c].title,value:_[c].id,default_length:_[c].default_length})}}}}if(!L.ticketListCustom.engineer){var I=[];angular.forEach(L.ticketListCustom.serviceDesks,function(e){I.push(e.id)});L.selectedServiceDesk.serviceDesk=I}angular.forEach(k,function(e){if(e.isDefault){e.length=e.length||e.default_length||N.ticketFields[e.value];e.default_length=e.default_length||N.ticketFields[e.value]}else{e.length=e.length||e.default_length||N["ticketDefault"];e.default_length=e.default_length||N["ticketDefault"]}});angular.forEach(C,function(e){if(e.isDefault){e.length=e.length||e.default_length||N.ticketFields[e.value];e.default_length=e.default_length||N.ticketFields[e.value]}else{e.length=e.length||e.default_length||N["ticketDefault"];e.default_length=e.default_length||N["ticketDefault"]}});L.noUseOptions=C;L.useOptions=k;void 0;void 0;U()}})}else{var a=[];var r=[];var e="";var t="";var i="";var n="";L.title="添加自定义工单视图";L.ticketListCustom.isSystemDefault=0;L.ticketListCustom.isCustomField=1;L.ticketListCustom.position=20;try{e=JSON.parse(localStorage["systemFieldSubject"]).title;n=JSON.parse(localStorage["systemFieldTags"]).title}catch(e){}a.push({option:e,value:"subject",width:"w500",isDefault:true},{option:"编号",value:"no",width:"w100",isDefault:true},{option:"客户",value:"requester.name",width:"w200",isDefault:true},{option:"处理人",value:"engineer.user.name",width:"w200",isDefault:true},{option:n,value:"tags",width:"w150",isDefault:true},{option:"创建于",value:"createdAt",width:"w200",isDefault:true});for(var s=0;s<M.length;s++){if(a==undefined||(JSON.stringify(a).indexOf(M[s].value)==-1||JSON.stringify(a).indexOf(M[s].option)==-1)){r.push(M[s])}}c.get("custom_field.json?scope=ticket&active=true").success(function(e,t){userAginLogin(e);var i=e.json;L.ticketListCustom.ticketCustomFields=i;for(var n=0,s=i.length;n<s;n++){if(i[n].systemFieldKey=="priority"){r.push({option:i[n].title,value:"priority",width:"w150",isDefault:true});M.push({option:i[n].title,value:"priority",width:"w150",isDefault:true})}else if(i[n].systemFieldKey=="ticket_type"){r.push({option:i[n].title,value:"ticketType.name",width:"w150",isDefault:true});M.push({option:i[n].title,value:"ticketType.name",width:"w150",isDefault:true})}else if(i[n].systemFieldKey=="service_catalog"){r.push({option:i[n].title,value:"serviceCatalog.id",width:"w150",isDefault:true});M.push({option:i[n].title,value:"serviceCatalog.id",width:"w150",isDefault:true})}else if(i[n].systemFieldKey=="subject"){M.push({option:i[n].title,value:"subject",width:"w500",isDefault:true})}else if(i[n].systemFieldKey=="ticket_description"||i[n].systemFieldKey=="tags"){continue}else{r.push({option:i[n].title,value:i[n].id})}}angular.forEach(a,function(e){if(e.isDefault){e.length=e.length||e.default_length||N.ticketFields[e.value];e.default_length=e.default_length||N.ticketFields[e.value]}else{e.length=e.length||e.default_length||N["ticketDefault"];e.default_length=e.default_length||N["ticketDefault"]}});angular.forEach(r,function(e){if(e.isDefault){e.length=e.length||e.default_length||N.ticketFields[e.value];e.default_length=e.default_length||N.ticketFields[e.value]}else{e.length=e.length||e.default_length||N["ticketDefault"];e.default_length=e.default_length||N["ticketDefault"]}})});L.noUseOptions=r;L.useOptions=a;U()}}function f(){var l=[];c.get("custom_field.json?scope=ticket&active=true").success(function(e,t){angular.forEach(e.json,function(e,t,i){var n={};var s="";if(e.systemFieldKey=="priority"){n={option:"工单："+e.title,value:"priority",valueType:"select"}}else if(e.systemFieldKey=="ticket_type"){n={option:"工单："+e.title,value:"ticketType",valueType:"select"}}else if(e.systemFieldKey=="service_catalog"){n={option:"工单："+e.title,value:"serviceCatalog",valueType:"servicecatalog"}}else if(e.systemFieldKey=="subject"){n={option:"工单："+e.title,value:"subject",valueType:"subject"}}else if(e.systemFieldKey=="tags"){n={option:"工单："+e.title,value:"tags",valueType:"text"}}else if(e.systemFieldKey=="ticket_description"){return}else if(e.type=="date_to_date"){return}else if(e.type=="date_time"){n={option:"工单：自定义字段-"+e.title,value:"ticketcustomfield_"+e.type+"_"+e.id,valueType:"date_time"}}else{n={option:"工单：自定义字段-"+e.title,value:"ticketcustomfield_"+e.type+"_"+e.id,valueType:"text"}}if(e.type=="text"||e.type=="email"||e.type=="regexp"||e.type=="textarea"||e.type=="number"||e.type=="decimal"){n.valueType="text"}else if(e.type=="date"){n.valueType=e.type;n.start=false}else if(e.type=="date_time"){n.valueType=e.type}else if(e.type=="options"){if(e.customFieldOptions){if(e.systemFieldKey){n.valueType="select";var a=angular.fromJson(e.customFieldOptions);for(var r=0,o=a.length;r<o;r++){a[r].option=a[r].name}n.valueOptions=a}else{n.valueType="options";if(e.customFieldOptions){n.valueOptions=e}}}}else if(e.type=="cascade_options"){if(e.systemFieldKey=="service_catalog"){n.valueType="serviceCatalog"}else{n.valueType="cascade_options";if(e.customFieldOptions){n.valueOptions=e}}}else if(e.type=="multi_options"){n.valueType="multi_options";if(e.customFieldOptions){n.valueOptions=e}}else if(e.type=="checkbox"){n.valueType="checkbox"}else{n.valueType="text"}n.edit_able=e.edit_able;if(s!=""){n.startTimeForm=false;n.endTimeForm=false;l.push(s)}else{if(!e.systemFieldKey){l.push(n)}}});L.ticketAllCustomField=P.firstFilterOptions("all").concat(l);p();L.datepickers={startForm:false,startTo:false,updateFrom:false,updateTo:false};L.open=function(e,t,i){e.preventDefault();e.stopPropagation();t[i].start=!t[i].start};L.timeFrameOpen=function(e,t,i,n){e.preventDefault();e.stopPropagation();t[i][n]=!t[i][n]}})}function _(){f()}_();L.toAddFilterOption=function(e){var t;if(e==="all"){t=L.ticketAllListFilters}else{t=L.ticketAnyListFilters}var i=L.ticketAllCustomField;var n="";var s="";var a="";var r="";try{n=JSON.parse(localStorage["systemFieldSubject"]).title;s=JSON.parse(localStorage["systemFieldPriority"]).title;a=JSON.parse(localStorage["systemFieldServiceCatalog"]).title;r=JSON.parse(localStorage["systemFieldTicketType"]).title}catch(e){}for(var o=0;o<i.length;o++){if(i[o].value=="subject"){i[o].option="工单:"+n}else if(i[o].value=="priority"){i[o].option="工单:"+s}else if(i[o].value=="ticketType.id"){i[o].option="工单:"+r}else if(i[o].value=="serviceCatalog.id"){i[o].option="工单:"+a}}t.push({firstValue:"",secondValue:"",thirdValue:"",firstOptions:i,secondOptions:"",thirdOptions:"",valueType:"select",isExist:true})};L.toDeleteAllFilterOption=function(e){var t=L.ticketAllListFilters;t.splice(e,1)};L.toDeleteAnyFilterOption=function(e){var t=L.ticketAnyListFilters;t.splice(e,1)};L.firstAllFilterOptionChange=function(e,t){var i=L.ticketAllListFilters[e].firstValue;L.ticketAllListFilters[e].secondOptions=P.secondFilterOptions(i);L.ticketAllListFilters[e].thirdValue="";K(L.ticketAllListFilters[e],i);G(L.ticketAllListFilters[e],i)};L.firstAnyFilterOptionChange=function(e,t){var i=L.ticketAnyListFilters[e].firstValue;L.ticketAnyListFilters[e].secondOptions=P.secondFilterOptions(i);L.ticketAnyListFilters[e].thirdValue="";K(L.ticketAnyListFilters[e],i);G(L.ticketAnyListFilters[e],i)};var G=function(e,t){if(t=="serviceCatalog.id"){e.valueType="serviceCatalog"}else if(t=="serviceDesk.id"||t=="engineerGroup"){e.valueType="serviceDesk"}else if(t=="requester.id"){e.valueType="requester"}else if(t=="user.id"){e.valueType="user"}else if(t=="engineer.id"){e.valueType="engineer"}else if(t=="requester.userGroup.id"){e.valueType="userGroup"}else if(t=="subject"||t=="tags"){e.valueType="text"}else if("createdAt,ticketMetric.responseAt,ticketMetric.solvedAt,lastReply,customerLastReply,engineerLastReply,ticketMetric.pausedAt,ticketMetric.planSolvedAt".indexOf(t)!=-1){e.valueType="number"}else if(t=="copyTo"){e.valueType="copyTo"}else if(t=="via.channel"){e.valueType="via"}else{if(t.indexOf("ticketcustomfield")===-1){e.valueType="select"}}};L.statusDelete=function(n){if(n.firstValue&&n.firstValue=="status"&&n.thirdValue!="deleted"){angular.forEach(n.thirdOptions,function(e,t,i){if(e.value=="deleted"){n.thirdOptions.splice(t,1)}})}};function k(){var e;if(localStorage){try{e=angular.fromJson(localStorage.systemFieldPriority);angular.isObject(e)&&(e.customFieldOptions=angular.fromJson(e.customFieldOptions));if(angular.isArray(e.customFieldOptions)){for(var t=0;t<e.customFieldOptions.length;t++){e.customFieldOptions[t].option=e.customFieldOptions[t].name}return e.customFieldOptions}}catch(e){}}return[{value:"P1",option:"P1"},{value:"P2",option:"P2"},{value:"P3",option:"P3"},{value:"P4",option:"P4"},{value:"P5",option:"P5"}]}var K=function(o,e){if(e=="status"){o.thirdOptions=[{value:"new",option:"未分派"},{value:"assigned",option:"已分派"},{value:"open",option:"处理中"},{value:"solved",option:"处理完毕"},{value:"closed",option:"关闭"},{value:"pending",option:"暂停"},{value:"suspended",option:"隔离"}]}else if(e=="priority"){o.thirdOptions=k()}else if(e=="evaluate.solved"){o.thirdOptions=[{option:"已解决",value:"1"},{option:"未解决",value:"0"}]}else if(e=="lastReplyUserType"){o.thirdOptions=[{option:"客户",value:"$customer"},{option:"客服",value:"$engineer"}]}else if(e=="ticketHaveEvaluate"){o.thirdOptions=[{option:"真实评价",value:"true"}]}else if(e=="evaluate.score"){o.thirdOptions=[{option:"1分",value:"1"},{option:"2分",value:"2"},{option:"3分",value:"3"},{option:"4分",value:"4"},{option:"5分",value:"5"}]}else if(e=="via.channel"){}else if(e=="ticketType.id"){c({url:"ticket_type.json",method:"GET",params:{_count:12332,_do_count:false,_fields:"id,name,description,isDefault"}}).success(function(e,t,i,n){if(e.ticketTypes){var s=[];for(var a=0,r=e.ticketTypes.length;a<r;a++){s.push({option:e.ticketTypes[a].name,value:e.ticketTypes[a].id})}o.thirdOptions=s}})}else{if(e.indexOf("ticketcustomfield")>-1){for(var t in o.firstOptions){var i=o.firstOptions[t];if(i.value===e){if(i.valueOptions){o.customField=angular.copy(i.valueOptions)}if(o.thirdValue&&o.customField){o.customField.value=o.thirdValue}if(i.valueType==="date"){o.thirdValue=x("date")(o.thirdValue,"yyyy/MM/dd").toString();o.thirdValue=u.parseDate(o.thirdValue,"yyyy/MM/dd")}o.edit_able=i.edit_able;o.valueType=i.valueType;break}}}}};L.listCustom=function(){t.go("system_setting.detail",{uri:"ticket_list_custom",settingType:"ticket"})};L.orderByChange=function(){L.ticketListCustom.order="asc"};function C(){var e={$and:[]};var t={$or:[]};var i=L.ticketAllListFilters;var n="";var s={$and:[]};var a={$or:[]};if(i!=undefined&&angular.isArray(i)&&i.length>0){for(var r=0;r<i.length;r++){if(!i[r].isExist){continue}if(i[r].valueType=="cascade_options"||i[r].valueType=="multi_options"||i[r].valueType=="options"){i[r].thirdValue=i[r].customField.value}if(i[r].valueType=="checkbox"){i[r].thirdValue=true}if(i[r].thirdValue===undefined||i[r].thirdValue===""||i[r].secondValue===undefined||i[r].secondValue===""){return false}if(i[r].firstValue=="ticketMetric.planSolvedAt"&&parseInt(i[r].thirdValue)!=parseFloat(i[r].thirdValue)){return false}var o={};var l={};if(i[r].firstValue=="copyTo"){var c="";for(var u=0;u<i[r].thirdValue.length;u++){if(i[r].thirdValue[u].id&&i[r].thirdValue[u].id>0){c+=i[r].thirdValue[u].id}else{c+=i[r].thirdValue[u].name}if(i[r].thirdValue.length-1!=u){c+=","}}l.id="[${copy_to_user_or_email_ticket_ids_"+c+"!}]";o[i[r].secondValue]=l;e["$and"].push(o)}else if(i[r].firstValue=="ticketMetric.planSolvedAt"){l["ticketMetric.planSolvedAt"]="${remainder_plan_solved_minute_time_"+i[r].thirdValue+"!}";o[i[r].secondValue]=l;e["$and"].push(o)}else if(i[r].firstValue=="engineerGroup"){var c=angular.isObject(i[r].thirdValue)?i[r].thirdValue.id:i[r].thirdValue;l["user.id"]="[${creator_service_desk_id_"+c+"!}]";o[i[r].secondValue]=l;e["$and"].push(o)}else if(i[r].firstValue=="via.channel"){var d=angular.copy(i[r].thirdValue);if(d.via&&d.via.uid){l["via.channel"]=d.channel+"_"+d.via.uid+"_"+d.via.name}else{l["via.channel"]=d.channel}o[i[r].secondValue]=l;e["$and"].push(o)}else if(i[r].firstValue.indexOf("ticketcustomfield")>-1){var p=i[r].firstValue.substr(i[r].firstValue.lastIndexOf("_")+1);if(i[r].valueType=="date"){l[p]=x("date")(i[r].thirdValue,"yyyy/MM/dd").toString()}else{l[p]=i[r].thirdValue}o[i[r].secondValue]=l;s["$and"].push(o)}else{if(i[r].secondValue==="$in"||i[r].secondValue==="$not_in"){if(i[r].firstValue==="status"){l[i[r].firstValue]=y.run(i[r].thirdValue,i[r].secondValue)}else if(i[r].firstValue==="requester.userGroup.id"){l[i[r].firstValue]=i[r].thirdValue}else if(i[r].firstValue==="serviceDesk.id"){var f="";if(angular.isObject(i[r].thirdValue)){f=i[r].thirdValue.id}else{f=i[r].thirdValue}l[i[r].firstValue]=(f+"").split(" ")}else{l[i[r].firstValue]="[${service_catalog_and_children_id_"+(i[r].thirdValue.id?i[r].thirdValue.id:i[r].thirdValue)+"!}]"}}else{l[i[r].firstValue]=angular.isObject(i[r].thirdValue)?i[r].thirdValue.id:i[r].thirdValue}o[i[r].secondValue]=l;e["$and"].push(o)}if(i[r].firstValue=="engineer.id"){if(i[r].thirdValue.id!="${current_engineer_id}"){n+=i[r].engineerDesk.id+","}}}L.filterEngineerDeskIds=n.substring(0,n.length-1)}var m=L.ticketAnyListFilters;if(m!=undefined&&angular.isArray(m)&&m.length>0){for(var r=0;r<m.length;r++){if(!m[r].isExist){continue}if(m[r].valueType=="cascade_options"||m[r].valueType=="multi_options"||m[r].valueType=="options"){m[r].thirdValue=m[r].customField.value}if(m[r].valueType=="checkbox"){m[r].thirdValue=true}if(m[r].thirdValue===undefined||m[r].thirdValue===""||m[r].secondValue===undefined||m[r].secondValue===""){return false}var o={};var l={};if(m[r].firstValue=="copyTo"){var c="";for(var u=0;u<m[r].thirdValue.length;u++){if(m[r].thirdValue[u].id&&m[r].thirdValue[u].id>0){c+=m[r].thirdValue[u].id}else{c+=m[r].thirdValue[u].name}if(m[r].thirdValue.length-1!=u){c+=","}}l.id="[${copy_to_user_or_email_ticket_ids_"+c+"!}]";o[m[r].secondValue]=l;t["$or"].push(o)}else if(m[r].firstValue=="ticketMetric.planSolvedAt"){l["ticketMetric.planSolvedAt"]="${remainder_plan_solved_minute_time_"+m[r].thirdValue+"!}";o[m[r].secondValue]=l;t["$or"].push(o)}else if(m[r].firstValue=="engineerGroup"){var c=angular.isObject(m[r].thirdValue)?m[r].thirdValue.id:m[r].thirdValue;l["user.id"]="[${creator_service_desk_id_"+c+"!}]";o[m[r].secondValue]=l;t["$or"].push(o)}else if(m[r].firstValue=="via.channel"){var d=angular.copy(m[r].thirdValue);if(d.via&&d.via.uid){l["via.channel"]=d.channel+"_"+d.via.uid+"_"+d.via.name}else{l["via.channel"]=d.channel}o[m[r].secondValue]=l;t["$or"].push(o)}else if(m[r].firstValue.indexOf("ticketcustomfield")>-1){var p=m[r].firstValue.substr(m[r].firstValue.lastIndexOf("_")+1);if(m[r].valueType=="date"){l[p]=x("date")(m[r].thirdValue,"yyyy/MM/dd").toString()}else{l[p]=m[r].thirdValue}o[m[r].secondValue]=l;a["$or"].push(o)}else{if(m[r].secondValue==="$in"||m[r].secondValue==="$not_in"){if(m[r].firstValue==="status"){l[m[r].firstValue]=y.run(m[r].thirdValue,m[r].secondValue)}else if(m[r].firstValue==="requester.userGroup.id"){l[m[r].firstValue]=m[r].thirdValue}else if(m[r].firstValue==="serviceDesk.id"){var f="";if(angular.isObject(m[r].thirdValue)){f=m[r].thirdValue.id}else{f=m[r].thirdValue}l[m[r].firstValue]=(f+"").split(" ")}else{l[m[r].firstValue]="[${service_catalog_and_children_id_"+(m[r].thirdValue.id?m[r].thirdValue.id:m[r].thirdValue)+"!}]"}}else{l[m[r].firstValue]=angular.isObject(m[r].thirdValue)?m[r].thirdValue.id:m[r].thirdValue}o[m[r].secondValue]=l;t["$or"].push(o)}if(m[r].firstValue=="engineer.id"){if(m[r].thirdValue.id!="${current_engineer_id}"){n+=m[r].engineerDesk.id+","}}}L.filterEngineerDeskIds=n.substring(0,n.length-1)}var g={filter:angular.toJson({$and:[e,t]}),customFieldFilter:angular.toJson({$and:[s,a]})};return g}var b=function(){var e="";var t={$and:[]};var i=L.ticketAllListFilters;if(i!=undefined&&angular.isArray(i)&&i.length>0){var n="";e+='{"$and":[';for(var s=0;s<i.length;s++){if(i[s].thirdValue===undefined||i[s].thirdValue===""||i[s].secondValue===undefined||i[s].secondValue===""){return false}if(i[s].firstValue=="serviceCatalog.id"||i[s].firstValue=="serviceDesk.id"||i[s].firstValue=="requester.id"||i[s].firstValue=="requester.userGroup.id"||i[s].firstValue=="user.id"){if(typeof i[s].thirdValue=="object"){e+='{"'+i[s].secondValue+'":{"'+i[s].firstValue+'":'+i[s].thirdValue.id+"}},"}else{e+='{"'+i[s].secondValue+'":{"'+i[s].firstValue+'":'+i[s].thirdValue+"}},"}}else if(i[s].firstValue=="copyTo"){var a="";for(var r=0;r<i[s].thirdValue.length;r++){if(i[s].thirdValue[r].id&&i[s].thirdValue[r].id>0){a+=i[s].thirdValue[r].id}else{a+=i[s].thirdValue[r].name}if(i[s].thirdValue.length-1!=r){a+=","}}e+='{"'+i[s].secondValue+'":{"id":[${copy_to_user_or_email_ticket_ids_'+a+"!}]}},"}else if(i[s].firstValue=="ticketMetric.planSolvedAt"){e+='{"'+i[s].secondValue+'":{"ticketMetric.planSolvedAt":${remainder_plan_solved_minute_time_'+i[s].thirdValue+"!}}},"}else if(typeof i[s].thirdValue=="string"){e+='{"'+i[s].secondValue+'":{"'+i[s].firstValue+'":"'+i[s].thirdValue+'"}},'}else if(typeof i[s].thirdValue=="number"){e+='{"'+i[s].secondValue+'":{"'+i[s].firstValue+'":'+i[s].thirdValue+"}},"}else if(i[s].firstValue=="engineer.id"){e+='{"'+i[s].secondValue+'":{"'+i[s].firstValue+'":'+i[s].thirdValue.id+"}},";n+=i[s].engineerDesk.id+","}}L.filterEngineerDeskIds=n.substring(0,n.length-1)}var o=L.ticketAnyListFilters;if(o!=undefined&&angular.isArray(o)&&o.length>0){e+='{"$or":[';for(var s=0;s<o.length;s++){if(o[s].thirdValue===undefined||o[s].thirdValue===""||o[s].secondValue===undefined||o[s].secondValue===""){return false}if(o[s].firstValue=="serviceCatalog.id"||o[s].firstValue=="serviceDesk.id"||o[s].firstValue=="requester.id"||o[s].firstValue=="requester.userGroup.id"||i[s].firstValue=="engineer.id"){if(typeof o[s].thirdValue=="object"){e+='{"'+o[s].secondValue+'":{"'+o[s].firstValue+'":'+o[s].thirdValue.id+"}},"}else{e+='{"'+o[s].secondValue+'":{"'+o[s].firstValue+'":'+o[s].thirdValue+"}},"}}else if(typeof o[s].thirdValue=="string"){e+='{"'+o[s].secondValue+'":{"'+o[s].firstValue+'":"'+o[s].thirdValue+'"}},'}else if(typeof o[s].thirdValue=="number"){e+='{"'+o[s].secondValue+'":{"'+o[s].firstValue+'":'+o[s].thirdValue+"}},"}}e+="]}";e=e.replace("},]","}]")}if(i!=undefined&&angular.isArray(i)&&i.length>0){e+="]}";e=e.replace("},]","}]")}return e};L.cancelEdit=function(){t.go("system_setting.detail",{uri:"ticket_list_custom",settingType:"ticket"})};L.updateTicketListCustom=function(s){if(s.title===""||s.title===undefined){g.add("请输入标题","danger");return}if(L.useOptions&&L.useOptions.length<4){g.add("显示列不足4个","danger");return}var a=C();if(!a&&!s.isSystemDefault&&L.ticketAllListFilters.length>0){g.add("符合条件信息填写完整","danger");return}c.get("list_views.json?type=ticket").success(function(e,t){var i=e.json;for(var n=0;n<i.length;n++){if(i[n].title==s.title&&s.id!=i[n].id){g.add("标题已经使用","danger");return}}w(a)})};function w(e){var i=angular.copy(L.ticketListCustom);if(L.ticketListCustom.id!=undefined){i.id=L.ticketListCustom.id}if(L.listCustomType.type=="private"&&!L.ticketListCustom.isSystemDefault){i.engineer={id:v.engineer.id}}else{if(i.engineer){delete i.engineer}var t=[];angular.forEach(L.selectedServiceDesk.serviceDesk,function(e){t.push({id:e})});i.serviceDesks=t}var n="";var s=[];i.title=L.ticketListCustom.title;i.active=true;i.orderBy=L.ticketListCustom.orderBy;i.groupBy=L.ticketListCustom.groupBy;i.order=L.ticketListCustom.orderBy?L.ticketListCustom.order:null;if(L.ticketListCustom.isSystemDefault){i.filter=L.ticketListCustom.filter}else{i.filter=e.filter;i.customFieldFilter=e.customFieldFilter;i.filterEngineerDeskIds=L.filterEngineerDeskIds}i.type="ticket";i.isCustomField=1;var a="id,status,";var r=[N.ticketFields["id"],N.ticketFields["status"]],o=[],l=[];var c=L.useOptions;var u=[];var d;for(var p=0;p<c.length;p++){d={};if(!Number(c[p].length)||c[p].length<=0){g.add("列宽必须为正数","danger");return false}if(M!=undefined&&JSON.stringify(M).indexOf(c[p].value)!=-1&&c[p].value!="tags"&&c[p].value!="copyTo"&&c[p].isDefault==true){a+=c[p].value+",";r.push(c[p].length);d.type="system"}else if(c[p].value=="tags"&&c[p].isDefault==true){n+=c[p].value+",";l.push(c[p].length);d.type="other"}else if(c[p].value=="copyTo"&&c[p].isDefault==true){n+=c[p].value+",";l.push(c[p].length);d.type="other"}else{s.push({title:c[p].option,id:c[p].value});o.push(c[p].length);d.type="custom"}d.id=c[p].value;u.push(d)}i.fields=a.substring(0,a.length-1);i.fieldsLength=r.join(",");i.otherFields=n.substring(0,n.length-1);i.otherFieldsLength=l.join(",");i.customFields=s.length>0?JSON.stringify(s):null;i.customFieldsLength=o.join(",");i.ticketCustomFields=null;i.sortFields=u.length>0?JSON.stringify(u):null;L.disabledBtn=true;if(i.isSystemDefault){i.title=angular.copy(L.ticketListCustom.copyTitle);delete i.copyTitle}var f={view:i};org.ewei.sdk.OpenViewApi().saveOrUpdate(f).then({success:function(e){var t=L.listCustomType.type;if(L.ticketListCustom.isSystemDefault){t="default"}h.config.route.put("system.setting.ticket_list_custom.showType",t);m.customViewType=t;if(h.detail.ticket.views.get(i.id)){h.detail.ticket.views.put(i.id,i)}L.cancelEdit()},fail:function(e){L.disabledBtn=false;g.add("更新失败","danger")}})}L.sortableOptions={connectWith:".sortable",beforeStop:function(e,t){var i=t.originalPosition.left;var n=t.position.left},stop:function(e,t){U()}};L.useSortableOptions={connectWith:".sortable",beforeStop:function(e,t){if(t.item&&t.item.sortable&&t.item.sortable.model&&t.item.sortable.model.value=="subject"){var i=t.originalPosition.left;var n=t.position.left;if(i-n>50){t.item.sortable.cancel();g.add("主题必须显示","danger")}}else{var i=t.originalPosition.left;var n=t.position.left;if(i-n>50&&L.useOptions.length<5){t.item.sortable.cancel();g.add("显示的列不能少于4个","danger")}}},stop:function(){U()}}}])})(org.ewei);(function(){"use strict";angular.module("eweiApp.ticket").controller("ticketExtendFormCtrl",e);e.$inject=["apiTicketAttachmentsService","$scope","coreModelService","coreNotifyService","$http","$modal_","alertService","$state","$rootScope"];function e(e,r,t,i,a,n,o,l,c){r.extendForm={isShowCustome:true};r.ticketCustomFieldShowDemo=[];var s=[],u=null;var d=null;var p=0;a({url:"/api/v1/ticket_types.json",method:"GET",params:{_count:999}}).success(function(e){void 0;if(e.status===0&&e.result){r.extendForm.ticketTypes=e.result.ticketTypes||[];if(c.lastTicketTypeFormId){for(var t=0;t<r.extendForm.ticketTypes.length;t++){if(r.extendForm.ticketTypes[t].id==c.lastTicketTypeFormId){r.extendForm.ticketTypeModel=r.extendForm.ticketTypes[t];break}}}else{r.extendForm.ticketTypeModel=r.extendForm.ticketTypes[0]}c.lastTicketTypeFormId=null;p++;if(p>=2){r.getTicketCustomForm()}}});a({url:"/api/v1/custom_fields/custom_form.json",method:"GET",params:{sys_custom_form:false}}).success(function(e){void 0;if(e.status===0&&e.result){var t=[];var i=e.result.customFields||[];for(var n=0;n<i.length;n++){if(i[n].type=="checkbox"||i[n].type=="textarea"||i[n].type=="date"||i[n].type=="multi_options"||i[n].type=="cascade_options"||i[n].type=="date_to_date"||i[n].type=="date_time"){i[n].inputType=i[n].type}else if(i[n].type=="options"){i[n].inputType="select"}else{i[n].inputType="text"}var s={customField:i[n],deleted:false};t.push(s)}r.ticketCustomFields=t;if(!r.ticketCustomFields.length){r.extendForm.isShowCustome=false}p++;if(p>=2){r.getTicketCustomForm()}}});r.getTicketCustomForm=function(){a({url:"/api/v1/ticket_custom_form/get/"+r.extendForm.ticketTypeModel.id+".json",method:"GET"}).success(function(e){r.ticketCustomFieldShowDemo=[];u=null;for(var t=0;t<r.ticketCustomFields.length;t++){r.ticketCustomFields[t].activeShow=false;r.ticketCustomFields[t].id=null;r.ticketCustomFields[t].deleted=false}if(e.status===0&&e.result&&e.result.ticketCustomForm){var i=e.result.ticketCustomForm.customFormFields||[];i=i.sort(function(e,t){return e.position-t.position});var n=_.filter(i,function(e){return e.deleted==false});if(!i.length||!n.length){r.extendForm.isShow=false}u=e.result.ticketCustomForm;for(var s=0;s<i.length;s++){for(var a=0;a<r.ticketCustomFields.length;a++){if(i[s].customField.id===r.ticketCustomFields[a].customField.id&&!i[s].sysCustomForm){r.ticketCustomFields[a].id=i[s].id;r.ticketCustomFields[a].deleted=i[s].deleted;if(!i[s].deleted){r.ticketCustomFields[a].activeShow=true;r.extendForm.isShow=true}r.ticketCustomFieldShowDemo.push(r.ticketCustomFields[a]);break}}}void 0}else{r.extendForm.isShow=false}})};r.checkedMenu=function(e){var t=true,i=false,n=null;for(var s=0;s<r.ticketCustomFieldShowDemo.length;s++){if(e.customField.id==r.ticketCustomFieldShowDemo[s].customField.id){t=false;n=s;break}}if(t){r.ticketCustomFieldShowDemo.push(e)}else{if(e.id){r.ticketCustomFieldShowDemo[n].deleted=!r.ticketCustomFieldShowDemo[n].deleted}else{r.ticketCustomFieldShowDemo.splice(n,1)}}for(var a=0;a<r.ticketCustomFieldShowDemo.length;a++){if(!r.ticketCustomFieldShowDemo[a].deleted){r.extendForm.isShow=true;i=true}}if(!i){r.extendForm.isShow=false}e.activeShow=!e.activeShow};var f=false;r.updateTicketExtendForm=function(){if(f){return false}f=true;var e=angular.copy(r.ticketCustomFieldShowDemo);var t=null;c.lastTicketTypeFormId=r.extendForm.ticketTypeModel.id;var i=[];for(var n=0;n<e.length;n++){var s={customField:{id:e[n].customField.id},position:n+1,deleted:!!e[n].deleted};if(e[n].id){s.id=e[n].id}i.push(s)}if(u){t=angular.copy(u);t.customFormFields=i}else{t={ticketType:{id:r.extendForm.ticketTypeModel.id},customFormFields:i}}a({url:"/api/v1/ticket_custom_form/save_or_update.json",method:"POST",data:t}).success(function(e,t,i,n){if(e.status===0&&e.result&&e.result.success){o.add("更新成功");l.reload()}else{o.add("更新失败","danger")}f=false}).error(function(){f=false})}}})();(function(){"use strict";angular.module("eweiApp.ticket").controller("sdkDetailController",e).controller("advancePreparationController",t).controller("autoReplyController",i).controller("ticketSendRuleDetailController",n).controller("onlineCustomerNavigationController",s);e.$inject=["$state","$ocLazyLoad"];function e(e,t,i){var n=this;t.load("source/webpage_form/webpage_form.css");t.load("/source/weixin-setting/weixin_setting.css");n.cancelEdit=function(){e.go("system_setting.detail",{uri:"sdk_setting",settingType:"ticket"})};return n}t.$inject=["$scope","$state","$stateParams","$http","ConsoleConfig","alertService"];function t(s,e,t,i,n,a){var r=this;o();function o(){var e=t.id;if(e!=null&&e!="undefined"&&e!=""&&e>0){i({url:"/api/find_via_sdk/"+e+".json",method:"GET",params:{provider_id:n.provider.id,_token:getCookie("user_token")}}).success(function(e,t,i,n){r.viaSDK=e.result;if(r.viaSDK.serviceDesk){s.$parent.vm.serviceDesk=r.viaSDK.serviceDesk}if(r.viaSDK.name){s.$parent.vm.viaSDKName=r.viaSDK.name}})}else{r.viaSDK=t.addViaSdk;s.$parent.vm.viaSDKName=t.addViaSdk.name;i({url:"/api/add_appid_appsecret.json",method:"get",params:{provider_id:n.provider.id,_token:getCookie("user_token")}}).success(function(e){if(e.result&&e.result.id>0){r.viaSDK.appId=e.result.id;r.viaSDK.appKey=e.result.appKey;r.viaSDK.appSecret=e.result.appSecret;s.$parent.vm.type="add"}})}}r.saveViaSDK=function(){if(r.viaSDK.name!=""&&r.viaSDK.name!=undefined&&r.viaSDK.name!=null){i({url:"/api/save_via_sdk.json",method:"post",params:{provider_id:n.provider.id,_token:getCookie("user_token")},data:r.viaSDK}).success(function(e){if(e.result&&e.result.id>0){a.add("保存成功");i({url:"add_desk_log?type=update",method:"post"}).success(function(e,t,i,n){});r.cancelEdit()}else{a.add("保存失败","danger")}})}else{a.add("请输入渠道名称","danger")}};r.cancelEdit=function(){e.go("system_setting.detail",{uri:"sdk_setting",settingType:"ticket"})};r.downloadViaSDK=function(e){var t=window.location.href;if(t.indexOf("localhost")>0||t.indexOf("127.0.0.1")>0){if("api"==e){window.open("http://localhost:8280/")}else{window.open("http://localhost:8380/find_latest_release_by_os?os="+e)}}else if(t.indexOf("itkeeping.com")>0){if("api"==e){window.open("http://api.itkeeping.com")}else{window.open("http://helpdesk.itkeeping.com/find_latest_release_by_os?os="+e)}}else{if("api"==e){window.open("http://api.ewei.com")}else{window.open("http://helpdesk.ewei.com/find_latest_release_by_os?os="+e)}}};return r}i.$inject=["$stateParams","$state","$http","alertService","ConsoleConfig"];function i(e,t,i,n,s){var a=this;var r="";var o=null;a.wechat={};i({url:"/api/v1/via_sdks/"+e.id+"/automatic_replys.json",method:"GET",params:{_token:getCookie("user_token")}}).success(function(e){if(e.result){for(var t in e.result){if(typeof e.result[t]=="string"&&e.result[t].indexOf("<save_ticket>")!=-1){e.result[t]=e.result[t].replace("<save_ticket>","");e.result[t]=e.result[t].replace("</save_ticket>","")}}o=angular.copy(e.result);a.wechat=angular.copy(e.result)}});i({url:"/api/v1/via_sdks/"+e.id+"/service_catalogs.json",method:"GET",params:{_token:getCookie("user_token")}}).success(function(e){if(e.result&&e.result.length>0){a.hasNav=true}else{a.hasNav=false}});var l={onlineWelcome:" 你好，请问有什么可以帮到你？",onlineAutomaticReply:"你是要联系客服吗？请回复【开始交谈】接通坐席代表。",offlineWelcome:"欢迎光临，如需帮助请提交工单",offlineAutomaticReply:"请提交工单获得帮助。",offlineArticleList:"下列文章供你参考，没有帮助时！也可以提交工单获得帮助。",onlineWelcomeMenu:"欢迎光临，请问有什么可以帮到你？你是否遇到下列问题？可以点击选择导航菜单，获得帮助。",onlineAutomaticReplyMenu:"请点击选择导航菜单，获得帮助"};a.markLink=function(e){if(navigator.appName=="Microsoft Internet Explorer"){r=document.selection.createRange().text}else{r=window.getSelection().toString()}if(!r){return false}a.wechat[e]=a.wechat[e].replace(/<(?!\/?BR)[^<>]*>/gi,"").replace(r,'<save_ticket style="color: #6699CC;">'+r+"</save_ticket>")};a.navCheck=function(){if(o.isMenu){if(a.wechat.isMenu){a.wechat.onlineWelcome=o.onlineWelcome;a.wechat.onlineAutomaticReply=o.onlineAutomaticReply}else{a.wechat.onlineWelcome=l.onlineWelcome;a.wechat.onlineAutomaticReply=l.onlineAutomaticReply}}else{if(a.wechat.isMenu){a.wechat.onlineWelcome=l.onlineWelcomeMenu;a.wechat.onlineAutomaticReply=l.onlineAutomaticReplyMenu}else{a.wechat.onlineWelcome=o.onlineWelcome;a.wechat.onlineAutomaticReply=o.onlineAutomaticReply}}};a.resetDefault=function(){if(a.wechat.isMenu){a.wechat.onlineWelcome=l.onlineWelcomeMenu;a.wechat.onlineAutomaticReply=l.onlineAutomaticReplyMenu}else{a.wechat.onlineWelcome=l.onlineWelcome}a.wechat.offlineWelcome=l.offlineWelcome;a.wechat.offlineAutomaticReply=l.offlineAutomaticReply;a.wechat.offlineArticleList=l.offlineArticleList};a.updateWelcomes=function(){if(!a.hasNav&&a.wechat.isMenu){n.add("当前的导航菜单为空，会导致客户无菜单可用。请前往“在线客服导航”进行配置。","danger");return false}i({url:"/api/v1/via_sdks/"+e.id+"/automatic_replys.json?_token="+getCookie("user_token"),method:"PUT",data:a.wechat}).success(function(e){if(e.result){n.add("更新成功")}else{if(e.message){n.add(e.message,"danger")}else{n.add("更新失败","danger")}}})};return a}n.$inject=["$scope","$stateParams","$http","alertService","serviceDeskService","$filter","ConsoleConfig"];function n(e,t,i,s,n,a,r){var o=this;var l="";o.robotReply=false;c();function c(){i({url:"/api/find_via_sdk/"+t.id+".json",method:"GET",params:{provider_id:r.provider.id,_token:getCookie("user_token")}}).success(function(e,t,i,n){if(e.result&&e.result.serviceDesk){l=e.result.serviceDesk;o.robotReply=e.result.robotReply;u()}})}function u(){n.query({_count:999,_do_count:false,_fields:"id,name"},function(e){var t=e.serviceDesks;for(var i=0;i<t.length;i++){if(t[i].name=="DEFAULT_SERVICE_DESK_NAME"){t[i].name=a("translate")(t[i].name)}if(t[i].id==l.id){o.serviceDesk=t[i]}}o.serviceDesks=t})}o.update=function(){if(!o.serviceDesk){s.add("更新失败","danger");return false}o.serviceDesk.robotReply=o.robotReply;i({url:"/api/v1/via_sdks/"+t.id+"/service_desks.json?_token="+getCookie("user_token"),method:"PUT",data:o.serviceDesk}).success(function(e,t,i,n){if(e.result){s.add("更新成功")}})};return o}s.$inject=["$stateParams","$state","$http","$timeout","alertService","ConsoleConfig"];function s(s,l,c,t,u,e){var a=this;var i="/api/v1/via_sdks/"+s.id+"/navigations.json";a.serviceCatalogs=[];a.navList=[{name:"导航菜单",serviceCatalogId:s.id}];var d=s.id;var n=function(e,n){c({url:e,method:"GET",params:{_token:getCookie("user_token")}}).success(function(e){if(e.result&&e.result.serviceCatalogs&&e.result.serviceCatalogs.length>0){var t=angular.copy(e.result.serviceCatalogs);for(var i=0;i<t.length;i++){if(!t[i].name){t[i].name=t[i].serviceCatalogName||""}if(t[i].no){t[i].isChecked=true}t[i].uId=i+1}if(n){n(t)}}})};n(i,function(e){var t=1;for(var i=0;i<e.length;i++){if(e[i].no){t++}}a.serviceCatalogs=e;if(t>=e.length){t=e.length}p[a.nowServiceCatalogNo].nowNo=t;var n={};n[s.id]={nowNo:t,allArr:e};p[a.nowServiceCatalogNo]=n});a.nowServiceCatalogNo=0;var r=s.id;var o=true;var p=[{},{},{},{},{}];a.Arr=p;a.editServiceCatalog=function(e,t){e.isShowInput=true;t.stopPropagation()};a.ngFocus=function(){o=false};a.ngBlur=function(e){e.isShowInput=false;t(function(){o=true},500)};a.inputStopPropagation=function(e){e.stopPropagation()};a.setIndex=function(e){if(!o){return false}e.isChecked=!e.isChecked;var t=p[a.nowServiceCatalogNo][r];if(!e.no){e.no=t.nowNo;if(e.no>=a.serviceCatalogs.length){t.nowNo=a.serviceCatalogs.length}else{t.nowNo++}}else{var i=0;for(var n=0;n<a.serviceCatalogs.length;n++){if(a.serviceCatalogs[n].no){if(a.serviceCatalogs[n].no>e.no){a.serviceCatalogs[n].no--}i++}}if(e.no!==a.serviceCatalogs.length&&i<a.serviceCatalogs.length){t.nowNo--}e.no=""}};a.getNextServiceCatalog=function(s,e){if(s.isChecked){if(p[a.nowServiceCatalogNo+1]&&p[a.nowServiceCatalogNo+1][s.serviceCatalogId]&&p[a.nowServiceCatalogNo+1][s.serviceCatalogId].allArr.length>0){a.nowServiceCatalogNo++;var t=f(s.serviceCatalogId,p[a.nowServiceCatalogNo]);if(t){a.serviceCatalogs=t;r=s.serviceCatalogId;a.navList.push({name:s.name,serviceCatalogId:s.serviceCatalogId})}}else{n(i+"?parentId="+s.serviceCatalogId,function(e){a.nowServiceCatalogNo++;r=s.serviceCatalogId;a.navList.push({name:s.name,serviceCatalogId:s.serviceCatalogId});var t=1;for(var i=0;i<e.length;i++){if(e[i].no){t++}}if(t>=e.length){t=e.length}var n={nowNo:t,allArr:e};a.serviceCatalogs=e;p[a.nowServiceCatalogNo][s.serviceCatalogId]=n})}e.stopPropagation()}};a.goServiceCatalog=function(e,t){a.nowServiceCatalogNo=t;r=e.serviceCatalogId;if(t==a.navList.length-1){return false}a.navList=a.navList.slice(0,t+1);var i=f(e.serviceCatalogId,p[t]);if(i){a.serviceCatalogs=i}};var f=function(e,t){for(var i in t){if(i==e){return t[i].allArr}}return false};a.updateServiceCatalogs=function(){var e=angular.copy(p);var t=[];var i=[];for(var n=0;n<e.length;n++){for(var s in e[n]){if(e[n][s]&&e[n][s].allArr&&e[n][s].allArr.length>0){t=t.concat(e[n][s].allArr)}}}for(var a=0;a<t.length;a++){if(t[a].no||t[a].id){var r={};if(t[a].id){r.id=t[a].id}r.name=t[a].name;if(t[a].no){r.no=t[a].no}r.serviceCatalogId=t[a].serviceCatalogId;r.viaSDKId=d;i.push(r)}}if(!i.length){u.add("请选择服务目录","danger");return false}var o="/api/v1/via_sdks/"+d+"/service_catalogs/all.json?_token="+getCookie("user_token");c.post(o,i).success(function(e,t,i,n){if(e.result.success){u.add("更新成功");l.reload()}else{u.add("更新失败")}})}}})();angular.module("eweiApp.system_setting").controller("logo_setting_controller",["$rootScope","$scope","$state","$stateParams","license","attachmentService","$upload","$timeout","$modal_","alertService","$http","commonTools","ConsoleConfig","EweiConfig","permissions","providerJudgement",function(t,s,i,e,a,n,r,o,l,c,u,d,p,f,m,g){if(s.attachments==null){s.attachments=[]}try{var v=new plupload.Uploader({runtimes:"gears,html5,flash",browse_button:"button_id"})}catch(e){void 0}s.licenseService=a;s.eweiHelpcenterApiUrl=p.eweiHelpcenterApiUrl;s.cacheFiles=[];s.uploading=false;eweiUpload(function(e,t){plupload.each(t,function(e){e.uploading=true;e.progress=0;s.cacheFiles.push(e)});d.safeApply(s)},function(e,t){var i=t.name;void 0;var n=new String(i.substring(i.lastIndexOf(".")+1,i.length));if(a.overduePayService()<=0){c.add("您余额不足，请先充值!","danger");e.removeFile(t);e.stop()}if(n=="gif"||n=="png"||n=="jpg"||n=="bmp"){}else{c.add("上传文件格式错误，请上传图片，格式为gif,png,bmp,jpg类型","danger");e.removeFile(t);e.stop()}if(t.size>204800){c.add("上传LOGO大小不能超过200KB。","danger");e.removeFile(t);e.stop()}else if(t.szie==0){c.add("请选择上传LOGO","danger");e.removeFile(t);e.stop()}},function(e,t){var i=e.total.percent;s.$emit("uploading",true);t.progress=i;d.safeApply(s)},function(e,t,i){t.progress=100;u({url:"save_attachment.json",method:"POST",params:{fileName:t.name,contentType:t.type,contentUrl:JSON.parse(i).key,size:t.size}}).success(function(e,t,i,n){if(e.json){o(function(){s.previewHeader.attachment=e.json;s.$emit("uploading",false);h(e.json);d.safeApply(s)})}else{}})},function(e,t,i){s.$emit("uploading",false);if(t.code==-600){c.add("上传文件不能大于50M。","danger");e.stop()}},function(){s.$emit("uploading",false)});var h=function(e){if(e){s.previewHeader.contentUrl="//"+f.bucket_domain+"/"+angular.fromJson(e).contentUrl;c.add("头像上传成功!","success")}else{c.add("头像上传失败!","danger")}};t.$watch("provider",function(){s.previewHeader=t.provider;s.oldPreviewHeader=angular.copy(t.provider)});s.pickfilesBuried=function(){_hmt.push(["_trackEvent","界面Logo","上传Logo"])};s.update=function(){if(a.type()=="oem"||a.type()=="enterprise_plus"||a.hasModule("custom_logo")){if(!g.isTrue()){return false}_hmt.push(["_trackEvent","界面Logo","更新界面Logo"]);u({url:"console_update.json",method:"POST",data:s.previewHeader}).success(function(e){if(e){s.oldPreviewHeader=angular.copy(t.provider);s.$broadcast("changePrividerName",t.provider.name);c.add("数据更新成功!","success")}else{c.add("数据更新失败!","success")}})}else{s.showModel()}};s.showModel=function(){var e=l({scope:s,title:"提示",contentTemplate:"source/views/fun_restriction_reminder.html",html:true,show:true,placement:"center"});s.hasPermission=true;s.tipNotSupportService="当前服务版本不支持此功能，请升级服务后再试。";s.goAuthorization=function(){void 0;if(m.hasPermission("system_setting_company_account")){i.go("system_setting.detail.provider",{uri:"company_account",settingType:"system"});e.$promise.then(e.hide)}else{s.hasPermission=false;s.tipNotSupportService="很抱歉，你没有访问授权计划的权限"}};s.hideModal_=function(){e.$promise.then(e.hide)}};s.selectColor=function(e){t.$broadcast("provider-color-setting",e)};s.$on("$destroy",function(){t.provider=angular.copy(s.oldPreviewHeader);t.$broadcast("provider-color-setting",t.provider.headBackgroundColor)});s.fontFamilys=["微软雅黑","宋体","黑体","楷体","华文彩云","新细明体 ","细明体 ","标楷体 ","仿宋 ","楷体 ","华文宋体","华文细黑","微軟正黑體","隶书"];s.colorOptions={showAlpha:false,replacerClassName:"w300 btn btn-default margin_top10px",cancelText:"取消",chooseText:"确定",showInput:true}}]);(function(){"use strict";angular.module("eweiApp.system_setting").controller("announcement_setting_controller",["$rootScope","$scope","$state","$stateParams","license","$modal_","alertService","$http","commonTools","ConsoleConfig","EweiConfig","permissions","providerJudgement",function(e,t,i,n,s,a,r,o,l,c,u,d,p){t.announcement={enabled:false,title:"",content:"",expireAt:l.parseDateTime(new Date,"yyyy-MM-dd HH:mm:ss")};t.isOpen=false;t.onPickerClick=function(e){e.preventDefault();e.stopPropagation();t.isOpen=!t.isOpen};t.onPickerClosed=function(){t.isOpen=false};t.onSwitchOpen=function(){if(!t.announcement.enabled){org.ewei.sdk.OpenHelpCenterApi().disableHelpCenterAnnouncement().then(function(e){if(e===false){r.add("关闭公告失败！","danger")}},function(e){})}};function f(){if(!t.announcement.title||/^[ ]*$/.test(t.announcement.title)){r.add("标题不能为空！","danger");return false}if(!t.announcement.content||/^[ ]*$/.test(t.announcement.content)){r.add("公告正文为空或正文超长！","danger");return false}if(new Date(t.announcement.expireAt)<=new Date){r.add("公告有效期必须大于当前时间!","danger");return false}return true}t.releaseAnnoucement=function(){if(f()){org.ewei.sdk.OpenHelpCenterApi().releaseHelpCenterAnnouncement({title:t.announcement.title,content:t.announcement.content,expireAt:l.formatTime(new Date(t.announcement.expireAt))}).then(function(e){if(e){r.add("发布成功！")}else{r.add("发布失败！","danger")}})}};org.ewei.sdk.OpenHelpCenterApi().getHelpCenterAnnouncement().then(function(e){if(e){e.expireAt=new Date(e.expireAt);t.announcement=e}});t.datetimepickerConfig={datepickerOptions:{showWeeks:false,minDate:new Date},timepickerOptions:{showSeconds:true},buttonBar:{show:true,now:{show:true,text:"现在",cls:"btn-sm btn-default"},today:{show:true,text:"今天",cls:"btn-sm btn-default"},clear:{show:true,text:"清除",cls:"btn-sm btn-default"},date:{show:true,text:"日期",cls:"btn-sm btn-default"},time:{show:true,text:"时间",cls:"btn-sm btn-default"},close:{show:true,text:"关闭",cls:"btn-sm btn-default"},cancel:{show:false,text:"取消",cls:"btn-sm btn-default"}}}}])})();(function(v){"use strict";angular.module("eweiApp.system_setting").controller("oem_setting_controller",e);e.$inject=["$rootScope","$scope","oemSettingService","alertService","$filter","license","ConsoleConfig","$modal_","$state","permissions","providerJudgement","$upload"];function e(e,n,t,s,i,a,r,o,l,c,u,d){var p={open:false,hideCopyright:false,productName:"易维帮助台",hideWebchat:false,hideIntegralTab:false,helpUrl:"http://help.ewei.com",latestNewsSource:"ewei",learnMore:"each",learnMoreUrl:"http://help.ewei.com",guideVideoUrl:{helpcenterVideoName:"360度透视帮助中心",addAgentVideoName:"如何添加客服账号",completeUserVideoName:"客服ABC",ticketVideoName:"工单123",viaEmailVideoName:"通过Email处理工单",viaTicketFormVideoName:"如何配置网页表单",viaWebchatVideoName:"在线交谈和远程协助",helpcenterVideoUrl:"http://ewei-web-saas.ewei.com/c90323c6fadd4b6bb2b609918be3d1c6",addAgentVideoUrl:"http://ewei-web-saas.ewei.com/f1c917a68df742acb2b34ed9dd2ef733",completeUserVideoUrl:"http://ewei-web-saas.ewei.com/e61b27b32ce64b318caa71ac47ef3e96",ticketVideoUrl:"http://ewei-web-saas.ewei.com/0b94e3a6f9cb4cd8bc497c235f88ac1a",viaEmailVideoUrl:"http://ewei-web-saas.ewei.com/b935736c7ea34ca3a9118da1f69e1db9",viaTicketFormVideoUrl:"http://ewei-web-saas.ewei.com/0b94e3a6f9cb4cd8bc497c235f88ac1a",viaWebchatVideoUrl:"http://ewei-web-saas.ewei.com/bfd1d851ad8b45b295ac85e59d0c5e90"}};n.licenseService=a;var f=angular.copy(p.guideVideoUrl);n.disableUseToggleOpen=true;n.eweiHelpcenterApiUrl=r.eweiHelpcenterApiUrl;n.providerDomain=r.providerHelpCenterUrl;t.getOemConfig().success(function(e){if(e.success){e.json=e.json||{provider:{id:r.provider.id}};var t=e.json.guideVideoUrl;if(e.json.hasOwnProperty("guideVideoUrl")){delete e.json.guideVideoUrl}var i=angular.extend(p,e.json);i.guideVideoUrl=angular.extend(p.guideVideoUrl,t);i.guideVideoUrl.helpcenterVideoName=i.guideVideoUrl.helpcenterVideoName?i.guideVideoUrl.helpcenterVideoName:f.helpcenterVideoName;i.guideVideoUrl.addAgentVideoName=i.guideVideoUrl.addAgentVideoName?i.guideVideoUrl.addAgentVideoName:f.addAgentVideoName;i.guideVideoUrl.completeUserVideoName=i.guideVideoUrl.completeUserVideoName?i.guideVideoUrl.completeUserVideoName:f.completeUserVideoName;i.guideVideoUrl.ticketVideoName=i.guideVideoUrl.ticketVideoName?i.guideVideoUrl.ticketVideoName:f.ticketVideoName;i.guideVideoUrl.viaEmailVideoName=i.guideVideoUrl.viaEmailVideoName?i.guideVideoUrl.viaEmailVideoName:f.viaEmailVideoName;i.guideVideoUrl.viaTicketFormVideoName=i.guideVideoUrl.viaTicketFormVideoName?i.guideVideoUrl.viaTicketFormVideoName:f.viaTicketFormVideoName;i.guideVideoUrl.viaWebchatVideoName=i.guideVideoUrl.viaWebchatVideoName?i.guideVideoUrl.viaWebchatVideoName:f.viaWebchatVideoName;n.oemSettingConfig=i;n.toggleOpen=i.open;n.oldProductName=angular.copy(n.oemSettingConfig.productName);n.oemSettingDiabeld=a&&(a.type()=="oem"||a.hasModule("oem"))?false:n.oemSettingConfig.open?false:true}});var m=function(){if(a.type()=="free"){n.disableUseToggleOpen=true;return}if(a.type()=="trial"){n.disableUseToggleOpen=true;return}if(a.type()=="public"){n.disableUseToggleOpen=true;return}if(a.type()=="blend"&&a.overduePayService()<=0){n.disableUseToggleOpen=true;return}};e.$watch("providerLicense",function(){if(e.providerLicense!=null){m()}});n.toggleOemConfig=function(e){if(!n.oemSettingConfig.open){if(a.type()=="oem"||a.hasModule("oem")){t.toggleOemConfig(false).success(function(e){if(e.success){}else{n.oemSettingConfig.open=!n.oemSettingConfig.open;if(e.message){s.add(i("translate")(e.message),"danger")}else{s.add("保存失败！","danger")}}})}else{if(n.oemSettingDiabeld){n.showModel()}else{t.toggleOemConfig(false).success(function(e){if(e.success){}else{n.oemSettingConfig.open=!n.oemSettingConfig.open;if(e.message){s.add(i("translate")(e.message),"danger")}else{s.add("保存失败！","danger")}}});n.oemSettingDiabeld=true}}}};n.showModel=function(){var e=o({scope:n,title:"提示",contentTemplate:"source/views/fun_restriction_reminder.html",html:true,show:true,placement:"center"});n.hasPermission=true;n.tipNotSupportService="当前服务版本不支持此功能，请升级服务后再试。";n.goAuthorization=function(){void 0;if(c.hasPermission("system_setting_company_account")){l.go("system_setting.detail.provider",{uri:"company_account",settingType:"system"});e.$promise.then(e.hide)}else{n.hasPermission=false;n.tipNotSupportService="很抱歉，你没有访问授权计划的权限"}};n.hideModal_=function(){e.$promise.then(e.hide)}};n.testGuideVideoUrl=function(e,t){if(e){f[t]=e}else{n.oemSettingConfig.guideVideoUrl[t]=f[t]}};n.saveOemSetting=function(e){_hmt.push(["_trackEvent","OEM","更新"]);if(!e){return false}if(a.type()==null||a.type()=="free"||a.type()=="public"||a.type()=="trial"||a.type()=="enterprise_trial"||a.type()=="enterprise"){n.showModel();return false}else if(!u.isTrue()){return false}if(!n.oemSettingConfig.helpUrl){s.add("客服头像下拉菜单“帮助文档”的链接不能为空","danger");return false}t.updateOemConfig(n.oemSettingConfig).success(function(e){if(e.success){s.add("您已成功保存OEM相关设置！");n.oldProductName=angular.copy(n.oemSettingConfig.productName);t.settingOemConfig(e.json)}else{if(e.message){s.add(i("translate")(e.message),"danger")}else{s.add("保存失败！","danger")}}}).error(function(){s.add("保存失败！","danger")})};n.uploadFile=function(e){var t=null;for(var i=0;i<e.length;i++){t=e[i];if(t.size>51200){s.add("上传单个附件大小不能超过50kb","danger")}else{d.upload({url:"upload",method:"POST",file:t}).success(function(e,t,i,n){g(e)}).error(function(e,t,i,n){void 0})}}};var g=function(t){v.sdk.OpenHelpCenterApi().updateOemPhoto({photoId:t.id}).then(function(e){if(e){n.oemSettingConfig.photo=t;s.add("上传成功","success")}else{s.add("上传失败","danger")}})}}})(org.ewei);angular.module("eweiApp.ticket").controller("appsController",["$scope","$state","ticket",function(e,t,i){e.ticket=i;$("#sidebar").css("display","block")}]).controller("engineerListAndOnlineController",["$scope","$state","engineerService","userOnlineService","$rootScope","$http","ConsoleConfig",function(o,e,t,i,n,s,l){$("#sidebar").css("display","block");o.eweiHelpcenterApiUrl=l.eweiHelpcenterApiUrl;o.loadtime=0;o.loadEngineers=function(){var e=(new Date).getTime();if(o.loadtime!=0&&e-o.loadtime<5e3){return}o.loadtime=e;o.onlineCount=0;s({url:"engineer_online_status.json",params:{_count:999,_do_count:false,_filter:"{'$ne':{'id':${current_engineer_id}}}"}}).success(function(e,t,i,n){o.engineers=e.json;var s=null;for(var a=0;a<o.engineers.length;a++){var r=o.engineers[a];if(l.user.id!=r.userId){o.onlineCount+=r.webOnline||r.androidOnline||r.iosOnline?1:0}else{s=a}}if(s!=null){o.engineers.splice(s,1)}})};o.loadEngineers()}]);angular.module("eweiApp.ticket").controller("assistController",["$rootScope","$scope","$state","ticket","userOnlineStatus","$modal_","$http","$filter","alertService","$location","license","ConsoleConfig",function(s,a,e,r,t,o,l,c,u,d,i,n){$("#sidebar").css("display","block");a.currentUserName=n.user.name;a.currentUserNickname=n.user.nickname;a.ticketNo=r.no;a.eweiHelpcenterApiUrl=n.eweiHelpcenterApiUrl;a.webOnline=t.webOnline;a.appOnline=t.appOnline;if(a.webOnline||a.appOnline){a.online=true}else{a.online=false}var p;a.isVideoCall=false;a.$on("accept_assist",function(e,t){p="accept";a.hideModal()});a.$on("accept_video_call",function(e,t){p="accept";a.hideModal()});a.$on("reject_assist",function(e,t){p="reject";if(t.reason=="bustling"){a.$apply(function(){a.reject=false;a.bustling=true;a.isOvertime=true})}else{a.$apply(function(){a.bustling=false;a.reject=true;a.isOvertime=true})}clearInterval(a.updateSecondsTimerId)});a.$on("modal_request_assist.hide",function(e,t){clearInterval(a.updateSecondsTimerId);if(p==null){l({url:"cancel_request_assist.json",method:"GET",params:{ticketId:r.id,userId:s.assistUser.id,isVideoCall:a.isVideoCall}}).success(function(e,t,i,n){if(e.success){}else{}})}});a.remoteVideoEnable=false;var f=null;a.checkVideoPlug=function(){$("#sidebar").css("display","none");if(!s.isInstallApplication){s.$broadcast("installEweiHubServer",null,null)}else{a.remoteVideoEnable=false;var e={cmd:"respondV",data:{type:"ticket",userId:s.assistUser.id}};s.$broadcast("checkVideoPlug",JSON.stringify(e));f=setTimeout(function(){if(!a.remoteVideoEnable){a.remoteVideoEnable=true;a.requestAssist(true)}},1e3)}};a.$on("checkVideoPlugResult",function(e,t){if(f){clearTimeout(f)}if(t.cmd=="respondV"&&t.data.type=="ticket"){if(t.run==false||t.run=="false"){if(!a.remoteVideoEnable){a.remoteVideoEnable=true;a.requestAssist(true)}}else{u.add("视频通话正在进行中","danger")}}});a.$watch("remoteVideoEnable",function(){if(a.remoteVideoEnable){}});a.requestAssist=function(e){a.isVideoCall=e==null?false:e;$("#sidebar").css("display","none");var t=function(){p=null;a.reject=false;a.bustling=false;a.isOvertime=false;a.seconds=30;a.updateSecondsTimerId=setInterval(function(){a.$apply(i)},1e3);l({url:"request_assist.json",method:"GET",params:{ticketId:r.id,ticketNo:r.no,requestCometdClientId:s.cometdClientId,userId:s.assistUser.id,isVideoCall:e==null?false:e}}).success(function(e,t,i,n){if(e.success){}else{p="failure";a.hideModal();if(e.message!=null){u.add(c("translate")(e.message),"danger")}else{u.add("请求失败","danger")}}})};t();var i=function(){a.seconds-=1;if(a.seconds==0){a.isOvertime=true;clearInterval(a.updateSecondsTimerId);l({url:"no_response_assist.json",method:"GET",params:{ticketId:r.id,targetUserId:s.assistUser.id}}).success(function(e,t,i,n){if(e.success){}else{}})}};a.retry=function(){t()};var n=o({scope:a,title:"邀请"+s.assistUser.name+"进行远程协助",contentTemplate:"source/views/ticket/apps.request_assist.html",html:true,show:true,placement:"center",backdrop:"static",prefixEvent:"modal_request_assist"});a.hideModal=function(){n.$promise.then(n.hide)}};a.sendPincode=function(){l({url:"send_pincode.json",method:"POST",data:{email:s.assistUser.email,pincodeUrl:a.pincodeUrl,pincode:a.pincode}}).success(function(e,t,i,n){if(e.success){a.hideModal1()}else{if(e.message!=null){u.add(c("translate")(e.message),"danger")}else{u.add("发送邀请码失败","danger")}}})};a.showPincode=function(){$("#sidebar").css("display","none");var e=o({scope:a,title:"发送邀请码",contentTemplate:"source/views/ticket/apps.pincode.html",html:true,show:true,placement:"center",backdrop:"static"});a.hideModal1=function(){e.$promise.then(e.hide)};l({url:"pincode.json",method:"GET",params:{ticketId:r.id,inviteeId:s.assistUser.id,requesterId:n.user.id}}).success(function(e,t,i,n){if(e.success){a.pincode=e.json;a.pincodeUrl=d.protocol()+"://"+d.host()+"/pincode_"+a.pincode.code}else{a.hideModal1();if(e.message!=null){u.add(c("translate")(e.message),"danger")}else{u.add("请求失败","danger")}}})};var m=null;a.openSendMail=function(){a.senndParams=angular.copy(s.assistUser);a.senndParams.postscript="我是"+a.senndParams.serviceName+"我将就工单"+a.senndParams.number+"邀请您为您远程服务，请于工作时间，点击下方链接，即可连接到我。";$("#sidebar").css("display","none");m=o({scope:a,title:"发送邀约邮件",contentTemplate:"source/views/ticket/apps.send.mail.invite.html",html:true,show:true,placement:"center",backdrop:"static"});a.hideSendMail=function(){m.$promise.then(m.hide)}};a.sendMail=function(){var e=verifyEmailAddress(a.senndParams.email);if(e){var t={};t.email=a.senndParams.email;t.content=a.senndParams.postscript;t.inviteeId=a.senndParams.id;t.ticketId=a.senndParams.ticketId;org.ewei.sdk.OpenTicketApi().sendTicketRemoteInviceMail({invice:t}).then(function(e){u.add("发送成功","success");a.hideSendMail()},function(e){u.add("发送失败，请重试！","danger")})}else{u.add("请输入正确的邮箱格式！","danger")}};a.$on("$destroy",function(){if(m){m.$promise.then(m.hide)}})}]).controller("helpcenterticketSettingController",["$scope","$state","coreModelService",function(e,t,i){var n=i.config.route.get("system_setting_help_center");if(n){return t.go(n.name,n.params)}else{return t.go("system_setting.detail.client")}}]);(function(e){angular.module("eweiApp.ticket").controller("triggerTaskSettingController",["$scope","$state","$stateParams","permissions","coreModelService",function(i,n,e,t,s){var a=s.config.route.get("system-setting.triggerTask");if(!e.type){if(a&&a.name){if(a.name==="system_setting.triggerTask.ticket"&&t.hasPermission("ticket_setting_ticket_trigger")){n.go("system_setting.triggerTask.ticket")}else if(a.name==="system_setting.triggerTask.webchat"&&t.hasPermission("chat_edit_trigger")){n.go("system_setting.triggerTask.webchat")}}else{if(t.hasPermission("ticket_setting_ticket_trigger")){n.go("system_setting.triggerTask.ticket")}else if(t.hasPermission("chat_edit_trigger")){n.go("system_setting.triggerTask.webchat")}}}i.searchChannel=function(){if(!i.searchKey||i.searchKey==i.oldSearchKey){return}i.oldSearchKey=i.searchKey;i.$broadcast("search-triggerTask",i.searchKey)};i.cancelSearch=function(){i.oldSearchKey="";i.searchKey="";i.$broadcast("search-triggerTask",i.searchKey)};i.$watch("searchKey",function(e,t){if(e==""&&i.oldSearchKey){i.oldSearchKey="";i.$broadcast("search-triggerTask",i.searchKey)}});i.addTriggerTask=function(e,t,i){if(n.current&&n.current.name=="system_setting.triggerTask.ticket"){n.go("system_setting.triggerTask_edit_ticket",{id:0,type:t})}else{n.go("system_setting.triggerTask_edit_webchat",{id:0,type:t})}};i.goDetail=function(){i.searchKey=""}}])})(org.ewei);angular.module("eweiApp.ticket").controller("editAutomationController",["$rootScope","$modal_","$scope","$state","$stateParams","$resource","$http","alertService","permissions","$filter","allConditionOptions","anyConditionOptions","executeOptions","automationCompareOptions","$timeout","ticketEvaluateService","commonTools","ticketStatusCompareService",function(e,t,g,i,v,n,s,h,a,y,r,o,l,c,u,d,_,k){g.andConditionOptions=angular.copy(r);g.orConditionOptions=angular.copy(o);g.operationOptions=l;g.automation={type:"ticket",andConditions:[],orConditions:[],operations:[]};g.andConditions=[{attribute:"-1",tally:"and"}];g.orConditions=[{attribute:"-1",tally:"or"}];g.operations=[{attribute:"-1",options:l}];g.compareOptions=angular.copy(c);s.get("custom_field.json?scope=ticket&active=true&ignore_scan_able=true").success(function(e,t){g.customField=e.json;l=l.slice(0,13);angular.forEach(e.json,function(e,t,i){var n={};var s="";if(e.systemFieldKey=="priority"){n={option:"工单："+e.title,value:"priority",valueType:"select"}}else if(e.systemFieldKey=="ticket_type"){n={option:"工单："+e.title,value:"ticketType.id",valueType:"select"}}else if(e.systemFieldKey=="service_catalog"){n={option:"工单："+e.title,value:"serviceCatalog.id",valueType:"servicecatalog"}}else if(e.systemFieldKey=="subject"){n={option:"工单："+e.title,value:"subject",valueType:"text"}}else if(e.systemFieldKey=="tags"){n={option:"工单："+e.title,value:"tags",valueType:"autocomplete"}}else if(e.systemFieldKey=="ticket_description"){return}else if(e.type=="date_to_date"){s={option:"工单：自定义字段-"+e.title,value:"ticketcustomfield_"+e.type+"_"+e.id,valueType:"date_to_date"}}else if(e.type=="date_time"){n={option:"工单：自定义字段-"+e.title,value:"ticketcustomfield_"+e.type+"_"+e.id,valueType:"date_time"}}else{n={option:"工单：自定义字段-"+e.title,value:"ticketcustomfield_"+e.type+"_"+e.id,valueType:"text"}}if(e.type=="text"||e.type=="email"||e.type=="regexp"||e.type=="textarea"||e.type=="number"||e.type=="decimal"){n.valueType="text"}else if(e.type=="date"){n.valueType=e.type;n.start=false}else if(e.type=="date_time"){n.valueType=e.type}else if(e.type=="options"){if(e.customFieldOptions){if(e.systemFieldKey){n.valueType="select";var a=angular.fromJson(e.customFieldOptions);for(var r=0,o=a.length;r<o;r++){a[r].option=a[r].name}n.valueOptions=a}else{n.valueType="options";if(e.customFieldOptions){n.valueOptions=e}}}}else if(e.type=="cascade_options"){if(e.systemFieldKey=="service_catalog"){n.valueType="serviceCatalog"}else{n.valueType="cascade_options";if(e.customFieldOptions){n.valueOptions=e}}}else if(e.type=="multi_options"){n.valueType="multi_options";if(e.customFieldOptions){n.valueOptions=e}}else if(e.type=="checkbox"){n.valueType="checkbox"}else{n.valueType="text"}if(e.systemFieldKey=="tags"){n.valueType="autocomplete"}n.edit_able=e.edit_able;if(s!=""){n.startTimeForm=false;n.endTimeForm=false;l.push(s)}else{g.andConditionOptions.push(angular.copy(n));g.orConditionOptions.push(angular.copy(n));if(e.systemFieldKey!="ticket_description"&&e.systemFieldKey!="tags"){l.push(n)}}g.operationOptions=l;g.operations=[{attribute:"-1",edit_able:e.edit_able,options:l}]});g.type=v.type;if(v.id>0){g.loadAutomation(v.id)}});g.datepickers={startForm:false,startTo:false,updateFrom:false,updateTo:false};g.open=function(e,t,i){e.preventDefault();e.stopPropagation();t[i].start=!t[i].start};g.timeFrameOpen=function(e,t,i,n){e.preventDefault();e.stopPropagation();t[i][n]=!t[i][n]};var p=function(e,t,i){if(e=="and"){for(var n=0,s=g.andConditionOptions.length;n<s;n++){if(g.andConditionOptions[n].value==i){g.andConditions[t].valueType=g.andConditionOptions[n].valueType;g.andConditions[t].valueOptions=angular.copy(g.andConditionOptions[n].valueOptions);g.andConditions[t].edit_able=g.andConditionOptions[n].edit_able}}}else if(e=="or"){for(var n=0,s=g.orConditionOptions.length;n<s;n++){if(g.orConditionOptions[n].value==i){g.orConditions[t].valueType=g.orConditionOptions[n].valueType;g.orConditions[t].valueOptions=angular.copy(g.orConditionOptions[n].valueOptions);g.orConditions[t].edit_able=g.orConditionOptions[n].edit_able}}}else if(e=="operation"){for(var n=0,s=g.operationOptions.length;n<s;n++){if(g.operationOptions[n].value==i){g.operations[t].valueType=g.operationOptions[n].valueType;g.operations[t].edit_able=g.operationOptions[n].edit_able;g.operations[t].valueOptions=angular.copy(g.operationOptions[n].valueOptions);g.operations[t].start=g.operationOptions[n].start;g.operations[t].startTimeForm=g.operationOptions[n].startTimeForm;g.operations[t].endTimeForm=g.operationOptions[n].endTimeForm}}}};var f=function(e,t,i){if(e=="and"){g.andConditions[t].valueOptions=i}else if(e=="or"){g.orConditions[t].valueOptions=i}else if(e=="operation"){g.operations[t].valueOptions=i}};var m=function(e,t){var i=[{option:"未分派",value:"new"},{option:"已分派",value:"assigned"},{option:y("translate")("TICKET_STATUS_OPEN"),value:"open"},{option:y("translate")("TICKET_STATUS_SOLVED"),value:"solved"},{option:y("translate")("TICKET_STATUS_PENDING"),value:"pending"}];f(e,t,i)};var C=function(e,t){void 0;var i=[{option:y("translate")("TICKET_STATUS_OPEN"),value:"open"},{option:y("translate")("TICKET_STATUS_SOLVED"),value:"solved"},{option:y("translate")("TICKET_STATUS_PENDING"),value:"pending"},{option:y("translate")("TICKET_STATUS_CLOSED"),value:"closed"}];f(e,t,i)};var b=function(e,t){var i=[{option:"无效信息",value:"无效信息"},{option:"重复信息",value:"重复信息"},{option:"恶意骚扰",value:"恶意骚扰"},{option:"其他原因",value:"其他原因"}];f(e,t,i)};var w=function(e,t){var i=[{option:"已解决",value:"1"},{option:"未解决",value:"0"}];f(e,t,i)};var T=function(e,t){var i=[{option:"P1",value:"P1"},{option:"P2",value:"P2"},{option:"P3",value:"P3"},{option:"P4",value:"P4"},{option:"P5",value:"P5"}];f(e,t,i)};var S=function(o,l){s({url:"ticket_type.json",method:"GET",params:{_count:12332,_do_count:false,_fields:"id,name,description,isDefault"}}).success(function(e,t,i,n){userAginLogin(e);if(e.ticketTypes){var s=[];for(var a=0,r=e.ticketTypes.length;a<r;a++){s.push({option:e.ticketTypes[a].name,value:""+e.ticketTypes[a].id})}f(o,l,s)}})};var F=function(e,t){var i=[{option:"Email收件箱",value:"email"},{option:"网页表单(feedback)",value:"form"},{option:"在线交谈/远程协助",value:"chat"},{option:"微信客服",value:"weixin"},{option:"电话渠道",value:"cti"},{option:"帮助中心",value:"helpcenter"},{option:"客服创建",value:"console"}];f(e,t,i)};var A=function(e,t){var i=[{option:"1分",value:"1"},{option:"2分",value:"2"},{option:"3分",value:"3"},{option:"4分",value:"4"},{option:"5分",value:"5"}];f(e,t,i)};var E=function(e){var t=[];for(var i=0,n=e[1];i<n;i++){t.push(g.compareOptions[e[0]+i])}return t};var O=function(e,t,i){var n=[];if(i=="status"){if(e=="operation"){C(e,t)}else{m(e,t)}}else if(i=="ticketType.id"){S(e,t)}else if(i=="priority"){T(e,t)}else if(i=="evaluate.score"){A(e,t)}else if(i=="deleteTicket"){b(e,t)}else if(i==="evaluate.solved"){w(e,t)}};g.deleteCondition=function(e,t){if(e=="and"){g.andConditions.splice(t,1)}else if(e=="or"){g.orConditions.splice(t,1)}else if(e=="operation"){g.operations.splice(t,1)}};g.conditionChange=function(e,t,i){void 0;void 0;if(e=="and"){if(g.andConditions[t].value!=undefined&&g.andConditions[t].value!=null&&g.andConditions[t].value!=""){delete g.andConditions[t]["value"]}if(g.andConditions[t].compare!=undefined&&g.andConditions[t].compare!=null&&g.andConditions[t].compare!=""){delete g.andConditions[t]["compare"]}if(g.andConditions[t].engineer!=undefined&&g.andConditions[t].engineer!=null&&g.andConditions[t].engineer!=""){delete g.andConditions[t]["engineer"];delete g.andConditions[t]["engineerDesk"]}}else if(e=="or"){if(g.orConditions[t].value!=undefined&&g.orConditions[t].value!=null&&g.orConditions[t].value!=""){delete g.orConditions[t]["value"]}if(g.orConditions[t].compare!=undefined&&g.orConditions[t].compare!=null&&g.orConditions[t].compare!=""){delete g.orConditions[t]["compare"]}if(g.orConditions[t].engineer!=undefined&&g.orConditions[t].engineer!=null&&g.orConditions[t].engineer!=""){delete g.orConditions[t]["engineer"];delete g.orConditions[t]["engineerDesk"]}}else{if(g.operations[t].value){delete g.operations[t]["value"]}if(g.operations[t]["endTime"]!=undefined&&g.operations[t]["endTime"]!=null&&g.operations[t]["endTime"]!=""){delete g.operations[t]["endTime"]}if(g.operations[t]["startTime"]!=undefined&&g.operations[t]["startTime"]!=null&&g.operations[t]["startTime"]!=""){delete g.operations[t]["startTime"]}if(g.operations[t].engineer){delete g.operations[t]["engineer"];delete g.operations[t]["engineerDesk"]}}g.conditionGetNode(e,t)};g.conditionGetNode=function(e,t){if(e=="and"){g.andConditions[t].orderKey=t+1;var i=g.andConditions[t];if(i.value!="-1"){p(e,t,i.attribute);i=g.andConditions[t];if(i.valueType=="number"){i.value=Number(i.value)}if(i.attribute=="priority"||i.attribute=="status"||i.attribute=="ticketType.id"||i.attribute=="serviceDesk.id"||i.attribute=="requester.id"||i.attribute=="requester.userGroup.id"||i.attribute=="user.id"||i.attribute=="evaluate.score"){g.andConditions[t].compareOptions=E([0,2]);if(i.attribute=="status"){g.andConditions[t].compareOptions=g.andConditions[t].compareOptions.concat(E([31,2]));if(g.andConditions[t].value){g.andConditions[t].value=k.getCurrentStatus(g.andConditions[t].value)}}}else if(i.attribute=="serviceCatalog.id"){var n=[{option:"是且包含其子目录",value:"$in"},{option:"是但不包含其子目录",value:"$eq"},{option:"不是且不是其子目录",value:"$not_in"},{option:"不是但可能是其子目录",value:"$ne_or_null"}];g.andConditions[t].compareOptions=n}else if(i.attribute==="evaluate.solved"){g.andConditions[t].compareOptions=E([0,1])}else if(i.attribute=="engineer.id"){g.andConditions[t].compareOptions=E([14,2])}else if(i.attribute=="tags"){g.andConditions[t].compareOptions=E([10,2])}else if(i.attribute=="subject"||i.attribute=="ticket_description"){g.andConditions[t].compareOptions=E([12,2])}else if(i.attribute=="createdAt"||i.attribute=="ticketMetric.responseAt"||i.attribute=="ticketMetric.pausedAt"||i.attribute=="ticketMetric.solvedAt"||i.attribute=="ticketMetric.closedAt"){g.andConditions[t].compareOptions=E([4,3])}else if(i.attribute=="ticketComment"){g.andConditions[t].compareOptions=E([16,2])}else if(i.attribute=="via"){g.andConditions[t].compareOptions=E([18,2])}else if(i.attribute.indexOf("checkbox")>=0){g.andConditions[t].compareOptions=E([22,2]);g.andConditions[t].value="true"}else if(i.attribute.indexOf("textarea")>=0){g.andConditions[t].compareOptions=E([24,2])}else if(i.attribute.indexOf("date")>=0||i.attribute.indexOf("number")>=0||i.attribute.indexOf("decimal")>=0){g.andConditions[t].compareOptions=E([26,3])}else if(i.attribute.indexOf("ticketcustomfield")>=0){if(i.attribute.indexOf("multi_options")>=0){g.andConditions[t].compareOptions=E([29,2])}else{g.andConditions[t].compareOptions=E([20,2])}}else{g.andConditions[t].compareOptions=E([7,3])}if(i.valueType=="select"){O(e,t,i.attribute)}}}else if(e=="or"){g.orConditions[t].orderKey=t+1;var i=g.orConditions[t];if(i.value!="-1"){p(e,t,i.attribute);i=g.orConditions[t];if(i.valueType=="number"){i.value=Number(i.value)}if(i.attribute=="tags"){g.orConditions[t].compareOptions=E([10,2])}else if(i.attribute=="subject"||i.attribute=="ticket_description"){g.orConditions[t].compareOptions=E([12,2])}else if(i.attribute=="engineer.id"){g.orConditions[t].compareOptions=E([14,2])}else if(i.attribute=="ticketComment"){g.orConditions[t].compareOptions=E([16,2])}else if(i.attribute=="via"){g.orConditions[t].compareOptions=E([18,2])}else if(i.attribute.indexOf("checkbox")>=0){g.orConditions[t].compareOptions=E([22,2]);g.orConditions[t].value="true"}else if(i.attribute.indexOf("textarea")>=0){g.orConditions[t].compareOptions=E([24,2])}else if(i.attribute.indexOf("date")>=0||i.attribute.indexOf("number")>=0||i.attribute.indexOf("decimal")>=0){g.orConditions[t].compareOptions=E([26,3])}else if(i.attribute.indexOf("ticketcustomfield")>=0){if(i.attribute.indexOf("multi_options")>=0){g.orConditions[t].compareOptions=E([29,2])}else{g.orConditions[t].compareOptions=E([20,2])}}else if(i.attribute=="serviceCatalog.id"){var s=[{option:"是且包含其子目录",value:"$in"},{option:"是但不包含其子目录",value:"$eq"},{option:"不是且不是其子目录",value:"$not_in"},{option:"不是但可能是其子目录",value:"$ne"}];g.orConditions[t].compareOptions=s}else if(i.attribute==="evaluate.solved"){g.orConditions[t].compareOptions=E([0,1])}else if(i.attribute=="status"){g.orConditions[t].compareOptions=E([0,2]).concat(E([31,2]));if(g.orConditions[t].value){g.orConditions[t].value=k.getCurrentStatus(g.orConditions[t].value)}}else{g.orConditions[t].compareOptions=E([0,2])}if(i.valueType=="select"){O(e,t,i.attribute)}}}else{g.operations[t].orderKey=t+1;var i=g.operations[t];if(i.value!="-1"){p(e,t,i.attribute)}if(i.valueType=="select"){O(e,t,i.attribute)}if(i.attribute.indexOf("checkbox")>=0){g.operations[t].compareOptions=E([22,2])}}};g.getEngineer=function(t,e,i,n){s({url:"service_desk/"+e+".json",method:"GET",params:{}}).success(function(e){t[n].engineerDesk=e.json});s({url:"engineer/"+i+".json",method:"GET",params:{}}).success(function(e){t[n].engineer=e.json})};g.getServiceDesk=function(t,i){s({url:"service_desk/"+t[i].value+".json",method:"GET",params:{}}).success(function(e){t[i].value=e.json})};g.getRequester=function(t,i){s({url:"user/"+t[i].value+"/no_access_scope.json",method:"GET",params:{}}).success(function(e){t[i].value=e.json})};g.getUserGroup=function(t,i){s({url:"user_group/"+t[i].value+".json",method:"GET",params:{}}).success(function(e){t[i].value=e.json})};g.eweiPermisstionType="自动化";g.loadAutomation=function(e){org.ewei.sdk.OpenAutomationApi().getById({id:parseInt(e)}).then({success:function(e){g.automation=e;g.rolePermissions=g.automation.permissions;if(!g.automation.isDefault){g.andConditions=g.automation.andConditions;g.orConditions=g.automation.orConditions;g.operations=g.automation.operations;for(var t=0;t<g.operations.length;t++){if(g.operations[t].operate){g.operations[t].attribute=g.operations[t].operate;delete g.operations[t]["operate"]}}g.operations[0].options={};g.operations[0].options=l;for(var t=1;t<g.operations.length;t++){var i=[];for(var n=0;n<g.operations[t-1].options.length;n++){if(g.operations[t-1].attribute!=g.operations[t-1].options[n].value){i.push(g.operations[t-1].options[n])}}g.operations[t].options={};g.operations[t].options=i}function s(e,t){for(var i=0;i<e.length;i++){if(e[i].attribute=="createdAt"||e[i].attribute=="ticketMetric.responseAt"||e[i].attribute=="ticketMetric.pausedAt"||e[i].attribute=="ticketMetric.solvedAt"||e[i].attribute=="lastReply"||e[i].attribute=="customerLastReply"||e[i].attribute=="engineerLastReply"){e[i].value=parseInt(e[i].value)}if(e[i].attribute=="deleteTicket"){if(e[i].value!="无效信息"&&e[i].value!="重复信息"&&e[i].value!="恶意骚扰"){e[i].reason=e[i].value;e[i].value="其他原因"}}g.conditionGetNode(t,i);if(e[i].attribute=="engineer.id"){var n=e[i].value.split("_")[0];var s=e[i].value.split("_")[1];g.getEngineer(e,n,s,i);delete e[i]["value"]}else if(e[i].attribute=="noticeUser"){e[i].value=e[i].value}else if(e[i].attribute=="serviceDesk.id"||e[i].attribute=="noticeGroup"){g.getServiceDesk(e,i)}else if(e[i].attribute=="requester.id"){g.getRequester(e,i)}else if(e[i].attribute=="requester.userGroup.id"){g.getUserGroup(e,i)}else if(e[i].attribute=="addCC"){e[i].value=JSON.parse(e[i].value)}else if(e[i].attribute=="via"){e[i].value=JSON.parse(e[i].value)}if(t==="and"||t==="or"){if(e[i].compare==="$in"||e[i].compare==="$not_in"){e[i].value=e[i].value.replace("service_catalog_and_children_id_","")}}}}s(g.andConditions,"and");s(g.orConditions,"or");s(g.operations,"operation");var a=[g.andConditions,g.orConditions,g.operations];for(var t=0;t<a.length;t++){for(var n=0;n<a[t].length;n++){if(a[t][n].valueType=="cascade_options"||a[t][n].valueType=="multi_options"||a[t][n].valueType=="options"){a[t][n].valueOptions.value=a[t][n].value}else if(a[t][n].valueType=="date"){a[t][n].value=_.parseDate(a[t][n].value,"yyyy/MM/dd")}else if(a[t][n].valueType=="date_time"){}else if(a[t][n].valueType=="date_to_date"){var r=a[t][n].value;r=r.split("-");a[t][n].startTime=_.parseDate(r[0],"yyyy/MM/dd");a[t][n].endTime=_.parseDate(r[1],"yyyy/MM/dd")}if(t==2&&a[t][n].valueType=="checkbox"){a[t][n].compare=a[t][n].value=="true"?"$eq_ticket_custom_field":"$ne_or_null_ticket_custom_field"}}}}},fail:function(e){h.add("获取自动化程序详情失败！","danger")}})};g.addNewCondition=function(e){if(e=="and"){g.andConditions.push({attribute:"-1",tally:"and"})}else if(e=="or"){g.orConditions.push({attribute:"-1",tally:"or"})}else{var t=[];for(var i=0,n=l.length;i<n;i++){var s=false;for(var a=0,r=g.operations.length;a<r;a++){if(g.operations[a].attribute!=0&&g.operations[a].attribute==l[i].value){s=true;break}}if(!s){t.push(l[i])}}var o={attribute:"-1",orderKey:"",valueOptions:[],valueType:"",options:t};g.operations.push(o)}};g.backAutomation=function(){i.go("system_setting.detail",{uri:"automations",settingType:"ticket"})};g.isClick=false;g.saveAutomation=function(){var e=false;if(!g.automation.name){e=false}else{e=true}if(g.andConditions.length<1||g.operations.length<1){h.add("每项至少需要一个条件和一项操作","danger")}else{var t=false;var i=false;var n=false;var s=false;var a=false;var r=false;for(var o=0;o<g.andConditions.length;o++){if(g.andConditions[o].valueType=="cascade_options"||g.andConditions[o].valueType=="multi_options"||g.andConditions[o].valueType=="options"){g.andConditions[o].value=g.andConditions[o].valueOptions.value}if(g.andConditions[o].compare&&(g.andConditions[o].value||g.andConditions[o].value==0)&&g.andConditions[o].attribute!=0){if(typeof g.andConditions[o].value=="number"){if(g.andConditions[o].value<0){t=false;break}else{t=true;i=true}}else{t=true;i=true}}else{if(g.andConditions[o].engineer){g.andConditions[o].value=g.andConditions[o].engineerDesk.id+"_"+g.andConditions[o].engineer.id;t=true;i=true}else{i=false;break}}}if(g.orConditions.length>0){for(var o=0;o<g.orConditions.length;o++){if(g.orConditions[o].valueType=="cascade_options"||g.orConditions[o].valueType=="multi_options"||g.orConditions[o].valueType=="options"){g.orConditions[o].value=g.orConditions[o].valueOptions.value}if(g.orConditions[o].valueType=="date"){g.orConditions[o].value=_.parseDate(g.orConditions[o].value,"yyyy/MM/dd")}if(g.orConditions[o].compare&&g.orConditions[o].value&&g.orConditions[o].attribute!=0){n=true;s=true}else{if(g.orConditions[o].engineer){g.orConditions[o].value=g.orConditions[o].engineerDesk.id+"_"+g.orConditions[o].engineer.id;n=true;s=true}else{n=false;break}}}}else{n=true;s=true}for(var o=0;o<g.operations.length;o++){if(g.operations[o].valueType=="cascade_options"||g.operations[o].valueType=="multi_options"||g.operations[o].valueType=="options"){if(g.operations[o].valueOptions.value!="-"){g.operations[o].value=g.operations[o].valueOptions.value;a=true;r=true}else{r=false;break}}else if(g.operations[o].valueType=="date"){if(g.operations[o].value){var l=y("date")(g.operations[o].value,"yyyy/MM/dd").toString();g.operations[o].value=l;a=true;r=true}else{r=false;break}}else if(g.operations[o].valueType=="checkbox"){if(g.operations[o].compare){g.operations[o].value=g.operations[o].compare.indexOf("$eq_ticket_custom_field")>-1?"true":"false";a=true;r=true}else{r=false;break}}else if(g.operations[o].valueType=="date_to_date"){if(g.operations[o].startTime&&g.operations[o].endTime){var l=y("date")(g.operations[o].startTime,"yyyy/MM/dd").toString();var c=y("date")(g.operations[o].endTime,"yyyy/MM/dd").toString();var u=l+"-"+c;g.operations[o].value=u;a=true;r=true}else{r=false;break}}if(g.operations[o].attribute=="noticeUser"){if(g.operations[o].noticeTitle&&g.operations[o].noticeContent&&g.operations[o].value){g.operations[o].value=g.operations[o].value.id;a=true;r=true}else{r=false;break}}else if(g.operations[o].attribute=="noticeGroup"){if(g.operations[o].noticeTitle&&g.operations[o].noticeContent&&g.operations[o].value){a=true;r=true}else{r=false;break}}else if(g.operations[o].attribute=="addCC"){if(g.operations[o].value.length>0){a=true;r=true}else{r=false;break}}else if(g.operations[o].attribute=="ticketComment"){if(g.operations[o].value&&g.operations[o].value.type&&g.operations[o].value.engineer){a=true;r=true}else{r=false;break}}else if(g.operations[o].attribute=="deleteTicket"){if(!g.operations[o].value){r=false;break}if(g.operations[o].value!="其他原因"){a=true;r=true}else{if(g.operations[o].reason){a=true;r=true}else{r=false;break}}}else if(g.operations[o].attribute==="deleteTicketEvalute"){a=true;r=true}else if(g.operations[o].attribute!="noticeEvaluate"&&g.operations[o].attribute!="noticeUser"&&g.operations[o].attribute!="noticeGroup"&&g.operations[o].attribute!="addCC"){if(g.operations[o].value&&g.operations[o].attribute!=0){a=true;r=true}else{if(g.operations[o].engineer){g.operations[o].value=g.operations[o].engineerDesk.id+"_"+g.operations[o].engineer.id;a=true;r=true}else{a=false;break}}}}if(!e){h.add("请填写程序名称","danger")}else if(t&&i&&n&&s&&a&&r&&e){g.automation.andConditions=[];g.automation.orConditions=[];g.automation.operations=[];for(var o=0;o<g.andConditions.length;o++){t=true;var d={};d.orderKey=g.andConditions[o].orderKey;d.attribute=g.andConditions[o].attribute;d.compare=g.andConditions[o].compare;d.tally=g.andConditions[o].tally;if(typeof g.andConditions[o].value=="object"){if(g.andConditions[o].attribute.indexOf("ticketcustomfield")>=0){if(g.andConditions[o].attribute.indexOf("ticketcustomfield_date")>=0){d.value=y("date")(g.andConditions[o].value,"yyyy/MM/dd").toString()}else{d.value=g.andConditions[o].value}}else if(g.andConditions[o].attribute=="via"){d.value=JSON.stringify(g.andConditions[o].value)}else{if(d.compare==="$in"||d.compare==="$not_in"){d.value="service_catalog_and_children_id_"+g.andConditions[o].value.id}else{d.value=g.andConditions[o].value.id}}}else{if(g.andConditions[o].attribute.indexOf("ticketcustomfield_checkbox")>=0){d.value="true"}else{if(d.compare==="$in"||d.compare==="$not_in"){if(d.attribute==="serviceCatalog.id"){d.value="service_catalog_and_children_id_"+g.andConditions[o].value}else{d.value=k.run(g.andConditions[o].value,d.compare)}}else{d.value=g.andConditions[o].value}}}g.automation.andConditions.push(d)}for(var o=0;o<g.orConditions.length;o++){var p={};p.orderKey=g.orConditions[o].orderKey;p.attribute=g.orConditions[o].attribute;p.compare=g.orConditions[o].compare;p.tally=g.orConditions[o].tally;if(typeof g.orConditions[o].value=="object"){if(g.orConditions[o].attribute.indexOf("ticketcustomfield")>=0){if(g.orConditions[o].attribute.indexOf("ticketcustomfield_date")>=0){p.value=y("date")(g.orConditions[o].value,"yyyy/MM/dd").toString()}else{p.value=g.orConditions[o].value}}else if(g.orConditions[o].attribute=="via"){p.value=JSON.stringify(g.orConditions[o].value)}else{if(p.compare==="$in"||p.compare==="$not_in"){p.value="service_catalog_and_children_id_"+g.orConditions[o].value.id}else{p.value=g.orConditions[o].value.id}}}else{if(g.orConditions[o].attribute.indexOf("ticketcustomfield_checkbox")>=0){p.value="true"}else{if(p.compare==="$in"||p.compare==="$not_in"){if(p.attribute==="serviceCatalog.id"){p.value="service_catalog_and_children_id_"+g.orConditions[o].value}else{p.value=k.run(g.orConditions[o].value,p.compare)}}else{p.value=g.orConditions[o].value}}}g.automation.orConditions.push(p)}for(var o=0;o<g.operations.length;o++){var f={};if(g.operations[o].attribute!="noticeEvaluate"){f.orderKey=g.operations[o].orderKey;if(g.operations[o].attribute=="noticeUser"||g.operations[o].attribute=="noticeGroup"){f.operate=g.operations[o].attribute}else{f.attribute=g.operations[o].attribute}if(typeof g.operations[o].value=="object"){if(g.operations[o].attribute=="addCC"||g.operations[o].attribute=="ticketComment"){f.value=g.operations[o].value;if(g.operations[o].attribute=="ticketComment"&&g.operations[o].value.open==null){f.value.open=true}}else{f.value=g.operations[o].value.id}}else if(g.operations[o].attribute=="deleteTicket"){if(g.operations[o].value==="其他原因"){f.value=g.operations[o].reason}else{f.value=g.operations[o].value}}else{f.value=g.operations[o].value}if(g.operations[o].noticeTitle){f.noticeTitle=g.operations[o].noticeTitle}if(g.operations[o].noticeContent){f.noticeContent=g.operations[o].noticeContent}}else{f.orderKey=g.operations[o].orderKey;f.operate=g.operations[o].attribute}if(f.attribute==="ticketComment"){f.value=JSON.stringify(g.operations[o].value)}g.automation.operations.push(f)}g.isClick=true;if(v.type=="clone"){if(g.automation.id){delete g.automation.id}}var m={automation:g.automation};m.automation.permissions=[];angular.forEach(g.fieldPermissions,function(e){role={};role.roleId=e.id;role.scanAble=e.scanAble;role.editAble=e.editAble;m.automation.permissions.push(role)});org.ewei.sdk.OpenAutomationApi().save(m).then({success:function(e){h.add("更新成功");g.backAutomation();g.isClick=false},fail:function(e){g.isClick=false;if(e!=null){h.add(y("translate")(e.error_description),"danger")}else{h.add("更新失败","danger")}for(var t=0;t<g.andConditions.length;t++){if(g.andConditions[t].attribute=="engineer.id"){delete g.andConditions[t]["value"]}}for(var t=0;t<g.orConditions.length;t++){if(g.orConditions[t].attribute=="engineer.id"){delete g.orConditions[t]["value"]}}for(var t=0;t<g.operations.length;t++){if(g.operations[t].attribute=="engineer.id"){delete g.operations[t]["value"]}}}})}else if(!i||!s||!r){h.add("请把信息填写完整","danger")}else if(!t||!n||!a){h.add("信息填写错误","danger")}}};g.saveAutomationDefault=function(e){var t=parseInt(e.tempValue==null?0:e.tempValue);if((e.type=="chat"||e.type=="weixin_chat")&&(t<8||t>2880)){h.add("自动结束会话时间在8-2880分钟之间","danger");return}else if(e.type=="ticket"&&(t<0||t>2e4)){h.add("自动关闭工单需在0到20000之间","danger");return}var i={automation:e};i.automation.permissions=[];angular.forEach(g.fieldPermissions,function(e){role={};role.roleId=e.id;role.scanAble=e.scanAble;role.editAble=e.editAble;i.automation.permissions.push(role)});org.ewei.sdk.OpenAutomationApi().updateAutomation(i).then({success:function(e){h.add("更新成功");g.backAutomation();g.isClick=false},fail:function(e){h.add("更新失败","danger")}})};g.checkCharCount=function(e){var t=$(e);if(t.val()!=null&&t.val()!=""){if(t.val().length>=t.attr("maxlength")){h.add(t.prev().text()+"不能超过"+t.attr("maxlength")+"个字符","danger")}}}}]);(function(N){angular.module("eweiApp.ticket").controller("editTriggerController",["$rootScope","$modal_","$scope","$state","$stateParams","$resource","$http","alertService","permissions","$filter","allConditionOptionsTrigger","anyConditionOptionsTrigger","executeOptionsTrigger","triggerCompareOptions","$timeout","ticketEvaluateService","commonTools","ticketStatusCompareService","ConsoleConfig",function(e,t,y,i,_,n,s,k,a,C,r,o,l,c,u,d,p,b,f){y.andConditionOptions=angular.copy(r);y.orConditionOptions=angular.copy(o);y.triggerTask={andConditions:[],orConditions:[],operations:[]};y.andConditions=[{attribute:"-1",tally:"and"}];y.orConditions=[{attribute:"-1",tally:"or"}];y.compareOptions=angular.copy(c);s.get("custom_field.json?scope=ticket&active=true&ignore_scan_able=true").success(function(e,t){l=l.slice(0,13);angular.forEach(e.json,function(e,t,i){var n={};var s="";if(e.systemFieldKey=="priority"){n={option:"工单："+e.title,value:"priority",valueType:"select"}}else if(e.systemFieldKey=="ticket_type"){n={option:"工单："+e.title,value:"ticketType",valueType:"select"}}else if(e.systemFieldKey=="service_catalog"){n={option:"工单："+e.title,value:"serviceCatalog",valueType:"servicecatalog"}}else if(e.systemFieldKey=="subject"){n={option:"工单："+e.title,value:"subject",valueType:"autocomplete"}}else if(e.systemFieldKey=="tags"){n={option:"工单："+e.title,value:"tags",valueType:"autocomplete"}}else if(e.systemFieldKey=="ticket_description"){return}else if(e.type=="date_to_date"){s={option:"工单：自定义字段-"+e.title,value:"ticketcustomfield_"+e.type+"_"+e.id,valueType:"date_to_date"}}else if(e.type=="date_time"){n={option:"工单：自定义字段-"+e.title,value:"ticketcustomfield_"+e.type+"_"+e.id,valueType:"date_time"}}else{n={option:"工单：自定义字段-"+e.title,value:"ticketcustomfield_"+e.type+"_"+e.id,valueType:"text"}}if(e.type=="text"||e.type=="email"||e.type=="regexp"||e.type=="textarea"||e.type=="number"||e.type=="decimal"){n.valueType="text"}else if(e.type=="date"){n.valueType=e.type;n.start=false}else if(e.type=="date_time"){n.valueType=e.type}else if(e.type=="options"){if(e.customFieldOptions){if(e.systemFieldKey){n.valueType="select";var a=angular.fromJson(e.customFieldOptions);for(var r=0,o=a.length;r<o;r++){a[r].option=a[r].name}n.valueOptions=a}else{n.valueType="options";if(e.customFieldOptions){n.valueOptions=e}}}}else if(e.type=="cascade_options"){if(e.systemFieldKey=="service_catalog"){n.valueType="serviceCatalog"}else{n.valueType="cascade_options";if(e.customFieldOptions){n.valueOptions=e}}}else if(e.type=="multi_options"){n.valueType="multi_options";if(e.customFieldOptions){n.valueOptions=e}}else if(e.type=="checkbox"){n.valueType="checkbox"}else{n.valueType="text"}if(e.systemFieldKey=="tags"){n.valueType="autocomplete"}n.edit_able=e.edit_able;if(s!=""){n.startTimeForm=false;n.endTimeForm=false;l.push(s)}else{y.andConditionOptions.push(angular.copy(n));y.orConditionOptions.push(angular.copy(n));if(e.systemFieldKey!="ticket_description"&&e.systemFieldKey!="tags"){l.push(n)}}y.operationOptions=l;y.operations=[{attribute:"-1",edit_able:e.edit_able,options:l}]});y.type=_.type;if(_.id>0){y.loadTrigger(_.id)}});y.datepickers={startForm:false,startTo:false,updateFrom:false,updateTo:false};y.open=function(e,t,i){e.preventDefault();e.stopPropagation();t[i].start=!t[i].start};y.timeFrameOpen=function(e,t,i,n){e.preventDefault();e.stopPropagation();t[i][n]=!t[i][n]};var m=function(e,t,i){if(e=="and"){for(var n=0,s=y.andConditionOptions.length;n<s;n++){if(y.andConditionOptions[n].value==i){y.andConditions[t].valueType=y.andConditionOptions[n].valueType;y.andConditions[t].valueOptions=angular.copy(y.andConditionOptions[n].valueOptions);y.andConditions[t].edit_able=y.andConditionOptions[n].edit_able}}}else if(e=="or"){for(var n=0,s=y.orConditionOptions.length;n<s;n++){if(y.orConditionOptions[n].value==i){y.orConditions[t].valueType=y.orConditionOptions[n].valueType;y.orConditions[t].valueOptions=angular.copy(y.orConditionOptions[n].valueOptions);y.orConditions[t].edit_able=y.orConditionOptions[n].edit_able}}}else if(e=="operation"){for(var n=0,s=y.operationOptions.length;n<s;n++){if(y.operationOptions[n].value==i){y.operations[t].valueType=y.operationOptions[n].valueType;y.operations[t].edit_able=y.operationOptions[n].edit_able;y.operations[t].valueOptions=angular.copy(y.operationOptions[n].valueOptions);y.operations[t].start=y.operationOptions[n].start;y.operations[t].startTimeForm=y.operationOptions[n].startTimeForm;y.operations[t].endTimeForm=y.operationOptions[n].endTimeForm}}}};var g=function(e,t,i){if(e=="and"){y.andConditions[t].valueOptions=i}else if(e=="or"){y.orConditions[t].valueOptions=i}else if(e=="operation"){y.operations[t].valueOptions=i}};var v=function(e,t){var i=[{option:"未分派",value:"new"},{option:"已分派",value:"assigned"},{option:C("translate")("TICKET_STATUS_OPEN"),value:"open"},{option:C("translate")("TICKET_STATUS_SOLVED"),value:"solved"},{option:C("translate")("TICKET_STATUS_PENDING"),value:"pending"}];g(e,t,i)};var h=function(e,t){var i=[{option:C("translate")("TICKET_STATUS_OPEN"),value:"open"},{option:C("translate")("TICKET_STATUS_SOLVED"),value:"solved"},{option:C("translate")("TICKET_STATUS_PENDING"),value:"pending"},{option:C("translate")("TICKET_STATUS_CLOSED"),value:"closed"}];g(e,t,i)};var w=function(e,t){var i=[{option:"无效信息",value:"无效信息"},{option:"重复信息",value:"重复信息"},{option:"恶意骚扰",value:"恶意骚扰"},{option:"其他原因",value:"其他原因"}];g(e,t,i)};var T=function(e,t){var i=[{option:"P1",value:"P1"},{option:"P2",value:"P2"},{option:"P3",value:"P3"},{option:"P4",value:"P4"},{option:"P5",value:"P5"}];g(e,t,i)};var S=function(o,l){s({url:"ticket_type.json",method:"GET",params:{_count:12332,_do_count:false,_fields:"id,name,description,isDefault"}}).success(function(e,t,i,n){userAginLogin(e);if(e.ticketTypes){var s=[];for(var a=0,r=e.ticketTypes.length;a<r;a++){s.push({option:e.ticketTypes[a].name,value:""+e.ticketTypes[a].id})}g(o,l,s)}})};var F=function(e,t){var i=[{option:"已解决",value:"1"},{option:"未解决",value:"0"}];g(e,t,i)};var A=function(e,t){var i=[{option:"客户",value:"customer"},{option:"客服",value:"engineer"}];g(e,t,i)};var E=function(e,t){var i=[{option:"Email收件箱",value:"email"},{option:"网页表单(feedback)",value:"form"},{option:"在线交谈/远程协助",value:"chat"},{option:"微信客服",value:"weixin"},{option:"电话渠道",value:"cti"},{option:"帮助中心",value:"helpcenter"},{option:"客服创建",value:"console"}];g(e,t,i)};var O=function(e,t){var i=[{option:"1分",value:"1"},{option:"2分",value:"2"},{option:"3分",value:"3"},{option:"4分",value:"4"},{option:"5分",value:"5"}];g(e,t,i)};var I=function(e){var t=[];for(var i=0,n=e[1];i<n;i++){t.push(y.compareOptions[e[0]+i])}return t};var L=function(e,t,i){var n=[];if(i=="status"){if(e=="operation"){h(e,t)}else{v(e,t)}}else if(i=="ticketType"){S(e,t)}else if(i=="priority"){T(e,t)}else if(i=="evaluate.score"){O(e,t)}else if(i=="deleteTicket"){w(e,t)}else if(i==="evaluate.solved"){F(e,t)}else if(i==="ticket_comment_user_type"){A(e,t)}};y.deleteCondition=function(e,t){var i;if(e=="and"){y.andConditions.splice(t,1);i=y.andConditions}else if(e=="or"){y.orConditions.splice(t,1);i=y.andConditions}else if(e=="operation"){y.operations.splice(t,1);i=y.operations}i.forEach(function(e,t,i){e.orderKey=t+1})};var D=function(e){var t=[];for(var i=0,n=e[1];i<n;i++){t.push(y.compareOptions[e[0]+i])}return t};y.conditionChange=function(e,t,i){void 0;if(e=="and"){if(y.andConditions[t].value!=undefined&&y.andConditions[t].value!=null&&y.andConditions[t].value!=""){delete y.andConditions[t]["value"]}if(y.andConditions[t].compare!=undefined&&y.andConditions[t].compare!=null&&y.andConditions[t].compare!=""){delete y.andConditions[t]["compare"]}if(y.andConditions[t].engineer!=undefined&&y.andConditions[t].engineer!=null&&y.andConditions[t].engineer!=""){delete y.andConditions[t]["engineer"];delete y.andConditions[t]["engineerDesk"]}}else if(e=="or"){if(y.orConditions[t].value!=undefined&&y.orConditions[t].value!=null&&y.orConditions[t].value!=""){delete y.orConditions[t]["value"]}if(y.orConditions[t].compare!=undefined&&y.orConditions[t].compare!=null&&y.orConditions[t].compare!=""){delete y.orConditions[t]["compare"]}if(y.orConditions[t].engineer!=undefined&&y.orConditions[t].engineer!=null&&y.orConditions[t].engineer!=""){delete y.orConditions[t]["engineer"];delete y.orConditions[t]["engineerDesk"]}}else{if(y.operations[t].value){delete y.operations[t]["value"]}if(y.operations[t]["endTime"]!=undefined&&y.operations[t]["endTime"]!=null&&y.operations[t]["endTime"]!=""){delete y.operations[t]["endTime"]}if(y.operations[t]["startTime"]!=undefined&&y.operations[t]["startTime"]!=null&&y.operations[t]["startTime"]!=""){delete y.operations[t]["startTime"]}if(y.operations[t].engineer){delete y.operations[t]["engineer"];delete y.operations[t]["engineerDesk"]}}y.conditionGetNode(e,t)};y.conditionGetNode=function(e,t){if(e=="and"){y.andConditions[t].orderKey=t+1;var i=y.andConditions[t];if(i.value!="-1"){m(e,t,i.attribute);i=y.andConditions[t];if(i.attribute=="priority"||i.attribute=="status"||i.attribute=="ticketType"||i.attribute=="requester.id"||i.attribute=="user"||i.attribute=="evaluate.score"){y.andConditions[t].compareOptions=D([0,2]);if(i.attribute=="status"){y.andConditions[t].compareOptions=y.andConditions[t].compareOptions.concat(D([15,2]));if(y.andConditions[t].value){y.andConditions[t].value=b.getCurrentStatus(y.andConditions[t].value)}}}else if(i.attribute=="serviceDesk"){y.andConditions[t].compareOptions=D([19,2])}else if(i.attribute=="userGroup"){y.andConditions[t].compareOptions=D([17,2])}else if(i.attribute=="serviceCatalog"){var n=[{option:"是且包含其子目录",value:"$in"},{option:"是但不包含其子目录",value:"$eq"},{option:"不是且不是其子目录",value:"$not_in"},{option:"不是但可能是其子目录",value:"$ne_or_null"}];y.andConditions[t].compareOptions=n}else if(i.attribute==="evaluate.solved"){y.andConditions[t].compareOptions=D([0,1])}else if(i.attribute=="engineer"){y.andConditions[t].compareOptions=D([0,2])}else if(i.attribute=="tags"){y.andConditions[t].compareOptions=D([2,2])}else if(i.attribute=="subject"||i.attribute=="ticket_description"){y.andConditions[t].compareOptions=D([2,2])}else if(i.attribute=="createdAt"||i.attribute=="ticketMetric.responseAt"||i.attribute=="ticketMetric.pausedAt"||i.attribute=="ticketMetric.solvedAt"||i.attribute=="ticketMetric.closedAt"){y.andConditions[t].compareOptions=D([4,3])}else if(i.attribute=="ticket_comment"){y.andConditions[t].compareOptions=D([2,2])}else if(i.attribute.indexOf("ticket_comment_user_type")>=0){y.andConditions[t].compareOptions=D([0,1])}else if(i.attribute=="via"){y.andConditions[t].compareOptions=D([0,2])}else if(i.attribute.indexOf("checkbox")>=0){y.andConditions[t].compareOptions=D([6,2]);y.andConditions[t].value="true"}else if(i.attribute.indexOf("textarea")>=0){y.andConditions[t].compareOptions=D([8,2])}else if(i.attribute.indexOf("text")>=0){y.andConditions[t].compareOptions=D([4,2]);y.andConditions[t].compareOptions=y.andConditions[t].compareOptions.concat(D([8,2]))}else if(i.attribute.indexOf("date")>=0||i.attribute.indexOf("number")>=0||i.attribute.indexOf("decimal")>=0){y.andConditions[t].compareOptions=D([10,3])}else if(i.attribute.indexOf("ticketcustomfield")>=0){if(i.attribute.indexOf("multi_options")>=0){y.andConditions[t].compareOptions=D([13,2])}else{y.andConditions[t].compareOptions=D([4,2])}}else{}if(i.valueType=="select"){L(e,t,i.attribute)}}}else if(e=="or"){y.orConditions[t].orderKey=t+1;var i=y.orConditions[t];if(i.value!="-1"){m(e,t,i.attribute);i=y.orConditions[t];if(i.attribute=="tags"){y.orConditions[t].compareOptions=D([2,2])}else if(i.attribute=="subject"||i.attribute=="ticket_description"){y.orConditions[t].compareOptions=D([2,2])}else if(i.attribute=="engineer"){y.orConditions[t].compareOptions=D([0,2])}else if(i.attribute=="ticket_comment"){y.orConditions[t].compareOptions=D([2,2])}else if(i.attribute.indexOf("ticket_comment_user_type")>=0){y.orConditions[t].compareOptions=D([0,1])}else if(i.attribute=="via"){y.orConditions[t].compareOptions=D([0,2])}else if(i.attribute.indexOf("checkbox")>=0){y.orConditions[t].compareOptions=D([6,2]);y.orConditions[t].value="true"}else if(i.attribute.indexOf("textarea")>=0){y.orConditions[t].compareOptions=D([8,2])}else if(i.attribute.indexOf("date")>=0||i.attribute.indexOf("number")>=0||i.attribute.indexOf("decimal")>=0){y.orConditions[t].compareOptions=D([10,3])}else if(i.attribute.indexOf("text")>=0){y.orConditions[t].compareOptions=D([4,2]);y.orConditions[t].compareOptions=y.orConditions[t].compareOptions.concat(D([8,2]))}else if(i.attribute.indexOf("ticketcustomfield")>=0){if(i.attribute.indexOf("multi_options")>=0){y.orConditions[t].compareOptions=D([13,2])}else{y.orConditions[t].compareOptions=D([4,2])}}else if(i.attribute=="serviceCatalog"){var s=[{option:"是且包含其子目录",value:"$in"},{option:"是但不包含其子目录",value:"$eq"},{option:"不是且不是其子目录",value:"$not_in"},{option:"不是但可能是其子目录",value:"$ne"}];y.orConditions[t].compareOptions=s}else if(i.attribute==="evaluate.solved"){y.orConditions[t].compareOptions=D([0,1])}else if(i.attribute=="status"){y.orConditions[t].compareOptions=D([0,2]).concat(D([15,2]));if(y.orConditions[t].value){y.orConditions[t].value=b.getCurrentStatus(y.orConditions[t].value)}}else if(i.attribute=="serviceDesk"){y.orConditions[t].compareOptions=D([19,2])}else if(i.attribute=="userGroup"){y.orConditions[t].compareOptions=D([17,2])}else{y.orConditions[t].compareOptions=D([0,2])}if(i.valueType=="select"){L(e,t,i.attribute)}}}else{y.operations[t].orderKey=t+1;var i=y.operations[t];if(i.value!="-1"){m(e,t,i.attribute)}if(i.valueType=="select"){L(e,t,i.attribute)}if(i.attribute.indexOf("checkbox")>=0){y.operations[t].compareOptions=D([6,2])}}};y.getEngineer=function(t,e,i,n){if(i==="${current_engineer_id}"){t[n].engineer={name:"（当前客服）",id:"${current_engineer_id}"}}else{s({url:"service_desk/"+e+".json",method:"GET",params:{}}).success(function(e){t[n].engineerDesk=e.json});s({url:"engineer/"+i+".json",method:"GET",params:{}}).success(function(e){t[n].engineer=e.json})}};y.getRequester=function(t,i){if(t[i].value==="${current_user_id}"){t[i].value={id:"${current_user_id}",name:"（当前客户）"}}else{s({url:"user/"+t[i].value+"/no_access_scope.json",method:"GET",params:{}}).success(function(e){t[i].value=e.json})}};y.eweiPermisstionType="触发器";y.loadTrigger=function(e){N.sdk.OpenTicketTriggerApi().getTicketTriggerById({id:parseInt(e)}).then(function(e){userAginLogin(e);if(e){y.triggerTask=e;y.rolePermissions=y.triggerTask.permissions;if(!y.triggerTask.isDefault){y.andConditions=y.triggerTask.andConditions;y.orConditions=y.triggerTask.orConditions;for(keys in y.triggerTask.operations){if((y.triggerTask.operations[keys].operate=="mailto_service_desk"||y.triggerTask.operations[keys].operate=="mailto_user")&&typeof y.triggerTask.operations[keys].value!="undefined"){try{y.triggerTask.operations[keys].value=JSON.parse(y.triggerTask.operations[keys].value)}catch(e){void 0}}}y.operations=y.triggerTask.operations;for(var t=0;t<y.operations.length;t++){if(y.operations[t].operate){y.operations[t].attribute=y.operations[t].operate;delete y.operations[t]["operate"]}}y.operations[0].options={};y.operations[0].options=l;for(var t=1;t<y.operations.length;t++){var i=[];for(var n=0;n<y.operations[t-1].options.length;n++){if(y.operations[t-1].attribute!=y.operations[t-1].options[n].value){i.push(y.operations[t-1].options[n])}}y.operations[t].options={};y.operations[t].options=i}function s(e,t){for(var i=0;i<e.length;i++){if(e[i].attribute=="createdAt"||e[i].attribute=="ticketMetric.responseAt"||e[i].attribute=="ticketMetric.pausedAt"||e[i].attribute=="ticketMetric.solvedAt"||e[i].attribute=="lastReply"||e[i].attribute=="customerLastReply"||e[i].attribute=="engineerLastReply"){e[i].value=parseInt(e[i].value)}if(e[i].attribute=="deleteTicket"){if(e[i].value!="无效信息"&&e[i].value!="重复信息"&&e[i].value!="恶意骚扰"){e[i].reason=e[i].value;e[i].value="其他原因"}}y.conditionGetNode(t,i);var n;var s;if(e[i].attribute=="engineer"){if(e[i].value==="${current_engineer_id}"){s="${current_engineer_id}"}else{n=e[i].value.split("_")[0];s=e[i].value.split("_")[1]}y.getEngineer(e,n,s,i);delete e[i]["value"]}else if(e[i].attribute=="mailto_user"){e[i].value=e[i].value}else if(e[i].attribute=="mailto_service_desk"){}else if(e[i].attribute=="requester.id"){y.getRequester(e,i)}else if(e[i].attribute=="userGroup"||e[i].attribute=="serviceDesk"){if(e[i].compare!="$in"&&e[i].compare!="$not_in"){e[i].compare=e[i].compare==="$eq"?"$in":"$not_in"}}else if(e[i].attribute==="user"){if(e[i].compare==="$ne_or_null"){e[i].compare="$ne"}}else if(e[i].attribute=="addCC"){e[i].value=JSON.parse(e[i].value)}else if(e[i].attribute=="via"){e[i].value=JSON.parse(e[i].value)}if(t==="and"||t==="or"){if(e[i].compare==="$in"||e[i].compare==="$not_in"){if(e[i].valueType!="userGroup"){e[i].value=e[i].value.replace("service_catalog_and_children_id_","")}}}}}s(y.andConditions,"and");s(y.orConditions,"or");s(y.operations,"operation");var a=[y.andConditions,y.orConditions,y.operations];for(var t=0;t<a.length;t++){for(var n=0;n<a[t].length;n++){if(a[t][n].valueType=="cascade_options"||a[t][n].valueType=="multi_options"||a[t][n].valueType=="options"){a[t][n].valueOptions.value=a[t][n].value}else if(a[t][n].valueType=="date"){a[t][n].value=p.parseDate(a[t][n].value,"yyyy/MM/dd")}else if(a[t][n].valueType=="date_to_date"){var r=a[t][n].value;r=r.split("-");a[t][n].startTime=p.parseDate(r[0],"yyyy/MM/dd");a[t][n].endTime=p.parseDate(r[1],"yyyy/MM/dd")}if(t==2&&a[t][n].valueType=="checkbox"){a[t][n].compare=a[t][n].value=="true"?"$eq_ticket_custom_field":"$ne_or_null_ticket_custom_field"}}}}}})};y.addNewCondition=function(e){if(e=="and"){y.andConditions.push({attribute:"-1",tally:"and"})}else if(e=="or"){y.orConditions.push({attribute:"-1",tally:"or"})}else{var t=[];for(var i=0,n=l.length;i<n;i++){var s=false;for(var a=0,r=y.operations.length;a<r;a++){if(y.operations[a].attribute!=0&&y.operations[a].attribute==l[i].value){s=true;break}}if(!s){t.push(l[i])}}var o={attribute:"-1",orderKey:"",valueOptions:[],valueType:"",options:t};y.operations.push(o)}};y.backTrigger=function(){i.go("system_setting.detail",{uri:"triggerTask",settingType:"ticket"})};y.isClick=false;y.saveTriggerTask=function(){var e=false;if(!y.triggerTask.name){e=false}else{e=true}if(y.andConditions.length<1||y.operations.length<1){k.add("每项至少需要一个条件和一项操作","danger")}else{var t=false;var i=false;var n=false;var s=false;var a=false;var r=false;for(var o=0;o<y.andConditions.length;o++){if(y.andConditions[o].valueType=="cascade_options"||y.andConditions[o].valueType=="multi_options"||y.andConditions[o].valueType=="options"){y.andConditions[o].value=y.andConditions[o].valueOptions.value;void 0}if(y.andConditions[o].compare&&(y.andConditions[o].value||y.andConditions[o].value==0)&&y.andConditions[o].attribute!=0){if(typeof y.andConditions[o].value=="number"){if(y.andConditions[o].value<0){t=false;break}else{t=true;i=true}}else{t=true;i=true}}else{if(y.andConditions[o].engineer){if(y.andConditions[o].engineerDesk){y.andConditions[o].value=y.andConditions[o].engineerDesk.id+"_"+y.andConditions[o].engineer.id}else{y.andConditions[o].value=y.andConditions[o].engineer.id}t=true;i=true}else{i=false;break}}}if(y.orConditions.length>0){for(var o=0;o<y.orConditions.length;o++){if(y.orConditions[o].valueType=="cascade_options"||y.orConditions[o].valueType=="multi_options"||y.orConditions[o].valueType=="options"){y.orConditions[o].value=y.orConditions[o].valueOptions.value}if(y.orConditions[o].compare&&y.orConditions[o].value&&y.orConditions[o].attribute!=0){n=true;s=true}else{if(y.orConditions[o].engineer){if(y.orConditions[o].engineerDesk){y.orConditions[o].value=y.orConditions[o].engineerDesk.id+"_"+y.orConditions[o].engineer.id}else{y.orConditions[o].value=y.orConditions[o].engineer.id}n=true;s=true}else{n=false;break}}}}else{n=true;s=true}for(var o=0;o<y.operations.length;o++){if(y.operations[o].valueType=="cascade_options"||y.operations[o].valueType=="multi_options"||y.operations[o].valueType=="options"){if(y.operations[o].valueOptions.value!="-"){y.operations[o].value=y.operations[o].valueOptions.value;a=true;r=true}else{r=false;break}}else if(y.operations[o].valueType=="date"){if(y.operations[o].value){var l=C("date")(y.operations[o].value,"yyyy/MM/dd").toString();y.operations[o].value=l;a=true;r=true}else{r=false;break}}else if(y.operations[o].valueType=="checkbox"){if(y.operations[o].compare){y.operations[o].value=y.operations[o].compare.indexOf("$eq_ticket_custom_field")>-1?"true":"false";a=true;r=true}else{r=false;break}}else if(y.operations[o].valueType=="date_to_date"){if(y.operations[o].startTime&&y.operations[o].endTime){var l=C("date")(y.operations[o].startTime,"yyyy/MM/dd").toString();var c=C("date")(y.operations[o].endTime,"yyyy/MM/dd").toString();var u=l+"-"+c;y.operations[o].value=u;a=true;r=true}else{r=false;break}}if(y.operations[o].attribute=="mailto_user"){if(y.operations[o].value.title&&y.operations[o].value.content&&y.operations[o].value){a=true;r=true}else{r=false;break}}else if(y.operations[o].attribute=="mailto_service_desk"){if(y.operations[o].value.title&&y.operations[o].value.content&&y.operations[o].value){a=true;r=true}else{r=false;break}}else if(y.operations[o].attribute=="addCC"){if(y.operations[o].value.length>0){a=true;r=true}else{r=false;break}}else if(y.operations[o].attribute=="ticket_comment"){if(y.operations[o].value&&y.operations[o].value.type&&y.operations[o].value.engineer){a=true;r=true}else{r=false;break}}else if(y.operations[o].attribute=="deleteTicket"){if(!y.operations[o].value){r=false;break}if(y.operations[o].value!="其他原因"){a=true;r=true}else{if(y.operations[o].reason){a=true;r=true}else{r=false;break}}}else if(y.operations[o].attribute==="deleteTicketEvalute"){a=true;r=true}else if(y.operations[o].attribute!="noticeEvaluate"&&y.operations[o].attribute!="mailto_user"&&y.operations[o].attribute!="mailto_service_desk"&&y.operations[o].attribute!="addCC"){if(y.operations[o].value&&y.operations[o].attribute!=0){a=true;r=true}else{if(y.operations[o].engineer){if(y.operations[o].engineerDesk){y.operations[o].value=y.operations[o].engineerDesk.id+"_"+y.operations[o].engineer.id}else{y.operations[o].value=y.operations[o].engineer.id}a=true;r=true}else{a=false;break}}}}if(!e){k.add("请填写程序名称","danger")}else if(t&&i&&n&&s&&a&&r&&e){var d=angular.copy(y.triggerTask.andConditions);var p=angular.copy(y.triggerTask.orConditions);var f=angular.copy(y.triggerTask.operations);y.triggerTask.andConditions=[];y.triggerTask.orConditions=[];y.triggerTask.operations=[];for(var o=0;o<y.andConditions.length;o++){t=true;var m={};m.orderKey=y.andConditions[o].orderKey;m.attribute=y.andConditions[o].attribute;m.compare=y.andConditions[o].compare;m.tally=y.andConditions[o].tally;if(typeof y.andConditions[o].value=="object"){if(y.andConditions[o].attribute.indexOf("ticketcustomfield")>=0){if(y.andConditions[o].attribute.indexOf("ticketcustomfield_date")>=0){m.value=C("date")(y.andConditions[o].value,"yyyy/MM/dd").toString()}else{m.value=y.andConditions[o].value}}else if(y.andConditions[o].attribute=="via"){m.value=JSON.stringify(y.andConditions[o].value)}else{if(m.compare==="$in"||m.compare==="$not_in"){if(m.attribute==="userGroup"){m.value=y.andConditions[o].value}else if(m.attribute==="serviceDesk"){m.value=y.andConditions[o].value.id}else{m.value="service_catalog_and_children_id_"+y.andConditions[o].value.id}}else{m.value=y.andConditions[o].value.id}}}else{if(y.andConditions[o].attribute.indexOf("ticketcustomfield_checkbox")>=0){m.value="true"}else{if(m.compare==="$in"||m.compare==="$not_in"){if(m.attribute==="serviceCatalog"){m.value="service_catalog_and_children_id_"+y.andConditions[o].value}else if(m.attribute==="userGroup"){m.value=y.andConditions[o].value}else if(m.attribute==="serviceDesk"){m.value=y.andConditions[o].value}else{m.value=b.run(y.andConditions[o].value,m.compare)}}else{m.value=y.andConditions[o].value}}}y.triggerTask.andConditions.push(m)}for(var o=0;o<y.orConditions.length;o++){var g={};g.orderKey=y.orConditions[o].orderKey;g.attribute=y.orConditions[o].attribute;g.compare=y.orConditions[o].compare;g.tally=y.orConditions[o].tally;if(typeof y.orConditions[o].value=="object"){if(y.orConditions[o].attribute.indexOf("ticketcustomfield")>=0){if(y.orConditions[o].attribute.indexOf("ticketcustomfield_date")>=0){g.value=C("date")(y.orConditions[o].value,"yyyy/MM/dd").toString()}else{g.value=y.orConditions[o].value}}else if(y.orConditions[o].attribute=="via"){g.value=JSON.stringify(y.orConditions[o].value)}else{if(g.compare==="$in"||g.compare==="$not_in"){if(g.attribute==="userGroup"){g.value=y.orConditions[o].value}else if(g.attribute==="serviceDesk"){g.value=y.orConditions[o].value.id}else{g.value="service_catalog_and_children_id_"+y.orConditions[o].value.id}}else{g.value=y.orConditions[o].value.id}}}else{if(y.orConditions[o].attribute.indexOf("ticketcustomfield_checkbox")>=0){g.value="true"}else{if(g.compare==="$in"||g.compare==="$not_in"){if(g.attribute==="serviceCatalog"){g.value="service_catalog_and_children_id_"+y.orConditions[o].value}else if(g.attribute==="userGroup"){g.value=y.orConditions[o].value}else if(g.attribute==="serviceDesk"){g.value=y.orConditions[o].value}else{g.value=b.run(y.orConditions[o].value,g.compare)}}else{g.value=y.orConditions[o].value}}}y.triggerTask.orConditions.push(g)}for(var o=0;o<y.operations.length;o++){var v={};v.value={};if(y.operations[o].attribute!="noticeEvaluate"){v.orderKey=y.operations[o].orderKey;if(y.operations[o].attribute=="mailto_user"||y.operations[o].attribute=="mailto_service_desk"){v.operate=y.operations[o].attribute;v.value=y.operations[o].value}else{v.attribute=y.operations[o].attribute}if(typeof y.operations[o].value=="object"){if(y.operations[o].attribute=="addCC"||y.operations[o].attribute=="ticket_comment"){v.value=y.operations[o].value;if(y.operations[o].attribute=="ticket_comment"&&y.operations[o].value.open==null){v.value.open=true}if(y.operations[o].attribute=="ticket_comment"){v.value=JSON.stringify(y.operations[o].value)}}else if(y.operations[o].attribute!="mailto_service_desk"&&y.operations[o].attribute!="mailto_user"){v.value=y.operations[o].value.id}else{v.value=JSON.stringify(y.operations[o].value)}}else if(y.operations[o].attribute=="deleteTicket"){if(y.operations[o].value==="其他原因"){v.value=y.operations[o].reason}else{v.value=y.operations[o].value}}else if(y.operations[o].attribute!="mailto_service_desk"&&y.operations[o].attribute!="mailto_user"){v.value=y.operations[o].value}}else{v.orderKey=y.operations[o].orderKey;v.operate=y.operations[o].attribute}y.triggerTask.operations.push(v)}y.isClick=true;var h;y.triggerTask.permissions=[];angular.forEach(y.fieldPermissions,function(e){role={};role.roleId=e.id;role.scanAble=e.scanAble;role.editAble=e.editAble;y.triggerTask.permissions.push(role)});if(_.type=="add"||_.type=="copy"){h={ticketTrigger:y.triggerTask};org.ewei.sdk.OpenTicketTriggerApi().save(h).then({success:function(e){P(e)},fail:function(e){x(e)}})}else{h={ticketTrigger:y.triggerTask,id:y.triggerTask.id};org.ewei.sdk.OpenTicketTriggerApi().update(h).then({success:function(e){P(e)},fail:function(e){x(e)}})}}else if(!i||!s||!r){void 0;void 0;k.add("请把信息填写完整","danger")}else if(!t||!n||!a){k.add("信息填写错误","danger")}}};function P(){k.add("更新成功");y.backTrigger();y.isClick=false}function x(e){y.isClick=false;if(e.error!=null){k.add(C("translate")(e.error_description),"danger")}else{k.add("更新失败","danger")}for(var t=0;t<y.andConditions.length;t++){if(y.andConditions[t].attribute=="engineer"){delete y.andConditions[t]["value"]}}for(var t=0;t<y.orConditions.length;t++){if(y.orConditions[t].attribute=="engineer"){delete y.orConditions[t]["value"]}}for(var t=0;t<y.operations.length;t++){if(y.operations[t].attribute=="engineer"){delete y.operations[t]["value"]}}}y.saveTriggerTaskDefault=function(e){var t=parseInt(automation.tempValue==null?0:automation.tempValue);if((automation.type=="chat"||automation.type=="weixin_chat")&&(t<8||t>2880)){k.add("自动结束会话时间在8-2880分钟之间","danger");return}else if(automation.type=="ticket"&&(t<8||t>120)){k.add("自动关闭工单在8-120小时之间","danger");return}s({url:"automation.json",method:"POST",data:e}).success(function(e){userAginLogin(e);if(e.success){k.add("更新成功");y.backAutomation()}else{k.add("更新失败","danger")}})};y.checkCharCount=function(e){var t=$(e);if(t.val()!=null&&t.val()!=""){if(t.val().length>=t.attr("maxlength")){k.add(t.prev().text()+"不能超过"+t.attr("maxlength")+"个字符","danger")}}}}])})(org.ewei);angular.module("eweiApp.chart").controller("performanceController",["$rootScope","$scope","$http","$filter","$location","$state","ConsoleConfig",function(e,i,t,n,s,a,r){if(a.current.name=="chart.performance"){a.go("chart.performance.number")}i.provider_id=r.provider.id;i._token=getCookie("user_token");i.$on("transfer.numberData",function(e,t){i.sumNewNum=t.newNum;i.sumEndNum=t.endNum;i.sumPaddingNum=t.paddingNum;i.sumOpenNum=t.openNum});i.$on("transfer.rponseTimeData",function(e,t){i.avgResponseTime=t.avgResponseTime;i.avgHandleTime=t.avgHandleTime;i.solvedRateNum=t.solvedRateNum;i.evaluateRate=t.evaluateRate;i.avgSlaRate=t.avgSlaRate;i.avgResolveSlaRate=t.avgResolveSlaRate;i.avgResponseSlaRate=t.avgResponseSlaRate});var o=2;if(angular.isDefined(e.chartSelectTime)){o=e.chartSelectTime.id}if(o==1||o==2||o==3){var l=new Date;var c=n("date")(l,"yyyy/MM/dd 23:59:59");if(o==1){l.setMonth(l.getMonth()-1)}else if(o==2){l.setDate(l.getDate()-7)}else if(o==3){l.setDate(l.getDate()-1)}i.advancedQueryCondition={startDate:n("date")(l,"yyyy/MM/dd 00:00:00"),endDate:c,chartSelectTimeType:o}}else{var u=e.chartSelectedDate.begin;var d=e.chartSelectedDate.end;if(u.length==10){u+=" 00:00:00"}if(d.length==10){d+=" 23:59:59"}i.advancedQueryCondition={startDate:u,endDate:d,chartSelectTimeType:o}}}]).controller("performanceNumberController",["$rootScope","$scope","$state","$stateParams","$http","$filter","chartService","ngTableParams","alertService","$timeout","$location","$anchorScroll","ConsoleConfig","ticketEvaluateService","serviceCatalogNameService","reportCountTicketNumberService","reportTicketChartsCountService",function(r,g,t,e,i,o,l,n,c,u,v,h,d,s,a,p,f){r.chartStateCurrentName=t.current.name;g.view={};if(g.advancedQueryCondition.ticketMetric&&g.advancedQueryCondition.ticketMetric.sla){g.advancedQueryCondition.ticketMetric.sla={}}if(g.advancedQueryCondition.ticketMetric&&g.advancedQueryCondition.ticketMetric.responseAt){g.advancedQueryCondition.ticketMetric.responseAt=""}var y={$and:[{$ge:{"ticketMetric.solvedAt":g.advancedQueryCondition.startDate.replace(/\//g,"-")}},{$lt:{"ticketMetric.solvedAt":g.advancedQueryCondition.endDate.replace(/\//g,"-")}}]};g.isLoad=true;g.loadTicketNumberChart=function(){g.ticketNumberChart=ECharts.Charts.InitChart("chart_performance");var m=function(){var e=g.advancedQueryCondition.chartSelectTimeType;if(!g.advancedQueryCondition.startDate||g.advancedQueryCondition.startDate=="undefined"){c.add("查询起始时间为空","danger")}if(!g.advancedQueryCondition.endDate&&g.advancedQueryCondition.endDate=="undefined"){c.add("查询结束时间为空","danger")}var t=new Date(g.advancedQueryCondition.startDate);var i=new Date(g.advancedQueryCondition.endDate);var n=[];while(t<=i){var s=t.getMonth()+1;if(s<10){s="0"+s}var a=t.getDate();if(a<10){a="0"+a}n.push(t.getFullYear()+"-"+s+"-"+a);t.setDate(t.getDate()+1)}return n};p.run({provider_id:g.provider_id,_token:g._token},g.advancedQueryCondition,false,function(e){var t=[];var i=0;var n=0;var s=0;var a=0;var r=30;if(e.result.length>0){if(e.result.length<r){var o=m();for(var l=0;l<o.length;l++){var c=false;var u={};u.name=o[l];u.value=0;u.group="新建工单";var d={};d.name=o[l];d.value=0;d.group="处理完成工单";for(var p=0;p<e.result.length;p++){if(o[l]==e.result[p].name){c=true;t.push(e.result[p])}if(l==0){if("新建工单"==e.result[p].group){i=parseInt(i)+parseInt(e.result[p].value)}else if("暂停工单"==e.result[p].group){a=parseInt(a)+parseInt(e.result[p].value)}else if("处理中的工单"==e.result[p].group){s=parseInt(s)+parseInt(e.result[p].value)}else{n=parseInt(n)+parseInt(e.result[p].value)}}}if(!c){t.push(u);t.push(d)}}}else{for(var p=0;p<e.result.length;p++){if("新建工单"==e.result[p].group){i=parseInt(i)+parseInt(e.result[p].value);t.push(e.result[p])}else if("暂停工单"==e.result[p].group){a=parseInt(a)+parseInt(e.result[p].value)}else if("处理中的工单"==e.result[p].group){s=parseInt(s)+parseInt(e.result[p].value)}else{n=parseInt(n)+parseInt(e.result[p].value);t.push(e.result[p])}}t.sort(function(e,t){return Date.parse(e.name)-Date.parse(t.name)})}}g.ticketNumberChart=ECharts.Charts.RenderChart("line","chart_performance",t,"",r,g.ticketNumberChart);g.$emit("transfer.numberData",{newNum:i,endNum:n,paddingNum:a,openNum:s});var f={};g.ticketNumberChart.on(echarts.config.EVENT.CLICK,function(e){var t=e.name;var i=new Date(e.name).getTime();var n=i+24*60*60*1e3;var s=new Date(n);var a=s.getMonth()+1;var r=s.getDate();a=a<10?"0"+a:a;r=r<10?"0"+r:r;if(e.seriesName=="新建工单"){f={$and:[{$ge:{createdAt:t+" 00:00:00"}},{$lt:{createdAt:s.getFullYear()+"-"+a+"-"+r+" 00:00:00"}}]}}else if(e.seriesName=="处理完成工单"){f={$and:[{$ge:{"ticketMetric.solvedAt":t+" 00:00:00"}},{$lt:{"ticketMetric.solvedAt":s.getFullYear()+"-"+a+"-"+r+" 00:00:00"}}]}}g.tableParamsTitle=e.seriesName+"("+e.name+")";g.isLoad=false;y=f;g.tableParams.reload();v.hash("tableParams");h()})})};g.$on("downLoadPerformanceNumber",function(e,t){if(t&&t.downLoadType==2){}else{var i="/api/export_performance_chart?_filter="+JSON.stringify(y)+"&provider_id="+d.provider.id+"&_token="+g._token+"&downLoadType="+t.downLoadType+"&advancedQueryCondition="+JSON.stringify(g.advancedQueryCondition)+"&engineerId="+d.engineer.id+"&userId="+d.user.id+"&columns="+encodeURIComponent(JSON.stringify(t.columns));window.open(i)}});g.ticketDetail=function(e){t.go("tickets_detail",{id:e})};var m=function(e,t){for(var i in e){if(e[i]==t){return i}return""}};var _={};var k={};var C={};var b={};if(localStorage){try{_=angular.fromJson(localStorage["systemFieldPriority"]);k=angular.fromJson(localStorage["systemFieldServiceCatalog"]);C=angular.fromJson(localStorage["systemFieldTicketType"]);b=JSON.parse(localStorage["systemFieldSubject"])}catch(e){}}var w=function(){s.run(false,function(e){g.evaluate={solveds:[],scores:[]};g.evaluate.solveds=e.firstQuestionOptions;g.evaluate.scores=e.secondQuestionOptions})};w();g.columns=[];if(g.currentTicketPage==undefined){g.currentTicketPage=1}g.clearSorting=function(){g.tableParams.sorting(JSON.parse('{"'+g.view.orderBy+'":"'+g.view.order+'"}'));g.defaultSorting=true};g.defaultSorting=false;g.$on("reloadPerformanceNumber",function(e,t){g.tableParamsTitle="";p.clearCache();f.clearCache();l.clearCache();g.advancedQueryCondition.startDate=t.begin;g.advancedQueryCondition.endDate=t.end;g.advancedQueryCondition.serviceDeskId=t.serviceDeskId;g.advancedQueryCondition.serviceDeskName=t.serviceDeskName;g.advancedQueryCondition.engineerId=t.engineerId;g.advancedQueryCondition.engineerName=t.engineerName;g.advancedQueryCondition.responseChecked=t.responseChecked;g.advancedQueryCondition.handleChecked=t.handleChecked;g.advancedQueryCondition.createChecked=t.createChecked;g.advancedQueryCondition.finishChecked=t.finishChecked;g.advancedQueryCondition.reviewChecked=t.reviewChecked;g.advancedQueryCondition.chartSelectTimeType=r.chartSelectTime.id;y={$and:[{$ge:{"ticketMetric.solvedAt":t.begin.replace(/\//g,"-")}},{$lt:{"ticketMetric.solvedAt":t.end.replace(/\//g,"-")}}]};g.isLoad=true;g.tableParams.page(1);g.tableParams.reload()});g.defaultSorting=true;g.clearSearch=function(){if(g.searchKey!=null||g.isAdvancedQuery){y={$and:[{$ge:{"ticketMetric.solvedAt":g.advancedQueryCondition.startDate.replace(/\//g,"-")}},{$lt:{"ticketMetric.solvedAt":g.advancedQueryCondition.endDate.replace(/\//g,"-")}}]};g.searchKey=null;g.oldSearchKey=null;g.isAdvancedQuery=false;g.searchType=null;g.advancedQueryCondition={};if(r.currentTicketPage!=1){g.tableParams.page(1)}else{g.tableParams.reload()}}};g.search=function(e){if(g.searchKey==""){g.clearSearch()}else{if(e!=g.oldSearchKey){g.oldSearchKey=e;g.searchType="searchKeyQuery";if(r.currentTicketPage!=1){g.tableParams.page(1)}else{g.tableParams.reload()}}}};a.run("",{},false,function(e){if(e.status==0&&e.result){g.servicecatalogs=e.result}});g.columnType="ticket";g.setRows=function(e){var t=g.tableParams.count();if(e==t)return;g.tableParams.count(e);g.tableParams.getData(g.tableParams)};g.tableParams=new n({page:g.currentTicketPage,count:20,sorting:JSON.parse('{"'+g.view.orderBy+'":"'+g.view.order+'"}')},{$scope:g,counts:[],groupBy:function(e){},total:0,getData:function(i,n){var s=m(n.sorting(),"asc");var a=m(n.sorting(),"desc");l.run({_page:n.page(),_count:n.count(),_fields:g.view.fields,_filter:y,_asc:s,_desc:a,searchType:g.searchType,advancedQueryCondition:g.advancedQueryCondition,searchKey:g.searchKey,engineerId:d.engineer.id,userId:d.user.id,provider_id:d.provider.id,_token:getCookie("user_token")},{},false,function(t){if(t.result==undefined||t.result.tickets==undefined||t.result.tickets.length==0){}u(function(){g.currentTicketPage=n.page();n.total(t.result._total);g.view.count=t.result._total;if(g.view.order=="asc"&&g.view.orderBy!=s){g.defaultSorting=false}else if(g.view.order=="desc"&&g.view.orderBy!=a){g.defaultSorting=false}var e=n.sorting()?o("orderBy")(t.result.tickets,n.orderBy()):t.result.tickets;i.resolve(e);g.showCheckboxes=false;g.tickets=e;r.$broadcast("loadCustomerData",g.tickets);if(g.isLoad){g.loadTicketNumberChart()}},100)})}})}]).controller("performanceRponseTimeController",["$rootScope","$scope","$state","$stateParams","$http","$filter","chartService","ngTableParams","alertService","$timeout","$location","$anchorScroll","ConsoleConfig","ticketEvaluateService","serviceCatalogNameService","reportTicketChartsCountService","reportCountTicketNumberService",function(r,D,t,e,i,o,l,n,s,c,P,x,u,a,d,p,f){r.chartStateCurrentName=t.current.name;if(D.advancedQueryCondition.ticketMetric&&D.advancedQueryCondition.ticketMetric.sla){D.advancedQueryCondition.ticketMetric.sla={}}if(D.advancedQueryCondition.ticketMetric&&D.advancedQueryCondition.ticketMetric.responseAt){D.advancedQueryCondition.ticketMetric.responseAt=""}D.view={};var N={$and:[{$ge:{"ticketMetric.solvedAt":D.advancedQueryCondition.startDate.replace(/\//g,"-")}},{$lt:{"ticketMetric.solvedAt":D.advancedQueryCondition.endDate.replace(/\//g,"-")}}]};D.isLoad=true;var m=function(){a.run(false,function(e){D.evaluate={solveds:[],scores:[]};D.evaluate.solveds=e.firstQuestionOptions;D.evaluate.scores=e.secondQuestionOptions})};m();D.loadTicketChartsCount=function(){D.picture_response=ECharts.Charts.InitChart("chart_response");D.picture_handle=ECharts.Charts.InitChart("chart_handle");D.picture_solvedRate=ECharts.Charts.InitChart("chart_solved_rate");D.picture_evaluate=ECharts.Charts.InitChart("chart_evaluate");D.picture_isEvaluate=ECharts.Charts.InitChart("chart_isEvaluate");D.picture_SLARate=ECharts.Charts.InitChart("chart_SLARate");p.run({provider_id:u.provider.id,_token:getCookie("user_token"),_filter:N,searchType:D.searchType,advancedQueryCondition:D.advancedQueryCondition,searchKey:D.searchKey,engineerId:u.engineer.id,userId:u.user.id,provider_id:u.provider.id},{},false,function(e){if(e.result==undefined||e.result==null){}var t=[];var i=[];var n=[];var s=[];var a=[];var r=[];var o=0;var l=["1H","4H","8H","24H","48H","72H+"];if(e.result.responseTimeList!=null&&e.result.responseTimeList.length>0){var c=e.result.responseTimeList.length;var u=0;var d=0;for(var p=0;p<l.length;p++){var f={};f.name=l[p];f.value=0;for(var m=0;m<c;m++){if(l[p]==e.result.responseTimeList[m].name){f.value=e.result.responseTimeList[m].value}if(p==0){if(e.result.responseTimeList[m].value!=null&&e.result.responseTimeList[m].value!="undefined"){u=parseInt(u)+parseInt(e.result.responseTimeList[m].value)}if(e.result.responseTimeList[m].sumTime!=null&&e.result.responseTimeList[m].sumTime!="undefined"){d=parseInt(d)+parseInt(e.result.responseTimeList[m].sumTime)}}}f.group="工单数量(个)";t.push(f)}if(u!=0){o=(d/(u*60)).toFixed(2)}}var g=0;var v=["1D","2D","3D","4D","5D","6D","7D+"];if(e.result.handleTimeList!=null&&e.result.handleTimeList.length>0){var c=e.result.handleTimeList.length;var d=0;var u=0;for(var p=0;p<v.length;p++){var h={};h.name=v[p];h.value=0;for(var m=0;m<c;m++){if(v[p]==e.result.handleTimeList[m].name){h.value=e.result.handleTimeList[m].value}if(p==0){if(e.result.handleTimeList[m].sumTime!=null&&e.result.handleTimeList[m].sumTime!="undefined"){d=parseInt(d)+parseInt(e.result.handleTimeList[m].sumTime)}if(e.result.handleTimeList[m].value!=null&&e.result.handleTimeList[m].value!="undefined"){u=parseInt(u)+parseInt(e.result.handleTimeList[m].value)}}}h.group="工单数量(个)";i.push(h)}if(u!=0){g=(d/(u*60*24)).toFixed(2)}}var y=0;var _=0;var k=0;var C=angular.copy(e.result.resolveSLARateList);var b=angular.copy(e.result.responseSLARateList);if(C!=null&&C.length>0){var w=C.splice(0,1);_=w[0].value}if(b!=null&&b.length>0){var w=b.splice(0,1);k=w[0].value}if(e.result.SLARateList!=null&&e.result.SLARateList.length>0){n=b.concat(C);var w=e.result.SLARateList;y=w[0].value}var T=0;if(e.result.solvedRateList!=null&&e.result.solvedRateList.length>0){s=e.result.solvedRateList;var S=0;var F=0;for(var p=0;p<e.result.solvedRateList.length;p++){if(e.result.solvedRateList[p].flag){S=parseInt(S)+parseInt(e.result.solvedRateList[p].value)}F=parseInt(F)+parseInt(e.result.solvedRateList[p].value)}if(F!=0){T=(S*100/F).toFixed(0)}}var A=0;if(e.result.evaluateList!=null&&e.result.evaluateList.length>0){a=e.result.evaluateList;var E=0;var $=0;for(var p=0;p<e.result.evaluateList.length;p++){if(0!=e.result.evaluateList[p].flag){E=parseInt(E)+parseInt(e.result.evaluateList[p].value)}$=parseInt($)+parseInt(e.result.evaluateList[p].value)}A=(E*100/$).toFixed(0)}if(e.result.isEvaluateList!=null){r=e.result.isEvaluateList}if(isNaN(A)){A=0}D.picture_response=ECharts.Charts.RenderChart("bar","chart_response",t,"平均响应时长"+o+"小时",null,D.picture_response);D.picture_handle=ECharts.Charts.RenderChart("bar","chart_handle",i,"平均处理时长"+g+"天",null,D.picture_handle);D.picture_solvedRate=ECharts.Charts.RenderChart("pie","chart_solved_rate",s,"解决率"+T+"%",null,D.picture_solvedRate);D.picture_evaluate=ECharts.Charts.RenderChart("pie","chart_evaluate",a,"满意度"+A+"%",null,D.picture_evaluate);D.picture_isEvaluate=ECharts.Charts.RenderChart("pie","chart_isEvaluate",r,"是否评价",null,D.picture_isEvaluate);D.picture_SLARate=ECharts.Charts.RenderChart("line","chart_SLARate",n,"SLA达标率"+y+"%",null,D.picture_SLARate);D.$emit("transfer.rponseTimeData",{avgResponseTime:o,avgHandleTime:g,solvedRateNum:T,evaluateRate:A,avgSlaRate:y,avgResolveSlaRate:_,avgResponseSlaRate:k});D.allPictrue=[D.picture_response,D.picture_handle,D.picture_solvedRate,D.picture_evaluate,D.picture_isEvaluate,D.picture_SLARate];var O={};var I="工单响应时长";var L="工单处理时长";D.allPictrue.forEach(function(e){e&&e.on(echarts.config.EVENT.CLICK,function(e){var t={"1H":{$and:[{$ge:{"ticketMetric.solvedAt":D.advancedQueryCondition.startDate.replace(/\//g,"-")}},{$lt:{"ticketMetric.solvedAt":D.advancedQueryCondition.endDate.replace(/\//g,"-")}},{$le:{"ticketMetric.responseMinutes":60}}]},"4H":{$and:[{$ge:{"ticketMetric.solvedAt":D.advancedQueryCondition.startDate.replace(/\//g,"-")}},{$lt:{"ticketMetric.solvedAt":D.advancedQueryCondition.endDate.replace(/\//g,"-")}},{$le:{"ticketMetric.responseMinutes":240}},{$gt:{"ticketMetric.responseMinutes":60}}]},"8H":{$and:[{$ge:{"ticketMetric.solvedAt":D.advancedQueryCondition.startDate.replace(/\//g,"-")}},{$lt:{"ticketMetric.solvedAt":D.advancedQueryCondition.endDate.replace(/\//g,"-")}},{$le:{"ticketMetric.responseMinutes":480}},{$gt:{"ticketMetric.responseMinutes":240}}]},"24H":{$and:[{$ge:{"ticketMetric.solvedAt":D.advancedQueryCondition.startDate.replace(/\//g,"-")}},{$lt:{"ticketMetric.solvedAt":D.advancedQueryCondition.endDate.replace(/\//g,"-")}},{$le:{"ticketMetric.responseMinutes":1440}},{$gt:{"ticketMetric.responseMinutes":480}}]},"48H":{$and:[{$ge:{"ticketMetric.solvedAt":D.advancedQueryCondition.startDate.replace(/\//g,"-")}},{$lt:{"ticketMetric.solvedAt":D.advancedQueryCondition.endDate.replace(/\//g,"-")}},{$le:{"ticketMetric.responseMinutes":2880}},{$gt:{"ticketMetric.responseMinutes":1440}}]},"72H+":{$and:[{$ge:{"ticketMetric.solvedAt":D.advancedQueryCondition.startDate.replace(/\//g,"-")}},{$lt:{"ticketMetric.solvedAt":D.advancedQueryCondition.endDate.replace(/\//g,"-")}},{$gt:{"ticketMetric.responseMinutes":2880}}]},"1D":{$and:[{$ge:{"ticketMetric.solvedAt":D.advancedQueryCondition.startDate.replace(/\//g,"-")}},{$lt:{"ticketMetric.solvedAt":D.advancedQueryCondition.endDate.replace(/\//g,"-")}},{$le:{"ticketMetric.solveMinutes":1440}}]},"2D":{$and:[{$ge:{"ticketMetric.solvedAt":D.advancedQueryCondition.startDate.replace(/\//g,"-")}},{$lt:{"ticketMetric.solvedAt":D.advancedQueryCondition.endDate.replace(/\//g,"-")}},{$le:{"ticketMetric.solveMinutes":2880}},{$gt:{"ticketMetric.solveMinutes":1440}}]},"3D":{$and:[{$ge:{"ticketMetric.solvedAt":D.advancedQueryCondition.startDate.replace(/\//g,"-")}},{$lt:{"ticketMetric.solvedAt":D.advancedQueryCondition.endDate.replace(/\//g,"-")}},{$le:{"ticketMetric.solveMinutes":4320}},{$gt:{"ticketMetric.solveMinutes":2880}}]},"4D":{$and:[{$ge:{"ticketMetric.solvedAt":D.advancedQueryCondition.startDate.replace(/\//g,"-")}},{$lt:{"ticketMetric.solvedAt":D.advancedQueryCondition.endDate.replace(/\//g,"-")}},{$le:{"ticketMetric.solveMinutes":5760}},{$gt:{"ticketMetric.solveMinutes":4320}}]},"5D":{$and:[{$ge:{"ticketMetric.solvedAt":D.advancedQueryCondition.startDate.replace(/\//g,"-")}},{$lt:{"ticketMetric.solvedAt":D.advancedQueryCondition.endDate.replace(/\//g,"-")}},{$le:{"ticketMetric.solveMinutes":7200}},{$gt:{"ticketMetric.solveMinutes":5760}}]},"6D":{$and:[{$ge:{"ticketMetric.solvedAt":D.advancedQueryCondition.startDate.replace(/\//g,"-")}},{$lt:{"ticketMetric.solvedAt":D.advancedQueryCondition.endDate.replace(/\//g,"-")}},{$le:{"ticketMetric.solveMinutes":8640}},{$gt:{"ticketMetric.solveMinutes":7200}}]},"7D":{$and:[{$ge:{"ticketMetric.solvedAt":D.advancedQueryCondition.startDate.replace(/\//g,"-")}},{$lt:{"ticketMetric.solvedAt":D.advancedQueryCondition.endDate.replace(/\//g,"-")}},{$gt:{"ticketMetric.solveMinutes":8640}}]},"已评价":{$and:[{$ge:{"ticketMetric.solvedAt":D.advancedQueryCondition.startDate.replace(/\//g,"-")}},{$lt:{"ticketMetric.solvedAt":D.advancedQueryCondition.endDate.replace(/\//g,"-")}},{$eq:{"evaluate.system":false}}]},"未评价":{$and:[{$ge:{"ticketMetric.solvedAt":D.advancedQueryCondition.startDate.replace(/\//g,"-")}},{$lt:{"ticketMetric.solvedAt":D.advancedQueryCondition.endDate.replace(/\//g,"-")}},{$eq:{"evaluate.system":true}}]},"响应SLA达标率(%)":{$and:[{$ge:{"ticketMetric.solvedAt":D.advancedQueryCondition.startDate.replace(/\//g,"-")}},{$lt:{"ticketMetric.solvedAt":D.advancedQueryCondition.endDate.replace(/\//g,"-")}},{$eq:{"ticketMetric.sla.name":e.name}},{$is_not_null:["ticketMetric.responseAt"]}]},"处理SLA达标率(%)":{$and:[{$ge:{"ticketMetric.solvedAt":D.advancedQueryCondition.startDate.replace(/\//g,"-")}},{$lt:{"ticketMetric.solvedAt":D.advancedQueryCondition.endDate.replace(/\//g,"-")}},{$eq:{"ticketMetric.sla.name":e.name}},{$or:[{$eq:{status:"solved"}},{$eq:{status:"closed"}}]}]}};t[D.evaluate.solveds[0].name]={$and:[{$ge:{"ticketMetric.solvedAt":D.advancedQueryCondition.startDate.replace(/\//g,"-")}},{$lt:{"ticketMetric.solvedAt":D.advancedQueryCondition.endDate.replace(/\//g,"-")}},{$eq:{"evaluate.solved":true}}]};t[D.evaluate.solveds[1].name]={$and:[{$ge:{"ticketMetric.solvedAt":D.advancedQueryCondition.startDate.replace(/\//g,"-")}},{$lt:{"ticketMetric.solvedAt":D.advancedQueryCondition.endDate.replace(/\//g,"-")}},{$eq:{"evaluate.solved":false}}]};t[D.evaluate.scores[0].name]={$and:[{$ge:{"ticketMetric.solvedAt":D.advancedQueryCondition.startDate.replace(/\//g,"-")}},{$lt:{"ticketMetric.solvedAt":D.advancedQueryCondition.endDate.replace(/\//g,"-")}},{$eq:{"evaluate.score":"2"}}]};t[D.evaluate.scores[1].name]={$and:[{$ge:{"ticketMetric.solvedAt":D.advancedQueryCondition.startDate.replace(/\//g,"-")}},{$lt:{"ticketMetric.solvedAt":D.advancedQueryCondition.endDate.replace(/\//g,"-")}},{$eq:{"evaluate.score":"1"}}]};t[D.evaluate.scores[2].name]={$and:[{$ge:{"ticketMetric.solvedAt":D.advancedQueryCondition.startDate.replace(/\//g,"-")}},{$lt:{"ticketMetric.solvedAt":D.advancedQueryCondition.endDate.replace(/\//g,"-")}},{$eq:{"evaluate.score":"0"}}]};if(t[e.name]){O=t[e.name]}if(e.seriesName=="响应SLA达标率(%)"){O=t["响应SLA达标率(%)"];if(!D.advancedQueryCondition.ticketMetric){D.advancedQueryCondition.ticketMetric={sla:{name:""},responseAt:""}}D.advancedQueryCondition.ticketMetric.sla.name=e.name;D.advancedQueryCondition.ticketMetric.responseAt="is_not_null"}else if(e.seriesName=="处理SLA达标率(%)"){O=t["处理SLA达标率(%)"];if(!D.advancedQueryCondition.ticketMetric){D.advancedQueryCondition.ticketMetric={sla:{name:""}}}D.advancedQueryCondition.ticketMetric.sla.name=e.name}if(e.name.indexOf("H")>-1){D.tableParamsTitle=I+"("+e.name+")"}else if(e.name.indexOf("D")>-1){D.tableParamsTitle=L+"("+e.name+")"}else if(e.seriesName=="SLA达标率(%)"){D.tableParamsTitle=e.seriesName+":"+e.value+"("+e.name+")"}else{D.tableParamsTitle=e.seriesName+"("+e.name+")"}D.isLoad=false;N=O;D.tableParams.reload();P.hash("tableParams");x()})})})};D.$on("downLoadPerformanceResponse",function(e,t){if(t&&t.downLoadType==2){}else{var i="/api/export_performance_chart?_filter="+JSON.stringify(N)+"&provider_id="+u.provider.id+"&_token="+D._token+"&downLoadType="+t.downLoadType+"&advancedQueryCondition="+JSON.stringify(D.advancedQueryCondition)+"&engineerId="+u.engineer.id+"&userId="+u.user.id+"&columns="+encodeURIComponent(JSON.stringify(t.columns));window.open(i)}});D.ticketDetail=function(e){t.go("tickets_detail",{id:e})};var g=function(e,t){for(var i in e){if(e[i]==t){return i}return""}};var v={};var h={};var y={};var _={};if(localStorage){try{v=angular.fromJson(localStorage["systemFieldPriority"]);h=angular.fromJson(localStorage["systemFieldServiceCatalog"]);y=angular.fromJson(localStorage["systemFieldTicketType"]);_=JSON.parse(localStorage["systemFieldSubject"])}catch(e){}}d.run("",{},false,function(e){if(e.success){D.servicecatalogs=e.json}});if(D.currentTicketPage==undefined){D.currentTicketPage=1}D.clearSorting=function(){D.tableParams.sorting(JSON.parse('{"'+D.view.orderBy+'":"'+D.view.order+'"}'));D.defaultSorting=true};D.defaultSorting=false;D.$on("reloadPerformanceRponseTime",function(e,t){f.clearCache();p.clearCache();l.clearCache();D.advancedQueryCondition.startDate=t.begin;D.advancedQueryCondition.endDate=t.end;D.advancedQueryCondition.serviceDeskId=t.serviceDeskId;D.advancedQueryCondition.serviceDeskName=t.serviceDeskName;D.advancedQueryCondition.engineerName=t.engineerName;D.advancedQueryCondition.engineerId=t.engineerId;D.advancedQueryCondition.responseChecked=t.responseChecked;D.advancedQueryCondition.handleChecked=t.handleChecked;D.advancedQueryCondition.createChecked=t.createChecked;D.advancedQueryCondition.finishChecked=t.finishChecked;D.advancedQueryCondition.reviewChecked=t.reviewChecked;N={$and:[{$ge:{"ticketMetric.solvedAt":t.begin.replace(/\//g,"-")}},{$lt:{"ticketMetric.solvedAt":t.end.replace(/\//g,"-")}}]};D.isLoad=true;D.tableParams.page(1);D.tableParams.reload()});D.defaultSorting=true;D.clearSearch=function(){if(D.searchKey!=null||D.isAdvancedQuery){N={$and:[{$ge:{"ticketMetric.solvedAt":D.advancedQueryCondition.startDate.replace(/\//g,"-")}},{$lt:{"ticketMetric.solvedAt":D.advancedQueryCondition.endDate.replace(/\//g,"-")}}]};D.searchKey=null;D.oldSearchKey=null;D.isAdvancedQuery=false;D.searchType=null;D.advancedQueryCondition={};if(r.currentTicketPage!=1){D.tableParams.page(1)}else{D.tableParams.reload()}}};D.search=function(e){if(D.searchKey==""){D.clearSearch()}else{if(e!=D.oldSearchKey){D.oldSearchKey=e;D.searchType="searchKeyQuery";if(r.currentTicketPage!=1){D.tableParams.page(1)}else{D.tableParams.reload()}}}};D.columnType="ticket";D.setRows=function(e){var t=D.tableParams.count();if(e==t)return;D.tableParams.count(e);D.tableParams.page(D.currentTicketPage);D.tableParams.getData(D.tableParams)};D.tableParams=new n({page:D.currentTicketPage,count:20,sorting:JSON.parse('{"'+D.view.orderBy+'":"'+D.view.order+'"}')},{$scope:D,counts:[],groupBy:function(e){},total:0,getData:function(i,n){var s=g(n.sorting(),"asc");var a=g(n.sorting(),"desc");l.run({_page:n.page(),_count:n.count(),_fields:D.view.fields,_filter:N,_asc:s,_desc:a,searchType:D.searchType,advancedQueryCondition:D.advancedQueryCondition,searchKey:D.searchKey,engineerId:u.engineer.id,userId:u.user.id,provider_id:u.provider.id,_token:getCookie("user_token")},{},false,function(t){if(t.result==undefined||t.result.tickets==undefined||t.result.tickets.length==0){}c(function(){D.currentTicketPage=n.page();n.total(t.result._total);D.view.count=t.result._total;if(D.view.order=="asc"&&D.view.orderBy!=s){D.defaultSorting=false}else if(D.view.order=="desc"&&D.view.orderBy!=a){D.defaultSorting=false}var e=n.sorting()?o("orderBy")(t.result.tickets,n.orderBy()):t.result.tickets;i.resolve(e);D.showCheckboxes=false;D.tickets=e;r.$broadcast("loadCustomerData",D.tickets);if(D.isLoad){D.loadTicketChartsCount()}},100)})}})}]);angular.module("eweiApp.chart").controller("ChartDistributeController",["$rootScope","$scope","$state","utils","$location",function(e,t,i,n,s){if(i.current.name=="chart.distribute"){i.go("chart.distribute.request_distribute")}}]).controller("RequestDistributeController",["$rootScope","$scope","$state","$stateParams","$filter","distributeService","ngTableParams","alertService",function(s,a,e,t,i,r,n,o){s.chartStateCurrentName=e.current.name;var l=function(i,n){a.chartBytime=ECharts.Charts.InitChart("distribute_bytime");a.chartByip=ECharts.Charts.InitChart("distribute_byip");a.chartBychannel=ECharts.Charts.InitChart("distribute_bychannel");a.chartByoverflow=ECharts.Charts.InitChart("distribute_byoverflow");a.chartBydeleterate=ECharts.Charts.InitChart("distribute_bydeleterate");a.chartBydeletereason=ECharts.Charts.InitChart("distribute_bydeletereason");a.byTimeType="day";if(i.length==10){i+=" 00:00:00"}if(n.length==10){n+=" 23:59:59"}r.run({way:"bytimeday",begin:i,end:n},{},false,function(e){a.chartBytime=ECharts.Charts.RenderChart("line","distribute_bytime",e.result,"时间段分布",50,a.chartBytime)});r.run({way:"byip",begin:i,end:n},{},false,function(e){a.chartByip=ECharts.Charts.RenderChart("bar","distribute_byip",e.result,"IP地址来源地",50,a.chartByip)});r.run({way:"bychannel",begin:i,end:n},{},false,function(e){a.chartBychannel=ECharts.Charts.RenderChart("pie","distribute_bychannel",e.result,"渠道分布",null,a.chartBychannel);if(a.chartBychannel!=null){a.chartBychannel.on(echarts.config.EVENT.CLICK,function(t){a.chartByoverflow=ECharts.Charts.InitChart("distribute_byoverflow");r.run({way:"byoverflow",begin:i,end:n,viaChannelName:t.name},{},false,function(e){a.chartByoverflow=ECharts.Charts.RenderChart("pie","distribute_byoverflow",e.result,t.name+"-溢出率",null,a.chartByoverflow)},function(e){a.chartByoverflow=null;$("#distribute_byoverflow").html('<p class="chart_data_none">响应超时，服务器长时间未响应，请联系'+s.providerEweiProductName+"客服人员...</p>")})})}});r.run({way:"byoverflow",begin:i,end:n,viaChannelName:null},{},false,function(e){a.chartByoverflow=ECharts.Charts.RenderChart("pie","distribute_byoverflow",e.result,"溢出率",null,a.chartByoverflow)});r.run({way:"bydeleterate",begin:i,end:n},{},false,function(e){a.chartBydeleterate=ECharts.Charts.RenderChart("pie","distribute_bydeleterate",e.result,"删除率",null,a.chartBydeleterate)});r.run({way:"bydeletereason",begin:i,end:n},{},false,function(e){a.chartBydeletereason=ECharts.Charts.RenderChart("pie","distribute_bydeletereason",e.result,"删除原因",null,a.chartBydeletereason)})};var c=1;if(angular.isDefined(s.chartSelectTime)){c=s.chartSelectTime.id}if(c==1||c==2||c==3){var u=new Date;var d=i("date")(u,"yyyy/MM/dd 23:59:59");if(c==1){u.setMonth(u.getMonth()-1)}else if(c==2){u.setDate(u.getDate()-7)}else if(c==3){u.setDate(u.getDate()-1)}a.begin=i("date")(u,"yyyy/MM/dd 00:00:00");a.end=d;l(i("date")(u,"yyyy/MM/dd 00:00:00"),d)}else{a.begin=s.chartSelectedDate.begin;a.end=s.chartSelectedDate.end;l(s.chartSelectedDate.begin,s.chartSelectedDate.end)}a.$on("reloadDistributeRequest",function(e,t){r.clearCache();a.begin=t.begin;a.end=t.end;l(t.begin,t.end)});a.switchHourAndDay=function(e){a.chartBytime=ECharts.Charts.InitChart("distribute_bytime");if(e=="hour"){a.byTimeType="hour";r.run({way:"bytimehour",begin:a.begin,end:a.end},{},false,function(e){a.chartBytime=ECharts.Charts.RenderChart("line","distribute_bytime",e.result,"时间段分布",24,a.chartBytime)})}else if(e=="day"){a.byTimeType="day";r.run({way:"bytimeday",begin:a.begin,end:a.end},{},false,function(e){a.chartBytime=ECharts.Charts.RenderChart("line","distribute_bytime",e.result,"时间段分布",50,a.chartBytime)})}};a.allChannelOverflow=function(){a.chartByoverflow=ECharts.Charts.InitChart("distribute_byoverflow");r.run({way:"byoverflow",begin:a.begin,end:a.end,viaChannelName:null},{},false,function(e){a.chartByoverflow=ECharts.Charts.RenderChart("pie","distribute_byoverflow",e.result,"溢出率",null,a.chartByoverflow)})};a.$on("exportPdfByRequestDistribute",function(e,t){})}]).controller("TicketPropDistributeController",["$rootScope","$scope","$state","$stateParams","$filter","distributeService","ngTableParams","alertService",function(e,o,t,i,n,s,a,r){e.chartStateCurrentName=t.current.name;var l=function(e,t){o.chartBypriority=ECharts.Charts.InitChart("distribute_bypriority");o.chartBytype=ECharts.Charts.InitChart("distribute_bytype");o.chartByservicecatalog=ECharts.Charts.InitChart("distribute_byservicecatalog");o.chartBytag=ECharts.Charts.InitChart("distribute_bytag");if(e.length==10){e+=" 00:00:00"}if(t.length==10){t+=" 23:59:59"}s.run({way:"bypriority",begin:e,end:t},{},false,function(e){var t=e.result;if(localStorage&&localStorage["systemFieldPriority"]){var i=angular.fromJson(angular.fromJson(localStorage["systemFieldPriority"]).customFieldOptions);for(var n=0,s=t.length;n<s;n++){for(var a=0,r=i.length;a<r;a++){if(t[n].name==i[a].value){t[n].name=i[a].name;break}}}}o.chartBypriority=ECharts.Charts.RenderChart("radar","distribute_bypriority",t,"优先级分布",null,o.chartBypriority)});s.run({way:"bytype",begin:e,end:t},{},false,function(e){o.chartBytype=ECharts.Charts.RenderChart("radar","distribute_bytype",e.result,"工单类型分布",null,o.chartBytype)});s.run({way:"byservicecatalog",begin:e,end:t,parentId:null},{},false,function(e){o.chartData=e.result;o.breadcrumbs=[{name:"根目录",id:null}];o.chartByservicecatalog=ECharts.Charts.RenderChart("pie","distribute_byservicecatalog",o.chartData,"服务目录分布",null,o.chartByservicecatalog);if(o.chartByservicecatalog!=null){o.chartByservicecatalog.on(echarts.config.EVENT.CLICK,function(e){var t=u(e.name);c(e.name,t)})}});s.run({way:"bytag",begin:e,end:t},{},false,function(e){o.chartBytag=ECharts.Charts.RenderChart("bar","distribute_bytag",e.result,"标签分布",50,o.chartBytag)})};var c=function(i,n){o.chartByservicecatalog=ECharts.Charts.InitChart("distribute_byservicecatalog");s.run({way:"byservicecatalog",begin:o.begin,end:o.end,parentId:n},{},false,function(e){o.chartData=e.result;var t=i=="根目录"?"服务目录分布":i+"-服务目录分布";o.chartByservicecatalog=ECharts.Charts.RenderChart("pie","distribute_byservicecatalog",o.chartData,t,null,o.chartByservicecatalog);if(o.chartByservicecatalog!=null){o.breadcrumbs.push({name:i,id:n});o.chartByservicecatalog.on(echarts.config.EVENT.CLICK,function(e){var t=u(e.name);c(e.name,t)})}})};o.selectServicecatalog=function(e,t,i){o.breadcrumbs.splice(i,o.breadcrumbs.length-i);c(e,t)};var u=function(e){for(var t=0;t<o.chartData.length;t++){var i=o.chartData[t];if(i.name==e){return i.other;break}}};var d=1;if(angular.isDefined(e.chartSelectTime)){d=e.chartSelectTime.id}if(d==1||d==2||d==3){var p=new Date;var f=n("date")(p,"yyyy/MM/dd 23:59:59");if(d==1){p.setMonth(p.getMonth()-1)}else if(d==2){p.setDate(p.getDate()-7)}else if(d==3){p.setDate(p.getDate()-1)}o.begin=n("date")(p,"yyyy/MM/dd 00:00:00");o.end=f;l(n("date")(p,"yyyy/MM/dd 00:00:00"),f)}else{o.begin=e.chartSelectedDate.begin;o.end=e.chartSelectedDate.end;l(e.chartSelectedDate.begin,e.chartSelectedDate.end)}o.$on("reloadDistributeTicketProp",function(e,t){s.clearCache();o.begin=t.begin;o.end=t.end;l(t.begin,t.end)});o.$on("exportPdfByTicketPropDistribute",function(e,t){})}]).controller("TopEngineerDistributeController",["$rootScope","$scope","$state","$stateParams","$filter","distributeService","ngTableParams","alertService",function(i,n,e,t,s,a,r,o){i.chartStateCurrentName=e.current.name;var l=function(e,t){n.chartByfirstreply=ECharts.Charts.InitChart("distribute_byfirstreply");n.chartByparticipate=ECharts.Charts.InitChart("distribute_byparticipate");n.chartByclose=ECharts.Charts.InitChart("distribute_byclose");n.chartBytechsupport=ECharts.Charts.InitChart("distribute_bytechsupport");n.chartByhelpcenter=ECharts.Charts.InitChart("distribute_byhelpcenter");if(e.length==10){e+=" 00:00:00"}if(t.length==10){t+=" 23:59:59"}a.run({way:"byfirstreply",begin:e,end:t},{},false,function(e){n.chartByfirstreply=ECharts.Charts.RenderChart("bar","distribute_byfirstreply",e.result,"接单排行榜（最先回复的工单）",10,n.chartByfirstreply)});a.run({way:"byparticipate",begin:e,end:t},{},false,function(e){n.chartByparticipate=ECharts.Charts.RenderChart("bar","distribute_byparticipate",e.result,"团队协作排行榜（参与的工单）",10,n.chartByparticipate)});a.run({way:"byclose",begin:e,end:t},{},false,function(e){n.chartByclose=ECharts.Charts.RenderChart("bar","distribute_byclose",e.result,"关单排行榜（处理完毕的工单）",10,n.chartByclose)},function(e){n.chartByclose=null;$("#distribute_byclose").html('<p class="chart_data_none">响应超时，服务器长时间未响应，请联系'+i.providerEweiProductName+"客服人员...</p>")});a.run({way:"bytechsupport",begin:e,end:t},{},false,function(e){n.chartBytechsupport=ECharts.Charts.RenderChart("bar","distribute_bytechsupport",e.result,"技术支持排行榜（提供远程协助的次数）",10,n.chartBytechsupport)});a.run({way:"byhelpcenter",begin:e,end:t},{},false,function(e){n.chartByhelpcenter=ECharts.Charts.RenderChart("bar","distribute_byhelpcenter",e.result,"社区贡献排行榜",10,n.chartByhelpcenter,true)})};var c=1;if(angular.isDefined(i.chartSelectTime)){c=i.chartSelectTime.id}if(c==1||c==2||c==3){var u=new Date;var d=s("date")(u,"yyyy/MM/dd 23:59:59");if(c==1){u.setMonth(u.getMonth()-1)}else if(c==2){u.setDate(u.getDate()-7)}else if(c==3){u.setDate(u.getDate()-1)}l(s("date")(u,"yyyy/MM/dd 00:00:00"),d)}else{l(i.chartSelectedDate.begin,i.chartSelectedDate.end)}n.$on("reloadDistributeTopEngineer",function(e,t){a.clearCache();l(t.begin,t.end)});n.$on("exportPdfByTopEngineer",function(e,t){})}]).controller("TopServiceDeskDistributeController",["$rootScope","$scope","$state","$stateParams","$filter","distributeService","ngTableParams","alertService",function(e,i,t,n,s,a,r,o){e.chartStateCurrentName=t.current.name;var l=function(e,t){i.chartBygroupfirstreply=ECharts.Charts.InitChart("distribute_bygroupfirstreply");i.chartBygroupclose=ECharts.Charts.InitChart("distribute_bygroupclose");i.chartBygroupparticipate=ECharts.Charts.InitChart("distribute_bygroupparticipate");i.chartBygrouptechsupport=ECharts.Charts.InitChart("distribute_bygrouptechsupport");i.chartBygrouphelpcenter=ECharts.Charts.InitChart("distribute_bygrouphelpcenter");if(e.length==10){e+=" 00:00:00"}if(t.length==10){t+=" 23:59:59"}a.run({way:"bygroupfirstreply",begin:e,end:t},{},false,function(e){i.chartBygroupfirstreply=ECharts.Charts.RenderChart("radar","distribute_bygroupfirstreply",e.result,"接单（最先回复的工单）",10,i.chartBygroupfirstreply)});a.run({way:"bygroupclose",begin:e,end:t},{},false,function(e){i.chartBygroupclose=ECharts.Charts.RenderChart("radar","distribute_bygroupclose",e.result,"关单（处理完毕的工单）",10,i.chartBygroupclose)});a.run({way:"bygroupparticipate",begin:e,end:t},{},false,function(e){i.chartBygroupparticipate=ECharts.Charts.RenderChart("radar","distribute_bygroupparticipate",e.result,"团队协作（参与的工单）",10,i.chartBygroupparticipate)});a.run({way:"bygrouptechsupport",begin:e,end:t},{},false,function(e){i.chartBygrouptechsupport=ECharts.Charts.RenderChart("radar","distribute_bygrouptechsupport",e.result,"技术支持（提供远程协助的次数）",10,i.chartBygrouptechsupport)});a.run({way:"bygrouphelpcenter",begin:e,end:t},{},false,function(e){i.chartBygrouphelpcenter=ECharts.Charts.RenderChart("bar","distribute_bygrouphelpcenter",e.result,"社区贡献排行榜",10,i.chartBygrouphelpcenter,true)})};var c=1;if(angular.isDefined(e.chartSelectTime)){c=e.chartSelectTime.id}if(c==1||c==2||c==3){var u=new Date;var d=s("date")(u,"yyyy/MM/dd 23:59:59");if(c==1){u.setMonth(u.getMonth()-1)}else if(c==2){u.setDate(u.getDate()-7)}else if(c==3){u.setDate(u.getDate()-1)}l(s("date")(u,"yyyy/MM/dd 00:00:00"),d)}else{l(e.chartSelectedDate.begin,e.chartSelectedDate.end)}i.$on("reloadDistributeTopServicedesk",function(e,t){a.clearCache();l(t.begin,t.end)});i.$on("exportPdfByTopServicedesk",function(e,t){})}]);angular.module("eweiApp.chart").controller("ChartCustomerController",["$rootScope","$scope","$state","utils","$location",function(e,t,i,n,s){if(i.current.name=="chart.customer"){i.go("chart.customer.customer_analyse")}}]).controller("CustomerAnalyseController",["$rootScope","$scope","$state","$stateParams","$filter","customerAnalyseService","ngTableParams","alertService",function(e,i,t,n,s,a,r,o){e.chartStateCurrentName=t.current.name;var l=function(e,t){i.chartByincremental=ECharts.Charts.InitChart("customer_analyse_incremental");i.chartByhelpcenter=ECharts.Charts.InitChart("helpcenter");i.chartByusergroup=ECharts.Charts.InitChart("customer_analyse_byusergroup");i.chartByusergroupscale=ECharts.Charts.InitChart("customer_analyse_byusergroupscale");i.byIncrementalType="month";i.byHelpcenterType="month";if(e.length==10){e+=" 00:00:00"}if(t.length==10){t+=" 23:59:59"}a.run({way:"incremental_bymonth",begin:e,end:t},{},false,function(e){i.chartByincremental=ECharts.Charts.RenderChart("bar","customer_analyse_incremental",e.result,"客户增量",12,i.chartByincremental,true)});a.run({way:"helpcenter_bymonth",begin:e,end:t},{},false,function(e){i.chartByhelpcenter=ECharts.Charts.RenderChart("bar","helpcenter",e.result,"客户活跃度",12,i.chartByhelpcenter,true)});a.run({way:"byusergroup",begin:e,end:t},{},false,function(e){i.chartByusergroup=ECharts.Charts.RenderChart("pie","customer_analyse_byusergroup",e.result,"客户类型占比（企业/个人）",null,i.chartByusergroup)});a.run({way:"byusergroupscale",begin:e,end:t},{},false,function(e){i.chartByusergroupscale=ECharts.Charts.RenderChart("pie","customer_analyse_byusergroupscale",e.result,"企业客户规模分布",null,i.chartByusergroupscale)})};var c=1;if(angular.isDefined(e.chartSelectTime)){c=e.chartSelectTime.id}if(c==1||c==2||c==3){var u=new Date;var d=s("date")(u,"yyyy/MM/dd 23:59:59");if(c==1){u.setMonth(u.getMonth()-1)}else if(c==2){u.setDate(u.getDate()-7)}else if(c==3){u.setDate(u.getDate()-1)}i.begin=s("date")(u,"yyyy/MM/dd 00:00:00");i.end=d;l(s("date")(u,"yyyy/MM/dd 00:00:00"),d)}else{i.begin=e.chartSelectedDate.begin;i.end=e.chartSelectedDate.end;l(e.chartSelectedDate.begin,e.chartSelectedDate.end)}i.$on("reloadCustomerAnalyse",function(e,t){a.clearCache();i.begin=t.begin;i.end=t.end;l(t.begin,t.end)});i.switchYearAndMonthByIncremental=function(e){i.chartByincremental=ECharts.Charts.InitChart("customer_analyse_incremental");if(e=="year"){i.byIncrementalType="year";a.run({way:"incremental_byyear",begin:i.begin,end:i.end},{},false,function(e){i.chartByincremental=ECharts.Charts.RenderChart("bar","customer_analyse_incremental",e.result,"客户增量",10,i.chartByincremental,true)})}else if(e=="month"){i.byIncrementalType="month";a.run({way:"incremental_bymonth",begin:i.begin,end:i.end},{},false,function(e){i.chartByincremental=ECharts.Charts.RenderChart("bar","customer_analyse_incremental",e.result,"客户增量",12,i.chartByincremental,true)})}};i.switchYearAndMonthByHelpcenter=function(e){i.chartByhelpcenter=ECharts.Charts.InitChart("helpcenter");if(e=="year"){i.byHelpcenterType="year";a.run({way:"helpcenter_byyear",begin:i.begin,end:i.end},{},false,function(e){i.chartByhelpcenter=ECharts.Charts.RenderChart("bar","helpcenter",e.result,"客户活跃度",10,i.chartByhelpcenter,true)})}else if(e=="month"){i.byHelpcenterType="month";a.run({way:"helpcenter_bymonth",begin:i.begin,end:i.end},{},false,function(e){i.chartByhelpcenter=ECharts.Charts.RenderChart("bar","helpcenter",e.result,"客户活跃度",12,i.chartByhelpcenter,true)})}};i.$on("exportPdfByCustomerAnalyse",function(e,t){})}]).controller("TopCustomerController",["$rootScope","$scope","$state","$stateParams","$filter","customerAnalyseService","ngTableParams","alertService",function(e,i,t,n,s,a,r,o){e.chartStateCurrentName=t.current.name;var l=function(e,t){i.chartByrequestcount=ECharts.Charts.InitChart("request_count_bycustomer");i.chartByhelpcentercount=ECharts.Charts.InitChart("helpcenter_count_bycustomer");i.chartBygoodcount=ECharts.Charts.InitChart("good_count_bycustomer");i.chartBypoorcount=ECharts.Charts.InitChart("poor_count_bycustomer");if(e.length==10){e+=" 00:00:00"}if(t.length==10){t+=" 23:59:59"}a.run({way:"request_count_bycustomer",begin:e,end:t},{},false,function(e){i.chartByrequestcount=ECharts.Charts.RenderChart("bar","request_count_bycustomer",e.result,"服务请求排行榜",10,i.chartByrequestcount)});a.run({way:"helpcenter_bycustomer",begin:e,end:t},{},false,function(e){i.chartByhelpcentercount=ECharts.Charts.RenderChart("bar","helpcenter_count_bycustomer",e.result,"社区活动排行榜",10,i.chartByhelpcentercount,true)});a.run({way:"good_count_bycustomer",begin:e,end:t},{},false,function(e){i.chartBygoodcount=ECharts.Charts.RenderChart("bar","good_count_bycustomer",e.result,"好评排行榜",10,i.chartBygoodcount)});a.run({way:"poor_count_bycustomer",begin:e,end:t},{},false,function(e){i.chartBypoorcount=ECharts.Charts.RenderChart("bar","poor_count_bycustomer",e.result,"差评排行榜",10,i.chartBypoorcount)})};var c=1;if(angular.isDefined(e.chartSelectTime)){c=e.chartSelectTime.id}if(c==1||c==2||c==3){var u=new Date;var d=s("date")(u,"yyyy/MM/dd 23:59:59");if(c==1){u.setMonth(u.getMonth()-1)}else if(c==2){u.setDate(u.getDate()-7)}else if(c==3){u.setDate(u.getDate()-1)}l(s("date")(u,"yyyy/MM/dd 00:00:00"),d)}else{l(e.chartSelectedDate.begin,e.chartSelectedDate.end)}i.$on("reloadCustomerTopCustomer",function(e,t){a.clearCache();l(t.begin,t.end)});i.$on("exportPdfByTopCustomer",function(e,t){})}]).controller("TopUserGroupController",["$rootScope","$scope","$state","$stateParams","$filter","customerAnalyseService","ngTableParams","alertService",function(e,i,t,n,s,a,r,o){e.chartStateCurrentName=t.current.name;var l=function(e,t){i.chartByrequestcount=ECharts.Charts.InitChart("request_count_byusergroup");i.chartByhelpcentercount=ECharts.Charts.InitChart("helpcenter_count_byusergroup");i.chartBygoodcount=ECharts.Charts.InitChart("good_count_byusergroup");i.chartBypoorcount=ECharts.Charts.InitChart("poor_count_byusergroup");if(e.length==10){e+=" 00:00:00"}if(t.length==10){t+=" 23:59:59"}a.run({way:"request_count_byusergroup",begin:e,end:t},{},false,function(e){i.chartByrequestcount=ECharts.Charts.RenderChart("bar","request_count_byusergroup",e.result,"服务请求排行榜",10,i.chartByrequestcount)});a.run({way:"helpcenter_byusergroup",begin:e,end:t},{},false,function(e){i.chartByhelpcentercount=ECharts.Charts.RenderChart("bar","helpcenter_count_byusergroup",e.result,"社区活动排行榜",10,i.chartByhelpcentercount,true)});a.run({way:"good_count_byusergroup",begin:e,end:t},{},false,function(e){i.chartBygoodcount=ECharts.Charts.RenderChart("bar","good_count_byusergroup",e.result,"好评排行榜",10,i.chartBygoodcount)});a.run({way:"poor_count_byusergroup",begin:e,end:t},{},false,function(e){i.chartBypoorcount=ECharts.Charts.RenderChart("bar","poor_count_byusergroup",e.result,"差评排行榜",10,i.chartBypoorcount)})};var c=1;if(angular.isDefined(e.chartSelectTime)){c=e.chartSelectTime.id}if(c==1||c==2||c==3){var u=new Date;var d=s("date")(u,"yyyy/MM/dd 23:59:59");if(c==1){u.setMonth(u.getMonth()-1)}else if(c==2){u.setDate(u.getDate()-7)}else if(c==3){u.setDate(u.getDate()-1)}l(s("date")(u,"yyyy/MM/dd 00:00:00"),d)}else{l(e.chartSelectedDate.begin,e.chartSelectedDate.end)}i.$on("reloadCustomerTopUsergroup",function(e,t){a.clearCache();l(t.begin,t.end)});i.$on("exportPdfByTopUserGroup",function(e,t){})}]).controller("CustomerIntegralController",["$rootScope","$scope","$state","$stateParams","$filter","customerAnalyseService","ngTableParams","alertService",function(e,i,t,n,s,a,r,o){e.chartStateCurrentName=t.current.name;var l=function(e,t){i.chartByintegral=ECharts.Charts.InitChart("customer_integral");a.run({way:"customer_integral"},{},false,function(e){i.chartByintegral=ECharts.Charts.RenderChart("h-bar","customer_integral",e.result,"积分排行榜",null,i.chartByintegral)})};l();i.$on("reloadCustomerIntegral",function(e,t){a.clearCache();l()});i.$on("exportPdfByCustomerIntegral",function(e,t){})}]);angular.module("eweiApp.ticket").controller("editWebchatAutomationController",["$rootScope","$modal_","$scope","$state","$stateParams","$resource","$http","alertService","permissions","$filter","allConditionOptionsWebchat","anyConditionOptionsWebchat","executeOptionsWebchat","automationCompareOptionsWebchat","$timeout","ticketEvaluateService","commonTools","ticketStatusCompareService",function(e,t,g,i,v,n,s,h,a,y,r,o,l,c,u,d,_,k){g.andConditionOptions=angular.copy(r);g.orConditionOptions=angular.copy(o);g.operationOptions=l;g.automation={type:"chat",andConditions:[],orConditions:[],operations:[]};g.andConditions=[{attribute:"-1",tally:"and"}];g.orConditions=[{attribute:"-1",tally:"or"}];g.operations=[{attribute:"-1",options:l}];g.compareOptions=angular.copy(c);var p=function(e,t,i){if(e=="and"){for(var n=0,s=g.andConditionOptions.length;n<s;n++){if(g.andConditionOptions[n].value==i){g.andConditions[t].valueType=g.andConditionOptions[n].valueType;g.andConditions[t].valueOptions=angular.copy(g.andConditionOptions[n].valueOptions);g.andConditions[t].edit_able=g.andConditionOptions[n].edit_able}}}else if(e=="or"){for(var n=0,s=g.orConditionOptions.length;n<s;n++){if(g.orConditionOptions[n].value==i){g.orConditions[t].valueType=g.orConditionOptions[n].valueType;g.orConditions[t].valueOptions=angular.copy(g.orConditionOptions[n].valueOptions);g.orConditions[t].edit_able=g.orConditionOptions[n].edit_able}}}else if(e=="operation"){for(var n=0,s=g.operationOptions.length;n<s;n++){if(g.operationOptions[n].value==i){g.operations[t].valueType=g.operationOptions[n].valueType;g.operations[t].edit_able=g.operationOptions[n].edit_able;g.operations[t].valueOptions=angular.copy(g.operationOptions[n].valueOptions);g.operations[t].start=g.operationOptions[n].start;g.operations[t].startTimeForm=g.operationOptions[n].startTimeForm;g.operations[t].endTimeForm=g.operationOptions[n].endTimeForm}}}};var f=function(e,t,i){if(e=="and"){g.andConditions[t].valueOptions=i}else if(e=="or"){g.orConditions[t].valueOptions=i}else if(e=="operation"){g.operations[t].valueOptions=i}};var m=function(e,t){var i=[{option:"是",value:"canceled"},{option:"否",value:"canceled"}];f(e,t,i)};var C=function(e,t){var i=[{option:"无效信息",value:"无效信息"},{option:"重复信息",value:"重复信息"},{option:"恶意骚扰",value:"恶意骚扰"},{option:"其他原因",value:"其他原因"}];f(e,t,i)};var b=function(e,t){var i=[{option:"已解决",value:"1"},{option:"未解决",value:"0"}];f(e,t,i)};var w=function(e,t){var i=[{option:"P1",value:"P1"},{option:"P2",value:"P2"},{option:"P3",value:"P3"},{option:"P4",value:"P4"},{option:"P5",value:"P5"}];f(e,t,i)};var T=function(o,l){s({url:"ticket_type.json",method:"GET",params:{_count:12332,_do_count:false,_fields:"id,name,description,isDefault"}}).success(function(e,t,i,n){userAginLogin(e);if(e.ticketTypes){var s=[];for(var a=0,r=e.ticketTypes.length;a<r;a++){s.push({option:e.ticketTypes[a].name,value:""+e.ticketTypes[a].id})}f(o,l,s)}})};var S=function(e,t){var i=[{option:"Email收件箱",value:"email"},{option:"网页表单(feedback)",value:"form"},{option:"在线交谈/远程协助",value:"chat"},{option:"微信客服",value:"weixin"},{option:"电话渠道",value:"cti"},{option:"帮助中心",value:"helpcenter"},{option:"客服创建",value:"console"}];f(e,t,i)};var F=function(e,t){var i=[{option:"1分",value:"1"},{option:"2分",value:"2"},{option:"3分",value:"3"},{option:"4分",value:"4"},{option:"5分",value:"5"}];f(e,t,i)};var A=function(e){var t=[];for(var i=0,n=e[1];i<n;i++){t.push(g.compareOptions[e[0]+i])}return t};var E=function(e,t,i){var n=[];if(i=="status"){m(e,t)}else if(i=="closeChat"){f(e,t,[{option:"结束会话",value:"close_chat"},{option:"结束会话，结束关联工单",value:"completed"},{option:"结束会话，工单继续跟踪",value:"go_ticket"}])}};g.deleteCondition=function(e,t){if(e=="and"){g.andConditions.splice(t,1)}else if(e=="or"){g.orConditions.splice(t,1)}else if(e=="operation"){g.operations.splice(t,1)}};g.conditionChange=function(e,t,i){void 0;void 0;if(e=="and"){if(g.andConditions[t].value!=undefined&&g.andConditions[t].value!=null&&g.andConditions[t].value!=""){delete g.andConditions[t]["value"]}if(g.andConditions[t].compare!=undefined&&g.andConditions[t].compare!=null&&g.andConditions[t].compare!=""){delete g.andConditions[t]["compare"]}if(g.andConditions[t].engineer!=undefined&&g.andConditions[t].engineer!=null&&g.andConditions[t].engineer!=""){delete g.andConditions[t]["engineer"];delete g.andConditions[t]["engineerDesk"]}}else if(e=="or"){if(g.orConditions[t].value!=undefined&&g.orConditions[t].value!=null&&g.orConditions[t].value!=""){delete g.orConditions[t]["value"]}if(g.orConditions[t].compare!=undefined&&g.orConditions[t].compare!=null&&g.orConditions[t].compare!=""){delete g.orConditions[t]["compare"]}if(g.orConditions[t].engineer!=undefined&&g.orConditions[t].engineer!=null&&g.orConditions[t].engineer!=""){delete g.orConditions[t]["engineer"];delete g.orConditions[t]["engineerDesk"]}}else{if(g.operations[t].value){delete g.operations[t]["value"]}if(g.operations[t]["endTime"]!=undefined&&g.operations[t]["endTime"]!=null&&g.operations[t]["endTime"]!=""){delete g.operations[t]["endTime"]}if(g.operations[t]["startTime"]!=undefined&&g.operations[t]["startTime"]!=null&&g.operations[t]["startTime"]!=""){delete g.operations[t]["startTime"]}if(g.operations[t].engineer){delete g.operations[t]["engineer"];delete g.operations[t]["engineerDesk"]}}g.conditionGetNode(e,t)};g.conditionGetNode=function(e,t){if(e=="and"){g.andConditions[t].orderKey=t+1;var i=g.andConditions[t];if(i.value!="-1"){p(e,t,i.attribute);i=g.andConditions[t];if(i.valueType=="number"){i.value=Number(i.value)}if(i.attribute=="status"){g.andConditions[t].compareOptions=A([36,2])}else if(i.attribute=="closedAt"){g.andConditions[t].compareOptions=A([4,3])}else if(i.attribute=="user.id"){g.andConditions[t].compareOptions=A([10,3])}else if(i.attribute=="engineer.id"){g.andConditions[t].compareOptions=A([10,3])}else if(i.attribute=="via"){g.andConditions[t].compareOptions=A([18,2])}else if(i.attribute.indexOf("checkbox")>=0){g.andConditions[t].compareOptions=A([22,2]);g.andConditions[t].value="true"}else if(i.attribute.indexOf("textarea")>=0){g.andConditions[t].compareOptions=A([24,2])}else if(i.attribute.indexOf("date")>=0||i.attribute.indexOf("number")>=0||i.attribute.indexOf("decimal")>=0){g.andConditions[t].compareOptions=A([26,3])}else if(i.attribute.indexOf("ticketcustomfield")>=0){if(i.attribute.indexOf("multi_options")>=0){g.andConditions[t].compareOptions=A([29,2])}else{g.andConditions[t].compareOptions=A([20,2])}}else if(i.attribute=="customerLastReply"||i.attribute=="engineerLastReply"){g.andConditions[t].compareOptions=A([10,3])}else{g.andConditions[t].compareOptions=A([7,3])}if(i.valueType=="select"){E(e,t,i.attribute)}}}else if(e=="or"){g.orConditions[t].orderKey=t+1;var i=g.orConditions[t];if(i.value!="-1"){p(e,t,i.attribute);i=g.orConditions[t];if(i.valueType=="number"){i.value=Number(i.value)}if(i.attribute=="tags"){g.orConditions[t].compareOptions=A([10,2])}else if(i.attribute=="subject"||i.attribute=="ticket_description"){g.orConditions[t].compareOptions=A([12,2])}else if(i.attribute=="engineer.id"){g.orConditions[t].compareOptions=A([14,2])}else if(i.attribute=="ticketComment"){g.orConditions[t].compareOptions=A([16,2])}else if(i.attribute=="via"){g.orConditions[t].compareOptions=A([18,2])}else if(i.attribute.indexOf("checkbox")>=0){g.orConditions[t].compareOptions=A([22,2]);g.orConditions[t].value="true"}else if(i.attribute.indexOf("textarea")>=0){g.orConditions[t].compareOptions=A([24,2])}else if(i.attribute.indexOf("date")>=0||i.attribute.indexOf("number")>=0||i.attribute.indexOf("decimal")>=0){g.orConditions[t].compareOptions=A([26,3])}else if(i.attribute.indexOf("ticketcustomfield")>=0){if(i.attribute.indexOf("multi_options")>=0){g.orConditions[t].compareOptions=A([29,2])}else{g.orConditions[t].compareOptions=A([20,2])}}else if(i.attribute=="serviceCatalog.id"){var n=[{option:"是且包含其子目录",value:"$in"},{option:"是但不包含其子目录",value:"$eq"},{option:"不是且不是其子目录",value:"$not_in"},{option:"不是但可能是其子目录",value:"$ne"}];g.orConditions[t].compareOptions=n}else if(i.attribute==="evaluate.solved"){g.orConditions[t].compareOptions=A([0,1])}else if(i.attribute=="status"){g.orConditions[t].compareOptions=A([36,2])}else if(i.attribute=="closedAt"){g.orConditions[t].compareOptions=A([4,3])}else if(i.attribute=="customerLastReply"||i.attribute=="engineerLastReply"){g.orConditions[t].compareOptions=A([10,3])}else{g.orConditions[t].compareOptions=A([0,2])}if(i.valueType=="select"){E(e,t,i.attribute)}}}else{g.operations[t].orderKey=t+1;var i=g.operations[t];if(i.value!="-1"){p(e,t,i.attribute)}if(i.valueType=="select"){E(e,t,i.attribute)}if(i.attribute.indexOf("checkbox")>=0){g.operations[t].compareOptions=A([22,2])}}};g.getEngineer=function(t,e,i,n){s({url:"service_desk/"+e+".json",method:"GET",params:{}}).success(function(e){t[n].engineerDesk=e.json});s({url:"engineer/"+i+".json",method:"GET",params:{}}).success(function(e){t[n].engineer=e.json})};g.getServiceDesk=function(t,i){s({url:"service_desk/"+t[i].value+".json",method:"GET",params:{}}).success(function(e){t[i].value=e.json})};g.getRequester=function(t,i){s({url:"user/"+t[i].value+"/no_access_scope.json",method:"GET",params:{}}).success(function(e){t[i].value=e.json})};g.getUserGroup=function(t,i){s({url:"user_group/"+t[i].value+".json",method:"GET",params:{}}).success(function(e){t[i].value=e.json})};g.eweiPermisstionType="自动化";g.loadAutomation=function(e){org.ewei.sdk.OpenAutomationApi().getById({id:parseInt(e)}).then({success:function(e){g.automation=e;g.rolePermissions=g.automation.permissions;if(!g.automation.isDefault){g.andConditions=g.automation.andConditions;g.orConditions=g.automation.orConditions;g.operations=g.automation.operations;for(var t=0;t<g.operations.length;t++){if(g.operations[t].operate){g.operations[t].attribute=g.operations[t].operate;delete g.operations[t]["operate"]}}g.operations[0].options={};g.operations[0].options=l;for(var t=1;t<g.operations.length;t++){var i=[];for(var n=0;n<g.operations[t-1].options.length;n++){if(g.operations[t-1].attribute!=g.operations[t-1].options[n].value){i.push(g.operations[t-1].options[n])}}g.operations[t].options={};g.operations[t].options=i}function s(e,t){for(var i=0;i<e.length;i++){if(e[i].attribute=="createdAt"||e[i].attribute=="ticketMetric.responseAt"||e[i].attribute=="ticketMetric.pausedAt"||e[i].attribute=="ticketMetric.solvedAt"||e[i].attribute=="lastReply"||e[i].attribute=="customerLastReply"||e[i].attribute=="engineerLastReply"){e[i].value=parseInt(e[i].value)}if(e[i].attribute=="deleteTicket"){if(e[i].value!="无效信息"&&e[i].value!="重复信息"&&e[i].value!="恶意骚扰"){e[i].reason=e[i].value;e[i].value="其他原因"}}g.conditionGetNode(t,i);if(e[i].attribute=="engineer.id"){var n=e[i].value.split("_")[0];var s=e[i].value.split("_")[1];g.getEngineer(e,n,s,i);delete e[i]["value"]}else if(e[i].attribute=="noticeUser"){e[i].value=e[i].value}else if(e[i].attribute=="serviceDesk.id"||e[i].attribute=="noticeGroup"){g.getServiceDesk(e,i)}else if(e[i].attribute=="requester.id"){g.getRequester(e,i)}else if(e[i].attribute=="requester.userGroup.id"){g.getUserGroup(e,i)}else if(e[i].attribute=="addCC"){e[i].value=JSON.parse(e[i].value)}else if(e[i].attribute=="via"||e[i].attribute=="chatComment"){e[i].value=JSON.parse(e[i].value)}if(t==="and"||t==="or"){if(e[i].compare==="$in"||e[i].compare==="$not_in"){e[i].value=e[i].value.replace("service_catalog_and_children_id_","")}}}}s(g.andConditions,"and");s(g.orConditions,"or");s(g.operations,"operation");var a=[g.andConditions,g.orConditions,g.operations];for(var t=0;t<a.length;t++){for(var n=0;n<a[t].length;n++){if(a[t][n].valueType=="cascade_options"||a[t][n].valueType=="multi_options"||a[t][n].valueType=="options"){a[t][n].valueOptions.value=a[t][n].value}else if(a[t][n].valueType=="date"){a[t][n].value=_.parseDate(a[t][n].value,"yyyy/MM/dd")}else if(a[t][n].valueType=="date_time"){}else if(a[t][n].valueType=="date_to_date"){var r=a[t][n].value;r=r.split("-");a[t][n].startTime=_.parseDate(r[0],"yyyy/MM/dd");a[t][n].endTime=_.parseDate(r[1],"yyyy/MM/dd")}if(t==2&&a[t][n].valueType=="checkbox"){a[t][n].compare=a[t][n].value=="true"?"$eq_ticket_custom_field":"$ne_or_null_ticket_custom_field"}}}}},fail:function(){h.add("更新失败","danger")}})};g.type=v.type;if(v.id>0){u(function(){g.loadAutomation(v.id)},100)}g.addNewCondition=function(e){if(e=="and"){g.andConditions.push({attribute:"-1",tally:"and"})}else if(e=="or"){g.orConditions.push({attribute:"-1",tally:"or"})}else{var t=[];for(var i=0,n=l.length;i<n;i++){var s=false;for(var a=0,r=g.operations.length;a<r;a++){if(g.operations[a].attribute!=0&&g.operations[a].attribute==l[i].value){s=true;break}}if(!s){t.push(l[i])}}var o={attribute:"-1",orderKey:"",valueOptions:[],valueType:"",options:t};g.operations.push(o)}};g.backAutomation=function(){i.go("system_setting.detail",{uri:"automations",settingType:"ticket"})};g.isClick=false;g.saveAutomation=function(){var e=false;if(!g.automation.name){e=false}else{e=true}if(g.andConditions.length<1||g.operations.length<1){h.add("每项至少需要一个条件和一项操作","danger")}else{var t=false;var i=false;var n=false;var s=false;var a=false;var r=false;for(var o=0;o<g.andConditions.length;o++){if((g.andConditions[o].attribute==="customerLastReply"||g.andConditions[o].attribute==="engineerLastReply")&&g.andConditions[o].value&&(parseInt(g.andConditions[o].value)<1||parseInt(g.andConditions[o].value)>300)){h.add("客户回复以来分钟数/客服回复以来分钟数值必须在1-300范围内","danger");return}if(g.andConditions[o].valueType=="cascade_options"||g.andConditions[o].valueType=="multi_options"||g.andConditions[o].valueType=="options"){g.andConditions[o].value=g.andConditions[o].valueOptions.value}if(g.andConditions[o].valueType=="number"){g.andConditions[o].value=Number(g.andConditions[o].value)}if(g.andConditions[o].compare&&(g.andConditions[o].value||g.andConditions[o].value==0)&&g.andConditions[o].attribute!=0){if(typeof g.andConditions[o].value=="number"){if(g.andConditions[o].value<0){t=false;break}else{t=true;i=true}}else{t=true;i=true}}else{if(g.andConditions[o].engineer){g.andConditions[o].value=g.andConditions[o].engineerDesk.id+"_"+g.andConditions[o].engineer.id;t=true;i=true}else if(g.andConditions[o].attribute==="status"&&g.andConditions[o].compare){if(g.andConditions[o].compare=="$eq"){g.andConditions[o].value="canceled"}else{g.andConditions[o].value="canceled"}t=true;i=true}else{i=false;break}}}if(g.orConditions.length>0){for(var o=0;o<g.orConditions.length;o++){if((g.orConditions[o].attribute==="customerLastReply"||g.orConditions[o].attribute==="engineerLastReply")&&g.orConditions[o].value&&(parseInt(g.orConditions[o].value)<1||parseInt(g.orConditions[o].value)>300)){h.add("客户回复以来分钟数/客服回复以来分钟数值必须在1-300范围内","danger");return}if(g.orConditions[o].valueType=="cascade_options"||g.orConditions[o].valueType=="multi_options"||g.orConditions[o].valueType=="options"){g.orConditions[o].value=g.orConditions[o].valueOptions.value}if(g.orConditions[o].valueType=="date"){g.orConditions[o].value=_.parseDate(g.orConditions[o].value,"yyyy/MM/dd")}if(g.orConditions[o].valueType=="number"){g.orConditions[o].value=Number(g.orConditions[o].value)}if(g.orConditions[o].compare&&g.orConditions[o].value&&g.orConditions[o].attribute!=0){n=true;s=true}else{if(g.orConditions[o].engineer){g.orConditions[o].value=g.orConditions[o].engineerDesk.id+"_"+g.orConditions[o].engineer.id;n=true;s=true}else if(g.orConditions[o].attribute==="status"&&g.orConditions[o].compare){if(g.orConditions[o].compare=="$ne"){g.orConditions[o].value="canceled"}else{g.orConditions[o].value="canceled"}n=true;s=true}else{n=false;break}}}}else{n=true;s=true}for(var o=0;o<g.operations.length;o++){if(g.operations[o].valueType=="cascade_options"||g.operations[o].valueType=="multi_options"||g.operations[o].valueType=="options"){if(g.operations[o].valueOptions.value!="-"){g.operations[o].value=g.operations[o].valueOptions.value;a=true;r=true}else{r=false;break}}else if(g.operations[o].valueType=="date"){if(g.operations[o].value){var l=y("date")(g.operations[o].value,"yyyy/MM/dd").toString();g.operations[o].value=l;a=true;r=true}else{r=false;break}}else if(g.operations[o].valueType=="checkbox"){if(g.operations[o].compare){g.operations[o].value=g.operations[o].compare.indexOf("$eq_ticket_custom_field")>-1?"true":"false";a=true;r=true}else{r=false;break}}else if(g.operations[o].valueType=="date_to_date"){if(g.operations[o].startTime&&g.operations[o].endTime){var l=y("date")(g.operations[o].startTime,"yyyy/MM/dd").toString();var c=y("date")(g.operations[o].endTime,"yyyy/MM/dd").toString();var u=l+"-"+c;g.operations[o].value=u;a=true;r=true}else{r=false;break}}if(g.operations[o].attribute=="deleteChat"){a=true;r=true}if(g.operations[o].attribute=="noticeUser"){if(g.operations[o].noticeTitle&&g.operations[o].noticeContent&&g.operations[o].value){g.operations[o].value=g.operations[o].value.id;a=true;r=true}else{r=false;break}}else if(g.operations[o].attribute=="noticeGroup"){if(g.operations[o].noticeTitle&&g.operations[o].noticeContent&&g.operations[o].value){a=true;r=true}else{r=false;break}}else if(g.operations[o].attribute=="addCC"){if(g.operations[o].value.length>0){a=true;r=true}else{r=false;break}}else if(g.operations[o].attribute=="chatComment"){if(g.operations[o].value){a=true;r=true}else{r=false;break}}else if(g.operations[o].attribute=="deleteTicket"){if(!g.operations[o].value){r=false;break}if(g.operations[o].value!="其他原因"){a=true;r=true}else{if(g.operations[o].reason){a=true;r=true}else{r=false;break}}}else if(g.operations[o].attribute!="deleteChat"&&g.operations[o].attribute!="noticeEvaluate"&&g.operations[o].attribute!="noticeUser"&&g.operations[o].attribute!="noticeGroup"&&g.operations[o].attribute!="addCC"){if(g.operations[o].value&&g.operations[o].attribute!=0){a=true;r=true}else{if(g.operations[o].engineer){g.operations[o].value=g.operations[o].engineerDesk.id+"_"+g.operations[o].engineer.id;a=true;r=true}else{a=false;break}}}}if(!e){h.add("请填写程序名称","danger")}else if(t&&i&&n&&s&&a&&r&&e){g.automation.andConditions=[];g.automation.orConditions=[];g.automation.operations=[];for(var o=0;o<g.andConditions.length;o++){t=true;var d={};d.orderKey=g.andConditions[o].orderKey;d.attribute=g.andConditions[o].attribute;d.compare=g.andConditions[o].compare;d.tally=g.andConditions[o].tally;if(typeof g.andConditions[o].value=="object"){if(g.andConditions[o].attribute.indexOf("ticketcustomfield")>=0){if(g.andConditions[o].attribute.indexOf("ticketcustomfield_date")>=0){d.value=y("date")(g.andConditions[o].value,"yyyy/MM/dd").toString()}else{d.value=g.andConditions[o].value}}else if(g.andConditions[o].attribute=="via"){d.value=JSON.stringify(g.andConditions[o].value)}else{if(d.compare==="$in"||d.compare==="$not_in"){d.value="service_catalog_and_children_id_"+g.andConditions[o].value.id}else{d.value=g.andConditions[o].value.id}}}else{if(g.andConditions[o].attribute.indexOf("ticketcustomfield_checkbox")>=0){d.value="true"}else{if(d.compare==="$in"||d.compare==="$not_in"){if(d.attribute==="serviceCatalog"){d.value="service_catalog_and_children_id_"+g.andConditions[o].value}else{d.value=k.run(g.andConditions[o].value,d.compare)}}else{d.value=g.andConditions[o].value}}}g.automation.andConditions.push(d)}for(var o=0;o<g.orConditions.length;o++){var p={};p.orderKey=g.orConditions[o].orderKey;p.attribute=g.orConditions[o].attribute;p.compare=g.orConditions[o].compare;p.tally=g.orConditions[o].tally;if(typeof g.orConditions[o].value=="object"){if(g.orConditions[o].attribute.indexOf("ticketcustomfield")>=0){if(g.orConditions[o].attribute.indexOf("ticketcustomfield_date")>=0){p.value=y("date")(g.orConditions[o].value,"yyyy/MM/dd").toString()}else{p.value=g.orConditions[o].value}}else if(g.orConditions[o].attribute=="via"){p.value=JSON.stringify(g.orConditions[o].value)}else{if(p.compare==="$in"||p.compare==="$not_in"){p.value="service_catalog_and_children_id_"+g.orConditions[o].value.id}else{p.value=g.orConditions[o].value.id}}}else{if(g.orConditions[o].attribute.indexOf("ticketcustomfield_checkbox")>=0){p.value="true"}else{if(p.compare==="$in"||p.compare==="$not_in"){if(p.attribute==="serviceCatalog"){p.value="service_catalog_and_children_id_"+g.orConditions[o].value}else{p.value=k.run(g.orConditions[o].value,p.compare)}}else{p.value=g.orConditions[o].value}}}g.automation.orConditions.push(p)}for(var o=0;o<g.operations.length;o++){var f={};if(g.operations[o].attribute!="noticeEvaluate"){f.orderKey=g.operations[o].orderKey;if(g.operations[o].attribute=="noticeUser"||g.operations[o].attribute=="noticeGroup"){f.operate=g.operations[o].attribute}else{f.attribute=g.operations[o].attribute}if(typeof g.operations[o].value=="object"){if(g.operations[o].attribute=="addCC"||g.operations[o].attribute=="chatComment"){f.value=g.operations[o].value}else{f.value=g.operations[o].value.id}}else if(g.operations[o].attribute=="deleteTicket"){if(g.operations[o].value==="其他原因"){f.value=g.operations[o].reason}else{f.value=g.operations[o].value}}else{f.value=g.operations[o].value}if(g.operations[o].noticeTitle){f.noticeTitle=g.operations[o].noticeTitle}if(g.operations[o].noticeContent){f.noticeContent=g.operations[o].noticeContent}}else{f.orderKey=g.operations[o].orderKey;f.operate=g.operations[o].attribute}if(f.attribute==="chatComment"){f.value=JSON.stringify(g.operations[o].value)}g.automation.operations.push(f)}g.isClick=true;if(v.type=="clone"){if(g.automation.id){delete g.automation.id}}var m={automation:g.automation};m.automation.permissions=[];angular.forEach(g.fieldPermissions,function(e){role={};role.roleId=e.id;role.scanAble=e.scanAble;role.editAble=e.editAble;m.automation.permissions.push(role)});org.ewei.sdk.OpenAutomationApi().save(m).then({success:function(e){h.add("更新成功");g.backAutomation();g.isClick=false},fail:function(e){g.isClick=false;if(e!=null){h.add(y("translate")(e.error_description),"danger")}else{h.add("更新失败","danger")}for(var t=0;t<g.andConditions.length;t++){if(g.andConditions[t].attribute=="engineer.id"){delete g.andConditions[t]["value"]}}for(var t=0;t<g.orConditions.length;t++){if(g.orConditions[t].attribute=="engineer.id"){delete g.orConditions[t]["value"]}}for(var t=0;t<g.operations.length;t++){if(g.operations[t].attribute=="engineer.id"){delete g.operations[t]["value"]}}}})}else if(!i||!s||!r){h.add("请把信息填写完整","danger")}else if(!t||!n||!a){h.add("信息填写错误","danger")}}};g.saveAutomationDefault=function(e){var t=parseInt(e.tempValue==null?0:e.tempValue);if((e.type=="chat"||e.type=="weixin_chat")&&(t<8||t>2880)){h.add("自动结束会话时间在8-2880分钟之间","danger");return}else if(e.type=="ticket"&&(t<0||t>2e4)){h.add("自动关闭工单需在0到20000之间","danger");return}var i={automation:e};i.automation.permissions=[];angular.forEach(g.fieldPermissions,function(e){role={};role.roleId=e.id;role.scanAble=e.scanAble;role.editAble=e.editAble;i.automation.permissions.push(role)});org.ewei.sdk.OpenAutomationApi().updateAutomation(i).then({success:function(e){h.add("更新成功");g.backAutomation()},fail:function(){h.add("更新失败","danger")}})};g.checkCharCount=function(e){var t=$(e);if(t.val()!=null&&t.val()!=""){if(t.val().length>=t.attr("maxlength")){h.add(t.prev().text()+"不能超过"+t.attr("maxlength")+"个字符","danger")}}}}]);(function(e){"use strict";angular.module("eweiApp.ticket").controller("WebchatTriggerTaskListController",["$modal_","$scope","$rootScope","$state","$stateParams","$resource","$http","permissions","alertService","ticketListCustomOptions","ticketListFilterOptions","ticketListCustomGroupByOptions","ticketListCustomOrderByOptions","ConsoleConfig","ticketEvaluateService","serviceDesks","$filter","DefaultColumnWidth","coreModelService","ticketStatusCompareService","commonTools",function(e,I,m,t,L,i,c,n,g,s,D,a,r,v,o,l,P,x,h,y,u){I.ticketListCustom={};I.ticketAllListFilters=[];I.ticketAnyListFilters=[];if(n.hasPermission("ticket_view_manage")){I.viewPermissions=true}else{I.viewPermissions=false}if(L.id==0){if(m.customViewType!="private"){if(n.hasPermission("ticket_view_manage")){I.listCustomType={type:"public"}}else{I.listCustomType={type:"private"}}}else{I.listCustomType={type:"private"}}}I.ticketListCustom.isSystemDefault=L.isSystemDefault=="1"?true:false;var N=angular.copy(s);var d=L.id;function M(e){var t=I.ticketListCustom.filterEngineerDeskIds&&I.ticketListCustom.filterEngineerDeskIds.split(",");var i=0;if(e.$or!=undefined&&angular.isArray(e.$or)){for(var n=0;n<e.$or.length;n++){I.ticketAnyListFilters.push({firstValue:"",secondValue:"",thirdValue:"",firstOptions:I.ticketAllCustomField,secondOptions:"",thirdOptions:"",valueType:"select"});var s=e.$or[n];for(var a in s){for(var r in s[a]){if(r=="id"&&s[a][r].indexOf("copy_to_user_or_email_ticket_ids_")!=-1){I.ticketAnyListFilters[n].firstValue="copyTo";I.ticketAnyListFilters[n].secondValue=a;var o=s[a][r].replace("[${copy_to_user_or_email_ticket_ids_","").replace("!}]","");var l=o.split(",");I.ticketAnyListFilters[n].thirdValue=I.ticketCcValues(l);void 0;I.ticketAnyListFilters[n].secondOptions=D.secondFilterOptions("copyTo");q(I.ticketAnyListFilters[n],"copyTo");V(I.ticketAnyListFilters[n],"copyTo")}else if(r=="user.id"&&Object.prototype.toString.call(s[a][r])==="[object String]"&&s[a][r].indexOf("creator_service_desk_id_")!=-1){I.ticketAnyListFilters[n].firstValue="engineerGroup";I.ticketAnyListFilters[n].secondValue=a;I.ticketAnyListFilters[n].thirdValue=s[a][r].replace("[${creator_service_desk_id_","").replace("!}]","");I.ticketAnyListFilters[n].secondOptions=D.secondFilterOptions("engineerGroup");q(I.ticketAnyListFilters[n],"engineerGroup");V(I.ticketAnyListFilters[n],"engineerGroup")}else{I.ticketAnyListFilters[n].firstValue=r;if(r==="requester.userGroup.id"||r==="serviceDesk.id"){if(a!="$in"&&a!="$not_in"){I.ticketAnyListFilters[n].secondValue=a==="$eq"?"$in":"$not_in"}else{I.ticketAnyListFilters[n].secondValue=a}}else{I.ticketAnyListFilters[n].secondValue=a}if(typeof s[a][r]=="number"){I.ticketAnyListFilters[n].thirdValue=s[a][r]}else{if(r==="status"||r==="serviceDesk.id"){if(angular.isArray(s[a][r])){I.ticketAnyListFilters[n].thirdValue=s[a][r][0]}else{I.ticketAnyListFilters[n].thirdValue=s[a][r]}}else if(r==="ticketMetric.planSolvedAt"){var o=s[a][r].replace("[${remainder_plan_solved_minute_time_","").replace("!}]","");I.ticketAnyListFilters[n].thirdValue=parseInt(o)}else if(r==="requester.userGroup.id"){I.ticketAnyListFilters[n].thirdValue=s[a][r]}else{if(typeof s[a][r]==="boolean"){I.ticketAnyListFilters[n].thirdValue=true}else{I.ticketAnyListFilters[n].thirdValue=s[a][r].replace("[${service_catalog_and_children_id_","").replace("!}]","")}}}var c;for(var u in I.ticketAllCustomField){c=I.ticketAllCustomField[u].value;if(c&&c.indexOf(r)>-1){r=c;I.ticketAnyListFilters[n].isExist=true;break}}I.ticketAnyListFilters[n].firstValue=r;I.ticketAnyListFilters[n].secondOptions=D.secondFilterOptions(r);q(I.ticketAnyListFilters[n],r);V(I.ticketAnyListFilters[n],r)}if(r=="engineer.id"){R(t[i++],I.ticketAnyListFilters[n]);U(s[a][r],I.ticketAnyListFilters[n])}}}}}}function j(){var e=[{option:"状态",value:"status"}];var t=[];for(var i=0;i<I.useOptions.length;i++){for(var n=0;n<a.length;n++){if(I.useOptions[i].value==a[n].value){e.push(a[n])}}for(var n=0;n<r.length;n++){if(I.useOptions[i].value==r[n].value){t.push(r[n])}}}I.ticketListCustomGroupByOptions=e;I.ticketListCustomOrderByOptions=t}I.ticketCcValues=function(e){var t="";var i=false;var n=[];for(var s=0;s<e.length;s++){if(validEmail(e[s])){n.push({name:e[s]})}else{var a=parseInt(e[s]);t+=a+",";i=true}}if(i){n.push({ids:t})}return n};var R=function(e,s){if(e){c({url:"service_desk/"+e+".json",method:"GET",params:{}}).success(function(e,t,i,n){void 0;s.engineerDesk=e.json})}};var U=function(e,s){if(e==="${current_engineer_id}"){s.thirdValue={name:"（当前客服）",id:"${current_engineer_id}"}}else{c({url:"engineer/"+e+".json",method:"GET",params:{}}).success(function(e,t,i,n){s.thirdValue=e.json})}};I.selectedServiceDesk={serviceDesk:[]};l.query({_count:999,_do_count:false,_filter:'{"$ne":{"deleted":true}}',_fields:"id,name"},function(e){var t=e.serviceDesks||[];var i=false,n=false;for(var s=0;s<t.length;s++){if(t[s].name=="DEFAULT_SERVICE_DESK_NAME"){t[s].name=P("translate")(t[s].name);i=true}if(i&&n){break}}I.serviceDesks=t});I.showDefault=function(e){e.isShowDefault=!e.isShowDefault};I.setDefault=function(e){e.length=e.default_length};function p(){if(d>0){I.title="编辑自定义工单视图";c({url:"get_view_id.json",method:"GET",params:{id:d}}).success(function(e,t,i,n){userAginLogin(e);if(e.success){I.ticketListCustom=e.json;if(e.json.engineer){I.listCustomType={type:"private"}}else{I.listCustomType={type:"public"}}if(I.ticketListCustom.isSystemDefault){I.ticketListCustom.copyTitle=angular.copy(I.ticketListCustom.title)}I.ticketListCustom.title=P("translate")(I.ticketListCustom.title);if(I.ticketListCustom.filter!=undefined&&I.ticketListCustom.filter!=""&&!I.ticketListCustom.isSystemDefault){var s=JSON.parse(I.ticketListCustom.filter);var a;var r;if(I.ticketListCustom.customFieldFilter){a=JSON.parse(I.ticketListCustom.customFieldFilter)}else{a={}}if(a.$and&&a.$and.length===2&&a.$and[0].$and){if(s.$and&&s.$and.length===2&&s.$and[0].$and){s.$and[0].$and=s.$and[0].$and.concat(a.$and[0].$and);s.$and[1].$or=s.$and[1].$or.concat(a.$and[1].$or)}}if(s.$and&&s.$and.length===2&&s.$and[0].$and){r=s.$and[1];s=s.$and[0]}var o=0;var l=I.ticketListCustom.filterEngineerDeskIds&&I.ticketListCustom.filterEngineerDeskIds.split(",");if(s.$and!=undefined&&angular.isArray(s.$and)){for(var c=0;c<s.$and.length;c++){var u=s.$and[c];for(var d in u){if(d=="$or"){M(u)}else{I.ticketAllListFilters.push({firstValue:"",secondValue:"",thirdValue:"",firstOptions:I.ticketAllCustomField,secondOptions:"",thirdOptions:"",valueType:"select",engineerDesk:""});for(var p in u[d]){var f=u[d][p];if(p=="id"&&f.indexOf("copy_to_user_or_email_ticket_ids_")!=-1){I.ticketAllListFilters[c].firstValue="copyTo";I.ticketAllListFilters[c].secondValue=d;var m=u[d][p].replace("[${copy_to_user_or_email_ticket_ids_","").replace("!}]","");var g=m.split(",");I.ticketAllListFilters[c].thirdValue=I.ticketCcValues(g);I.ticketAllListFilters[c].secondOptions=D.secondFilterOptions("copyTo");q(I.ticketAllListFilters[c],"copyTo");V(I.ticketAllListFilters[c],"copyTo")}else if(p=="user.id"&&Object.prototype.toString.call(f)==="[object String]"&&f.indexOf("creator_service_desk_id_")!=-1){I.ticketAllListFilters[c].firstValue="engineerGroup";I.ticketAllListFilters[c].secondValue=d;I.ticketAllListFilters[c].thirdValue=u[d][p].replace("[${creator_service_desk_id_","").replace("!}]","");I.ticketAllListFilters[c].secondOptions=D.secondFilterOptions("engineerGroup");q(I.ticketAllListFilters[c],"engineerGroup");V(I.ticketAllListFilters[c],"engineerGroup")}else{I.ticketAllListFilters[c].firstValue=p;if(p==="requester.userGroup.id"||p==="serviceDesk.id"){if(d!="$in"&&d!="$not_in"){I.ticketAllListFilters[c].secondValue=d==="$eq"?"$in":"$not_in"}else{I.ticketAllListFilters[c].secondValue=d}}else{I.ticketAllListFilters[c].secondValue=d}if(typeof u[d][p]=="number"){I.ticketAllListFilters[c].thirdValue=u[d][p]}else{if(p==="status"||p==="serviceDesk.id"){if(angular.isArray(u[d][p])){I.ticketAllListFilters[c].thirdValue=u[d][p][0]}else{I.ticketAllListFilters[c].thirdValue=u[d][p]}}else if(p==="ticketMetric.planSolvedAt"){var m=u[d][p].replace("[${remainder_plan_solved_minute_time_","").replace("!}]","");I.ticketAllListFilters[c].thirdValue=parseInt(m)}else if(p==="requester.userGroup.id"){I.ticketAllListFilters[c].thirdValue=u[d][p]}else{if(typeof u[d][p]==="boolean"){I.ticketAllListFilters[c].thirdValue=true}else{I.ticketAllListFilters[c].thirdValue=u[d][p].replace("[${service_catalog_and_children_id_","").replace("!}]","")}}}var v;for(var h in I.ticketAllCustomField){v=I.ticketAllCustomField[h].value;if(v&&v.indexOf(p)>-1){p=v;I.ticketAllListFilters[c].isExist=true;break}}I.ticketAllListFilters[c].firstValue=p;I.ticketAllListFilters[c].secondOptions=D.secondFilterOptions(p);q(I.ticketAllListFilters[c],p);V(I.ticketAllListFilters[c],p)}if(p=="engineer.id"){R(l[o++],I.ticketAllListFilters[c]);U(u[d][p],I.ticketAllListFilters[c])}}}}}}M(r||s)}if(L.type=="copy"){I.ticketListCustom.id="";I.ticketListCustom.title="";I.ticketListCustom.isSystemDefault=0;I.ticketListCustom.isCustomField=1;I.ticketListCustom.position=20}var y=JSON.parse(I.ticketListCustom.ticketCustomFields);for(var c=0;c<y.length;c++){if(y[c].systemFieldKey=="priority"){N.push({option:y[c].title,value:"priority",width:"w150",isDefault:true,default_length:y[c].default_length})}else if(y[c].systemFieldKey=="ticket_type"){N.push({option:y[c].title,value:"ticketType.name",width:"w150",isDefault:true,default_length:y[c].default_length})}else if(y[c].systemFieldKey=="service_catalog"){N.push({option:y[c].title,value:"serviceCatalog.id",width:"w150",isDefault:true,default_length:y[c].default_length})}else if(y[c].systemFieldKey=="subject"){N.push({option:y[c].title,value:"subject",width:"w150",isDefault:true,default_length:y[c].default_length})}else if(y[c].systemFieldKey=="tags"){N.push({option:y[c].title,value:"tags",width:"w150",isDefault:true,default_length:y[c].default_length})}}var _=[];var k=[];if(I.ticketListCustom.fields!=undefined){var C=I.ticketListCustom.fields.split(",");if(I.ticketListCustom.fieldsLength){var b=I.ticketListCustom.fieldsLength.split(",")}for(var d=0;d<C.length;d++){for(var c=0;c<N.length;c++){if(C[d]==N[c].value){if(b&&b.length){N[c].length=b[d]}_.push(N[c]);break}}}}if(I.ticketListCustom.otherFields!=undefined){var w=I.ticketListCustom.otherFields.split(",");if(I.ticketListCustom.otherFieldsLength){var T=I.ticketListCustom.otherFieldsLength.split(",")}for(var d=0;d<w.length;d++){for(var c=0;c<N.length;c++){if(w[d]==N[c].value){if(T&&T.length){N[c].length=T[d]}_.push(N[c]);break}}}}if(I.ticketListCustom.customFields!=undefined&&I.ticketListCustom.customFields!=""&&I.ticketListCustom.ticketCustomFields!=undefined){var S=JSON.parse(I.ticketListCustom.customFields);if(I.ticketListCustom.customFieldsLength){var F=I.ticketListCustom.customFieldsLength.split(",")}for(var c=0;c<S.length;c++){for(var d=0;d<y.length;d++){if(y[d].title==S[c].title){if(y[d].systemFieldKey==null||y[d].systemFieldKey==""){var A={option:S[c].title,value:S[c].id,default_length:y[c].default_length};if(F&&F.length){A.length=F[c]}_.push(A);break}}}}}if(I.ticketListCustom.sortFields){var E=JSON.parse(I.ticketListCustom.sortFields)}if(E&&E.length>0){var $=[];angular.forEach(E,function(e){for(var t=0;t<_.length;t++){if(_[t].value==e.id){$.push(_[t]);break}}});_=$}for(var c=0;c<N.length;c++){var m=true;for(var d=0;d<_.length;d++){if(_[d].value==N[c].value){m=false;break}}if(m){k.push(N[c])}}if(I.ticketListCustom.ticketCustomFields!=undefined&&I.ticketListCustom.ticketCustomFields!=""){var y=JSON.parse(I.ticketListCustom.ticketCustomFields);for(var c=0;c<y.length;c++){if(_==undefined||JSON.stringify(_).indexOf(y[c].title)==-1){if(!y[c].systemFieldKey&&(y[c].scan_able===1&&!I.ticketListCustom.isSystemDefault||I.ticketListCustom.isSystemDefault)){k.push({option:y[c].title,value:y[c].id,default_length:y[c].default_length})}}}}if(!I.ticketListCustom.engineer){var O=[];angular.forEach(I.ticketListCustom.serviceDesks,function(e){O.push(e.id)});I.selectedServiceDesk.serviceDesk=O}angular.forEach(_,function(e){if(e.isDefault){e.length=e.length||e.default_length||x.ticketFields[e.value];e.default_length=e.default_length||x.ticketFields[e.value]}else{e.length=e.length||e.default_length||x["ticketDefault"];e.default_length=e.default_length||x["ticketDefault"]}});angular.forEach(k,function(e){if(e.isDefault){e.length=e.length||e.default_length||x.ticketFields[e.value];e.default_length=e.default_length||x.ticketFields[e.value]}else{e.length=e.length||e.default_length||x["ticketDefault"];e.default_length=e.default_length||x["ticketDefault"]}});I.noUseOptions=k;I.useOptions=_;void 0;void 0;j()}})}else{var a=[];var r=[];var e="";var t="";var i="";var n="";I.title="添加自定义工单视图";I.ticketListCustom.isSystemDefault=0;I.ticketListCustom.isCustomField=1;I.ticketListCustom.position=20;try{e=JSON.parse(localStorage["systemFieldSubject"]).title;n=JSON.parse(localStorage["systemFieldTags"]).title}catch(e){}a.push({option:e,value:"subject",width:"w500",isDefault:true},{option:"编号",value:"no",width:"w100",isDefault:true},{option:"客户",value:"requester.name",width:"w200",isDefault:true},{option:"处理人",value:"engineer.user.name",width:"w200",isDefault:true},{option:n,value:"tags",width:"w150",isDefault:true},{option:"创建于",value:"createdAt",width:"w200",isDefault:true});for(var s=0;s<N.length;s++){if(a==undefined||(JSON.stringify(a).indexOf(N[s].value)==-1||JSON.stringify(a).indexOf(N[s].option)==-1)){r.push(N[s])}}c.get("custom_field.json?scope=ticket&active=true").success(function(e,t){userAginLogin(e);var i=e.json;I.ticketListCustom.ticketCustomFields=i;for(var n=0,s=i.length;n<s;n++){if(i[n].systemFieldKey=="priority"){r.push({option:i[n].title,value:"priority",width:"w150",isDefault:true});N.push({option:i[n].title,value:"priority",width:"w150",isDefault:true})}else if(i[n].systemFieldKey=="ticket_type"){r.push({option:i[n].title,value:"ticketType.name",width:"w150",isDefault:true});N.push({option:i[n].title,value:"ticketType.name",width:"w150",isDefault:true})}else if(i[n].systemFieldKey=="service_catalog"){r.push({option:i[n].title,value:"serviceCatalog.id",width:"w150",isDefault:true});N.push({option:i[n].title,value:"serviceCatalog.id",width:"w150",isDefault:true})}else if(i[n].systemFieldKey=="subject"){N.push({option:i[n].title,value:"subject",width:"w500",isDefault:true})}else if(i[n].systemFieldKey=="ticket_description"||i[n].systemFieldKey=="tags"){continue}else{r.push({option:i[n].title,value:i[n].id})}}angular.forEach(a,function(e){if(e.isDefault){e.length=e.length||e.default_length||x.ticketFields[e.value];e.default_length=e.default_length||x.ticketFields[e.value]}else{e.length=e.length||e.default_length||x["ticketDefault"];e.default_length=e.default_length||x["ticketDefault"]}});angular.forEach(r,function(e){if(e.isDefault){e.length=e.length||e.default_length||x.ticketFields[e.value];e.default_length=e.default_length||x.ticketFields[e.value]}else{e.length=e.length||e.default_length||x["ticketDefault"];e.default_length=e.default_length||x["ticketDefault"]}})});I.noUseOptions=r;I.useOptions=a;j()}}function f(){var l=[];c.get("custom_field.json?scope=ticket&active=true").success(function(e,t){angular.forEach(e.json,function(e,t,i){var n={};var s="";if(e.systemFieldKey=="priority"){n={option:"工单："+e.title,value:"priority",valueType:"select"}}else if(e.systemFieldKey=="ticket_type"){n={option:"工单："+e.title,value:"ticketType",valueType:"select"}}else if(e.systemFieldKey=="service_catalog"){n={option:"工单："+e.title,value:"serviceCatalog",valueType:"servicecatalog"}}else if(e.systemFieldKey=="subject"){n={option:"工单："+e.title,value:"subject",valueType:"subject"}}else if(e.systemFieldKey=="tags"){n={option:"工单："+e.title,value:"tags",valueType:"text"}}else if(e.systemFieldKey=="ticket_description"){return}else if(e.type=="date_to_date"){return}else if(e.type=="date_time"){n={option:"工单：自定义字段-"+e.title,value:"ticketcustomfield_"+e.type+"_"+e.id,valueType:"date_time"}}else{n={option:"工单：自定义字段-"+e.title,value:"ticketcustomfield_"+e.type+"_"+e.id,valueType:"text"}}if(e.type=="text"||e.type=="email"||e.type=="regexp"||e.type=="textarea"||e.type=="number"||e.type=="decimal"){n.valueType="text"}else if(e.type=="date"){n.valueType=e.type;n.start=false}else if(e.type=="date_time"){n.valueType=e.type}else if(e.type=="options"){if(e.customFieldOptions){if(e.systemFieldKey){n.valueType="select";var a=angular.fromJson(e.customFieldOptions);for(var r=0,o=a.length;r<o;r++){a[r].option=a[r].name}n.valueOptions=a}else{n.valueType="options";if(e.customFieldOptions){n.valueOptions=e}}}}else if(e.type=="cascade_options"){if(e.systemFieldKey=="service_catalog"){n.valueType="serviceCatalog"}else{n.valueType="cascade_options";if(e.customFieldOptions){n.valueOptions=e}}}else if(e.type=="multi_options"){n.valueType="multi_options";if(e.customFieldOptions){n.valueOptions=e}}else if(e.type=="checkbox"){n.valueType="checkbox"}else{n.valueType="text"}n.edit_able=e.edit_able;if(s!=""){n.startTimeForm=false;n.endTimeForm=false;l.push(s)}else{if(!e.systemFieldKey){l.push(n)}}});I.ticketAllCustomField=D.firstFilterOptions("all").concat(l);p();I.datepickers={startForm:false,startTo:false,updateFrom:false,updateTo:false};I.open=function(e,t,i){e.preventDefault();e.stopPropagation();t[i].start=!t[i].start};I.timeFrameOpen=function(e,t,i,n){e.preventDefault();e.stopPropagation();t[i][n]=!t[i][n]}})}function _(){f()}_();I.toAddFilterOption=function(e){var t;if(e==="all"){t=I.ticketAllListFilters}else{t=I.ticketAnyListFilters}if(t.length>6){g.add("最多添加7个条件","danger");return}var i=I.ticketAllCustomField;var n="";var s="";var a="";var r="";try{n=JSON.parse(localStorage["systemFieldSubject"]).title;s=JSON.parse(localStorage["systemFieldPriority"]).title;a=JSON.parse(localStorage["systemFieldServiceCatalog"]).title;r=JSON.parse(localStorage["systemFieldTicketType"]).title}catch(e){}for(var o=0;o<i.length;o++){if(i[o].value=="subject"){i[o].option="工单:"+n}else if(i[o].value=="priority"){i[o].option="工单:"+s}else if(i[o].value=="ticketType.id"){i[o].option="工单:"+r}else if(i[o].value=="serviceCatalog.id"){i[o].option="工单:"+a}}t.push({firstValue:"",secondValue:"",thirdValue:"",firstOptions:i,secondOptions:"",thirdOptions:"",valueType:"select",isExist:true})};I.toDeleteAllFilterOption=function(e){var t=I.ticketAllListFilters;t.splice(e,1)};I.toDeleteAnyFilterOption=function(e){var t=I.ticketAnyListFilters;t.splice(e,1)};I.firstAllFilterOptionChange=function(e,t){var i=I.ticketAllListFilters[e].firstValue;I.ticketAllListFilters[e].secondOptions=D.secondFilterOptions(i);I.ticketAllListFilters[e].thirdValue="";q(I.ticketAllListFilters[e],i);V(I.ticketAllListFilters[e],i)};I.firstAnyFilterOptionChange=function(e,t){var i=I.ticketAnyListFilters[e].firstValue;I.ticketAnyListFilters[e].secondOptions=D.secondFilterOptions(i);I.ticketAnyListFilters[e].thirdValue="";q(I.ticketAnyListFilters[e],i);V(I.ticketAnyListFilters[e],i)};var V=function(e,t){if(t=="serviceCatalog.id"){e.valueType="serviceCatalog"}else if(t=="serviceDesk.id"||t=="engineerGroup"){e.valueType="serviceDesk"}else if(t=="requester.id"){e.valueType="requester"}else if(t=="user.id"){e.valueType="user"}else if(t=="engineer.id"){e.valueType="engineer"}else if(t=="requester.userGroup.id"){e.valueType="userGroup"}else if(t=="subject"||t=="tags"){e.valueType="text"}else if("createdAt,ticketMetric.responseAt,ticketMetric.solvedAt,lastReply,customerLastReply,engineerLastReply,ticketMetric.pausedAt,ticketMetric.planSolvedAt".indexOf(t)!=-1){e.valueType="number"}else if(t=="copyTo"){e.valueType="copyTo"}else{if(t.indexOf("ticketcustomfield")===-1){e.valueType="select"}}};I.statusDelete=function(n){if(n.firstValue&&n.firstValue=="status"&&n.thirdValue!="deleted"){angular.forEach(n.thirdOptions,function(e,t,i){if(e.value=="deleted"){n.thirdOptions.splice(t,1)}})}};function k(){var e;if(localStorage){try{e=angular.fromJson(localStorage.systemFieldPriority);angular.isObject(e)&&(e.customFieldOptions=angular.fromJson(e.customFieldOptions));if(angular.isArray(e.customFieldOptions)){for(var t=0;t<e.customFieldOptions.length;t++){e.customFieldOptions[t].option=e.customFieldOptions[t].name}return e.customFieldOptions}}catch(e){}}return[{value:"P1",option:"P1"},{value:"P2",option:"P2"},{value:"P3",option:"P3"},{value:"P4",option:"P4"},{value:"P5",option:"P5"}]}var q=function(o,e){if(e=="status"){o.thirdOptions=[{value:"new",option:"未分派"},{value:"assigned",option:"已分派"},{value:"open",option:"处理中"},{value:"solved",option:"处理完毕"},{value:"closed",option:"关闭"},{value:"pending",option:"暂停"},{value:"suspended",option:"隔离"}]}else if(e=="priority"){o.thirdOptions=k()}else if(e=="evaluate.score"){o.thirdOptions=[{option:"1分",value:"1"},{option:"2分",value:"2"},{option:"3分",value:"3"},{option:"4分",value:"4"},{option:"5分",value:"5"}]}else if(e=="via.channel"){o.thirdOptions=[{option:"Email收件箱",value:"email"},{option:"网页表单(feedback)",value:"form"},{option:"在线交谈/远程协助",value:"chat"},{option:"微信客服",value:"weixin"},{option:"CTI客服",value:"cti"},{option:"帮助中心",value:"helpcenter"},{option:"客服创建",value:"console"},{option:"API工单渠道",value:"api"}]}else if(e=="ticketType.id"){c({url:"ticket_type.json",method:"GET",params:{_count:12332,_do_count:false,_fields:"id,name,description,isDefault"}}).success(function(e,t,i,n){if(e.ticketTypes){var s=[];for(var a=0,r=e.ticketTypes.length;a<r;a++){s.push({option:e.ticketTypes[a].name,value:e.ticketTypes[a].id})}o.thirdOptions=s}})}else{if(e.indexOf("ticketcustomfield")>-1){for(var t in o.firstOptions){var i=o.firstOptions[t];if(i.value===e){if(i.valueOptions){o.customField=angular.copy(i.valueOptions)}if(o.thirdValue&&o.customField){o.customField.value=o.thirdValue}if(i.valueType==="date"){o.thirdValue=P("date")(o.thirdValue,"yyyy/MM/dd").toString();o.thirdValue=u.parseDate(o.thirdValue,"yyyy/MM/dd")}o.edit_able=i.edit_able;o.valueType=i.valueType;break}}}}};I.listCustom=function(){t.go("system_setting.detail",{uri:"ticket_list_custom",settingType:"ticket"})};I.orderByChange=function(){I.ticketListCustom.order="asc"};function C(){var e={$and:[]};var t={$or:[]};var i=I.ticketAllListFilters;var n="";var s={$and:[]};var a={$or:[]};if(i!=undefined&&angular.isArray(i)&&i.length>0){for(var r=0;r<i.length;r++){if(!i[r].isExist){continue}if(i[r].valueType=="cascade_options"||i[r].valueType=="multi_options"||i[r].valueType=="options"){i[r].thirdValue=i[r].customField.value}if(i[r].valueType=="checkbox"){i[r].thirdValue=true}if(i[r].thirdValue==undefined||i[r].thirdValue==""||i[r].secondValue==undefined||i[r].secondValue==""){return false}var o={};var l={};if(i[r].firstValue=="copyTo"){var c="";for(var u=0;u<i[r].thirdValue.length;u++){if(i[r].thirdValue[u].id&&i[r].thirdValue[u].id>0){c+=i[r].thirdValue[u].id}else{c+=i[r].thirdValue[u].name}if(i[r].thirdValue.length-1!=u){c+=","}}l.id="[${copy_to_user_or_email_ticket_ids_"+c+"!}]";o[i[r].secondValue]=l;e["$and"].push(o)}else if(i[r].firstValue=="ticketMetric.planSolvedAt"){l["ticketMetric.planSolvedAt"]="[${remainder_plan_solved_minute_time_"+i[r].thirdValue+"!}]";o[i[r].secondValue]=l;e["$and"].push(o)}else if(i[r].firstValue=="engineerGroup"){var c=angular.isObject(i[r].thirdValue)?i[r].thirdValue.id:i[r].thirdValue;l["user.id"]="[${creator_service_desk_id_"+c+"!}]";o[i[r].secondValue]=l;e["$and"].push(o)}else if(i[r].firstValue.indexOf("ticketcustomfield")>-1){var d=i[r].firstValue.substr(i[r].firstValue.lastIndexOf("_")+1);if(i[r].valueType=="date"){l[d]=P("date")(i[r].thirdValue,"yyyy/MM/dd").toString()}else{l[d]=i[r].thirdValue}o[i[r].secondValue]=l;s["$and"].push(o)}else{if(i[r].secondValue==="$in"||i[r].secondValue==="$not_in"){if(i[r].firstValue==="status"){l[i[r].firstValue]=y.run(i[r].thirdValue,i[r].secondValue)}else if(i[r].firstValue==="requester.userGroup.id"){l[i[r].firstValue]=i[r].thirdValue}else if(i[r].firstValue==="serviceDesk.id"){var p="";if(angular.isObject(i[r].thirdValue)){p=i[r].thirdValue.id}else{p=i[r].thirdValue}l[i[r].firstValue]=(p+"").split(" ")}else{l[i[r].firstValue]="[${service_catalog_and_children_id_"+(i[r].thirdValue.id?i[r].thirdValue.id:i[r].thirdValue)+"!}]"}}else{l[i[r].firstValue]=angular.isObject(i[r].thirdValue)?i[r].thirdValue.id:i[r].thirdValue}o[i[r].secondValue]=l;e["$and"].push(o)}if(i[r].firstValue=="engineer.id"){if(i[r].thirdValue.id!="${current_engineer_id}"){n+=i[r].engineerDesk.id+","}}}I.filterEngineerDeskIds=n.substring(0,n.length-1)}var f=I.ticketAnyListFilters;if(f!=undefined&&angular.isArray(f)&&f.length>0){for(var r=0;r<f.length;r++){if(!f[r].isExist){continue}if(f[r].valueType=="cascade_options"||f[r].valueType=="multi_options"||f[r].valueType=="options"){f[r].thirdValue=f[r].customField.value}if(f[r].valueType=="checkbox"){f[r].thirdValue=true}if(f[r].thirdValue==undefined||f[r].thirdValue==""||f[r].secondValue==undefined||f[r].secondValue==""){return false}var o={};var l={};if(f[r].firstValue=="copyTo"){var c="";for(var u=0;u<f[r].thirdValue.length;u++){if(f[r].thirdValue[u].id&&f[r].thirdValue[u].id>0){c+=f[r].thirdValue[u].id}else{c+=f[r].thirdValue[u].name}if(f[r].thirdValue.length-1!=u){c+=","}}l.id="[${copy_to_user_or_email_ticket_ids_"+c+"!}]";o[f[r].secondValue]=l;t["$or"].push(o)}else if(f[r].firstValue=="ticketMetric.planSolvedAt"){l["ticketMetric.planSolvedAt"]="[${remainder_plan_solved_minute_time_"+f[r].thirdValue+"!}]";o[f[r].secondValue]=l;t["$or"].push(o)}else if(f[r].firstValue=="engineerGroup"){var c=angular.isObject(f[r].thirdValue)?f[r].thirdValue.id:f[r].thirdValue;l["user.id"]="[${creator_service_desk_id_"+c+"!}]";o[f[r].secondValue]=l;t["$or"].push(o)}else if(f[r].firstValue.indexOf("ticketcustomfield")>-1){var d=f[r].firstValue.substr(f[r].firstValue.lastIndexOf("_")+1);if(f[r].valueType=="date"){l[d]=P("date")(f[r].thirdValue,"yyyy/MM/dd").toString()}else{l[d]=f[r].thirdValue}o[f[r].secondValue]=l;a["$or"].push(o)}else{if(f[r].secondValue==="$in"||f[r].secondValue==="$not_in"){if(f[r].firstValue==="status"){l[f[r].firstValue]=y.run(f[r].thirdValue,f[r].secondValue)}else if(f[r].firstValue==="requester.userGroup.id"){l[f[r].firstValue]=f[r].thirdValue}else if(f[r].firstValue==="serviceDesk.id"){var p="";if(angular.isObject(f[r].thirdValue)){p=f[r].thirdValue.id}else{p=f[r].thirdValue}l[f[r].firstValue]=(p+"").split(" ")}else{l[f[r].firstValue]="[${service_catalog_and_children_id_"+(f[r].thirdValue.id?f[r].thirdValue.id:f[r].thirdValue)+"!}]"}}else{l[f[r].firstValue]=angular.isObject(f[r].thirdValue)?f[r].thirdValue.id:f[r].thirdValue}o[f[r].secondValue]=l;t["$or"].push(o)}if(f[r].firstValue=="engineer.id"){if(f[r].thirdValue.id!="${current_engineer_id}"){n+=f[r].engineerDesk.id+","}}}I.filterEngineerDeskIds=n.substring(0,n.length-1)}var m={filter:angular.toJson({$and:[e,t]}),customFieldFilter:angular.toJson({$and:[s,a]})};return m}var b=function(){var e="";var t={$and:[]};var i=I.ticketAllListFilters;if(i!=undefined&&angular.isArray(i)&&i.length>0){var n="";e+='{"$and":[';for(var s=0;s<i.length;s++){if(i[s].thirdValue==undefined||i[s].thirdValue==""||i[s].secondValue==undefined||i[s].secondValue==""){return false}if(i[s].firstValue=="serviceCatalog.id"||i[s].firstValue=="serviceDesk.id"||i[s].firstValue=="requester.id"||i[s].firstValue=="requester.userGroup.id"||i[s].firstValue=="user.id"){if(typeof i[s].thirdValue=="object"){e+='{"'+i[s].secondValue+'":{"'+i[s].firstValue+'":'+i[s].thirdValue.id+"}},"}else{e+='{"'+i[s].secondValue+'":{"'+i[s].firstValue+'":'+i[s].thirdValue+"}},"}}else if(i[s].firstValue=="copyTo"){var a="";for(var r=0;r<i[s].thirdValue.length;r++){if(i[s].thirdValue[r].id&&i[s].thirdValue[r].id>0){a+=i[s].thirdValue[r].id}else{a+=i[s].thirdValue[r].name}if(i[s].thirdValue.length-1!=r){a+=","}}e+='{"'+i[s].secondValue+'":{"id":[${copy_to_user_or_email_ticket_ids_'+a+"!}]}},"}else if(i[s].firstValue=="ticketMetric.planSolvedAt"){e+='{"'+i[s].secondValue+'":{"ticketMetric.planSolvedAt":[${remainder_plan_solved_minute_time_'+i[s].thirdValue+"!}]}},"}else if(typeof i[s].thirdValue=="string"){e+='{"'+i[s].secondValue+'":{"'+i[s].firstValue+'":"'+i[s].thirdValue+'"}},'}else if(typeof i[s].thirdValue=="number"){e+='{"'+i[s].secondValue+'":{"'+i[s].firstValue+'":'+i[s].thirdValue+"}},"}else if(i[s].firstValue=="engineer.id"){e+='{"'+i[s].secondValue+'":{"'+i[s].firstValue+'":'+i[s].thirdValue.id+"}},";n+=i[s].engineerDesk.id+","}}I.filterEngineerDeskIds=n.substring(0,n.length-1)}var o=I.ticketAnyListFilters;if(o!=undefined&&angular.isArray(o)&&o.length>0){e+='{"$or":[';for(var s=0;s<o.length;s++){if(o[s].thirdValue==undefined||o[s].thirdValue==""||o[s].secondValue==undefined||o[s].secondValue==""){return false}if(o[s].firstValue=="serviceCatalog.id"||o[s].firstValue=="serviceDesk.id"||o[s].firstValue=="requester.id"||o[s].firstValue=="requester.userGroup.id"||i[s].firstValue=="engineer.id"){if(typeof o[s].thirdValue=="object"){e+='{"'+o[s].secondValue+'":{"'+o[s].firstValue+'":'+o[s].thirdValue.id+"}},"}else{e+='{"'+o[s].secondValue+'":{"'+o[s].firstValue+'":'+o[s].thirdValue+"}},"}}else if(typeof o[s].thirdValue=="string"){e+='{"'+o[s].secondValue+'":{"'+o[s].firstValue+'":"'+o[s].thirdValue+'"}},'}else if(typeof o[s].thirdValue=="number"){e+='{"'+o[s].secondValue+'":{"'+o[s].firstValue+'":'+o[s].thirdValue+"}},"}}e+="]}";e=e.replace("},]","}]")}if(i!=undefined&&angular.isArray(i)&&i.length>0){e+="]}";e=e.replace("},]","}]")}return e};I.cancelEdit=function(){t.go("system_setting.detail",{uri:"ticket_list_custom",settingType:"ticket"})};I.updateTicketListCustom=function(s){if(s.title==""||s.title==undefined){g.add("请输入标题","danger");return}if(I.useOptions&&I.useOptions.length<4){g.add("显示列不足4个","danger");return}var a=C();if(!a&&!s.isSystemDefault&&I.ticketAllListFilters.length>0){g.add("符合条件信息填写完整","danger");return}c.get("list_views.json?type=ticket").success(function(e,t){var i=e.json;for(var n=0;n<i.length;n++){if(i[n].title==s.title&&s.id!=i[n].id){g.add("标题已经使用","danger");return}}w(a)})};function w(e){var i=angular.copy(I.ticketListCustom);if(I.ticketListCustom.id!=undefined){i.id=I.ticketListCustom.id}if(I.listCustomType.type=="private"&&!I.ticketListCustom.isSystemDefault){i.engineer={id:v.engineer.id}}else{if(i.engineer){delete i.engineer}var t=[];angular.forEach(I.selectedServiceDesk.serviceDesk,function(e){t.push({id:e})});i.serviceDesks=t}var n="";var s=[];i.title=I.ticketListCustom.title;i.active=true;i.orderBy=I.ticketListCustom.orderBy;i.groupBy=I.ticketListCustom.groupBy;i.order=I.ticketListCustom.orderBy?I.ticketListCustom.order:null;if(I.ticketListCustom.isSystemDefault){i.filter=I.ticketListCustom.filter}else{i.filter=e.filter;i.customFieldFilter=e.customFieldFilter;i.filterEngineerDeskIds=I.filterEngineerDeskIds}i.type="ticket";i.isCustomField=1;var a="id,status,";var r=[x.ticketFields["id"],x.ticketFields["status"]],o=[],l=[];var c=I.useOptions;var u=[];var d;for(var p=0;p<c.length;p++){d={};if(!Number(c[p].length)||c[p].length<=0){g.add("列宽必须为正数","danger");return false}if(N!=undefined&&JSON.stringify(N).indexOf(c[p].value)!=-1&&c[p].value!="tags"&&c[p].value!="copyTo"&&c[p].isDefault==true){a+=c[p].value+",";r.push(c[p].length);d.type="system"}else if(c[p].value=="tags"&&c[p].isDefault==true){n+=c[p].value+",";l.push(c[p].length);d.type="other"}else if(c[p].value=="copyTo"&&c[p].isDefault==true){n+=c[p].value+",";l.push(c[p].length);d.type="other"}else{s.push({title:c[p].option,id:c[p].value});o.push(c[p].length);d.type="custom"}d.id=c[p].value;u.push(d)}i.fields=a.substring(0,a.length-1);i.fieldsLength=r.join(",");i.otherFields=n.substring(0,n.length-1);i.otherFieldsLength=l.join(",");i.customFields=s.length>0?JSON.stringify(s):null;i.customFieldsLength=o.join(",");i.ticketCustomFields=null;i.sortFields=u.length>0?JSON.stringify(u):null;I.disabledBtn=true;if(i.isSystemDefault){i.title=angular.copy(I.ticketListCustom.copyTitle);delete i.copyTitle}var f={view:i};org.ewei.sdk.OpenViewApi().saveOrUpdate(f).then({success:function(e){var t=I.listCustomType.type;if(I.ticketListCustom.isSystemDefault){t="default"}h.config.route.put("system.setting.ticket_list_custom.showType",t);m.customViewType=t;if(h.detail.ticket.views.get(i.id)){h.detail.ticket.views.put(i.id,i)}I.cancelEdit()},fail:function(e){I.disabledBtn=false;g.add("更新失败","danger")}})}I.sortableOptions={connectWith:".sortable",beforeStop:function(e,t){var i=t.originalPosition.left;var n=t.position.left},stop:function(e,t){j()}};I.useSortableOptions={connectWith:".sortable",beforeStop:function(e,t){if(t.item&&t.item.sortable&&t.item.sortable.model&&t.item.sortable.model.value=="subject"){var i=t.originalPosition.left;var n=t.position.left;if(i-n>50){t.item.sortable.cancel();g.add("主题必须显示","danger")}}else{var i=t.originalPosition.left;var n=t.position.left;if(i-n>50&&I.useOptions.length<5){t.item.sortable.cancel();g.add("显示的列不能少于4个","danger")}}},stop:function(){j()}}}])})(org.ewei);angular.module("eweiApp.ticket").controller("editWebchatTriggerController",["$rootScope","$modal_","$scope","$state","$stateParams","$resource","$http","alertService","permissions","$filter","allConditionOptionsTriggerWebchat","anyConditionOptionsTriggerWebchat","executeOptionsTriggerWebchat","triggerCompareOptionsWebchat","$timeout","ticketEvaluateService","commonTools","ticketStatusCompareService","ConsoleConfig",function(e,t,y,i,_,n,s,k,a,C,r,o,l,c,u,d,p,b,f){y.andConditionOptions=angular.copy(r);y.orConditionOptions=angular.copy(o);y.triggerTask={andConditions:[],orConditions:[],operations:[]};y.andConditions=[{attribute:"-1",tally:"and"}];y.orConditions=[{attribute:"-1",tally:"or"}];y.operations=[{attribute:"-1",options:l}];y.compareOptions=angular.copy(c);y.operationOptions=l;y.operations=[{attribute:"-1",edit_able:true,options:l}];var m=function(e,t,i){if(e=="and"){for(var n=0,s=y.andConditionOptions.length;n<s;n++){if(y.andConditionOptions[n].value==i){y.andConditions[t].valueType=y.andConditionOptions[n].valueType;y.andConditions[t].valueOptions=angular.copy(y.andConditionOptions[n].valueOptions);y.andConditions[t].edit_able=y.andConditionOptions[n].edit_able}}}else if(e=="or"){for(var n=0,s=y.orConditionOptions.length;n<s;n++){if(y.orConditionOptions[n].value==i){y.orConditions[t].valueType=y.orConditionOptions[n].valueType;y.orConditions[t].valueOptions=angular.copy(y.orConditionOptions[n].valueOptions);y.orConditions[t].edit_able=y.orConditionOptions[n].edit_able}}}else if(e=="operation"){for(var n=0,s=y.operationOptions.length;n<s;n++){if(y.operationOptions[n].value==i){y.operations[t].valueType=y.operationOptions[n].valueType;y.operations[t].edit_able=y.operationOptions[n].edit_able;y.operations[t].valueOptions=angular.copy(y.operationOptions[n].valueOptions);y.operations[t].start=y.operationOptions[n].start;y.operations[t].startTimeForm=y.operationOptions[n].startTimeForm;y.operations[t].endTimeForm=y.operationOptions[n].endTimeForm}}}};var g=function(e,t,i){if(e=="and"){y.andConditions[t].valueOptions=i}else if(e=="or"){y.orConditions[t].valueOptions=i}else if(e=="operation"){y.operations[t].valueOptions=i}};var v=function(e,t){var i=[{option:"排队",value:"new"},{option:"已接通",value:"open"},{option:"已结束",value:"closed"},{option:"溢出",value:"canceled"}];g(e,t,i)};var h=function(e,t){var i=[{option:C("translate")("TICKET_STATUS_OPEN"),value:"open"},{option:C("translate")("TICKET_STATUS_SOLVED"),value:"solved"},{option:C("translate")("TICKET_STATUS_PENDING"),value:"pending"},{option:C("translate")("TICKET_STATUS_CLOSED"),value:"closed"}];g(e,t,i)};var w=function(e,t){var i=[{option:"无效信息",value:"无效信息"},{option:"重复信息",value:"重复信息"},{option:"恶意骚扰",value:"恶意骚扰"},{option:"其他原因",value:"其他原因"}];g(e,t,i)};var T=function(e,t){var i=[{option:"P1",value:"P1"},{option:"P2",value:"P2"},{option:"P3",value:"P3"},{option:"P4",value:"P4"},{option:"P5",value:"P5"}];g(e,t,i)};var S=function(o,l){s({url:"ticket_type.json",method:"GET",params:{_count:12332,_do_count:false,_fields:"id,name,description,isDefault"}}).success(function(e,t,i,n){userAginLogin(e);if(e.ticketTypes){var s=[];for(var a=0,r=e.ticketTypes.length;a<r;a++){s.push({option:e.ticketTypes[a].name,value:""+e.ticketTypes[a].id})}g(o,l,s)}})};var F=function(e,t){var i=[{option:"已解决",value:"1"},{option:"未解决",value:"0"}];g(e,t,i)};var A=function(e,t){var i=[{option:"Email收件箱",value:"email"},{option:"网页表单(feedback)",value:"form"},{option:"在线交谈/远程协助",value:"chat"},{option:"微信客服",value:"weixin"},{option:"电话渠道",value:"cti"},{option:"帮助中心",value:"helpcenter"},{option:"客服创建",value:"console"}];g(e,t,i)};var E=function(e,t){var i=[{option:"1分",value:"1"},{option:"2分",value:"2"},{option:"3分",value:"3"},{option:"4分",value:"4"},{option:"5分",value:"5"}];g(e,t,i)};var O=function(e){var t=[];for(var i=0,n=e[1];i<n;i++){t.push(y.compareOptions[e[0]+i])}return t};var I=function(e,t,i){var n=[];if(i=="status"){v(e,t)}};y.deleteCondition=function(e,t){if(e=="and"){y.andConditions.splice(t,1)}else if(e=="or"){y.orConditions.splice(t,1)}else if(e=="operation"){y.operations.splice(t,1)}};var L=function(e){var t=[];for(var i=0,n=e[1];i<n;i++){t.push(y.compareOptions[e[0]+i])}return t};y.conditionChange=function(e,t,i){void 0;if(e=="and"){if(y.andConditions[t].value!=undefined&&y.andConditions[t].value!=null&&y.andConditions[t].value!=""){delete y.andConditions[t]["value"]}if(y.andConditions[t].compare!=undefined&&y.andConditions[t].compare!=null&&y.andConditions[t].compare!=""){delete y.andConditions[t]["compare"]}if(y.andConditions[t].engineer!=undefined&&y.andConditions[t].engineer!=null&&y.andConditions[t].engineer!=""){delete y.andConditions[t]["engineer"];delete y.andConditions[t]["engineerDesk"]}}else if(e=="or"){if(y.orConditions[t].value!=undefined&&y.orConditions[t].value!=null&&y.orConditions[t].value!=""){delete y.orConditions[t]["value"]}if(y.orConditions[t].compare!=undefined&&y.orConditions[t].compare!=null&&y.orConditions[t].compare!=""){delete y.orConditions[t]["compare"]}if(y.orConditions[t].engineer!=undefined&&y.orConditions[t].engineer!=null&&y.orConditions[t].engineer!=""){delete y.orConditions[t]["engineer"];delete y.orConditions[t]["engineerDesk"]}}else{if(y.operations[t].value){delete y.operations[t]["value"]}if(y.operations[t]["endTime"]!=undefined&&y.operations[t]["endTime"]!=null&&y.operations[t]["endTime"]!=""){delete y.operations[t]["endTime"]}if(y.operations[t]["startTime"]!=undefined&&y.operations[t]["startTime"]!=null&&y.operations[t]["startTime"]!=""){delete y.operations[t]["startTime"]}if(y.operations[t].engineer){delete y.operations[t]["engineer"];delete y.operations[t]["engineerDesk"]}}y.conditionGetNode(e,t)};y.conditionGetNode=function(e,t){if(e=="and"){y.andConditions[t].orderKey=t+1;var i=y.andConditions[t];if(i.value!="-1"){m(e,t,i.attribute);i=y.andConditions[t];if(i.attribute=="priority"||i.attribute=="status"||i.attribute=="ticketType"||i.attribute=="requester.id"||i.attribute=="user"||i.attribute=="evaluate.score"){y.andConditions[t].compareOptions=L([0,2])}else if(i.attribute=="serviceDesk"){y.andConditions[t].compareOptions=L([6,2])}else if(i.attribute=="userGroup"){y.andConditions[t].compareOptions=L([4,2])}else if(i.attribute=="serviceCatalog"){var n=[{option:"是且包含其子目录",value:"$in"},{option:"是但不包含其子目录",value:"$eq"},{option:"不是且不是其子目录",value:"$not_in"},{option:"不是但可能是其子目录",value:"$ne_or_null"}];y.andConditions[t].compareOptions=n}else if(i.attribute=="via"){y.andConditions[t].compareOptions=L([0,2])}else if(i.attribute.indexOf("checkbox")>=0){y.andConditions[t].compareOptions=L([6,2]);y.andConditions[t].value="true"}else if(i.attribute.indexOf("textarea")>=0){y.andConditions[t].compareOptions=L([8,2])}else if(i.attribute.indexOf("text")>=0){y.andConditions[t].compareOptions=L([4,2]);y.andConditions[t].compareOptions=y.andConditions[t].compareOptions.concat(L([8,2]))}if(i.valueType=="select"){I(e,t,i.attribute)}}}else if(e=="or"){y.orConditions[t].orderKey=t+1;var i=y.orConditions[t];if(i.value!="-1"){m(e,t,i.attribute);i=y.orConditions[t];if(i.attribute=="via"){y.orConditions[t].compareOptions=L([0,2])}else if(i.attribute.indexOf("checkbox")>=0){y.orConditions[t].compareOptions=L([6,2]);y.orConditions[t].value="true"}else if(i.attribute.indexOf("textarea")>=0){y.orConditions[t].compareOptions=L([8,2])}else if(i.attribute.indexOf("date")>=0||i.attribute.indexOf("number")>=0||i.attribute.indexOf("decimal")>=0){y.orConditions[t].compareOptions=L([10,3])}else if(i.attribute.indexOf("text")>=0){y.orConditions[t].compareOptions=L([4,2]);y.orConditions[t].compareOptions=y.orConditions[t].compareOptions.concat(L([8,2]))}else if(i.attribute=="status"){y.orConditions[t].compareOptions=L([0,2])}else if(i.attribute=="serviceDesk"){y.orConditions[t].compareOptions=L([6,2])}else if(i.attribute=="userGroup"){y.orConditions[t].compareOptions=L([4,2])}else{y.orConditions[t].compareOptions=L([0,2])}if(i.valueType=="select"){I(e,t,i.attribute)}}}else{y.operations[t].orderKey=t+1;var i=y.operations[t];if(i.value!="-1"){m(e,t,i.attribute)}if(i.valueType=="select"){I(e,t,i.attribute)}if(i.attribute.indexOf("checkbox")>=0){y.operations[t].compareOptions=L([6,2])}}};y.getEngineer=function(t,e,i,n){if(i==="${current_engineer_id}"){t[n].engineer={name:"（当前客服）",id:"${current_engineer_id}"}}else{s({url:"service_desk/"+e+".json",method:"GET",params:{}}).success(function(e){t[n].engineerDesk=e.json});s({url:"engineer/"+i+".json",method:"GET",params:{}}).success(function(e){t[n].engineer=e.json})}};y.getRequester=function(t,i){if(t[i].value==="${current_user_id}"){t[i].value={id:"${current_user_id}",name:"（当前客户）"}}else{s({url:"user/"+t[i].value+"/no_access_scope.json",method:"GET",params:{}}).success(function(e){t[i].value=e.json})}};y.eweiPermisstionType="触发器";y.loadTrigger=function(e){org.ewei.sdk.OpenChatTriggerApi().getById({id:parseInt(e)}).then({success:function(e){y.triggerTask=e;y.rolePermissions=y.triggerTask.permissions;if(!y.triggerTask.isDefault){y.andConditions=y.triggerTask.andConditions;y.orConditions=y.triggerTask.orConditions;for(keys in y.triggerTask.operations){if((y.triggerTask.operations[keys].operate=="mailto_service_desk"||y.triggerTask.operations[keys].operate=="mailto_user")&&typeof y.triggerTask.operations[keys].value!="undefined"){try{y.triggerTask.operations[keys].value=JSON.parse(y.triggerTask.operations[keys].value)}catch(e){void 0}}}y.operations=y.triggerTask.operations;for(var t=0;t<y.operations.length;t++){if(y.operations[t].operate){y.operations[t].attribute=y.operations[t].operate;delete y.operations[t]["operate"]}}y.operations[0].options={};y.operations[0].options=l;for(var t=1;t<y.operations.length;t++){var i=[];for(var n=0;n<y.operations[t-1].options.length;n++){if(y.operations[t-1].attribute!=y.operations[t-1].options[n].value){i.push(y.operations[t-1].options[n])}}y.operations[t].options={};y.operations[t].options=i}function s(e,t){for(var i=0;i<e.length;i++){if(typeof e[i].value=="undefined"){void 0;return false}if(e[i].attribute=="createdAt"||e[i].attribute=="ticketMetric.responseAt"||e[i].attribute=="ticketMetric.pausedAt"||e[i].attribute=="ticketMetric.solvedAt"||e[i].attribute=="lastReply"||e[i].attribute=="customerLastReply"||e[i].attribute=="engineerLastReply"){e[i].value=parseInt(e[i].value)}if(e[i].attribute=="deleteTicket"){if(e[i].value!="无效信息"&&e[i].value!="重复信息"&&e[i].value!="恶意骚扰"){e[i].reason=e[i].value;e[i].value="其他原因"}}y.conditionGetNode(t,i);var n;var s;if(e[i].attribute=="engineer"){if(e[i].value==="${current_engineer_id}"){s="${current_engineer_id}"}else{n=e[i].value.split("_")[0];s=e[i].value.split("_")[1]}y.getEngineer(e,n,s,i);delete e[i]["value"]}else if(e[i].attribute=="mailto_user"){e[i].value=e[i].value}else if(e[i].attribute=="mailto_service_desk"){e[i].value.serviceDesk=e[i].value.serviceDesk.id}else if(e[i].attribute=="requester.id"){y.getRequester(e,i)}else if(e[i].attribute=="userGroup"||e[i].attribute=="serviceDesk"){if(e[i].compare!="$in"&&e[i].compare!="$not_in"){e[i].compare=e[i].compare==="$eq"?"$in":"$not_in"}}else if(e[i].attribute==="user"){if(e[i].compare==="$ne_or_null"){e[i].compare="$ne"}}else if(e[i].attribute=="addCC"){e[i].value=JSON.parse(e[i].value)}else if(e[i].attribute=="via"){e[i].value=JSON.parse(e[i].value)}else if(e[i].attribute=="chatComment"){e[i].value=JSON.parse(e[i].value)}if(t==="and"||t==="or"){if(e[i].compare==="$in"||e[i].compare==="$not_in"){if(e[i].valueType!="userGroup"){e[i].value=e[i].value.replace("service_catalog_and_children_id_","")}}}}}s(y.andConditions,"and");s(y.orConditions,"or");s(y.operations,"operation");var a=[y.andConditions,y.orConditions,y.operations];for(var t=0;t<a.length;t++){for(var n=0;n<a[t].length;n++){if(a[t][n].valueType=="cascade_options"||a[t][n].valueType=="multi_options"||a[t][n].valueType=="options"){a[t][n].valueOptions.value=a[t][n].value}else if(a[t][n].valueType=="date"){a[t][n].value=p.parseDate(a[t][n].value,"yyyy/MM/dd")}else if(a[t][n].valueType=="date_to_date"){var r=a[t][n].value;r=r.split("-");a[t][n].startTime=p.parseDate(r[0],"yyyy/MM/dd");a[t][n].endTime=p.parseDate(r[1],"yyyy/MM/dd")}if(t==2&&a[t][n].valueType=="checkbox"){a[t][n].compare=a[t][n].value=="true"?"$eq_ticket_custom_field":"$ne_or_null_ticket_custom_field"}}}}},fail:function(){}})};y.type=_.type;if(_.id&&parseInt(_.id)>0){y.loadTrigger(_.id)}y.addNewCondition=function(e){if(e=="and"){y.andConditions.push({attribute:"-1",tally:"and"})}else if(e=="or"){y.orConditions.push({attribute:"-1",tally:"or"})}else{var t=[];for(var i=0,n=l.length;i<n;i++){var s=false;for(var a=0,r=y.operations.length;a<r;a++){if(y.operations[a].attribute!=0&&y.operations[a].attribute==l[i].value){s=true;break}}if(!s){t.push(l[i])}}var o={attribute:"-1",orderKey:"",valueOptions:[],valueType:"",options:t};y.operations.push(o)}};y.backTrigger=function(){i.go("system_setting.detail",{uri:"triggerTask",settingType:"ticket"})};y.isClick=false;y.saveTriggerTask=function(){var e=false;if(!y.triggerTask.name){e=false}else{e=true}if(y.andConditions.length<1||y.operations.length<1){k.add("每项至少需要一个条件和一项操作","danger")}else{var t=false;var i=false;var n=false;var s=false;var a=false;var r=false;for(var o=0;o<y.andConditions.length;o++){if(y.andConditions[o].valueType=="cascade_options"||y.andConditions[o].valueType=="multi_options"||y.andConditions[o].valueType=="options"){y.andConditions[o].value=y.andConditions[o].valueOptions.value;void 0}if(y.andConditions[o].compare&&(y.andConditions[o].value||y.andConditions[o].value==0)&&y.andConditions[o].attribute!=0){if(typeof y.andConditions[o].value=="number"){if(y.andConditions[o].value<0){t=false;break}else{t=true;i=true}}else{t=true;i=true}}else{if(y.andConditions[o].engineer){if(y.andConditions[o].engineerDesk){y.andConditions[o].value=y.andConditions[o].engineerDesk.id+"_"+y.andConditions[o].engineer.id}else{y.andConditions[o].value=y.andConditions[o].engineer.id}t=true;i=true}else{i=false;break}}}if(y.orConditions.length>0){for(var o=0;o<y.orConditions.length;o++){if(y.orConditions[o].valueType=="cascade_options"||y.orConditions[o].valueType=="multi_options"||y.orConditions[o].valueType=="options"){y.orConditions[o].value=y.orConditions[o].valueOptions.value}if(y.orConditions[o].compare&&y.orConditions[o].value&&y.orConditions[o].attribute!=0){n=true;s=true}else{if(y.orConditions[o].engineer){if(y.orConditions[o].engineerDesk){y.orConditions[o].value=y.orConditions[o].engineerDesk.id+"_"+y.orConditions[o].engineer.id}else{y.orConditions[o].value=y.orConditions[o].engineer.id}n=true;s=true}else{n=false;break}}}}else{n=true;s=true}for(var o=0;o<y.operations.length;o++){if(y.operations[o].valueType=="cascade_options"||y.operations[o].valueType=="multi_options"||y.operations[o].valueType=="options"){if(y.operations[o].valueOptions.value!="-"){y.operations[o].value=y.operations[o].valueOptions.value;a=true;r=true}else{r=false;break}}else if(y.operations[o].valueType=="date"){if(y.operations[o].value){var l=C("date")(y.operations[o].value,"yyyy/MM/dd").toString();y.operations[o].value=l;a=true;r=true}else{r=false;break}}else if(y.operations[o].valueType=="checkbox"){if(y.operations[o].compare){y.operations[o].value=y.operations[o].compare.indexOf("$eq_ticket_custom_field")>-1?"true":"false";a=true;r=true}else{r=false;break}}else if(y.operations[o].valueType=="date_to_date"){if(y.operations[o].startTime&&y.operations[o].endTime){var l=C("date")(y.operations[o].startTime,"yyyy/MM/dd").toString();var c=C("date")(y.operations[o].endTime,"yyyy/MM/dd").toString();var u=l+"-"+c;y.operations[o].value=u;a=true;r=true}else{r=false;break}}if(y.operations[o].attribute=="mailto_user"){if(y.operations[o].value.title&&y.operations[o].value.content&&y.operations[o].value){a=true;r=true}else{r=false;break}}else if(y.operations[o].attribute=="mailto_service_desk"){if(y.operations[o].value.title&&y.operations[o].value.content&&y.operations[o].value){a=true;r=true}else{r=false;break}}else if(y.operations[o].attribute=="addCC"){if(y.operations[o].value.length>0){a=true;r=true}else{r=false;break}}else if(y.operations[o].attribute=="chatComment"){if(y.operations[o].value&&y.operations[o].value.value){a=true;r=true}else{r=false;break}}else if(y.operations[o].attribute=="deleteTicket"){if(!y.operations[o].value){r=false;break}if(y.operations[o].value!="其他原因"){a=true;r=true}else{if(y.operations[o].reason){a=true;r=true}else{r=false;break}}}else if(y.operations[o].attribute!="noticeEvaluate"&&y.operations[o].attribute!="mailto_user"&&y.operations[o].attribute!="mailto_service_desk"&&y.operations[o].attribute!="addCC"){if(y.operations[o].value&&y.operations[o].attribute!=0){a=true;r=true}else{if(y.operations[o].engineer){if(y.operations[o].engineerDesk){y.operations[o].value=y.operations[o].engineerDesk.id+"_"+y.operations[o].engineer.id}else{y.operations[o].value=y.operations[o].engineer.id}a=true;r=true}else{a=false;break}}}}if(!e){k.add("请填写程序名称","danger")}else if(t&&i&&n&&s&&a&&r&&e){var d=angular.copy(y.triggerTask.andConditions);var p=angular.copy(y.triggerTask.orConditions);var f=angular.copy(y.triggerTask.operations);y.triggerTask.andConditions=[];y.triggerTask.orConditions=[];y.triggerTask.operations=[];for(var o=0;o<y.andConditions.length;o++){t=true;var m={};m.orderKey=y.andConditions[o].orderKey;m.attribute=y.andConditions[o].attribute;m.compare=y.andConditions[o].compare;m.tally=y.andConditions[o].tally;if(typeof y.andConditions[o].value=="object"){if(y.andConditions[o].attribute.indexOf("ticketcustomfield")>=0){if(y.andConditions[o].attribute.indexOf("ticketcustomfield_date")>=0){m.value=C("date")(y.andConditions[o].value,"yyyy/MM/dd").toString()}else{m.value=y.andConditions[o].value}}else if(y.andConditions[o].attribute=="via"){m.value=JSON.stringify(y.andConditions[o].value)}else{if(m.compare==="$in"||m.compare==="$not_in"){if(m.attribute==="userGroup"){m.value=y.andConditions[o].value}else if(m.attribute==="serviceDesk"){m.value=y.andConditions[o].value.id}else{m.value="service_catalog_and_children_id_"+y.andConditions[o].value.id}}else{m.value=y.andConditions[o].value.id}}}else{if(y.andConditions[o].attribute.indexOf("ticketcustomfield_checkbox")>=0){m.value="true"}else{if(m.compare==="$in"||m.compare==="$not_in"){if(m.attribute==="serviceCatalog"){m.value="service_catalog_and_children_id_"+y.andConditions[o].value}else if(m.attribute==="userGroup"){m.value=y.andConditions[o].value}else if(m.attribute==="serviceDesk"){m.value=y.andConditions[o].value}else{m.value=b.run(y.andConditions[o].value,m.compare)}}else{m.value=y.andConditions[o].value}}}y.triggerTask.andConditions.push(m)}for(var o=0;o<y.orConditions.length;o++){var g={};g.orderKey=y.orConditions[o].orderKey;g.attribute=y.orConditions[o].attribute;g.compare=y.orConditions[o].compare;g.tally=y.orConditions[o].tally;if(typeof y.orConditions[o].value=="object"){if(y.orConditions[o].attribute.indexOf("ticketcustomfield")>=0){if(y.orConditions[o].attribute.indexOf("ticketcustomfield_date")>=0){g.value=C("date")(y.orConditions[o].value,"yyyy/MM/dd").toString()}else{g.value=y.orConditions[o].value}}else if(y.orConditions[o].attribute=="via"){g.value=JSON.stringify(y.orConditions[o].value)}else{if(g.compare==="$in"||g.compare==="$not_in"){if(g.attribute==="userGroup"){g.value=y.orConditions[o].value}else if(g.attribute==="serviceDesk"){g.value=y.orConditions[o].value.id}else{g.value="service_catalog_and_children_id_"+y.orConditions[o].value.id}}else{g.value=y.orConditions[o].value.id}}}else{if(y.orConditions[o].attribute.indexOf("ticketcustomfield_checkbox")>=0){g.value="true"}else{if(g.compare==="$in"||g.compare==="$not_in"){if(g.attribute==="serviceCatalog"){g.value="service_catalog_and_children_id_"+y.orConditions[o].value}else if(g.attribute==="userGroup"){g.value=y.orConditions[o].value}else if(g.attribute==="serviceDesk"){g.value=y.orConditions[o].value}else{g.value=b.run(y.orConditions[o].value,g.compare)}}else{g.value=y.orConditions[o].value}}}y.triggerTask.orConditions.push(g)}for(var o=0;o<y.operations.length;o++){var v={};v.value={};if(y.operations[o].attribute!="noticeEvaluate"){v.orderKey=y.operations[o].orderKey;if(y.operations[o].attribute=="mailto_user"||y.operations[o].attribute=="mailto_service_desk"){v.operate=y.operations[o].attribute;v.value=y.operations[o].value}else{v.attribute=y.operations[o].attribute}if(y.operations[o].attribute=="deleteTicket"){if(y.operations[o].value==="其他原因"){v.value=y.operations[o].reason}else{v.value=y.operations[o].value}}else if(y.operations[o].attribute=="chatComment"){v.value=y.operations[o].value}else if(y.operations[o].attribute!="mailto_service_desk"&&y.operations[o].attribute!="mailto_user"){v.value=y.operations[o].value}}else{v.orderKey=y.operations[o].orderKey;v.operate=y.operations[o].attribute}y.triggerTask.operations.push(v)}y.isClick=true;var h;y.triggerTask.permissions=[];angular.forEach(y.fieldPermissions,function(e){role={};role.roleId=e.id;role.scanAble=e.scanAble;role.editAble=e.editAble;y.triggerTask.permissions.push(role)});if(_.type=="add"||_.type=="copy"){if(y.triggerTask.id){delete y.triggerTask.id;delete y.triggerTask.uid}h={chatTrigger:y.triggerTask};org.ewei.sdk.OpenChatTriggerApi().save(h).then({success:function(e){D(e)},fail:function(e){P(e)}})}else{h={chatTrigger:y.triggerTask,id:y.triggerTask.id};org.ewei.sdk.OpenChatTriggerApi().update(h).then({success:function(e){D(e)},fail:function(e){P(e)}})}}else if(!i||!s||!r){void 0;void 0;k.add("请把信息填写完整","danger")}else if(!t||!n||!a){k.add("信息填写错误","danger")}}};function D(){k.add("更新成功");y.backTrigger();y.isClick=false}function P(e){y.isClick=false;if(e.error!=null){k.add(C("translate")(e.error_description),"danger")}else{k.add("更新失败","danger")}for(var t=0;t<y.andConditions.length;t++){if(y.andConditions[t].attribute=="engineer"){delete y.andConditions[t]["value"]}}for(var t=0;t<y.orConditions.length;t++){if(y.orConditions[t].attribute=="engineer"){delete y.orConditions[t]["value"]}}for(var t=0;t<y.operations.length;t++){if(y.operations[t].attribute=="engineer"){delete y.operations[t]["value"]}}}y.saveTriggerTaskDefault=function(e){var t=parseInt(automation.tempValue==null?0:automation.tempValue);if((automation.type=="chat"||automation.type=="weixin_chat")&&(t<8||t>2880)){k.add("自动结束会话时间在8-2880分钟之间","danger");return}else if(automation.type=="ticket"&&(t<8||t>120)){k.add("自动关闭工单在8-120小时之间","danger");return}s({url:"automation.json",method:"POST",data:e}).success(function(e){userAginLogin(e);if(e.success){k.add("更新成功");y.backAutomation()}else{k.add("更新失败","danger")}})};y.checkCharCount=function(e){var t=$(e);if(t.val()!=null&&t.val()!=""){if(t.val().length>=t.attr("maxlength")){k.add(t.prev().text()+"不能超过"+t.attr("maxlength")+"个字符","danger")}}}}]);+function(){"use strict";angular.module("eweiApp.ticket").controller("createNewTicketController",e);e.$inject=["$rootScope","$scope","$state","$stateParams","coreModelService","utils","providerJudgement"];function e(e,t,i,n,s,a,r){if(!r.isTrue()){return false}var o=i.current.name,l=i.params.type,c="";if(l==="normal"){c="新建工单"}else if(l==="batch-customer"){c="多客户批量派单"}else if(l==="batch-engineer"){c="多客服批量派单"}else if(l==="batch-ticket"){c="批量建单"}else if(l==="plan-ticket"){c="计划工单";var u=s.config.route.get("tickets_new_"+n.id);if(u&&u.name){i.go(u.name,u.params||{})}}if(l==="plan-ticket"){a.addTab("tickets_new"+n.id,c,"tickets_new.plan_list",{id:n.id,type:l},"",true)}else{a.addTab("tickets_new"+n.id,c,o,{id:n.id,type:l},"",true)}}}();+function(){"use strict";angular.module("eweiApp.ticket").controller("batchCreateTicketController",e);e.$inject=["$rootScope","$http","$scope","$state","batchTicketService","$filter","coreModelService","$stateParams","ConsoleConfig","$modal_","alertService","license","permissions","providerJudgement","coreNotifyService"];function e(n,e,l,t,s,c,a,i,u,r,o,d,p,f,m){l.id=i.id;l.batch={id:i.id};l.data=[];var g=t.current.name;var v=d.type();l.hasBatchTicketCreateModule=v&&(v==="enterprise_basic"||v==="enterprise_trial"||v==="enterprise_basic_19");m.register(g,m.constant.EVENT_LICENSE,function(e,t){var i=a.config.license.get("license").type||"";l.hasBatchTicketCreateModule=i==="enterprise_basic"||i==="enterprise_trial"||i==="enterprise_basic_19"});s.noSaveCacheData=false;l.addRow=function(){if(l.data.length==0){var i=s.getNewRowData();l.data.push(i)}else{var e=s.checkedCustomFileds;var i={id:eweiCommon.uuid(32).toLowerCase()};angular.forEach(e,function(e){var t=e.isCopy;if(e.field=="handle"){i.serviceDesk=t?angular.copy(l.data[0].serviceDesk):null;i.engineer=t?angular.copy(l.data[0].engineer):null}else if(e.field=="customer"){i.requester=t?angular.copy(l.data[0].requester):null}else if(e.field=="ticket_description"){i.ticketComment=t?angular.copy(l.data[0].ticketComment):{content:null}}else if(e.field=="ticket_type"){i.ticketType=t?angular.copy(l.data[0].ticketType):{}}else if(e.field=="subject"){i.subject=t?angular.copy(l.data[0].subject):""}else if(e.field=="priority"){i.priority=t?angular.copy(l.data[0].priority):""}else if(e.field=="service_catalog"){i.serviceCatalog=t?angular.copy(l.data[0].serviceCatalog):null}else if(e.field=="ccs"){i.ccs=t?angular.copy(l.data[0].ccs):[]}else if(e.field=="sla_time"){i.ticketMetric=t?angular.copy(l.data[0].ticketMetric):null}else if(e.field=="tags"){i.tags=t?angular.copy(l.data[0].tags):[]}else if(e.type=="options"){i[e.field]=t?angular.copy(l.data[0][e.field]):{};if(e.defaultValue){i[e.field].defaultValue=e.defaultValue}i[e.field].openSearch=true}else if(e.type=="date_to_date"){i[e.field]=t?angular.copy(l.data[0][e.field]):{startTime:"",endTime:""}}else if(e.type=="date"||e.type=="date_time"){i[e.field]=t?angular.copy(l.data[0][e.field]):{startForm:""}}else{i[e.field]=t?angular.copy(l.data[0][e.field]):{value:""}}if(e.url){i[e.field].valueUrl=e.url}if(e.customFieldOptions&&e.field!="priority"){if(e.field=="ticket_type"){i.ticketType.customFieldOptions=e.customFieldOptions}else{i[e.field].customFieldOptions=e.customFieldOptions}}});l.data.unshift(i)}};l.delete=function(e){for(var t=0;t<l.data.length;t++){var i=l.data[t];if(i.id==e){l.data.splice(t,1);t--}}};l.batchDelete=function(){l._messages="确认删除？";var e=r({scope:l,title:"删除确认",contentTemplate:"source/views/alter_common.html",html:true,show:true,placement:"center"});l.$ok=function(){if(l.isLoading==true){return false}l.isLoading=true;for(var e=0;e<l.selectedTicketIds.length;e++){l.delete(l.selectedTicketIds[e]);l.selectedTicketIds.splice(e,1);e--}l.checkboxes={checked:false,items:{}};l.isLoading=false;l.$hide();o.add("删除成功","success")};l.$hide=function(){e.$promise.then(e.hide)}};function h(){var e=d.type();if(!e||e!=="enterprise_basic"&&e!=="enterprise_trial"&&e!=="enterprise_basic_19"){o.add("您当前的版本不支持批量派单功能，请升级后再使用！","danger");return false}if(!p.hasPermission("batch_ticket_create")){o.add("您没有批量建单权限，不能使用此功能！","danger");return false}return true}l.batchSubmit=function(e){if(!h())return;if(!f.isTrue()){return false}if(n.providerLicense.useDataCapacity&&n.providerLicense.useDataCapacity!==-1){var t=n.providerLicense.useDataCapacity*1024*1024*1024;if(n.providerLicense.attachmentSize>=t&&!n.providerLicense.is_cover_data){o.add("数据空间授权不足","danger");return}}if(n.batchWorker){o.add("上一个批量派单尚未结束，请稍后再试","danger");return}org.ewei.sdk.OperationLogApi().saveOperationLog({action:"CREATE",position:"TICKET",target:"BATCH_CREATE_TICKET"}).then(function(){l.submit(e)},function(){l.submit(e)})};l.submit=function(n){l.disabled=true;l.selectRow=[];angular.forEach(l.data,function(i){angular.forEach(l.selectedTicketIds,function(e){if(i.id==e){var t=y(i,n);l.selectRow.push(t)}})});l.task()};l.cleanupSaveData=function(e){if(!e)return e;if(e.engineer&&e.engineer.id){e.engineer={id:e.engineer.id}}else{e.engineer=null}if(e.requester&&e.requester.id){e.requester={id:e.requester.id,name:e.requester.name}}else{e.requester=null}if(e.serviceCatalog&&e.serviceCatalog.id){e.serviceCatalog={id:e.serviceCatalog.id}}else{e.serviceCatalog=null}if(e.serviceDesk&&e.serviceDesk.id){e.serviceDesk={id:e.serviceDesk.id,name:e.serviceDesk.name}}else{e.serviceDesk=null}if(e.ticketMetric&&e.ticketMetric.planSolvedAt){}else{e.ticketMetric=null}if(e.workflowTemplate&&e.workflowTemplate.id){e.activitiWorkflowTemplateId=e.workflowTemplate.id;delete e.workflowTemplate}else{}if(e.ccs&&e.ccs.length>0){for(var t=0;t<e.ccs.length;t++){var i=e.ccs[t];if(i.user){i.user={id:i.user.id,name:i.user.name};continue}if(i.userGroup){i.userGroup={id:i.userGroup.id,name:i.userGroup.name};continue}if(i.serviceDesk){i.serviceDesk={id:i.serviceDesk.id,name:i.serviceDesk.name};continue}if(i.type){if(i.type=="serviceDesk"){i.serviceDesk={id:i.id,name:i.name};delete i.id;delete i.name;delete i.type;continue}if(i.type=="userGroup"){i.userGroup={id:i.id,name:i.name};delete i.id;delete i.name;delete i.type;continue}}else{if(i.email){delete i.id;delete i.name;continue}else{var n=new RegExp(/^[0-9]*$/);if(!n.test(i.id)){i.email=i.name;delete i.id;delete i.name;delete i.type;continue}else{i.user={id:i.id,name:i.name};delete i.id;delete i.name;delete i.type;continue}}}}}else{e.ccs=[]}return e};function y(e,t){var i=angular.copy(e);var n=true;for(var s=0;s<l.columns.length;s++){var a=l.columns[s];if(a.type=="date"&&i[a.field].value){i[a.field].value=c("date")(i[a.field].value,"yyyy/MM/dd")}if(a.type=="date_time"&&i[a.field].value){i[a.field].value=c("date")(i[a.field].value,"yyyy/MM/dd HH:mm:ss")}if(a.type=="cascade_options"&&i[a.field]&&i[a.field].value&&i[a.field].value==="-"){i[a.field].value=null}if(i.ticketMetric&&i.ticketMetric.planSolvedAt){i.ticketMetric.planSolvedAt=c("date")(i.ticketMetric.planSolvedAt,"yyyy-MM-dd HH:mm:ss").toString()}if(i.ticketType&&!i.ticketType.id){i.ticketType=null}if(i.ticketMetric&&i.ticketMetric.planSolvedAt){i.ticketMetric.planSolvedAt=i.ticketMetric.planSolvedAt.replaceAll("/","-")}if(a.required){if(a.field=="handle"&&(!i.serviceDesk&&!i.engineer)){n=false;continue}if(a.field=="customer"&&(!i.requester||i.requester&&!i.requester.id)){n=false;continue}if(a.field=="subject"&&!i.subject){n=false;continue}if(a.field=="ticket_description"&&(!i.ticketComment||i.ticketComment&&!i.ticketComment.content)){n=false;continue}if(a.field=="priority"&&!i.priority){n=false;continue}if(a.field=="service_catalog"&&(!i.serviceCatalog||i.serviceCatalog&&!i.serviceCatalog.id)){n=false;continue}if(a.field=="ticket_type"&&(!i.ticketType||i.ticketType&&!i.ticketType.id)){n=false;continue}if(a.field=="ccs"&&(!i.ccs||i.ccs&&i.ccs.length<=0)){n=false;continue}if(a.field=="tags"&&(!i.tags||i.tags&&i.tags.length<=0)){n=false;continue}if(a.field=="sla_time"&&(!i.ticketMetric||i.ticketMetric&&!i.ticketMetric.planSolvedAt)){n=false;continue}if(a.field.indexOf("custom_field_")>-1&&(!i[a.field]||i[a.field]&&!i[a.field].value)){n=false;continue}}}i=l.cleanupSaveData(i);var r={isChecked:n,via:{channel:"console",channelName:"客服界面 ",source:u.user.name}};r.uId=i.id;delete i.id;r.ticketCustomFields=[];for(var o in i){if(o.indexOf("custom_field_")>-1){r.ticketCustomFields.push({value:i[o].value,customField:{id:o.split("custom_field_")[1]}})}else if(o=="engineer"){if(t){r.status=t}else if(!i[o]){r.status="new"}else if(i[o]&&i[o].id==u.engineer.id){r.status="open"}else{r.status="assigned"}r[o]=i[o]}else{r[o]=i[o];if(r[o]&&r[o].customFieldOptions){delete r[o].customFieldOptions}}}return r}l.task=function(){var i=n.batchWorker=new Worker("/source/scripts/ticket-batch-create.js");i.onmessage=function(e){if(!e.data||!e.data.type)return;switch(e.data.type){case"ready":{i.postMessage({type:"batch-create",tickets:l.selectRow,params:{provider_id:u.provider.id,_token:getCookie("user_token")}});break}case"started":{n.$broadcast("batch-started",e.data.data);break}case"progress":{n.$broadcast("batch-progress",e.data.data);if(e.data.data.id){l.delete(e.data.data.id);s.deleteCacheDataById(l.id,e.data.data.id);for(var t=0;t<l.selectedTicketIds.length;t++){if(e.data.data.id==l.selectedTicketIds[t]){l.delete(l.selectedTicketIds[t]);delete l.checkboxes.items[l.selectedTicketIds[t]];l.selectedTicketIds.splice(t,1)}}}break}case"finished":{i.terminate();delete n.batchWorker;if(e.data.data){e.data.data.fromId=l.id}n.$broadcast("batch-finished",e.data.data);l.disabled=false;break}}}};l.$on("$destroy",function(){if(!s.noSaveCacheData){s.setCacheData(l.id,l.data)}})}}();+function(){"use strict";angular.module("eweiApp.ticket").config(e).service("batchTicketService",t);e.$inject=["$stateProvider","$urlRouterProvider"];t.$inject=["$http","serviceCatalogService"];function e(e,t){e.state("batchticket",{url:"/batchticket/:id",controller:"batchticketController",templateUrl:"source/batch-create-ticket/template/batchticket.html",permission:"batch_ticket_create",params:{type:"batch-ticket"}}).state("batchticket.copy-setting",{url:"/copy-setting",controller:"batchticketCopySettingController",templateUrl:"source/batch-create-ticket/template/copy-setting.html",permission:"batch_ticket_create",controllerAs:"vm"}).state("batchticket.setting-fileds",{url:"/setting-fileds",controller:"batchticketSettingFiledsController",templateUrl:"source/batch-create-ticket/template/setting-fileds.html",permission:"batch_ticket_create",controllerAs:"vm"}).state("batchticket.import-excel",{url:"/import-excel",controller:"batchticketImportExcelController",templateUrl:"source/batch-create-ticket/template/import-excel.html",permission:"batch_ticket_create",controllerAs:"vm"})}function t(t,e){var m=this;this.checkedCustomFileds=[];this.allCustomFileds=[];this.cacheData={};var g=["handle","priority","service_catalog","ccs","ticket_type","tags"];this.getTicketCustomfileds=function(d){var e="custom_field.json?scope=ticket&active=true";var p=[{title:"处理人",field:"handle",required:true,isCopy:true,length:100},{title:"客户",field:"customer",required:true,length:100},{title:"抄送人",field:"ccs",required:false,length:100,isCopy:true},{title:"要求完成时间",field:"sla_time",required:false,length:100}];var f=[];t.get(e).success(function(e,t,i,n){var u=e.json;org.ewei.sdk.OpenListHeaderSettingApi().getByType({type:"ticket.batch.list"}).then({success:function(e){this.headerFileds=e.fields;if(this.headerFileds!==undefined&&this.headerFileds.length>0){var t=[];u=u.concat(p);for(var i=0,n=u.length;i<n;i++){var s=u[i].systemFieldKey||u[i].field||"custom_field_"+u[i].id;var a={id:u[i].id,title:u[i].title,field:s,required:u[i].required,notes:u[i].notes,type:u[i].type,defaultValue:u[i].defaultValue,length:s==="subject"||s==="ticket_description"?280:100};f.push(a);if(u[i].fromParams){a.fromParams=u[i].fromParams}if(u[i].regexpForValidation){a.regexpForValidation=u[i].regexpForValidation}if(u[i].customFieldOptions){a.customFieldOptions=u[i].customFieldOptions}for(var r=0,o=this.headerFileds.length;r<o;r++){if(u[i].id!==undefined&&this.headerFileds[r].id!==undefined&&u[i].id===this.headerFileds[r].id){a.length=this.headerFileds[r].length;a.isCopy=this.headerFileds[r].isCopy;a.orderKey=this.headerFileds[r].orderKey;t.push(a)}if(u[i].field!==undefined&&this.headerFileds[r].field!==undefined&&u[i].field===this.headerFileds[r].field){a.length=this.headerFileds[r].length;a.isCopy=this.headerFileds[r].isCopy;a.orderKey=this.headerFileds[r].orderKey;t.push(a)}}}var l=function(s){return function(e,t){var i=e[s];var n=t[s];return i-n}};t.sort(l("orderKey"));m.checkedCustomFileds=t;m.allCustomFileds=f;if(typeof d==="function"){d()}}else{for(var c=0,n=u.length;c<n;c++){var s=u[c].systemFieldKey||"custom_field_"+u[c].id;var a={id:u[c].id,title:u[c].title,field:s,required:u[c].required,notes:u[c].notes,type:u[c].type,defaultValue:u[c].defaultValue,length:s==="subject"||s==="ticket_description"?280:100};if(s==="subject"||s==="ticket_description"||s==="priority"||s==="service_catalog"||s==="ticket_type"||s==="tags"){p.push(a)}else{f.push(a)}if(u[c].fromParams){a.fromParams=u[c].fromParams}if(u[c].regexpForValidation){a.regexpForValidation=u[c].regexpForValidation}if(u[c].customFieldOptions){a.customFieldOptions=u[c].customFieldOptions}if(g.indexOf(s)>-1){a.isCopy=true}}m.checkedCustomFileds=p;m.allCustomFileds=p.concat(f);if(typeof d==="function"){d()}}}})})};this.saveFaileExceldData=[];this.getNewRowData=function(){var e=this.checkedCustomFileds;var t={id:eweiCommon.uuid(32).toLowerCase()};angular.forEach(e,function(e){if(e.field=="handle"){t.serviceDesk=null;t.engineer=null}else if(e.field=="customer"){t.requester=null}else if(e.field=="ticket_description"){t.ticketComment=null}else if(e.field=="ticket_type"){t.ticketType={}}else if(e.field=="subject"){t.subject=""}else if(e.field=="priority"){t.priority=""}else if(e.field=="service_catalog"){t.serviceCatalog=null}else if(e.field=="ccs"){t.ccs=[]}else if(e.field=="sla_time"){t.ticketMetric=null}else if(e.field=="tags"){t.tags=[]}else if(e.type=="options"){t[e.field]={};t[e.field].openSearch=true}else if(e.type=="date_to_date"){t[e.field]={startTime:"",endTime:""}}else if(e.type=="date"||e.type=="date_time"){t[e.field]={startForm:""}}else{t[e.field]={value:null}}if(e.url){t[e.field].valueUrl=e.url}if(e.customFieldOptions&&e.field!="priority"){if(e.field=="ticket_type"){t.ticketType.customFieldOptions=e.customFieldOptions}else{t[e.field].customFieldOptions=e.customFieldOptions}}});return t};this.setCacheData=function(e,t){this.cacheData[e]=angular.copy(t)};this.getCacheData=function(e){return this.cacheData[e]||[]};this.deleteCacheDataById=function(e,t){if(this.cacheData[e]&&this.cacheData[e].length>0){for(var i=0;i<this.cacheData[e].length;i++){if(this.cacheData[e][i].id==t){this.cacheData[e].splice(i,1);i--}}}};this.serviceCatalogs=[];this.getServiceCatalogs=function(){var t=function(e){angular.forEach(e.serviceCatalogs,function(e){var t=e;if(angular.isString(e)){e=e.replace(/[\r]/g,"").replace(/[\n]/g,"");t=angular.fromJson(e)}m.serviceCatalogs.push(t)})};e.run("",{},false,function(e){t(e.result)})};this.getServiceCatalogs()}}();(function(){"use strict";angular.module("eweiApp.ticket").controller("batchticketController",e).controller("batchticketCopySettingController",t).controller("batchticketSettingFiledsController",i).controller("batchticketImportExcelController",n);e.$inject=["$scope","$stateParams","$state","utils","license"];t.$inject=["$scope","$state","alertService","batchTicketService","$stateParams"];i.$inject=["$scope","$state","alertService","batchTicketService","$stateParams"];n.$inject=["$scope","$modal_","alertService","batchTicketService","$http","$rootScope","ConsoleConfig","$stateParams","license","permissions","providerJudgement"];function e(e,t,i,n,s){var a=i.current.name,r=i.params.type,o="";if(r==="normal"){o="新建工单"}else if(r==="batch-customer"){o="多客户批量派单"}else if(r==="batch-engineer"){o="多客服批量派单"}else if(r==="batch-ticket"){o="批量建单"}else if(r==="plan-ticket"){o="计划工单"}n.addTab("tickets_new"+t.id,o,a,{id:t.id,type:r},"",true)}function t(e,t,i,n,s){var a=this;a.id=s.id;if(n.checkedCustomFileds.length){a.copySetting=n.checkedCustomFileds}else{n.getTicketCustomfileds(function(){a.copySetting=n.checkedCustomFileds})}a.saveCopySetting=function(){i.add("更新成功");t.go("tickets_new.batch",{id:a.id})}}function i(e,t,a,s,i){var r=this;r.id=i.id;r.getDifferenceData=function(){var n=[];angular.forEach(s.allCustomFileds,function(e){var t=false;for(var i=0;i<s.checkedCustomFileds.length;i++){if(s.checkedCustomFileds[i].field===e.field){t=true;break}}if(!t){n.unshift(e)}});r.notCheckedMoudel=n};if(s.checkedCustomFileds.length){r.checkedMoudel=angular.copy(s.checkedCustomFileds);r.getDifferenceData()}else{s.getTicketCustomfileds(function(){r.checkedMoudel=angular.copy(s.checkedCustomFileds);r.getDifferenceData()})}r.notCheckedSortableOptions={connectWith:".sortable"};r.checkedSortableOptions={handle:".drag-handle",connectWith:".sortable",beforeStop:function(e,t){var i=t.item.sortable.model.field;var n=t.originalPosition.left;var s=t.position.left;if(i==="handle"||i==="customer"||i==="subject"){if(n-s>50){t.item.sortable.cancel();a.add("处理人,客户,主题必须显示","danger")}}}};r.settingFileds=function(){s.checkedCustomFileds=r.checkedMoudel;angular.forEach(s.checkedCustomFileds,function(e,t){e.orderKey=t});org.ewei.sdk.OpenListHeaderSettingApi().saveOrUpdate({type:"ticket.batch.list",fields:s.checkedCustomFileds}).then(function(e){if(e){a.add("更新成功");t.go("tickets_new.batch",{id:r.id})}})}}function n(i,t,n,s,e,a,r,o,l,c,u){var d=this;d.id=o.id;var p=[];d.getServerUrl=function(e){for(var t=0;t<e.length;t++){var i={title:e[t].title,field:e[t].field,required:e[t].required};p.push(i)}d.serverUrl="/api/v1/ticket/analysis_excel_task.json?_token="+getCookie("user_token");d.formData={fields:JSON.stringify(p)}};if(s.checkedCustomFileds.length){d.getServerUrl(s.checkedCustomFileds)}else{s.getTicketCustomfileds(function(){d.getServerUrl(s.checkedCustomFileds)})}d.downLoadTemplete=function(){var e=$("<iframe></iframe>");e.attr("name","batchTicketDownLoadTemplage");e.attr("style","display:none");var t=$("<form>");$("body").append(e);$("body").append(t);t.attr("style","display:none");t.attr("target","batchTicketDownLoadTemplage");t.attr("method","post");t.attr("action","/api/v1/ticket/generate_excel_template");t.attr("acceptCharset","UTF-8");var i=$("<input>");i.attr("type","hidden");i.attr("name","fields");i.attr("value",JSON.stringify(p));t.append(i);var n=$("<input>");n.attr("type","hidden");n.attr("name","_token");n.attr("value",getCookie("user_token"));t.append(n);t.submit().remove()};d.importExplain=function(){var e=t({scope:i,title:"导入说明",contentTemplate:"source/batch-create-ticket/template/import-explain.html",html:true,show:true,placement:"center",backdrop:"static"})};d.status="initialize";d.fileQueued=function(e){d.status="uploadding";i.$apply()};d.uploadSuccess=function(e,t){if(t.status===0&&t.result){d.status="uploadSuccess";d.analysis_excel_count=t.result.analysis_excel_count;d.analysis_excel_task_id=t.result.analysis_excel_task_id}else{d.status="initialize";n.add(t.result.error_description,"danger")}i.$apply()};function f(){if(!l.type()||l.type()!="enterprise_basic"&&l.type()!="enterprise_trial"&&l.type()!=="enterprise_basic_19"){n.add("您当前的版本不支持批量派单功能，请升级后再使用！","danger");return false}if(!c.hasPermission("batch_ticket_create")){n.add("您没有批量建单权限，不能使用此功能！","danger");return false}return true}d.batchCreateTicket=function(){if(!f()){return false}if(!u.isTrue()){return false}if(a.providerLicense.useDataCapacity&&a.providerLicense.useDataCapacity!==-1){var e=a.providerLicense.useDataCapacity*1024*1024*1024;if(a.providerLicense.attachmentSize>=e&&!a.providerLicense.is_cover_data){n.add("数据空间授权不足","danger");return}}if(a.batchWorker){n.add("上一个批量派单尚未结束，请稍后再试","danger");return}org.ewei.sdk.OperationLogApi().saveOperationLog({action:"CREATE",position:"TICKET",target:"BATCH_CREATE_TICKET"}).then(function(){d.batchCreate()},function(){d.batchCreate()})};d.batchCreate=function(){var t=a.batchWorker=new Worker("/source/scripts/ticket-batch-import-excel.js");t.onmessage=function(e){if(!e.data||!e.data.type)return;switch(e.data.type){case"ready":{t.postMessage({type:"batch-create",config:{analysis_excel_count:d.analysis_excel_count},params:{provider_id:r.provider.id,_token:getCookie("user_token"),analysis_excel_task_id:d.analysis_excel_task_id,_count:50}});break}case"started":{a.$broadcast("batch-started",e.data.data);break}case"progress":{a.$broadcast("batch-progress",e.data.data);break}case"finished":{t.terminate();delete a.batchWorker;d.status="initialize";d.analysis_excel_count=0;d.setFaildData(e.data.data.saveFailedData);if(e.data.data){e.data.data.fromId=d.id}a.$broadcast("batch-finished",e.data.data);break}}}};d.setFaildData=function(e){var n=[];angular.forEach(e,function(e){var t=[],i={};if(e.success&&e.success.length){t=e.success}if(e.error&&e.error.length){angular.forEach(e.error,function(e){t.push(e)})}var i=d.handleData(t);n.push(i)});s.saveFaileExceldData=n};d.handleData=function(e){var a={ccs:[],engineer:null,priority:"",requester:null,serviceCatalog:null,serviceDesk:null,subject:"",tags:[],ticketComment:null,ticketMetric:null,ticketType:null,id:eweiCommon.uuid(32).toLowerCase(),$errorData:{}};angular.forEach(e,function(e){var t,i,n,s;if(e.field==="ccs"){if(e.id&&e.text){a.ccs=d.handleCcs(e)}else if(e.message&&!e.text){a.ccs=[]}}else if(e.field==="handle"){if(e.id&&e.text){if(e.id.indexOf("<")!==-1){n=e.id.substring(e.id.indexOf("<")+1,e.id.indexOf(">"));s=e.text.substring(e.text.indexOf("<")+1,e.text.indexOf(">"));a.engineer={id:n,user:{name:s}}}if(e.id.indexOf("[")!==-1){n=e.id.substring(e.id.indexOf("[")+1,e.id.indexOf("]"));s=e.text.substring(e.text.indexOf("[")+1,e.text.indexOf("]"));a.serviceDesk={id:n,name:s}}}else if(e.message&&!e.text){a.engineer=null}}else if(e.field==="priority"){if(e.text){a.priority=e.text}else if(e.message){a.priority=""}}else if(e.field==="customer"){if(e.id&&e.text){a.requester={id:e.id,name:e.text}}else if(e.message){a.requester=null}}else if(e.field==="service_catalog"){if(e.id&&e.text){t=e.id.split("/");i=e.text.split("/");a.serviceCatalog={id:t[t.length-1],name:i[i.length-1]}}else if(e.message&&!e.text){a.serviceCatalog=null}}else if(e.field==="subject"){if(e.text){a.subject=e.text}else if(e.message){a.subject=""}}else if(e.field==="ticket_type"){if(e.id&&e.text){a.ticketType={id:e.id,name:e.text}}else if(e.message){a.ticketType=null}}else if(e.field==="tags"){if(e.id&&e.text){a.tags=d.handleTags(e)}else if(e.message){a.tags=[]}}else if(e.field==="sla_time"){if(e.text){a.ticketMetric={planSolvedAt:e.text}}else if(e.message){a.ticketMetric=null}}else if(e.field==="ticket_description"){if(e.text){a.ticketComment={content:e.text}}else if(e.message){a.ticketComment={content:null}}}else if(e.field.indexOf("custom_field_")!==-1){if(e.message){a[e.field]={value:null}}else if(e.text){a[e.field]={value:e.text}}}if(e.message){a["$errorData"][e.field]={message:e.message,text:e.text}}});return a};d.handleCcs=function(e){var t=e.id.split(";");var i=e.text.split(";");var n=[],s,a;for(var r=0;r<t.length;r++){if(t[r].indexOf("<")!==-1){s=t[r].substring(t[r].indexOf("<")+1,t[r].indexOf(">"));a=i[r].substring(i[r].indexOf("<")+1,i[r].indexOf(">"));n.push({user:{id:s,name:a}})}else if(t[r].indexOf("[")!==-1){s=t[r].substring(t[r].indexOf("[")+1,t[r].indexOf("]"));a=i[r].substring(i[r].indexOf("[")+1,i[r].indexOf("]"));n.push({serviceDesk:{id:s,name:a}})}else{n.push({email:i[r]})}}return n};d.handleTags=function(e){var t=e.id.split(";");var i=e.text.split(";");var n=[];for(var s=0;s<t.length;s++){var a={id:t[s],name:i[s]};n.push(a)}return n}}})();+function(){"use strict";angular.module("eweiApp.ticket").controller("batchCreateTicketPlanListController",e);e.$inject=["$rootScope","$scope","$state","$filter","$stateParams","ConsoleConfig","alertService","NgTableParams","$modal_","commonTools"];function e(e,n,t,i,s,a,r,o,l,c){n.argument={pageSize:20,pageNumber:1};n.newTicketId=s.id;n.columns=[{field:"subject",length:400,visible:true,title:"工单主题"},{field:"participations",length:180,visible:true,title:"工单处理人"},{field:"schedule",length:180,visible:true,title:"计划排期"},{field:"user.name",length:160,visible:true,title:"计划创建人"},{field:"createdAt",length:180,visible:true,title:"创建于"},{field:"operations",length:180,visible:true,title:"操作"}];function u(){return org.ewei.sdk.OpenTicketPlanApi().list({page:{pageSize:n.argument.pageSize,pageNumber:n.argument.pageNumber}})}function d(e){if(e.schedule.type==="custom"){e.schedule.date=c.parseDate(e.schedule.date)}if(e.schedule.type==="point"){e.schedule.presetTimes=_.map(e.schedule.presetTimes,function(e){return c.parseDateTime(e)})}}function p(){n.tableParams=n.tableParams||new o({page:n.argument.pageNumber,count:n.argument.pageSize},{counts:[],total:0,groupBy:function(){return null},getData:function(t,i){n.argument.pageNumber=i.page();u().then(function(e){n.serverDataLoaded=true;angular.forEach(e.list,function(e){e.participations=JSON.parse(e.participations);e.schedule=JSON.parse(e.schedule);if(e.schedule.presetTimes&&typeof e.schedule.presetTimes==="string"){e.schedule.presetTimes=JSON.parse(e.schedule.presetTimes)}e.ticketData=JSON.parse(e.ticketData);d(e)});i.total(e.recordCount);n.plans=e.list;t.resolve(n.plans)})}})}n.deletePlan=function(e){n._messages="计划删除后，将不再执行，您确定要删除此计划吗？";var t=l({scope:n,title:"删除计划",contentTemplate:"source/views/alter_common.html",html:true,show:true,placement:"center"});n.$hide=function(){t.$promise.then(t.hide)};n.$ok=function(){t.$promise.then(t.hide);n.isLoading=true;org.ewei.sdk.OpenTicketPlanApi().deleted({uid:e}).then(function(e){n.isLoading=false;n.tableParams.reload();r.add("删除成功","success")},function(e){n.isLoading=false;r.add("删除失败","danger")})}};n.setEnabled=_.debounce(function(t,i){org.ewei.sdk.OpenTicketPlanApi().updateState({uid:t.uid,enabled:i}).then(function(e){if(e){t.enabled=i}else{r.add(i?"启用":"停用"+"操作失败！请重试。","danger")}})},1e3);p()}}();+function(){"use strict";angular.module("eweiApp.ticket").controller("batchCreateTicketNewPlanController",e);e.$inject=["$rootScope","$scope","$state","$filter","$stateParams","ConsoleConfig","alertService","license","permissions","emojiService","$q","$http","commonTools","locker","cachedTicket","coreModelService"];function e(e,l,t,a,i,r,c,n,s,u,o,d,p,f,m,g){l.attachments=[];l.newTicket={createType:"plan",isPeriod:false,schedule:{type:"point",presetTimes:[{}]},participations:[{requesters:[]}],ccs:[],ticketComment:{attachments:l.attachments}};try{l.systemFieldSubject=JSON.parse(localStorage["systemFieldSubject"]);l.systemFieldTicketdescription=JSON.parse(localStorage["systemFieldTicketdescription"]);l.typeFiled=angular.fromJson(localStorage.getItem("systemFieldTicketType"));l.priorityFiled=angular.fromJson(localStorage.getItem("systemFieldPriority"));l.catalogFiled=angular.fromJson(localStorage.getItem("systemFieldServiceCatalog"))}catch(e){}if(angular.isObject(m.ticket)&&m.ticket.createType&&m.ticket.createType=="plan"){l.newTicket=m.ticket;h();if(m.ticket&&m.ticket.ticketComment&&m.ticket.ticketComment.attachments&&m.ticket.ticketComment.attachments.length>0){l.attachments=m.ticket.ticketComment.attachments}}l.private_reply={isopenreply:true};l.setOpenNew=function(){l.private_reply.isopenreply=!l.private_reply.isopenreply;l.newTicket.ticketComment.open=l.private_reply.isopenreply};l.gotoPlanList=function(){g.config.route.put("tickets_new_"+i.id,{name:"tickets_new.plan_list",params:{}});t.go("tickets_new.plan_list")};function v(){if(l.ticketCount>=1e3){c.add("每个计划最多允许创建1000张工单，无法添加更多客户了。","danger");return false}return true}l.$on("on-selected-customer",function(e,t,i){if(!v())return;var n=parseInt(i);if(n>=0){l.newTicket.participations[n]=l.newTicket.participations[n]||[];l.newTicket.participations[n].requesters=l.newTicket.participations[n].requesters||[];if(!_.find(l.newTicket.participations[n].requesters,function(e){return e.id===t.id})){l.newTicket.participations[n].requesters.unshift(t)}}h()});l.$on("on-selected-customer-group",function(e,t,i){if(!v())return;var n=parseInt(i);if(n>=0){l.newTicket.participations[n]=l.newTicket.participations[n]||[];l.newTicket.participations[n].requesters=l.newTicket.participations[n].requesters||[];if(!_.find(l.newTicket.participations[n].requesters,function(e){return!e.id&&e.userGroup.id===t.id})){l.newTicket.participations[n].requesters.unshift({userGroup:t})}}h()});function h(){var t=0;angular.forEach(l.newTicket.participations,function(e){e.requesters.forEach(function(e){if(e.type){t++}if(!e.type){t+=e.userGroup.countUser}})});l.ticketCount=t}function y(e,t){e=Math.ceil(e);t=Math.floor(t);return Math.floor(Math.random()*(t-e))+e}function k(){h();if(l.ticketCount>1e3){c.add("每个计划最多仅允许创建1000张工单","danger");return false}switch(l.newTicket.schedule.type){case"point":{for(var e=0;e<l.newTicket.schedule.presetTimes.length;e++){var t=l.newTicket.schedule.presetTimes[e];if(!t.time||!t.date){c.add("请选择排期日期时间！","danger");return false}var i=moment(moment(t.date).format("YYYY-MM-DD")+" "+t.time,"YYYY-MM-DD HH:mm").subtract("30","minutes");if(i.isBefore(moment(),"minute")){c.add("计划开始时间需晚于当前时间30分钟以上","danger");return false}}break}case"custom":{if(!l.newTicket.isPeriod){break}if(!l.newTicket.schedule.date||!l.newTicket.schedule.intervalTime||!l.newTicket.schedule.time){c.add("请选择排期开始日期、时间和间隔！","danger");return false}var i=moment(moment(l.newTicket.schedule.date).format("YYYY-MM-DD")+" "+l.newTicket.schedule.time,"YYYY-MM-DD HH:mm").subtract("30","minutes");if(i.isBefore(moment(),"minute")){c.add("计划起始时间需晚于当前时间30分钟以上","danger");return false}break}case"day":{if(!l.newTicket.isPeriod){break}if(!l.newTicket.schedule.time){c.add("请选择排期时间！","danger");return false}break}case"month":{if(!l.newTicket.isPeriod){break}if(!l.newTicket.schedule.intervalTime||!l.newTicket.schedule.time){c.add("请选择排期日期和时间！","danger");return false}break}case"week":{if(!l.newTicket.isPeriod){break}if(!l.newTicket.schedule.weekDay||!l.newTicket.schedule.time){c.add("请选择排期日期和时间！","danger");return false}break}}for(var e=0;e<l.newTicket.participations.length;e++){var n=l.newTicket.participations[e];if(!n.engineer&&!n.serviceDesk){c.add("请选择处理人！","danger");return false}if(!n.requesters||n.requesters.length===0){c.add("请选择客户！","danger");return false}}var s=u.parseHtmlToSend(l.newTicket.ticketComment.content);var a=angular.copy(s)||"";if(navigator.userAgent.indexOf("Firefox")!==-1){a=a.replace(/&nbsp;/g,"").replace(/<br>/g,"")}a=a.replace(/^\s*|\s*$/g,"");if(l.systemFieldTicketdescription&&l.systemFieldTicketdescription.required&&!/\S/.test(a)&&(l.newTicket.ticketComment&&(!l.newTicket.ticketComment.attachments||l.newTicket.ticketComment.attachments.length==0))){c.add("请填写"+l.systemFieldTicketdescription.title,"danger");return false}if(l.typeFiled&&l.typeFiled.required&&!l.newTicket.ticketType||l.newTicket.ticketType&&!l.newTicket.ticketType.id&&l.typeFiled.required){c.add(l.typeFiled.title+"不能为空","danger");return false}if(l.catalogFiled&&l.catalogFiled.required&&!l.newTicket.serviceCatalog){c.add(l.catalogFiled.title+"不能为空","danger");return false}if(l.priorityFiled&&l.priorityFiled.required&&!l.newTicket.priority){c.add(l.priorityFiled.title+"不能为空","danger");return false}if(l.systemFieldSubject&&l.systemFieldSubject.required&&!l.newTicket.subject){c.add(l.systemFieldSubject.title+"不能为空","danger");return false}var r=l.newTicket.ticketCustomFields;for(var e=0;e<r.length;e++){var o=r[e];if(l.customFormFields&&l.customFormFields.indexOf(o)>-1){if(o.customFormInfo&&!o.customFormInfo.deleted){if(o.customField.required&&(!o.value||o.value=="-")){c.add(o.customField.title+"不能为空","danger");return false}}}else{if(o.customField.sysCustomForm&&o.customField.required&&(!o.value||o.value=="-")){c.add(o.customField.title+"不能为空","danger");return false}}}return true}function C(){var i=angular.copy(l.newTicket);i.ticketCustomFieldsCopy&&delete i.ticketCustomFieldsCopy;i.participations&&delete i.participations;i.schedule&&delete i.schedule;i.workflowTemplate&&delete i.workflowTemplate;i.serviceDesk&&delete i.serviceDesk;var e=["select_ticket_template_show","is_use_template","submit_ticket_template_show","ticketCustomFieldsCopy","selectedCustomers","selectedEngineers","createType"];angular.forEach(e,function(e){if(i.hasOwnProperty(e)){delete i[e]}});i.via={channel:"console",channelName:"客服界面 ",source:r.user.name};var t=u.parseHtmlToSend(i.ticketComment.content);var n=angular.copy(t)||"";if(navigator.userAgent.indexOf("Firefox")!==-1){n=n.replace(/&nbsp;/g,"").replace(/<br>/g,"")}n=n.replace(/^\s*|\s*$/g,"");t=n;if(t){if(t.length>1e4){c.add("消息不能超过10000个字符","danger");return}}i.ticketComment.content=t;var s=[];angular.forEach(i.ccs,function(e){if(e.id&&Object.prototype.toString.call(e.id)==="[object Number]"){if(e.type==="userGroup"){s.push({userGroup:e})}else if(e.type==="serviceDesk"){s.push({serviceDesk:e})}else{s.push({user:e})}}else{s.push({email:e.name})}});i.ccs=s;angular.forEach(i.ticketCustomFields,function(e,t){if(e.value=="-"){e.value=""}if(e.customField&&e.customField.type=="date"&&e.value){i.ticketCustomFields[t].value=a("date")(e.value,"yyyy/MM/dd")}if(e.customField&&e.customField.type=="date_time"&&e.value){i.ticketCustomFields[t].value=a("date")(e.value,"yyyy/MM/dd HH:mm:ss")}});if(i.ticketMetric&&i.ticketMetric.planSolvedAt){i.ticketMetric.planSolvedAt=a("date")(i.ticketMetric.planSolvedAt,"yyyy-MM-dd HH:mm:ss").toString()}return i}function b(){var e={schedule:angular.copy(l.newTicket.schedule),ticketPlan:{isPeriod:l.newTicket.isPeriod,participations:l.newTicket.participations,subject:l.newTicket.subject,ticketData:C()}};if(l.newTicket.isPeriod&&e.schedule.type==="custom"){e.schedule.date=moment(e.schedule.date).format("YYYY-MM-DD");e.schedule.presetTimes=[{}]}if(!l.newTicket.isPeriod&&e.schedule.type==="point"){e.schedule.presetTimes=_.map(e.schedule.presetTimes,function(e){return moment(moment(e.date).format("YYYY-MM-DD")+" "+e.time,"YYYY-MM-DD HH:mm").add(y(0,60),"seconds").format("YYYY-MM-DD HH:mm:ss")});delete e.schedule.date}if(l.newTicket.isPeriod&&e.schedule.presetTimes){e.schedule.presetTimes=[{}]}if(e.schedule.date&&typeof e.schedule.date==="object"){e.schedule.date=moment(e.schedule.date).format("YYYY-MM-DD")}angular.forEach(e.ticketPlan.participations,function(e){if(e.serviceDesk&&e.serviceDesk.engineers&&e.serviceDesk.engineers.length>0){e.serviceDesk.engineers=[]}});return e}function w(){return org.ewei.sdk.OpenTicketPlanApi().getByUid({uid:i.planuid})}function T(e){if(e.schedule.presetTimes){if(typeof e.schedule.presetTimes==="string"){e.schedule.presetTimes=JSON.parse(e.schedule.presetTimes);e.schedule.presetTimes=_.map(e.schedule.presetTimes,function(e){var t=p.parseDateTime(e);return{time:moment(t).format("HH:mm"),date:t}})}else{e.schedule.presetTimes.forEach(function(e){if(typeof e.date==="string"){e.date=moment(e.date).toDate()}})}}if(e.schedule.date&&typeof e.schedule.date==="string"){e.schedule.date=moment(e.schedule.date,"YYYY-MM-DD").toDate()}}function S(n){n.ticketData=JSON.parse(n.ticketData);l.newTicket=Object.assign(l.newTicket,n.ticketData);l.newTicket.schedule=n.schedule=JSON.parse(n.schedule);T(n);l.newTicket.participations=n.participations=JSON.parse(n.participations);l.newTicket.isPeriod=n.ticketData.isPeriod;l.newTicket.subject=n.ticketData.subject;if(n.ticketData.ticketComment&&n.ticketData.ticketComment.open===false){l.setOpenNew()}l.attachments.splice(0,l.attachments.length);if(l.newTicket.tags&&!n.ticketData.tags){delete l.newTicket.tags}if(n.ticketData.ticketComment&&n.ticketData.ticketComment.attachments&&n.ticketData.ticketComment.attachments.length>0){if(i.clone){var e=_.map(n.ticketData.ticketComment.attachments,function(e){return e.id});var t=o.defer();org.ewei.sdk.OpenAttachmentApi().batchCopyAttachment({attachmentIds:e}).then(function(e){angular.forEach(e,function(e,t){var i=n.ticketData.ticketComment.attachments[t];i.id=e;l.attachments.push(i)});t.resolve(n)},function(e){t.reject(e)});return t.promise}else{angular.forEach(n.ticketData.ticketComment.attachments,function(e){l.attachments.push(e)});return o.resolve(n)}}else{return o.resolve(n)}}l.cancel=function(){t.go("tickets_new.plan_list",{id:i.id})};l.save=function(){if(k()){var e=b();l.saving=true;if(i.planuid&&!i.clone){e.ticketPlan.uid=i.planuid;org.ewei.sdk.OpenTicketPlanApi().update(e).then(function(e){l.saving=false;if(e){c.add("计划修改成功！");f.driver("session").namespace("eweiApp.chat").forget(i.id);f.forget(i.id);m.noSave=true;t.go("tickets_new.plan_list",{id:i.id})}else{c.add("保存计划出错！","danger")}},function(e){l.saving=false;if(e&&e.error_description){c.add(e.error_description,"danger")}else{c.add("保存计划出错！","danger")}})}else{org.ewei.sdk.OpenTicketPlanApi().save(e).then(function(e){l.saving=false;if(e){c.add("计划创建成功！");m.noSave=true;f.driver("session").namespace("eweiApp.chat").forget(i.id);f.forget(i.id);t.go("tickets_new.plan_list",{id:i.id})}else{c.add("保存计划出错！","danger")}},function(e){l.saving=false;if(e&&e.error_description){c.add(e.error_description,"danger")}else{c.add("保存计划出错！","danger")}})}}};l.$watch("newTicket",function(e,t,i){if(e!==t){m.ticket=angular.copy(e)}},true);l.showCustomForm=false;l.toggleCustomForm=function(e){l.showCustomForm=e};function F(){if(!l.newTicket||!l.newTicket.ticketType||!l.newTicket.ticketType.id){return o.resolve(null)}return d({url:"/api/v1/ticket_custom_form/get/"+l.newTicket.ticketType.id+".json",method:"GET"}).then(function(e){if(e.data&&e.data.status==0&&e.data.result){l.lastCustomFormTicketTypeId=l.newTicket.ticketType.id;return e.data.result.ticketCustomForm}else{return o.reject(e.data)}})}function A(){if(!l.newTicket||!l.newTicket.ticketCustomFields){return}if(l.customFormLoading||l.newTicket&&l.newTicket.ticketType&&l.lastCustomFormTicketTypeId===l.newTicket.ticketType.id){return}l.customFormLoading=true;F().then(function(e){l.customFormLoading=false;if(e&&e.customFormFields){var i=[];angular.forEach(e.customFormFields,function(t){var e=_.find(l.newTicket.ticketCustomFields,function(e){return t&&t.customField&&t.customField.id==e.id});if(e&&!e.customField.sysCustomForm){if(!e.sysCustomForm&&(!t.deleted||t.deleted&&e.value&&(l.newTicket.status=="solved"||l.newTicket.status=="closed"))){e.customFormInfo={deleted:t.deleted,position:t.position};i.push(e)}}});l.customFormFields=_.sortBy(i,function(e){return e.customFormInfo.position});l.showCustomForm=l.customFormFields.length>0}else{l.showCustomForm=false;l.customFormFields=[]}},function(e){c.add("获取扩展表单失败，请重试！","danger")})}A();l.$watch("newTicket.ticketType",function(e,t){if(e!==t){A()}},true);l.$watchCollection("newTicket.ticketCustomFields",function(e,t){if(e!==t){if(e&&!t){A();return}var i=false;for(var n=0;n<e.length;n++){if(e[n]!=t[n]&&e[n].id!=t[n].id){i=true;break}}if(i){A()}}});l.$watchCollection("attachments",function(e,t,i){if(e!==t&&l.newTicket.ticketComment){l.newTicket.ticketComment.attachments=l.attachments}},true);l.$on("paricipation-updated",h);l.$on("ticket-plan-form-requester-updated",h);e.$on("ticket-cached-no-save",function(e,t){if(t){m.noSave=true}});l.editMode="new";if(i.planuid){if(!i.clone){l.editMode="edit"}else{l.editMode="clone"}if(i.clone&&angular.isObject(m.ticket)&&m.ticket.createType&&m.ticket.createType=="plan"){T(l.newTicket);return}w().then(function(e){S(e).then(function(){l.$broadcast("ticket-loaded");h()})})}else if(angular.isObject(m.ticket)&&m.ticket.createType&&m.ticket.createType=="plan"){T(l.newTicket)}}}();+function(){"use strict";angular.module("com.ewei.angular.ui").controller("ticketPlanFormController",e).directive("ticketPlanForm",t);e.$inject=["$scope","alertService","$filter","commonTools","permissions"];function e(n,e,t,i,s){n.datePickerState={periodDateStartOpened:false};n.weekData=[{key:"MON",value:"星期一"},{key:"TUE",value:"星期二"},{key:"WED",value:"星期三"},{key:"THU",value:"星期四"},{key:"FRI",value:"星期五"},{key:"SAT",value:"星期六"},{key:"SUN",value:"星期日"}];n.timeList=[];for(var a=0;a<24;a++){n.timeList[a]=a<10?"0"+a+":00":a+":00"}n.monthData=[];for(var a=1;a<=31;a++){n.monthData.push(a.toString())}n.presetTimeDatePickerOpened=[];n.datePickerOptions={minDate:new Date,showWeeks:false};n.toggleDatePicker=function(e,t,i){e.preventDefault();e.stopPropagation();if(t==="preset_time"){n.presetTimeDatePickerOpened[i]=!n.presetTimeDatePickerOpened[i]}else{n.datePickerState[t]=!n.datePickerState[t]}};n.changePlanType=function(e){if(e==="point"){n.plan.schedule.type="point"}else{if(!n.plan.schedule.presetTimes||n.plan.schedule.presetTimes.length==0){n.plan.schedule.presetTimes=[{}]}}};n.addPresetTime=function(){if(n.plan.schedule.presetTimes.length>24){return}n.plan.schedule.presetTimes.push({})};n.removePresetTime=function(e){if(n.plan.schedule.presetTimes.length>e){n.plan.schedule.presetTimes.splice(e,1)}};n.addParticipator=function(){n.plan.participations.push({requesters:[]});n.$emit("paricipation-updated")};n.removeParticipator=function(e){if(n.plan.participations.length>e){n.plan.participations.splice(e,1);n.$emit("paricipation-updated")}};n.removeRequester=function(e,t){if(e&&e.length>t){e.splice(t,1);n.$emit("ticket-plan-form-requester-updated")}}}t.$inject=[];function t(){return{restrict:"E",replace:true,templateUrl:"/source/scripts/directives/ticket-plan-form/ticket-plan-form.html",controller:"ticketPlanFormController",scope:{plan:"="}}}}();+function(){"use strict";angular.module("eweiApp.system_setting").config(e);e.$inject=["$stateProvider","$urlRouterProvider"];function e(e,t){e.state("system_setting.robot-setting_edit",{url:"/intelligent-robot/robot-setting/:type/:ids",controller:"robotSettingEditController",templateUrl:"source/system-setting/intelligent-robot/template/robot-setting-edit.html",permission:"automaton_manage",params:{type:"add",ids:"0",title:""}}).state("system_setting.robot_knowledge_edit",{url:"/intelligent-robot/robot-knowledge/:selectId/:type/:id",controller:"robotKnowledgeEditController",templateUrl:"source/system-setting/intelligent-robot/template/robot-knowledge-edit.html",permission:"automaton_manage",params:{type:"add",id:"0",title:"",selectId:"0"}}).state("system_setting.robot_knowledge_import",{url:"/intelligent-robot/robot-knowledge/import",controller:"robotKnowledgeImportController",templateUrl:"source/system-setting/intelligent-robot/template/robot-knowledge-import.html",permission:"automaton_manage"})}}();+function(){"use strict";angular.module("eweiApp.system_setting").service("intelligentRobotService",["$resource",function(e){var r=this;r.list2Tree=function(i,n){var s=[];i.forEach(function(e){if(e.pid===n){var t=JSON.parse(JSON.stringify(e));t.children=r.list2Tree(i,e.id);s.push(t)}});if(s.length>0){s.sort(function(e,t){return e.order-t.order})}return s};r.traverse=function(e,t){if(e){t(e);if(e.children&&e.children.length>0){e.children.forEach(function(e){r.traverse(e,t)})}}};r.getCascadeChain=function(i,n,s){var a=[];i.forEach(function(e){if(n===e.id){a.push(e[s]);var t=r.getCascadeChain(i,e.pid,s);a=t.concat(a)}});return a}}])}();+function(){"use strict";angular.module("eweiApp.system_setting").controller("robotSettingController",e);e.$inject=["$scope","$state","alertService","$modal_"];function e(s,i,a,e){s.page={pageSize:99999,pageNumber:1};s.reload=function(){org.ewei.sdk.OpenAutomatonApi().list({page:s.page}).then(function(e){s.robotList=e.list;s.allCount=e.recordCount})};s.reload();s.searchRobot=function(){if(!s.searchKey||s.searchKey==s.oldSearchKey){return}s.oldSearchKey=angular.copy(s.searchKey);var n=[];angular.forEach(s.robotList,function(e,t,i){if(e.name.indexOf(s.searchKey)>-1){n.push(e)}});s.robotList=n};s.cancelSearch=function(){s.oldSearchKey="";s.searchKey="";s.page.pageNumber=1;s.reload()};s.$watch("searchKey",function(e,t){if(e==""&&s.oldSearchKey){s.oldSearchKey="";s.page.pageNumber=1;s.reload()}});s.active=function(t,i){if(!i){s._messages="您确定停用吗？";var n=e({scope:s,title:"停用确认",contentTemplate:"source/views/alter_common.html",html:true,show:true,placement:"center"});s.$ok=function(){s.isLoading=true;org.ewei.sdk.OpenAutomatonApi().active({id:t.id,active:i}).then(function(e){if(e){s.isLoading=false;a.add("停用成功","success");t.active=i;s.reload();n.$promise.then(n.hide)}else{s.isLoading=false;a.add("停用失败","danger")}})};s.$hide=function(){n.$promise.then(n.hide)}}else{org.ewei.sdk.OpenAutomatonApi().active({id:t.id,active:i}).then(function(e){if(e){t.active=i;s.reload()}else{a.add("启用失败","danger")}})}};s.toEditRobot=function(e,t){i.go("system_setting.robot-setting_edit",{ids:e===0?0:e.id,title:e.name,type:t})};s.deleteRobot=function(t){s._messages="机器人删除后无法恢复，请谨慎操作。确定删除？";var i=e({scope:s,title:"删除确认",contentTemplate:"source/views/alter_common.html",html:true,show:true,placement:"center"});s.$ok=function(){if(s.robotList.indexOf(t)===-1){return false}s.isLoading=true;org.ewei.sdk.OpenAutomatonApi().delete({id:t.id}).then(function(e){if(e){s.robotList.splice(s.robotList.indexOf(t),1);s.isLoading=false;a.add("删除成功","success");i.$promise.then(i.hide);s.allCount--}else{s.isLoading=false;a.add("删除失败","danger")}})};s.$hide=function(){i.$promise.then(i.hide)}};s.robotTest=function(e){s.selectRobotTest=e;s.showRobot=true}}}();+function(){"use strict";angular.module("eweiApp.system_setting").controller("robotSettingEditController",e);e.$inject=["$scope","$state","$filter","$http","ConsoleConfig","alertService"];function e(s,i,n,e,t,a){s.eweiHelpcenterApiUrl=t.eweiHelpcenterApiUrl;s.robotName=i.params.type&&i.params.type==="add"?"添加机器人":i.params.title;var r={name:"",remark:"",type:"knowledge",photo:null,welcomeArticleReply:"欢迎光临，请问有什么可以帮到你？",articleReply:"下列文章供你参考，<br>{{article_list}}<br>",missArticleReply:"抱歉，能否再描述一下您的问题，没太听懂呢~",turnArticleReply:"没有帮助，输入999可接通人工",welcomeKnowledgeReply:"你好，请问有什么可以帮您？",knowledgeReply:"您是想问？",missKnowledgeReply:'抱歉，没有找到您要的答案，如需帮助请联系<staff_service style="color: #6699CC;">人工客服</staff_service>。',missKnowledgeReplyWeixin:'抱歉，没有找到您要的答案，如需人工客服请回复"rg"或"人工客服"',isTurnKnowledge:"1",turnKnowledgeReply:'以上都不是，请联系<staff_service style="color: #6699CC;">人工客服</staff_service>。',turnKnowledgeReplyWeixin:'以上都不是，请回复"rg"或"人工客服"转人工',recommend:false,recommendReply:"常见问题",recommendKnowledges:[{}]};if(i.params.ids>0&&i.params.type=="modify"){org.ewei.sdk.OpenAutomatonApi().findById({id:i.params.ids}).then({success:function(e){s.robotName=e.name;s.robotConfig=e||{};if(e.type==="article"){s.oldRobotConfig={type:e.type,welcomeArticleReply:e.welcomeArticleReply,articleReply:e.articleReply,missArticleReply:e.missArticleReply,turnArticleReply:e.turnArticleReply}}else if(e.type==="knowledge"){s.oldRobotConfig={type:e.type,welcomeKnowledgeReply:e.welcomeKnowledgeReply,knowledgeReply:e.knowledgeReply,missKnowledgeReply:e.missKnowledgeReply,missKnowledgeReplyWeixin:e.missKnowledgeReplyWeixin}}if(s.robotConfig.photo&&s.robotConfig.photo.contentUrl){s.imgUrl="/no_auth_ewei_attachment?contentUrl="+s.robotConfig.photo.contentUrl}else{s.imgUrl="source/images/face/robot.jpg"}}})}else{setTimeout(function(){s.robotConfig=angular.copy(r);s.oldRobotConfig=angular.copy(r);s.imgUrl="source/images/face/robot.jpg";s.$apply()},0)}s.uploadSuccess=function(t,i){s.imgUrl="/no_auth_ewei_attachment?contentUrl="+i.key;s.$apply();org.ewei.sdk.AttachmentApi().save({attachment:{fileName:t.name,contentType:t.type,contentUrl:i.key,size:t.size}}).then(function(e){s.robotConfig.photo={id:e,contentUrl:i.key,fileName:t.name}})};s.error=function(e){if(e=="F_EXCEED_SIZE"){a.add("上传文件不能大于200K。","danger")}};s.deleteProblem=function(e,t){if(s.robotConfig.recommendKnowledges&&s.robotConfig.recommendKnowledges.length<=1){return}s.robotConfig.recommendKnowledges.splice(e,1)};s.addProblem=function(){if(s.robotConfig.recommendKnowledges){s.robotConfig.recommendKnowledges.push({})}else{s.robotConfig.recommendKnowledges=[{}]}};s.$watch("robotConfig.recommend",function(e,t){if(e&&!s.options){org.ewei.sdk.KnowledgeApi().listByCondition({page:{pageSize:99999,pageNumber:1},conditions:{knowledgeCatalogIds:null,searchKey:""}}).then(function(e){if(e.list){s.options=e.list.filter(function(e){return e.active&&!e.deleted})}});return}});s.$watch("robotConfig.type",function(e,t){if(!e||!t){return}var i;if(s.oldRobotConfig.type===e){i=s.oldRobotConfig}else{if(e==="article"){i={type:"article",welcomeArticleReply:"欢迎光临，请问有什么可以帮到你？",articleReply:"下列文章供你参考，<br>{{article_list}}<br>",missArticleReply:"抱歉，能否再描述一下您的问题，没太听懂呢~",turnArticleReply:"没有帮助，输入999可接通人工",turnKnowledgeReply:'以上都不是，请联系<staff_service style="color: #6699CC;">人工客服</staff_service>。',turnKnowledgeReplyWeixin:'以上都不是，请回复"rg"或"人工客服"转人工'}}else{i={type:"knowledge",welcomeKnowledgeReply:"你好，请问有什么可以帮您？",knowledgeReply:"您是想问？",missKnowledgeReply:'抱歉，没有找到您要的答案，如需帮助请联系<staff_service style="color: #6699CC;">人工客服</staff_service>。',missKnowledgeReplyWeixin:'抱歉，没有找到您要的答案，如需人工客服请回复"rg"或"人工客服"'}}}for(var n in i){if(i.hasOwnProperty(n)){s.robotConfig[n]=i[n]}}});var o=function(e,t){if(s.robotConfig[e]&&s.robotConfig[e].length>=1024){return false}return true};s.recover=function(e){s.robotConfig[e]=r[e]};s.onSelected=function(e,t){s.robotConfig.recommendKnowledges[t]=e};s.update=function(){if(!s.robotConfig.name){a.add("名称不能为空","danger");return false}if(n("specialChart")(s.robotConfig.name)){a.add("名称不支持除中划线，下划线以外的特殊字符","danger");return false}if(n("specialChart")(s.robotConfig.remark)){a.add("备注不支持除中划线，下划线以外的特殊字符","danger");return false}if(s.robotConfig.type==="article"){if(!o("welcomeArticleReply")){a.add("欢迎语 不能超过1024个字符","danger");return false}if(!o("articleReply")){a.add("帮助文档关键词命中 不能超过1024个字符","danger");return false}if(!o("missArticleReply")){a.add("关键词未命中 不能超过1024个字符","danger");return false}if(!o("turnArticleReply")){a.add("转人工引导 不能超过1024个字符","danger");return false}}else{if(!o("welcomeKnowledgeReply")){a.add("欢迎语 不能超过1024个字符","danger");return false}if(!o("knowledgeReply")){a.add("相似问题引导 不能超过1024个字符","danger");return false}if(!o("missKnowledgeReply")){a.add("未匹配到问题 不能超过1024个字符","danger");return false}if(!o("missKnowledgeReplyWeixin")){a.add("微信渠道 不能超过1024个字符","danger");return false}}if(s.robotConfig.recommendKnowledges&&s.robotConfig.recommendKnowledges.length>0){var e=s.robotConfig.recommendKnowledges.map(function(e){return e.id});s.robotConfig.recommendKnowledgeIds=JSON.stringify(e)}var t=angular.copy(s.robotConfig);delete t.recommendKnowledges;t.photoId=t.photo&&t.photo.id||null;Object.keys(t).forEach(function(e){if(typeof t[e]==="string"){t[e]=t[e].replace(/&amp;/g,"&")}});if(t.id){org.ewei.sdk.OpenAutomatonApi().updateAutomaton({automaton:t}).then({success:function(e){if(e){a.add("更新成功","success");if(t.type==="article"){s.oldRobotConfig={type:t.type,welcomeArticleReply:t.welcomeArticleReply,articleReply:t.articleReply,missArticleReply:t.missArticleReply,turnArticleReply:t.turnArticleReply}}else if(t.type==="knowledge"){s.oldRobotConfig={type:t.type,welcomeKnowledgeReply:t.welcomeKnowledgeReply,knowledgeReply:t.knowledgeReply,missKnowledgeReply:t.missKnowledgeReply,missKnowledgeReplyWeixin:t.missKnowledgeReplyWeixin}}}}})}else{org.ewei.sdk.OpenAutomatonApi().save({automaton:t}).then({success:function(e){if(e){a.add("新增成功","success");i.go("system_setting.robot-setting_edit",{type:"modify",ids:e,name:s.robotConfig.name})}}})}}}}();+function(){"use strict";angular.module("eweiApp.system_setting").controller("robotKnowledgeController",e);e.$inject=["$scope","$state","$modal_","intelligentRobotService","alertService"];function e(s,i,e,t,a){s.list={name:"全部问题",pid:0,id:0,level:0,children:[],isopen:true};s.loadCatalog=function(){org.ewei.sdk.KnowledgeCatalogApi().list({}).then(function(e){s.list.children=t.list2Tree(e,0)})};s.loadCatalog();var n=function(e){var i=[e.id];if(e.children&&e.children.length>0){e.children.forEach(function(e){var t=n(e);i=i.concat(t)})}return i};s.$on("select-tree",function(e,t){s.selectid=t.id;s.knowledgeCatalogIds=n(t);s.page.pageNumber=1;s.reload()});s.page={pageSize:11,pageNumber:1};s.reload=function(){org.ewei.sdk.KnowledgeApi().listByCondition({page:s.page,conditions:{knowledgeCatalogIds:s.knowledgeCatalogIds,searchKey:s.searchKey}}).then(function(e){s.knowledgeList=e.list;s.allCount=e.recordCount})};s.reload();s.searchKnowledge=function(){if(!s.searchKey||s.searchKey==s.oldSearchKey){return}s.oldSearchKey=angular.copy(s.searchKey);s.page.pageNumber=1;s.reload()};s.cancelSearch=function(){s.oldSearchKey="";s.searchKey="";s.page.pageNumber=1;s.reload()};s.$watch("searchKey",function(e,t){if(e==""&&s.oldSearchKey){s.oldSearchKey="";s.page.pageNumber=1;s.reload()}});s.active=function(t,i){if(!i){s._messages="停用的问题将不再被机器人引用，是否继续？";var n=e({scope:s,title:"停用确认",contentTemplate:"source/views/alter_common.html",html:true,show:true,placement:"center"});s.$ok=function(){s.isLoading=true;org.ewei.sdk.KnowledgeApi().active({id:t.id,active:i}).then(function(e){if(e){s.isLoading=false;a.add("停用成功","success");t.active=i;s.reload();n.$promise.then(n.hide)}else{s.isLoading=false;a.add("停用失败","danger")}})};s.$hide=function(){n.$promise.then(n.hide)}}else{org.ewei.sdk.KnowledgeApi().active({id:t.id,active:i}).then(function(e){if(e){t.active=i;s.reload()}else{a.add("启用失败","danger")}})}};s.importExcel=function(){i.go("system_setting.robot_knowledge_import")};s.toEditKnowledge=function(e,t){i.go("system_setting.robot_knowledge_edit",{id:e===0?0:e.id,title:e.title,type:t,selectId:s.selectid||"0"})};s.deleteKnowledge=function(t){s._messages="删除问题后无法恢复，是否继续？";var i=e({scope:s,title:"删除确认",contentTemplate:"source/views/alter_common.html",html:true,show:true,placement:"center"});s.$ok=function(){if(s.knowledgeList.indexOf(t)===-1){return false}s.isLoading=true;org.ewei.sdk.KnowledgeApi().delete({id:t.id}).then(function(e){if(e){s.knowledgeList.splice(s.knowledgeList.indexOf(t),1);s.isLoading=false;a.add("删除成功","success");i.$promise.then(i.hide);s.allCount--}else{s.isLoading=false;a.add("删除失败","danger")}})};s.$hide=function(){i.$promise.then(i.hide)}}}}();+function(){"use strict";angular.module("eweiApp.system_setting").controller("robotKnowledgeEditController",e);e.$inject=["$scope","$modal_","$state","alertService","intelligentRobotService"];function e(i,n,s,a,t){i.title=s.params.type&&s.params.type==="add"?"添加问题":s.params.title;if(s.params.id>0&&s.params.type=="modify"){org.ewei.sdk.KnowledgeApi().findById({id:s.params.id}).then({success:function(e){i.title=e.title;i.knowledge=e||{};if(e.similarTitle){var t=e.similarTitle.split(",");i.knowledge.problems=t.map(function(e){return{value:e}})}else{i.knowledge.problems=[]}}})}else{i.knowledge={title:s.params.title,answer:"",active:true,problems:[]};i.knowledge.knowledgeCatalog=!s.params.selectId||s.params.selectId=="0"?"":{id:s.params.selectId}}i.loadCatalog=function(){org.ewei.sdk.KnowledgeCatalogApi().list({}).then(function(e){i.list=t.list2Tree(e,0)})};i.loadCatalog();i.checkProblem=function(){var t={};i.knowledge.problems.forEach(function(e){if(t[e.value]){t[e.value]++}else{t[e.value]=1}e.repeat=t[e.value]})};i.deActiveKnowledge=function(e){i._messages="停用的问题将不再被机器人引用，是否继续？";var t=n({scope:i,title:"停用确认",contentTemplate:"source/views/alter_common.html",html:true,show:true,placement:"center"});i.$ok=function(){org.ewei.sdk.KnowledgeApi().active({id:e.id,active:false}).then(function(e){if(e){i.$hide();a.add("停用成功","success");i.searchKnowledge()}else{i.$hide();a.add("停用失败","danger")}})};i.$hide=function(){t.$promise.then(t.hide)}};i.searchKnowledge=function(){if(!i.knowledge.title){i.knowledgeList=[];return}org.ewei.sdk.KnowledgeApi().listByCondition({page:{pageSize:5,pageNumber:1},conditions:{searchKey:i.knowledge.title,active:true}}).then(function(e){i.knowledgeList=e.list})};i.deleteProblem=function(e,t){i.knowledge.problems.splice(e,1)};i.addProblem=function(){i.knowledge.problems.push({value:""})};i.update=function(){if(!i.knowledge.title){a.add("问题不能为空","danger");return false}if(!i.knowledge.answer){a.add("答案不能为空","danger");return false}if(!i.knowledge.knowledgeCatalog){a.add("所属分类不能为空","danger");return false}if(i.knowledge.answer.length>1024){a.add("答案 不能超过1024个字符","danger");return false}var e=angular.copy(i.knowledge);var t=e.problems.map(function(e){return e.value});t=_.uniq(t);if(e.problems.length!==t.length){a.add("相似问题不能重复","danger");return false}e.similarTitle=e.problems.map(function(e){return e.value}).join(",");delete e.problems;e.answer=e.answer.replace(/&amp;/g,"&");if(s.params.id>0&&s.params.type=="modify"){org.ewei.sdk.KnowledgeApi().update({knowledge:e}).then(function(e){if(e){a.add("修改成功","success")}})}else{org.ewei.sdk.KnowledgeApi().save({knowledge:e}).then(function(e){if(e){a.add("新增成功","success");s.go("system_setting.robot_knowledge_edit",{type:"modify",id:e,title:i.knowledge.title})}})}}}}();+function(){"use strict";angular.module("eweiApp.system_setting").controller("robotKnowledgeImportController",e);e.$inject=["$scope","$state","$modal_","intelligentRobotService","alertService","$queue"];function e(o,e,i,l,t,n){var s=/^[ ]*$/;o.excel={importAbort:false,importPause:false,imported:false,isBaseErr:false,isDataErr:false,file:"",successCount:0,failedCount:0};o.processPercent=0;o.knowledgeFields=[];o.knowledgeList=[];o.errKnowledgeList=[];o.errLogList=[];o.catalogList=[];function a(){o.errLogList=[];o.knowledgeList=[];o.errKnowledgeList=[];o.excel.importAbort=false;o.excel.importPause=false;o.excel.imported=false;o.excel.isBaseErr=false;o.excel.isDataErr=false;o.excel.file="";o.excel.successCount=0;o.excel.failedCount=0;o.processPercent=0;w.forEach(function(e){clearTimeout(e)})}function c(t,e){var i=e+1;var n={status:true,result:[]};o.knowledgeFields.forEach(function(e){if(e.required){if(s.test(t[e.key])||!t[e.key]){n.status=false;n.result.push({info:"第"+i+"行："+e.key+"：没有数据!"})}}if(e.maxLength&&t[e.key]){if(t[e.key].length>e.maxLength){n.status=false;n.result.push({info:"第"+i+"行："+e.key+"：数据超长! 最长 "+e.maxLength+" 字符"})}}});return n}function u(e){o.excel.successCount+=1;o.processPercent=Math.round((e+1)/o.knowledgeList.length*100);if(e+1===o.knowledgeList.length){o.$hide();o.excel.imported=true;p()}}function d(e,t,i){o.excel.isDataErr=true;o.excel.failedCount+=1;o.errLogList=o.errLogList.concat(i);o.processPercent=Math.round((t+1)/o.knowledgeList.length*100);o.errKnowledgeList.push(e);if(t+1===o.knowledgeList.length){o.$hide();o.excel.imported=true;p()}}function r(e){var t=new ArrayBuffer(e.length);var i=new Uint8Array(t);for(var n=0;n!==e.length;++n)i[n]=e.charCodeAt(n)&255;return t}function p(){var t=[];o.knowledgeFields.forEach(function(e){t.push(e.key)});var e=XLSX.utils.json_to_sheet(o.errKnowledgeList,{header:t});e["!cols"]=_.map(o.knowledgeFields,function(e){if(!e.maxLength||e.maxLength>100){return{wpx:100}}return{wpx:e.maxLength}});e["!rows"]=[{hpx:30}];var i=XLSX.utils.book_new();XLSX.utils.book_append_sheet(i,e);var n={bookType:"xlsx",bookSST:false,type:"binary",cellStyles:true,showGridLines:false};var s=XLSX.write(i,n);var a=new Blob([r(s)],{type:"application/octet-stream"});o.errExcelFile=URL.createObjectURL(a);o.errExcelFileName="机器人知识库"+moment().format("YYYYMMDDHHmm")+".xlsx"}function f(){o.knowledgeFields.push({key:"问题*",type:"text",required:true,maxLength:64});o.knowledgeFields.push({key:"答案*",type:"text",required:true,maxLength:1024});o.knowledgeFields.push({key:"一级分类*",type:"text",required:true});o.knowledgeFields.push({key:"二级分类",type:"text"});o.knowledgeFields.push({key:"三级分类",type:"text"});o.knowledgeFields.push({key:"四级分类",type:"text"});o.knowledgeFields.push({key:"五级分类",type:"text"});o.knowledgeFields.push({key:"相似问题1",type:"text",maxLength:64});o.knowledgeFields.push({key:"相似问题2",type:"text",maxLength:64});o.knowledgeFields.push({key:"相似问题3",type:"text",maxLength:64});o.knowledgeFields.push({key:"相似问题4",type:"text",maxLength:64});o.knowledgeFields.push({key:"相似问题5",type:"text",maxLength:64})}function m(e){var i=JSON.parse(JSON.stringify(o.catalogList));var n=[];e.forEach(function(t){i.forEach(function(e){if(e.name===t){n.push(e)}})});var t={id:0,name:"root",children:l.list2Tree(n,0)};var s=[];l.traverse(t,function(e){if(!e.children||e.children.length===0){s.push(e.id)}});var a={};s.forEach(function(e){var t=l.getCascadeChain(n,e,"name");a[t.join("/")]=e});var r=a[e.join("/")];if(r){return{id:r}}return null}function g(t,e){var i=e+1;var n={status:true,result:[]};var s=[];for(var a=1;a<=5;a++){if(t["相似问题"+a]){s.push(t["相似问题"+a])}}var r=[];s.forEach(function(e){if(r.indexOf(e)<0){r.push(e)}});if(r.length!==s.length){n.status=false;n.result.push({info:"第"+i+"行：相似问题重复"})}t.similarTitle=s.join(",");var o=[],l=[];t.knowledgeCatalog=null;["一级分类*","二级分类","三级分类","四级分类","五级分类"].forEach(function(e){o.push(t[e])});l=JSON.parse(JSON.stringify(o));for(var a=o.length-1;a>=0;a--){if(o[a]){break}else{l.splice(a,1)}}t.knowledgeCatalog=m(l);if(!t.knowledgeCatalog){n.status=false;n.result.push({info:"第"+i+"行：分类不存在"})}return n}function v(e){return{active:true,answer:e["答案*"],title:e["问题*"],similarTitle:e["similarTitle"],knowledgeCatalog:e["knowledgeCatalog"]}}var h=function(e){var t=e.idx;var i=t+1;var n=e.knowledge;var s=JSON.parse(JSON.stringify(e.knowledge));var a=c(s,t);var r=g(s,t);if(a.status&&r.status){org.ewei.sdk.KnowledgeApi().save({knowledge:v(s)}).then(function(e){u(t)},function(e){if(e.stack){d(n,t,[{info:"第"+i+"行："+httpErrTrans(e.message)}])}else if(e.error_code===1001){d(n,t,[{info:"第"+i+"行：编号：重复"}])}else{d(n,t,[{info:"第"+i+"行："+e.error_description}])}})}else{d(n,t,a.result.concat(r.result))}};var y=null;y=n.queue(h);function k(e){for(var t=0;t<e.length;t++){y.add({idx:t,knowledge:e[t]})}y.start()}function C(){org.ewei.sdk.KnowledgeCatalogApi().list({}).then(function(e){o.catalogList=e})}function b(e){o.errLogList.push(e);w.push(setTimeout(function(){o.excel.isBaseErr=true;o.excel.imported=true;o.$apply()},100))}o.cancel=function(){if(y){y.clear()}o.$hide()};var w=[];o.loaded=function(e){a();if(e.status){if(e.data.length===0){b({info:"没有数据需要导入"});return}var t=i({scope:o,backdrop:"static",keyboard:false,template:"modal/modal.tpl.w380.html",contentTemplate:"source/system-setting/intelligent-robot/template/robot-knowledge-import-process.html",html:true,show:true,placement:"center",hideCallback:function(){if(y){y.clear()}}});o.$hide=function(){t.$promise.then(t.hide)};w.push(setTimeout(function(){k(o.knowledgeList=e.data)},100))}else{b({info:e.data})}};f();C()}}();+function(){"use strict";angular.module("eweiApp.system_setting").controller("robotUnknownKnowledgeController",e);e.$inject=["$scope","$state","$modal_","intelligentRobotService","alertService"];function e(i,t,n,e,s){i.unknownKnowledgeList=[];i.page={pageSize:20,pageNumber:1};i.getUnknownKnowledgeList=function(){org.ewei.sdk.UnknownKnowledgeApi().list({page:i.page}).then(function(e){i.unknownKnowledgeList=e.list;i.allCount=e.recordCount})};i.getUnknownKnowledgeList();i.createKnowledge=function(e){t.go("system_setting.robot_knowledge_edit",{id:0,title:e.title,type:"add",selectId:"0"})};i.remove=function(e){i._messages="删除问题后无法恢复，是否继续？";var t=n({scope:i,title:"删除确认",contentTemplate:"source/views/alter_common.html",html:true,show:true,placement:"center"});i.$ok=function(){org.ewei.sdk.UnknownKnowledgeApi().delete({id:e.id}).then(function(e){if(e){i.getUnknownKnowledgeList();t.$promise.then(t.hide)}else{s.add("删除失败","danger")}})};i.$hide=function(){t.$promise.then(t.hide)}}}}();