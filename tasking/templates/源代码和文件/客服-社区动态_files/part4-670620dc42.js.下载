(function(){angular.module("eweiApp.dashboard",[]).config(e).controller("mainCtrl",t).directive("dashTable",function(){return{restrict:"E",transclude:true,replace:true,templateUrl:"source/dashboard/dash-table/dash-table.html"}});e.$inject=["$stateProvider","$urlRouterProvider"];function e(e,t){e.state("quickentry.dashboard",{abstract:true,templateUrl:"source/dashboard/main.html",controller:"mainCtrl"}).state("quickentry.dashboard.home",{url:"/dashboard",templateUrl:"source/dashboard/dashboard.new.html",controller:"DashboardCtrlNew",controllerAs:"dashboard"}).state("quickentry.dashboard.chatQueue",{url:"/dashboard/chatqueue",templateUrl:"source/dashboard/chat_queue/chat_queue.html",controller:"chatQueueCtrl",controllerAs:"chatQueue"}).state("quickentry.dashboard.waitChatQueue",{url:"/dashboard/waitchatqueue",templateUrl:"source/dashboard/wait_chat_queue/wait_chat_queue.html",controller:"waitChatQueueCtrl",controllerAs:"waitChatQueue"})}t.$inject=["$scope","$modal_","$rootScope","$location","$http","alertService","ConsoleConfig"];function t(t,i,e,n,o,a,r){e.$broadcast("clear_notice_count");t.providerDomain=r.providerHelpCenterUrl;t.favoriteLink=function(){var e=i({scope:t,title:"提示信息",contentTemplate:"source/views/favorite.html",html:true,show:true,placement:"center"})};t.domainNameBuried=function(){_hmt.push(["_trackPageview","/全局/一级页面/换一个域名"]);_hmt.push(["_setCustomVar",e.vertionNumber,"名称","换一个域名",1])};t.dashboardBuried=function(){_hmt.push(["_trackPageview","/全局/一级页面/仪表盘"]);_hmt.push(["_setCustomVar",e.vertionNumber,"名称","仪表盘",1])};t.noviceguideBuried=function(){_hmt.push(["_trackEvent","仪表盘","新手向导"])}}})();(function(){"use strict";angular.module("eweiApp.dashboard").controller("DashboardCtrl",e).controller("DashboardCtrlNew",t);e.$inject=["$scope","$http","$rootScope","$state","$modal_","$timeout","alertService","license","ConsoleConfig","EweiExeUrl","loadJs","permissions","$window","cometdService","typeTransfer"];function e(d,r,f,t,n,e,a,i,o,s,c,l,u,p,g){var m=this;m.dashBoradStatistics={};d.loadingConversation=false;d.loadingTicket=false;d.loadingCapacity=false;d.loadingChart=false;m.exeurl=s;m.currentUserName=o.user.name;m.currentProviderName=o.provider.name;d.loadingDynamic=false;d.loadingNews=false;m.loadChatCount=function(){r({url:"load_chat_count.json",method:"GET",params:{providerId:o.provider.id}}).success(function(e,t,i,n){userAginLogin(e);if(e.success){d.loadingConversation=true;m.dashBoradStatistics.requestCount=e.json.requestCount;m.dashBoradStatistics.sessionCount=e.json.sessionCount}})};m.dashBoradStatistics={myTicket:{count:0,viewId:0,uri:"ticket"},myGroupTicket:{count:0,viewId:0,uri:"ticket"},newTicket:{count:0,viewId:0,uri:"ticket"},request:{count:0,viewId:0,uri:"session"},session:{count:0,viewId:0,uri:"session"},inActiveDevice:{count:0,viewId:0,uri:"device"},deskUsage:{count:"-GB",viewId:0,uri:"desk"}};m.engineerOnlineDetail={allCount:0,onlineCount:0};m.loadTicketCount=function(){r({url:"view_simple.json",method:"GET",params:{_count:3,_do_count:false,_filter:"{'$and':[{'$eq':{'type':'ticket'}},{'$or':[{'$eq':{'title':'VIEW_TITLE_TICKET_MY'}},{'$eq':{'title':'VIEW_TITLE_TICKET_NEW'}},{'$eq':{'title':'VIEW_TITLE_TICKET_MY_GROUP'}}]}]}"}}).success(function(e,t,i,n){userAginLogin(e);for(var o=0;o<e.views.length;o++){if(e.views[o].title=="VIEW_TITLE_TICKET_MY"){m.dashBoradStatistics.myTicket.count=e.views[o].count;m.dashBoradStatistics.myTicket.viewId=e.views[o].id}else if(e.views[o].title=="VIEW_TITLE_TICKET_NEW"){m.dashBoradStatistics.newTicket.count=e.views[o].count;m.dashBoradStatistics.newTicket.viewId=e.views[o].id}else if(e.views[o].title=="VIEW_TITLE_TICKET_MY_GROUP"){m.dashBoradStatistics.myGroupTicket.count=e.views[o].count;m.dashBoradStatistics.myGroupTicket.viewId=e.views[o].id}}d.loadingTicket=true})};m.loadEngineerCount=function(){m.engineerOnlineDetail.onlineCount=0;r({url:"engineer_online_status.json"}).success(function(e,t,i,n){userAginLogin(e);m.engineers=e.json;m.engineerOnlineDetail.allCount=m.engineers.length;angular.forEach(m.engineers,function(e){m.engineerOnlineDetail.onlineCount+=e.webOnline||e.androidOnline||e.iosOnline?1:0})})};m.loadTicketCount();m.loadEngineerCount();m.loadChatCount();m.showEngineerList=function(){var e;var t=d;t.engineerList=m.engineers;void 0;for(var i=0;i<t.engineerList.length;i++){if(o.user.id==t.engineerList[i].userId){if(p.getCometdService()){t.engineerList[i].webOnline=1}}}e=n({scope:t,title:"客服列表",contentTemplate:"source/dashboard/engineer_list.html",html:true,show:true});d.hideModal=function(){e.$promise.then(e.hide)}};m.loadUsedDiskCapacity=function(){f.$watch("providerLicense",function(){if(f.providerLicense!=null){m.dashBoradStatistics.deskUsage.count=i.attachmentSize("G");d.loadingCapacity=true}})};m.workorder=function(){d.workorderChart=ECharts.Charts.InitChart("workorder");r({url:"/api/ticket_state_pie_chart.json",method:"GET",params:{_token:getCookie("user_token"),provider_id:o.provider.id}}).success(function(e){if(e.result.closed==0&&e.result.deleted==0&&e.result.news==0&&e.result.open==0&&e.result.pending==0&&e.result.solved==0&&e.result.suspended==0){document.getElementById("workorder").innerHTML='<p class="chart_data_none">暂无数据</p>';return}var n=[];var o=[];var a=20;n=[{name:"回收站",value:e.result.deleted},{name:"新建",value:e.result.news},{name:"处理中",value:e.result.open},{name:"暂停",value:e.result.pending},{name:"处理完毕",value:e.result.solved},{name:"隔离区",value:e.result.suspended}];o=[40,80];r({url:"ticketlegend/list.json",type:"GET"}).success(function(e){if(e.success){var t={};for(var i=0;i<e.json.length;i++){e.json[i].legendStatus=g.keyToValue(e.json[i].legendStatus);if(e.json[i].legendStatus!="error"){t[e.json[i].legendStatus]=false}}d.loadingChart=true;d.workorderChart=ECharts.Charts.RenderChart("pie","workorder",n,"",a,d.workorderChart,"",o,true,t);d.workorderChart.on(echarts.config.EVENT.LEGEND_SELECTED,function(e){if(e.selected[e.target]){r({url:"ticketlegend/delete.json",method:"POST",params:{legend_status:g.valueToKey(e.target)}})}else{r({url:"ticketlegend/add.json",method:"POST",params:{legend_status:g.valueToKey(e.target)}})}})}})}).error(function(){if(document.getElementById("workorder")){document.getElementById("workorder").innerHTML='<p class="chart_data_none">响应超时，服务器长时间未响应，请联系'+f.providerEweiProductName+"客服人员...</p>"}})};c.loadScript("/source/lib/echarts/echarts-all.js",function(){c.loadScript("/source/scripts/chart-utils.js",function(){m.workorder()})});d.loadtime=0;d.refreshCount=function(){var e=(new Date).getTime();if(d.loadtime!=0&&e-d.loadtime<1500){return}d.loadtime=e;m.loadTicketCount();m.loadEngineerCount();m.loadChatCount();m.loadUsedDiskCapacity()};d.waitchatqueueBuried=function(){_hmt.push(["_trackEvent","仪表盘","等待中的会话"]);t.go("quickentry.dashboard.waitChatQueue")};d.chatqueueBuried=function(){if(l.hasPermission("chat_list")){_hmt.push(["_trackEvent","仪表盘","进行中的会话"]);t.go("quickentry.dashboard.chatQueue")}else{a.add("您没有权限进行该操作","danger")}};d.$on("refreshWaitingChatCount",function(e,t){d.refreshCount()});d.$on("notice",function(e,t){f.$broadcast("clear_notice_count")});m.loadUsedDiskCapacity();f.notifyLogs=[];m.pageSize=8;m.loadNotifyLogs=function(l,u){r({url:"notify_log.json",method:"GET",params:{_count:m.pageSize,_page:l,_desc:"createdAt"}}).success(function(e,t,i,n){d.loadingNews=true;userAginLogin(e);var o=e.notifyLogs;for(var a=0,r=e.notifyLogs.length;a<r;a++){var s=e.notifyLogs[a];var c=s.message;if(f.providerEweiProductName!=""){c=c.replaceAll("易维帮助台",f.providerEweiProductName);s.message=c}o[a]=s}if(u){f.notifyLogs=o}else{f.notifyLogs=_.union(f.notifyLogs,o)}m.nextPageNo=e._total>l*m.pageSize?l+1:1})};m.loadNotifyLogs(1);m.deleteNotifyLogs=function(){_hmt.push(["_trackEvent","仪表盘","删除最新消息"]);void 0;if(f.notifyLogs.length>0){d.confirmContent="是否确定要删除最新消息列表？";var e=n({scope:d,title:"确认",contentTemplate:"source/views/confirm_template.html",html:true,show:true,placement:"center"});d.hideModal=function(){e.$promise.then(e.hide)};d.$ok=function(){r({url:"notify_log_delete_by_user_id.json",method:"POST"}).success(function(e,t,i,n){userAginLogin(e);if(e.success){d.hideModal();f.notifyLogs=[]}else{a.add("删除失败","danger")}})}}};m.toSetNotice=function(){_hmt.push(["_trackEvent","仪表盘","最新消息设置"]);var e;var o=d;r({url:"user_notice_config.json",method:"GET",data:{}}).success(function(e,t,i,n){userAginLogin(e);if(e.json){o.userNoticeConfig=e.json}else{}});e=n({scope:o,title:"自定义通知内容和方式",template:"source/dashboard/notice_setting.html",html:true,show:true});d.hideModal=function(){e.$promise.then(e.hide)};o.$save=function(e){r({url:"user_notice_config",method:"POST",data:e}).success(function(e,t,i,n){userAginLogin(e);if(e.success){d.hideModal()}else{a.add("更新失败","danger")}})}};m.clickNotifyLog=function(e){_hmt.push(["_trackEvent","仪表盘","最新消息"]);void 0;try{r({url:"delete_notify_log_by_id.json",method:"GET",params:{notifyLogId:e.id}}).success(function(e,t,i,n){if(e.success){for(var o=0,a=f.notifyLogs.length;o<a;o++){if(e.id==f.notifyLogs[o].id){f.notifyLogs.splice(o,1);break}}}})}catch(e){void 0}if(e.type=="ticket"){t.go("tickets_detail",{id:e.targetId})}else if(e.type=="comment_article"){u.open("/#/article/detail/"+e.targetId)}else if(e.type=="answer_question"){u.open("/#/forum/detail/"+e.targetId)}else if(e.type=="comment_answer"){u.open("/#/forum/detail/"+e.targetId)}};d.newDynamicBuried=function(){_hmt.push(["_trackEvent","仪表盘","最新动态"])};r({url:"dashborad_community_dynamics.json",method:"GET",params:{size:9}}).success(function(e){d.loadingDynamic=true;if(e.success&&e.json!=undefined){m.recommondQuestions=e.json.recommondQuestions}});m.downloadImage={androidImage:false,iosImage:false};m.downloadStyle={left:"100",top:"100"};m.androidImageShow=function(){m.downloadStyle.left=$("#androidImage").position().left+15;m.downloadStyle.top=$("#androidImage").position().top+97;m.downloadImage.androidImage=true};m.androidImageHide=function(){m.downloadImage.androidImage=false};m.iosImageShow=function(){m.downloadStyle.left=$("#iosImage").position().left+10;m.downloadStyle.top=$("#iosImage").position().top-135;m.downloadImage.iosImage=true};m.iosImageHide=function(){m.downloadImage.iosImage=false}}t.$inject=["$filter","$scope","$rootScope","$http","chartTypeService","ConsoleConfig","$modal_","coreNotifyService","coreModelService","apiDashboardService","apiRecommondQuestionsService","apiSummaryProviderActivityDataService","apiSummaryAttachmentSizeService","license"];function t(e,o,t,a,i,r,s,n,c,l,u,d,f,p){var g=this;var m=g.__proto__.constructor.name+"_"+(new Date).valueOf();g.chartTypeList=i;g.positionA="A";g.positionB="B";g.positionC="C";g.positionD="D";g.positionE="E";g.positionF="F";if(p.type()=="oem"||p.hasModule("oem")){g.dashboardTypeList=[{type:"newState",name:"最新动态"},{type:"data",name:"存储与数据"},{type:"chart",name:"报表视图"}]}else{g.dashboardTypeList=[{type:"newState",name:"最新动态"},{type:"data",name:"存储与数据"},{type:"chart",name:"报表视图"},{type:"client",name:"移动客户端"}]}g.positionAState="default";g.positionBState="default";g.positionCState="default";g.positionDState="default";g.positionEState="default";g.positionFState="default";g.dashboardTypeA="newState";g.dashboardTypeB="newState";g.dashboardTypeC="newState";g.dashboardTypeD="newState";g.dashboardTypeE="newState";g.dashboardTypeF="newState";g.chartTypeA="";g.chartTypeB="";g.chartTypeC="";g.chartTypeD="";g.chartTypeE="";g.chartTypeF="";g.isChartTypeA=false;g.isChartTypeB=false;g.isChartTypeC=false;g.isChartTypeD=false;g.isChartTypeE=false;g.isChartTypeF=false;g.noneNewstateList=false;g.loadingConversation=true;g.loadDashboardInfo=function(){l.run("dashboard",n.constant.EVENT_LIST_DASHBOARD,1,"","",function(e){if(angular.isDefined(e.result)&&angular.isDefined(e.result.shortcuts)){}})};_();function _(){w();h("dashboardInfo");g.loadDashboardInfo()}function h(e){do{if(e=="dashboardInfo"){g.dashboardInfo=c.list.dashboard.gets(1)||[];v();break}if(e=="recommondQuestions"){g.recommondQuestions=c.detail.recommondQuestions.gets(c.list.recommondQuestions.gets(1))||[];E();break}if(e=="loadProviderActivityData"){g.providerActivityData=c.detail.summary.get("providerActivityData")||{};break}if(e=="attachmentSize"){var t=c.detail.summary.get("attachmentSize")||{};if(t!=null&&!angular.equals({},t)){if(t!=null&&!angular.equals({},t)){g.attachmentSize=(t/1024/1024/1024).toFixed(2)}}}}while(0)}function v(e){if(g.dashboardInfo.length<=0){return}var t={};var i=false;var n=false;var o="";for(var a=0;a<6;a++){t=g.dashboardInfo[a];o=C(a);if(t){if(t.type=="client"&&(p.type()=="oem"||p.hasModule("oem"))){g["position"+o+"State"]="chart";g["chartType"+o]="解决率"}else{g["position"+o+"State"]=t.type}g["position"+o+"id"]=t.id;if(t.type=="chart"){g["chartType"+o]=t.chartType}if(!i&&t.type=="newState"){i=true}if(!n&&t.type=="data"){n=true}}else{g["position"+o+"State"]="default"}}if(i){h("recommondQuestions");T()}if(n){h("loadProviderActivityData");h("attachmentSize");y();N()}if(e){e()}g.loadingConversation=false}function E(){o.loadingDynamic=true;if(g.recommondQuestions.length<=0){g.noneNewstateList=true;return}for(var e=0;e<g.recommondQuestions.length;e++){if(!g.recommondQuestions[e].updater){g.recommondQuestions[e].updater=g.recommondQuestions[e].author}}}function T(){u.run("recommondQuestions",n.constant.EVENT_LIST_RECOMMONDQUESTIONS,1,"",{size:10},function(e){if(angular.isDefined(e.result)){}})}function y(){d.run("providerActivityData",n.constant.EVENT_DETAIL_SUMMARY,"","","","loadProviderActivityData",function(e){if(angular.isDefined(e.result)){}})}function N(){f.run("attachmentSize",n.constant.EVENT_DETAIL_SUMMARY,"","",{authorizeDeadline:t.providerLicense.authorizeDeadline},"attachmentSize",function(e){if(angular.isDefined(e.result)){}})}g.addTemplte=function(e){g["position"+e+"State"]="add";g["dashboardType"+e]="newState";g["isChartType"+e]=false};g.selectDashboardType=function(e){if(g["dashboardType"+e]=="chart"){g["isChartType"+e]=true;g["chartType"+e]="工单状态"}else{g["isChartType"+e]=false}};g.changeTemplte=function(n){var o=S(n);g["savingSettings"+n]=true;var e={};if(g["dashboardType"+n]=="chart"){e={type:"chart",chartType:g["chartType"+n],orderNo:o}}else{e={type:g["dashboardType"+n],orderNo:o}}a({url:"/api/v1/dashboard/save.json?_token="+getCookie("user_token")+"&provider_id="+r.provider.id,method:"POST",data:e}).success(function(e){if(e.status==0){g["savingSettings"+n]=false;g["position"+n+"id"]=e.result.id;var t=g["dashboardType"+n];g["position"+n+"State"]=t;var i=angular.copy(c.list.dashboard.gets(1));if(t=="chart"){g["position"+n]=n;i[o-1]={id:e.result.id,orderNo:o,type:g["dashboardType"+n],chartType:g["chartType"+n]}}else{i[o-1]={id:e.result.id,orderNo:o,type:g["dashboardType"+n]};if(t=="newState"){h("recommondQuestions");T()}else if(t=="data"){h("loadProviderActivityData");h("attachmentSize");y();N()}}c.list.dashboard.put(1,i)}})};g.cancleChangeTemplte=function(e){g["position"+e+"State"]="default"};g.deleteTemplte=function(n){o.isLoading=false;o._messages="您确定删除吗？";var e=s({scope:o,title:"删除确认",contentTemplate:"source/views/alter_common.html",html:true,show:true,placement:"center"});o.$hide=function(){e.$promise.then(e.hide)};o.$ok=function(){o.isLoading=true;var i=S(n);if(g.dashboardInfo.length<=0){var e;if(p.type()!="oem"&&!p.hasModule("oem")){e=[{type:"chart",chartType:"工单状态",orderNo:1},{type:"newState",orderNo:2},{type:"chart",chartType:"工单数量",orderNo:3},{type:"data",orderNo:4},{type:"chart",chartType:"满意度",orderNo:5},{type:"client",orderNo:6}]}else{e=[{type:"chart",chartType:"工单状态",orderNo:1},{type:"newState",orderNo:2},{type:"chart",chartType:"工单数量",orderNo:3},{type:"data",orderNo:4},{type:"chart",chartType:"满意度",orderNo:5},{type:"chart",chartType:"解决率",orderNo:6}]}e.splice(i-1,1);a({url:"/api/v1/dashboard/save_more.json?_token="+getCookie("user_token")+"&provider_id="+r.provider.id,method:"POST",data:e}).success(function(e){if(e.status==0){g["position"+n+"State"]="default";g["dashboardType"+n]="newState";g["chartType"+n]="工单状态";g["isChartType"+n]=false;o.$hide()}else{o.isLoading=false}g.loadDashboardInfo()}).error(function(){o.isLoading=false})}else{a({url:"/api/v1/dashboard/delete/"+g["position"+n+"id"]+".json?_token="+getCookie("user_token")+"&provider_id="+r.provider.id,method:"POST",data:e}).success(function(e){if(e.status==0){var t=c.list.dashboard.get(1,i-1);t.type="default";delete t.chartType;g["position"+n+"State"]="default";g["dashboardType"+n]="newState";g["chartType"+n]="工单状态";g["isChartType"+n]=false;o.$hide()}else{o.isLoading=false}}).error(function(){o.isLoading=false})}}};function S(e){if(e=="A"){return 1}else if(e=="B"){return 2}else if(e=="C"){return 3}else if(e=="D"){return 4}else if(e=="E"){return 5}else{return 6}}function C(e){if(e==0){return"A"}else if(e==1){return"B"}else if(e==2){return"C"}else if(e==3){return"D"}else if(e==4){return"E"}else{return"F"}}g.clientCode_A="weixin";g.clientCode_B="weixin";g.clientCode_C="weixin";g.clientCode_D="weixin";g.clientCode_E="weixin";g.clientCode_F="weixin";g.changeClinet=function(e,t,i){if(t=="enter"){g["clientCode_"+e]=i}else{}};function w(){n.register(m,n.constant.EVENT_LIST_DASHBOARD,function(e,t){if(t==0){g.positionAState="chart";g.positionBState="newState";g.positionCState="chart";g.positionDState="data";g.positionEState="chart";if(p.type()!="oem"&&!p.hasModule("oem")){g.positionFState="client"}else{g.positionFState="chart";g.chartTypeF="解决率"}g.chartTypeA="工单状态";g.chartTypeC="工单数量";g.chartTypeE="满意度";h("recommondQuestions");h("loadProviderActivityData");h("attachmentSize");T();y();N();g.loadingConversation=false;return}h("dashboardInfo")});n.register(m,n.constant.EVENT_LIST_RECOMMONDQUESTIONS,function(e){h("recommondQuestions")});n.register(m,n.constant.EVENT_DETAIL_SUMMARY,function(e,t){if(t!="loadProviderActivityData"&&t!="attachmentSize"){return}h(t)})}function P(){n.unRegister(m)}o.$on("$destroy",function(){P()})}})();(function(){"use strict";angular.module("eweiApp.dashboard").service("typeTransfer",e).factory("dashboardService",t);function e(){this.valueToKey=function(e){if(e=="回收站"){return"deleted"}else if(e=="处理中"){return"open"}else if(e=="处理完毕"){return"solved"}else if(e=="新建"){return"new"}else if(e=="暂停"){return"pending"}else if(e=="隔离区"){return"suspended"}else if(e=="关闭"){return"closed"}};this.keyToValue=function(e){if(e=="deleted"){return"回收站"}else if(e=="open"){return"处理中"}else if(e=="solved"){return"处理完毕"}else if(e=="new"){return"新建"}else if(e=="pending"){return"暂停"}else if(e=="suspended"){return"隔离区"}else if(e=="closed"){return"关闭"}else{return"error"}}}t.$inject=["$http","$q"];function t(t){function e(e){return t({url:"chat_count_list.json",method:"GET",params:{engineerId:e}})}function i(e){return t({url:"waiting_queue_count_list.json",method:"GET",params:{engineerId:e}})}return{getChatCountList:e,getWaitingQueueList:i}}})();(function(e){o.$inject=["$http","$q"];p.$inject=["$modal_","eweiPhoneService"];e.module("eweiApp.chat").factory("chatTypeTotalService",t).factory("chatColunmSetUpId",i).factory("getCustomerServiceList",n).factory("waitChatHandleService",o).factory("waitChatQueueSetUp",a).factory("waitChatQueueSetUpDefault",r).factory("forceJoinChatService",l).factory("chatQueueSetUpDefault",d).factory("chatQueueSetUp",u).factory("endChatQueueSetUpDefault",f).factory("closeChatService",p).factory("untreatedChatQueueSetUp",s).factory("untreatedChatQueueSetUpDefault",c);t.$inject=["apiRestfulService","coreModelService","coreNotifyService"];function t(a,r,s){var e=function(e,t,i,n){var o={url:"api/v1/chat/count_chats.json",urlParam:e,dataParam:t};a.run(o).get(o.dataParam,function(e){void 0;r.detail.chats.closed.put("total_closed",e.result.total_closed);r.detail.chats.closed.put("total_ongoing",e.result.total_ongoing);r.detail.chats.closed.put("total_waiting",e.result.total_waiting);r.detail.chats.closed.put("total_untreated",e.result.total_untreated);s.doNotify(i);if(typeof n==="function"){n(e)}})};return e}i.$inject=[];function i(){var t=null;var e=null;var i=null;return{setWaitChatID:function(e){t=e},getWaitChatID:function(){if(t==null){return""}else{return t}},setChatID:function(e){t=e},getChatID:function(){if(e==null){return""}else{return e}},setUntreatedChatID:function(e){i=e},getUntreatedChatID:function(){if(i==null){return""}else{return i}}}}n.$inject=["$http","$q"];function n(i,n){var e=function(e){var t=n(function(o,a){i({url:"user_online_status.json",params:{_count:999,_do_count:false,_filter:"{'$ne':{'id':${current_engineer_id}}}"}}).success(function(e,t,i,n){o(e)}).error(function(e,t,i,n){a(e)})});return t};return e}o.$injct=["$http","$q"];function o(n,o){var e=function(e){var t=o(function(o,a){n({url:"accept_chat/"+e+".json",method:"GET",params:{assignMe:true}}).success(function(e,t,i,n){o(e)}).error(function(e,t,i,n){a(e)})});return t};var t=function(e,t){var i=o(function(o,a){n({url:"assign_chat.json",method:"GET",params:{chatId:e,assignedUserId:t}}).success(function(e,t,i,n){o(e)}).error(function(e,t,i,n){a(e)})});return i};return{myselfHandleWaitingSession:e,sendChatRequest:t}}a.$inject=["$http","$q","chatColunmSetUpId","waitChatQueueSetUpDefault","coreModelService","ConsoleConfig","apiRestfulService"];function a(e,t,a,r,i,n,s){var o=function(e,t){var i={url:"api/v1/search_view.json"};s.run(i).post({fields:e,type:"waiting_chat",id:a.getWaitChatID()},function(e){if(typeof t==="function"){t(e)}})};var c=function(o){var e={url:"api/v1/search_view/waiting_chat.json"};s.run(e).get({},function(e){if(e.status==0){if(typeof e.result!="undefined"){if(typeof e.result.id!="undefined"){a.setWaitChatID(e.result.id)}if(e.result.fields!="undefined"){var t=e.result.fields.split(",");for(var i=0;i<r.length;i++){for(var n=0;n<t.length;n++){if(r[i].field==t[n]&&r[i]["default"]==false){r[i].active=true;break}else if(n==t.length-1&&r[i].field!=t[n]){r[i].active=false}}void 0}}}}if(typeof o==="function"){o(e)}})};return{saveWaitChatOption:o,getWaitChatOption:c}}r.$inject=[];function r(){return[{title:"时间",field:"createdAt",widthClass:"w200",active:true,default:false},{title:"主题",field:"w_firstMessage",widthClass:"w200",default:true},{title:"客户",field:"user.name",fieldCount:2,field0:"user",field1:"name",widthClass:"w150",active:true,default:false},{title:"客服组",field:"serviceDesk.name",fieldCount:2,field0:"serviceDesk",field1:"name",widthClass:"w150",active:true,default:false},{title:"渠道",field:"via.channelName",fieldCount:2,field0:"via",field1:"channelName",widthClass:"w150",active:true,default:false},{title:"IP",field:"fromIp",widthClass:"w150",active:true,default:false},{title:"位置",field:"location",widthClass:"w150",active:false,default:false},{title:"服务目录",field:"serviceCatalog.name",fieldCount:2,field0:"serviceCatalog",field1:"name",widthClass:"w150",active:false,default:false}]}s.$inject=["$http","$q","chatColunmSetUpId","untreatedChatQueueSetUpDefault","coreModelService","ConsoleConfig","apiRestfulService"];function s(e,t,a,r,i,n,s){var o=function(e,t){var i={url:"api/v1/search_view.json"};s.run(i).post({fields:e,type:"untreated_chat",id:a.getUntreatedChatID()},function(e){if(typeof t==="function"){t(e)}})};var c=function(o){var e={url:"api/v1/search_view/untreated_chat.json"};s.run(e).get({},function(e){if(e.status==0){if(typeof e.result!="undefined"){if(typeof e.result.id!="undefined"){a.setUntreatedChatID(e.result.id)}if(e.result.fields!="undefined"){var t=e.result.fields.split(",");for(var i=0;i<r.length;i++){for(var n=0;n<t.length;n++){if(r[i].field==t[n]&&r[i]["default"]==false){r[i].active=true;break}else if(n==t.length-1&&r[i].field!=t[n]){r[i].active=false}}void 0}}}}if(typeof o==="function"){o(e)}})};return{saveUntreatedChatOption:o,getUntreatedChatOption:c}}c.$inject=[];function c(){return[{title:"时间",field:"createdAt",widthClass:"w200",active:true,default:false},{title:"主题",field:"firstMessage",widthClass:"w200",default:true},{title:"客户",field:"user.name",fieldCount:2,field0:"user",field1:"name",widthClass:"w150",active:true,default:false},{title:"Email",field:"user.email",fieldCount:2,field0:"user",field1:"email",widthClass:"w150",active:true,default:false},{title:"手机",field:"user.mobilePhone",fieldCount:2,field0:"user",field1:"mobilePhone",widthClass:"w150",active:true,default:false},{title:"客服组",field:"serviceDesk.name",fieldCount:2,field0:"serviceDesk",field1:"name",widthClass:"w150",active:false,default:false},{title:"渠道",field:"via.channelName",fieldCount:2,field0:"via",field1:"channelName",widthClass:"w150",active:false,default:false},{title:"IP",field:"fromIp",widthClass:"w150",active:false,default:false},{title:"位置",field:"location",widthClass:"w150",active:false,default:false},{title:"服务目录",field:"serviceCatalog.name",fieldCount:2,field0:"serviceCatalog",field1:"name",widthClass:"w150",active:false,default:false}]}l.$inject=["$http","$q"];function l(i,n){var e=function(e){var t=n(function(o,a){i({url:"force_join_chat.json",method:"GET",params:{chatId:e}}).success(function(e,t,i,n){o(e)}).error(function(e,t,i,n){a(e)})});return t};return e}u.$inject=["$http","$q","chatColunmSetUpId","chatQueueSetUpDefault","coreModelService","ConsoleConfig","apiRestfulService"];function u(e,t,a,r,i,n,s){var o=function(e,t){var i={url:"api/v1/search_view.json"};s.run(i).post({fields:e,type:"ongoing_chat",id:a.getChatID()},function(e){if(typeof t==="function"){t(e)}})};var c=function(o){var e={url:"api/v1/search_view/ongoing_chat.json"};s.run(e).get({},function(e){if(e.status==0){if(typeof e.result!="undefined"){if(typeof e.result.id!="undefined"){a.setChatID(e.result.id)}if(typeof e.result.fields!="undefined"){var t=e.result.fields.split(",");void 0;for(var i=0;i<r.length;i++){for(var n=0;n<t.length;n++){if(r[i].field==t[n]&&r[i]["default"]==false){r[i].active=true;break}else if(n==t.length-1&&r[i].field!=t[n]){r[i].active=false}}void 0}}}}if(typeof o==="function"){o(e)}})};return{saveChatOption:o,getChatOption:c}}d.$inject=[];function d(){return[{title:"ID",field:"id",visible:true,sortable:true,widthClass:"w130",active:true,default:false},{title:"主题",field:"c_firstMessage",visible:true,sortable:false,widthClass:"",default:true},{title:"客户",field:"user.name",fieldCount:2,field0:"user",field1:"name",visible:true,widthClass:"w200",active:true,default:false},{title:"客服",field:"engineer.user.name",fieldCount:3,field0:"engineer",field1:"user",field2:"name",widthClass:"w200",active:true,default:false},{title:"时间",field:"responseAt",visible:true,sortable:true,widthClass:"w200",active:true,default:false},{title:"客服组",field:"serviceDesk.name",fieldCount:2,field0:"serviceDesk",field1:"name",visible:true,widthClass:"",active:true,default:false}]}f.$inject=[];function f(){return[{title:"ID",field:"id",widthClass:"w150"},{title:"主题",field:"first_message",visible:true,widthClass:"w300"},{title:"客户",field:"user_name",widthClass:"w200"},{title:"客服",field:"engineer_user_name",widthClass:"w200"},{title:"开始时间",field:"created_at",widthClass:"w200",visible:true,sortable:true},{title:"结束时间",field:"closed_at",widthClass:"w200",visible:true,sortable:true}]}p.$injct=["$modal_","eweiPhoneService"];function p(r,s){return{close:function(e,t,i,n){var o=e;var a="";o.hideCloseChat=function(){a.$promise.then(a.hide)};o._messages="电话会话，确认关闭";o.$ok=function(){s.closeChatFn(t,"close_chat",function(e){n(e)});o.hideCloseChat()};o.$hide=function(){o.hideCloseChat()};a=r({scope:o,title:"确认关闭",contentTemplate:"source/views/alter_common.html",html:true,show:true,placement:"center"})}}}})(angular);(function(){angular.module("eweiApp.dashboard").controller("chatQueueCtrl",e);e.$inject=["$scope","ngTableParams","$timeout","$filter","$rootScope","$state","$http","permissions","alertService","ConsoleConfig"];function e(c,e,t,l,i,a,n,r,s,u){var o=this;c.$watch("filterItem",function(e,t,i){if(e!==t){c.oldEngineerId=e?e.engineerId:null;c.tableParams.reload()}},true);o.loadChatCount=function(){n({url:"load_chat_count.json",method:"GET",params:{providerId:u.provider.id}}).success(function(e,t,i,n){userAginLogin(e);if(e.success){o.sessionCount=e.json.sessionCount}})};o.loadChatCount();c.view={};var d=function(e,t){for(var i in e){if(e[i]==t){return i}return""}};c.columns=[{title:"时间",field:"responseAt",visible:true,sortable:true,widthClass:"w200"},{title:"主题",field:"c_firstMessage",visible:true,sortable:false,widthClass:"w500"},{title:"客服",field:"engineer.user.name",fieldCount:3,field0:"engineer",field1:"user",field2:"name",visible:true,widthClass:"w200"},{title:"客服组",field:"serviceDesk.name",fieldCount:2,field0:"serviceDesk",field1:"name",visible:true,widthClass:"w200"},{title:"客户",field:"user.name",fieldCount:2,field0:"user",field1:"name",visible:true,widthClass:"w200"},{title:"会话ID",field:"id",visible:true,sortable:true,widthClass:"w200"},{title:"工单ID",field:"ticket.no",fieldCount:2,field0:"ticket",field1:"no",visible:true,sortable:true,widthClass:"w200"}];c.clearSorting=function(){c.tableParams.sorting(JSON.parse('{"'+c.view.orderBy+'":"'+c.view.order+'"}'));c.defaultSorting=true};c.defaultSorting=true;c.clearSearch=function(){if(c.searchKey!=null){c.searchKey=null;c.oldSearchKey=null;c.tableParams.reload()}};c.placeholder="搜索主题";o.search=function(e){if(e!=c.oldSearchKey){c.oldSearchKey=e;c.searchKey=e;c.tableParams.reload()}};c.tableParams=new e({page:1,count:25},{groupBy:function(e){return null},total:0,$scope:c,counts:[],getData:function(o,a){var r=d(a.sorting(),"asc");var s=d(a.sorting(),"desc");void 0;n.get("chats.json",{params:f(a)}).success(function(e){void 0;if(c.view.order=="asc"&&c.view.orderBy!=r){c.defaultSorting=false}else if(c.view.order=="desc"&&c.view.orderBy!=s){c.defaultSorting=false}var t=a.sorting()?l("orderBy")(e.chats,a.orderBy()):e.chats;if(e._total!=0){for(var i=0;i<t.length;i++){var n=t[i].firstMessage;if(n&&n.length>20){t[i].c_firstMessage=n.substring(0,21)+"..."}else if(n!=null&&n!=""&&n!="undefined"){t[i].c_firstMessage=n}else{t[i].c_firstMessage="#"+t[i].id}}}c.chatQueue.sessionCount=e._total;a.total(e._total);o.resolve(t);c.showCheckboxes=false;c.customers=null})}});var f=function(e){var t=e.page();if(e.page()==undefined){t=1}return{pageNo:t,pageSize:e.count(),searchKey:c.searchKey,_asc:d(e.sorting(),"asc"),_desc:d(e.sorting(),"desc"),engineerId:c.oldEngineerId}};c._gotoChatCenter=function(o,e,t){var i;if(e){i=e.id}if(i==u.engineer.id){a.go("webchats_new.detail",{id:o},{reload:"webchats_new.detail"})}else if(r.hasPermission("ticket_force_join_chat")&&t.clientType!="USB_PHONE"){n({url:"force_join_chat.json",method:"GET",params:{chatId:o}}).success(function(e,t,i,n){if(e.success){a.go("webchats_new.detail",{id:o},{reload:"webchats_new.detail"})}else{if(e.message!=null){s.add(l("translate")(e.message),"danger")}else{s.add("失败","danger")}}})}else{if(t.clientType=="USB_PHONE"){s.add("语音会话暂不支持加入","danger")}else{s.add("对不起，您没有权限加入此会话","danger")}}}}})();(function(){angular.module("eweiApp.dashboard").controller("waitChatQueueCtrl",e);e.$inject=["$scope","ngTableParams","$timeout","$filter","$rootScope","permissions","$modal_","$http","alertService","license","ConsoleConfig"];function e(c,e,t,l,a,u,r,d,s,f,i){var o=this;c.$watch("filterItem",function(e,t,i){if(e!==t){c.oldServiceDeskId=e?e.servicedeskId:null;c.tableParams.reload()}},true);o.loadChatCount=function(){d({url:"load_chat_count.json",method:"GET",params:{providerId:i.provider.id}}).success(function(e,t,i,n){userAginLogin(e);if(e.success){o.requestCount=e.json.requestCount}})};o.loadChatCount();c.view={};var n=function(e,t){for(var i in e){if(e[i]==t){return i}return""}};c.columns=[{title:"时间",field:"createdAt",visible:true,sortable:true,widthClass:"w150"},{title:"主题",field:"w_firstMessage",visible:true,sortable:false,widthClass:"w400"},{title:"客户",field:"user.name",fieldCount:2,field0:"user",field1:"name",visible:true,widthClass:"w150"},{title:"客服组",field:"serviceDesk.name",fieldCount:2,field0:"serviceDesk",field1:"name",visible:true,widthClass:"w150"},{title:"IP",field:"fromIp",visible:true,sortable:false,widthClass:"w150"},{title:"位置",field:"location",visible:true,sortable:false,widthClass:"w150"},{title:"渠道",field:"via.channelName",fieldCount:2,field0:"via",field1:"channelName",visible:true,widthClass:"w150"},{title:"服务目录",field:"serviceCatalog.name",fieldCount:2,field0:"serviceCatalog",field1:"name",visible:true,widthClass:"w150"}];c.clearSorting=function(){c.tableParams.sorting(JSON.parse('{"'+c.view.orderBy+'":"'+c.view.order+'"}'));c.defaultSorting=true};c.defaultSorting=true;c.clearSearch=function(){if(c.searchKey!=null){c.searchKey=null;c.oldSearchKey=null;c.tableParams.reload()}};c.placeholder="搜索主题";o.search=function(e){void 0;if(e!=c.oldSearchKey){c.oldSearchKey=e;c.searchKey=e;c.tableParams.reload()}};c.tableParams=new e({page:1,count:25},{groupBy:function(e){return null},total:0,$scope:c,counts:[],getData:function(o,a){void 0;var r=n(a.sorting(),"asc");var s=n(a.sorting(),"desc");d.get("waiting_chat_queue.json",{params:p(a)}).success(function(n){t(function(){void 0;if(c.view.order=="asc"&&c.view.orderBy!=r){c.defaultSorting=false}else if(c.view.order=="desc"&&c.view.orderBy!=s){c.defaultSorting=false}var e=a.sorting()?l("orderBy")(n.chats,a.orderBy()):n.chats;if(n._total!=0){for(var t=0;t<e.length;t++){var i=e[t].firstMessage;if(i&&i.length>20){e[t].w_firstMessage=i.substring(0,21)+"..."}else if(i!=null&&i!=""&&i!="undefined"){e[t].w_firstMessage=i}else{e[t].w_firstMessage="等待接通会话"}if(u.hasPermission("ticket_chat_assign")||u.hasPermission("ticket_force_join_chat")){e[t].isMyselfHandle="false"}else{e[t].isMyselfHandle="true"}}}c.waitChatQueue.requestCount=n._total;a.total(n._total);o.resolve(e);c.showCheckboxes=false;c.customers=null},100)})}});var p=function(e){var t=e.page();if(e.page()==undefined){t=1}return{pageNo:t,pageSize:e.count(),searchKey:c.searchKey,servicedeskId:c.oldServiceDeskId}};var g=function(e,t){if(e&&e.length>t){return e.substr(0,t)+"..."}return e};c.myselfHandleWaitingSession=function(e){if((f.type()=="free"||f.type()=="trial"||f.type()=="enterprise_trial")&&f.overdueDays()<0){a.$broadcast("license_overdue","time");return false}else if(f.type()!="free"&&f.overduePayService()<=0){a.$broadcast("license_overdue","time");return false}else if(f.type()!="free"&&f.remainingCapacity()<=0){if(f.isCoverData()==0){a.$broadcast("license_overdue","disk");return false}}else if(f.type()!="free"&&f.accountBalance()<0){a.$broadcast("license_overdue","account");return false}var t=c;var i;c.hideMyselfHandleModal=function(){i.$promise.then(i.hide)};t._messages="您确定要接通该会话，自己处理吗？";i=r({scope:t,title:"接通确认",contentTemplate:"source/views/alter_common.html",html:true,show:true,placement:"center"});t.$ok=function(){if((f.type()=="free"||f.type()=="trial"||f.type()=="enterprise_trial")&&f.overdueDays()<0){a.$broadcast("license_overdue","time");return false}else if((f.type()=="public"||f.type()=="blend"||f.type()=="professional"||f.type()=="enterprise"||f.type()=="enterprise_plus"||f.type()=="oem")&&f.overduePayService()<=0){a.$broadcast("license_overdue","time");return false}else if((f.type()=="public"||f.type()=="blend"||f.type()=="professional"||f.type()=="enterprise"||f.type()=="enterprise_plus"||f.type()=="oem")&&f.accountBalance()<0){a.$broadcast("license_overdue","account");return false}d({url:"accept_chat/"+e+".json",method:"GET",params:{assignMe:true}}).success(function(e,t,i,n){if(e.success){}else{if(e.message!=null){if(e.message=="license_limit"){s.add("很抱歉，你今日的工单数量已经达到上限，暂时无法接通会话。","danger")}else{s.add(l("translate")(e.message),"danger")}}else{s.add("失败","danger")}}c.tableParams.reload()});c.hideMyselfHandleModal()}};c.selectEngineerHandleWaitingSession=function(e){if(!u.hasPermission("ticket_chat_assign")){s.add("您没有权限分派会话","danger");return false}if((f.type()=="free"||f.type()=="trial"||f.type()=="enterprise_trial")&&f.overdueDays()<0){a.$broadcast("license_overdue","time");return false}else if(f.type()!="free"&&f.overduePayService()<=0){a.$broadcast("license_overdue","time");return false}else if(f.type()!="free"&&f.remainingCapacity()<=0){if(f.isCoverData()==0){a.$broadcast("license_overdue","disk");return false}}else if(f.type()!="free"&&f.accountBalance()<0){a.$broadcast("license_overdue","account");return false}var t=c;var i;c.setwaitingEngineer=function(e){if(e){i=e.userId}};c.sendChatRequest=function(){void 0;d({url:"assign_chat.json",method:"GET",params:{chatId:e,assignedUserId:i}}).success(function(e,t,i,n){if(e.success){s.add(l("translate")("ASSIGN_WAITINGCHAT_SUCC"))}else{if(e.message=="license_limit"){s.add("很抱歉，你今日的工单数量已经达到上限，暂时无法接通会话。","danger")}else{s.add(l("translate")(e.message),"danger")}}});c.hideSelectEngineerModal()};var o=function(e){var t=new Array;function i(e,t){for(var i=0,n=e.length;i<n;i++){if(e[i].id==t){return true}}return false}for(var n=0,o=e.length;n<o;n++){var a=e[n];if(!i(t,a.servicedeskId)){var r={id:a.servicedeskId,name:a.servicedeskName,engineers:[]};t.push(r)}}for(var n=0,o=t.length;n<o;n++){for(var s=0,c=e.length;s<c;s++){var a=e[s];if(a.webSessionId==undefined||a.webSessionId==""){continue}if(t[n].id==a.servicedeskId){var l={id:a.engineerId,name:a.userName,userId:a.userId,chatCount:a.chatCount,concurrentChatNumber:a.concurrentChatNumber};t[n].engineers.push(l)}}}return t};var n;c.hideSelectEngineerModal=function(){n.$promise.then(n.hide)};n=r({scope:t,title:"选择客服人员",contentTemplate:"source/dashboard/select__engineers_single.html",html:true,show:true,placement:"center"});c.loadtime=0;c.loadEngineers=function(){var e=(new Date).getTime();if(c.loadtime!=0&&e-c.loadtime<1500){return}c.loadtime=e;c.onlineCount=0;d({url:"user_online_status.json",params:{_count:999,_do_count:false,_filter:"{'$ne':{'id':${current_engineer_id}}}"}}).success(function(e,t,i,n){c.selectServiceDesks=o(e.json)})};c.loadEngineers()}}})();(function(){angular.module("eweiApp.dashboard").directive("queueTab",e);e.$inject=[];function e(){e.$inject=["dashboardService","$rootScope","$q","$scope","ConsoleConfig","commonTools"];e.$injct=["dashboardService","$rootScope","$q","$scope","ConsoleConfig","common","commonTools"];function e(e,t,i,n,o,a){var r=this;var s=[];r.type=n.type;r.showMoreCountList=false;r.chatShowCountList=[];r.moreCountList=[];var c=n.$watch("totalQueueCount",function(e,t,i){if((e||e==0)&&(t||t==0)&&e!=t){d().then(function(e){s=e;l(0)})}});n.$on("$destroy",function(){c()});r.resizeQueueCount=function(t){if(s.length){l(t)}else{if(n.type==="wait-queue"){d().then(function(e){s=e;r.totalQueueCount=s.length;l(t)})}else if(n.type==="chat-queue"){u().then(function(e){s=e;r.totalQueueCount=s.length;l(t)})}}};r.setCurrentQueueItem=function(e){n.filterItem=e};var l=function(e){r.chatShowCountList=s;r.moreCountList=[]};var u=function(){var t=i.defer();e.getChatCountList(o.engineer.id).success(function(e){if(e.success){t.resolve(e.json.filter(function(e){return e.count>0}).sort(function(e,t){return e.count-t.count}))}else{t.reject("数据请求失败!")}});return t.promise};var d=function(){var t=i.defer();e.getWaitingQueueList(o.engineer.id).success(function(e){if(e.success){t.resolve(e.json.filter(function(e){return e.count>0}).sort(function(e,t){return e.count-t.count}))}else{t.reject("数据请求失败!")}});return t.promise};r.resizeQueueCount(0)}function t(e,t,i,n){var o=window.innerWidth||document.documentElement.clientWidth||document.body.clientWidth;n.resizeQueueCount(o);$(window).resize(function(){o=window.innerWidth||document.documentElement.clientWidth||document.body.clientWidth;n.resizeQueueCount(o)})}return{restrict:"AEC",templateUrl:"source/dashboard/queue-tab/queue-tab.html",scope:{type:"@",filterItem:"=",totalQueueCount:"="},controller:e,controllerAs:"queueTab"}}})();(function(){"use strict";angular.module("eweiApp.dashboard").controller("dashLogMessageCtrl",e).directive("dashLogMessage",t);e.$inject=["$scope","$filter","$sanitize"];function e(e,i,n){var o=this;o.setHtmlMessage=t;function t(t){var i;if(/^{.+}$/.test(t)){try{i=angular.fromJson(t)}catch(e){t=t.replace(/\r/g,"\\r").replace(/\n/g,"\\n").replace(/\t/g,"\\t");i=angular.fromJson(t)}o.htmlMessage=a(i)}else{o.htmlMessage=t}}function a(e){var t="";if(angular.isObject(e)&&e["type"]){e.title=i("escapeHTML")(e.title&&e.title.length>30?e.title.substring(0,30)+"...":e.title);e.subject=i("escapeHTML")(e.subject&&e.subject.length>30?e.subject.substring(0,30)+"...":e.subject);e.content=i("escapeHTML")(e.content&&e.content.length>100?e.content.substring(0,100)+"...":e.content);e.userName=n(e.userName)||e.requesterName||"";switch(e["type"]){case"ticket_receive":t='<p><span class="font_b">'+n(e.userName)+'</span>请求服务，新工单到达：<span class="dash-msgDetail">';t+=e.serviceDeskName+'</span></p><p><span class="font_b margin_right15px">工单#'+e.ticketNo+"</span>"+n(e.subject)+"</p>";break;case"add_ticket_comment":t='<p><span class="font_b">'+n(e.userName)+"</span>"+(e.open?"":"[私密]")+'回复：<span class="dash-msgDetail">';t+=n(e.content)+'</span></p><p><span class="font_b margin_right15px">工单#'+e.ticketNo+"</span>"+n(e.subject)+"</p>";break;case"ticket_automation":t='<p>自动化通知：<span class="dash-msgDetail">';t+=n(e.content)+'</span></p><p><span class="font_b margin_right15px">工单#'+e.ticketNo+"</span>"+n(e.subject)+"</p>";break;case"assign_ticket":t='<p><span class="font_b">'+n(e.userName)+'</span>分派工单给你@<span class="dash-msgDetail">';t+=e.serviceDeskName+'</span></p><p><span class="font_b margin_right15px">工单#'+e.ticketNo+"</span>"+n(e.subject)+"</p>";break;case"other_place_user_online":t="用户("+n(e.userName)+")在另一设备登陆("+n(e.deviceName)+")";break;case"comment_article":t='<p><span class="font_b">'+n(e.userName)+'</span>评论：<span class="dash-msgDetail">';t+=n(e.content)+'</span></p><p><span class="font_b margin_right15px">文章</span>'+n(e.title)+"</p>";break;case"answer_question":t='<p><span class="font_b">'+n(e.userName)+'</span>回答：<span class="dash-msgDetail">';t+=n(e.content)+'</span></p><p><span class="font_b margin_right15px">问题</span>'+n(e.title)+"</p>";break;case"comment_answer":t='<p><span class="font_b">'+n(e.userName)+'</span>评论：<span class="dash-msgDetail">';t+=n(e.content)+'</span></p><p><span class="font_b margin_right15px">回答</span>'+n(e.title)+"</p>";break;case"change_password":t='<p><span class="font_b">'+n(e.userName)+"</span>修改了你的登录密码</p>";break;case"change_email":t='<p><span class="font_b">'+n(e.userName)+'</span>替换您的Email为：<span class="dash-msgDetail">'+n(e.email)+"</span></p>";break;case"account_enable":t='<p><span class="font_b">'+n(e.userName)+"</span>"+e.enable?"启用":"停用"+"了你的账号</p>";break;case"project_share":t='<p><span class="font_b">'+n(e.userName)+"</span>分享项目给你</p>";t+='<p><span class="font_b margin_right15px">项目#'+e.projectNo+"</span>"+n(e.projectName)+"</p>";break;case"project_add_remark":t='<p><span class="font_b">'+n(e.userName)+"</span>备注："+e.content+"</p>";t+='<p><span class="font_b margin_right15px">项目#'+e.projectNo+"</span>"+n(e.projectName)+"</p>";break;case"project_update_phase":t='<p><span class="font_b">'+n(e.userName)+"</span>变更项目进度到"+n(e.phaseName);if(e.content){t+=",并备注："+n(e.content)}t+='</p><p><span class="font_b margin_right15px">项目#'+e.projectNo+"</span>"+n(e.projectName)+"</p>";break;case"project_relate_ticket":t='<p><span class="font_b">'+n(e.userName)+"</span>添加关联工单#"+e.ticketNo+"</p>";t+='<p><span class="font_b margin_right15px">项目#'+e.projectNo+"</span>"+e.projectName+"</p>";break;case"project_delete_relate_ticket":t='<p><span class="font_b">'+n(e.userName)+"</span>解除了关联工单#"+e.ticketNo+"</p>";t+='<p><span class="font_b margin_right15px">项目#'+e.projectNo+"</span>"+e.projectName+"</p>";break;case"file_export_success":t='<p><span class="font_b">工单#'+e.ticketNo+"</span>数据导出完成</p>";t+='<p>下载导出文件: <a class="custom-main-font-color">'+n(e.attachmentName)+"</a></p>"}return t}else{return""}}}function t(){var e={restrict:"E",link:t,template:'<div ng-bind-html="dashLog.htmlMessage|trusted"></div>',controller:"dashLogMessageCtrl",controllerAs:"dashLog",scope:{message:"@"}};function t(e,t,i,n){var o=e.$watch("message",function(){n.setHtmlMessage(e.message)});e.$on("$destroy",function(){o()})}return e}})();(function(){"use strict";angular.module("eweiApp.usersguide",[]).config(e).controller("UsersguideCtrl",t);e.$inject=["$stateProvider","$urlRouterProvider"];function e(e,t){e.state("usersguide",{url:"/usersguide",templateUrl:"source/usersguide/usersguide.html",controller:"UsersguideCtrl",controllerAs:"guide"}).state("usersguide.initial",{url:"/initial",templateUrl:"source/usersguide/guide-initial.html",controller:"UsersCtrl"}).state("usersguide.experience",{url:"/experience",templateUrl:"source/usersguide/guide-experience.html",controller:"experienceCtrl"}).state("usersguide.customized",{url:"/customized",templateUrl:"source/usersguide/guide-customized.html",controller:"customizedCtrl"}).state("usersguide.bring",{url:"/bring",templateUrl:"source/usersguide/guide-bring.html",controller:"guideBringCtrl"}).state("usersguide.efficiency",{url:"/efficiency",templateUrl:"source/usersguide/guide-efficiency.html",controller:"guideEfficiencyCtrl"}).state("usersguide.quality",{url:"/quality",templateUrl:"source/usersguide/guide-quality.html",controller:"guideQualityCtrl"}).state("usersguide.safety",{url:"/safety",templateUrl:"source/usersguide/guide-safety.html",controller:"guideSafetyCtrl"})}t.$inject=["$state","$rootScope","permissions","ConsoleConfig"];function t(e,t,i,n){var o=this;o.switchTab=s;o.currentTabTitle="初始，添加用户";o.usersguideMenuVisited={};o.guideItems=[];var a={"usersguide.initial":"初始，添加用户","usersguide.experience":"体验，处理第一张工单","usersguide.customized":"定制，适配你的业务","usersguide.bring":"接入，添加服务渠道","usersguide.efficiency":"效率，快速处理工单","usersguide.quality":"质量，提供等级化服务","usersguide.safety":"安全，用户账号控制"};if(a.hasOwnProperty(e.current.name)){o.currentTabTitle=a[e.current.name]}o.guideItems.push({sref:"usersguide.initial",title:"初始，添加用户",type:"initialVisited"});o.guideItems.push({sref:"usersguide.experience",title:"体验，处理第一张工单",type:"experienceVisited"});if(i.anyPermissions(["customer_setting","ticket_property","customer_setting","ticket_property","ticket_property"])){o.guideItems.push({sref:"usersguide.customized",title:"定制，适配你的业务",type:"customizedVisited"})}if(i.hasPermission("ticket_via")){o.guideItems.push({sref:"usersguide.bring",title:"接入，添加服务渠道",type:"bringVisited"})}if((n.engineer.role&&n.engineer.role.name)==="ROLE_NAME_ADMIN"){o.guideItems.push({sref:"usersguide.efficiency",title:"效率，快速处理工单",type:"efficiencyVisited"});o.guideItems.push({sref:"usersguide.quality",title:"质量，提供等级化服务",type:"qualityVisited"});o.guideItems.push({sref:"usersguide.safety",title:"安全，用户账号控制",type:"safetyVisited"})}if(window.localStorage){var r=localStorage.usersguideMenuVisited;if(angular.isString(r)){o.usersguideMenuVisited=angular.fromJson(r)}}function s(e,t){o.usersguideMenuVisited[t]="visited";o.currentTabTitle=e;if(window.localStorage){localStorage.usersguideMenuVisited=angular.toJson(o.usersguideMenuVisited)}}}})();(function(){"use strict";angular.module("eweiApp.usersguide").controller("UsersCtrl",e);e.$inject=["$scope","alertService","$rootScope","license","$modal_","userService","$filter","$http","$upload","permissions","$location","engineerService","$timeout","ConsoleConfig","providerJudgement"];function e(s,r,i,e,t,n,o,a,c,l,u,d,f,p,g){s.currentUserRole=p.user.role.name;s.toAddCustomer=function(){var e=t({scope:s,title:"新建客户",contentTemplate:"source/views/customer/user_add.html",html:true,show:true,placement:"top"});s.hideModal=function(){e.$promise.then(e.hide)};s.newUser={};s.$save=function(){if(s.newUser.email&&!verifyEmailAddress(s.newUser.email)){r.add("邮件地址需由字母、数字或下划线组成","danger");return false}if(s.newUser.mobilePhone&&!validMobilePhone(s.newUser.mobilePhone)){r.add("手机号码格式不正确","danger");return false}if(!g.isTrue()){return false}else{n.add(s.newUser,function(e){if(e.success){s.hideModal();a({url:"reset_user_password.json",method:"POST",data:{userId:e.id,password:s.newUser.password}}).success(function(e,t,i,n){});r.add("添加客户成功")}else{if(e.message!=null){r.add(o("translate")(e.message),"danger")}else{r.add("保存失败","danger")}}})}};s.moreField=false;s.showMoreField=function(){s.moreField=true}};s.downLoadfailureCustomerRecored=function(){s.hideBatchAddCustomerModal();var e="/download_import_user_failure_record?recordId="+s.recordId;window.location.replace(e)};s.importUserComplete=false;s.toBatchAddCustomer=function(){s.view={type:"user"};var e=t({scope:s,title:"客户导入",contentTemplate:"source/views/customer/user_excel_url.choice.html",html:true,show:true,placement:"center",backdrop:"static"});s.hideBatchAddCustomerModal=function(){s.importUserComplete=false;e.$promise.then(e.hide)};s.fileIsNUll=false;s.datas=[];s.titles=[];s.options=[];s.titleOptions=[];s.customFieldIdMap={};s.$read=function(e){if(e==null||e==undefined||e.length<=0){return}s.fileIsNUll=true;s.fileName=e[e.length-1].name;e.upload=c.upload({url:"resolve_customer_excel.json",method:"POST",file:e});e.upload.then(function(e){if(e.data.success){var t=e.data.json;s.titles=t.titles;s.options=t.selectPropertyOptions;for(var i=0,n=t.titles.length;i<n;i++){var o={title:t.titles[i]};if(s.options[i].option==t.titles[i]){o.selectProperty=s.options[i].value}s.titleOptions.push(o)}s.datas=t.datas;s.customFieldIdMap=t.customFieldIdMap;s.fileIsNUll=true}else{var a=e.data.message;r.add(a+" 请查看详细说明","danger");s.fileIsNUll=false}void 0},function(e){s.uploading=false;s.errorMsg=e.status+": "+e.data});e.upload.progress(function(e){s.uploading=true;void 0});e.upload.xhr(function(e){e.upload.addEventListener("abort",function(){void 0;s.uploading=false},false)})};s.$explain=function(){var e=t({scope:s,title:"客户导入详细说明",contentTemplate:"source/views/customer/user_import_explain.html",html:true,show:true,placement:"center",backdrop:"static"})};s.$template=function(e){var t="/export_user_template?&templateType="+e;window.location.replace(t)};s.importting=false;s.importCustomer=function(e){var t=document.getElementById("repeatedCustomerUpdate");var i=false;if(t.checked===true){i=true}s.importting=true;a({url:"import_user.json?update="+i,method:"POST",data:e}).success(function(e,t,i,n){s.importting=false;if(e.success){s.failureCount=e.json.failureCount;s.successCount=e.json.successCount;s.recordId=e.json.recordId;s.importData="success";s.importUserComplete=true}else if(e.data&&e.data.message){r.add(e.data.message,"danger")}else{r.add("请检查文件类型，格式！","danger")}s.uploading=false}).error(function(e,t,i,n){r.add("导入失败,请稍候再试！","danger");s.importting=false})};s.$save=function(){var e=document.getElementsByName("selectCustomerPropertyOptions");var t=new Array;var i=new Array;for(var n=0;n<e.length;n++){var o=s.options[n];if(o==undefined||o==null||o==""){void 0;return}for(var a=0;a<t.length;a++){if(t[a]==e[n].value){void 0;return}}t[n]=o.value;i[n]=o.option}var r={};r.titles=s.titles;r.fileds=i;r.selectPropertys=t;r.datas=s.datas;r.customFieldIdMap=s.customFieldIdMap;s.importCustomer(r)}};s.toInviteEngineer=function(){var e=t({scope:s,title:"邀请客服",template:"modal/modal.tpl.w670.html",contentTemplate:"source/usersguide/invite_engineer.html",html:true,show:true,placement:"top"});s.hideInviteEngineerModal=function(){e.$promise.then(e.hide)};s.inviteEmails="";s.inviteEngineer=function(e){s.inviteEmails=e;s.isClick=true;if(s.inviteEmails==""){r.add("请输入Email地址","danger");s.isClick=false}else if(s.inviteEmails.length==500){r.add("请不要超过500个字符","danger");s.isClick=false}else{s.inviteEmails=s.inviteEmails.replace(/\r/gi,"").replace(/\n/gi,";").replace(/ /gi,";").replace(/,/gi,";").replace(/，/gi,";").replace(/。/gi,";").replace(/；/gi,";").replace(/、/gi,";");if(s.inviteEmails!=null){if(s.inviteEmails.indexOf(";")==-1){if(!verifyEmailAddress(s.inviteEmails)){r.add("您输入的邮件格式有误，请重新核对后再输入,请不要使用“.”，“|”等特殊符号来分隔多个邮箱","danger");s.isClick=false;return false}}else{var t=s.inviteEmails.split(";");var i=true,n="";for(var o=0;o<t.length;o++){if(t[o]!=null||t[o]!=""){if(!verifyEmailAddress(t[o])){i=false;n+=t[o]+"; "}}}if(!i){r.add("以下邮件格式有误："+n+"请重新核对后再输入","danger");s.isClick=false;return false}}}a({url:"send_invite_engineer_email",method:"POST",data:{emails:s.inviteEmails}}).success(function(e,t,i,n){s.isClick=false;userAginLogin(e);if(e.success){r.add(e.message,"success");s.hideInviteEngineerModal()}else if(e.success==false){r.add(e.message,"danger")}else{r.add("邀请失败，稍后再试","danger")}})}}};s.downLoadfailureRecored=function(){s.hideImportModal();var e="/download_import_engineer_failure_record?recordId="+s.recordId;window.location.replace(e)};s.toBatchAddEngineer=function(){var e=t({scope:s,title:"客服导入",contentTemplate:"source/views/system_setting/engineer_excel_url.choice.html",html:true,show:true,placement:"center",backdrop:"static"});s.hideImportModal=function(){s.importComplete=false;e.$promise.then(e.hide)};s.$template=function(e){var t="/export_engineer_template";window.location.replace(t)};s.$explain=function(){var e=t({scope:s,title:"客服导入详细说明",contentTemplate:"source/views/customer/engineer_import_explain.html",html:true,show:true,placement:"center",backdrop:"static"})};s.fileIsNUll=false;s.datas=[];s.titles=[];s.options=[];s.titleOptions=[];s.$read=function(e){if(e==null||e==undefined||e.length<=0){return}s.fileIsNUll=true;s.fileName=e[e.length-1].name;e.upload=c.upload({url:"resolve_engineer_excel.json",method:"POST",file:e});e.upload.then(function(e){if(e.data.success){var t=e.data.json;s.titles=t.titles;s.options=t.selectPropertyOptions;for(var i=0,n=t.titles.length;i<n;i++){var o={title:t.titles[i]};if(s.options[i].option==t.titles[i]){o.selectProperty=s.options[i].value}s.titleOptions.push(o)}s.datas=t.datas;s.fileIsNUll=true}else{var a=e.data.message;r.add(a+" 请查看详细说明","danger");s.fileIsNUll=false}void 0},function(e){s.uploading=false;s.errorMsg=e.status+": "+e.data});e.upload.progress(function(e){s.uploading=true;void 0});e.upload.xhr(function(e){e.upload.addEventListener("abort",function(){void 0;s.uploading=false},false)})};s.importting=false;s.importEngineer=function(e){var t=document.getElementById("repeatedUpdate");var i=false;if(t.checked===true){i=true}s.importting=true;a({url:"import_engineer.json?update="+i,method:"POST",data:e}).success(function(e,t,i,n){s.importting=false;if(e.success){s.failureCount=e.json.failureCount;s.successCount=e.json.successCount;s.recordId=e.json.recordId;s.importData="success";s.importComplete=true}else if(e.data&&e.data.message){r.add(e.data.message,"danger")}else{r.add("请检查文件类型，格式！","danger")}s.uploading=false}).error(function(e,t,i,n){r.add("导入失败,请稍候再试！","danger");s.importting=false})};s.$save=function(){var e=document.getElementsByName("selectEngineerPropertyOptions");var t=new Array;var i=new Array;for(var n=0;n<e.length;n++){var o=s.options[e[n].value];if(o==undefined||o==null||o==""){void 0;return}for(var a=0;a<t.length;a++){if(t[a]==e[n].value){void 0;return}}t[n]=o.value;i[n]=o.option}var r={};r.titles=s.titles;r.fileds=i;r.selectPropertys=t;r.datas=s.datas;s.importEngineer(r)}};s.toPersonalInformation=function(){var e=t({scope:s,title:"个人资料",contentTemplate:"source/usersguide/personal-information.html",html:true,show:true,placement:"center"});s.hideModal=function(){e.$promise.then(e.hide)};d.get({id:p.engineer.id},function(e){userAginLogin(e);s.engineer=e.json});s.eweiHelpcenterApiUrl=p.eweiHelpcenterApiUrl;s.update=function(){a.post("update_engineer.json",{engineer:s.engineer,oldValid:s.engineer.user.valid}).success(function(e){if(e.success){r.add("更新成功！","success");s.hideModal()}else{r.add("更新失败！","danger")}})};s.uploading=false;s.uploadFile=function(e){for(var t=0;t<e.length;t++){var i=e[t];if(i.size>102400){r.add("上传单个附件大小不能超过100kb","danger")}else{i.upload=c.upload({url:"upload",method:"POST",file:i});i.upload.then(function(e){f(function(){s.uploading=false;s.$emit("uploading",false);i.result=e.data;n(e.data);void 0})},function(e){s.uploading=false;s.$emit("uploading",false);s.errorMsg=e.status+": "+e.data})}}};var n=function(t){a.post("update_photo",{id:s.engineer.user.id,photoId:angular.fromJson(t).id}).success(function(e){if(e.success){r.add("头像更新成功!","success");s.engineer.user.photo.contentUrl=angular.fromJson(t).contentUrl;i.currentUserPhoto=angular.fromJson(t).contentUrl}else{r.add("头像更新失败!","danger")}})}};s.accessControl=function(){var o=t({scope:s,title:"帮助中心访问控制",contentTemplate:"source/usersguide/access-control.html",html:true,show:true,placement:"center"});s.accessConfig={};a({url:"getAccessConfigByProvider.json",method:"GET"}).success(function(e,t,i,n){if(e.success&&e.json){s.accessConfig.id=e.json.id;if(e.json.requiredLogin&&e.json.requiredLogin==true){s.accessConfig.requiredLogin="true"}else{s.accessConfig.requiredLogin="false"}}else{o.$promise.then(o.hide);r.add("获取配置失败，稍后再试","danger")}});s.updateAccessControl=function(e){var t;if(e=="true"){t=true}else{t=false}a({url:"updateAccessControl.json",method:"POST",data:{id:s.accessConfig.id,requiredLogin:t}}).success(function(e,t,i,n){if(e.success){o.$promise.then(o.hide);r.add("更新成功")}else{r.add("更新失败，稍后再试","danger")}})}};s.currentHost=$("#current_provider_helpcenter_url").val()+"/";s.currentLink=s.currentHost.length>40?s.currentHost.substring(0,40)+"...":s.currentHost}})();(function(){"use strict";angular.module("eweiApp.usersguide").controller("experienceCtrl",e);e.$inject=["$scope","alertService","$rootScope","license","$modal_","$filter","$http","$location","$state","ConsoleConfig"];function e(r,s,n,e,c,t,l,u,o,d){r.creatting=false;r.toCreateTestTicket=function(){if(r.creatting){return}r.creatting=true;l({url:"create_demo_ticket.json",method:"POST"}).success(function(e,t,i,n){userAginLogin(e);r.creatting=false;if(e.success){o.go("tickets_detail",{id:e.id})}else{s.add("创建测试工单失败","danger")}})};r.toCreateTestHelpDesk=function(){if(r.creatting){return}r.creatting=true;l({url:"find_or_create_demo_ticket.json",method:"POST"}).success(function(e,t,i,n){if(e.success){var o=parseInt(JSON.parse(e.message).requesterId);var a={inviteeId:o,requesterId:parseInt(d.user.id),ticketId:e.id};void 0;l({url:"pincode.json",method:"GET",params:a}).success(function(e,t,i,n){r.creatting=false;if(e.success){r.pincodeUrl=u.protocol()+"://"+u.host()+"/pincode_"+e.json.code;var o=c({scope:r,title:"远程协助链接",contentTemplate:"source/usersguide/pincode_modal.html",html:true,show:true,placement:"center",backdrop:"static"})}else{s.add("远程协助失败","danger")}}).error(function(e,t,i,n){r.creatting=false})}else{r.creatting=false;s.add("远程协助失败","danger")}})};r.videoSrc=[{type:"helpcenterVideoUrl",src:n.helpcenterVideoUrl,name:"帮助中心简介"},{type:"addAgentVideoUrl",src:n.addAgentVideoUrl,name:"客服账号"},{type:"completeUserVideoUrl",src:n.completeUserVideoUrl,name:"客服ABC"},{type:"ticketVideoUrl",src:n.ticketVideoUrl,name:"网页表单"},{type:"viaEmailVideoUrl",src:n.viaEmailVideoUrl,name:"Email渠道"},{type:"viaWebchatVideoUrl",src:n.viaWebchatVideoUrl,name:"远程协助"}];r.videoPlay=function(e,t){r.experienceVideo=n[e];if(n[e]){var i=c({scope:r,title:t,contentTemplate:"source/usersguide/experience_video.html",template:"modal/modal.tpl.w900.html",html:true,show:true,placement:"center"})}}}})();(function(){"use strict";angular.module("eweiApp.usersguide").controller("guideBringCtrl",e);e.$inject=["$scope","$rootScope","permissions","$state"];function e(e,t,i,n){e.bringMenus=[{type:"ticket",title:"电话语音渠道",buttonTitle:"配置CTI客服",description:"利用电脑电话接口（CTI），将来电转接到电脑上接听，根据来电号码识别客户，调取服务记录，将通话录音保存到工单。",uri:"cti_setting",permission:"ticket_via"},{type:"ticket",title:"电子邮件渠道",buttonTitle:"配置电子邮件",description:"接受客户邮件自动创建工单，客服的回复自动发送邮件给客户，客户回复邮件继续参与工单处理流程。",uri:"via_email",permission:"ticket_via"},{type:"ticket",title:"网页意见反馈渠道",buttonTitle:"配置网页表单",description:"将网页插件JS嵌入任何网页，供客户填写意见反馈，形成工单投递给相关部门（客服组）。",uri:"ticket_web_form",permission:"ticket_via"},{type:"ticket",title:"网页在线帮助渠道",buttonTitle:"配置在线交谈",description:"将网页插件JS嵌入任何网页，客户点击求助按钮立即接通在线客服，接受远程协助，线上立即解决问题，或转成工单继续跟进。",uri:"webchat_form",permission:"ticket_via"},{type:"ticket",title:"微信在线帮助渠道",buttonTitle:"设置微信客服",description:"将帮助中心嵌入到微信服务号或企业号，供客户自助服务，请求在线帮助，提交工单和查询服务记录。",uri:"wechat_setting",permission:"ticket_via"},{type:"ticket",title:"In-APP在线帮助渠道",buttonTitle:"配置sdk",description:"集成易维SDK，将帮助中心嵌入到APP或桌面应用软件，供客户自助服务，请求在线帮助，提交工单和查询服务记录。",uri:"sdk_setting",permission:"ticket_via"},{type:"ticket",title:"API工单渠道",buttonTitle:"配置API",description:"调用易维Rest API，创建工单并投递给相关部门（客服组）。",uri:"api_setting",permission:"ticket_via"}];e.goDetail=function(e,t){if(e=="ticket"){n.go("system_setting.detail",{uri:t,settingType:"ticket"})}}}})();(function(){"use strict";angular.module("eweiApp.usersguide").controller("guideEfficiencyCtrl",e);e.$inject=["$scope","$rootScope","permissions","$state"];function e(e,t,i,n){e.efficiencyMenus=[{type:"ticket",title:"快捷回复",buttonTitle:"添加快捷回复语",description:"预设工单和会话的回复，在处理工单时直接引用，减少录入。",uri:"quick_reply",permission:""},{type:"ticket",title:"工作流",buttonTitle:"添加工作流",description:"将固定事务固化为工作流，让工单在多个处理人之间有序自动流转。",uri:"workflow_templet",permission:""},{type:"ticket",title:"工单模版",buttonTitle:"添加工单模版",description:"预设工单回复和属性字段，在处理工单时直接引用，一次性处理工单。",uri:"ticket_template",permission:""},{type:"ticket",title:"自动化",buttonTitle:"添加自动化脚本",description:"编制工单处理脚本，交给系统自动执行，自动化处理工单。",uri:"automations",permission:"ticket_business_rules"},{type:"faq",title:"FAQ",buttonTitle:"编辑知识库文章",description:"将常见问题编写成文章，让客户自助服务，或者在处理工单时推送给客户。",uri:"faq",permission:""}];e.goDetail=function(e,t){if(e=="ticket"){n.go("system_setting.detail",{uri:t,settingType:"ticket"})}}}})();(function(){"use strict";angular.module("eweiApp.usersguide").controller("guideQualityCtrl",e);e.$inject=["$scope","$rootScope","permissions","$state","ConsoleConfig"];function e(e,n,t,o,i){e.settingShow=false;if(i.user.role.name=="ROLE_NAME_EDITOR"||i.user.role.name=="ROLE_NAME_ADMIN"){e.settingShow=true}e.qualityMenus=[{type:"ticket",title:"营业时间",buttonTitle:"设置营业时间段",description:"设置营业时间表，营业时段内提供在线帮助，营业时段外提供工单服务。",uri:"working_day",permission:"ticket_business_rules"},{type:"helpcenter",item:"community",title:"客户社区",buttonTitle:"开关客户社区",description:"开放客户社区，让客户通过FAQ自助服务，通过问答互助服务。",uri:"access",permission:""},{type:"ticket",title:"SLA",buttonTitle:"添加服务质量指标",description:"对客户提供分等级的服务，按服务目录设定服务质量控制指标。",uri:"sla",permission:"ticket_business_rules"},{type:"ticket",title:"责任客服组",buttonTitle:"设置责任客服组",description:"为特定服务目录指派专门的客服小组，服务请求直接投递到责任客服组。",uri:"service_catalog",permission:"ticket_property"}];e.goDetail=function(e,t,i){if(e=="ticket"){o.go("system_setting.detail",{uri:t,settingType:"ticket"})}else if(e=="helpcenter"){n.helpcenterSettingAccessSelectTab=2;o.go("helpcenter_setting.detail",{type:t,item:i})}}}})();(function(){"use strict";angular.module("eweiApp.usersguide").controller("guideSafetyCtrl",e);e.$inject=["$scope","$rootScope","permissions","$state"];function e(e,t,i,n){e.safetyMenus=[{item:"account",title:"SSO单点登录",buttonTitle:"设置SSO单点登录",description:"启用SSO单点登录，要求客户在你指定的账号系统完成验证。",uri:"access",permission:""},{type:"ip-address",title:"IP地址访问控制",buttonTitle:"设置IP白名单",description:"仅允许特定IP地址段的访问。",uri:"access",permission:""},{item:"email",title:"EMAIL黑白名单",buttonTitle:"设置EMAIL黑白名单",description:"允许/禁止特定的Email提交工单。",uri:"ticket",permission:""}];e.goDetail=function(e,t){n.go("helpcenter_setting.detail",{type:e,item:t})}}})();(function(){"use strict";angular.module("eweiApp.usersguide").controller("customizedCtrl",e);e.$inject=["$scope","$rootScope","permissions","$state"];function e(e,t,i,n){e.hasStatisticsPermission=i.hasPermission("statistics_ticket")||i.hasPermission("statistics_customer_satisfaction")||i.hasPermission("statistics_helpcenter");e.customizedMenus=[{type:"ticket",title:"工单视图",buttonTitle:"自定义工单视图",description:"视图是工单的分类列表，除了系统内置的通用视图，你可以添加更多分类以便查看",uri:"ticket_list_custom",permission:"ticket_property"},{type:"user",title:"客户字段",buttonTitle:"自定义客户字段",description:"客户是接受服务的个人，你可以添加更多个人属性字段，满足你的客户管理需要",uri:"user_custom_field",permission:"customer_setting"},{type:"ticket",title:"工单类型",buttonTitle:"自定义工单类型",description:"类型是工单的事务分类，系统内置了4种通用类型，你还可以添加更多",uri:"ticket_type",permission:"ticket_property"},{type:"user",title:"客户组字段",buttonTitle:"自定义客户组字段",description:"客户组是客户的集合，即企业组织，你可以添加更多企业属性字段，满足你的客户管理需要",uri:"user_group_custom_field",permission:"customer_setting"},{type:"ticket",title:"服务目录",buttonTitle:"设置服务目录",description:"服务目录是对服务内容的分类，你可以按产品、业务或任意纬度定义你的服务目录",uri:"service_catalog",permission:"ticket_property"},{type:"ticket",title:"工单字段",buttonTitle:"自定义工单字段",description:"除了系统内置的工单属性字段，你还可以添加更多字段",uri:"ticket_custom_field",permission:"ticket_property"}];e.goDetail=function(e,t){if(e=="ticket"){n.go("system_setting.detail",{uri:t,settingType:"ticket"})}else{if(t=="user_custom_field"){n.go("system_setting.detail",{uri:"user_custom_field",settingType:"customer"})}else if(t=="user_group_custom_field"){n.go("system_setting.detail",{uri:"user_group_custom_field",settingType:"customer"})}}}}})();(function(){"use strict";angular.module("eweiApp.noviceGuide",["oc.lazyLoad"]).config(e).controller("noviceGuideCtrl",t);e.$inject=["$stateProvider","$urlRouterProvider"];function e(e,t){e.state("noviceguide",{url:"/noviceguide",templateUrl:"/source/noviceguide/templates/novice_guide.html",controller:"noviceGuideCtrl"}).state("noviceguide.experience",{url:"/experience",templateUrl:"/source/noviceguide/templates/guide_experience.html",controller:"noviceGuideExperienceCtrl",resolve:{loadMyCtrl:["$ocLazyLoad",function(e){return e.load("/source/noviceguide/js/guide_experience.js")}]}}).state("noviceguide.accidence",{url:"/accidence",templateUrl:"/source/noviceguide/templates/guide_accidence.html",controller:"noviceGuideAccidenceCtrl",resolve:{loadMyCtrl:["$ocLazyLoad",function(e){return e.load("/source/noviceguide/js/guide_accidence.js")}]}}).state("noviceguide.advanced",{url:"/advanced",templateUrl:"/source/noviceguide/templates/guide_advanced.html",controller:"noviceGuideAdvancedCtrl",resolve:{loadMyCtrl:["$ocLazyLoad",function(e){return e.load("/source/noviceguide/js/guide_advanced.js")}]}})}t.$inject=["$scope","$rootScope","ConsoleConfig","$modal_","alertService","$http","$state"];function t(t,i,e,n,o,a,r){t.guideItems=[{sref:"noviceguide.experience",title:"体验篇",text:"您有一张工单需要处理",type:"experienceVisited",imageUrl:"/source/noviceguide/image/experience.png",imageUrlActive:"/source/noviceguide/image/experience-active.png",name:"experience-active"},{sref:"noviceguide.accidence",title:"基础入门篇",text:"尝试管理您的客户和客服",type:"basisVisited",imageUrl:"/source/noviceguide/image/accidence.png",imageUrlActive:"/source/noviceguide/image/accidence-active.png",name:"accidence-active"}];if(e.engineer.role&&(e.engineer.role.nameKey==="ROLE_NAME_ADMIN"||e.engineer.role.nameKey==="ROLE_NAME_CREATOR")){t.guideItems.push({sref:"noviceguide.advanced",title:"高手进阶篇",text:"巧用设置，可以更高效的工作",type:"advancedVisited",imageUrl:"/source/noviceguide/image/advanced.png",imageUrlActive:"/source/noviceguide/image/advanced-active.png",name:"advanced-active"})}t.guideBuried=function(e){if("体验篇"===e){_hmt.push(["_trackPageview","/全局/一级页面/体验篇"]);_hmt.push(["_setCustomVar",i.vertionNumber,"名称","新手向导-体验篇",1])}else if("基础入门篇"===e){_hmt.push(["_trackPageview","/全局/一级页面/基础入门篇"]);_hmt.push(["_setCustomVar",i.vertionNumber,"名称","新手向导-基础入门篇",1])}else if("高手进阶篇"===e){_hmt.push(["_trackPageview","/全局/一级页面/高手进阶篇"]);_hmt.push(["_setCustomVar",i.vertionNumber,"名称","新手向导-高手进阶篇",1])}};t.domainNameBuried=function(){_hmt.push(["_trackPageview","/全局/一级页面/换一个域名"])};t.dashboardBuried=function(){_hmt.push(["_trackPageview","/全局/一级页面/仪表盘"])};t.providerDomain=e.providerHelpCenterUrl;t.shareDiv={url:t.providerDomain+"/",text:"我们全新的客服系统已经上线了。新的帮助中心网址："+t.providerDomain+"/"};var s;t.showShareDiv=function(){_hmt.push(["_trackEvent","新手向导","通知客户"]);s=n({scope:t,contentTemplate:"/source/views/notify_and_share.html",html:true,show:true,placement:"center"});t.hideModal=function(){s.$promise.then(s.hide)};t.email={};t.email.subject=e.provider.name+"客服系统开通啦";t.email.content="非常高兴地通知你，我们全新的客服系统已经上线了。新的帮助中心网址如下：\r\n\r\n"+t.shareDiv.url+"\r\n\r\n期待您的光临。";t.sendNotifyEmail=function(){_hmt.push(["_trackEvent","通知客户","发送"]);t.email.customerEmails=t.email.customerEmails.replace(/\r/gi,"").replace(/\n/gi,";").replace(/ /gi,";").replace(/；/gi,";").replace(/、/gi,";").replace(/,/gi,";").replace(/，/gi,";").replace(/\//gi,";");a.post("notify_to_customer.json",t.email).success(function(e){if(e.success){o.add("通知邮件发送成功","success");t.hideModal()}else{o.add("通知邮件发送失败！","danger")}})};t.hideBlack=function(){_hmt.push(["_trackEvent","通知客户","取消"])}};t.favoriteLink=function(){var e=n({scope:t,title:"提示信息",contentTemplate:"source/views/favorite.html",html:true,show:true,placement:"center"})}}})();(function(){"use strict";angular.module("eweiApp.ticket").config(e).controller("weixinSettingCtrl",t).factory("getWeixinCommonInf",i);e.$inject=["$stateProvider","$urlRouterProvider"];t.$inject=["$scope","$ocLazyLoad","$state","$http","$stateParams","serviceDeskService","$filter","alertService","getWeixinCommonInf","ConsoleConfig"];i.$inject=["$http","$stateParams","$q"];function e(e,t){e.state("system_setting.wechat_detail",{url:"/wechat_detail/:id/:type/:version/:verified",templateUrl:"source/weixin-setting/weixin_setting.html",controller:"weixinSettingCtrl",permission:"ticket_setting_via"}).state("system_setting.wechat_detail.weixin_new_service_port",{url:"/weixin_new_service_port",templateUrl:"source/weixin-setting/templates/weixin_new_service_port.html",controller:"weixinNewServicePortCtrl",controllerAs:"vm",permission:"ticket_setting_via",resolve:{loadMyFiels:["$ocLazyLoad",function(e){return e.load("/source/weixin-setting/js/weixin_new_service_port.js")}]}}).state("system_setting.wechat_detail.weixin_port",{url:"/weixin_port",templateUrl:"source/weixin-setting/templates/weixin_port.html",controller:"winxinPortCtrl",permission:"ticket_setting_via",resolve:{loadMyFiels:["$ocLazyLoad",function(e){return e.load("/source/weixin-setting/js/weixin_port.js")}]}}).state("system_setting.wechat_detail.auto_reply",{url:"/auto_reply",templateUrl:"source/weixin-setting/templates/auto_reply.html",controller:"autoReplyCtrl",permission:"ticket_setting_via",resolve:{loadMyFiels:["$ocLazyLoad",function(e){return e.load("/source/weixin-setting/js/auto_reply.js")}]}}).state("system_setting.wechat_detail.weixin_menu",{url:"/weixin_new_menu",templateUrl:"source/weixin-setting/templates/weixin_new_menu.html",controller:"weixinNewMenuCtrl",resolve:{loadMyFiels:["$ocLazyLoad",function(e){return e.load("/source/weixin-setting/js/weixin_new_menu.js")}]},permission:"ticket_setting_via"}).state("system_setting.wechat_detail.ticket_send_rule",{url:"/ticket_send_rule",templateUrl:"source/weixin-setting/templates/ticket_send_rule.html",controller:"ticketSendRuleCtrl",permission:"ticket_setting_via",resolve:{loadMyFiels:["$ocLazyLoad",function(e){return e.load("/source/weixin-setting/js/ticket_send_rule.js")}]}}).state("system_setting.wechat_detail.online_customer_navigation",{url:"/online_customer_navigation",templateUrl:"source/weixin-setting/templates/online_customer_navigation.html",controller:"onlineCustomerNavigationCtrl",resolve:{loadMyFiels:["$ocLazyLoad",function(e){return e.load("/source/weixin-setting/js/online_customer_navigation.js")}]},permission:"ticket_setting_via"}).state("system_setting.wechat_detail.template_message",{url:"/template_message",templateUrl:"source/weixin-setting/templates/template_message.html",controller:"templateMessageCtrl",permission:"ticket_setting_via",resolve:{loadMyFiels:["$ocLazyLoad",function(e){return e.load("/source/weixin-setting/js/template_message.js")}]}})}function t(t,e,i,n,o,a,r,s,c,l){e.load("/source/weixin-setting/weixin_setting.css");t.isMessageTemplate=o.type;t.checkId=o.id;t.eweiHelpcenterApiUrl=l.eweiHelpcenterApiUrl;if(t.checkId>0){t.navListDataNoQiye=[{title:"微信接口",self:"system_setting.wechat_detail.weixin_port"},{title:"自动回复",self:"system_setting.wechat_detail.auto_reply"},{title:"微信菜单",self:"system_setting.wechat_detail.weixin_menu"},{title:"服务请求管理",self:"system_setting.wechat_detail.ticket_send_rule"},{title:"在线客服导航",self:"system_setting.wechat_detail.online_customer_navigation"}];if(o.version=="new"){if(o.verified=="verified"){t.navListData=[{title:"微信授权",self:"system_setting.wechat_detail.weixin_new_service_port"},{title:"自动回复",self:"system_setting.wechat_detail.auto_reply"},{title:"微信菜单",self:"system_setting.wechat_detail.weixin_menu"},{title:"服务请求管理",self:"system_setting.wechat_detail.ticket_send_rule"},{title:"在线客服导航",self:"system_setting.wechat_detail.online_customer_navigation"},{title:"模版消息",self:"system_setting.wechat_detail.template_message"}]}else{t.navListData=[{title:"微信授权",self:"system_setting.wechat_detail.weixin_new_service_port"}]}}else{t.navListData=[{title:"微信接口",self:"system_setting.wechat_detail.weixin_port"},{title:"自动回复",self:"system_setting.wechat_detail.auto_reply"},{title:"微信菜单",self:"system_setting.wechat_detail.weixin_menu"},{title:"服务请求管理",self:"system_setting.wechat_detail.ticket_send_rule"},{title:"在线客服导航",self:"system_setting.wechat_detail.online_customer_navigation"},{title:"模版消息",self:"system_setting.wechat_detail.template_message"}]}c.getWeinInf().then(function(e){t.channelName=e.name})}else{t.navListDataNoQiye=[{title:"微信接口",self:"system_setting.wechat_detail.weixin_port"}];t.navListData=[{title:"微信授权",self:"system_setting.wechat_detail.weixin_new_service_port"}]}}function i(t,i,n){return{getWeinInf:function(){var o=n.defer();var e="getViaWeixin/"+i.id+".json";t.get(e).success(function(e,t,i,n){userAginLogin(e);if(e.success&&e.json){o.resolve(e.json)}}).error(function(e,t,i,n){o.reject(e)});return o.promise},getWeinNewMenu:function(){var o=n.defer();var e="api/v1/via_weixin/"+i.id+"/menu.json";t({url:e,method:"get",headers:{_token:getCookie("user_token")}}).success(function(e){userAginLogin(e);if(e.result){o.resolve(e.result)}}).error(function(e,t,i,n){o.reject(e)});return o.promise}}}})();(function(){"use strict";angular.module("eweiApp.ticket").config(e).controller("webPageFormCtrl",t).factory("getWebPageFormCommonInf",i).factory("getWebPageFormSetting",n);e.$inject=["$stateProvider","$urlRouterProvider"];t.$inject=["$scope","$ocLazyLoad","$stateParams","getWebPageFormCommonInf"];i.$inject=["$http","$stateParams","$q"];n.$inject=["$http","$stateParams","$q"];function e(e,t){e.state("system_setting.ticket_web_form_edit",{url:"/ticket_web_form_edit/{type}/:id",templateUrl:"source/webpage_form/webpage_form.html",controller:"webPageFormCtrl",permission:"ticket_setting_via"}).state("system_setting.ticket_web_form_edit.plug_in",{url:"/plug_in",templateUrl:"source/webpage_form/templates/plug_in.html",controller:"webPageFormPlugInCtrl",resolve:{loadMyFiels:["$ocLazyLoad",function(e){return e.load("source/webpage_form/js/plug_in.js")}]},permission:"ticket_setting_via"}).state("system_setting.ticket_web_form_edit.config",{url:"/config",templateUrl:"source/webpage_form/templates/config_form_style.html",controller:"webPageFormConfigCtrl",resolve:{loadMyFiels:["$ocLazyLoad",function(e){return e.load("source/webpage_form/js/config_form_style.js")}]},permission:"ticket_setting_via"}).state("system_setting.ticket_web_form_edit.rule",{url:"/rule",templateUrl:"source/webpage_form/templates/ticket_send_rule.html",controller:"webPageFormRuleCtrl",resolve:{loadMyFiels:["$ocLazyLoad",function(e){return e.load("source/webpage_form/js/ticket_send_rule.js")}]},permission:"ticket_setting_via"}).state("system_setting.ticket_web_form_edit.api",{url:"/api",templateUrl:"source/webpage_form/templates/webpage_api.html",controller:"webPageFormApiCtrl",resolve:{loadMyFiels:["$ocLazyLoad",function(e){return e.load("source/webpage_form/js/ticket_send_rule.js")}]},permission:"ticket_setting_via"})}function t(t,e,i,n){var o=i.id;e.load("source/webpage_form/webpage_form.css");t.title="添加网页表单";if(o>0){n.getWebPageFormInf().then(function(e){t.title=e.name||""});t.navListData=[{title:"网页插件",self:"system_setting.ticket_web_form_edit.plug_in"},{title:"配置表单样式",self:"system_setting.ticket_web_form_edit.config"},{title:"工单投递规则",self:"system_setting.ticket_web_form_edit.rule"},{title:"开发者文档",self:"system_setting.ticket_web_form_edit.api"}]}else{t.navListData=[{title:"网页插件",self:"system_setting.ticket_web_form_edit.plug_in"}]}}function i(t,i,n){return{getWebPageFormInf:function(){var o=n.defer();var e="ticket_web_form/"+i.id+".json";t.get(e).success(function(e,t,i,n){userAginLogin(e);if(e.success&&e.json){o.resolve(e.json)}}).error(function(e,t,i,n){o.reject(e)});return o.promise}}}function n(e,t,i){return{getRandomString:function(e){var t=e||32;var i="ABCDEFGHJKMNPQRSTWXYZabcdefhijkmnprstwxyz2345678";var n=i.length;var o="";for(var a=0;a<t;a++){if(a==3){o+="ti"}else if(a==6){o+="ck"}else if(a==9){o+="ett"}else{o+=i.charAt(Math.floor(Math.random()*n))}}return o}}}})();(function(){"use strict";angular.module("eweiApp.ticket").config(e).controller("webchatFormListCtrl",t).controller("webchatFormCtrl",i).factory("getWebChatFormCommonInf",n);e.$inject=["$stateProvider","$urlRouterProvider"];t.$inject=["$scope","$ocLazyLoad","$state","$http","$stateParams","$filter","alertService"];i.$inject=["$stateParams","$ocLazyLoad","ConsoleConfig","getWebChatFormCommonInf"];n.$inject=["$http","$stateParams","$q"];function e(e,t){e.state("system_setting.webchat_form_edit",{url:"/webchat_form_edit/{type}/:id",templateUrl:"source/webchat_form/webchat_form.html",controller:"webchatFormCtrl",controllerAs:"webChat",permission:"ticket_setting_via"}).state("system_setting.webchat_form_edit.plug_in",{url:"/plug_in",templateUrl:"source/webchat_form/templates/plug_in.html",controller:"webChatFormPlugInCtrl",controllerAs:"webChat",resolve:{loadMyFiels:["$ocLazyLoad",function(e){return e.load("source/webchat_form/js/plug_in.js")}]},permission:"ticket_setting_via"}).state("system_setting.webchat_form_edit.interface_appearance",{url:"/interface_appearance",templateUrl:"source/webchat_form/templates/interface_appearance.html",controller:"webChatFormInterfaceAppearanceCtrl",resolve:{loadMyFiels:["$ocLazyLoad",function(e){return e.load("source/webchat_form/js/interface_appearance.js")}]},permission:"ticket_setting_via"}).state("system_setting.webchat_form_edit.auto_reply",{url:"/auto_reply",templateUrl:"source/webchat_form/templates/auto_reply.html",controller:"webChatFormAutoReplyCtrl",resolve:{loadMyFiels:["$ocLazyLoad",function(e){return e.load("source/webchat_form/js/auto_reply.js")}]},permission:"ticket_setting_via"}).state("system_setting.webchat_form_edit.ticket_send_rule",{url:"/ticket_send_rule",templateUrl:"source/webchat_form/templates/ticket_send_rule.html",controller:"webChatFormTicketSendRuleCtrl",resolve:{loadMyFiels:["$ocLazyLoad",function(e){return e.load("source/webchat_form/js/ticket_send_rule.js")}]},permission:"ticket_setting_via"}).state("system_setting.webchat_form_edit.online_customer_navigation",{url:"/online_customer_navigation",templateUrl:"source/webchat_form/templates/online_customer_navigation.html",controller:"webChatFormOnlineCustomerNavigationCtrl",resolve:{loadMyFiels:["$ocLazyLoad",function(e){return e.load("source/webchat_form/js/online_customer_navigation.js")}]},permission:"ticket_setting_via"}).state("system_setting.webchat_form_edit.api",{url:"/api",templateUrl:"source/webchat_form/templates/webchat_api.html",controller:"webChatFormApiCtrl",resolve:{loadMyFiels:["$ocLazyLoad",function(e){return e.load("source/webchat_form/js/ticket_send_rule.js")}]},permission:"ticket_setting_via"})}function t(a,e,i,n,t,o,r){n({method:"GET",url:"webchat_form.json"}).success(function(e){if(e.customWebForms){a.webChatForms=e.customWebForms||[]}});a.toEditWebchatForm=function(e,t){if(t==="add"){_hmt.push(["_trackEvent","在线交谈","添加在线交谈"])}else if(t==="modify"){_hmt.push(["_trackEvent","在线交谈","编辑在线交谈"])}i.go("system_setting.webchat_form_edit.plug_in",{id:e,type:t})};a.enabled=function(t,i){var e=function(){n({url:" enable_webchat/"+t.id+".json",method:"put",params:{enable:i}}).success(function(e){if(e.success){t.active=i}else{r.add(e.message,"danger")}})};if(!i){_hmt.push(["_trackEvent","在线交谈","停用在线交谈"]);if(confirm("您确定停用吗?")){e()}}else{_hmt.push(["_trackEvent","在线交谈","启用在线交谈"]);e()}};a.deleteWebChatForm=function(o){_hmt.push(["_trackEvent","在线交谈","删除在线交谈"]);if(confirm('您确定删除"'+o.name+'"吗?')){n({url:"webchat_form/"+o.id,method:"DELETE",params:{}}).success(function(e,t,i,n){userAginLogin(e);if(e.success){a.webChatForms.remove(o)}})}}}function i(e,t,i,n){t.load("source/webpage_form/webpage_form.css");t.load("/source/weixin-setting/weixin_setting.css");var o=e.id;var a=this;a.eweiHelpcenterApiUrl=i.eweiHelpcenterApiUrl;if(o>0){a.navListData=[{title:"网页插件",self:"system_setting.webchat_form_edit.plug_in"},{title:"界面外观",self:"system_setting.webchat_form_edit.interface_appearance"},{title:"自动回复",self:"system_setting.webchat_form_edit.auto_reply"},{title:"服务请求管理",self:"system_setting.webchat_form_edit.ticket_send_rule"},{title:"在线客服导航",self:"system_setting.webchat_form_edit.online_customer_navigation"},{title:"开发者文档",self:"system_setting.webchat_form_edit.api"}];n.getWebChatFormInf().then(function(e){a.title=e.name||""})}else{a.title="添加渠道";a.navListData=[{title:"网页插件",self:"system_setting.webchat_form_edit.plug_in"}]}}function n(t,i,n){return{getWebChatFormInf:function(){var o=n.defer();var e="webchat_form/"+i.id+".json";t.get(e).success(function(e,t,i,n){userAginLogin(e);if(e.success&&e.json){o.resolve(e.json)}}).error(function(e,t,i,n){o.reject(e)});return o.promise},getRandomString:function(e){var t=e||32;var i="ABCDEFGHJKMNPQRSTWXYZabcdefhijkmnprstwxyz2345678";var n=i.length;var o="";for(var a=0;a<t;a++){if(a==3){o+="we"}else if(a==6){o+="bc"}else if(a==9){o+="hat"}else{o+=i.charAt(Math.floor(Math.random()*n))}}return o}}}})();(function(){"use strict";angular.module("eweiApp.ticket").config(e).controller("desktopHelpCtrl",t).factory("getDesktopHelpIdService",i);e.$inject=["$stateProvider","$urlRouterProvider"];function e(e,t){e.state("system_setting.detail.auto_reply",{url:"/auto_reply",templateUrl:"source/desktop_help/templates/auto_reply.html",controller:"desktopHelpAutoReplyCtrl",resolve:{loadMyFiels:["$ocLazyLoad",function(e){return e.load("source/desktop_help/js/auto_reply.js")}]},permission:"ticket_setting_via",onEnter:["$state","$stateParams","coreModelService",function(e,t,i){i.config.route.put("system-setting.desktop_help",{name:this.name,params:t})}]}).state("system_setting.detail.ticket_send_rule",{url:"/ticket_send_rule",templateUrl:"source/desktop_help/templates/ticket_send_rule.html",controller:"desktopHelpTicketSendRuleCtrl",resolve:{loadMyFiels:["$ocLazyLoad",function(e){return e.load("source/desktop_help/js/ticket_send_rule.js")}]},permission:"ticket_setting_via",onEnter:["$state","$stateParams","coreModelService",function(e,t,i){i.config.route.put("system-setting.desktop_help",{name:this.name,params:t})}]}).state("system_setting.detail.online_customer_navigation",{url:"/online_customer_navigation",templateUrl:"source/desktop_help/templates/online_customer_navigation.html",controller:"desktopHelpOnlineCustomerNavigationCtrl",resolve:{loadMyFiels:["$ocLazyLoad",function(e){return e.load("source/desktop_help/js/online_customer_navigation.js")}]},permission:"ticket_setting_via",onEnter:["$state","$stateParams","coreModelService",function(e,t,i){i.config.route.put("system-setting.desktop_help",{name:this.name,params:t})}]}).state("system_setting.detail.download_address",{url:"/download_address",templateUrl:"source/desktop_help/templates/download_address.html",controller:"desktopHelpDownloadAddressCtrl",resolve:{loadMyFiels:["$ocLazyLoad",function(e){return e.load("source/desktop_help/js/download_address.js")}]},permission:"ticket_setting_via",onEnter:["$state","$stateParams","coreModelService",function(e,t,i){i.config.route.put("system-setting.desktop_help",{name:this.name,params:t})}]})}t.$inject=["$scope","$state","$stateParams","$ocLazyLoad","ConsoleConfig","getDesktopHelpIdService","coreModelService"];function t(e,t,i,n,o,a,r){n.load("source/webpage_form/webpage_form.css");n.load("/source/weixin-setting/weixin_setting.css");e.eweiHelpcenterApiUrl=o.eweiHelpcenterApiUrl;var s;var c=r.config.route.get("system-setting.desktop_help");if(c){s=c.name}else{s="system_setting.detail.auto_reply"}e.navListData=[{title:"自动回复",self:"system_setting.detail.auto_reply"},{title:"服务请求管理",self:"system_setting.detail.ticket_send_rule"},{title:"在线客服导航",self:"system_setting.detail.online_customer_navigation"},{title:"下载地址",self:"system_setting.detail.download_address"}];t.go(s)}i.$inject=["$http","$q"];function i(e,t){return{getDesktopHelpId:function(){var o=t.defer();e.get("ticket_desktopchat_form.json").success(function(e,t,i,n){userAginLogin(e);if(e.success&&e.json){o.resolve(e.json)}}).error(function(e,t,i,n){o.reject(e)});return o.promise}}}n.$inject=["$http","$stateParams","$q"];function n(t,e,i){return{getWebChatFormInf:function(){var o=i.defer();var e="webchat_form/48.json";t.get(e).success(function(e,t,i,n){userAginLogin(e);if(e.success&&e.json){o.resolve(e.json)}}).error(function(e,t,i,n){o.reject(e)});return o.promise},getRandomString:function(e){var t=e||32;var i="ABCDEFGHJKMNPQRSTWXYZabcdefhijkmnprstwxyz2345678";var n=i.length;var o="";for(var a=0;a<t;a++){if(a==3){o+="we"}else if(a==6){o+="bc"}else if(a==9){o+="hat"}else{o+=i.charAt(Math.floor(Math.random()*n))}}return o}}}})();(function(){"use strict";angular.module("eweiApp.ticket").config(e).controller("dingdingListCtrl",t).controller("dingdingSettingCtrl",i).factory("getdingdingCommonInf",n);e.$inject=["$stateProvider","$urlRouterProvider"];t.$inject=["$scope","$ocLazyLoad","$state","$http","$stateParams","$filter","alertService","ConsoleConfig","apiRestfulService"];i.$inject=["$scope","$ocLazyLoad","$state","$http","$stateParams","serviceDeskService","$filter","alertService","ConsoleConfig","getdingdingCommonInf"];n.$inject=["$http","$stateParams","$q","ConsoleConfig"];function e(e,t){e.state("system_setting.dingding_detail",{url:"/dingding_detail/:id",templateUrl:"source/dingding_setting/dingding_setting.html",controller:"dingdingSettingCtrl",permission:"ticket_setting_via"}).state("system_setting.dingding_detail.dingding_port",{url:"/dingding_port",templateUrl:"source/dingding_setting/templates/dingding_port.html",controller:"dingdingPortCtrl",permission:"ticket_setting_via",resolve:{loadMyFiels:["$ocLazyLoad",function(e){return e.load("/source/dingding_setting/js/dingding_port.js")}]}}).state("system_setting.dingding_detail.auto_reply",{url:"/auto_reply",templateUrl:"source/dingding_setting/templates/auto_reply.html",controller:"dingdingAutoReplyCtrl",permission:"ticket_setting_via",resolve:{loadMyFiels:["$ocLazyLoad",function(e){return e.load("/source/dingding_setting/js/auto_reply.js")}]}}).state("system_setting.dingding_detail.dingding_menu",{url:"/dingding_menu",templateUrl:"source/dingding_setting/templates/dingding_menu.html",controller:"dingdingMenuCtrl",resolve:{loadMyFiels:["$ocLazyLoad",function(e){return e.load("/source/dingding_setting/js/dingding_menu.js")}]},permission:"ticket_setting_via"}).state("system_setting.dingding_detail.ticket_send_rule",{url:"/ticket_send_rule",templateUrl:"source/dingding_setting/templates/ticket_send_rule.html",controller:"dingdingTicketSendRuleCtrl",permission:"ticket_setting_via",resolve:{loadMyFiels:["$ocLazyLoad",function(e){return e.load("/source/dingding_setting/js/ticket_send_rule.js")}]}}).state("system_setting.dingding_detail.online_customer_navigation",{url:"/online_customer_navigation",templateUrl:"source/dingding_setting/templates/online_customer_navigation.html",controller:"dingdingOnlineCustomerNavigationCtrl",resolve:{loadMyFiels:["$ocLazyLoad",function(e){return e.load("/source/dingding_setting/js/online_customer_navigation.js")}]},permission:"ticket_setting_via"}).state("system_setting.dingding_detail.template_message",{url:"/template_message",templateUrl:"source/dingding_setting/templates/template_message.html",controller:"templateMessageCtrl",permission:"ticket_setting_via",resolve:{loadMyFiels:["$ocLazyLoad",function(e){return e.load("/source/dingding_setting/js/template_message.js")}]}})}function t(i,e,n,o,t,a,r,s,c){var l=s.provider.id,u=getCookie("user_token");o({method:"GET",url:"api/v1/via_dingding/list.json",params:{_token:u,provider_id:l}}).success(function(e){if(e.status==0){i.lists=e.result}});i.toDingdingDetail=function(e,t){if(t==="add"){_hmt.push(["_trackEvent","钉钉客户端","添加钉钉客户端"])}else if(t==="modify"){_hmt.push(["_trackEvent","钉钉客户端","编辑钉钉客户端"])}n.go("system_setting.dingding_detail.dingding_port",{id:e})};i.deleteDingding=function(t){_hmt.push(["_trackEvent","钉钉客户端","删除钉钉客户端"]);if(confirm('您确定删除"'+t.name+'"吗?')){o({url:"api/v1/via_dingding/delete/"+t.id,method:"DELETE",params:{_token:u,provider_id:l}}).success(function(e){if(e.status==0){i.lists.remove(t)}})}}}function i(t,e,i,n,o,a,r,s,c,l){e.load("/source/dingding_setting/dingding_setting.css");t.checkId=o.id;t.eweiHelpcenterApiUrl=c.eweiHelpcenterApiUrl;if(t.checkId>0){t.navListData=[{title:"钉钉接口",self:"system_setting.dingding_detail.dingding_port"},{title:"自动回复",self:"system_setting.dingding_detail.auto_reply"},{title:"钉钉菜单",self:"system_setting.dingding_detail.dingding_menu"},{title:"服务请求管理",self:"system_setting.dingding_detail.ticket_send_rule"},{title:"在线客服导航",self:"system_setting.dingding_detail.online_customer_navigation"}];l.getDingdingInf().then(function(e){t.channelName=e.name})}else{t.navListData=[{title:"钉钉接口",self:"system_setting.dingding_detail.dingding_port"}]}}function n(n,a,r,s){return{getDingdingInf:function(){var o=r.defer();var e=s.provider.id,t=getCookie("user_token");var i="api/v1/via_dingding/get/"+a.id+".json?provider_id="+e+"&_token="+t;n.get(i).success(function(e,t,i,n){userAginLogin(e);if(e.status==0){o.resolve(e.result)}}).error(function(e,t,i,n){o.reject(e)});return o.promise}}}})();(function(e){"use strict";e.module("eweiApp.quickEntry",[]).config(t);t.$inject=["$stateProvider"];function t(e){e.state("quickentry",{url:"/quickentry",templateUrl:"/source/quick_entry/templates/quick_entry.html",controller:"quickEntryController",controllerAs:"vm"}).state("quickentry.ticket",{url:"/ticket/:id",templateUrl:"/source/quick_entry/templates/quick_entry_ticket.html",controller:"quickEntryTicketController",controllerAs:"vm"}).state("quickentry.user",{url:"/user/:id",templateUrl:"/source/quick_entry/templates/quick_entry_user.html",controller:"quickEntryUserController",controllerAs:"vm"}).state("quickentry.usergroup",{url:"/group",templateUrl:"/source/quick_entry/templates/quick_entry_usergroup.html",controller:"quickEntryUserGroupController",controllerAs:"vm"}).state("quickentry.engineer",{url:"/engineer",templateUrl:"/source/quick_entry/templates/quick_entry_engineer.html",controller:"quickEntryEngineerController",controllerAs:"vm"}).state("quickentry.servicedesk",{url:"/servicedesk",templateUrl:"/source/quick_entry/templates/quick_entry_servicedesk.html",controller:"quickEntryServiceDeskController",controllerAs:"vm"}).state("quickentry.waiting",{url:"/chat/waiting",templateUrl:"/source/quick_entry/templates/quick_entry_chat_waiting.html",controller:"quickEntryWaitChatQueueController"}).state("quickentry.chating",{url:"/chat/chating",templateUrl:"/source/quick_entry/templates/quick_entry_chat_chating.html",controller:"quickEntryChatQueueController"}).state("quickentry.no-license",{url:"/chat/no-license",templateUrl:"/source/license-control/template/no-license.html",controller:"noLicenseController"}).state("quickentry.closed",{url:"/chat/closed",templateUrl:"/source/quick_entry/templates/quick_entry_chat_closed.html",controller:"quickEntryEndChatQueueController"}).state("quickentry.community",{url:"/community",templateUrl:"/source/quick_entry/templates/quick_entry_community.html",controller:"quickEntryCommunityController",controllerAs:"vm"}).state("manage",{url:"/manage",templateUrl:"/source/quick_entry/templates/quick_entry_manage.html",controller:"manageController",controllerAs:"vm"})}})(angular);(function(T){"use strict";T.module("eweiApp.quickEntry").controller("quickEntryController",e);e.$inject=["$http","$state","$scope","coreNotifyService","coreModelService","apiConsoleShortcutsService","ConsoleConfig","$modal_","alertService","license","providerJudgement"];function e(e,o,t,i,a,n,r,s,c,l,u){var d=this;var f=d.__proto__.constructor.name+"_"+(new Date).valueOf();d.listName="list.shortcut";d.providerDomain=r.providerHelpCenterUrl;d.datas=[];d.isLoading=true;d.selectedId=-1;d.argument={_fields:"",_page:1,_count:0};function p(e){var t=e.type;var i=e.typeKey;var n=l.type();do{d.selectedId=e.id;a.config.route.put("quickentry.selectedId",e.id);if(u.isFree()){if(t==="chat"&&(i==="chat_new"||i==="chat_closed"||i==="chat_open")){o.go("quickentry.no-license");break}}if("ticket"===t){o.go("quickentry.ticket",{id:e.typeKey});break}if("user"===t){if("user_new"===i||"user_all"===i||"user_blacklist"===i){o.go("quickentry.user",{id:i})}else if("engineer"===i){o.go("quickentry.engineer")}else if("service_desk"===i){o.go("quickentry.servicedesk")}else if("user_group"===i){o.go("quickentry.usergroup")}break}if("chat"===t){void 0;if(i==="chat_open"){o.go("quickentry.chating")}else if(i==="chat_closed"){o.go("quickentry.closed")}else if(i==="chat_new"){o.go("quickentry.waiting")}break}if("community"===t){o.go("quickentry.community");break}if("dashboard"===t){o.go("quickentry.dashboard.home");break}}while(0)}d.click=function(e){if(e.count=="+"){o.go("manage")}else{p(e)}};function g(){d.datas=a.detail.shortcuts.gets(a.list.shortcuts.gets(d.argument._page))||[];if(r.engineer.isCreatedDemoTicket==false){T.forEach(d.datas,function(e){if(e.view&&"VIEW_TITLE_TICKET_MY"==e.view.title){if(0==parseInt(e.count)){e.count="1"}}})}m()}function m(){var e=a.detail.shortcuts.gets(a.list.shortcuts.gets(d.argument._page));if(e.length>0){var t=a.config.route.get("quickentry.selectedId");if(T.isDefined(t)&&t<e.length){p(e[t])}else{p(e[0])}}}function _(){d.isLoading=true;n.run(d.listName,i.constant.EVENT_LIST_SHORTCUT,d.argument._page,"",d.argument,function(e){if(0==e.status){d.isLoading=false}})}function h(){v();g();_()}function v(){i.register(f,i.constant.EVENT_LIST_SHORTCUT,function(e){g()});i.register(f,i.constant.EVENT_LIST_SHORTCUT_UPDATE,function(e,t){T.forEach(d.datas,function(e){if(e.typeKey==t.typeKey){void 0;e.count=t.count}})});i.register(f,i.constant.EVENT_LIST_DATA_LOADING,function(e,t){T.forEach(d.datas,function(e){if(e.typeKey==t.typeKey){e.isLoading=t.isLoading}})})}function E(){i.unRegister(f)}h();t.$on("$destroy",function(){E()});t.$on("quickentry-force-reload",_)}})(angular);(function(b){e.$inject=["$scope","coreModelService","manageService","alertService","refreshManageService","$state","$timeout","apiTicketViewService","coreNotifyService","apiUserViewService","$modal_","ConsoleConfig","apiConsoleShortcutsService"];b.module("eweiApp.quickEntry").controller("manageController",e);e.$injct=["$scope","coreModelService","manageService","alertService","refreshManageService","$state","$timeout","apiTicketViewService","coreNotifyService","apiUserViewService","$modal_","ConsoleConfig","apiConsoleShortcutsService "];function e(a,o,e,r,t,i,s,n,c,l,u,d,f){var p;a.favoriteLink=function(){p=u({scope:a,title:"提示信息",contentTemplate:"source/views/favorite.html",html:true,show:true,placement:"center"})};var g=this.__proto__.constructor.name+"_"+(new Date).valueOf();var m="list.shortcut";var _="";a.items=o.detail.shortcuts.gets(o.list.shortcuts.gets(1));if(a.items.length==0){f.run(m,c.constant.EVENT_LIST_SHORTCUT,1,"","",function(e){if(b.isDefined(e)){}})}else{h()}function h(){_=a.items.pop();void 0;for(var e=0;e<a.items.length;e++){a.items[e].view=null}void 0;a.defaultCheckedOptionValues=v(a.items)}a.sortableOptions={animation:300,ghostClass:"sortable-ghost",chosenClass:"sortable-chosen",forceFallback:true};function v(e){var t={};for(var i=0;i<e.length;i++){if(typeof e[i]=="undefined"){continue}else if(typeof e[i].view!="undefined"&&e[i].view!=null&&e[i].view!=""&&e[i].view.title=="CONSOLE_SHORTCUTS_MANAGE"){continue}else{t[e[i].typeKey]=e[i].type}}void 0;return t}a.defaultCheckedOptionValues=v(a.items);void 0;function E(){c.register(g,c.constant.EVENT_DETAIL_TICKET_VIEWS,function(e,t){a.ticket_views=o.detail.ticket.views.gets(o.list.ticket.views.gets(1))});c.register(g,c.constant.EVENT_DETAIL_USER_VIEWS,function(e,t){a.user_views=o.detail.user.views.gets(o.list.user.views.gets(1))});c.register(g,c.constant.EVENT_LIST_SHORTCUT,function(e){a.items=o.detail.shortcuts.gets(o.list.shortcuts.gets(1));h()})}function T(){c.unRegister(g)}a.$on("$destroy",function(){T()});function y(){n.run({_count:999,_do_count:false,_filter:"{'$and':[{'$eq':{'type':'ticket'}},{'$eq':{'active':1}}]}",include_fields:"id,type,title,isSystemDefault"},"",c.constant.EVENT_DETAIL_TICKET_VIEWS,function(e){if(e.status!=0){r.add("服务器异常","danger")}})}function N(){l.run({_count:999,_do_count:false,_filter:"{'$and':[{'$in':{'type':['user','userGroup']}},{'$eq':{'active':1}}]}",include_fields:"id,type,title,isSystemDefault"},"",c.constant.EVENT_DETAIL_USER_VIEWS,function(e){if(e.status!=0){r.add("服务器异常","danger")}})}function S(){a.ticket_views=o.detail.ticket.views.gets(o.list.ticket.views.gets(1));a.user_views=o.detail.user.views.gets(o.list.user.views.gets(1));a.user_default_views=e.userDefaultViewService();a.chatList=e.chatListService();a.communityResourceList=e.communityResourceService();a.dashboardList=[{title:"仪表盘",typeKey:"dashboard",type:"dashboard"}]}function C(){N();y();E();S()}C();function w(e,t){var i=[];for(var n=0;n<t.length;n++){if(e.typeKey!=t[n].typeKey){i.push(t[n])}else{a.items[n].reduce=true}}return i}function P(e,t){var i=t;for(var n=0;n<i.length;n++){i[n].grow=false}i.unshift(e);i[0].grow=true;a.items=i;return i}var k=true;a.switchTicketList=function(e,t){if(!k){r.add("请不要点击的过快","warning","left",1e3);return false}k=false;void 0;var i=a.items;var n={name:e.displayTitle?e.displayTitle:e.title,orderKey:"",type:"ticket",typeKey:"ticket_view_"+e.id,view:{id:e.id}};if(a.items.length>=7&&!a.defaultCheckedOptionValues[n.typeKey]){r.add("自定义快捷入口不能超过7个，请取消其他快捷入口再进行添加","warning");k=true;return false}else if(a.defaultCheckedOptionValues[n.typeKey]){a.ticket_views[t].pointShow=false;a.ticket_views[t].pointHide=true;i=w(n,i)}if(a.items.length<=1&&a.defaultCheckedOptionValues[n.typeKey]){r.add("自定义快捷入口至少要保留一个","warning");k=true;return false}else if(!a.defaultCheckedOptionValues[n.typeKey]){n.orderKey=1;a.ticket_views[t].pointHide=false;a.ticket_views[t].pointShow=true;i=P(n,i)}s(function(){a.items=i;a.items[0].grow=false;a.defaultCheckedOptionValues=v(i);k=true},800)};a.switchUserList=function(e,t){if(!k){r.add("请不要点击的过快","warning","left",1e3);return false}k=false;void 0;var i=a.items;var n={name:e.displayTitle?e.displayTitle:e.title,orderKey:"",type:e.type,typeKey:e.typeKey?e.typeKey:"user_new"};if(a.items.length>=7&&!a.defaultCheckedOptionValues[n.typeKey]){r.add("自定义快捷入口不能超过7个，请取消其他快捷入口再进行添加","warning");k=true;return false}else if(a.defaultCheckedOptionValues[n.typeKey]){a.user_views[t].pointShow=false;a.user_views[t].pointHide=true;i=w(n,i)}if(a.items.length<=1&&a.defaultCheckedOptionValues[n.typeKey]){r.add("自定义快捷入口至少要保留一个","warning");k=true;return false}else if(!a.defaultCheckedOptionValues[n.typeKey]){a.user_views[t].pointShow=true;a.user_views[t].pointHide=false;n.orderKey=1;i=P(n,i)}s(function(){a.items=i;a.items[0].grow=false;a.defaultCheckedOptionValues=v(i);k=true},800)};a.switchCommonList=function(e,t,i){if(!k){r.add("请不要点击的过快","warning","left",1e3);return false}k=false;var n=a.items;var o={name:e.title,orderKey:"",type:e.type,typeKey:e.typeKey};if(a.items.length>=7&&!a.defaultCheckedOptionValues[o.typeKey]){r.add("自定义快捷入口不能超过7个，请取消其他快捷入口再进行添加","warning");k=true;return false}else if(a.defaultCheckedOptionValues[o.typeKey]){if(i=="user_default"){a.user_default_views[t].pointShow=false;a.user_default_views[t].pointHide=true}else if(i=="chat_list"){a.chatList[t].pointShow=false;a.chatList[t].pointHide=true}else if(i=="community"){a.communityResourceList[t].pointShow=false;a.communityResourceList[t].pointHide=true}n=w(o,n)}if(a.items.length<=1&&a.defaultCheckedOptionValues[o.typeKey]){r.add("自定义快捷入口至少要保留一个","danger");k=true;return false}else if(!a.defaultCheckedOptionValues[o.typeKey]){o.orderKey=1;if(i=="user_default"){a.user_default_views[t].pointShow=true;a.user_default_views[t].pointHide=false}else if(i=="chat_list"){a.chatList[t].pointShow=true;a.chatList[t].pointHide=false}else if(i=="community"){a.communityResourceList[t].pointShow=true;a.communityResourceList[t].pointHide=false}n=P(o,n)}s(function(){a.items=n;a.items[0].grow=false;a.defaultCheckedOptionValues=v(n);k=true},800)};a.submitManage=function(){a.savingSettings=true;t(A()).then(function(e){if(e.status==0){I(a.items);c.doNotify(c.constant.EVENT_LIST_SHORTCUT);o.config.route.put("quickentry.selectedId",0);i.go("quickentry")}else{r.add("保存失败","danger");a.savingSettings=false}})};function I(e){var i=[];b.forEach(e,function(e,t){e.id=t;o.detail.shortcuts.put(t,e);i.push(t)});var t=i.length;var n={id:t,name:"管理",count:"+",orderKey:t,view:{title:"CONSOLE_SHORTCUTS_MANAGE"}};o.detail.shortcuts.put(n.id,n);i.push(t);o.list.shortcuts.put(1,i);void 0}function A(){var e=a.items;void 0;for(var t=0;t<e.length;t++){e[t].orderKey=t;if(e[t].type=="ticket"){e[t].view={};e[t].view.id=e[t].typeKey.substring(12,e[t].typeKey.length);void 0}else if(e[t].type=="user"){e[t]=L(e[t])}}return e}function L(e){var t=a.user_views;for(var i=0;i<t.length;i++){if(t[i].typeKey==e.typeKey){e.view={};e.view.id=t[i].id}else if(e.typeKey=="user_new"&&t[i].typeKey=="user_all"){e.view={};e.view.id=t[i].id}}return e}}})(angular);(function(e){i.$inject=["$http","$q"];e.module("eweiApp.quickEntry").factory("refreshManageService",i).service("manageService",t);t.$inject=[];function t(){this.communityResourceService=function(){return[{type:"community",typeKey:"community",title:"社区动态"}]};this.chatListService=function(){return[{type:"chat",typeKey:"chat_new",title:"待接通的会话"},{type:"chat",typeKey:"chat_open",title:"进行中的会话"},{type:"chat",typeKey:"chat_closed",title:"已结束的会话"}]};this.userDefaultViewService=function(){return[{title:"客服",typeKey:"engineer",type:"user"},{title:"客服组",typeKey:"service_desk",type:"user"}]}}i.$injct=["$http","$q"];function i(i,n){var e=function(e){var t=n(function(o,a){i({url:"api/v1/console_shortcuts.json",data:e,params:{_token:getCookie("user_token")},method:"post"}).success(function(e,t,i,n){o(e)}).error(function(e,t,i,n){a(e)})});return t};return e}})(angular);(function(H){"use strict";H.module("eweiApp.quickEntry").controller("quickEntryTicketController",t).directive("simulationTicketPointer",e);e.$inject=[];function e(){return{restrict:"E",replace:true,template:"<div style='position: fixed;z-index:10'><img src='source/images/simulation-ticket-pointer.png'></div>",link:function(e,t,i){var n=t.prev("a");e.$evalAsync(function(){var e=n.offset();t.css({top:e.top+40+"px",left:e.left+30+"px"})})}}}t.$inject=["$rootScope","$http","$stateParams","$scope","coreNotifyService","coreModelService","apiTicketService","apiTicketStatusColorService","apiTicketSubscriptionsService","apiSetTicketSubscriptionService","apiTicketCustomFieldValueService","apiCustomFieldListShowService","NgTableParams","utils","$state","ConsoleConfig","apiTicketServiceCatalogNameService","apiTicketEvaluateConfigService","apiTicketCopytoService","apiTicketTagsService","permissions","cachedTicketService","cachedTicketTagService","locker","providerJudgement"];function t(t,e,o,i,n,l,a,r,s,c,u,d,f,p,g,m,_,h,v,E,T,y,N,S,C){var w=this;var P=w.__proto__.constructor.name+"_"+(new Date).valueOf();w.listName="";w.statusColors={};w.servicecatalogs=[];w.columns=[];w.datas=[];w.view={};w.viewClientWidth=window.screen.width-55;w.isShowCreateNewTicket=false;w.isShowHowToCreateTicket=false;w.isAuthorTicketSettingVia=false;w.isShowSimulationTicketPointer=false;w.submitNewTicketTip=m.providerHelpCenterUrl;w.argument={_fields:"",_filter:{},_asc:"",_desc:"",_count:99999,_page:1};w.argumentLast=H.copy(w.argument);function k(){if(w.view.fields&&(-1!=w.view.fields.indexOf("evaluate.score")||-1!=w.view.fields.indexOf("evaluate.solved"))){h.run()}}w.setEvaluates=function(){var e=l.config.evaluate;H.forEach(w.datas,function(t){if(t&&t.evaluate){H.forEach(e.firstQuestionOptions,function(e){if(e.value==String(t.evaluate.solved)){t.evaluate.solvedName=e.name}});H.forEach(e.secondQuestionOptions,function(e){if(e.value==t.evaluate.score){t.evaluate.scoreName=e.name}})}})};w.getStatusColors=function(){var e=l.list.cachedTickets.get(w.listName).gets(w.argument._page).join(",");if(e&&e.length>0){r.run(w.listName,n.constant.EVENT_LIST_TICKET_STATUSCOLORS,w.argument._page,"",{ticketIds:e},function(e){if(e){}})}};w.setStatusColors=function(){var e=l.list.cachedTickets.get(w.listName).gets(w.argument._page);var t={};H.forEach(e,function(e){t[e]=l.detail.statuscolors.get(e)});w.statusColors=t};w.getSubscriptions=function(){var e=l.list.cachedTickets.get(w.listName).gets(w.argument._page).join(",");if(e&&e.length>0){s.run(w.listName,n.constant.EVENT_DETAIL_TICKETS,w.argument._page,"",{ticketIds:e},function(e){if(e){if(e.status==0&&H.isDefined(e.result)){y.updateSubscriptionCached(e.result);D()}}})}};w.getCopyto=function(){if(!w.view)return;if(w.view.otherFields&&-1!=w.view.otherFields.indexOf("copyTo")){var e=l.list.cachedTickets.get(w.listName).gets(w.argument._page).join(",");if(e&&e.length>0){v.run(w.listName,n.constant.EVENT_DETAIL_TICKETS,w.argument._page,"",{ticketIds:e},function(e){if(e.status==0&&H.isDefined(e.result)){y.updateCopyToCached(e.result);D()}})}}};w.getTags=function(){if(w.view.otherFields&&-1!=w.view.otherFields.indexOf("tags")){var e=l.list.cachedTickets.get(w.listName).gets(w.argument._page).join(",");if(e&&e.length>0){E.run(w.listName,n.constant.EVENT_DETAIL_TICKETS,w.argument._page,"",{ticketIds:e},function(e){if(e.status==0&&H.isDefined(e.result)){N.updateCached(e.result);D()}})}}};w.getServiceCatalogName=function(){if(w.view.fields&&-1!=w.view.fields.indexOf("serviceCatalog.id")){var e=l.list.cachedTickets.get(w.listName).gets(w.argument._page).join(",");if(e&&e.length>0){_.run(w.listName,n.constant.EVENT_DETAIL_TICKETS,w.argument._page,"",{ticketIds:e},function(e){if(e.status==0&&H.isDefined(e.result)){y.updateServiceCatalogCached(e.result);D()}})}}};w.setSubscription=function(t){c.run(t.isTarget,n.constant.EVENT_DETAIL_TICKETS,{ticket_id:t.id},"",function(e){if(e.status==0){y.updateSubscriptionCached({ticketId:t.id,isTarget:t.isTarget})}})};w.createNewTicket=function(){if(!C.isTrue()){return false}if(t.nextTicketId==undefined){t.nextTicketId=p.countByStateName("tickets_new")+1}var e=++t.nextTicketId;S.driver("session").namespace("eweiApp.nextTicketId").put("lastid",e);g.go("tickets_new.normal",{id:e,type:"normal"})};w.createDemoTicket=function(){e({url:"create_demo_ticket.json",method:"POST"}).success(function(e,t,i,n){if(e.success){m.engineer.isCreatedDemoTicket=true;g.go("tickets_detail",{id:e.id})}})};w.createNewViaWebForm=function(){g.go("system_setting.detail",{uri:"channel_settings",settingType:"multi_channel"})};w.createNewViaEmail=function(){g.go("system_setting.detail",{uri:"channel_settings",settingType:"multi_channel"})};function I(){d.run(w.listName,n.constant.EVENT_LIST_FIELD_TITLE,1,"",{view_id:w.view.id},function(e){})}w.getCustomFieldValue=function(){if(w.view.customFields){var e=JSON.parse(w.view.customFields);var t=[];H.forEach(e,function(e){t.push(e.id)});var i=l.list.cachedTickets.get(w.listName).gets(w.argument._page).join(",");if(i&&i.length>0){u.run(w.listName,n.constant.EVENT_DETAIL_TICKETS,1,"",{customFieldIds:t.join(","),ticketIds:i},function(e){if(e.status==0&&H.isDefined(e.result)){y.updateCustomFieldCached(e.result);D()}})}}};function A(e,t,i,n){var o=2;for(var a in e){if(e.hasOwnProperty(a)){o++;var r=i&&i[e[a].id];var s=n&&n[e[a].id];t=t-(r|s);if(t<=0){break}}}return o}function L(e){var i=l.detail.fields.title.gets(l.list.fields.title.get(o.id).gets(1));w.columns=[{title:"",visible:true,sortable:false,widthClass:"w15",field:"subscription",fieldCount:1}];var n=[];if(w.view&&w.view.sortFields){w.view.sortFields=H.fromJson(w.view.sortFields);H.forEach(w.view.sortFields,function(e){for(var t=0;t<i.length;t++){if(i[t].id==e.id){n.push(i[t]);break}}})}var a=["serviceCatalog.id","tags","copyTo"];n=n.length>0?n:i;var r=e?i.length:A(n,w.viewClientWidth,w.fieldsLength,w.customFieldsLength);H.forEach(n,function(e,t){if(t<=r){var i={};i.title=e.title;i.visible=true;i.sortable=e.systemFieldKey&&a.indexOf(e.id)===-1;i.widthClass=V(e.id);i.field=e.id;if("status"!=e.id&&"id"!=e.id){if(e.systemFieldKey){var n=e.id.split(".");for(var o=0;o<n.length;o++){i["field"+o]=n[o]}i.fieldCount=n.length}else{i.fieldCount="customFields";i.type=e.type}w.columns.push(i)}}});w.tableParams&&w.tableParams.reload()}function b(){M();L();U();O(l.config.route.get("quickentry.selectedId"))}var $=0;i.loadMoreFields=function(){if($++===0){L(true)}};w.sorting=function(e){var t=w.tableParams.isSortBy(e.field,"desc");if(t){w.argument._asc=e.field;w.argument._desc=""}else{w.argument._desc=e.field;w.argument._asc=""}e.sortable?w.tableParams.sorting(e.field,w.tableParams.isSortBy(e.field,"desc")?"asc":"desc"):""};function D(){var t=!j||JSON.stringify(w.argument)==JSON.stringify(w.argumentLast);if(!t){n.doNotify(n.constant.EVENT_LIST_DATA_LOADING,{typeKey:w.listName,isLoading:true})}w.datas=y.getTickets(w.listName,w.argument._page,w.argument,null,t,function(e){n.doNotify(n.constant.EVENT_LIST_DATA_LOADING,{typeKey:w.listName,isLoading:false});if(!t){w.argumentLast=H.copy(w.argument)}w.tableParams.isTicketLoading=false;if(w.view){w.view.count=l.list.cachedTickets.get(w.listName).total();n.doNotify(n.constant.EVENT_LIST_SHORTCUT_UPDATE,{typeKey:w.listName,count:w.view.count})}});if(w.datas&&w.datas.length>0){w.setEvaluates();w.setStatusColors()}}function O(e){if(H.isUndefined(e)){e=0}var t=l.detail.shortcuts.get(parseInt(e));if(H.isDefined(t)&&t.view&&t.view.filter&&t.view.fields){w.view=t.view;w.listName=t.typeKey;w.argument._fields=w.view.fields;w.argument._filter=w.view.filter;w.argument._custom_field_filter=w.view.customFieldFilter?w.view.customFieldFilter:null;w.argument._page=l.list.cachedTickets.get(w.listName).page();w.tableParams.page(w.argument._page);if("desc"==w.view.order){w.argument._desc=w.view.orderBy}else if("asc"==w.view.order){w.argument._asc=w.view.orderBy}w.tableParams.sorting(w.view.orderBy,w.view.order);w.isShowCreateNewTicket="VIEW_TITLE_TICKET_ALL"==w.view.title||"VIEW_TITLE_TICKET_MY_GROUP"==w.view.title||"VIEW_TITLE_TICKET_MY"==w.view.title;w.isShowHowToCreateTicket="VIEW_TITLE_TICKET_NEW"==w.view.title;w.isAuthorTicketSettingVia=T.hasPermission("ticket_setting_via");I();k();if(w.view&&H.isString(w.view.customFields)&&H.isString(w.view.customFieldsLength)){w.customFieldsLength={};var i=H.fromJson(w.view.customFields);var n=w.view.customFieldsLength.split(",");if(H.isDefined(i)&&i.length==n.length){i.forEach(function(e,t){if(e){w.customFieldsLength[parseInt(e.id)]=parseInt(n[t])}})}}if(w.view&&H.isString(w.view.fields)&&H.isString(w.view.fieldsLength)){w.fieldsLength={};var o=w.view.fields.split(",");var a=w.view.fieldsLength.split(",");if(H.isString(w.view.groupBy)&&o.length!=a.length){for(var r=0;r<o.length;r++){if(o[r]==w.view.groupBy){o.splice(r,1);break}}}if(o.length==a.length){o.forEach(function(e,t){if(e&&e.length>0){w.fieldsLength[e]=parseInt(a[t])}})}}if(w.view&&H.isString(w.view.otherFields)&&H.isString(w.view.otherFieldsLength)){w.fieldsLength=w.fieldsLength||{};var s=w.view.otherFields.split(",");var c=w.view.otherFieldsLength.split(",");if(H.isDefined(s)&&s.length==c.length){s.forEach(function(e,t){if(e&&e.length>0&&c[t]){w.fieldsLength[e]=parseInt(c[t])}})}}}}w.setRows=function(e){j=true;var t=w.tableParams.count();if(e==t)return;w.tableParams.count(e);w.argument._count=e;w.tableParams.page(w.argument._page);w.tableParams.getData(w.tableParams)};var j=false;function U(){w.tableParams=w.tableParams||new f({page:w.argument._page,count:w.argument._count,sorting:JSON.parse('{"'+w.view.orderBy+'":"'+w.view.order+'"}')},{counts:[],groupBy:function(e){return null},total:0,getData:function(e,t){w.argument._page=H.copy(t.page());l.list.cachedTickets.get(w.listName).page(H.copy(t.page()));D();t.total(l.list.cachedTickets.get(w.listName).total());e.resolve(w.datas)}})}function V(e){var t="w100";do{if("subject"==e){t="w320";break}if("serviceDesk.name"==e||"via.name"==e){t="w200"}}while(0);return t}w.simulationTicket=function(){if("VIEW_TITLE_TICKET_MY"==w.view.title&&m.engineer.isCreatedDemoTicket==false){if(0==l.list.cachedTickets.get(w.listName).total()){var e={createdAt:(new Date).format("yyyy-MM-dd hh:mm:ss"),id:0,requester:{name:"Robot"},subject:"你有一张工单需要处理",via:{channelName:"客服界面",source:m.providerHelpCenterUrl+"/console"},status:"new"};l.detail.cachedTickets.put(e.id,e);l.list.cachedTickets.get(w.listName).put(1,[e.id]);l.list.cachedTickets.get(w.listName).total(1);w.isShowSimulationTicketPointer=true}}};function M(){n.register(P,n.constant.EVENT_LIST_CACHED_TICKETS_AVAILABLE,function(e){w.getServiceCatalogName();w.getStatusColors();w.getSubscriptions();w.getCustomFieldValue();w.getCopyto();w.getTags();w.simulationTicket();w.tableParams.reload();if(w.datas&&w.datas.length==0&&w.argument._page>1){i.$evalAsync(function(){void 0;var e=l.list.cachedTickets.get(w.listName).total();var t=Math.ceil(e/w.argument._count);w.argument._page=t;if(w.argument._page<1){w.argument._page=1}w.tableParams.page(w.argument._page);w.tableParams.getData(w.tableParams)})}});n.register(P,n.constant.EVENT_LIST_TICKET_STATUSCOLORS,function(e){w.setStatusColors()});n.register(P,n.constant.EVENT_LIST_FIELD_TITLE,function(e){L()});n.register(P,n.constant.EVENT_LIST_SHORTCUT,function(e){O(l.config.route.get("quickentry.selectedId"));w.tableParams.reload()})}function R(){n.unRegister(P)}b();i.$on("$destroy",function(){R()})}})(angular);(function(y){"use strict";y.module("eweiApp.quickEntry").controller("quickEntryEngineerController",e);e.$inject=["$rootScope","$scope","coreNotifyService","coreModelService","apiEngineerOnlineService","ConsoleConfig","NgTableParams","apiCustomFieldListShowService","permissions"];function e(e,t,i,n,o,a,r,s,c){var l=this;var u=l.__proto__.constructor.name+"_"+Date.now();l.listName="";l.datas=[];l.columns=[];l.view={};l.argument={_fields:"",_count:0,_page:1,_asc:"",_desc:"id"};l.argumentLast=y.copy(l.argument);l.showAddTip=false;l.rowClick=function(e){};var d=function(){l.columns=[{title:"姓名",field:"user.name",fieldCount:2,field0:"user",field1:"name",visible:true,sortable:true,widthClass:"w100",sortField:"name"},{title:"客服组",field:"defaultServiceDesk.name",fieldCount:2,field0:"defaultServiceDesk",field1:"name",visible:true,sortable:true,widthClass:"w200",sortField:"defaultServicedeskName"},{title:"角色权限",field:"role.name",fieldCount:2,field0:"role",field1:"name",visible:true,sortable:true,widthClass:"w200",sortField:"roleName"},{title:"手机号",field:"user.mobilePhone",fieldCount:2,field0:"user",field1:"mobilePhone",visible:true,sortable:true,widthClass:"w200",sortField:"mobilePhone"},{title:"最近登录",field:"user.lastLoginAt",fieldCount:2,field0:"user",field1:"lastLoginAt",visible:true,sortable:true,widthClass:"w200",sortField:"lastLoginAt"},{title:"会话状态",field:"concurrentChatNumber",visible:true,sortable:false,widthClass:"w100"},{title:"已登录的终端",field:"client",fieldCount:1,visible:true,sortable:false,widthClass:"w200"}]};l.sorting=function(e){var t=l.tableParams.isSortBy(e.sortField,"desc");if(t){l.argument._asc=e.sortField;l.argument._desc=""}else{l.argument._desc=e.sortField;l.argument._asc=""}e.sortable?l.tableParams.sorting(e.sortField,l.tableParams.isSortBy(e.sortField,"desc")?"asc":"desc"):""};function f(){i.doNotify(i.constant.EVENT_LIST_DATA_LOADING,{typeKey:l.listName,isLoading:true});o.run(l.listName,i.constant.EVENT_LIST_ENGINEER_ONLINE,l.argument._page,"",l.argument,function(e){i.doNotify(i.constant.EVENT_LIST_DATA_LOADING,{typeKey:l.listName,isLoading:false})})}function p(){l.datas=n.detail.engineers.gets(n.list.engineers.online.gets(l.argument._page))}function g(){E();d();v();_(n.config.route.get("quickentry.selectedId"))}function m(){p();if(!h)return;if(JSON.stringify(l.argument)!=JSON.stringify(l.argumentLast)){f();l.argumentLast=y.copy(l.argument)}}function _(e){var t=n.detail.shortcuts.get(n.list.shortcuts.get(1,parseInt(e)));if(y.isDefined(t)){l.view=t.view;l.listName=t.typeKey;l.argument._page=n.list.engineers.online.page();l.tableParams.page(l.argument._page);l.argument._fields="id,user.name,defaultServiceDesk.name,role.name,user.mobilePhone,user.lastLoginAt,androidOnline,iosOnline,webOnline,androidLogin,iosLogin,webLogin,countChat,concurrentChatNumber"}}l.setRows=function(e){h=true;var t=l.tableParams.count();if(e==t)return;l.argument._count=e;l.tableParams.count(e);l.tableParams.page(l.argument._page);l.tableParams.getData(l.tableParams)};var h=false;function v(){l.tableParams=l.tableParams||new r({page:l.argument._page,count:l.argument._count,sorting:JSON.parse('{"'+l.view.orderBy+'":"'+l.view.order+'"}')},{counts:[],groupBy:function(e){return null},total:0,getData:function(e,t){l.argument._page=y.copy(t.page());n.list.engineers.online.page(y.copy(t.page()));m();t.total(n.list.engineers.online.total());e.resolve(l.datas);l.showAddTip=c.hasPermission("engieer_create")&&t.total()<2}})}function E(){i.register(u,i.constant.EVENT_LIST_ENGINEER_ONLINE,function(e){l.tableParams.reload()});i.register(u,i.constant.EVENT_DETAIL_ENGINEERS,function(e,t){y.forEach(l.datas,function(e){if(e.id==t.id){e=n.detail.engineers.get(t.id)}})})}function T(){i.unRegister(u)}l.inviteEngineer=function(){e.$broadcast("show-invite-engineer-dialog")};g();t.$on("$destroy",function(){T()})}})(angular);(function(C){"use strict";C.module("eweiApp.quickEntry").controller("quickEntryUserController",e);e.$inject=["$rootScope","$stateParams","$scope","coreNotifyService","coreModelService","apiCustomerService","apiCustomFieldListShowService","NgTableParams","apiCustomerCustomFieldValueService","permissions"];function e(e,o,t,i,s,n,a,r,c,l){var u=this;var d=u.__proto__.constructor.name+"_"+(new Date).valueOf();u.listName="";u.datas=[];u.columns=[];u.view={};u.typeKey="";u.argument={_fields:"",_asc:"",_desc:"",_count:0,_page:1};u.argumentLast=C.copy(u.argument);u.typeKeyLast=C.copy(u.typeKey);u.showAddTip=false;function f(){a.run(u.listName,i.constant.EVENT_LIST_FIELD_TITLE,1,"",{view_id:u.view.id},function(e){})}u.getCustomFieldValue=function(){if(u.view.customFields){var e=JSON.parse(u.view.customFields);var t=[];C.forEach(e,function(e){t.push(e.id)});c.run(u.listName,i.constant.EVENT_DETAIL_CUSTOMERS,1,"",{customFieldIds:t.join(","),userIds:s.list.customers.get(u.listName).gets(u.argument._page).join(",")},function(e){if(e){}})}};function p(){var i=s.detail.fields.title.gets(s.list.fields.title.get(o.id).gets(1));u.columns=[];var n=[];if(u.view&&u.view.sortFields){u.view.sortFields=C.fromJson(u.view.sortFields);C.forEach(u.view.sortFields,function(e){for(var t=0;t<i.length;t++){if(i[t].id==e.id){n.push(i[t]);break}}})}n=n.length>0?n:i;var t=[];C.forEach(n,function(e){u.columns.push({title:e.title,field:e.id,visible:true,sortable:false,widthClass:E(e.id),type:e.type});t.push(e.id)});s.list.fields.title.get(u.listName).put(1,t);u.tableParams&&u.tableParams.reload()}function g(){i.doNotify(i.constant.EVENT_LIST_DATA_LOADING,{typeKey:u.listName,isLoading:true});n.run(u.listName,i.constant.EVENT_LIST_CUSTOMER_REFRESH,u.argument._page,"",u.argument,function(e){i.doNotify(i.constant.EVENT_LIST_DATA_LOADING,{typeKey:u.listName,isLoading:false})})}function m(){u.datas=s.detail.customers.gets(s.list.customers.get(o.id).gets(u.argument._page))}function _(){N();p();y();v(s.config.route.get("quickentry.selectedId"))}u.sorting=function(e){var t=u.tableParams.isSortBy(e.field,"desc");if(t){u.argument._asc=e.field;u.argument._desc=""}else{u.argument._desc=e.field;u.argument._asc=""}e.sortable?u.tableParams.sorting(e.field,u.tableParams.isSortBy(e.field,"desc")?"asc":"desc"):""};function h(){m();if(!T)return;if(JSON.stringify(u.argument)!=JSON.stringify(u.argumentLast)||u.typeKey!=u.typeKeyLast){g();u.argumentLast=C.copy(u.argument);u.typeKeyLast=C.copy(u.typeKey)}}function v(e){var t=s.detail.shortcuts.get(s.list.shortcuts.get(1,parseInt(e)));if(C.isDefined(t)){u.view=t.view;u.listName=t.typeKey;u.argument._fields=u.view.fields;u.typeKey=t.typeKey;u.argument._page=s.list.customers.get(u.listName).page();u.tableParams.page(u.argument._page);if("desc"==u.view.order){u.argument._desc=u.view.orderBy}else if("asc"==u.view.order){u.argument._asc=u.view.orderBy}f();if(u.view&&C.isString(u.view.customFields)&&C.isString(u.view.customFieldsLength)){u.customFieldsLength={};var i=C.fromJson(u.view.customFields);var n=u.view.customFieldsLength.split(",");if(C.isDefined(i)&&i.length==n.length){i.forEach(function(e,t){u.customFieldsLength[parseInt(e.id)]=parseInt(n[t])})}}if(u.view&&C.isString(u.view.fields)&&C.isString(u.view.fieldsLength)){u.fieldsLength={};var o=u.view.fields.split(",");var a=u.view.fieldsLength.split(",");if(C.isString(u.view.groupBy)&&o.length!=a.length){for(var r=0;r<o.length;r++){if(o[r]==u.view.groupBy){o.splice(r,1);break}}}if(o.length==a.length){o.forEach(function(e,t){if(e&&e.length>0){u.fieldsLength[e]=parseInt(a[t])}})}}}}function E(e){var t="w150";do{if("name"==e){t="w200";break}if("nickname"==e){t="w200";break}if("id"==e){t="w70";break}}while(0);return t}u.setRows=function(e){T=true;var t=u.tableParams.count();if(e==t)return;u.tableParams.count(e);u.argument._count=e;u.tableParams.page(u.argument._page);u.tableParams.getData(u.tableParams)};var T=false;function y(){u.tableParams=u.tableParams||new r({page:u.argument._page,count:u.argument._count,sorting:JSON.parse('{"'+u.view.orderBy+'":"'+u.view.order+'"}')},{counts:[],groupBy:function(e){return null},total:0,getData:function(e,t){u.argument._page=C.copy(t.page());s.list.customers.get(u.listName).page(C.copy(t.page()));h();t.total(s.list.customers.get(u.listName).total());e.resolve(u.datas);u.showAddTip=l.hasPermission("customer_create")&&t.total()<2}})}function N(){i.register(d,i.constant.EVENT_LIST_CUSTOMER_REFRESH,function(e){u.getCustomFieldValue();u.tableParams.reload()});i.register(d,i.constant.EVENT_DETAIL_CUSTOMERS,function(e,t){C.forEach(u.datas,function(e){if(e.id==t.id){e=s.detail.customers.get(t.id)}})});i.register(d,i.constant.EVENT_LIST_FIELD_TITLE,function(e){p()})}function S(){i.unRegister(d)}u.createUser=function(){e.$broadcast("createNewUser")};_();t.$on("$destroy",function(){S()})}})(angular);(function(E){"use strict";E.module("eweiApp.quickEntry").controller("quickEntryCommunityController",e);e.$inject=["$state","$scope","coreNotifyService","coreModelService","apiCommunitysService","ConsoleConfig","NgTableParams","$filter"];function e(e,t,i,n,o,a,r,s){var c=this;var l=c.__proto__.constructor.name+"_"+(new Date).valueOf();c.listName="list.communitys";c.datas=[];c.selectedId=0;c.argument={_fields:"",_page:1,_count:0,createdAtBegin:"",createdAtEnd:""};c.role=a.user.role.nameKey;c.argumentLast=E.copy(c.argument);c.columns=[{title:"更新于",field:"createdAt",sortable:true,widthClass:"w200"},{title:"更新人",field:"user.name",fieldCount:2,field0:"user",field1:"name",sortable:true,widthClass:"w200"},{title:"主题",field:"question.title",fieldCount:2,field0:"question",field1:"title",sortable:true,widthClass:"w200"}];function u(){c.datas=n.detail.communitys.gets(n.list.communitys.news.gets(c.argument._page))||[]}c.sorting=function(e){var t=c.tableParams.isSortBy(e.field,"desc");if(t){c.argument._asc=e.field;c.argument._desc=""}else{c.argument._desc=e.field;c.argument._asc=""}e.sortable?c.tableParams.sorting(e.field,c.tableParams.isSortBy(e.field,"desc")?"asc":"desc"):""};c.goAddArticle=function(){window.open(window.location.protocol+"//"+window.location.host+"/#/article/new")};c.goEditMenu=function(){window.open(window.location.protocol+"//"+window.location.host+"/#/manage/article-catalog")};function d(){i.doNotify(i.constant.EVENT_LIST_DATA_LOADING,{typeKey:"community",isLoading:true});o.run(c.listName,i.constant.EVENT_LIST_COMMUNITYS,c.argument._page,"",c.argument,function(e){i.doNotify(i.constant.EVENT_LIST_DATA_LOADING,{typeKey:"community",isLoading:false})})}function f(){u();if(!g)return;if(JSON.stringify(c.argument)!=JSON.stringify(c.argumentLast)){d();c.argumentLast=E.copy(c.argument)}}function p(e){var t=n.detail.shortcuts.get(n.list.shortcuts.get(1,parseInt(e)));if(E.isDefined(t)){c.argument.createdAtBegin=s("date")((new Date).getTime()-60*24*3600*1e3,"yyyy-MM-dd");c.argument.createdAtEnd=s("date")((new Date).getTime(),"yyyy-MM-dd");c.argument._page=n.list.communitys.news.page();c.tableParams.page(c.argument._page)}}c.setRows=function(e){g=true;var t=c.tableParams.count();if(e==t)return;c.argument._count=e;c.tableParams.count(e);c.tableParams.page(c.argument._page);c.tableParams.getData(c.tableParams)};var g=false;function m(){c.tableParams=c.tableParams||new r({page:c.argument._page,count:c.argument._count},{counts:[],groupBy:function(e){return null},total:0,getData:function(e,t){c.argument._page=E.copy(t.page());n.list.communitys.news.page(E.copy(t.page()));f();t.total(n.list.communitys.news.total());e.resolve(c.datas)}})}function _(){h();m();p(n.config.route.get("quickentry.selectedId"))}function h(){i.register(l,i.constant.EVENT_LIST_COMMUNITYS,function(e){c.tableParams.reload()})}function v(){i.unRegister(l)}_();t.$on("$destroy",function(){v()})}})(angular);(function(){"use strict";angular.module("eweiApp.quickEntry").controller("quickEntryUserGroupController",e);e.$inject=["$rootScope","$scope","$stateParams","NgTableParams","permissions","ConsoleConfig","coreModelService","coreNotifyService","apiCustomFieldListShowService","apiCustomerGroupService","apiCustomerGroupCustomFieldValueService"];function e(e,t,i,n,o,a,s,r,c,l,u){var d=this;var f=d.__proto__.constructor.name+"_"+Date.now();d.listName="";d.datas=[];d.columns=[];d.view={};d.argument={_fields:"",_asc:"",_desc:"",_count:0,_page:1};d.showAddTip=false;var p=function(){c.run(d.listName,r.constant.EVENT_LIST_FIELD_TITLE,1,"",{view_id:d.view.id},function(e){})};d.getCustomFieldValue=function(){if(d.view.customFields){var e=JSON.parse(d.view.customFields);var t=[];angular.forEach(e,function(e){t.push(e.id)});u.run(d.listName,r.constant.EVENT_DETAIL_CUSTOMERGROUPS,1,"",{customFieldIds:t.join(","),userGroupIds:s.list.customerGroups.gets(d.argument._page).join(",")},function(e){if(e){}})}};var g=function(){var i=s.detail.fields.title.gets(s.list.fields.title.get(d.listName).gets(1));d.columns=[];var n=[];if(d.view&&d.view.sortFields){d.view.sortFields=angular.fromJson(d.view.sortFields);angular.forEach(d.view.sortFields,function(e){for(var t=0;t<i.length;t++){if(i[t].id==e.id){n.push(i[t]);break}}})}n=n.length>0?n:i;angular.forEach(n,function(e){d.columns.push({title:e.title,field:e.id,visible:true,sortable:false,widthClass:C(e.id),type:e.type})});d.tableParams&&d.tableParams.reload()};var m=function(){r.doNotify(r.constant.EVENT_LIST_DATA_LOADING,{typeKey:d.listName,isLoading:true});l.run(r.constant.EVENT_LIST_CUSTOMERGROUP_REFRESH,d.argument._page,"",d.argument,function(e){r.doNotify(r.constant.EVENT_LIST_DATA_LOADING,{typeKey:d.listName,isLoading:false})})};var _=function(){d.datas=s.detail.customerGroups.gets(s.list.customerGroups.gets(d.argument._page))};var h=function(){r.register(f,r.constant.EVENT_DETAIL_CUSTOMERGROUPS,function(e,t){angular.forEach(d.datas,function(e){if(e.id==t.id){e=s.detail.customerGroups.get(t.id)}})});r.register(f,r.constant.EVENT_LIST_CUSTOMERGROUP_REFRESH,function(e){d.getCustomFieldValue();d.tableParams.reload()});r.register(f,r.constant.EVENT_LIST_FIELD_TITLE,function(e){g()})};var v=function(){r.unRegister(f)};var E=function(){_();if(!T)return;if(JSON.stringify(d.argument)!==JSON.stringify(d.argumentLast)){m();d.argumentLast=angular.copy(d.argument)}};d.setRows=function(e){T=true;var t=d.tableParams.count();if(e==t)return;d.tableParams.count(e);d.argument._count=e;d.tableParams.page(d.argument._page);d.tableParams.getData(d.tableParams)};var T=false;var y=function(){d.tableParams=d.tableParams||new n({page:d.argument._page,count:d.argument._count,sorting:JSON.parse('{"'+d.view.orderBy+'":"'+d.view.order+'"}')},{counts:[],groupBy:function(e){return null},total:0,getData:function(e,t){d.argument._page=angular.copy(t.page());s.list.customerGroups.page(angular.copy(t.page()));E();t.total(s.list.customerGroups.total());e.resolve(d.datas);d.showAddTip=o.hasPermission("customer_group_create")&&t.total()==0}})};d.sorting=function(e){var t=d.tableParams.isSortBy(e.field,"desc");if(t){d.argument._asc=e.field;d.argument._desc=""}else{d.argument._desc=e.field;d.argument._asc=""}e.sortable?d.tableParams.sorting(e.field,d.tableParams.isSortBy(e.field,"desc")?"asc":"desc"):""};var N=function(e){var t=s.detail.shortcuts.get(s.list.shortcuts.get(1,parseInt(e)));if(angular.isDefined(t)){d.view=t.view;d.listName=t.typeKey;d.argument._fields=d.view.fields;d.typeKey=t.typeKey;d.argument._page=s.list.customerGroups.page();d.tableParams.page(d.argument._page);if("desc"==d.view.order){d.argument._desc=d.view.orderBy}else if("asc"==d.view.order){d.argument._asc=d.view.orderBy}p();if(d.view&&angular.isString(d.view.customFields)&&angular.isString(d.view.customFieldsLength)){d.customFieldsLength={};var i=angular.fromJson(d.view.customFields);var n=d.view.customFieldsLength.split(",");if(angular.isDefined(i)&&i.length==n.length){i.forEach(function(e,t){d.customFieldsLength[parseInt(e.id)]=parseInt(n[t])})}}if(d.view&&angular.isString(d.view.fields)&&angular.isString(d.view.fieldsLength)){d.fieldsLength={};var o=d.view.fields.split(",");var a=d.view.fieldsLength.split(",");if(angular.isString(d.view.groupBy)&&o.length!=a.length){for(var r=0;r<o.length;r++){if(o[r]==d.view.groupBy){o.splice(r,1);break}}}if(o.length==a.length){o.forEach(function(e,t){if(e&&e.length>0){d.fieldsLength[e]=parseInt(a[t])}})}}}};var S={id:"w100"};var C=function(e){if(S.hasOwnProperty(e)){return S[e]}return"w200"};var w=function(){h();g();y();N(s.config.route.get("quickentry.selectedId"))};w();d.userGroupsBuried=function(){_hmt.push(["_trackEvent","快捷入口/客户组","点击客户组列表"])};d.createUserGroup=function(){e.$broadcast("createNewUserGroup")};t.$on("$destroy",v)}})(angular);(function(){"use strict";angular.module("eweiApp.quickEntry").controller("quickEntryServiceDeskController",e);e.$inject=["$rootScope","$scope","$state","$stateParams","NgTableParams","permissions","ConsoleConfig","coreModelService","coreNotifyService","apiCustomFieldListShowService","apiServiceDeskService","apiSetServiceDeskService","alertService"];function e(t,e,i,n,o,a,r,s,c,l,u,d,f){var p=this;var g=p.__proto__.constructor.name+"_"+Date.now();p.listName="";p.datas=[];p.columns=[];p.view={};p.argument={_fields:"",_asc:"",_desc:"",_count:0,_page:1};var m=function(){p.columns=[{title:"编号",field:"id",visible:false,widthClass:"w50"},{title:"客服组名称",field:"name",visible:true,widthClass:"w300",sortable:true},{title:"客服数量",field:"engineerCount",visible:true,widthClass:"w200"},{title:"创建时间",field:"createdAt",visible:true,widthClass:"w200",sortable:true}];p.argument._fields="id,name,notes,createdAt,updatedAt,engineerCount"};var _=function(){c.doNotify(c.constant.EVENT_LIST_DATA_LOADING,{typeKey:p.listName,isLoading:true});u.run(c.constant.EVENT_LIST_SERVICEDESK,p.argument._page,"",p.argument,function(e){c.doNotify(c.constant.EVENT_LIST_DATA_LOADING,{typeKey:p.listName,isLoading:false})})};var h=function(){p.datas=s.detail.servicedesks.gets(s.list.servicedesks.gets(p.argument._page))};var v=function(){c.register(g,c.constant.EVENT_LIST_SERVICEDESK,function(e,t){p.tableParams.reload()});c.register(g,c.constant.EVENT_DETAIL_SERVICEDESKS,function(e,t){if(t.action=="delete"&&t.id!==undefined){for(var i=0,n=p.datas.length;i<n;i++){if(t.id==p.datas[i].id){p.datas.splice(i,1);break}}}else{angular.forEach(p.datas,function(e){if(e.id==t.id){e=s.detail.servicedesks.get(t.id)}})}})};var E=function(){c.unRegister(g)};var T=function(){h();if(!y)return;if(JSON.stringify(p.argument)!==JSON.stringify(p.argumentLast)||p.typeKey!==p.typeKeyLast){_();p.argumentLast=angular.copy(p.argument);p.typeKeyLast=angular.copy(p.typeKey)}};p.setRows=function(e){y=true;var t=p.tableParams.count();if(e==t)return;p.tableParams.count(e);p.argument._count=e;p.tableParams.page(p.argument._page);p.tableParams.getData(p.tableParams)};var y=false;var N=function(){p.tableParams=p.tableParams||new o({page:p.argument._page,count:p.argument._count},{counts:[],groupBy:function(e){return null},total:0,getData:function(e,t){p.argument._page=angular.copy(t.page());s.list.servicedesks.page(angular.copy(t.page()));T();t.total(s.list.servicedesks.total());e.resolve(p.datas)}})};p.sorting=function(e){var t=p.tableParams.isSortBy(e.field,"desc");if(t){p.argument._asc=e.field;p.argument._desc=""}else{p.argument._desc=e.field;p.argument._asc=""}e.sortable?p.tableParams.sorting(e.field,p.tableParams.isSortBy(e.field,"desc")?"asc":"desc"):""};var S=function(e){var t=s.detail.shortcuts.get(s.list.shortcuts.get(1,parseInt(e)));if(angular.isDefined(t)){p.listName=t.typeKey;p.typeKey=t.typeKey;p.argument._page=s.list.servicedesks.page();p.tableParams.page(p.argument._page)}};var C=function(){v();m();N();S(s.config.route.get("quickentry.selectedId"))};C();p.remove=function(e){_hmt.push(["_trackEvent","客服组","删除客服组"]);if(confirm("您确定删除"+e.name+"吗?")){_hmt.push(["_trackEvent","客服组-删除客服组","确认"]);d.run("delete",c.constant.EVENT_DETAIL_SERVICEDESKS,{id:"@id"},{id:e.id},function(e){if(e.status!=0){if(e.result&&e.result.error==="servicedesk_has_ralation"){f.add("不可删除客服组"+serviceDesk.name+"，请先移除组内的成员和渠道","danger")}else if(e.result&&e.result.error&&e.result.error_description){f.add("删除失败！<br/>"+e.result.error_description,"danger")}else{f.add("删除失败！","danger")}}else{f.add("删除成功！","success");p.tableParams.reload();t.$broadcast("quickentry-force-reload")}})}else{_hmt.push(["_trackEvent","客服组-删除客服组","取消"])}};p.edit=function(e,t){if(t=="add"){_hmt.push(["_trackEvent","快捷入口/客服组","新增客服组"])}else{_hmt.push(["_trackEvent","快捷入口/客服组","编辑客服组"])}i.go("system_setting.service_desks_edit",{id:e,type:t})};p.userGroupsBuried=function(){_hmt.push(["_trackEvent","快捷入口/客服组","点击客服组列表"])};e.$on("$destroy",E)}})(angular);(function(D){"use strict";D.module("eweiApp.quickEntry").controller("quickEntryChatQueueController",e).controller("quickEntryWaitChatQueueController",t).controller("quickEntryEndChatQueueController",i);e.$inject=["$scope","NgTableParams","chatQueueSetUp","chatQueueSetUpDefault","chatQueueService","chatColunmSetUpId","$state","$stateParams","alertService","ConsoleConfig","permissions","forceJoinChatService","coreNotifyService","coreModelService","closeChatService"];function e(i,e,n,o,t,a,r,s,c,l,u,d,f,p,g){i.chat={};i.chatHeader=o;i.chatList=[];i.showSetUp=false;var m=this.__proto__.constructor.name+"_"+(new Date).valueOf();var _="";i.params={_page:0,_currentPage:0};var h=D.copy(i.params);i.setRows=function(e){v=true;var t=i.tableParams.count();if(e==t)return;i.tableParams.count(e);i.params._page=e;i.tableParams.getData(i.tableParams)};var v=false;function E(){i.tableParams=i.tableParams||new e({page:1,count:i.params._page},{total:0,counts:[],getData:function(e,t){i.params._currentPage=D.copy(t.page());p.list.chats.chatting.page(D.copy(t.page()));S(i.params._currentPage);t.total(p.list.chats.chatting.total());if(!v)return;if(h._currentPage!=i.params._currentPage||h._page!=i.params._page){T(i.params._currentPage);h=D.copy(i.params)}e.resolve(i.chatList)}})}i.searchChatList=function(){T(1)};i.hoverFun=function(e){i.hoverEffect=e};function T(e){f.doNotify(f.constant.EVENT_LIST_DATA_LOADING,{typeKey:"chat_open",isLoading:true});t({pageNo:e,pageSize:i.params._page,searchKey:i.searchKey},"",f.constant.EVENT_LIST_CHAT_CHATTING,function(e){f.doNotify(f.constant.EVENT_LIST_DATA_LOADING,{typeKey:"chat_open",isLoading:false});f.doNotify(f.constant.EVENT_LIST_SHORTCUT_UPDATE,{typeKey:"chat_new",count:p.list.chats.waitting.total()});f.doNotify(f.constant.EVENT_LIST_SHORTCUT_UPDATE,{typeKey:"chat_open",count:p.list.chats.chatting.total()});f.doNotify(f.constant.EVENT_LIST_SHORTCUT_UPDATE,{typeKey:"chat_closed",count:p.list.chats.closed.total()})})}function y(e){if(D.isUndefined(e)){e=0}var t=p.detail.shortcuts.get(parseInt(e));if(D.isDefined(t)){i.params._currentPage=p.list.chats.chatting.page();void 0;i.tableParams.page(i.params._currentPage)}}function N(){n.getChatOption(function(e){i.chatHeader=D.copy(o);_=D.copy(o)})}function S(e){i.chatList=p.detail.chats.chatting.gets(p.list.chats.chatting.gets(e))}function C(){f.register(m,f.constant.EVENT_LIST_CHAT_CHATTING,function(e,t){i.tableParams.reload()})}function w(){f.unRegister(m)}i.$on("$destroy",function(){w()});function P(){C();E();y(p.config.route.get("quickentry.selectedId"));N()}P();i.chat.selectColumn=function(e){if(i.chatHeader[e].active){i.chatHeader[e].active=false}else{i.chatHeader[e].active=true}};i.chat.setUp=function(){i.showSetUp=true};i.chat.sureSetUp=function(){var e="";for(var t=0;t<i.chatHeader.length;t++){if(typeof i.chatHeader[t].active!="undefined"&&i.chatHeader[t].active){e+=i.chatHeader[t].field+","}}e=e.substring(0,e.length-1);n.saveChatOption(e,function(e){if(e.status==0){i.showSetUp=false;a.setChatID(e.result.id);_=D.copy(o);N()}else{c.add("保存失败","danger")}})};i.chat.cancelSetUp=function(){i.showSetUp=false;N()};i._gotoChatCenter=function(t,e,i){if(i.clientType=="USB_PHONE"){c.add("语音会话暂不支持加入","danger");return false}var n;if(e){n=e.id}if(n==l.engineer.id){r.go("webchats_new.detail",{id:t},{reload:"webchats_new.detail"})}else if(u.hasPermission("ticket_force_join_chat")){d(t).then(function(e){if(e.success){r.go("webchats_new.detail",{id:t},{reload:"webchats_new.detail"})}else{if(e.message!=null){c.add($filter("translate")(e.message),"danger")}else{c.add("失败","danger")}}})}else{c.add("对不起，您没有权限加入此会话","danger")}}}t.$inject=["$scope","NgTableParams","waitChatQueueSetUpDefault","waitChatQueueService","waitChatQueueSetUp","license","chatColunmSetUpId","alertService","$rootScope","waitChatHandleService","$http","permissions","$modal_","$filter","getCustomerServiceList","ConsoleConfig","$window","coreNotifyService","coreModelService","$state","providerJudgement"];function t(r,e,i,t,n,o,a,s,c,l,u,d,f,p,g,m,_,h,v,E,T){r.licenseService=o;r.waitChat={};r.waitChatHeader=i;r.waitChatList=[];var y=this.__proto__.constructor.name+"_"+(new Date).valueOf();var N="";r.params={_page:0,_currentPage:0};r.serviceProvider=m.providerHelpCenterUrl;var S=D.copy(r.params);r.setRows=function(e){C=true;var t=r.tableParams.count();if(e==t)return;r.tableParams.count(e);r.params._page=e;r.tableParams.getData(r.tableParams)};var C=false;function w(){r.tableParams=r.tableParams||new e({page:1,count:r.params._page},{total:0,counts:[],getData:function(e,t){r.params._currentPage=D.copy(t.page());v.list.chats.waitting.page(D.copy(t.page()));A(r.params._currentPage);t.total(v.list.chats.waitting.total());if(!C)return;if(S._currentPage!=r.params._currentPage||S._page!=r.params._page){P(r.params._currentPage);S=D.copy(r.params)}e.resolve(r.waitChatList)}})}r.searchChatList=function(){P(1)};r.hoverFun=function(e){r.hoverEffect=e};function P(e){h.doNotify(h.constant.EVENT_LIST_DATA_LOADING,{typeKey:"chat_new",isLoading:true});t({pageNo:e,pageSize:r.params._page,searchKey:r.searchKey},"",h.constant.EVENT_LIST_CHAT_WAITTING,function(e){h.doNotify(h.constant.EVENT_LIST_DATA_LOADING,{typeKey:"chat_new",isLoading:false});h.doNotify(h.constant.EVENT_LIST_SHORTCUT_UPDATE,{typeKey:"chat_new",count:v.list.chats.waitting.total()});if(v.list.chats.waitting.total()>0){h.doNotify(h.constant.EVENT_OTHER_CHAT_RED_POINT,true)}else{h.doNotify(h.constant.EVENT_OTHER_CHAT_RED_POINT,false)}h.doNotify(h.constant.EVENT_LIST_SHORTCUT_UPDATE,{typeKey:"chat_open",count:v.list.chats.chatting.total()});h.doNotify(h.constant.EVENT_LIST_SHORTCUT_UPDATE,{typeKey:"chat_closed",count:v.list.chats.closed.total()})})}function k(e){if(D.isUndefined(e)){e=0}var t=v.detail.shortcuts.get(parseInt(e));if(D.isDefined(t)){r.params._currentPage=v.list.chats.waitting.page();r.tableParams.page(r.params._currentPage)}}function I(){n.getWaitChatOption(function(e){r.waitChatHeader=D.copy(i);N=D.copy(i)})}function A(e){r.waitChatList=v.detail.chats.waitting.gets(v.list.chats.waitting.gets(e))}function L(){h.register(y,h.constant.EVENT_LIST_CHAT_WAITTING,function(e,t){if(t){P(r.params._currentPage)}else{r.tableParams.reload();if(r.waitChatList&&r.waitChatList.length==0&&r.params._currentPage>1){r.$evalAsync(function(){void 0;r.params._currentPage=r.params._currentPage-1;if(r.params._currentPage<1){r.params._currentPage=1}r.tableParams.page(r.params._currentPage);r.tableParams.getData(r.tableParams)})}}})}function b(){h.unRegister(y)}r.$on("$destroy",function(){b()});function $(){L();w();k(v.config.route.get("quickentry.selectedId"));I()}$();r.showSetUp=false;r.waitChat.selectColumn=function(e){if(r.waitChatHeader[e].active){r.waitChatHeader[e].active=false}else{r.waitChatHeader[e].active=true}};r.waitChat.setUp=function(){r.showSetUp=true};r.waitChat.sureSetUp=function(){var e="";for(var t=0;t<r.waitChatHeader.length;t++){if(typeof r.waitChatHeader[t].active!="undefined"&&r.waitChatHeader[t].active){e+=r.waitChatHeader[t].field+","}}e=e.substring(0,e.length-1);void 0;n.saveWaitChatOption(e,function(e){if(e.status==0){r.showSetUp=false;a.setWaitChatID(e.result.id);N=D.copy(i);I()}else{s.add("保存失败","danger")}})};r.waitChat.cancelSetUp=function(){r.showSetUp=false;I()};r.myselfHandleWaitingSession=function(t){if(!T.isTrue()){return false}var e=r;var i;r.disabledVal=false;r.hideMyselfHandleModal=function(){i.$promise.then(i.hide)};e._messages="您确定要接通该会话，自己处理吗？";i=f({scope:e,title:"接通确认",contentTemplate:"source/views/alter_common.html",html:true,show:true,placement:"center"});e.$ok=function(){if(!T.isTrue()){return false}l.myselfHandleWaitingSession(t).then(function(e){if(e.success){h.doNotify(h.constant.EVENT_LIST_CHAT_WAITTING,true);h.doNotify(h.constant.EVENT_LIST_CHAT_CHATTING,true);E.go("webchats_new.detail",{id:t},{reload:"webchats_new.detail"})}else if(e.message!=null){if(e.message=="license_limit"){s.add("很抱歉，你今日的工单数量已经达到上限，暂时无法接通会话。","danger")}else{s.add(p("translate")(e.message),"danger");h.doNotify(h.constant.EVENT_LIST_CHAT_WAITTING,true)}}else{s.add("失败","danger")}});r.hideMyselfHandleModal()}};r.selectEngineerHandleWaitingSession=function(e){if(!d.hasPermission("ticket_chat_assign")){s.add("您没有权限分派会话","danger");return false}if(!T.isTrue()){return false}var t=r;var i;var a="";r.setwaitingEngineer=function(e){if(e){i=e.userId}};r.sendChatRequest=function(){r.disabledVal=true;if(typeof i=="undefined"){s.add("请选择一个客服分派","danger");r.disabledVal=false;return false}l.sendChatRequest(e,i).then(function(e){if(e.success){h.doNotify(h.constant.EVENT_LIST_CHAT_WAITTING,true);s.add(p("translate")("ASSIGN_WAITINGCHAT_SUCC"))}else if(e.message=="license_limit"){s.add("很抱歉，你今日的工单数量已经达到上限，暂时无法接通会话。","danger")}else{s.add(p("translate")(e.message),"danger");h.doNotify(h.constant.EVENT_LIST_CHAT_WAITTING,true)}r.disabledVal=false});r.hideSelectEngineerModal()};var n=function(e){var t=new Array;function i(e,t){for(var i=0,n=e.length;i<n;i++){if(e[i].id==t){return true}}return false}for(var n=0,o=e.length;n<o;n++){var a=e[n];if(!i(t,a.servicedeskId)){var r={id:a.servicedeskId,name:a.servicedeskName,engineers:[]};t.push(r)}}for(var n=0,o=t.length;n<o;n++){for(var s=0,c=e.length;s<c;s++){var a=e[s];if(a.webSessionId==undefined||a.webSessionId==""){continue}if(t[n].id==a.servicedeskId){var l={id:a.engineerId,name:a.userName,userId:a.userId,chatCount:a.chatCount};t[n].engineers.push(l)}}}return t};var o;r.hideSelectEngineerModal=function(){o.$promise.then(o.hide)};o=f({scope:t,title:"选择客服人员",contentTemplate:"source/dashboard/select__engineers_single.html",html:true,show:true,placement:"top"});r.loadtime=0;r.loadEngineers=function(){var e=(new Date).getTime();if(r.loadtime!=0&&e-r.loadtime<1500){return}r.loadtime=e;r.onlineCount=0;g().then(function(e){r.selectServiceDesks=n(e.json);a=r.selectServiceDesks})};r.loadEngineers();r.searchCustomer=function(){void 0;var e=new RegExp(transferConversation.searchCustomerCond.value);var t=a;var i=[];if(transferConversation.searchCustomerCond.value==""){r.selectServiceDesks=a}else{for(var n in t){i[n]=[];i[n].engineers=[];for(var o in t[n].engineers){if(e.test(t[n].engineers[o].name)){i[n].id=t[n].id;i[n].name=t[n].name;i[n].engineers.push(t[n].engineers[o])}}}r.selectServiceDesks=i}}};r.downloadApplication=function(){if(m.enviroment=="Production"){_.open("http://ewei-app-saas.ewei.com/Helpdesk.exe")}else if(m.enviroment=="Test"){_.open("http://apptest.cdn.ewei.com/Helpdesk.exe")}else{_.open("http://apptest.cdn.ewei.com/Helpdesk.exe")}};r.permissionValue=d.hasPermission("ticket_setting_via")}i.$inject=["$scope","NgTableParams","endChatQueueSetUpDefault","endChatQueueService","ConsoleConfig","coreNotifyService","coreModelService","apiTicketEvaluateConfigService","apiTicketStatusColorService"];function i(i,e,t,n,o,a,r,s,c){i.endChat={};i.endChatHeader=t;i.endChatList=[];var l=[];var u=this.__proto__.constructor.name+"_"+(new Date).valueOf();i.params={_page:0,_currentPage:0};var d=D.copy(i.params);i.setRows=function(e){f=true;var t=i.tableParams.count();if(e==t)return;i.tableParams.count(e);i.params._page=e;i.tableParams.getData(i.tableParams)};var f=false;function p(){i.tableParams=i.tableParams||new e({page:1,count:i.params._page},{total:0,counts:[],getData:function(e,t){i.params._currentPage=D.copy(t.page());r.list.chats.closed.page(D.copy(t.page()));void 0;m(i.params._currentPage);t.total(r.list.chats.closed.total());if(!f)return;if(d._currentPage!=i.params._currentPage||d._page!=i.params._page){_(i.params._currentPage);d=D.copy(i.params)}e.resolve(i.endChatList)}})}i.searchChatList=function(){_(1)};function g(e){if(D.isUndefined(e)){e=0}var t=r.detail.shortcuts.get(parseInt(e));if(D.isDefined(t)){i.params._currentPage=r.list.chats.closed.page();void 0;i.tableParams.page(i.params._currentPage)}s.run()}function m(e){i.endChatList=r.detail.chats.closed.gets(r.list.chats.closed.gets(e));if(i.endChatList.length>0){h();T()}}function _(t){a.doNotify(a.constant.EVENT_LIST_DATA_LOADING,{typeKey:"chat_closed",isLoading:true});n({pageNo:t,pageSize:i.params._page,searchKey:i.searchKey},"",a.constant.EVENT_LIST_CHAT_ClOSED,function(e){a.doNotify(a.constant.EVENT_LIST_DATA_LOADING,{typeKey:"chat_closed",isLoading:false});l=v(r.detail.chats.closed.gets(r.list.chats.closed.gets(t)));E(l,t);a.doNotify(a.constant.EVENT_LIST_SHORTCUT_UPDATE,{typeKey:"chat_new",count:r.list.chats.waitting.total()});a.doNotify(a.constant.EVENT_LIST_SHORTCUT_UPDATE,{typeKey:"chat_open",count:r.list.chats.chatting.total()});a.doNotify(a.constant.EVENT_LIST_SHORTCUT_UPDATE,{typeKey:"chat_closed",count:r.list.chats.closed.total()})})}function h(){var e=r.config.evaluate;var t=i.endChatList;D.forEach(t,function(t){D.forEach(e.firstQuestionOptions,function(e){if(e.value==String(t.ticket_evaluate_solved)){t.ticket_evaluate_solved=e.name}});D.forEach(e.secondQuestionOptions,function(e){if(e.value==t.ticket_evaluate_score){t.ticket_evaluate_score=e.name}})});void 0}function v(e){var t=[];D.forEach(e,function(e){if(D.isDefined(e.ticket_id)){t.push(e.ticket_id)}});return t}function E(e,t){if(e&&e.length>0){c.run("",a.constant.EVENT_LIST_TICKET_STATUSCOLORS,t,"",{ticketIds:e.join(",")},function(e){if(e){}})}}function T(){var e=r.list.statuscolors.gets(i.params._currentPage);var t={};D.forEach(e,function(e){t[e]=r.detail.statuscolors.get(e)});i.ticketStatusColors=t}function y(){a.register(u,a.constant.EVENT_LIST_CHAT_ClOSED,function(e,t){i.tableParams.reload()});a.register(u,a.constant.EVENT_LIST_TICKET_STATUSCOLORS,function(e){T()})}function N(){a.unRegister(u)}i.$on("$destroy",function(){N()});function S(){y();p();g(r.config.route.get("quickentry.selectedId"))}S()}})(angular);(function(e){"use strict";e.module("eweiApp.remoteControlWidget").directive("remoteControlTip",t).controller("tipController",i);t.$inject=[];function t(){return{restrict:"EA",replace:true,scope:{showInstall:"="},template:'<div class="tipLayer" ng-show="showInstall">'+'未检测到远程协助组件，请<a class="href" ng-click="vm.downloadApp()" style="margin-left:0px;">下载</a>安装'+'<a class="href" ng-click="vm.close()" style="margin-left:20px;">关闭</a>'+"</div>",controller:i,controllerAs:"vm",link:function(e,t,i){t.on("click",function(e){e.stopPropagation()})}}}i.$inject=["$scope","$rootScope","$window"];function i(e,t,i){var n=this;n.downloadApp=function(){i.open(t.applicationUrl)};e.$on("plugInstalled",function(){e.showInstall=false});n.close=function(){e.showInstall=false}}})(angular);(function(e,t){"use strict";function E(e){var t=this;var i=0;var n=[];t.status="normal";function o(){for(var e in n){if(n.hasOwnProperty(e)){clearTimeout(n[e])}}}t.getTxt=function(){return e[i]?e[i]:"未配置的错误提示"};t.doing=function(e){if(t.status=="success")return;t.status="doing";i=0;n.push(setTimeout(function(){if(typeof e==="function"){e();void 0}},30*1e3))};t.success=function(){t.status="success";i=0;o()};t.failed=function(e){t.status="failed";i=e;o()};t.normal=function(){t.status="normal";i=0};t.getStatus=function(){return t.status}}e.module("eweiApp.remoteControlWidget").directive("remoteControlCode",n).directive("checkState",i).controller("codeController",o);i.$inject=[];function i(){return{restrict:"E",replace:true,scope:{subject:"="},template:"",link:function(e,t,i){var n={normal:"&#xe70e;",doing:"&#xe70e;",success:"&#xe710;",failed:"&#xe711;"};var o={normal:"normal",doing:"doing",success:"success",failed:"failed"};e.$watch("subject.status",function(){t.html('<div class="status '+o[e.subject.status]+'"><i class="iconfont">'+n[e.subject.status]+"</i>"+e.subject.getTxt()+"</div>")})}}}n.$inject=[];function n(){return{restrict:"EA",replace:true,scope:{},templateUrl:"/source/remote_control_widget/templates/code.html",controller:o,controllerAs:"vm",link:function(e,t,i){}}}o.$inject=["$timeout","$scope","coreNotifyService","apiCheckCodeService","$window","$rootScope","ConsoleConfig"];function o(e,t,i,n,o,a,r){var s=this;var c=s.__proto__.constructor.name+"_"+Date.now();var l=[];s.showInfo=true;s.showCheck=false;s.connecting=false;s.code="";s.startDesk=1;s.startVideo=0;s.checkCode=new E({0:"校验共享码",1:"无法访问服务器，请检查网络",2:"错误的共享码，请与对方确认后重新输入",3:"错误的共享码",4:"请输入共享码"});s.checkClient=new E({0:"等待对端响应",1:"对端无响应，请检查后再试"});s.checkP2p=new E({0:"建立P2P通道",1:"不能建立P2P隧道，请检查双方网络后重试"});s.checkChat=new E({0:"建立会话",1:"会话建立失败，请检查后再试"});var u={info:function(){s.showInfo=true;s.showCheck=false;d()},check:function(){s.showInfo=false;s.showCheck=true;d()}};s.downloadApp=function(){var e=null;if(r.enviroment=="Production"){e="http://ewei-app-saas.ewei.com/Helpdesk.exe"}else{e="http://apptest.cdn.ewei.com/Helpdesk.exe"}o.open(e)};s.startRemoteType=function(e){if(s.connecting)return;if(e=="desk"){s.startVideo=0;if(s.startDesk==1){s.startDesk=0}else{s.startDesk=1}}if(e=="video"){s.startDesk=0;if(s.startVideo==1){s.startVideo=0}else{s.startVideo=1}}d()};s.connect=function(){u["check"]();s.connecting=true;p()};function d(){s.checkCode.normal();s.checkClient.normal();s.checkP2p.normal();s.checkChat.normal();f()}function f(){for(var e in l){if(l.hasOwnProperty(e)){clearTimeout(l[e])}}}function p(){s.checkCode.doing(function(){s.connecting=false;s.checkCode.failed(1)});if(s.code.replace(/(^\s*)|(\s*$)/g,"").length==0){l.push(e(function(){s.checkCode.failed(4);s.connecting=false},500))}else if(/^\d{4}$|^\d{6}$/.test(s.code)==false){l.push(e(function(){s.checkCode.failed(3);s.connecting=false},500))}else{n.run("",{sharedCode:s.code,startRemotedesk:s.startDesk,startVideo:s.startVideo,userId:""},function(e){if(e.status==0){s.checkCode.success();if(s.startDesk||s.startVideo){s.checkClient.doing(function(){s.checkClient.failed(1);s.connecting=false})}else{s.checkChat.doing(function(){s.checkChat.failed(1);s.connecting=false})}}else{s.checkCode.failed(2);s.connecting=false}},function(){s.checkCode.failed(1);s.connecting=false})}}function g(){if(s.startDesk||s.startVideo){return s.checkCode.getStatus()=="success"&&s.checkClient.getStatus()=="success"&&s.checkP2p.getStatus()=="success"&&s.checkChat.getStatus()=="success"}else{return s.checkCode.getStatus()=="success"&&s.checkChat.getStatus()=="success"}}function m(){u["info"]();i.doNotify(i.constant.EVENT_WIDGET_REMOTE_HIDE)}function _(){i.register(c,i.constant.EVENT_WIDGET_REMOTE_STATUS,function(e,t){if(t&&"success"===s.checkCode.getStatus()){do{if(t.clientStatus=="success"){s.checkClient.success();s.checkP2p.doing(function(){s.checkP2p.failed(1);s.connecting=false})}else if(t.clientStatus=="failed"){s.checkClient.failed(2);s.connecting=false}if(t.p2pStatus=="success"){s.checkP2p.success();if(g()){m()}else{s.checkChat.doing(function(){s.checkChat.failed(1);s.connecting=false})}}else if(t.p2pStatus=="failed"&&s.checkP2p.status!="success"){s.checkP2p.failed(1);s.connecting=false}if(t.chatStatus=="success"){s.checkChat.success();s.connecting=false;if(g()){m()}}else if(t.chatStatus=="failed"){s.checkChat.failed(2);s.connecting=false}}while(0)}})}function h(){i.unRegister(c);f()}t.$on("$destory",h);function v(){_()}v()}})(angular,org.ewei);(function(e){"use strict";e.module("eweiApp.remoteControlWidget").directive("remoteControlIcon",t).directive("remoteControlWidget",n).controller("iconController",i).controller("widgetController",r);t.$inject=[];function t(){return{restrict:"EA",replace:true,scope:{},template:'<a class="notify message-icon" title="远程协助" ng-click="vm.togglePanel()"><span class="bell"><i id="remote-control-icon" class="iconfont">&#xe685;</i></span></a>',controller:i,controllerAs:"vm",link:function(e,t,i){}}}i.$inject=["$rootScope"];function i(e){var t=this;var i=t.__proto__.constructor.name+"_"+Date.now();t.togglePanel=function(){e.$broadcast("toggle-global-panel",{name:"remote-panel"})};t.showPanel=function(){e.$broadcast("active-global-panel",{name:"remote-panel"})};t.hidePanel=function(){e.$broadcast("deactive-global-panel",{name:"remote-panel"})}}n.$inject=["$timeout","$document","commonTools","coreNotifyService"];function n(e,o,t,a){return{restrict:"EA",replace:true,scope:{},templateUrl:"/source/remote_control_widget/templates/remote_control_widget.html",controller:r,controllerAs:"vm",link:function(e,i,t){var n=function(e){var t=i.find(e.target).length>0||e.target.id=="remote-control-icon";if(!t){a.doNotify(a.constant.EVENT_WIDGET_REMOTE_HIDE)}};o.on("click",n);e.$on("$destory",function(){o.off("click",n)})}}}r.$inject=["$timeout","$scope","$rootScope","coreNotifyService"];function r(e,t,n,i){var o=this;var a=o.__proto__.constructor.name+"_"+Date.now();var r="remote-panel";var s=[];o.panelActived=false;o.showWithTab=true;o.showCode=true;o.showContact=false;o.showRecentContact=false;o.showInvite=false;o.showInviteBefore=false;o.showInstallApp=false;var c={code:function(){o.showWithTab=true;o.showCode=true;o.showContact=false;o.showRecentContact=false;o.showInvite=false;o.showInviteBefore=false},contact:function(){o.showWithTab=true;o.showCode=false;o.showContact=true;o.showRecentContact=false;o.showInvite=false;o.showInviteBefore=false},rectentContact:function(){o.showWithTab=true;o.showCode=false;o.showContact=false;o.showRecentContact=true;o.showInvite=false;o.showInviteBefore=false},inviteBefore:function(){o.showWithTab=true;o.showCode=false;o.showContact=false;o.showRecentContact=false;o.showInvite=false;o.showInviteBefore=true},invite:function(){o.showWithTab=false;o.showCode=false;o.showContact=false;o.showRecentContact=false;o.showInvite=true;o.showInviteBefore=false}};t.$on("active-global-panel",function(e,t){o.panelActived=t.name===r});t.$on("deactive-global-panel",function(e,t){if(t.name===r){o.panelActived=false}});t.$on("toggle-global-panel",function(e,t){if(t.name===r){n.isInstallApplication?o.showInstallApp=false:o.showInstallApp=true;if(!o.showInstallApp){var i={name:r};if(!o.panelActived){n.$broadcast("active-global-panel",i)}else{n.$broadcast("deactive-global-panel",i)}}}});t.$on("$destory",function(){l()});function l(){for(var e in s){if(s.hasOwnProperty(e)){clearTimeout(s[e])}}}i.register(a,i.constant.EVENT_WIDGET_REMOTE_HIDE,function(e,t){o.panelActived=false})}})(angular);!function(c){c.module("eweiApp.common").directive("contactMainPanel",e).controller("contactMainPanelController",t);e.$inject=["$timeout","eweiPhoneService","$window"];function e(r,e,s){return{restrict:"EA",replace:true,templateUrl:"/source/ewei-phone/template/contact-main-panel.html",controller:t,controllerAs:"vm",compile:function e(t,i,n){return{post:function(a,e,t){var i=c.element(".list-panel");i.on("scroll",function(){var e=c.element(".list-contacts",i);if(e.height()-i.height()==i.scrollTop()){r(function(){a.vm.getMoreContacts()},100)}});a.$on("reload-searchContacts",function(e){i.scrollTop(0)});var n=c.element(s);var o=c.element(".onlyyou");o.on("click",".mounted-contacts",function(){var e=c.element(".mounted-contacts");for(var t=0;t<e.length;t++){e.eq(t).removeClass("li-actived-contacts")}c.element(this).addClass("li-actived-contacts")});void 0;n.on("keydown",function(e){var t=c.element(".mounted-contacts");var i=0;var n=true;for(var o=0;o<t.length;o++){if(t.eq(o).hasClass("li-actived-contacts")){i=o;n=false}}void 0;if(e.keyCode==13){if(!n){a.vm.choseTelNum(t.eq(i).attr("name"))}}else if(e.keyCode==40){if(n){t.eq(i).addClass("li-actived-contacts")}else if(i+1<t.length){t.eq(i).removeClass("li-actived-contacts");t.eq(++i).addClass("li-actived-contacts")}else{a.vm.getMoreRecords()}}else if(e.keyCode==38){if(i-1>=0){t.eq(i).removeClass("li-actived-contacts");t.eq(--i).addClass("li-actived-contacts")}}});a.$on("$destroy",function(){o.off("click");n.off("keydown")})}}}}}t.$inject=["coreNotifyService","$scope","$timeout","filterContactsService","coreModelService","apiCtiContactListService","telNumService"];function t(t,e,i,n,o,a,r){var s=this;var c=s.__proto__.constructor.name+"_"+(new Date).valueOf();s.searchContacts=function(){a.run(t.constant.EVENT_PHONE_DATA_CONTACTS,s.params.contacts._page,{page:{pageNumber:s.params.contacts._page,pageSize:10},key:s.telNum,phoneNotNull:true},function(){void 0})};var l=null;s.saveTelNumByKeyboard=function(){s.params.contacts={_page:1};i.cancel(l);l=i(function(){e.$emit("reload-searchContacts");s.searchContacts()},500)};s.getMoreContacts=function(){if(s.params.contacts._page*10>=o.list.contacts.total()){s.nomoreContacts=true;void 0;return}else{s.params.contacts._page+=1;s.searchContacts()}};s.backToDialPanel=function(e){r.setTelNum(e);t.doNotify(t.constant.EVENT_CONTACT_TITLE,{contactTitle:false});t.doNotify(t.constant.EVENT_CONTACT_MAIN_PANEL,{contactMainPanel:false})};s.filterTelNum=function(e){if(s.telNum){return e.contact.phone&&e.contact.phone.indexOf(s.telNum)>-1||e.contact.name&&e.contact.name.indexOf(s.telNum)>-1||e.contact.mobilePhone&&e.contact.mobilePhone.indexOf(s.telNum)>-1}return true};function u(){t.register(c,t.constant.EVENT_PHONE_DATA_CONTACTS,function(e,t){s.nomoreContacts=false;s.hasload=true;if(s.params.contacts._page==1){s.contactsListData=n.filterContactsData(o.detail.contacts.gets(o.list.contacts.gets(s.params.contacts._page)))}else if(s.params.contacts._page>1){Array.prototype.push.apply(s.contactsListData,n.filterContactsData(o.detail.contacts.gets(o.list.contacts.gets(s.params.contacts._page))));if(o.list.contacts.total()<s.params.contacts._page*10){s.nomoreContacts=true}}else{s.nomoreContacts=true}void 0})}function d(){t.unRegister(c)}e.$on("$destroy",function(){i.cancel(l);d()});function f(){u();p()}function p(){s.params={};s.params.contacts={_page:1};s.contactsListData=n.filterContactsData(o.detail.contacts.gets(o.list.contacts.gets(s.params.contacts._page)));s.searchContacts()}f()}}(angular);!function(e){e.module("eweiApp.common").directive("contractRecord",t).controller("contractRecordController",i);t.$inject=[];function t(){return{restrict:"EA",replace:true,templateUrl:"/source/ewei-phone/template/contact-record.html",controller:i,controllerAs:"vm"}}i.$inject=["coreNotifyService","$scope","$timeout"];function i(e,t,i){var n=this;var o=n.__proto__.constructor.name+"_"+(new Date).valueOf();n.backToDialPanel=function(){e.doNotify(e.constant.EVENT_CONTACT_TITLE,{contactTitle:false});e.doNotify(e.constant.EVENT_CONTACT_MAIN_PANEL,{contactMainPanel:false})};function a(){}function r(){}t.$on("$destroy",function(){r()});function s(){a()}s()}}(angular);(function(e){e.module("eweiApp.common").factory("eweiPhoneService",t).factory("createSessionFailService",i).factory("createSessionService",n).factory("resetIndexService",o).factory("judgeDisabledService",a).factory("addCallRecordService",r).factory("filterContactsService",s).factory("telNumService",c).factory("mutilListService",l).factory("closeSelfChatService",u).factory("searchChatDetailService",d);t.$inject=["coreModelService","$http","ConsoleConfig","telNumService"];function t(e,n,o,t){var i=null;var a=null;var r=null;var s=null;var c=null;var l=null;var u=null;var d=null;var f=null;var p=null;var g=null;var m=null;var _=null;var h=null;var v=null;return{setActiveCtiID:function(e){i=e},getActiveCtiID:function(){return i},setSipPhoneConfig:function(e){a=e},getSipPhoneConfig:function(){return a},setCtiChatId:function(e){r=e},getCtiChatId:function(){return r},setHostTelNum:function(e){s=e},getHostTelNum:function(){return s},setHeld:function(e){c=e},getHeld:function(){return c},setUser:function(e){l=e},getUser:function(){return l},closeChatFn:function(e,t,i){n({url:"close_chat/"+e+".json",method:"GET",params:{quitUserId:o.user.id,closeAction:t}}).success(function(e){i(e)})},setStatus:function(e){u=e},getStatus:function(){return u},reverseStatus:function(e){if(u&&e&&typeof e==="function"){e(u)}},setCallIdentity:function(e){d=e},getCallIdentity:function(){return d},setTransferStatus:function(e){v=e},getTransferStatus:function(){return v},setHangupNum:function(e){p=e},getHangupNum:function(){return p},backKeyboardFn:function(){var e=this.getDialPanelNum();if(e){if(e!=""){e=e.substring(0,e.length-1)}}else{e=""}this.setDialPanelNum(e)},setDialPanelNum:function(e){f=e},getDialPanelNum:function(){return f},setUboxFlag:function(e){g=e},getUboxFlag:function(){return g},setMouseIndex:function(e){m=e},getMouseIndex:function(){return m},setLastPhoneState:function(e){_=e},getLastPhoneState:function(){return _},numberDeleteZero:function(e){var t=/^((\+?86)|(\(\+86\)))?1\d{10}$/;var i="";var n="";for(var o=0;o<e.length;o++){i+=e[e.length-1-o]}i=i.substring(0,11);for(var o=0;o<i.length;o++){n+=i[i.length-1-o]}if(t.test(n)){return n}else{return e}},setUBoxError:function(e){h=e},getUBoxError:function(){return h}}}i.$inject=["$modal_","alertService","permissions","$state"];function i(o,a,r,s){return{createSessionFail:function(e,t){var i=t;if(e.message=="license_limit"){var n=o({scope:i,title:"提示",contentTemplate:"source/views/fun_restriction_reminder.html",html:true,show:true,placement:"center"});i.hasPermission=true;i.tipNotSupportService="当前服务版本不支持此功能，请升级服务后再试。";i.goAuthorization=function(){void 0;if(r.hasPermission("system_setting_company_account")){s.go("system_setting.detail.provider",{uri:"company_account",settingType:"system"});n.$promise.then(n.hide)}else{i.hasPermission=false;i.tipNotSupportService="很抱歉，你没有访问授权计划的权限"}};i.hideModal_=function(){n.$promise.then(n.hide)}}else{a.add("创建会话失败，请联系客服人员","danger")}}}}n.$inject=["$http","ctiUsbService","telNumService","coreModelService","alertService","eweiPhoneService","recordlogService"];function n(c,e,t,l,u,i,d){return{fn:function(e,o,a){var t="",i=null;var n=l.detail.ctis.get(l.config.activeCtiID);if(n){t=n.name;i=n.uid}var r={requestMode:"",user:{mobilePhone:"",phone:"",id:""},via:{channel:"phone",channelId:l.config.activeCtiID,channelName:t,source:"",channelUid:i},phoneNo:o};var s=/^1[34578]\d{9}$/;if(s.test(o)){r.user.mobilePhone=o}else{r.user.phone=o}r.requestMode=e;d.log("ewei-phone-service.js createSessionService create_phone_chat request telNum:"+o);c({url:"create_phone_chat.json",method:"POST",data:r}).success(function(e,t,i,n){d.log("ewei-phone-service.js createSessionService create_phone_chat response telNum:"+o+" chatId:"+e.json.chatId+" requesterId:"+e.json.requesterId);a(e)}).error(function(e,t,i,n){d.log("ewei-phone-service.js createSessionService create_phone_chat response error telNum:"+o);u.add("创建会话失败，请联系客服人员","danger")})}}}o.$inject=["coreModelService"];function o(i){return{fn:function(){var e=i.detail.ctis.getAll();var t=[];for(item in e){if(typeof e[item]=="object"){t.push(e[item])}}return t}}}a.$inject=["coreModelService","ctiSipService"];function a(n,o){return{fn:function(e,t){var i={line:false,phone:false,voice:false,network:false,senior:false};i.line=true;if(n.detail.ctis.get(n.config.activeCtiID)&&n.detail.ctis.get(n.config.activeCtiID).voiceSystem=="sip"){if(o.getStarted()){i.phone=true;i.voice=true;i.network=true;i.senior=true}}if(t){return i}else{return i[e]}}}}r.$inject=["apiCtiCallRecordService","coreNotifyService","telNumService","coreModelService"];function r(i,n,o,a){return{fn:function(e,t){i.run(n.constant.EVENT_ADD_CALL_RECORD,"",{callMode:e?"call_in":"call_out",phone:o.getTelNum(),status:t?"normal":"missed_call",viaphoneId:a.config.activeCtiID},function(){void 0})}}}s.$inject=[];function s(){return{filterContactsData:function(e){var t=[];for(var i in e){var n=e[i];if(n.phone!=undefined&&n.mobilePhone!=undefined&&n.phone!=""&&n.mobilePhone!=""&&n.name!=undefined&&n.name!=""){t.push({contact:n,type:1})}else if(n.phone!=undefined&&n.phone!=""&&n.name!=undefined&&n.name!=""){t.push({contact:n,type:2})}else if(n.mobilePhone!=undefined&&n.mobilePhone!=""&&n.name!=undefined&&n.name!=""){t.push({contact:n,type:3})}else if(n.sipAccount!=undefined&&n.sipAccount!=""&&n.name!=undefined&&n.name!=""){t.push({contact:n,type:4})}else if(n.contactMobilePhone!=undefined&&n.contactMobilePhone!=""&&n.name!=undefined&&n.name!=""){t.push({contact:n,type:5})}}return t}}}c.$inject=[];function c(){var t=null;return{setTelNum:function(e){t=e.replace(/\s/g,"")},getTelNum:function(){return t}}}l.$inject=[];function l(){var t=[];return{getMutilList:function(){return t},setMutilList:function(e){t=e},clearMutilList:function(){t=[]}}}u.$inject=["apiRestfulService"];function u(a){var e=function(e,t,i,n){var o={url:"api/v1/chat/chats.json",urlParam:e,dataParam:t};a.run(o).get(o.dataParam,function(e){if(typeof n==="function"){n(e)}})};return e}d.$inject=["eweiPhoneService","$http"];function d(e,i){return{fn:function(t){i({url:"chat_detail/"+e.getCtiChatId()+".json",method:"get"}).success(function(e){if(typeof t==="function"){t(e)}})}}}})(angular);(function(e){e.module("eweiApp.common").factory("recordlogService",t);t.$inject=["ConsoleConfig"];function t(t){return{log:function(e){if([8,9134,432,11].indexOf(t.provider.id)>-1){try{org.ewei.sdk.OpenLoggerApi().save({phoneLog:{type:"phone-usb",content:e}}).then(function(e){})}catch(e){void 0}}}}}})(angular);(function(e){e.module("eweiApp.common").controller("saveTicketController",t).directive("saveTicket",i);t.$inject=["$scope","coreNotifyService","ctiSipService","ConsoleConfig","eweiPhoneService","$http","coreModelService"];function t(i,e,t,n,o,a,r){var s=this,c=true;var l=s.__proto__.constructor.name+"_"+(new Date).valueOf();s.backToDial=function(){if(r.detail.ctis.get(r.config.activeCtiID).voiceSystem=="sip"){o.reverseStatus(function(e){t.setUserState(e)})}i.disabled=true;if(c){o.closeChatFn(o.getCtiChatId(),"close_chat",function(e){i.disabled=false})}o.setCtiChatId("");if(i.tipShow){e.doNotify(e.constant.EVENT_CTI_CALLIN,{telNum:i.newNumber})}else{e.doNotify(e.constant.EVENT_MAIN_DIAL_PANEL,{showMainDialPanel:true});e.doNotify(e.constant.EVENT_PHONE_USB_PANEL,{showPhoneUsbCallPanel:false});e.doNotify(e.constant.EVENT_PHONE_SIPCALL_PANEL,{showPhoneSipcallPanel:false});e.doNotify(e.constant.EVENT_PHONE_SIPCALL_RECORD_TICKET_PANEL,{showRecordTicketPanel:false,hideRecordTicketPanel:true})}o.setHostTelNum("")};s.goRecordTicket=function(){e.doNotify(e.constant.EVENT_PHONE_SIPCALL_RECORD_TICKET_PANEL,{showRecordTicketPanel:true,hideRecordTicketPanel:false})};function u(){e.register(l,e.constant.EVENT_USB_DEDICATE_ACTIVE_MODE,function(e,t){s.onTheCall=t.onTheCall});e.register(l,e.constant.EVENT_PHONE_CREATE_TICKET,function(e,t){c=t.noTicket});e.register(l,e.constant.EVENT_UBOX_CALLIN_TIP,function(e,t){i.tipShow=t.tipShow;i.newNumber=t.tel});e.register(l,e.constant.EVENT_UBOX_CLOSE_CALLIN_TIP,function(e,t){i.tipShow=false})}function d(){e.unRegister(l)}i.$on("$destroy",function(){d()});function f(){u()}f()}i.$inject=[];function i(){return{restrict:"EA",replace:true,scope:{},templateUrl:"/source/ewei-phone/template/save-ticket.html",controller:t,controllerAs:"vm"}}})(angular);(function(e){e.module("eweiApp.common").controller("usbCallController",t).directive("usbCall",i);t.$inject=["$timeout","$scope","$http","apiCtiUserByPhoneService","telNumService","coreNotifyService","coreModelService","EweiConfig","createSessionFailService","eweiPhoneService","createSessionService","ctiUsbService","providerJudgement","ConsoleConfig","recordlogService"];function t(e,n,t,i,o,a,r,s,c,l,u,d,f,p,g){var m=this;var _=m.__proto__.constructor.name+"_"+(new Date).valueOf();function h(){a.register(_,a.constant.EVENT_PHONE_USB_CREATE_TICKET,function(e,t){if(l.getUboxFlag()&&l.getUboxFlag()=="callout"){m.showSaveTicket=false;l.setCtiChatId("");u.fn("outgoing",t.telNum,function(e){if(e.success){var t={bucket:s.bucket_name,accesskey:s.access_key,secretkey:s.secret_key};var i={chatId:e.json.chatId,type:"ticket"};l.setCtiChatId(e.json.chatId);d.chatCreated(t,i,eweiCommon.uuid(32,16));m.showSaveTicket=true}else{c.createSessionFail(e,n)}})}});a.register(_,a.constant.EVENT_CTI_HANGUP,function(e,t){a.doNotify(a.constant.EVENT_USB_DEDICATE_ACTIVE_MODE,{onTheCall:false});m.call.status="通话结束"});a.register(_,a.constant.EVENT_UBOX_PHONE_CALL_IN_STATUS,function(e,t){m.call.status=t});a.register(_,a.constant.EVENT_CTI_PICKUP,function(e,t){if(!f.isTrue()){return false}m.call.status="通话建立";m.showSaveTicket=false;var i=l.getCtiChatId();l.setCtiChatId("");g.log("usb-call.js EVENT_CTI_PICKUP telNum:"+t.telNum);l.setUser(null);o.setTelNum(t.telNum);a.doNotify(a.constant.EVENT_PHONE_RESET_USERINFO);if(n.tipShow){a.doNotify(a.constant.EVENT_USB_DEDICATE_ACTIVE_MODE,{onTheCall:true});a.doNotify(a.constant.EVENT_PHONE_CREATE_TICKET,{noTicket:true});l.closeChatFn(i,"close_chat",function(e){});a.doNotify(a.constant.EVENT_UBOX_CLOSE_CALLIN_TIP);a.doNotify(a.constant.EVENT_PHONE_SIPCALL_RECORD_TICKET_PANEL,{showRecordTicketPanel:false,hideRecordTicketPanel:true});g.log("usb-call.js EVENT_CTI_PICKUP tipShow is true")}u.fn("incoming",t.telNum,function(e){if(e.success){var t={bucket:s.bucket_name,accesskey:s.access_key,secretkey:s.secret_key};var i={chatId:e.json.chatId,type:"ticket"};l.setCtiChatId(e.json.chatId);d.chatCreated(t,i,eweiCommon.uuid(32,16));m.showSaveTicket=true}else{c.createSessionFail(e,n)}})});a.register(_,a.constant.EVENT_UBOX_CALLIN_TIP,function(e,t){n.tipShow=t.tipShow;n.newNumber=t.tel});a.register(_,a.constant.EVENT_UBOX_CLOSE_CALLIN_TIP,function(e,t){n.tipShow=false})}function v(){a.unRegister(_)}n.$on("$destroy",function(){v()});function E(){a.doNotify(a.constant.EVENT_USB_DEDICATE_ACTIVE_MODE,{onTheCall:true});m.call={}}function T(){h();E()}T()}i.$inject=[];function i(){return{restrict:"EA",replace:true,scope:{},templateUrl:"/source/ewei-phone/template/usb-call.html",controller:t,controllerAs:"vm"}}})(angular);(function(e){e.module("eweiApp.common").controller("phoneSettingSeniorPanelController",t).directive("phoneSettingSeniorPanel",i);t.$inject=["$scope","eweiPhoneService","ctiSipService","alertService"];function t(e,t,i,n){var o=this;var a=o.__proto__.constructor.name+"_"+(new Date).valueOf();o.checkSTUN=function(){o.STUN=!o.STUN};o.checkTURN=function(){o.TURN=!o.TURN};o.checkICE=function(){o.ICE=!o.ICE};o.refreshSenior=function(){i.setSS(o.STUN+"",o.net_senior_config["SipProfiles/0"].StunServer+"",o.net_senior_config["SipProfiles/0"].StunPort+"",o.net_senior_config["SipProfiles/0"].StunKeepAliveInSecs+"",o.TURN+"",o.net_senior_config["SipProfiles/0"].TurnServer+"",o.net_senior_config["SipProfiles/0"].TurnPort+"",o.net_senior_config["SipProfiles/0"].TurnUsername+"",o.net_senior_config["SipProfiles/0"].TurnPassword+"",o.net_senior_config["SipProfiles/0"].TurnKeepAliveInSecs+"",o.ICE+"");n.add("更新成功");r()};function r(){o.ICE==true?"1":"0";o.net_senior_config["SipProfiles/0"].EnableIce=o.ICE;o.STUN==true?"1":"0";o.net_senior_config["SipProfiles/0"].EnableStun=o.STUN;o.TURN==true?"1":"0";o.net_senior_config["SipProfiles/0"].EnableTurn=o.TURN;t.setSipPhoneConfig(o.net_senior_config)}function s(){}function c(){}e.$on("$destroy",function(){c()});function l(){o.net_senior_config=t.getSipPhoneConfig();if(o.net_senior_config["SipProfiles/0"].EnableIce=="1"){o.ICE=true}else if(o.net_senior_config["SipProfiles/0"].EnableIce=="0"){o.ICE=false}else{o.ICE=true}if(o.net_senior_config["SipProfiles/0"].EnableStun=="1"){o.STUN=true}else if(o.net_senior_config["SipProfiles/0"].EnableStun=="0"){o.STUN=false}else{o.STUN=true}if(o.net_senior_config["SipProfiles/0"].EnableTurn=="1"){o.TURN=true}else if(o.net_senior_config["SipProfiles/0"].EnableTurn=="0"){o.TURN=false}else{o.TURN=true}void 0}function u(){s();l()}u()}i.$inject=[];function i(){return{restrict:"EA",replace:true,scope:{},templateUrl:"/source/ewei-phone/template/phone-setting-senior-panel.html",controller:t,controllerAs:"vm"}}})(angular);(function(u){u.module("eweiApp.common").controller("phoneSettingVoicePanelController",e).directive("phoneSettingVoicePanel",t);e.$inject=["$scope","coreNotifyService","eweiPhoneService","ctiSipService","alertService"];function e(e,t,i,n,o){var a=this;var r=a.__proto__.constructor.name+"_"+(new Date).valueOf();function s(e){var t=210;var i=100;var n="";n=(210*e/100).toFixed(0);return n}function c(e){var t=210;var i=100;var n="";n=(100*e/210).toFixed(0);return n}a.checkMicro=function(e){a.MicroItem=e;a.clicked=false};a.checkSpeaker=function(e){a.speakerItem=e;a.clicked1=false};a.refreshVoice=function(){var e={};e.SpeakerVolume=c(a.temp.SpeakerVolume);e.MicGain=c(a.temp.MicGain);n.setSA(a.MicroItem+"",a.speakerItem+"",e.SpeakerVolume+"",e.MicGain+"");o.add("更新成功");l(e.SpeakerVolume,e.MicGain)};function l(e,t){a.config.AudioSettings.SpeakerVolume=e;a.config.AudioSettings.MicGain=t;a.config.AudioSettings.CallInputDevice=a.MicroItem;a.config.AudioSettings.CallOutputDevice=a.speakerItem;i.setSipPhoneConfig(a.config)}function u(){t.register(r,t.constant.EVENT_CTI_SIP_DL,function(e,t){var i=t.result.split(":");a.Microphone=i[0].split(",");a.speaker=i[1].split(",");void 0;void 0})}function d(){t.unRegister(r)}e.$on("$destroy",function(){d()});function f(){a.temp={};a.config=i.getSipPhoneConfig();a.temp.SpeakerVolume=s(a.config.AudioSettings.SpeakerVolume);a.temp.MicGain=s(a.config.AudioSettings.MicGain);void 0;void 0;a.MicroItem=a.config.AudioSettings.CallInputDevice;a.speakerItem=a.config.AudioSettings.CallOutputDevice}function p(){u();f()}p()}t.$inject=[];function t(){return{restrict:"EA",replace:true,scope:{},templateUrl:"/source/ewei-phone/template/phone-setting-voice-panel.html",controller:e,controllerAs:"vm",compile:function e(t,i,n){return{post:function(t,e,i){var n=u.element(".rang-panel");var o=u.element(".circle-1");var a=u.element(".dx-1");var r=u.element(".circle-2");var s=u.element(".dx-2");var c=210;function l(e,t){var i=e.width();if(i+t.originalEvent.movementX<=0){i=0}else if(i+t.originalEvent.movementX>=c){i=c}else{i+=t.originalEvent.movementX}e.width(i)}o.on("mousedown",function(e){n.on("mousemove",function(e){l(a,e)})});r.on("mousedown",function(e){n.on("mousemove",function(e){l(s,e)})});u.element("body").on("mouseup",function(e){void 0;n.off("mousemove");t.vm.temp.MicGain=a.width();t.vm.temp.SpeakerVolume=s.width()});t.$on("$destroy",function(){u.element("body").off("mouseup")})}}}}}})(angular);(function(e){e.module("eweiApp.common").controller("phoneSettingNetworkPanelController",t).directive("phoneSettingNetworkPanel",i);t.$inject=["$scope","eweiPhoneService","ctiSipService","alertService"];function t(e,t,i,n){var o=this;var a=o.__proto__.constructor.name+"_"+(new Date).valueOf();o.checkMaxConnect=function(){o.Max=!o.Max};o.refreshNetWork=function(){i.setSO(o.net_senior_config["SipProfiles/0"].BindAddress+"",o.Max+"",o.net_senior_config["SipProfiles/0"].MaxConnections+"",o.net_senior_config["SipProfiles/0"].SipPort+"",o.net_senior_config["SipProfiles/0"].RtpPortStart+"");n.add("更新成功");r()};function r(){o.Max==true?"1":"0";o.net_senior_config["SipProfiles/0"].UseSequentialPorts=o.Max;t.setSipPhoneConfig(o.net_senior_config)}function s(){}function c(){}e.$on("$destroy",function(){c()});function l(){o.net_senior_config=t.getSipPhoneConfig();void 0;if(o.net_senior_config["SipProfiles/0"]&&o.net_senior_config["SipProfiles/0"].UseSequentialPorts){if(o.net_senior_config["SipProfiles/0"].UseSequentialPorts=="1"){o.Max=true}else if(o.net_senior_config["SipProfiles/0"].UseSequentialPorts=="0"){o.Max=false}else{o.Max=true}}else{o.Max=true}void 0}function u(){s();l()}u()}i.$inject=[];function i(){return{restrict:"EA",replace:true,scope:{},templateUrl:"/source/ewei-phone/template/phone-setting-network-panel.html",controller:t,controllerAs:"vm"}}})(angular);(function(e){e.module("eweiApp.common").controller("phoneSettingPhonePanelController",t).directive("phoneSettingPhonePanel",i);t.$inject=["$scope","coreNotifyService","eweiPhoneService","ctiSipService","alertService","coreModelService"];function t(e,t,i,n,o,a){var r=this;var s=r.__proto__.constructor.name+"_"+(new Date).valueOf();r.refreshPhoneSet=function(){if(r.redirectTo==r.config["SipProfiles/0/Lines/0"].Username){o.add("请不要将转移电话设置为本机号码","danger");return false}var e="";if(r.config.GeneralSettings.AutoAccept=="0"){e="false"}else if(r.config.GeneralSettings.AutoAccept=="1"){e="true"}else{e=r.config.GeneralSettings.AutoAccept+""}r.call_in_ring=="Default"?"":r.call_in_ring;n.setSR(r.redirectTo+"",e,r.call_in_ring+"");if(r.redirectTo!=""){r.config.GeneralSettings.RedirectTo="sip:"+r.redirectTo+"@"+a.detail.ctis.get(a.config.activeCtiID).sipAddress+":"+a.detail.ctis.get(a.config.activeCtiID).sipPort}else{r.config.GeneralSettings.RedirectTo=""}o.add("更新成功");c()};function c(){r.config.GeneralSettings.AutoAccept==true?"1":"0";r.call_in_ring=="Default"?"":r.call_in_ring;r.config.AudioSettings.Ringtone=r.call_in_ring;i.setSipPhoneConfig(r.config)}r.answerMethod=function(e){r.config.GeneralSettings.AutoAccept=e;r.clicked=false};r.ringMethod=function(e){r.call_in_ring=e;r.clicked1=false};function l(){t.register(s,t.constant.EVENT_CTI_SIP_WL,function(e,t){void 0;r.ringList=t.result.split(",")})}function u(){t.unRegister(s)}e.$on("$destroy",function(){u()});function d(){r.config=i.getSipPhoneConfig();if(r.config.GeneralSettings.RedirectTo!=""){var e=new RegExp(/\:([\s\S]*)\@/);r.redirectTo=e.exec(r.config.GeneralSettings.RedirectTo)[1]}else{r.redirectTo=r.config.GeneralSettings.RedirectTo}r.call_in_ring=r.config.AudioSettings.Ringtone}function f(){l();d()}f()}i.$inject=[];function i(){return{restrict:"EA",replace:true,scope:{},templateUrl:"/source/ewei-phone/template/phone-setting-phone-panel.html",controller:t,controllerAs:"vm"}}})(angular);(function(e){e.module("eweiApp.common").filter("transAnswer",t).filter("transSipError",i);t.$inject=[];function t(){return function(e){if(typeof e!="undefined"){if(e==0||e==false){e="手动接听"}else if(e==1||e==true){e="自动接听"}return e}}}i.$inject=[];function i(){return function(e){if(typeof e!="undefined"){if(e=="cause unknown"||e=="registered normal"||e=="registering normal"||e=="unregistering normal"||e=="unregistered normal"||e=="unregister failed, could not connect"||e=="unregister failed, not authorized"||e=="unregister failed, timeout"||e=="provisioned, normal"||e=="unknown reason"){return"连接失败，未知原因"}else if(e=="register failed, could not connect"){return"注册失败，连接SIP失败"}else if(e=="register failed, timeout"){return"注册失败，网络超时"}else if(e=="register failed, not authorized"){return"注册失败，用户名或密码错误"}}}}})(angular);(function(e){e.module("eweiApp.common").controller("phoneSettingLinePanelController",t).directive("phoneSettingLinePanel",i);t.$inject=["$scope","coreModelService","resetIndexService","ctiUsbService","ctiSipService","coreNotifyService","eweiPhoneService","apiRestfulService","ctiService","$timeout","alertService","ConsoleConfig"];function t(e,n,t,o,a,r,s,c,l,u,d,i){var f=this;var p=f.__proto__.constructor.name+"_"+(new Date).valueOf();var g="";f.eweiHelpcenterApiUrl=i.eweiHelpcenterApiUrl;f.chosenChannel=function(e){f.checkedChannel=n.detail.ctis.get(e);r.doNotify(r.constant.EVENT_MENUS_STATUS);f.clicked=false};f.refreshChannel=function(){f.channel_list=t.fn();void 0;f.clicked=!f.clicked};f.connectChannel=function(e,t){if(typeof t=="undefined"){d.add("请选择一个电话渠道","danger");return false}else if((typeof f.username=="undefined"||f.username==""||typeof f.pwd=="undefined"||f.pwd=="")&&n.detail.ctis.get(t).voiceSystem=="sip"){d.add("用户名或密码没有输入","danger");return false}r.doNotify(r.constant.EVENT_PHONE_CONNECT_NOTIFY,false);f.sipFail=false;f.connectingChannel=true;var i={phone_box:{phone_box:function(){void 0},sip:function(){o.stop();r.doNotify(r.constant.EVENT_PHONE_STATUS,{type:"offline"});void 0}},sip:{phone_box:function(){a.stop();r.doNotify(r.constant.EVENT_PHONE_STATUS,{type:"offline"});void 0},sip:function(){void 0}}};do{if(!n.detail.ctis.get(t)){break}if(!n.detail.ctis.get(n.config.activeCtiID)){break}i[n.detail.ctis.get(n.config.activeCtiID).voiceSystem][n.detail.ctis.get(t).voiceSystem]();r.doNotify(r.constant.EVENT_PHONE_CONNECT_NOTIFY,true)}while(0);if(e=="phone_box"){o.stop();u(function(){o.run()},5e3);void 0}else if(e=="sip"){if(!f.checkedChannel.proxyAddress||/^[ ]*$/.test(f.checkedChannel.proxyAddress)){a.loginSip(f.checkedChannel.sipAddress+":"+f.checkedChannel.sipPort,f.checkedChannel.sipAddress+":"+f.checkedChannel.sipPort,f.username,f.pwd,t+"")}else{a.loginSip(f.checkedChannel.sipAddress+":"+f.checkedChannel.sipPort,f.checkedChannel.proxyAddress+":"+f.checkedChannel.proxyPort,f.username,f.pwd,t+"")}void 0}s.setActiveCtiID(t);l.setActiveCtiID(t);if(n.detail.ctis.get(t).voiceSystem=="phone_box"){g=u(function(){f.connectingChannel=false;f.sipFail=true;f.sipFailMessage="连接失败";r.doNotify(r.constant.EVENT_PHONE_CONNECT_NOTIFY,false)},1e4)}};function m(){r.register(p,r.constant.EVENT_CTI_ERROR,function(e,t){s.setUBoxError(t.type);r.doNotify(r.constant.EVENT_PHONE_STATUS,{type:o.getUserState()});f.warntip=true});r.register(p,r.constant.EVENT_UBOX_CANCEL_ERROR,function(e,t){s.setUBoxError(null);f.warntip=false;r.doNotify(r.constant.EVENT_PHONE_STATUS,{type:o.getUserState()})});r.register(p,r.constant.EVENT_CTI_STARTED,function(e,t){r.doNotify(r.constant.EVENT_PHONE_CONNECT_NOTIFY,false);f.connectingChannel=false;if(t.result&&t.result!="0"){f.sipFail=true;f.sipFailMessage=t.context;return false}if(o.getStarted()){u.cancel(g);void 0;r.doNotify(r.constant.EVENT_UBOX_CANCEL_ERROR);if(s.getActiveCtiID()){n.config.activeCtiID=s.getActiveCtiID()}var i={url:"api/v1/engineers/sip_logout.json",urlParam:"",dataParam:""};r.doNotify(r.constant.EVENT_PHONE_DIAL_SET,true);c.run(i).put(i.dataParam,function(e){if(e.status!=0){void 0}})}else if(a.getStarted()){void 0;if(s.getActiveCtiID()){n.config.activeCtiID=s.getActiveCtiID()}r.doNotify(r.constant.EVENT_PHONE_DIAL_SET,true)}else{}});r.register(p,r.constant.EVENT_CHANNEL_STOP,function(e,t){if(f.checkedChannel.id==t.id){h()}});r.register(p,r.constant.EVENT_CONFIG_COMPLETE,function(e,t){f.config=s.getSipPhoneConfig();if(f.config){f.username=f.config["SipProfiles/0/Lines/0"].Username;f.pwd=f.config["SipProfiles/0/Lines/0"].Password}})}function _(){r.unRegister(p)}e.$on("$destroy",function(){_()});function h(){if(!n.detail.ctis.get(n.config.activeCtiID)){return false}if(typeof n.detail.ctis.get(n.config.activeCtiID).enabled!="undefined"){n.detail.ctis.get(n.config.activeCtiID).enabled?f.checkedChannel=n.detail.ctis.get(n.config.activeCtiID):f.checkedChannel={}}else{f.checkedChannel=n.detail.ctis.get(n.config.activeCtiID)}f.channel_list=t.fn();f.config=s.getSipPhoneConfig();if(f.config){f.username=f.config["SipProfiles/0/Lines/0"].Username;f.pwd=f.config["SipProfiles/0/Lines/0"].Password}if(o.getStarted()&&s.getUBoxError()){f.warntip=true}}function v(){m();h()}v()}i.$inject=[];function i(){return{restrict:"EA",replace:true,scope:{},templateUrl:"/source/ewei-phone/template/phone-setting-line-panel.html",controller:t,controllerAs:"vm"}}})(angular);(function(e){e.module("eweiApp.common").controller("phoneSettingMenuPanelController",t).directive("phoneSettingMenuPanel",i);t.$inject=["$scope","coreNotifyService","coreModelService","judgeDisabledService","ctiSipService","ctiUsbService","eweiPhoneService"];function t(e,i,t,n,o,a,r){var s=this;var c=s.__proto__.constructor.name+"_"+(new Date).valueOf();s.choseMenuFn=function(e){if(!n.fn(e)){return false}s.choseMenu=[];s.choseMenu[e]=true;i.doNotify(i.constant.EVENT_SWITCH_SET_PANEL,{menu:e});if(e=="phone"){o.getWL()}else if(e=="voice"){o.getDL("2")}};function l(){i.register(c,i.constant.EVENT_MENUS_STATUS,function(e,t){s.disabled=n.fn("","disabled");if(t&&t.misc&&t.misc.status=="phone"){s.choseMenuFn("phone")}});i.register(c,i.constant.EVENT_CTI_ERROR,function(e,t){r.setUBoxError(t.type);s.warntip=true})}function u(){i.unRegister(c)}e.$on("$destroy",function(){u()});function d(){s.choseMenu=[];s.choseMenu["line"]=true;s.disabled=n.fn("","disabled");i.doNotify(i.constant.EVENT_SWITCH_SET_PANEL,{menu:"line"});if(a.getStarted()&&r.getUBoxError()){s.warntip=true}i.register(c,i.constant.EVENT_UBOX_CANCEL_ERROR,function(e,t){r.setUBoxError(null);s.warntip=false;i.doNotify(i.constant.EVENT_PHONE_STATUS,{type:a.getUserState()})})}function f(){l();d()}f()}i.$inject=[];function i(){return{restrict:"EA",replace:true,scope:{},templateUrl:"/source/ewei-phone/template/phone-setting-menu-panel.html",controller:t,controllerAs:"vm"}}})(angular);(function(e){e.module("eweiApp.common").controller("phoneSettingPanelController",t).directive("phoneSettingPanel",i);t.$inject=["$scope","coreNotifyService"];function t(e,t){var i=this;var n=i.__proto__.constructor.name+"_"+(new Date).valueOf();function o(){t.register(n,t.constant.EVENT_SWITCH_SET_PANEL,function(e,t){if(t&&t.menu){i.setPanel=[];i.setPanel[t.menu]=true}})}function a(){t.unRegister(n)}e.$on("$destroy",function(){a()});function r(){o()}r()}i.$inject=[];function i(){return{restrict:"EA",replace:true,scope:{},templateUrl:"/source/ewei-phone/template/phone-setting-panel.html",controller:t,controllerAs:"vm"}}})(angular);(function(){"use strict";angular.module("eweiApp.ticket").config(e).controller("telephoneChannelsListCtrl",t).controller("telephoneChannelsCtrl",i);e.$inject=["$stateProvider","$urlRouterProvider"];t.$inject=["$scope","$state","$http","$rootScope","alertService","$modal_","permissions","coreModelService","coreNotifyService","apiCtiViaListService","ctiUsbService","ctiSipService"];i.$inject=["$scope","$stateParams","coreModelService"];function e(e,t){e.state("system_setting.telephone_channels",{url:"/telephone_channels/:id/:type",templateUrl:"source/telephone_channels/telephone_channels.html",controller:"telephoneChannelsCtrl",permission:"ticket_setting_via"}).state("system_setting.telephone_channels.cti_port",{url:"/cti_port",templateUrl:"source/telephone_channels/templates/cti_port.html",controller:"telephoneChannelsCtiPortCtrl",permission:"ticket_setting_via",resolve:{loadMyFiels:["$ocLazyLoad",function(e){return e.load("/source/telephone_channels/js/cti_port.js")}]}})}function t(o,a,e,r,s,c,l,u,d,t,f,p){o.ctiList={viaPhones:[]};var i=this.__proto__.constructor.name+"_"+(new Date).valueOf();function n(){m();_();g()}function g(){t.run(d.constant.EVENT_DETAIL_CTIS)}function m(){d.register(i,d.constant.EVENT_DETAIL_CTIS,function(e,t){_()})}function _(){o.ctiList={viaPhones:[]};var e=u.detail.ctis.getAll();for(var t in e){o.ctiList.viaPhones.push(e[t])}void 0}function h(){d.unRegister(i)}o.$on("$destroy",function(){h()});n();o.toEditTelephoneChannels=function(e,t,i){if(r.providerLicense.type=="blend"||r.providerLicense.type=="public"||r.providerLicense.type=="trial"||r.providerLicense.type=="professional"||r.providerLicense.type=="enterprise"||r.providerLicense.type=="enterprise_trial"||r.providerLicense.type=="enterprise_plus"||r.providerLicense.type=="oem"||r.providerLicense.type=="online_service_basic"||r.providerLicense.type=="remote_assistance_basic"||r.providerLicense.type=="enterprise_basic"||r.providerLicense.type=="enterprise_basic_19"){a.go("system_setting.telephone_channels.cti_port",{id:e,type:t,name:i})}else{var n=c({scope:o,title:"提示",contentTemplate:"source/views/fun_restriction_reminder.html",html:true,show:true,placement:"center"});o.hasPermission=true;o.tipNotSupportService="当前服务版本不支持此功能，请升级服务后再试。";o.goAuthorization=function(){void 0;if(l.hasPermission("system_setting_company_account")){a.go("system_setting.detail.license",{uri:"company_account",settingType:"system"});n.$promise.then(n.hide)}else{o.hasPermission=false;o.tipNotSupportService="很抱歉，你没有访问授权计划的权限"}};o.hideModal_=function(){n.$promise.then(n.hide)}}};o.enabled=function(t,i){if(!i){o._messages="您确定停用吗？";var n=c({scope:o,title:"停用确认",contentTemplate:"source/views/alter_common.html",html:true,show:true,placement:"center"});o.$ok=function(){o.isLoading=true;e({url:"api/v1/via_phone/enable/"+t.viaPhone.id+".json?enabled="+i,method:"put",headers:{_token:getCookie("user_token")}}).success(function(e){if(e.status==0){o.isLoading=false;s.add("停用成功","success");t.viaPhone.enabled=i;u.detail.ctis.set(t.viaPhone.id,"enabled",i);if(t.viaPhone.voiceSystem=="sip"){p.stop()}if(t.viaPhone.voiceSystem=="phone_box"){f.stop()}d.doNotify(d.constant.EVENT_CHANNEL_STOP,{id:t.viaPhone.id});d.doNotify(d.constant.EVENT_PHONE_DIAL_SET,true);n.$promise.then(n.hide)}else{o.isLoading=false;s.add("停用失败","danger")}})};o.$hide=function(){n.$promise.then(n.hide)}}else{e({url:"api/v1/via_phone/enable/"+t.viaPhone.id+".json?enabled="+i,method:"put",headers:{_token:getCookie("user_token")}}).success(function(e){if(e.status==0){o.isLoading=false;t.viaPhone.enabled=i;u.detail.ctis.set(t.viaPhone.id,"enabled",i)}else{o.isLoading=false;s.add("启用失败","danger")}})}};o.deleteTelephoneChannels=function(t,i){o._messages="您确定删除吗？";var n=c({scope:o,title:"删除确认",contentTemplate:"source/views/alter_common.html",html:true,show:true,placement:"center"});o.$ok=function(){o.isLoading=true;e({url:"api/v1/via_phone/"+i.id+".json",method:"DELETE",headers:{_token:getCookie("user_token")}}).success(function(e){if(e.status==0){s.add("删除成功","success");o.isLoading=false;t.splice(t.indexOf(i),1);u.detail.ctis.remove(i.id);n.$promise.then(n.hide)}else{o.isLoading=false;s.add("删除失败","danger")}})};o.$hide=function(){n.$promise.then(n.hide)}}}function i(e,t,i){e.checkId=t.id;if(t.id>0){e.telphoneChannelName=i.detail.ctis.get(t.id).name}e.navListData=[{title:"CTI接口",self:"system_setting.telephone_channels"}]}})();(function(o){o.module("eweiApp.common").controller("dialFnPanelController",t).directive("dialFnPanel",e);t.$inject=["$scope","telNumService","coreNotifyService","ctiUsbService","coreModelService","ctiSipService","addCallRecordService","createSessionService","EweiConfig","$rootScope","eweiPhoneService","createSessionFailService","permissions","mutilListService"];function t(r,s,c,l,u,d,e,t,i,n,f,o,a,p){var g=this;var m=g.__proto__.constructor.name+"_"+(new Date).valueOf();var _=a.hasPermission("chat_call_out");g.toggleNumberPanel=function(){g.showNumberPanel=!g.showNumberPanel};var h=0;var v=f.getMouseIndex();g.clickNum=function(e){var t=s.getTelNum();void 0;if(v!=f.getMouseIndex()){h=0;v=f.getMouseIndex()}if(t){if(f.getMouseIndex()==-1||f.getMouseIndex()==null){t+=e}else{var i=f.getMouseIndex()+h++;var n=t.substring(0,i);var o=t.substring(i,t.length);t=n+e+o}}else{t="";t+=e}f.setDialPanelNum(t);c.doNotify(c.constant.EVENT_PHONE_NUM_IMPORT)};g.backTelNum=function(){f.backKeyboardFn();c.doNotify(c.constant.EVENT_PHONE_NUM_IMPORT)};var E=f.getSipPhoneConfig();void 0;g.callout=function(){if(!s.getTelNum()||s.getTelNum()==""){return false}if(!_){c.doNotify(c.constant.EVENT_JUDGE_CALL_OUT,{message:"无权限呼出！"});return false}if(u.detail.ctis.get(u.config.activeCtiID)&&u.detail.ctis.get(u.config.activeCtiID).voiceSystem=="phone_box"){if(!l.getStarted()){c.doNotify(c.constant.EVENT_JUDGE_CALL_OUT,{message:"无可用的呼出设备!"});return false}c.doNotify(c.constant.EVENT_JUDGE_CALL_OUT,{message:"正在拨号,请稍等···"});f.setUser(null);l.callout(s.getTelNum())}else if(u.detail.ctis.get(u.config.activeCtiID)&&u.detail.ctis.get(u.config.activeCtiID).voiceSystem=="sip"){var e=f.getSipPhoneConfig();var t=e["SipProfiles/0/Lines/0"].Username;var i=s.getTelNum();if(t==i){c.doNotify(c.constant.EVENT_JUDGE_CALL_OUT,{message:"无法呼叫本机!"});return}var n=p.getMutilList();var o=-1;for(var a=0;a<n.length;a++){if(n[a].phoneNumber==i){o=a;break}}if(o>-1||i==f.getHostTelNum()){c.doNotify(c.constant.EVENT_JUDGE_CALL_OUT,{message:"请勿重复拨打该号码!"});return}if(!d.callout(s.getTelNum())){c.doNotify(c.constant.EVENT_JUDGE_CALL_OUT,{message:"暂时不能拨打电话或号码有误!"});return}if(r.isMutil){c.doNotify(c.constant.EVENT_MAIN_DIAL_PANEL,{showMainDialPanel:false,isMutil:true,mutilSuccess:r.mutilSuccess});c.doNotify(c.constant.EVENT_PHONE_SIPCALL_PANEL,{showPhoneSipcallPanel:true,isMutil:true})}else{f.setStatus(d.getUserState());f.setUser(null);c.doNotify(c.constant.EVENT_MAIN_DIAL_PANEL,{showMainDialPanel:false});c.doNotify(c.constant.EVENT_PHONE_SIPCALL_PANEL,{showPhoneSipcallPanel:true})}}f.setDialPanelNum(null)};function T(){c.register(m,c.constant.EVENT_CTI_CONNECTED,function(e,t){if(t=="0"){c.doNotify(c.constant.EVENT_MAIN_DIAL_PANEL,{showMainDialPanel:false});c.doNotify(c.constant.EVENT_PHONE_USB_PANEL,{showPhoneUsbCallPanel:true,Ubox:"callout"});c.doNotify(c.constant.EVENT_UBOX_PHONE_CALL_IN_STATUS,"通话建立")}else if(t=="1"){c.doNotify(c.constant.EVENT_JUDGE_CALL_OUT,{message:"请先摘机后拨号！"})}else if(t=="2"){c.doNotify(c.constant.EVENT_JUDGE_CALL_OUT,{message:"拔号失败！"})}});c.register(m,c.constant.EVENT_CALL_OUT,function(e,t){if(g.isCallOutVal!="offline"){g.callout()}});c.register(m,c.constant.EVENT_PHONE_STATUS,function(e,t){g.isCallOutVal=t.type})}function y(){c.unRegister(m)}r.$on("$destroy",function(){y()});function N(){g.showNumberPanel=true}function S(){T();N()}S()}e.$inject=["$timeout"];function e(e){return{restrict:"EA",replace:true,scope:{ok:"&",isMutil:"=",mutilSuccess:"="},templateUrl:"/source/ewei-phone/template/dial-fn-panel.html",controller:t,controllerAs:"vm",compile:function e(t,i,n){return{post:function(e,t,i){var n=o.element(".rotary-dial",t);n.on("click",function(e){n.toggleClass("rotary-dial");n.toggleClass("rotary-dial-opposite");e.stopPropagation()});e.$on("$destroy",function(){n.off("click")})}}}}}})(angular);(function(s){s.module("eweiApp.common").controller("contactsAndRecordsController",e).directive("contactsAndRecords",t);e.$inject=["$scope","coreNotifyService","telNumService","apiCtiContactListService","coreModelService","filterContactsService","apiCtiCallRecordListService","eweiPhoneService"];function e(e,t,i,n,o,a,r,s){var c=this;var l=c.__proto__.constructor.name+"_"+(new Date).valueOf();c.saveTelNumByKeyboard=function(){i.setTelNum(c.telNum);s.setDialPanelNum(c.telNum)};c.callout=function(e){i.setTelNum(e);t.doNotify(t.constant.EVENT_CALL_OUT)};c.goContacts=function(){t.doNotify(t.constant.EVENT_CONTACT_TITLE,{contactTitle:true});t.doNotify(t.constant.EVENT_CONTACT_MAIN_PANEL,{contactMainPanel:true})};c.getMoreRecords=function(){c.params.records._page=c.nextPageNoRecords;r.run(t.constant.EVENT_PHONE_DATA_RECORDS,c.params.records._page,"",{_do_count:false,_count:10,_desc:"createdAt",_page:c.params.records._page},function(){void 0})};c.choseTelNum=function(e){i.setTelNum(e);c.telNum=i.getTelNum()};c.filterTelNum=function(e){if(c.telNum){return e.phone&&e.phone.indexOf(c.telNum)>-1||e.name&&e.name.indexOf(c.telNum)>-1}return true};function u(){c.telNum=i.getTelNum();c.params={};c.params.records={_page:1};c.nextPageNoContacts=1;c.nextPageNoRecords=1;c.recordsListData=o.detail.callrecords.gets(o.list.callrecords.gets(c.params.records._page))}function d(){t.register(l,t.constant.EVENT_PHONE_DIAL_SET,function(e,t){if(t){u();c.getMoreRecords()}});t.register(l,t.constant.EVENT_PHONE_NUM_IMPORT,function(e,t){c.telNum=s.getDialPanelNum();i.setTelNum(c.telNum)});t.register(l,t.constant.EVENT_PHONE_DATA_RECORDS,function(e,t){if(t&&t.id){c.recordsListData=o.detail.callrecords.gets(o.list.callrecords.gets(1))}else if(c.params.records._page==1&&o.list.callrecords.total()>c.nextPageNoRecords*10){c.recordsListData=o.detail.callrecords.gets(o.list.callrecords.gets(c.params.records._page));c.nextPageNoRecords=c.params.records._page+1}else if(o.list.callrecords.total()>c.nextPageNoRecords*10){Array.prototype.push.apply(c.recordsListData,o.detail.callrecords.gets(o.list.callrecords.gets(c.params.records._page)));c.nextPageNoRecords=c.params.records._page+1;void 0;void 0;void 0}else{c.nomoreRecords=true}})}function f(){t.unRegister(l)}e.$on("$destroy",function(){f()});function p(){d();u()}p()}t.$inject=["$timeout","eweiPhoneService"];function t(o,r){return{restrict:"EA",replace:true,scope:{},templateUrl:"/source/ewei-phone/template/contacts-and-records.html",controller:e,controllerAs:"vm",compile:function e(t,i,n){return{post:function(a,e,t){var i=s.element("body");var n=s.element(".list-panel");n.on("scroll",function(){var e=s.element(".list-records",n);if(e.height()-n.height()==n.scrollTop()){o(function(){a.vm.getMoreRecords()},100)}});i.on("click",".mounted",function(){var e=s.element(".mounted");for(var t=0;t<e.length;t++){e.eq(t).removeClass("li-actived")}s.element(this).addClass("li-actived")});i.on("keydown",function(e){var t=s.element(".mounted");var i=0;var n=true;for(var o=0;o<t.length;o++){if(t.eq(o).hasClass("li-actived")){i=o;n=false}}void 0;if(e.keyCode==8){r.backKeyboardFn()}else if(e.keyCode==13){if(!n){a.vm.choseTelNum(t.eq(i).attr("name"))}}else if(e.keyCode==40){if(n){t.eq(i).addClass("li-actived")}else if(i+1<t.length){t.eq(i).removeClass("li-actived");t.eq(++i).addClass("li-actived")}else{a.vm.getMoreRecords()}}else if(e.keyCode==38){if(i-1>=0){t.eq(i).removeClass("li-actived");t.eq(--i).addClass("li-actived")}}});a.$on("$destroy",function(){n.off("scroll");i.off("click");i.off("keydown")})}}}}}})(angular);(function(e){e.module("eweiApp.common").filter("filterTime",t);t.$inject=[];function t(){return function(e){if(typeof e=="undefined"){return""}if(e==0){return e+'"'}if(parseInt(e/3600)<1){if(parseInt(e/60)==0){return parseInt(e%60)+'"'}else{return parseInt(e/60)+"'"+parseInt(e%60)+'"'}}else{var t=e%3600;var i=parseInt(t/60);var n=parseInt(t-i*60);return parseInt(e/3600)+" "+i+"'"+n+'"'}}}})(angular);(function(e){e.module("eweiApp.common").controller("dialHeaderMenuController",t).directive("dialHeaderMenu",i);t.$inject=["$scope","coreNotifyService","coreModelService","ctiSipService","ctiUsbService","eweiPhoneService","apiRestfulService"];function t(e,n,t,o,a,r,s){var c=this;var i=c.__proto__.constructor.name+"_"+(new Date).valueOf();c.showStatusList=function(){c.statusList=!c.statusList;if(t.detail.ctis.get(t.config.activeCtiID)){c.channelType=t.detail.ctis.get(t.config.activeCtiID).voiceSystem}};c.switchPanel=function(e){if(!e){c.warntip=false}else{if(a.getStarted()&&r.getUBoxError()){c.warntip=true}}n.doNotify(n.constant.EVENT_PHONE_DIAL_SET,e);n.doNotify(n.constant.EVENT_MENUS_STATUS)};c.checkPhoneStatus=function(e){c.statusList=!c.statusList;n.doNotify(n.constant.EVENT_PHONE_STATUS,{type:e})};function l(){n.register(i,n.constant.EVENT_CTI_ERROR,function(e,t){r.setUBoxError(t.type);n.doNotify(n.constant.EVENT_PHONE_STATUS,{type:a.getUserState()});c.warntip=true});n.register(i,n.constant.EVENT_UBOX_CANCEL_ERROR,function(e,t){r.setUBoxError(null);c.warntip=false;n.doNotify(n.constant.EVENT_PHONE_STATUS,{type:a.getUserState()})});n.register(i,n.constant.EVENT_PHONE_DIAL_SET,function(e,t){c.dialSetPanel=t});n.register(i,n.constant.EVENT_PHONE_STATUS,function(e,t){c.phoneStatus=t.type;c.SipPhoneOK=o.getStarted();void 0;if(o.getStarted()){r.setLastPhoneState(o.getUserState());o.setUserState(t.type)}else if(a.getStarted()){r.setLastPhoneState(a.getUserState());a.setUserState(t.type)}if(t.type=="transfer"){c.switchPanel(false);n.doNotify(n.constant.EVENT_MENUS_STATUS,{misc:{status:"phone"}})}if(t.type=="offline"&&o.getStarted()){var i={url:"api/v1/engineers/sip_logout.json",urlParam:"",dataParam:""};s.run(i).put(i.dataParam,function(e){if(e.status!=0){void 0}})}else if(r.getLastPhoneState()=="offline"&&t.type!="offline"&&o.getStarted()){c.config=r.getSipPhoneConfig();var i={url:"api/v1/engineers/sip_login.json",urlParam:"",dataParam:{sipAccount:c.config["SipProfiles/0/Lines/0"].Username}};s.run(i).put(i.dataParam,function(e){if(e.status!=0){void 0}else if(e.status==0){void 0}})}});n.register(i,n.constant.EVENT_CTI_STARTED,function(e,t){if(o.getStarted()){n.doNotify(n.constant.EVENT_PHONE_STATUS,{type:o.getUserState()})}else if(a.getStarted()){n.doNotify(n.constant.EVENT_PHONE_STATUS,{type:a.getUserState()})}else{n.doNotify(n.constant.EVENT_PHONE_STATUS,{type:"offline"})}})}function u(){n.unRegister(i)}e.$on("$destroy",function(){u()});function d(){c.statusList=false;c.dialSetPanel=true;if(o.getStarted()){n.doNotify(n.constant.EVENT_PHONE_STATUS,{type:o.getUserState()})}else if(a.getStarted()){n.doNotify(n.constant.EVENT_PHONE_STATUS,{type:a.getUserState()});if(r.getUBoxError()){c.warntip=true}}else{n.doNotify(n.constant.EVENT_PHONE_STATUS,{type:"offline"})}}function f(){l();d()}f()}i.$inject=[];function i(){return{restrict:"EA",replace:true,scope:{},templateUrl:"/source/ewei-phone/template/dial-header-menu.html",controller:t,controllerAs:"vm"}}})(angular);(function(e){e.module("eweiApp.common").controller("dialPanelController",t).directive("dialPanel",i);t.$inject=["$scope","coreNotifyService","coreModelService","ctiSipService","ctiUsbService","eweiPhoneService"];function t(e,t,i,n,o,a){var r=this;var s=r.__proto__.constructor.name+"_"+(new Date).valueOf();r.dialHeaderMenuShow=true;function c(){t.register(s,t.constant.EVENT_PHONE_DIAL_SET,function(e,t){if(o.getStarted()||n.getStarted()){r.phoneEnable=true}else{r.phoneEnable=false}r.whichPanelShow=t});t.register(s,t.constant.EVENT_CTI_HELD_SUCCESS,function(e,t){r.heldSuccess=true;a.setHeld(r.heldSuccess)});t.register(s,t.constant.EVENT_PHONE_CONNECT_NOTIFY,function(e,t){if(t){r.isLoop=true;r.connectMessage="话机正在连接，请稍等···"}else{r.isLoop=false;r.connectMessage="话机不可用，请检查线路和设置"}});t.register(s,t.constant.EVENT_CONTACT_TITLE,function(e,t){r.contactTitle=t.contactTitle});t.register(s,t.constant.EVENT_CONTACT_MAIN_PANEL,function(e,t){r.contactMainPanel=t.contactMainPanel})}function l(){t.unRegister(s)}e.$on("$destroy",function(){l()});function u(){r.whichPanelShow=true;if(o.getStarted()||n.getStarted()){r.phoneEnable=true}else{r.phoneEnable=false}t.doNotify(t.constant.EVENT_PHONE_CONNECT_NOTIFY,false);r.dialHeaderMenuShow=!e.isMutil;r.isKeepPhone=e.isKeepPhone;r.isSipCall=e.isSipCall;r.mutilSuccess=e.mutilSuccess;if(e.isMutil){r.heldSuccess=a.getHeld()}else{r.heldSuccess=true}}function d(){c();u()}d()}i.$inject=[];function i(){return{restrict:"EA",replace:true,scope:{isMutil:"=",isKeepPhone:"=",isSipCall:"=",mutilSuccess:"="},templateUrl:"/source/ewei-phone/template/dial-panel.html",controller:t,controllerAs:"vm"}}})(angular);(function(h){h.module("eweiApp.common").controller("eweiPhonePanelController",t).directive("eweiPhonePanel",e);t.$inject=["$scope","searchChatDetailService","coreNotifyService","telNumService","ctiUsbService","ctiSipService","apiCtiContactListService","EweiConfig","$rootScope","eweiPhoneService","providerJudgement"];function t(n,e,o,i,a,r,t,s,c,l,u){var d=this.__proto__.constructor.name+"_"+(new Date).valueOf();var f=this;f.panelActived=false;function p(){o.register(d,o.constant.EVENT_PHONE_PANEL,function(e,t){f.showPhonePanel=t.showPhonePanel;f.panelActived=f.showPhonePanel;o.doNotify(o.constant.EVENT_MAIN_DIAL_PANEL,{showMainDialPanel:t.showPhonePanel})});o.register(d,o.constant.EVENT_MAIN_DIAL_PANEL,function(e,t){f.showMainDialPanel=t.showMainDialPanel;if(t.isMutil){f.isMutil=t.isMutil;f.isKeepPhone=t.isKeepPhone;f.isSipCall=t.isSipCall;f.mutilSuccess=t.mutilSuccess;f.sipCallMutil=true}else{f.isMutil=false;f.sipCallMutil=false}});o.register(d,o.constant.EVENT_PHONE_USB_PANEL,function(e,t){if(t["Ubox"]){l.setUboxFlag(t["Ubox"])}else{l.setUboxFlag(null)}f.showPhoneUsbCallPanel=t.showPhoneUsbCallPanel});o.register(d,o.constant.EVENT_PHONE_SIPCALL_PANEL,function(e,t){f.showPhoneSipcallPanel=t.showPhoneSipcallPanel;f.showPlayScreen=false;if(t.isMutil){f.sipCallMutil=true}if(t.backToSipCall){f.backToSipCall=true;o.doNotify(o.constant.EVENT_PHONE_MUTIL_PANEL,{calling:true})}else{f.backToSipCall=false}if(t.incoming){f.incoming=true}else{f.incoming=false}});o.register(d,o.constant.EVENT_PHONE_TRANSFER_PANEL,function(e,t){if(h.isDefined(t)&&t.hasOwnProperty("showTransferPanel")){f.showTransferPanel=t.showTransferPanel}if(h.isDefined(t)&&t.hasOwnProperty("action")){switch(t.action){case"mark-transfer-state":{f.transferState=t.state;break}}}});o.register(d,o.constant.EVENT_PHONE_MUTIL_PANEL,function(e,t){if(t.isMutilPanel){f.showEweiPhoneMutil=t.showEweiPhoneMutil}});o.register(d,o.constant.EVENT_PHONE_SIPCALL_RECORD_TICKET_PANEL,function(e,t){f.showRecordTicketPanel=t.showRecordTicketPanel});o.register(d,o.constant.EVENT_PHONE_CLOSE_PLAYSCREEN,function(e,t){f.showPlayScreen=false;f.showPhonePanel=false;f.showMainDialPanel=true;f.showPhoneUsbCallPanel=false;f.showPhoneSipcallPanel=false;f.showRecordTicketPanel=false});o.register(d,o.constant.EVENT_CTI_RING,function(e,t){l.setUser(null);if(a.getStarted()){if(l.getCtiChatId()){o.doNotify(o.constant.EVENT_PHONE_PANEL,{showPhonePanel:true});o.doNotify(o.constant.EVENT_UBOX_CALLIN_TIP,{tipShow:true,tel:""})}else{i.setTelNum("");o.doNotify(o.constant.EVENT_PHONE_PANEL,{showPhonePanel:true});o.doNotify(o.constant.EVENT_MAIN_DIAL_PANEL,{showMainDialPanel:false});f.showPhoneUsbCallPanel=false;f.showPhoneSipcallPanel=false;f.showRecordTicketPanel=false}o.doNotify(o.constant.EVENT_PHONE_USB_PANEL,{showPhoneUsbCallPanel:true,Ubox:"callin"})}});o.register(d,o.constant.EVENT_CTI_CALLIN,function(e,t){if(!u.isTrue()){return false}l.setUser(null);if(a.getStarted()){if(l.getCtiChatId()){o.doNotify(o.constant.EVENT_UBOX_CALLIN_TIP,{tipShow:true,tel:t.telNum})}else{i.setTelNum(t.telNum);o.doNotify(o.constant.EVENT_PHONE_PANEL,{showPhonePanel:true});o.doNotify(o.constant.EVENT_MAIN_DIAL_PANEL,{showMainDialPanel:false});f.showPhoneUsbCallPanel=false;f.showPhoneSipcallPanel=false;f.showRecordTicketPanel=false}o.doNotify(o.constant.EVENT_PHONE_USB_PANEL,{showPhoneUsbCallPanel:true,Ubox:"callin"})}else if(r.getStarted()){if(l.getCtiChatId()&&!f.showMainDialPanel){o.doNotify(o.constant.EVENT_PHONE_PANEL,{showPhonePanel:true});o.doNotify(o.constant.EVENT_UBOX_CALLIN_TIP,{tipShow:true,tel:t.telNum})}else{i.setTelNum(t.telNum);o.doNotify(o.constant.EVENT_PHONE_PANEL,{showPhonePanel:true});o.doNotify(o.constant.EVENT_MAIN_DIAL_PANEL,{showMainDialPanel:false});f.showPhoneUsbCallPanel=false;f.showPhoneSipcallPanel=false;f.showRecordTicketPanel=false;l.setStatus(r.getUserState());if(l.getSipPhoneConfig()&&l.getSipPhoneConfig().GeneralSettings&&l.getSipPhoneConfig().GeneralSettings.AutoAccept==="1"||l.getSipPhoneConfig()&&l.getSipPhoneConfig().GeneralSettings&&l.getSipPhoneConfig().GeneralSettings.AutoAccept===true){o.doNotify(o.constant.EVENT_PHONE_SIPCALL_PANEL,{showPhoneSipcallPanel:true,incoming:true})}else{f.showPlayScreen=true}}}});o.register(d,o.constant.EVENT_CTI_PICKUP,function(e,t){o.doNotify(o.constant.EVENT_PHONE_PANEL,{showPhonePanel:true})});o.register(d,o.constant.EVENT_CTI_HANGUP,function(e,t){if(t&&t.trigger=="other"&&f.showPlayScreen){o.doNotify(o.constant.EVENT_PHONE_PANEL,{showPhonePanel:false});o.doNotify(o.constant.EVENT_MAIN_DIAL_PANEL,{showMainDialPanel:true});o.doNotify(o.constant.EVENT_PHONE_USB_PANEL,{showPhoneUsbCallPanel:false});o.doNotify(o.constant.EVENT_PHONE_SIPCALL_PANEL,{showPhoneSipcallPanel:false});o.doNotify(o.constant.EVENT_PHONE_SIPCALL_RECORD_TICKET_PANEL,{showRecordTicketPanel:false,hideRecordTicketPanel:true});if(a.getStarted()){f.showPhoneUsbCallPanel=false}else if(r.getStarted()){f.showPlayScreen=false}}void 0;var i=l.getCallIdentity();if(h.isDefined(t)&&i!=null&&i.identity=="transfer.invite"&&t.trigger=="myself"){if(l.getTransferStatus()===true){o.doNotify(o.constant.EVENT_PHONE_SIPCALL_PANEL,{showPhoneSipcallPanel:false});o.doNotify(o.constant.EVENT_PHONE_TRANSFER_PANEL,{showTransferPanel:false});o.doNotify(o.constant.EVENT_MAIN_DIAL_PANEL,{showMainDialPanel:true});l.setCtiChatId("")}l.reverseStatus(function(e){r.setUserState(e)})}if(h.isDefined(t)&&t.type=="transfer"){if(t.direct=="host"&&f.transferState!="transfer-finished"){o.doNotify(o.constant.EVENT_PHONE_SIPCALL_PANEL,{showPhoneSipcallPanel:true,isKeepPhone:false});n.$evalAsync(function(){o.doNotify(o.constant.EVENT_PHONE_TRANSFER_PANEL,{backToSipCall:true,hangup:true})})}else if(t.direct=="host"&&f.transferState=="transfer-finished"){o.doNotify(o.constant.EVENT_PHONE_SIPCALL_PANEL,{showPhoneSipcallPanel:false});o.doNotify(o.constant.EVENT_PHONE_TRANSFER_PANEL,{showTransferPanel:false});o.doNotify(o.constant.EVENT_MAIN_DIAL_PANEL,{showMainDialPanel:true})}}var i=l.getCallIdentity();if(i!==undefined&&i!=null){l.setCallIdentity(null)}});o.register(d,o.constant.EVENT_CTI_MISS_CALL,function(e,t){if(!u.isTrue()){return false}if(a.getStarted()){if(l.getCtiChatId()){o.doNotify(o.constant.EVENT_UBOX_CLOSE_CALLIN_TIP)}else{f.showPhonePanel=false;f.showMainDialPanel=true;f.showPhoneUsbCallPanel=false;f.showPhoneSipcallPanel=false;f.showRecordTicketPanel=false;f.showPhoneUsbCallPanel=false}}else if(r.getStarted()){if(l.getCtiChatId()){o.doNotify(o.constant.EVENT_UBOX_CLOSE_CALLIN_TIP)}else{f.showPhonePanel=false;f.showMainDialPanel=true;f.showPhoneUsbCallPanel=false;f.showPhoneSipcallPanel=false;f.showRecordTicketPanel=false;f.showPlayScreen=false}}});o.register(d,o.constant.EVENT_CTI_LINE_IDENTITY,function(e,t){if(h.isDefined(t)&&t.identity){l.setCallIdentity(t);if(t.identity==="transfer.invite"){l.setTransferStatus(true)}else{l.setTransferStatus(false)}}})}f.hidePanel=function(){o.doNotify(o.constant.EVENT_PHONE_PANEL,{showPhonePanel:false})};function g(){o.unRegister(d)}n.$on("$destroy",function(){g()});function m(){f.showMainDialPanel=true}function _(){p();m()}_()}e.$inject=["$window","eweiPhoneService","$timeout"];function e(o,e,a){return{restrict:"EA",replace:true,scope:{},templateUrl:"/source/ewei-phone/template/ewei-phone-panel.html",controller:t,controllerAs:"vm",link:function(e,t,i){function n(){if(e.vm.panelActived){a(e.vm.hidePanel)}}t.on("click",function(e){e.stopPropagation()});a(function(){h.element(o).on("click",n)},500);e.$on("$destory",function(){h.element(o).off("click",n)})}}}})(angular);(function(e){e.module("eweiApp.common").controller("eweiPhoneTipController",t).directive("eweiPhoneTip",i);t.$inject=["$scope","$rootScope","coreNotifyService","$timeout","$window"];function t(e,t,i,n,o){vm=this;var a=vm.__proto__.constructor.name+"_"+(new Date).valueOf();vm.downloadApplication=function(){o.open(t.applicationUrl);t.$broadcast("installEweiHubServer","remote_desk");vm.installing=true;vm.installApp=false};e.$on("plugInstalled",function(){vm.installing=false;i.doNotify(i.constant.EVENT_PHONE_PANEL,{showPhonePanel:vm.showPhonePanel})});function r(){i.register(a,i.constant.EVENT_TIP_PANEL,function(e,t){vm.installApp=t.installApp;vm.viaSettingAuthorized=t.viaSettingAuthorized;vm.viaCtiCount=t.viaCtiCount;vm.missCallCount=t.missCallCount;vm.autoHide=true;n(function(){vm.autoHide=false},5e3)})}function s(){i.unRegister(a)}e.$on("$destroy",function(){s()});function c(){r()}c();vm.closedownload=function(){vm.installing=false;vm.installApp=false;vm.autoHide=false}}i.$inject=[];function i(){return{restrict:"EA",replace:true,scope:{},templateUrl:"/source/ewei-phone/template/ewei-phone-tip.html",controller:t,controllerAs:"vm"}}})(angular);(function(){"use strict";angular.module("eweiApp.common").directive("eweiPhoneTransfer",t).constant("phoneTransferState",Object.freeze({Nothing:"nothing",SelectEngineer:"select-engineer",Transfering:"transfering",TransferSuccessful:"transfer-successful",TransferFailed:"transfer-failed",TransferFinished:"transfer-finished"})).directive("phoneTransferCall",n);e.$inject=["$rootScope","$scope","coreNotifyService","coreModelService","phoneTransferState","ctiSipService","eweiPhoneService","apiCtiUserByPhoneService"];function e(e,i,n,t,o,a,r,s){var c=this;var l=this.__proto__.constructor.name+"_"+Date.now();c.state=o.Nothing;c.transferTarget;function u(){n.register(l,n.constant.EVENT_PHONE_TRANSFER_PANEL,function(e,t){if(!t)return;if(t.transferPanelCall){c.hide=true}if(t.action){switch(t.action){case"dotransfer":{if(a.callout(t.target.sipAccount||t.target.telNum)){a.setUser(t.target.sipAccount||t.target.telNum,t.target);i.$evalAsync(function(){c.transferTarget=t.target;c.state=o.Transfering})}else{return}c.hostTelNum=r.getHostTelNum();break}case"blindtransfer":{break}}}else{if(t.showTransferPanel){c.state=o.SelectEngineer;c.hide=false;if(c.transferTarget){c.transferTarget={}}n.doNotify(n.constant.EVENT_PHONE_TRANSFER_PANEL,{action:"mark-transfer-state",state:c.state})}}});n.register(l,n.constant.EVENT_CTI_CALL_FAILED,function(e,t){void 0});n.register(l,n.constant.EVENT_PHONE_TRANSFER_PANEL,function(e,t){if(angular.isDefined(t)&&t.hasOwnProperty("showTransferPanel")&&t.showTransferPanel){c.state=o.SelectEngineer}})}var d=function(){n.unRegister(l)};i.$on("$destory",d);var f=function(){u()};f()}t.$inject=[];function t(){return{restrict:"EA",scope:{},templateUrl:"/source/ewei-phone/template/ewei-phone-transfer.html",controller:e,controllerAs:"vm"}}i.$inject=["$rootScope","$scope","coreNotifyService","coreModelService","phoneTransferState","ctiSipService","telNumService","$timeout","eweiPhoneService"];function i(e,t,i,n,o,a,r,s,c){var l=this;var u=this.__proto__.constructor.name+"_"+Date.now();l.status="";l.state=o.Transfering;var d={};d[o.Transfering]="正在呼叫";d[o.TransferSuccessful]="通话中";d[o.TransferFailed]="呼叫失败";d[o.TransferFinished]="转接完成";l.status=d[l.state];l.enableHangup=false;l.hostOffline=false;var f;l.toggleNumberPanel=function(){l.showNumberPanel=!l.showNumberPanel};var p=function(e){i.doNotify(i.constant.EVENT_PHONE_TRANSFER_PANEL,{showTransferPanel:false});i.doNotify(i.constant.EVENT_MAIN_DIAL_PANEL,{showMainDialPanel:false});i.doNotify(i.constant.EVENT_PHONE_SIPCALL_PANEL,{showPhoneSipcallPanel:true,isKeepPhone:false});i.doNotify(i.constant.EVENT_PHONE_TRANSFER_PANEL,{backToSipCall:true,transferSuccessful:e});i.doNotify(i.constant.EVENT_PHONE_SIPCALL_RECORD_TICKET_PANEL,{showRecordTicketPanel:false,hideRecordTicketPanel:true})};var g=function(){l.state=o.Transfering;l.status=d[l.state];l.enableHangup=false;l.showNumberPanel=false;l.hostOffline=false;l.hostOffline=false};var m=function(){i.register(u,i.constant.EVENT_CTI_HANGUP,function(e,t){if(angular.isDefined(t)&&t.hasOwnProperty("type")){if(t.type=="transfer"){if(t.direct=="invite"){l.enableHangup=true;if(l.state==o.Transfering){l.state=o.TransferFailed;l.status=d[l.state]}else{if(l.state!=o.TransferFinished){a.stateCancel();p(false)}else{i.doNotify(i.constant.EVENT_PHONE_TRANSFER_PANEL,{action:"mark-transfer-state",state:l.state});i.doNotify(i.constant.EVENT_PHONE_SIPCALL_RECORD_TICKET_PANEL,{showRecordTicketPanel:false,hideRecordTicketPanel:true})}}}else if(t.direct=="host"){l.hostOnline=false;l.hostOffline=true;if(l.state!=o.TransferFinished){p(false)}}}}});i.register(u,i.constant.EVENT_CTI_CALL_FAILED,function(e,t){if(angular.isDefined(t)&&t.type=="transfer"){l.state=o.TransferFailed;l.status=d[l.state];f=s(function(){p(false)},3e3)}});i.register(u,i.constant.EVENT_CTI_CONNECTED,function(e,t){if(angular.isDefined(t)&&"transfer"==t.type){l.state=o.TransferSuccessful;l.status=d[l.state];l.hostOnline=true}});i.register(u,i.constant.EVENT_CTI_HANGUP_ENABLE,function(e){l.enableHangup=true});i.register(u,i.constant.EVENT_PHONE_TRANSFER_PANEL,function(e,t){if(angular.isDefined(t)&&t.showTransferPanel){g()}if(angular.isDefined(t)&&t.action){switch(t.action){case"blindtransfer":{l.state=o.TransferFinished;i.doNotify(i.constant.EVENT_PHONE_TRANSFER_PANEL,{action:"mark-transfer-state",state:l.state});break}}}})};var _=function(){i.unRegister(u)};var h=function(){m()};l.tempNum="";l.clickNum=function(e){l.tempNum+=e;a.dialNum(e)};l.hangupTransfer=function(){if(l.enableHangup&&l.state!=o.TransferFinished){a.hangup(t.target.sipAccount||t.target.telNum);a.stateCancel();p(false)}else{}};l.transfer=function(){if(l.state==o.TransferSuccessful){a.transferConfirm();l.state=o.TransferFinished;c.setHostTelNum()}c.reverseStatus(function(e){a.setUserState(e)});c.setCtiChatId("");i.doNotify(i.constant.EVENT_MAIN_DIAL_PANEL,{showMainDialPanel:true});i.doNotify(i.constant.EVENT_PHONE_TRANSFER_PANEL,{transferPanelCall:true})};l.createTicket=function(){i.doNotify(i.constant.EVENT_PHONE_SIPCALL_RECORD_TICKET_PANEL,{showRecordTicketPanel:true,hideRecordTicketPanel:false})};l.cancel=function(){if(f){s.cancel(f)}a.stateCancel();p(false)};l.redial=function(){if(f){s.cancel(f)}i.doNotify(i.constant.EVENT_PHONE_TRANSFER_PANEL,{action:"dotransfer",target:t.target,telNum:t.target.telNum});l.state=o.Transfering;l.status=d[l.state]};h();t.$on("$destory",_)}n.$inject=[];function n(){return{restrict:"EA",scope:{target:"=",hostTelNum:"="},templateUrl:"/source/ewei-phone/template/ewei-phone-transfer-call.html",controller:i,controllerAs:"vm"}}})();(function(){"use strict";angular.module("eweiApp.common").controller("PhoneTransferEngineerSelectController",e).directive("phoneTransferEngineerSelect",t);e.$inject=["$rootScope","$scope","$log","$timeout","coreModelService","coreNotifyService","apiServicePhoneServiceDeskService","apiSipOnlineService","ctiSipService","eweiPhoneService"];function e(e,t,i,n,o,a,r,s,c,l){var u=this;var d=u.__proto__.constructor.name+"_"+Date.now();u.showBlindTransfer=false;u.blindTransferNumber="";var f=/[+]?[0-9]+[#*]?[0-9]+/gi;u.blindTransfer=function(){if(u.transferNumberValid()){a.doNotify(a.constant.EVENT_PHONE_TRANSFER_PANEL,{action:"blindtransfer",telNum:u.blindTransferNumber});c.blindTransfer(u.blindTransferNumber);u.blindTransfered=true;l.setHostTelNum();l.closeChatFn(l.getCtiChatId(),"close_chat",function(e){});l.setCtiChatId("")}};u.transferNumberValid=function(){var e=f.test(u.blindTransferNumber);f.lastIndex=0;return e};u.doTransfer=function(e){e.isEngineer=true;e.phoneNumber=e.phoneNumber||e.telNum||e.sipAccount;a.doNotify(a.constant.EVENT_PHONE_TRANSFER_PANEL,{action:"dotransfer",target:e,telNum:e.telNum||e.sipAccount})};u.lastSearchParams={};u.searchParams={_count:999,_page:1,key:u.searchKey};u.search=function(){if(angular.isDefined(u.selectedServiceDesk)&&u.selectedServiceDesk.id!=-1){u.searchParams.serviceDeskId=u.selectedServiceDesk.id}else{delete u.searchParams.serviceDeskId}u.searchParams.key=u.searchKey;if(angular.toJson(u.searchParams)!==angular.toJson(u.lastSearchParams)){s.run(a.constant.EVENT_LIST_PHONE_SIPONLINE,u.searchParams._page,"",u.searchParams,function(e){});u.lastSearchParams=angular.copy(u.searchParams)}else{u.onlineEngineers=o.detail.siponline.gets(o.list.siponline.gets(u.searchParams._page))}};u.servicedeskArgument={_fields:"",_asc:"creatAt",_desc:"",_count:999,_page:1};u.servicedeskArgumentLast={};var p=function(){if(angular.toJson(u.servicedeskArgument)!==angular.toJson(u.servicedeskArgumentLast)){r.run(a.constant.EVENT_LIST_PHONE_SERVICEDESK,u.servicedeskArgument._page,"",u.servicedeskArgument,function(e){});u.servicedeskArgumentLast=angular.copy(u.servicedeskArgument)}else{u.servicedesks=o.detail.servicedesks.gets(o.list.phoneServicedesks.gets(u.servicedeskArgument._page));u.servicedesks.unshift({id:-1,name:"全部客服组"});u.selectedServiceDesk=u.servicedesks[0]}};var g=function(){u.showBlindTransfer=false;u.blindTransferNumber="";u.searchKey="";u.heldSuccess=false;u.blindTransfered=false;n(function(){u.heldSuccess=true},5e3)};var m=function(){a.register(d,a.constant.EVENT_LIST_PHONE_SERVICEDESK,function(e,t){u.search()});a.register(d,a.constant.EVENT_LIST_PHONE_SIPONLINE,function(e,t){u.search()});a.register(d,a.constant.EVENT_DETAIL_SERVICEDESKS,function(e,t){if(angular.isUndefined(t))return;if(t.action=="delete"&&t.id!==undefined){for(var i=0,n=u.servicedesks.length;i<n;i++){if(t.id==u.servicedesks[i].id){u.servicedesks.splice(i,1);break}}}else{angular.forEach(u.servicedesks,function(e){if(e.id==t.id){e=o.detail.servicedesks.get(t.id)}})}});a.register(d,a.constant.EVENT_PHONE_TRANSFER_PANEL,function(e,t){if(angular.isDefined(t)&&t.hasOwnProperty("showTransferPanel")&&t.showTransferPanel){g();u.lastSearchParams={};u.search()}});a.register(d,a.constant.EVENT_CTI_HELD_SUCCESS,function(e,t){u.heldSuccess=true});a.register(d,a.constant.EVENT_CTI_HANGUP,function(e,t){if(angular.isDefined(t)&&t.hasOwnProperty("type")){if(t.type=="transfer"&&u.blindTransfered){var i=l.getCtiChatId();l.closeChatFn(i,"close_chat",function(e){a.doNotify(a.constant.EVENT_PHONE_SIPCALL_PANEL,{showPhoneSipcallPanel:false});a.doNotify(a.constant.EVENT_PHONE_TRANSFER_PANEL,{showTransferPanel:false});a.doNotify(a.constant.EVENT_MAIN_DIAL_PANEL,{showMainDialPanel:true});l.reverseStatus(function(e){c.setUserState(e)});a.doNotify(a.constant.EVENT_PHONE_SIPCALL_RECORD_TICKET_PANEL,{showRecordTicketPanel:false,hideRecordTicketPanel:true})})}}})};var _=function(){a.unRegister(d)};var h=function(){m();p()};u.back=function(){a.doNotify(a.constant.EVENT_PHONE_TRANSFER_PANEL,{showTransferPanel:false});a.doNotify(a.constant.EVENT_MAIN_DIAL_PANEL,{showMainDialPanel:false});a.doNotify(a.constant.EVENT_PHONE_SIPCALL_PANEL,{showPhoneSipcallPanel:true,isKeepPhone:false});a.doNotify(a.constant.EVENT_PHONE_TRANSFER_PANEL,{backToSipCall:true,isKeepPhone:false});a.doNotify(a.constant.EVENT_PHONE_SIPCALL_RECORD_TICKET_PANEL,{showRecordTicketPanel:false,hideRecordTicketPanel:true});c.stateCancel()};h();t.$on("$destory",_)}t.$inject=[];function t(){return{restrict:"EA",scope:{},templateUrl:"/source/ewei-phone/template/ewei-phone-transfer-engineer-select.html",controller:"PhoneTransferEngineerSelectController",controllerAs:"vm"}}})();(function(){"use strict";angular.module("eweiApp.common").directive("sipCall",function(){return{restrict:"EA",scope:{sipCallMutil:"=",backToSipCall:"=",incoming:"=",mutilSuccess:"="},templateUrl:"source/ewei-phone/template/sip_call.html",controller:"sipCallCtr",link:function(e,t,i){e.supportMute=true;var n=["ME","NT","2000","XP","Vista"];if($.ua.os.name=="Windows"&&n.indexOf($.ua.os.version)>-1){e.supportMute=false}}}}).controller("sipCallCtr",["$scope","$rootScope","coreNotifyService","apiCtiUserByPhoneService","telNumService","ctiSipService","eweiPhoneService","createSessionFailService","EweiConfig","mutilListService","coreModelService",function(o,e,a,r,i,s,c,t,n,l,u){var d=this.__proto__.constructor.name+"_"+(new Date).valueOf();var f=true;o.call={calling:false,hangup:false,status:"正在拨号"};if(o.incoming){o.call.status="通话正在连接"}var p=c.getCallIdentity();if(p==undefined||p==null||p.identity==undefined||p.identity=="normal.invite"){o.callType="normal"}else{o.callType=p.identity}function g(){a.register(d,a.constant.EVENT_CTI_CONNECTED,function(e,t){void 0;if(t.type=="normal"){o.call.calling=true;o.call.status="通话中";if(!o.callType){o.callType="normal"}}if(angular.isDefined(t)&&t.type=="transfer"&&t.info&&t.info.length>0){void 0;o.user=t.info[0].user;i.setTelNum(o.user.phoneNumber);o.call.calling=true;o.call.status="通话中";o.callType="normal";c.setTransferStatus(false)}});a.register(d,a.constant.EVENT_CTI_HANGUP,function(e,t){if(t.type=="normal"){o.call.hangup=true;o.call.status="通话结束";if(!f){if(u.detail.ctis.get(u.config.activeCtiID).voiceSystem=="sip"){c.reverseStatus(function(e){s.setUserState(e)})}}var i=document.getElementById("sipHangupSound");i&&i.play()}if(t.type=="multi"){if(o.mutilSuccess){if("host"==t.direct){a.doNotify(a.constant.EVENT_MAIN_DIAL_PANEL,{showMainDialPanel:false});a.doNotify(a.constant.EVENT_PHONE_MUTIL_PANEL,{showEweiPhoneMutil:true,isMutilPanel:true})}}else{o.sipCallMutil=false;o.call.calling=true;o.call.status="通话中";a.doNotify(a.constant.EVENT_PHONE_MUTIL_PANEL,{calling:true});var n=c.getHostTelNum();r.run(a.constant.EVENT_FIND_PEOPLE_INFO,1,"",{phone:n},function(e){o.user={};if(e.status==0){o.user=e.result.users[0]}o.user.phoneNumber=n;a.doNotify(a.constant.EVENT_PHONE_MUTIL_PANEL,{user:o.user})})}}});a.register(d,a.constant.EVENT_CTI_CALL_FAILED,function(e,t){o.call.hangup=true;o.call.failure=true;o.call.status="呼出失败"});a.register(d,a.constant.EVENT_PHONE_MUTIL_PANEL,function(e,t){if(t.backToSipCall){o.call.calling=true;o.call.status="通话中";o.canHangup=true;o.isKeepPhone=t.isKeepPhone;i.getTelNum()}if(t.callIsEnd){o.call.hangup=true;o.call.status="通话结束";c.setHeld(false)}});a.register(d,a.constant.EVENT_PHONE_TRANSFER_PANEL,function(e,t){if(angular.isDefined(t.backToSipCall)){if(t.hangup){o.call.hangup=true;o.call.status="通话结束"}else{o.call.calling=true;o.call.status="通话中";o.call.canHangup=true;o.calling=true;o.canHangup=true;o.isKeepPhone=false;o.user={phoneNumber:i.getTelNum()}}}});a.register(d,a.constant.EVENT_PHONE_CREATE_TICKET,function(e,t){f=t.noTicket});a.register(d,a.constant.EVENT_UBOX_CALLIN_TIP,function(e,t){o.tipShow=t.tipShow;o.newNumber=t.tel});a.register(d,a.constant.EVENT_UBOX_CLOSE_CALLIN_TIP,function(e,t){o.tipShow=false})}o.keepPhone=function(){if(!o.isKeepPhone){o.call.status="通话保持";s.startHeld(i.getTelNum())}else{o.call.status="通话中";s.stopHeld(i.getTelNum())}o.isKeepPhone=!o.isKeepPhone};o.isMutePhone=s.getMute();o.mutePhone=function(){s.setMute();o.isMutePhone=s.getMute()};o.callMutil=function(){if(i.getTelNum()){c.setHostTelNum(i.getTelNum())}a.doNotify(a.constant.EVENT_PHONE_MUTIL_PANEL,{canInvite:true});a.doNotify(a.constant.EVENT_MAIN_DIAL_PANEL,{showMainDialPanel:true,isMutil:true,isKeepPhone:o.isKeepPhone,isSipCall:true});a.doNotify(a.constant.EVENT_PHONE_SIPCALL_PANEL,{showPhoneSipcallPanel:false});s.multi()};o.callTransfer=function(){if(i.getTelNum()){c.setHostTelNum(i.getTelNum())}a.doNotify(a.constant.EVENT_PHONE_TRANSFER_PANEL,{showTransferPanel:true,isKeepPhone:o.isKeepPhone});a.doNotify(a.constant.EVENT_MAIN_DIAL_PANEL,{showMainDialPanel:false});a.doNotify(a.constant.EVENT_PHONE_SIPCALL_PANEL,{showPhoneSipcallPanel:false});s.transfer()};o.cancel=function(){if(o.sipCallMutil){if(o.mutilSuccess){a.doNotify(a.constant.EVENT_PHONE_SIPCALL_PANEL,{showPhoneSipcallPanel:false});a.doNotify(a.constant.EVENT_PHONE_MUTIL_PANEL,{showEweiPhoneMutil:true,isMutilPanel:true})}else{o.call={calling:true,hangup:false,status:"通话中",failure:false};o.canHangup=true;o.calling=true;o.backToSipCall=true;o.sipCallMutil=false;s.stateCancel();a.doNotify(a.constant.EVENT_PHONE_MUTIL_PANEL,{initUserInfo:true})}}else{a.doNotify(a.constant.EVENT_PHONE_SIPCALL_PANEL,{showPhoneSipcallPanel:false});a.doNotify(a.constant.EVENT_MAIN_DIAL_PANEL,{showMainDialPanel:true})}};o.callReturn=function(){r.run(a.constant.EVENT_FIND_PEOPLE_INFO,1,"",{phone:i.getTelNum()},function(e){var t=null;if(e.status==0){t=e.result.users[0]}s.callout(i.getTelNum());s.setUser(i.getTelNum(),t);o.call={calling:false,hangup:false,status:"正在拨号",failure:false};o.canHangup=false})};function m(){a.unRegister(d)}o.$on("$destroy",function(){m()});function _(){g()}_()}])})(angular);(function(){"use strict";angular.module("eweiApp.common").directive("sipKeyboard",function(){return{restrict:"EA",templateUrl:"source/ewei-phone/template/sip-keyboard.html",controller:"sipKeyboardCtr"}}).controller("sipKeyboardCtr",["$scope","coreNotifyService","apiCtiUserByPhoneService","telNumService","ctiSipService","eweiPhoneService","mutilListService",function(i,n,o,a,r,s,c){var e=this.__proto__.constructor.name+"_"+(new Date).valueOf();var l=s.getCallIdentity();if(l==undefined||l==null||l.identity==undefined||l.identity=="normal.invite"){i.callType="normal"}else{i.callType=l.identity}if(i.incoming){i.canHangup=true}i.toggleNumberPanel=function(){i.showNumberPanel=!i.showNumberPanel};i.hangup=function(){var e=a.getTelNum();if(i.sipKeyboardMuitl&&s.getHostTelNum()){e=s.getHostTelNum()}if(i.sipKeyboardMuitl){i.vm.mutilIsEnd=true}r.hangup(e);if(i.sipCallMutil){if(i.mutilSuccess){n.doNotify(n.constant.EVENT_PHONE_SIPCALL_PANEL,{showPhoneSipcallPanel:false});n.doNotify(n.constant.EVENT_PHONE_MUTIL_PANEL,{showEweiPhoneMutil:true,isMutilPanel:true})}else{i.sipCallMutil=false;i.call.calling=true;i.call.status="通话建立";n.doNotify(n.constant.EVENT_PHONE_MUTIL_PANEL,{calling:true});var t=s.getHostTelNum();o.run(n.constant.EVENT_FIND_PEOPLE_INFO,1,"",{phone:t},function(e){i.user={};if(e.status==0){i.user=e.result.users[0]}i.user.phoneNumber=t;n.doNotify(n.constant.EVENT_PHONE_MUTIL_PANEL,{user:i.user})})}}else{if(!i.calling){n.doNotify(n.constant.EVENT_PHONE_SIPCALL_PANEL,{showPhoneSipcallPanel:false});n.doNotify(n.constant.EVENT_MAIN_DIAL_PANEL,{showMainDialPanel:true})}c.clearMutilList()}};i.clickNum=function(e){r.dialNum(e);n.doNotify(n.constant.EVENT_PHONE_SIPCALL_CHANGE_NUMBER,{number:e})};i.goRecordTicket=function(){n.doNotify(n.constant.EVENT_PHONE_SIPCALL_RECORD_TICKET_PANEL,{showRecordTicketPanel:true,hideRecordTicketPanel:false})};function t(){n.register(e,n.constant.EVENT_CTI_CONNECTED,function(e,t){void 0;if(l&&l.identity=="multi.invite"){i.canHangup=false}else{i.canHangup=true}if(t.type=="normal"){i.calling=true}if(angular.isDefined(t)&&t.type=="transfer"&&t.info&&t.info.length>0){i.callType="normal"}});n.register(e,n.constant.EVENT_PHONE_MUTIL_PANEL,function(e,t){if(t.calling){i.calling=true}});n.register(e,n.constant.EVENT_CTI_HANGUP_ENABLE,function(e,t){i.canHangup=true})}function u(){n.unRegister(e)}i.$on("$destroy",function(){u()});function d(){t()}d()}])})(angular);(function(){"use strict";angular.module("eweiApp.common").directive("ctiUserInfo",function(){return{restrict:"EA",scope:{backToSipCall:"="},templateUrl:"source/ewei-phone/template/cti-user-info.html",controller:"ctiUserInfoCtr"}}).controller("ctiUserInfoCtr",["$scope","coreNotifyService","apiCtiUserByPhoneService","telNumService","ctiSipService","eweiPhoneService","ctiUsbService","$state",function(n,t,e,o,i,a,r,s){var c=this.__proto__.constructor.name+"_"+(new Date).valueOf();var l="";function u(){a.setUser(null);n.user={};if(n.backToSipCall){l=a.getHostTelNum()}else{l=o.getTelNum()}e.run(t.constant.EVENT_FIND_PEOPLE_INFO,1,"",{phone:l},function(e){if(e.status==0){if(e.result.recentContactUser){n.user=e.result.recentContactUser;a.setUser({id:n.user.id,name:n.user.name})}else if(e.result.users&&e.result.users.length>0){n.user=e.result.users[0];a.setUser({id:n.user.id,name:n.user.name})}else{n.user={name:l}}r.setUser(l,n.user);t.doNotify(t.constant.EVENT_PHONE_USB_CREATE_TICKET,{telNum:l});n.user.phoneNumber=l}t.doNotify(t.constant.EVENT_PHONE_MUTIL_PANEL,{user:n.user});i.setUser(l,n.user);void 0})}function d(){t.register(c,t.constant.EVENT_PHONE_SIPCALL_CHANGE_NUMBER,function(e,t){n.user.phoneNumber+=t.number});t.register(c,t.constant.EVENT_PHONE_CHANGE_CHAT_USER,function(e,t){n.user=t.user});t.register(c,t.constant.EVENT_PHONE_RESET_USERINFO,function(e,t){u()});t.register(c,t.constant.EVENT_PHONE_MUTIL_PANEL,function(e,t){if(t&&t.user){n.user=t.user;o.setTelNum(n.user.phoneNumber)}if(t&&t.initUserInfo){u()}});t.register(c,t.constant.EVENT_CTI_CONNECTED,function(e,t){void 0;if(angular.isDefined(t)&&t.type=="transfer"&&t.info&&t.info.length>0){n.user=t.info[0].user;o.setTelNum(n.user.phoneNumber);a.setUser(n.user)}else{var i=a.getUser();if(i){n.user.id=i.id;n.user.name=i.name}}})}n.showCustomer=function(){if(n.user&&n.user.id&&n.user.type!="engineer"){s.go("customers_detail",{id:n.user.id},{reload:true})}};function f(){t.unRegister(c)}n.$on("$destroy",function(){f()});function p(){d();u()}p()}])})(angular);(function(e){e.module("eweiApp.common").directive("recordTicket",function(){return{restrict:"EA",replace:true,templateUrl:"/source/ewei-phone/template/record-ticket.html",controller:t}}).controller("recordTicketController",t);t.$inject=["$scope","$state","coreNotifyService","telNumService","apiCtiUserByPhoneService","chatRelatedTicketsService","alertService","permissions","apiRestfulService","eweiPhoneService","ctiSipService","$http","coreModelService","ConsoleConfig","mutilListService","recordlogService"];function t(r,e,s,c,l,i,t,o,a,u,d,f,p,n,g,m){var _=this.__proto__.constructor.name+"_"+(new Date).valueOf();r.location="recordTicket";r.noTicket=true;m.log("record-ticket.js chat_detail request chatId:"+u.getCtiChatId());f({url:"chat_detail/"+u.getCtiChatId()+".json",method:"get"}).success(function(e){if(e.json.ticket){m.log("record-ticket.js chat_detail response ticket; user.name:"+e.json.user.name);r.selectDisabled=true;r.listHide=true;r.users=[{id:e.json.user.id,name:e.json.user.name}];r.userTickets.user=e.json.user.id;r.userTickets.group=e.json.user.userGroup;r.ticketDetail="#"+e.json.ticket.no+" "+e.json.ticket.subject;r.ticketId=e.json.ticket.id;r.newUser=e.json.user;s.doNotify(s.constant.EVENT_PHONE_CREATE_TICKET,{noTicket:false});if(p.detail.ctis.get(p.config.activeCtiID).voiceSystem=="sip"){u.reverseStatus(function(e){d.setUserState(e)})}}else{if(c.getTelNum()===""){m.log("record-ticket.js chat_detail response no ticket and no telNum; user.name:"+e.json.user.name);r.users=[{id:e.json.user.id,name:e.json.user.name}];r.userTickets.user=e.json.user.id}else{m.log("record-ticket.js chat_detail response no ticket and has telNum; user.name:"+e.json.user.name);h(e.json.user.id)}}});function h(i){var e=g.getMutilList();var t="",n=null,o="";if(e&&e.length>2){for(var a=0;a<e.length;a++){if(e[a].telFirst){t=e[a].phoneNumber;n=e[a].id;o=e[a].userGroup;r.newUser=e[a];break}}m.log("record-ticket.js getUserInfo mutilListService has list phoneNumber:"+t)}else{m.log("record-ticket.js getUserInfo mutilListService no list phoneNumber:"+t);t=c.getTelNum()}l.run(s.constant.EVENT_FIND_PEOPLE_INFO,1,"",{phone:t},function(e){r.users=e.result.users;if(n){r.userTickets.user=n;if(o){r.userTickets.group=o}m.log("record-ticket.js apiCtiUserByPhoneService has userId:"+n)}else{if(e.result.users){if(e.result.users.length>1){m.log("record-ticket.js apiCtiUserByPhoneService response users.length>1");for(var t=0;t<e.result.users.length;t++){if(e.result.users[t].id==i){r.userTickets.user=e.result.users[t].id;if(e.result.users[t].userGroup){r.userTickets.group=e.result.users[t].userGroup}r.newUser=e.result.users[t];break}}}else{m.log("record-ticket.js apiCtiUserByPhoneService response users.length=0");r.userTickets.user=e.result.users[0].id;r.newUser=e.result.users[0];if(e.result.users[0].userGroup){r.userTickets.group=e.result.users[0].userGroup}}}}v(r.userTickets.user)})}r.userTickets={page:1,count:5,total:0,group:"-"};r.isLoad=false;function v(e,t){m.log("record-ticket.js getUserTickets request requesterId:"+e);i.run({_page:r.userTickets.page,_count:r.userTickets.count,_fields:"id,no,subject,createdAt,updatedAt,status,engineer.user.name,serviceDesk.name",_filter:{$and:[{$eq:{"requester.id":e}},{$in:{status:["new","open","pending"]}}]},_asc:"",_desc:"updatedAt",searchType:"nonCurrentUser"},{},true,function(e){if(e._total>5&&e.tickets.length==5){r.isLoad=true}else{r.isLoad=false}if(t){r.userTickets.list=r.userTickets.list.concat(e.tickets)}else{r.userTickets.list=e.tickets}})}r.closeChat=function(){u.closeChatFn(u.getCtiChatId(),"close_chat",function(e){});u.setCtiChatId("");s.doNotify(s.constant.EVENT_CTI_CALLIN,{telNum:r.newNumber});r.tipModal=false};r.changeUser=function(t){for(var e=0;e<r.users.length;e++){if(r.users[e].id==t){r.userTickets={page:1,count:5,total:0,group:r.users[e].userGroup?r.users[e].userGroup:"",user:t};r.newUser=r.users[e];break}}r.isLoad=false;f({url:"update_chat_user/"+u.getCtiChatId()+"/"+t+".json",method:"POST"}).success(function(e){if(!e.success){if(e.message=="chat_is_null"){void 0}else if(e.message=="chat_user_is_engineer"){void 0}else if(e.message=="user_is_null"){void 0}else{void 0}}else{s.doNotify(s.constant.EVENT_PHONE_CHANGE_CHAT_USER,{user:r.newUser})}v(t)})};r.goBack=function(){r.hideRecordTicketPanel=true};r.getMore=function(){r.userTickets.page+=1;v(r.userTickets.user,"more")};r.associated=function(e){r.modal=true;r.ticketNo=e.no;r.ticketId=e.id;r.ticketSubject=e.subject};r.ticketDetail="-";r.disabled=false;r.chainChatToTicket=function(i){if(!o.hasPermission("ticket_create")){s.doNotify(s.constant.EVENT_JUDGE_CALL_OUT,{message:"您没有创建工单的权限"});return}var n={};if(i){n={ticketId:i}}else{n={subject:r.subject};if(r.template.id){n.ticketTemplateId=r.template.id}if(!r.subject){return}}m.log("record-ticket.js  chainChatToTicket chat_detail param chatid:"+u.getCtiChatId());r.disabled=true;f({url:"chat_detail/"+u.getCtiChatId()+".json",method:"get"}).success(function(e){if(e.json.ticket){m.log("record-ticket.js chainChatToTicket chat_detail has ticket user.name:"+e.json.user.name);void 0;r.selectDisabled=true;r.listHide=true;r.modal=false;r.subjectModal=false;r.users=[{id:e.json.user.id,name:e.json.user.name}];r.userTickets.user=e.json.user.id;r.userTickets.group=e.json.user.userGroup;r.ticketDetail="#"+e.json.ticket.no+" "+e.json.ticket.subject;r.ticketId=e.json.ticket.id;s.doNotify(s.constant.EVENT_PHONE_CREATE_TICKET,{noTicket:false});r.noTicket=false;if(d.getCallIsHangup()){if(p.detail.ctis.get(p.config.activeCtiID).voiceSystem=="sip"){u.reverseStatus(function(e){d.setUserState(e)})}}}else{var t={url:"api/v1/chat_to_ticket/"+u.getCtiChatId()+".json",urlParam:"",dataParam:n};m.log("record-ticket.js chainChatToTicket chat_detail has no ticket chatid:"+u.getCtiChatId());a.run(t).put(t.dataParam,function(e){r.disabled=false;if(e.status==0){T();if(i){r.ticketDetail="# "+r.ticketNo+" "+r.ticketSubject}else{r.ticketDetail="#"+e.result.ticketNo+" "+r.subject;r.ticketId=e.result.ticketId}r.selectDisabled=true;r.modal=false;r.subjectModal=false;r.listHide=true;if(d.getCallIsHangup()){if(p.detail.ctis.get(p.config.activeCtiID).voiceSystem=="sip"){u.reverseStatus(function(e){d.setUserState(e)})}}r.noTicket=false;s.doNotify(s.constant.EVENT_PHONE_CREATE_TICKET,{noTicket:false})}})}})};function E(){r.template={id:"",name:"不使用模板"};var e={url:"api/ticket_template.json",urlParam:{_count:1e3,_asc:"orderKey",_filter:"{'$and':[{'$or':[{'$eq':{'engineer.id':"+n.engineer.id+"}},{'$is_null':'engineer.id'}]},{'$ne':{'active':false}}]}"},dataParam:""};a.run(e).get(e.urlParam,function(e){if(e.status==0){r.templates=e.result.ticketTemplates;r.templates.unshift({id:"",name:"不使用模板"})}})}r.noTemplate=true;r.selectTemplate=function(e,t){if(t==0){r.noTemplate=true}else{r.noTemplate=false}r.template=e;r.clicked=!r.clicked};function T(){f({url:"close_chat/"+u.getCtiChatId()+".json",method:"GET",params:{quitUserId:n.user.id,closeAction:"go_ticket"}}).success(function(e){if(e.success){}r.disabled=false})}r.goTicketDetail=function(){if(r.ticketId){e.go("tickets_detail",{id:r.ticketId})}};function y(){s.register(_,s.constant.EVENT_PHONE_SIPCALL_RECORD_TICKET_PANEL,function(e,t){r.hideRecordTicketPanel=t.hideRecordTicketPanel});s.register(_,s.constant.EVENT_UBOX_CALLIN_TIP,function(e,t){r.tipShow=t.tipShow;r.newNumber=t.tel});s.register(_,s.constant.EVENT_UBOX_CLOSE_CALLIN_TIP,function(e,t){r.tipShow=false;r.tipModal=false});s.register(_,s.constant.EVENT_UBOX_CALLIN_TIP_CONFIRM,function(e,t){r.tipModal=t.tipModal})}function N(){s.unRegister(_)}r.$on("$destroy",function(){N()});function S(){y();E()}S()}})(angular);(function(e){e.module("eweiApp.common").directive("ctiPlayScreen",function(){return{restrict:"EA",replace:true,templateUrl:"/source/ewei-phone/template/cti-play-screen.html",controller:"ctiPlayScreenCtr"}}).controller("ctiPlayScreenCtr",t);t.$inject=["$scope","$rootScope","coreNotifyService","telNumService","apiCtiUserByPhoneService","ctiSipService","$timeout","eweiPhoneService","EweiConfig","alertService","createSessionFailService"];function t(e,t,i,n,o,a,r,s,c,l,u){var d=this.__proto__.constructor.name+"_"+(new Date).valueOf();function f(){}e.hangup=function(){a.hangup(n.getTelNum());i.doNotify(i.constant.EVENT_PHONE_CLOSE_PLAYSCREEN);i.doNotify(i.constant.EVENT_PHONE_PANEL,{showPhonePanel:false})};e.pickup=function(){a.pickup(n.getTelNum());i.doNotify(i.constant.EVENT_PHONE_SIPCALL_PANEL,{showPhoneSipcallPanel:true,incoming:true});i.doNotify(i.constant.EVENT_MAIN_DIAL_PANEL,{showMainDialPanel:false})};function p(){i.unRegister(d)}e.$on("$destroy",function(){p()});function g(){}function m(){f();g()}m()}})(angular);(function(e){e.module("eweiApp.common").controller("eweiPhoneMutilController",t).directive("eweiPhoneMutil",i);t.$inject=["$scope","coreNotifyService","coreModelService","ConsoleConfig","mutilListService","ctiSipService","eweiPhoneService"];function t(e,u,t,d,f,i,p){var n=this.__proto__.constructor.name+"_"+(new Date).valueOf();var g=this;g.currentUserId=d.user.id;o();function o(){r();a()}function a(){g.mutilList=f.getMutilList();g.mutilIsEnd=false;g.canInvite=false;e.sipKeyboardMuitl=true;g.picHostName="http://ewei-web-saas.ewei.com/";if(d.enviroment=="Test"){g.picHostName="http://ewei-web-upload-test.ewei.com/"}else if(d.enviroment=="dev"){g.picHostName="http://webdev.cdn.itkeeping.com/"}}function r(){u.register(n,u.constant.EVENT_CTI_HANGUP,function(e,t){if(!g.mutilIsEnd&&t&&g.mutilList.length>0){if("invite"==t.direct){if(t.telNum==g.mutilList[g.mutilList.length-1].phoneNumber){p.setHeld(true)}var i=-1;for(var n=0;n<g.mutilList.length;n++){if(g.mutilList[n].phoneNumber==t.telNum){i=n;break}}if(i>-1){g.mutilList.splice(i,1);f.setMutilList(g.mutilList)}}else{g.mutilIsEnd=true;p.setHeld(false);u.doNotify(u.constant.EVENT_PHONE_MUTIL_PANEL,{showEweiPhoneMutil:true,isMutilPanel:true});u.doNotify(u.constant.EVENT_PHONE_SIPCALL_PANEL,{showPhoneSipcallPanel:false});u.doNotify(u.constant.EVENT_MAIN_DIAL_PANEL,{showMainDialPanel:false})}}if(t&&"multi"==t.type&&"host"==t.direct){u.doNotify(u.constant.EVENT_MAIN_DIAL_PANEL,{showMainDialPanel:false});u.doNotify(u.constant.EVENT_PHONE_SIPCALL_PANEL,{showPhoneSipcallPanel:true});u.doNotify(u.constant.EVENT_PHONE_MUTIL_PANEL,{callIsEnd:true})}});u.register(n,u.constant.EVENT_CTI_CONNECTED,function(e,t){if(!g.mutilIsEnd&&t&&"multi"==t.type){var i=[];var n=null;var o="";for(var a=0;a<t.info.length;a++){n=t.info[a].user;if(Object.prototype.toString.call(n.photo)=="[object Object]"){o=n.photo.contentUrl}else{o=n.photo}if(o){if(o.indexOf(g.picHostName)<=-1&&o.indexOf("/source/ewei-phone/images/portrait.png")<=-1){n.photo=g.picHostName+o}}else{n.photo="/source/ewei-phone/images/portrait.png"}i.push(n)}g.mutilList=i;f.setMutilList(g.mutilList);var r=d.user.id;var s=null;var c="";for(var l=0;l<g.mutilList.length;l++){s=g.mutilList[l];c=s.name?s.name:s.nickname;if(c.indexOf("(我)")>-1){s.name=c.replace("(我)","")}if(s.id==r){g.mutilList.splice(l,1);if(c.indexOf("(我)")<=-1){s.name="(我)"+c}g.mutilList.unshift(s)}}p.setHeld(false);u.doNotify(u.constant.EVENT_PHONE_MUTIL_PANEL,{showEweiPhoneMutil:true,isMutilPanel:true});u.doNotify(u.constant.EVENT_PHONE_SIPCALL_PANEL,{showPhoneSipcallPanel:false})}});u.register(n,u.constant.EVENT_PHONE_MUTIL_PANEL,function(e,t){if(!g.mutilIsEnd&&t&&t.canInvite){g.canInvite=true}});u.register(n,u.constant.EVENT_CTI_CALL_FAILED,function(e,t){if(!g.mutilIsEnd&&t&&t.telNum&&"multi"==t.type){var i=-1;for(var n=0;n<g.mutilList.length;n++){if(g.mutilList[n].phoneNumber==t.telNum){i=n;break}}if(i>-1){g.mutilList.splice(i,1);f.setMutilList(g.mutilList)}}});u.register(n,u.constant.EVENT_CTI_HELD_SUCCESS,function(e,t){p.setHeld(true)})}g.invite=function(){if(g.mutilList.length>=5){u.doNotify(u.constant.EVENT_JUDGE_CALL_OUT,{message:"多方通话最多同时在线5人!"});return}u.doNotify(u.constant.EVENT_MAIN_DIAL_PANEL,{showMainDialPanel:true,isMutil:true,isSipCall:false,mutilSuccess:true});u.doNotify(u.constant.EVENT_PHONE_MUTIL_PANEL,{showEweiPhoneMutil:false,isMutilPanel:true})};e.$on("$destroy",function(){s()});g.createTicket=function(){u.doNotify(u.constant.EVENT_PHONE_SIPCALL_RECORD_TICKET_PANEL,{showRecordTicketPanel:true,hideRecordTicketPanel:false})};g.closeSip=function(){if(g.canInvite){p.closeChatFn(p.getCtiChatId(),"close_chat",function(e){})}p.setCtiChatId("");f.clearMutilList();p.setHostTelNum("");g.mutilList.length=0;i.setUserState("online");g.mutilIsEnd=false;p.setHeld(false);u.doNotify(u.constant.EVENT_PHONE_SIPCALL_RECORD_TICKET_PANEL,{showRecordTicketPanel:false,hideRecordTicketPanel:true});u.doNotify(u.constant.EVENT_MAIN_DIAL_PANEL,{showMainDialPanel:true,isMutil:false});u.doNotify(u.constant.EVENT_PHONE_SIPCALL_PANEL,{showPhoneSipcallPanel:false});u.doNotify(u.constant.EVENT_PHONE_MUTIL_PANEL,{showEweiPhoneMutil:false,isMutilPanel:true})};function s(){u.unRegister(n)}g.isMutePhone=i.getMute();g.mutePhone=function(){i.setMute();g.isMutePhone=i.getMute()}}i.$inject=[];function i(){return{restrict:"EA",replace:true,scope:{},templateUrl:"/source/ewei-phone/template/ewei-phone-mutil.html",controller:t,controllerAs:"vm",link:function(e,t,i){e.supportMute=true;var n=["ME","NT","2000","XP","Vista"];if($.ua.os.name=="Windows"&&n.indexOf($.ua.os.version)>-1){e.supportMute=false}}}}})(angular);(function(e){e.module("eweiApp.common").controller("dialMutilHeaderController",t).directive("dialMutilHeader",i);t.$inject=["$scope","coreNotifyService","telNumService","ctiSipService"];function t(e,t,i,n){var o=this;o.isKeepPhone=e.isKeepPhone;o.telNum=i.getTelNum();o.back=function(){t.doNotify(t.constant.EVENT_MAIN_DIAL_PANEL,{showMainDialPanel:false});if(e.isSipCall){t.doNotify(t.constant.EVENT_PHONE_SIPCALL_PANEL,{showPhoneSipcallPanel:true,isMutil:false,isKeepPhone:e.isKeepPhone,backToSipCall:true});t.doNotify(t.constant.EVENT_PHONE_MUTIL_PANEL,{backToSipCall:true,isKeepPhone:e.isKeepPhone});n.stateCancel()}else{t.doNotify(t.constant.EVENT_PHONE_MUTIL_PANEL,{showEweiPhoneMutil:true,isMutilPanel:true})}}}i.$inject=[];function i(){return{restrict:"EA",replace:true,scope:{isKeepPhone:"=",isSipCall:"="},templateUrl:"/source/ewei-phone/template/dial-mutil-header.html",controller:t,controllerAs:"vm"}}})(angular);!function(e){e.module("eweiApp.common").directive("alertTipCommon",t).controller("alertTipCommonController",i);t.$inject=[];function t(){return{restrict:"EA",replace:true,templateUrl:"/source/ewei-phone/template/alert-tip-common.html",controller:i,controllerAs:"atc"}}i.$inject=["coreNotifyService","$scope","$timeout"];function i(e,t,i){var n=this;var o=n.__proto__.constructor.name+"_"+(new Date).valueOf();n.cancelMessage=function(){n.message=null};function a(){e.register(o,e.constant.EVENT_JUDGE_CALL_OUT,function(e,t){n.message=t.message;i(function(){n.message=null},5e3)})}function r(){e.unRegister(o)}t.$on("$destroy",function(){r()});function s(){a()}s()}}(angular);(function(e){e.module("eweiApp.common").controller("dialIconController",t).directive("dialIcon",i);t.$inject=["$scope","permissions","ctiUsbService","ctiSipService","$rootScope","coreNotifyService","coreModelService","closeSelfChatService","ConsoleConfig","eweiPhoneService","providerJudgement","apiRestfulService"];function t(e,t,i,n,o,a,r,s,c,l,u,d){var f=this;var p=f.__proto__.constructor.name+"_"+(new Date).valueOf();f.showPhonePanel=false;f.popTelDial=function(){if(!u.isTrue()){return false}f.isInstallApp=o.isInstallApplication;if(!f.isInstallApp){a.doNotify(a.constant.EVENT_TIP_PANEL,{installApp:!f.isInstallApp});return false}if(t.hasPermission("chat_call_out")){f.viaSettingAuthorized=true}else{f.viaSettingAuthorized=false;a.doNotify(a.constant.EVENT_TIP_PANEL,{viaSettingAuthorized:f.viaSettingAuthorized});return false}f.viaCtiCount=r.detail.ctis.total();a.doNotify(a.constant.EVENT_TIP_PANEL,{viaCtiCount:f.viaCtiCount});if(f.viaCtiCount<=0){return false}r.other.cti.missCallCount=0;a.doNotify(a.constant.EVENT_TIP_PANEL,{missCallCount:r.other.cti.missCallCount});f.showPhonePanel=!f.showPhonePanel;if(n.getStarted()||i.getStarted()){}else{a.doNotify(a.constant.EVENT_PHONE_STATUS,{type:"offline"})}a.doNotify(a.constant.EVENT_PHONE_PANEL,{showPhonePanel:f.showPhonePanel})};function g(){s({pageNo:1,pageSize:99999,searchKey:""},"","",function(e){void 0;if(e.result._total<=0){return false}for(var t=0;t<e.result.chats.length;t++){if(e.result.chats[t].clientType=="USB_PHONE"&&e.result.chats[t].engineer.user.id==c.user.id){l.closeChatFn(e.result.chats[t].id,"close_chat",function(e){})}}void 0})}function m(){a.register(p,a.constant.EVENT_CTI_ERROR,function(e,t){l.setUBoxError(t.type);a.doNotify(a.constant.EVENT_PHONE_STATUS,{type:i.getUserState()})});a.register(p,a.constant.EVENT_UBOX_CANCEL_ERROR,function(e,t){l.setUBoxError(null);f.warntip=false;a.doNotify(a.constant.EVENT_PHONE_STATUS,{type:i.getUserState()})});a.register(p,a.constant.EVENT_CTI_MISS_CALL,function(e,t){var i=parseInt(r.other.cti.missCallCount);++i;r.other.cti.missCallCount=i;a.doNotify(a.constant.EVENT_TIP_PANEL,{missCallCount:r.other.cti.missCallCount});void 0});a.register(p,a.constant.EVENT_CTI_SIP_CONFIG,function(e,t){void 0;void 0;l.setSipPhoneConfig(t);f.config=l.getSipPhoneConfig();a.doNotify(a.constant.EVENT_CONFIG_COMPLETE);var i={url:"api/v1/engineers/sip_login.json",urlParam:"",dataParam:{sipAccount:f.config["SipProfiles/0/Lines/0"].Username}};if(n.getStarted()&&n.getUserState()!="offline"){d.run(i).put(i.dataParam,function(e){if(e.status!=0){void 0}else if(e.status==0){void 0}})}});a.register(p,a.constant.EVENT_PHONE_PANEL,function(e,t){f.showPhonePanel=t.showPhonePanel})}function _(){a.unRegister(p)}e.$on("$destroy",function(){_()});function h(){m();g()}h();e.$on("active-global-panel",function(e,t){a.doNotify(a.constant.EVENT_PHONE_PANEL,{showPhonePanel:false})})}i.$inject=[];function i(){return{restrict:"EA",replace:true,scope:{},templateUrl:"/source/ewei-phone/template/dial-icon.html",controller:t,controllerAs:"vm"}}})(angular);(function(){"use strict";angular.module("eweiApp.common").directive("phoneCallinTip",function(){return{restrict:"EA",templateUrl:"source/ewei-phone/template/phone-callin-tip.html",controller:"phoneCallinTipCtr"}}).controller("phoneCallinTipCtr",["$scope","searchChatDetailService","coreNotifyService","telNumService","ctiSipService","eweiPhoneService",function(e,t,i,n,o,a){var r=this.__proto__.constructor.name+"_"+(new Date).valueOf();var s=true;e.goNewCall=function(){if(e.location&&e.noTicket){i.doNotify(i.constant.EVENT_UBOX_CALLIN_TIP_CONFIRM,{tipModal:true})}else{if(s){a.closeChatFn(a.getCtiChatId(),"close_chat",function(e){})}a.setCtiChatId("");i.doNotify(i.constant.EVENT_CTI_CALLIN,{telNum:e.newNumber})}};function c(){i.register(r,i.constant.EVENT_PHONE_CREATE_TICKET,function(e,t){s=t.noTicket})}function l(){i.unRegister(r)}e.$on("$destroy",function(){l()});function u(){c()}u()}])})(angular);!function(h){"use strict";h.module("eweiApp.project_anagement").directive("turnleft",e).directive("turnright",t);e.$inject=["coreModelService","coreNotifyService","$location"];function e(m,i,_){return{restrict:"EA",replace:true,scope:{},link:function(e,p){var g=new RegExp("[0-9]*$","i");i.register("directiveleft",i.constant.EVENT_PROJECT_CLASSIFY_LIST,function(e,t){var i=h.element(".carousel");var n=m.detail.projectClassifyList.gets(m.list.projectClassifyList.gets(1))||[];var o=1;for(var a=0;a<n.length;a++){if(n[a].display){o++}}var r=h.element(".specialul");var s=o*78-10;var c=s-710;void 0;if(s>710){p.show()}else{p.hide();return}p[0].onclick=function(){var e=parseInt(r.css("margin-left"));e-=710;r.css({"margin-left":e});if(e<-c){e=-c}r.css({"margin-left":e})};if(g.exec(_.url())[0]!=""){var l=m.detail.projectClassifyList.gets(m.list.projectClassifyList.gets(1))||[];var u=0;for(var a=0;a<l.length;a++){if(l[a].id==parseInt(g.exec(_.url())[0])){u=a;void 0}}u=parseInt((u+1)/10)+1;var d=true;var f=0;if(u<=1){return false}var a=1;do{void 0;if(a<u){f-=710;a++}else{d=false}}while(d);r.css({"margin-left":f});if(f<-c){f=-c}r.css({"margin-left":f})}});function t(){i.unRegister("directiveleft")}e.$on("$destroy",function(){t()})}}}t.$inject=["coreModelService","coreNotifyService","$location"];function t(u,i,e){return{restrict:"EA",replace:true,scope:{},link:function(e,l){i.register("directiveright",i.constant.EVENT_PROJECT_CLASSIFY_LIST,function(e,t){var i=h.element(".carousel");var n=u.detail.projectClassifyList.gets(u.list.projectClassifyList.gets(1))||[];var o=1;for(var a=0;a<n.length;a++){if(n[a].display){o++}}void 0;var r=h.element(".specialul");var s=o*78-10;var c=s-710;if(s>710){l.show()}else{l.hide();return}l[0].onclick=function(){var e=parseInt(r.css("margin-left"));e+=710;r.css({"margin-left":e});if(e>0){e=0}r.css({"margin-left":e})}});function t(){i.unRegister("directiveright")}e.$on("$destroy",function(){t()})}}}}(angular);(function(){"use strict";angular.module("eweiApp.project_anagement").controller("universalListCtrl",e);e.$inject=[];function e(){var e=this;var t=e.__proto__.constructor.name+"_"+(new Date).valueOf();void 0}})();(function(){"use strict";angular.module("eweiApp.project_anagement").controller("favoritesListCtrl",e);e.$inject=["$scope","$modal_","apiRestfulService","alertService","coreModelService","sortOrder","coreNotifyService","loadFavData","apiProjectClassifyListService","providerJudgement","deleteFavOptions","$state"];function e(o,a,r,s,n,i,c,l,u,d,f,p){var g=this;var e=g.__proto__.constructor.name+"_"+(new Date).valueOf();var m=1;var _=1;var h=[];var v={};g.translateToProject=function(e,t,i){if(!d.isTrue()){return false}g.projectName="";e.stopPropagation();h.push({id:t,ticketComment:{ticket:{id:i}}});var n=a({scope:o,title:"转化为项目",contentTemplate:"source/project_management/template/modal_template/translateToProject.html",template:"modal/modal.tpl.w500.html",html:true,show:true,placement:"center"});g.hideModal=function(){n.$promise.then(n.hide)}};g.makeSure=function(){if(!g.projectName){s.add("请输入项目名称","danger");return false}else if(!g.choseSort){s.add("请选择分类","danger");return false}var e="";for(var t=0;t<g.choseSort.projectPhases.length;t++){if(g.choseSort.projectPhases[t].position==1){e=g.choseSort.projectPhases[t].id}}var i={url:"api/v1/favorites/convertToPrject",urlParam:"",dataParam:{currentPhase:{id:e},favorites:h,name:g.projectName,projectCategory:{id:g.choseSort.id}}};r.run(i).post(i.dataParam,function(e){if(e.status!=0){s.add("转化为项目失败","danger")}else{s.add("转化为项目成功","success");g.projectName="";g.hideModal();for(var t=0;t<h.length;t++){c.doNotify(c.constant.EVENT_NEW_FAVORITE_REMOVED)}void 0;p.go("project_detail",{categoryid:g.choseSort.id,id:e.result.id});g.choseSort=""}h=[]})};g.selected=false;g.favStyle={};g.selectedFn=function(e,t,i){if(v[e]){v[e]=false;c.doNotify(c.constant.EVENT_FAV_TRAN_PROJECT_DELETE,{favArray:{id:e,ticketComment:{ticket:{id:t}}},typeArray:i})}else{v[e]=true;c.doNotify(c.constant.EVENT_FAV_TRAN_PROJECT,{favArray:{id:e,ticketComment:{ticket:{id:t}}},typeArray:i})}};g.deleteProject=function(e,i,n){e.stopPropagation();var t={url:"api/v1/favorites/"+i,urlParam:"",dataParam:""};r.run(t).delete(t.dataParam,function(e){if(e.status!=0){s.add("删除失败","danger")}else{var t=f.run(g.todayData,g.boforeTodayData,i,n);g.todayData=t.today;g.boforeTodayData=t.beforetoday}})};function t(){y();E()}function E(){g.items=i.fn(true);var e={_fields:"",_page:1,_count:0,createdAtBegin:"",createdAtEnd:""};u.run("list.projectClassifyList",c.constant.EVENT_PROJECT_CLASSIFY_LIST,e._page,"",e,function(e){});var t={url:"api/v1/favorites/list",urlParam:{_count:"10",_page:"1",time:""},dataParam:""};t.urlParam.time="today";l.run(t,c.constant.EVENT_FAV_DATA,function(){var e={url:"api/v1/favorites/list",urlParam:{_count:"10",_page:"1",time:""},dataParam:""};e.urlParam.time="beforetoday";l.run(e,c.constant.EVENT_FAV_DATA)})}function T(e){angular.forEach(e,function(e){if(e.type==7){var t=/\[([\s\S]+)\]/gi;var i=/\(([\s\S]+)\)/gi;var n=t.exec(e.content);if(n&&n.length==2){e.linkTitle=n[1]}var o=i.exec(e.content);if(o&&o.length==2){e.linkAddress=o[1]}}})}function y(){c.register(e,c.constant.EVENT_FAV_DELETE_MUTILE,function(e,t){for(var i=0;i<t.ids.length;i++){var n=f.run(g.todayData,g.boforeTodayData,t.ids[i],t.type[i]);g.todayData=n.today;g.boforeTodayData=n.beforetoday}c.doNotify(c.constant.EVENT_FAV_GO_PAGE);c.doNotify(c.constant.EVENT_PROJECT_CHECK_ALL,{checkAll:false})});c.register(e,c.constant.EVENT_PROJECT_CLASSIFY_LIST,function(e,t){g.items=i.fn(true)});c.register(e,c.constant.EVENT_PROJECT_CHECK_ALL,function(e,t){if(!t.checkAll){g.selected=false;g.favStyle={}}else{g.selected=true;g.favStyle={display:"block"}}});c.register(e,c.constant.EVENT_FAV_DATA,function(e,t){if(t.type=="today"){if(m==1){g.todayData=[];g.todayData=n.detail.todayData.gets(n.list.todayData.gets(m))}else{g.todayData=g.todayData.concat(n.detail.todayData.gets(n.list.todayData.gets(m)))}T(g.todayData);m++}else if(t.type=="beforetoday"){if(_==1){g.boforeTodayData=[];g.boforeTodayData=n.detail.beforeTodayData.gets(n.list.beforeTodayData.gets(_))}else{g.boforeTodayData=g.boforeTodayData.concat(n.detail.beforeTodayData.gets(n.list.beforeTodayData.gets(_)))}T(g.boforeTodayData);_++}});c.register(e,c.constant.EVENT_FAV_DATA_MORE,function(e,t){var i={url:"",urlParam:{_count:"10",_page:"",time:""},dataParam:""};i.url="api/v1/favorites/list";i.urlParam.time=t.type;if(t.type=="today"){i.urlParam._page=m;if(m*10-n.list.todayData.total()<10){l.run(i,c.constant.EVENT_FAV_DATA,function(){})}}else{i.urlParam._page=_;if(_*10-n.list.beforeTodayData.total()<10){l.run(i,c.constant.EVENT_FAV_DATA,function(){})}}void 0})}function N(){c.unRegister(e)}o.$on("$destroy",function(){N()});t();void 0}})();(function(T){"use strict";angular.module("eweiApp.project_anagement").directive("universalNavigation",e).controller("universalNavigationCtrl",t);e.$inject=[];function e(){return{restrict:"EA",replace:true,scope:{},templateUrl:"/source/project_management/directives/nav/universalNavigation.html",controller:t,controllerAs:"vm",link:function(e,t){}}}t.$inject=["$scope","$modal_","$state","$stateParams","coreModelService","sortOrder","coreNotifyService","apiRestfulService","alertService","providerJudgement","permissions","apiProjectClassifyListService","projectRecentViewService"];function t(a,r,n,o,i,s,c,l,u,d,f,t,p){var g=this;var m=g.__proto__.constructor.name+"_"+(new Date).valueOf();g.items=s.fn(true);g.sortItems=s.fn();g.default=true;g.searchKey=o.searchKey||"";g.showSearchInput=n.current.name!=="universal_list.favorites_list";g.preSelectIndex=0;if(o.catId){angular.forEach(g.sortItems,function(e,t,i){if(e.id==o.catId){e.active=true;g.preSelectIndex=t}else{e.active=false}})}g.trackNav=function(e,t){g.sortItems[g.preSelectIndex].active=false;c.doNotify(c.constant.EVENT_PROJECT_CHECK_ALL,{checkAll:false});if(angular.isString(e)&&e=="favorites_list"){i.config.route.put("project_list.selected",{id:e,searchKey:null});g.showSearchInput=false}else{i.config.route.put("project_list.selected",{id:e.id,searchKey:g.searchKey});g.showSearchInput=true;e.active=true;g.preSelectIndex=t;n.go("universal_list.project_category_list",{catId:e.id,searchKey:g.searchKey})}};g.createProject=function(e){if(!d.isTrue()){return false}angular.forEach(g.items,function(e){if(e.id==o.catId){g.choseSort=e}});if(!o.catId){g.choseSort=null}if(e=="create"&&!f.hasPermission("project_create")){u.add("无权限","danger");return false}if(e=="fl"){n.go("project_management");return false}var t=r({scope:a,title:"创建项目",contentTemplate:"source/project_management/template/modal_template/createProject.html",template:"modal/modal.tpl.w500.html",html:true,show:true,placement:"center"});g.hideModal=function(){t.$promise.then(t.hide)}};g.makeSureCreate=function(){void 0;if(!g.projectName){u.add("请输入项目名称","danger");return false}else if(!g.describe){u.add("请输入项目描述","danger");return false}else if(!g.choseSort){u.add("请选择分类","danger");return false}var e="";for(var t=0;t<g.choseSort.projectPhases.length;t++){if(g.choseSort.projectPhases[t].position==1){e=g.choseSort.projectPhases[t].id}}var i={url:"api/v1/projects",urlParam:"",dataParam:{content:g.describe,currentPhase:{id:e},name:g.projectName,projectCategory:{id:g.choseSort.id}}};l.run(i).post(i.dataParam,function(e){if(e.status!=0){u.add("创建项目失败","danger")}else{u.add("创建项目成功","success");c.doNotify(c.constant.EVENT_NEW_PROJECT_ADDED,{catId:g.choseSort.id});n.go("project_detail",{categoryid:g.choseSort.id,id:e.result.id});g.projectName="";g.describe="";g.hideModal()}})};var _=[];var h=[];g.makeSure=function(){if(!g.projectName){u.add("请输入项目名称","danger");return false}else if(!g.choseSort){u.add("请选择分类","danger");return false}var e="";for(var t=0;t<g.choseSort.projectPhases.length;t++){if(g.choseSort.projectPhases[t].position==1){e=g.choseSort.projectPhases[t].id}}var i={url:"api/v1/favorites/convertToPrject",urlParam:"",dataParam:{currentPhase:{id:e},favorites:_,name:g.projectName,projectCategory:{id:g.choseSort.id}}};l.run(i).post(i.dataParam,function(i){if(i.status!=0){u.add("转化为项目失败","danger")}else{u.add("转化为项目成功","success");g.projectName="";c.register(m,c.constant.EVENT_FAV_GO_PAGE,function(e,t){n.go("project_detail",{categoryid:g.choseSort.id,id:i.result.id})});var e=[];for(var t=0;t<_.length;t++){e.push(_[t].id)}c.doNotify(c.constant.EVENT_FAV_DELETE_MUTILE,{ids:e,type:h});g.hideModal()}_=[];h=[]})};g.tranferProject=function(e){if(!d.isTrue()){return false}if(e=="cancel"){c.doNotify(c.constant.EVENT_PROJECT_CHECK_ALL,{checkAll:false});return false}else if(e=="tranfer"){g.projectName="";var t=r({scope:a,title:"转化为项目",contentTemplate:"source/project_management/template/modal_template/translateToProject.html",template:"modal/modal.tpl.w500.html",html:true,show:true,placement:"center"});g.hideModal=function(){t.$promise.then(t.hide)}}else if(e=="delete"){var i={url:"api/v1/favorites/",urlParam:"",dataParam:""};var n=[];for(var o=0;o<_.length;o++){n.push(_[o].id);if(o==_.length-1){i.url+=_[o].id}else{i.url+=_[o].id+","}}l.run(i).delete(i.dataParam,function(e){if(e.status!==0){u.add("删除失败","danger")}else{c.doNotify(c.constant.EVENT_FAV_DELETE_MUTILE,{ids:n,type:h});_=[];h=[]}})}else if(e==="append"){a.mergerUnit={list:[]};a.mergerUnit.submiting=false;a.mergerUnit.openMenu=false;a.mergerUnit.showSearch=true;a.mergerUnit.selectedProject=null;a.mergerUnit.lastText=a.mergerUnit.curText="";a.mergerUnit.list=angular.copy(p.getProjects());var t=r({scope:a,title:"添加到已有项目",contentTemplate:"source/project_management/template/modal_template/appendToProject.html",template:"modal/modal.tpl.w500.html",html:true,show:true,placement:"center"});a.mergerUnit.search=function(){if(a.mergerUnit.curText.trim()==="")return;T.sdk.OpenFavoriteApi().listProjectByKey({key:a.mergerUnit.curText||"",page:{pageNumber:1,pageSize:20}}).then(function(e){a.mergerUnit.list=e.list;a.mergerUnit.showSearch=false;a.mergerUnit.openMenu=true})};a.mergerUnit.clear=function(){a.mergerUnit.selectedProject=null;a.mergerUnit.openMenu=true;a.mergerUnit.showSearch=true;a.mergerUnit.lastText=a.mergerUnit.curText=""};a.mergerUnit.select=function(e){a.mergerUnit.selectedProject=e;a.mergerUnit.lastText=a.mergerUnit.curText="#"+e.no+"  "+e.name;a.mergerUnit.openMenu=false;a.mergerUnit.showSearch=false};a.mergerUnit.focus=function(){if(a.mergerUnit.curText===""){a.mergerUnit.openMenu=true}};a.mergerUnit.change=function(){if(a.mergerUnit.lastText!==a.mergerUnit.curText){a.mergerUnit.showSearch=true;a.mergerUnit.selectedProject=null;a.mergerUnit.openMenu=a.mergerUnit.curText===""}};a.mergerUnit.keyup=function(e){var t=window.event?e.keyCode:e.which;if(t===13){a.mergerUnit.search()}};a.hideModal=function(){t.$promise.then(t.hide)};a.$ok=function(n){a.mergerUnit.submiting=true;T.sdk.OpenFavoriteApi().favoritesAppendToProject({projectId:a.mergerUnit.selectedProject.id,favorites:_}).then({success:function(e){a.mergerUnit.submiting=false;a.hideModal();u.add("已添加到#"+n.no+"项目！","success");var t=[];for(var i=0;i<_.length;i++){t.push(_[i].id)}c.doNotify(c.constant.EVENT_FAV_DELETE_MUTILE,{ids:t,type:h})},fail:function(e){a.mergerUnit.submiting=false;u.add(e.error_description,"danger")}})}}};g.clearSearchKey=function(){g.searchKey="";o.searchKey="";c.doNotify(c.constant.EVENT_LIST_PHASE_REFRESH,{catId:o.catId})};g.searchCategory=function(){o.searchKey=g.searchKey;c.doNotify(c.constant.EVENT_LIST_PHASE_REFRESH,{catId:o.catId})};function e(){v();var e={_fields:"",_page:1,_count:0,createdAtBegin:"",createdAtEnd:""};t.run("list.projectClassifyList",c.constant.EVENT_PROJECT_CLASSIFY_LIST,e._page,"",e,function(e){})}function v(){c.register(m,c.constant.EVENT_PROJECT_CHECK_ALL,function(e,t){if(t.checkAll){g.default=false}else{g.default=true}});c.register(m,c.constant.EVENT_FAV_TRAN_PROJECT,function(e,t){_.push(t.favArray);h.push(t.typeArray)});c.register(m,c.constant.EVENT_FAV_TRAN_PROJECT_DELETE,function(e,t){for(var i=0;i<_.length;i++){if(_[i].id==t.favArray.id){_.splice(i,1);h.splice(i,1)}}});c.register(m,c.constant.EVENT_PROJECT_CLASSIFY_LIST,function(e,t){g.items=s.fn(true);g.sortItems=s.fn();if(o.catId){angular.forEach(g.sortItems,function(e,t,i){if(e.id==o.catId){e.active=true;g.preSelectIndex=t}else{e.active=false}})}})}e();function E(){c.unRegister(m)}a.$on("$destroy",function(){E()});void 0}})(org.ewei);!function(l){"use strict";l.module("eweiApp.project_anagement").directive("stopparent",e).directive("scrollF",t).directive("changeable",i);e.$inject=[];function e(){return{restrict:"EA",replace:true,link:function(e,t){var i=l.element(t);i.on("click",function(e){e.stopPropagation()})}}}t.$inject=["coreModelService","coreNotifyService"];function t(e,o){return{restrict:"EA",replace:true,scope:{num:"@"},link:function(e,t){var i=l.element(".innerscroll");var n=l.element(t);n.on("scroll",function(){if(i.eq(e.num).height()-n.height()==n.scrollTop()){if(e.num==0){o.doNotify(o.constant.EVENT_FAV_DATA_MORE,{type:"today"})}else{o.doNotify(o.constant.EVENT_FAV_DATA_MORE,{type:"beforetoday"})}}});e.$on("$destory",function(){n.off("scroll")})}}}i.$inject=["$rootScope","coreNotifyService"];function i(s,c){return{restrict:"EA",replace:true,scope:{},link:function(a,e){var r=l.element(e);r.on("click",function(e){var t=tinycolor(r.find(".flag").css("color"));if(t.toHexString()==s.mainColor){r.find(".flag").css({color:"#dddddd"})}else{r.find(".flag").css({color:s.mainColor})}a.$evalAsync(function(){c.doNotify(c.constant.EVENT_PROJECT_CHECK_ALL,{checkAll:true})});var i=l.element(".listarea");var n=0;for(var o=0;o<i.find(".flag").length;o++){if(tinycolor(i.find(".flag").eq(o).css("color")).toHexString()=="#dddddd"){n++}}if(n==i.find(".flag").length){a.$evalAsync(function(){c.doNotify(c.constant.EVENT_PROJECT_CHECK_ALL,{checkAll:false})})}});a.$on("$destory",function(){r.off("click")});c.register("controllerName",c.constant.EVENT_PROJECT_CHECK_ALL,function(e,t){if(!t.checkAll){r.find(".flag").css({color:"#dddddd"})}})}}}}(angular);!function(s){"use strict";s.module("eweiApp.project_anagement").factory("sortOrder",t).factory("deleteFavOptions",i).factory("loadFavData",n).factory("projectRecentViewService",e);e.$inject=[];function e(){var o=[];function t(e){var t=o.length;var i=-1;for(var n=0;n<t;n++){if(o[n].id===e){i=n;break}}return i}return{appendProject:function(e){if(t(e.id)===-1){o.push(e)}},getProjects:function(){return o}}}t.$inject=["coreModelService"];function t(o){return{fn:function(e){if(e){return o.detail.projectClassifyList.gets(o.list.projectClassifyList.gets(1))||[]}else{var t=o.detail.projectClassifyList.gets(o.list.projectClassifyList.gets(1))||[];var i=[];for(var n=0;n<t.length;n++){if(t[n].display){i.push(t[n])}}return i}}}}i.$inject=["coreNotifyService","coreModelService"];function i(r,s){return{run:function(e,t,i,n){if(n=="today"){s.list.todayData.delete(1,i);var o=0;for(var a=0;a<e.length;a++){if(i==e[a].id){e.splice(a,1);r.doNotify(r.constant.EVENT_NEW_FAVORITE_REMOVED);a=0}}}else if(n=="beforetoday"){s.list.beforeTodayData.delete(1,i);for(var a=0;a<t.length;a++){if(i==t[a].id){t.splice(a,1);a=0}}}return{today:e,beforetoday:t}}}}n.$inject=["coreModelService","apiRestfulService","coreNotifyService"];function n(a,e,r){return{run:function(i,n,o){e.run(i).query(i.dataParam,function(e){if(e.status!=0){if(o&&typeof o==="function"){o(e.status)}return false}if(s.isDefined(e.result)){var t=[];if(i.urlParam.time=="today"){s.forEach(e.result.favorites,function(e){a.detail.todayData.put(e.id,e);t.push(e.id)});a.list.todayData.put(i.urlParam._page,t);a.list.todayData.total(e.result._total);r.doNotify(n,{type:i.urlParam.time})}else if(i.urlParam.time=="beforetoday"){s.forEach(e.result.favorites,function(e){a.detail.beforeTodayData.put(e.id,e);t.push(e.id)});a.list.beforeTodayData.put(i.urlParam._page,t);a.list.beforeTodayData.total(e.result._total);r.doNotify(n,{type:i.urlParam.time})}}if(o&&typeof o==="function"){o(e.status)}})}}}}(angular);(function(){"use strict";angular.module("eweiApp.project_anagement").controller("projectCategoryListCtrl",e);e.$inject=["$scope","$state","coreNotifyService","coreModelService","$http","$stateParams","apiRestfulService","apiPhaseListByCategoryService"];function e(e,t,i,n,o,a,r,s){var c=this;var l=this.__proto__.constructor.name+"_"+Date.now();var u="condition",d;var f=parseInt(a.catId);var p=function(){c.phases=_.sortBy(c.phases,"position")};var g=function(t){c.phases=n.detail.phases.gets(n.list.phaseByCategory.gets(f));p();if(u!==d){s.run(f,i.constant.EVENT_LIST_PHASE_BY_CATEGORY,null,null,function(e){if(t&&c.phases.length>0){i.doNotify(i.constant.EVENT_LIST_PROJECT_REFRESH,{phaseId:c.phases[0].id})}});d=angular.copy(u)}};var m=function(){if(c.phases.length>0){angular.forEach(c.phases,function(e){i.doNotify(i.constant.EVENT_LIST_PROJECT_REFRESH,{phaseId:e.id})})}};function h(){v();g()}function v(){i.register(l,i.constant.EVENT_LIST_PHASE_BY_CATEGORY,function(e,t){if(t&&t.catId==f){g()}});i.register(l,i.constant.EVENT_LIST_PHASE_REFRESH,function(e,t){if(t&&t.catId==f){m()}});i.register(l,i.constant.EVENT_NEW_PROJECT_ADDED,function(e,t){if(t&&t.catId==f||!t){d=null;g(true)}})}function E(){i.unRegister(l)}h();e.$on("$destroy",function(){E()})}})();(function(){"use strict";angular.module("eweiApp.project_anagement").directive("phaseCard",e).filter("dateOnly",i);e.$inject=[];function e(){return{restrict:"EA",scope:{phase:"=phaseCard",phaseIndex:"=",allPhases:"="},templateUrl:"source/project_management/directives/phase/phaseCard.html",controller:t,controllerAs:"vm"}}t.$inject=["$scope","$stateParams","$state","coreNotifyService","coreModelService","apiRestfulService","ConsoleConfig","$modal_","alertService","$filter","apiProjectListByPhaseService","permissions"];function t(a,e,t,i,n,o,r,s,c,l,u,d){var f=this;var p=this.__proto__.constructor.name+"_"+Date.now();f.catId=parseInt(e.catId);f.phase=a.phase;f.projects=[];f.showmyonly=false;f.oldSearchKey=e.searchKey;var g="condition",m;f.projectProgress={};f.loadProjects=function(){f.projects=n.detail.projects.gets(n.list.projectByPhase.gets(f.phase.id));f.sortProjects();if(g!==m||f.oldSearchKey!=e.searchKey){f.oldSearchKey=e.searchKey;f.loading=true;u.run(f.phase.id,i.constant.EVENT_LIST_PROJECT_BY_PHASE,null,{searchKey:e.searchKey},function(){f.loading=false});g=angular.copy(m)}};f.filter=function(e,t,i){if(f.showmyonly){return e.creater.id==r.user.id}return true};f.addProject=function(t){var i=false;angular.forEach(f.projects,function(e){if(e.id==t.id){i=true}});if(!i){f.projects.push(t);u.add(f.phase.id,t.id);f.sortProjects()}};f.removeProject=function(e){var t=-1;for(var i=0;i<f.projects.length;i++){if(f.projects[i].id===e){t=i;break}}if(t>-1){f.projects.splice(t,1);u.remove(f.phase.id,e)}};f.sortProjects=function(){f.projects.sort(function(e,t){return t.id-e.id});f.projects.sort(function(e,t){var i=Date.parse(e.joinPhaseTime);var n=Date.parse(t.joinPhaseTime);return n-i})};function _(t,i){a.$evalAsync(function(){f.addProject(t)});var e={url:"api/v1/projects/"+t.id+"/phases/"+f.phase.id};o.run(e).put({text:f.projectProgress.text},function(e){if(e.status!=0){void 0;f.removeProject(t.id);a.$parent.$parent.$broadcast("revert-project",t)}else{t.currentPhase.id=f.phase.id;t.joinPhaseTime=e.result.join_phase_time;f.sortProjects();void 0}i&&i()},function(e){void 0;f.removeProject(t.id);a.$parent.$parent.$broadcast("revert-project",t);i&&i()})}f.changeProgress=function(i){f.projectProgress.text="";f.projectPhases=a.allPhases;var n=false;var o=s({scope:a,title:"变更项目进度",contentTemplate:"source/project_management/template/modal_template/changeProgress.html",template:"modal/modal.tpl.w500.html",html:true,show:true,placement:"center"});a.$on("modal.hide.before",function(e,t){if(!n&&t==o){a.$parent.$parent.$broadcast("revert-project",i)}});f.projectProgress.id=f.phase.id;a.cancel=function(){a.$parent.$parent.$broadcast("revert-project",i);n=true;o.hide()};a.saveChangeProgress=function(){a.$loading=true;n=true;o.hide();i.currentPhase.id=f.projectProgress.id;if(i.currentPhase.id!=f.phase.id){a.$parent.$parent.$broadcast("project-phase-changed",i)}else{_(i,function(){a.$loading=false})}}};f.sortOptions={chosenClass:"dragging",sort:false,group:{name:"phase-project-list",pull:true,put:true},onAdd:function(e){var t=e.model;f.changeProgress(t)},onMove:function(e){if(e.from===e.to)return false;var t=angular.element(e.from).parents(".phase-card");var i=t.parents(".phase-container");var n=i.children(".phase-card:last");if(t.size()>0&&n.size()>0&&t.get(0)==n.get(0)){return false}},onRemove:function(e){a.$evalAsync(function(){f.removeProject(e.model.id)})}};f.deleteProject=function(t,i){if(!d.hasPermission("project_delete")){c.add("您没有权限删除项目","danger");return false}a._messages="删除后，已分享的用户将不再可见此项目，是否确定删除？";var e=s({scope:a,title:"删除项目",contentTemplate:"source/views/alter_common.html",html:true,show:true,placement:"center"});a.$hide=function(){e.$promise.then(e.hide)};a.$ok=function(){var e={url:"/api/v1/projects/"+t.id,urlParam:""};a.isLoading=true;o.run(e).delete(null,function(e){if(e.status===0){f.projects.splice(i,1);n.list.projectByPhase.remove([t.id]);n.detail.projects.remove(t.id)}else{c.add("删除失败，请重试！","error")}a.$hide();delete a.isLoading},function(){delete a.isLoading})}};a.$on("revert-project",function(e,t){if(t.currentPhase.id===f.phase.id){f.addProject(t)}});a.$on("project-phase-changed",function(e,t){if(t.currentPhase.id==f.phase.id){_(t)}});function h(){v();f.loadProjects()}function v(){i.register(p,i.constant.EVENT_LIST_PROJECT_BY_PHASE,function(e,t){if(t&&t.phaseId===f.phase.id){f.loadProjects()}});i.register(p,i.constant.EVENT_LIST_PROJECT_REFRESH,function(e,t){if(t&&t.phaseId==f.phase.id||!t){m=null;f.loadProjects()}})}function E(){i.unRegister(p)}h();a.$on("$destroy",function(){E()})}function i(){return function(e){if(e&&e.length>10){return e.substring(0,10)}return e}}})();(function(){"use strict";angular.module("eweiApp.ticket").directive("addToFavorite",e).directive("addToFavoriteTarget",t);e.$inject=["$timeout","apiRestfulService"];function e(c,l){return{restrict:"A",scope:{comment:"=addToFavorite",logType:"@",chatLog:"="},link:function(o,a,e){var r=false;var s=Date.now();a.on("click",function(e){if(r||Date.now()-s<1500){return}s=Date.now();r=true;var t=a.offset();var i=o.comment.content;var n=o.comment.attachments;if(angular.isDefined(o.logType)&&o.logType=="chat"){if(o.chatLog.type=="html"){i=o.chatLog.richTextContent.richText}else{i=o.chatLog.rawContent||o.chatLog.content}if(o.chatLog.attachment){n=[o.chatLog.attachment]}}l.run({url:"api/v1/favorites",urlParam:""}).post({ticketComment:{id:o.comment.id},content:i,attachments:n,type:o.comment.type},function(e){r=false;if(e.status==0){if(e.result){o.showAnimation(t)}}},function(){r=false})});o.showAnimation=function(e){var t=angular.element("*[add-to-favorite-target]>i");if(t.length==0)return;var i=angular.element("i",a).clone();var n=t.offset();var o={position:"fixed",top:e.top+"px",left:e.left+"px",zIndex:9999,color:"#558EFC",transition:"all 0.6s",fontSize:"30px"};i.css(o);i.appendTo(document.body);c(function(){i.css({top:n.top+"px",left:n.left+"px"});c(function(){i.remove();t.parent().trigger("plus-one")},600)},100)}}}}t.$inject=["$timeout","coreNotifyService"];function t(o,a){return{restrict:"A",link:function(e,t,i){var n=angular.element(".plusone",t);t.on("plus-one",function(){n.show().css({top:"-15px"});o(function(){a.doNotify(a.constant.EVENT_NEW_FAVORITE_ADDED);n.hide().css({top:"0"})},500)})}}}})();(function(){"use strict";angular.module("eweiApp.project_anagement").directive("shareUser",e);e.$inject=[];function e(){return{restrict:"EA",scope:{ccs:"=",log:"=",isclosed:"=",iscopytome:"=",assignable:"@",hidetomy:"@",ispolymerizesearch:"@"},compile:function e(a,t,i){return{post:function e(t,i,n,o){if(t.assignable=="false"){t.$on("removeDisabled",function(e,t){a.children().eq(0).removeAttr("disabled")});a.children().eq(0).attr("disabled","disabled")}}}},templateUrl:"/source/project_management/directives/share-user/share-user.html",controller:t,link:function(e){}}}t.$inject=["$rootScope","$stateParams","$scope","$http","ConsoleConfig","apiRestfulService","alertService"];function t(e,n,i,o,a,r,s){i.displayShareBox=false;i.addShare=function(){if(i.isclosed){s.add("项目已关闭，不可添加分享人！","danger");return false}i.displayShareBox=true};i.loadUsers=function(e){var t="?provider_id="+a.provider.id+"&_token="+getCookie("user_token");var i={url:"/api/v1/project_categories/"+n.categoryid+"/sharers"+t+"&keyword="+e};return o.get(i.url,{}).then(function(e){var i=[];var t=angular.isDefined(e.data.result)?e.data.result:[];angular.forEach(t,function(e){var t=angular.isDefined(e.email)?e.email:"";if(!c(e.userid)){i.push({id:e.userid,contentUrl:e.content_url,name:e.name+(t?"("+t+")":""),showname:e.name})}});void 0;return i})};var c=function(e){if(i.ccs){for(var t=0;t<i.ccs.length;t++){if(i.ccs[t].id==e){return true}}}return false};var l=true;var t=function(t){if(l){l=false;i.displayShareBox=false;r.run({url:"/api/v1/projects/"+n.id+"/sharers/"+t.id,urlParam:""}).post(null,function(e){l=true;if(e.status===0){s.add("分享成功！","success");i.$emit("sendTimeLineLogs",{log:e.result.log})}else{i.ccs.splice(i.ccs.indexOf(t),1);s.add("分享失败！","danger")}})}else{return false}};var u=true;i.deleteCcRelation=function(t){if(u){u=false;r.run({url:"/api/v1/projects/"+n.id+"/sharers/"+t.id,urlParam:""}).delete(null,function(e){if(e.status===0){i.ccs.splice(i.ccs.indexOf(t),1);i.$emit("sendTimeLineLogs",{log:e.result.log});s.add("删除分享人成功！","success")}else{s.add("删除分享人失败！","danger")}u=true})}};i.validateTag=function(t){if(!t.id)return false;var e=i.ccs&&_.filter(i.ccs,function(e){return e.name===t.name||t.name.indexOf(e.name)!==-1||e.name.indexOf(t.name)!==-1}).length>0;if(e){return false}return t.id||verifyEmailAddress(t.name)};i.tagAdded=function(e){if(e.id){t(e)}};i.tagRemoveing=function(e){return false};i.focus=function(){if(i.ispolymerizesearch){i.isHidden=false}};i.blur=function(){i.displayShareBox=false;if(i.ispolymerizesearch){i.isHidden=true}}}})();(function(){"use strict";angular.module("eweiApp.project_anagement").directive("relatedWorkOrder",e);e.$inject=[];function e(){return{restrict:"EA",scope:{ticketIds:"=",projectStatus:"=",addTicketDetail:"=",ticketList:"="},templateUrl:"/source/project_management/directives/related-workorder/related-workorder.html",controller:t,controllerAs:"vm",link:function(e){}}}t.$inject=["$rootScope","$state","$stateParams","$scope","$http","utils","ConsoleConfig","coreModelService","coreNotifyService","apiRestfulService","alertService","apiProjectRelatedWorkOrderService","ticketStatusColorExtendService","$modal_"];function t(e,i,n,o,t,a,r,s,c,l,u,d,f,p){var g=this;var m=this.__proto__.constructor.name+"_"+Date.now();g.listName="list.projectRelatedWorkOrder";g.ticketInfo=[];g.catId=n.categoryid+"_"+n.id;g.argument={_fields:"",_page:1,_count:0,createdAtBegin:"",createdAtEnd:""};var h="condition",v;var E=o.$watch("ticketIds",function(e,t){if(e!==t&&!angular.isUndefined(o.ticketIds)){g.ticketIdArray=o.ticketIds.replace(/,$/gi,"");if(g.ticketIdArray==""){g.ticketIdArray=","}v="";N()}});var T=o.$watch("addTicketDetail",function(e,t){if(e!==t&&!angular.isUndefined(o.addTicketDetail)){g.ticketLists.push(o.addTicketDetail);S(g.ticketLists)}});function y(){d.run(g.catId,c.constant.EVENT_PROJECT_RELATE_WORKORDER,g.argument._page,{ids:g.ticketIdArray||","},"",o.ticketList,function(e){})}function N(){g.ticketLists=s.detail.projectRelatedWorkOrder.gets(s.list.projectRelatedWorkOrder.gets(g.catId))||[];S(g.ticketLists);void 0;if(h!==v){y();v=angular.copy(h)}}var S=function(e){var t=w(e);if(t.length>0){C(t)}};var C=function(e){f.run("",{ticketIds:e.join(",")},false,function(e){if(e.success){g.ticketStatusColors=e.json}})};var w=function(e){var t=[];angular.forEach(e,function(e){if(angular.isDefined(e.id)){t.push(e.id)}});return t};g.openTicket=function(e){if(e.thoroughstatus&&e.thoroughstatus==="deleted"){u.add("工单已被彻底删除，无法查看！","danger");return false}var t=a.findTabByIdAndStateName("tickets_detail"+e.id,"tickets_detail");if(t==null){a.addTab("tickets_detail"+e.id,e.subject,"tickets_detail",{id:e.id},"")}else{t.active=true}i.go("tickets_detail",{id:e.id})};g.removeRelevanceWorkOrder=function(i,t){if(o.projectStatus){u.add("项目已关闭，不可再操关联工单！","danger");return false}o._messages="是否解除工单与项目的关联关系？解除后，工单和项目将分别独立存在。";var e=p({scope:o,title:"解除关联工单",contentTemplate:"source/project_management/template/modal_template/deleteWorkOrder.html",html:true,show:true,placement:"center"});o.$hide=function(){e.$promise.then(e.hide)};o.delete_ticket=false;o.$ok=_.debounce(function(){if(o.delete_ticket){return false}o.delete_ticket=true;o.$hide();var e={ticketId:i.id};l.run({url:"/api/v1/projects/"+n.id+"/tickets/"+i.no,urlParam:e}).delete(null,function(e){void 0;if(e.status===0){angular.forEach(o.ticketList,function(t){if(parseInt(t.id)===parseInt(i.id)){var e;while(e=_.find(o.ticketList,function(e){return e.id==t.id})){o.ticketList.splice(o.ticketList.indexOf(e),1)}o.$emit("updateTicket",o.ticketList)}});o.$emit("sendTimeLineLogs",{log:e.result.log});g.ticketLists.splice(t,1);s.list.projectRelatedWorkOrder.remove([i.id]);s.detail.projectRelatedWorkOrder.remove(i.id);u.add("已与工单 “#"+i.no+"” 解除关联！","success");o.delete_ticket=false}else{o.delete_ticket=false;u.add("解除关联失败！#"+i.no+e.result.error_description,"danger")}})},500)};function P(){k()}function k(){c.register(m,c.constant.EVENT_PROJECT_RELATE_WORKORDER,function(e){N()})}function I(){c.unRegister(m)}function A(){E();T()}P();o.$on("$destroy",function(){A();I()})}})();